#!/usr/bin/env sh
set -eu

script_dir=$(cd "$(dirname "$0")" && pwd)

print_step() {
  printf '%s\n' "$1"
}

run_quiet() {
  if [ "$#" -eq 0 ]; then
    return 0
  fi
  "$@" >/dev/null 2>&1
}

assume_yes() {
  case ${WIZARDRY_UPDATE_ALL_ASSUME_YES:-} in
    1|[Yy]|[Yy][Ee][Ss]|[Tt][Rr][Uu][Ee])
      return 0
      ;;
  esac
  return 1
}

confirm_updates() {
  if assume_yes; then
    return 0
  fi

  printf '%s\n' 'Proceed with system updates? [Y/n]'
  IFS= read -r response || response=''
  if [ -z "$response" ]; then
    response='y'
  fi
  case $response in
    [Yy]*)
      return 0
      ;;
  esac
  return 1
}

resolve_distro() {
  if [ -n "${WIZARDRY_UPDATE_ALL_DISTRO:-}" ]; then
    printf '%s\n' "$WIZARDRY_UPDATE_ALL_DISTRO"
    return 0
  fi

  if distro=$("$script_dir/detect-distro" 2>/dev/null); then
    printf '%s\n' "$distro"
    return 0
  fi

  return 1
}

distro=$(resolve_distro)
if [ -z "$distro" ]; then
  printf '%s\n' 'Unable to detect operating system.' >&2
  exit 1
fi

printf 'Detected platform: %s\n' "$distro"

if ! confirm_updates; then
  printf '%s\n' 'cancelled by user' >&2
  exit 1
fi

case $distro in
  debian)
    print_step '• Refreshing apt package lists'
    run_quiet sudo apt-get update
    print_step '• Installing upgrades'
    run_quiet sudo apt-get -y full-upgrade
    print_step '• Removing unused packages'
    run_quiet sudo apt-get -y autoremove
    ;;
  arch)
    print_step '• Synchronising pacman packages'
    run_quiet sudo pacman -Syu --noconfirm
    print_step '• Refreshing Pamac-managed packages'
    run_quiet pamac update --no-confirm
    print_step '• Rebuilding Pamac AUR packages'
    run_quiet pamac build --no-confirm
    ;;
  *)
    printf 'Unsupported platform: %s\n' "$distro" >&2
    exit 2
    ;;
esac

print_step 'All updates complete.'
