#!/bin/sh

set -eu

usage() {
        cat <<'USAGE' >&2
Usage: scribe-spell --rc-file FILE --spell NAME {add|remove|status}

Reads spell content from standard input for the 'add' action and wraps it with
wizardry comment sentinels so future removals remain deterministic.
Single-line spells receive an inline `# wizardry-spell: NAME` suffix, while
multi-line spells are wrapped with `begin`/`end` sentinels (including a lines
count) to keep rc files readable.
Spell names must contain only letters, digits, dashes, underscores, periods, and colons.
USAGE
}

action=""
rc_file=""
spell=""

while [ "$#" -gt 0 ]; do
        case $1 in
        --rc-file)
                if [ "$#" -lt 2 ]; then
                        printf '%s\n' "scribe-spell: --rc-file expects a file path." >&2
                        usage
                        exit 1
                fi
                rc_file=$2
                shift 2
                ;;
        --rc-file=*)
                rc_file=${1#*=}
                shift
                ;;
        --spell)
                if [ "$#" -lt 2 ]; then
                        printf '%s\n' "scribe-spell: --spell expects a name." >&2
                        usage
                        exit 1
                fi
                spell=$2
                shift 2
                ;;
        --spell=*)
                spell=${1#*=}
                shift
                ;;
        add|remove|status)
                if [ -n "$action" ]; then
                        printf '%s\n' "scribe-spell: only one action may be specified." >&2
                        usage
                        exit 1
                fi
                action=$1
                shift
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                break
                ;;
        -*)
                printf '%s\n' "scribe-spell: unknown option '$1'." >&2
                usage
                exit 1
                ;;
        *)
                printf '%s\n' "scribe-spell: unexpected argument '$1'." >&2
                usage
                exit 1
                ;;
        esac
done

if [ -z "$action" ] || [ -z "$rc_file" ] || [ -z "$spell" ]; then
        usage
        exit 1
fi

case $spell in
*[!A-Za-z0-9._:-]*)
        printf '%s\n' "scribe-spell: spell names may contain only letters, digits, dots, underscores, dashes, and colons." >&2
        exit 1
        ;;
*) : ;;
        esac

spell_tag="# wizardry-spell: $spell"
inline_marker=" $spell_tag"
block_start="$spell_tag begin"
block_end="$spell_tag end"
legacy_prefix="$spell_tag lines="

ensure_rc_directory() {
        dir=${rc_file%/*}
        if [ "$dir" != "$rc_file" ] && [ ! -d "$dir" ]; then
                        mkdir -p "$dir"
        fi
}

spell_status() {
        if [ ! -f "$rc_file" ]; then
                return 1
        fi
        if grep -Fq "$spell_tag" "$rc_file" 2>/dev/null; then
                return 0
        fi
        return 1
}

ensure_trailing_newline() {
        if [ ! -f "$rc_file" ] || [ ! -s "$rc_file" ]; then
                return 0
        fi
        last_char=$(tail -c 1 "$rc_file" 2>/dev/null | od -An -t o1 | tr -d ' ')
        if [ "$last_char" != "012" ]; then
                printf '\n' >>"$rc_file"
        fi
}

add_spell() {
        ensure_rc_directory
        tmp_file=$(mktemp "${TMPDIR:-/tmp}/scribe-spell.XXXXXX") || exit 1
        line_count=0
        while IFS= read -r line || [ -n "$line" ]; do
                printf '%s\n' "$line" >>"$tmp_file"
                line_count=$((line_count + 1))
        done
        if [ "$line_count" -eq 0 ]; then
                rm -f "$tmp_file"
                printf '%s\n' "scribe-spell: no spell content provided on stdin." >&2
                exit 1
        fi
        if spell_status; then
                rm -f "$tmp_file"
                return 0
        fi
        if [ ! -f "$rc_file" ]; then
                : >"$rc_file"
        fi
        ensure_trailing_newline
        if [ "$line_count" -eq 1 ]; then
                first_line=$(sed -n '1p' "$tmp_file")
                printf '%s%s\n' "$first_line" "$inline_marker" >>"$rc_file"
                rm -f "$tmp_file"
                return 0
        fi
        block_header="$block_start lines=$line_count"
        printf '%s\n' "$block_header" >>"$rc_file"
        cat "$tmp_file" >>"$rc_file"
        printf '%s\n' "$block_end" >>"$rc_file"
        rm -f "$tmp_file"
}

remove_spell() {
        if [ ! -f "$rc_file" ]; then
                printf '%s\n' "scribe-spell: cannot remove from missing file '$rc_file'." >&2
                exit 1
        fi
        tmp_file=$(mktemp "${TMPDIR:-/tmp}/scribe-spell.XXXXXX") || exit 1
        removing_block=0
        to_skip=0
        removed=0
        while IFS= read -r line || [ -n "$line" ]; do
                if [ "$removing_block" -eq 1 ]; then
                        if [ "$line" = "$block_end" ]; then
                                removing_block=0
                        fi
                        continue
                fi
                if [ "$to_skip" -gt 0 ]; then
                        to_skip=$((to_skip - 1))
                        continue
                fi
                case $line in
                "$block_start"*)
                        removing_block=1
                        removed=1
                        continue
                        ;;
                "$legacy_prefix"*)
                        count=${line#"$legacy_prefix"}
                        case $count in
                        *[!0-9]*)
                                to_skip=0
                                ;;
                        *)
                                to_skip=$count
                                ;;
                        esac
                        removed=1
                        continue
                        ;;
                *"$inline_marker")
                        removed=1
                        continue
                        ;;
                esac
                printf '%s\n' "$line" >>"$tmp_file"
        done <"$rc_file"
        if [ "$removed" -eq 0 ]; then
                rm -f "$tmp_file"
                printf '%s\n' "scribe-spell: spell '$spell' not found in '$rc_file'." >&2
                exit 1
        fi
        mv "$tmp_file" "$rc_file"
}

case $action in
add)
        add_spell
        ;;
remove)
        remove_spell
        ;;
status)
        if spell_status; then
                exit 0
        fi
        exit 1
        ;;
*)
        usage
        exit 1
        ;;
esac
