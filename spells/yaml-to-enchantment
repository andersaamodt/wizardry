#!/bin/sh

# This spell reads a YAML front matter block and restores its keys as attributes.
# After the transfer, it trims the prologue so the file holds only its content.

show_usage() {
        cat <<'USAGE'
Usage: yaml-to-enchantment <path-to-file>

Parse a YAML front matter header, write each key/value into the file's extended
attributes, and rewrite the file without the header.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

if [ "$#" -ne 1 ]; then
    printf '%s\n' "Error: incorrect number of arguments" >&2
    show_usage >&2
    exit 1
fi

scroll=$1
if [ ! -f "$scroll" ]; then
    printf '%s\n' "Error: file does not exist" >&2
    exit 1
fi

header_count=$(awk '/^---$/{c++} END{print c}' "$scroll")
if [ "$header_count" -lt 2 ]; then
    printf '%s\n' "Error: file does not have a YAML header" >&2
    exit 1
fi

yaml_header=$(awk '
    /^---$/ {delim++; next}
    delim==1 {print}
' "$scroll")

if [ -z "$yaml_header" ]; then
    printf '%s\n' "Error: file does not have a YAML header" >&2
    exit 1
fi

set_attr() {
    key=$1
    value=$2

    if command -v attr >/dev/null 2>&1; then
        attr -s "$key" -V "$value" "$scroll" 2>/dev/null && return 0
    fi
    if command -v setfattr >/dev/null 2>&1; then
        setfattr -n "$key" -v "$value" "$scroll" 2>/dev/null && return 0
    fi
    if command -v xattr >/dev/null 2>&1; then
        xattr -w "$key" "$value" "$scroll" 2>/dev/null && return 0
    fi
    return 1
}

printf '%s' "$yaml_header" |
    while IFS= read -r line || [ -n "$line" ]; do
        key=${line%%:*}
        value=${line#*:}
        value=${value# }
        set_attr "$key" "$value"
    done

body_tmp=$(mktemp "${TMPDIR:-/tmp}/wizardry-body.XXXXXX") || exit 1
awk '
    /^---$/ {delim++; next}
    delim<2 {next}
    {print}
' "$scroll" >"$body_tmp"
mv "$body_tmp" "$scroll"
