#!/bin/sh

# Manage PATH entries in a shell start-up file. This helper is deliberately
# conservative: it only prepends directories and removes the exact lines it
# previously added so repeated invocations remain idempotent.

set -eu

usage() {
        cat <<'USAGE' >&2
Usage: path-wizard [--rc-file FILE] add [DIRECTORY]
       path-wizard [--rc-file FILE] remove DIRECTORY
USAGE
}

# Default to .bashrc for backwards compatibility while permitting callers to
# override the profile via --rc-file or the PATH_WIZARD_RC environment variable.
rc_file=${PATH_WIZARD_RC:-"$HOME/.bashrc"}

while [ "$#" -gt 0 ]; do
        case $1 in
        --rc-file)
                if [ "$#" -lt 2 ]; then
                        printf '%s\n' "path-wizard: --rc-file expects a file path" >&2
                        usage
                        exit 1
                fi
                rc_file=$2
                shift 2
                ;;
        --rc-file=*)
                rc_file=${1#*=}
                shift
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                break
                ;;
        -*)
                printf '%s\n' "path-wizard: unknown option '$1'" >&2
                usage
                exit 1
                ;;
        *)
                break
                ;;
        esac
done

if [ "$#" -eq 0 ]; then
        usage
        exit 1
fi

action=$1
shift

case $action in
add|remove) : ;;
*)
        printf '%s\n' "Error: The first argument must be 'add' or 'remove'." >&2
        exit 1
        ;;
esac

# Determine the target directory. When adding and no directory is supplied use
# the current working directory; removals always require an explicit path.
if [ "$action" = "add" ]; then
        if [ "$#" -eq 0 ]; then
                directory=$(pwd -P)
        else
                directory=$1
        fi
elif [ "$#" -eq 0 ]; then
        printf '%s\n' "Error: The 'remove' action expects a directory argument." >&2
        exit 1
else
        directory=$1
fi

# Expand leading tildes by hand so the script works with POSIX sh.
case $directory in
"~")
        directory=$HOME
        ;;
"~"/*)
        directory=$HOME/${directory#\~/}
        ;;
esac

if [ ! -d "$directory" ]; then
        printf '%s\n' "Error: The directory does not exist." >&2
        exit 1
fi

# Resolve relative paths to absolute ones so duplicate entries are avoided.
case $directory in
/*) : ;;
.)
        directory=$(pwd -P)
        ;;
..|../*|./*)
        directory=$(cd "$directory" && pwd -P)
        ;;
*)
        directory=$(cd "$directory" && pwd -P)
        ;;
esac

# Create the rc file on demand for additions; removals still require the file to
# exist so we do not silently succeed when nothing could have been changed.
if [ ! -f "$rc_file" ]; then
        if [ "$action" = "add" ]; then
                if ! : >"$rc_file"; then
                        printf '%s\n' "Error: Unable to create '$rc_file'." >&2
                        exit 1
                fi
        else
                printf '%s\n' "Error: The startup file '$rc_file' does not exist." >&2
                exit 1
        fi
fi

pattern="export PATH=$directory:\$PATH"

case $action in
add)
        if grep -Fqx "$pattern" "$rc_file" 2>/dev/null; then
                printf '%s\n' "The directory is already in your PATH."
                exit 0
        fi
        printf '%s\n' "$pattern" >>"$rc_file"
        printf '%s\n' "The directory has been added to your PATH."
        printf '%s\n' "The changes to your PATH will take effect in new shells."
        ;;
remove)
        if ! grep -Fqx "$pattern" "$rc_file" 2>/dev/null; then
                printf '%s\n' "Error: The directory is not in your PATH." >&2
                exit 1
        fi
        tmp_file="$rc_file.wizardry.$$"
        if ! grep -Fv "$pattern" "$rc_file" >"$tmp_file"; then
                status=$?
                if [ "$status" -ge 2 ]; then
                        rm -f "$tmp_file"
                        printf '%s\n' "Error: Unable to update '$rc_file'." >&2
                        exit 1
                fi
        fi
        if ! mv "$tmp_file" "$rc_file"; then
                rm -f "$tmp_file"
                printf '%s\n' "Error: Unable to replace '$rc_file'." >&2
                exit 1
        fi
        printf '%s\n' "The directory has been removed from your PATH."
        printf '%s\n' "The changes to your PATH will take effect in new shells."
        ;;
esac
