#!/bin/sh

# This spell teleports you to your system trash directory.
# Must be sourced (not executed) to change your shell's directory.

case "${1-}" in
--help|--usage|-h)
  cat << 'USAGE'
Usage: . jump-trash

Teleport to your system trash directory.
This spell must be sourced (note the dot) to change your current directory.
USAGE
  exit 0
  ;;
esac

# Enforce sourced-only behavior (but don't exit the shell if already sourced)
# uncastable must be sourced (invoked), never executed (cast)
UNCASTABLE_MESSAGE='Use "jump trash" to invoke this spell, as it is uncastable directly.'
export UNCASTABLE_MESSAGE
if ! . uncastable; then
  exit 1
fi

set -eu
. env-clear

# Detect trash directory
if command -v detect-trash >/dev/null 2>&1; then
  trash_path=$(detect-trash)
else
  # Inline fallback if detect-trash is not available
  platform=''
  if command -v detect-distro >/dev/null 2>&1; then
    platform=$(detect-distro 2>/dev/null || printf 'unknown')
  else
    kernel=$(uname -s 2>/dev/null || printf 'unknown')
    case "$kernel" in
    Darwin) platform='mac' ;;
    Linux) platform='linux' ;;
    *) platform='unknown' ;;
    esac
  fi
  
  case "$platform" in
  mac)
    trash_path="$HOME/.Trash"
    ;;
  *)
    xdg_data="${XDG_DATA_HOME:-$HOME/.local/share}"
    trash_path="$xdg_data/Trash/files"
    ;;
  esac
fi

if [ -z "$trash_path" ]; then
  printf '%s\n' "jump-trash: could not determine trash directory" >&2
  exit 1
fi

if [ ! -d "$trash_path" ]; then
  printf '%s\n' "jump-trash: trash directory does not exist: $trash_path" >&2
  printf '%s\n' "The trash may be empty or the directory has not been created yet." >&2
  exit 1
fi

# Check if already in trash directory
current=$(pwd -P | sed 's|//|/|g')
normalized_trash=$(cd "$trash_path" && pwd -P | sed 's|//|/|g')

if [ "$current" = "$normalized_trash" ]; then
  printf '%s\n' "You are already in the trash."
  return 0
fi

cd "$trash_path" || exit 1
printf '%s\n' "You teleport to the trash at $trash_path"
