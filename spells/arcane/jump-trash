#!/bin/sh

# This spell teleports you to your system trash directory.
# Must be sourced (not executed) to change your shell's directory.

case "${1-}" in
--help|--usage|-h)
  cat << 'USAGE'
Usage: . jump-trash

Teleport to your system trash directory.
This spell must be sourced (note the dot) to change your current directory.
USAGE
  exit 0
  ;;
esac

# Uncastable: Must be sourced, not executed
_jt_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) _jt_sourced=1 ;;
  esac
else
  _jt_base=${0##*/}
  case "$_jt_base" in
    sh|dash|bash|zsh|ksh|mksh) _jt_sourced=1 ;;
    jump-trash) _jt_sourced=0 ;;
    *) _jt_sourced=1 ;;
  esac
fi

if [ "$_jt_sourced" -eq 0 ]; then
  printf '%s\n' "jump-trash: must be sourced, not executed" >&2
  printf '%s\n' "Usage: . jump-trash" >&2
  exit 1
fi
unset _jt_sourced _jt_base

set -eu
. env-clear

# Detect trash directory
if command -v detect-trash >/dev/null 2>&1; then
  trash_path=$(detect-trash)
else
  # Inline fallback if detect-trash is not available
  platform=''
  if command -v detect-distro >/dev/null 2>&1; then
    platform=$(detect-distro 2>/dev/null || printf 'unknown')
  else
    kernel=$(uname -s 2>/dev/null || printf 'unknown')
    case "$kernel" in
    Darwin) platform='mac' ;;
    Linux) platform='linux' ;;
    *) platform='unknown' ;;
    esac
  fi
  
  case "$platform" in
  mac)
    trash_path="$HOME/.Trash"
    ;;
  *)
    xdg_data="${XDG_DATA_HOME:-$HOME/.local/share}"
    trash_path="$xdg_data/Trash/files"
    ;;
  esac
fi

if [ -z "$trash_path" ]; then
  printf '%s\n' "jump-trash: could not determine trash directory" >&2
  exit 1
fi

if [ ! -d "$trash_path" ]; then
  printf '%s\n' "jump-trash: trash directory does not exist: $trash_path" >&2
  printf '%s\n' "The trash may be empty or the directory has not been created yet." >&2
  exit 1
fi

# Check if already in trash directory
current=$(pwd -P | sed 's|//|/|g')
normalized_trash=$(cd "$trash_path" && pwd -P | sed 's|//|/|g')

if [ "$current" = "$normalized_trash" ]; then
  printf '%s\n' "You are already in the trash."
  return 0
fi

cd "$trash_path" || exit 1
printf '%s\n' "You teleport to the trash at $trash_path"
