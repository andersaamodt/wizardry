#!/bin/sh

# This spell copies the text file at the specified path to the clipboard.
# It takes one argument, the path to the text file.
# When run without arguments, it prompts for the file path interactively.

show_usage() {
cat <<'USAGE'
Usage: copy <file>

Copy the contents of a text file to the system clipboard using pbcopy, xsel, or xclip. Prompts for a path when none is given and prints a confirmation when successful.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac
set -eu

# Handle missing argument - prompt interactively
if [ "$#" -eq 0 ]; then
    if command -v ask-text >/dev/null 2>&1; then
        file_path=$(ask-text "Enter file path to copy to clipboard:")
        if [ -z "$file_path" ]; then
            say 'No file path provided.'
            exit 1
        fi
        set -- "$file_path"
    else
        show_usage >&2
        exit 1
    fi
fi

is file "$1" || { say 'That file does not exist.'; exit 1; }

# Copy file contents to clipboard using the clip-copy imp
# Suppress clip-copy's error to avoid duplicate messages
if ! clip-copy < "$1" 2>/dev/null; then
    # Attempt to install a clipboard utility using the unified installer
    if command -v install-clipboard-helper >/dev/null 2>&1; then
        if install-clipboard-helper >/dev/null 2>&1 && clip-copy < "$1" 2>/dev/null; then
            : # Installation succeeded and copy worked
        else
            warn 'Your spell fizzles. No clipboard utility available (xsel, xclip, wl-copy, or pbcopy).'
            exit 1
        fi
    else
        warn 'Your spell fizzles. No clipboard utility available (xsel, xclip, wl-copy, or pbcopy).'
        exit 1
    fi
fi

# Normalize path for display
display_path=$(norm-path "$1")
say "Copied $display_path to your clipboard."
