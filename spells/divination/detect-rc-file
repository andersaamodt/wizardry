#!/bin/sh

# This spell selects the best shell rc file for PATH exports or memorization.
# It prints platform, rc_file, and format hints so callers can update startup files safely.

set -eu

usage() {
        cat <<'USAGE' >&2
Usage: detect-rc-file [--platform PLATFORM]

Detects the best startup file to modify for PATH exports or spell memorization.
Prints key=value pairs for the detected platform, rc_file, and format.
USAGE
}

platform="${DETECT_RC_FILE_PLATFORM-}"

while [ "$#" -gt 0 ]; do
        case $1 in
        --platform)
                if [ "$#" -lt 2 ]; then
                        printf '%s\n' "detect-rc-file: --platform expects a value." >&2
                        usage
                        exit 1
                fi
                platform=$2
                shift 2
                ;;
        --platform=*)
                        platform=${1#*=}
                        shift
                        ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                break
                ;;
        -*)
                printf '%s\n' "detect-rc-file: unknown option '$1'." >&2
                usage
                exit 1
                ;;
        *)
                break
                ;;
        esac
done

if [ "$#" -gt 0 ]; then
        printf '%s\n' "detect-rc-file: unexpected argument '$1'." >&2
        usage
        exit 1
fi

add_candidate() {
        file=$1
        if [ -z "$file" ]; then
                return 0
        fi
        for candidate in $RC_CANDIDATES; do
                if [ "$candidate" = "$file" ]; then
                        return 0
                fi
        done
        if [ -z "$RC_CANDIDATES" ]; then
                RC_CANDIDATES=$file
        else
                RC_CANDIDATES="$RC_CANDIDATES $file"
        fi
}

# Decide platform once so the downstream selection stays predictable.
if [ -z "$platform" ]; then
        if [ -f /etc/NIXOS ] || grep -qi 'ID=nixos' /etc/os-release 2>/dev/null; then
                platform=nixos
        elif [ -f /etc/debian_version ]; then
                platform=debian
        elif [ -f /etc/arch-release ]; then
                platform=arch
        elif [ -f /etc/fedora-release ]; then
                platform=fedora
        elif uname 2>/dev/null | grep -q 'Darwin'; then
                platform=mac
        else
                platform=unknown
        fi
fi

RC_CANDIDATES=''

case $platform in
mac)
        add_candidate "$HOME/.zshrc"
        add_candidate "$HOME/.zprofile"
        add_candidate "$HOME/.bash_profile"
        ;;
nixos)
        # For NixOS, prefer shell rc files over configuration.nix.
        # Only changes to configuration.nix persist through system rebuilds,
        # but modifying it automatically is risky and many users don't use home-manager.
        # Users who want to use configuration.nix can do so manually.
        add_candidate "$HOME/.bashrc"
        add_candidate "$HOME/.bash_profile"
        add_candidate "$HOME/.profile"
        ;;
debian|arch|fedora)
        add_candidate "$HOME/.bashrc"
        add_candidate "$HOME/.profile"
        ;;
*) : ;;
        esac

shell_name=${SHELL-}
if [ -z "$shell_name" ]; then
# Some non-interactive shells (like dash) do not export SHELL, so default to
# sh to keep the rc-file selection predictable even when the variable is
# unset.
shell_name=sh
fi

case ${shell_name##*/} in
zsh)
        add_candidate "$HOME/.zshrc"
        add_candidate "$HOME/.zprofile"
        ;;
bash)
        add_candidate "$HOME/.bashrc"
        add_candidate "$HOME/.bash_profile"
        ;;
*)
        add_candidate "$HOME/.profile"
        ;;
        esac

add_candidate "$HOME/.bashrc"
add_candidate "$HOME/.profile"

rc_file=''
for candidate in $RC_CANDIDATES; do
        if [ -f "$candidate" ]; then
                rc_file=$candidate
                break
        fi
done

if [ -z "$rc_file" ]; then
        for candidate in $RC_CANDIDATES; do
                rc_file=$candidate
                break
        done
fi

if [ -z "$rc_file" ]; then
        printf '%s\n' "detect-rc-file: unable to determine a startup file." >&2
        exit 1
fi

case $rc_file in
*.nix)
        format=nix
        ;;
*)
        format=shell
        ;;
        esac

printf 'platform=%s\n' "$platform"
printf 'rc_file=%s\n' "$rc_file"
printf 'format=%s\n' "$format"
