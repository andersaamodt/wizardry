#!/bin/sh
# Diagnostic script to check wizardry installation on macOS

echo "=== Wizardry Installation Diagnostic ==="
echo ""

echo "1. Shell:"
echo "   SHELL=$SHELL"
echo "   Running: $(ps -p $$ -o comm=)"
echo ""

echo "2. RC files:"
for rc in ~/.zprofile ~/.zshrc ~/.bash_profile ~/.bashrc; do
  if [ -f "$rc" ]; then
    echo "   ✓ $rc exists"
    if grep -q "invoke-wizardry" "$rc" 2>/dev/null; then
      echo "     - Contains invoke-wizardry"
      grep "invoke-wizardry" "$rc" | sed 's/^/       /'
    fi
  else
    echo "   ✗ $rc not found"
  fi
done
echo ""

echo "3. WIZARDRY_DIR:"
echo "   ${WIZARDRY_DIR:-NOT SET}"
echo ""

echo "4. Wizardry in PATH:"
if echo "$PATH" | grep -q "wizardry"; then
  echo "   ✓ Found in PATH"
  echo "$PATH" | tr ':' '\n' | grep wizardry | sed 's/^/     /'
else
  echo "   ✗ NOT in PATH"
fi
echo ""

echo "5. Can find menu:"
if command -v menu >/dev/null 2>&1; then
  echo "   ✓ YES: $(command -v menu)"
else
  echo "   ✗ NO - menu not found"
  echo "   This is the problem!"
fi
echo ""

echo "6. _WIZARDRY_INVOKED:"
echo "   ${_WIZARDRY_INVOKED:-NOT SET}"
echo ""

echo "7. SPELLBOOK_DIR:"
echo "   ${SPELLBOOK_DIR:-NOT SET}"
if [ -d "${SPELLBOOK_DIR:-}" ]; then
  echo "   ✓ Directory exists"
else
  echo "   ✗ Directory not found"
fi
echo ""

echo "=== Recommendations ==="
if ! command -v menu >/dev/null 2>&1; then
  echo ""
  echo "PROBLEM: menu command not found"
  echo ""
  echo "This means invoke-wizardry didn't run or PATH wasn't set."
  echo ""
  echo "Check these:"
  echo "  1. Is invoke-wizardry in your .zprofile? (on macOS, use .zprofile not .zshrc)"
  echo "  2. Does .zprofile have the correct path to invoke-wizardry?"
  echo "  3. Open a NEW terminal window (not tab) to test"
  echo ""
  if [ -n "${WIZARDRY_DIR:-}" ]; then
    echo "Expected line in ~/.zprofile:"
    echo "  . \"$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry\" # wizardry: wizardry-init"
  else
    echo "Expected line in ~/.zprofile:"
    echo '  . "$HOME/.wizardry/spells/.imps/sys/invoke-wizardry" # wizardry: wizardry-init'
  fi
  echo ""
fi
