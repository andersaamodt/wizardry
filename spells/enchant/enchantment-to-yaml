#!/bin/sh

# This spell copies extended attributes into a YAML prologue within the file.
# After the runes are preserved in text, it clears the attributes from the file.

case "${1-}" in
--help|--usage|-h)
  cat << 'USAGE'
Usage: enchantment-to-yaml <path-to-file>

Extract all extended attributes from a file, write them into a YAML front matter header, and strip the original attributes from the file.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Validate arguments
if [ "$#" -ne 1 ]; then
  printf '%s\n' "Error: incorrect number of arguments" >&2
  cat >&2 << 'USAGE'
Usage: enchantment-to-yaml <path-to-file>

Extract all extended attributes from a file, write them into a YAML front matter header, and strip the original attributes from the file.
USAGE
  exit 1
fi

file=$1
if [ ! -f "$file" ]; then
  printf '%s\n' "Error: file does not exist" >&2
  exit 1
fi

# Get all extended attribute keys
keys=$(attribute-list "$file" || true)
if [ -z "$keys" ]; then
  printf '%s\n' "Error: file does not have extended attributes" >&2
  exit 1
fi

# Create YAML front matter with attributes
tmp=$(temp-file wizardry-yaml) || exit 1
{
  printf '%s\n' '---'
  for key in $keys; do
    [ -z "$key" ] && continue
    value=$(attribute-get "$key" "$file" || printf '')
    printf '%s: %s\n' "$key" "$value"
  done
  printf '%s\n' '---'
  printf '\n'
} >"$tmp"
cat "$file" >>"$tmp" || exit 1
mv "$tmp" "$file"

# Clear attributes from file - check if we have tools available
has_attr_tool=0
if attribute-tool-check xattr; then
  has_attr_tool=1
elif attribute-tool-check attr; then
  has_attr_tool=1
elif attribute-tool-check setfattr; then
  has_attr_tool=1
fi

if [ "$has_attr_tool" -eq 0 ]; then
  printf '%s\n' "Error: requires one of attr, xattr, or setfattr to clear attributes" >&2
  exit 1
fi

# Clear all attributes using available tools
if attribute-tool-check xattr; then
  xattr -c "$file" 2>/dev/null || true
fi

for key in $keys; do
  [ -z "$key" ] && continue
  if attribute-tool-check attr; then
    attr -r "$key" "$file" 2>/dev/null || true
  fi
  if attribute-tool-check setfattr; then
    setfattr -x "$key" "$file" 2>/dev/null || true
  fi
  if attribute-tool-check xattr; then
    xattr -d "$key" "$file" 2>/dev/null || true
  fi
done
