#!/bin/sh

# This spell applies an extended attribute to a file.
# Provide a file, attribute name, value, and optional helper preference.

show_usage() {
        cat <<'USAGE'
Usage: enchant <file> <attribute> <value> [helper]

Apply an extended attribute with the given name and value to the file, using
attr, xattr, or setfattr. Optionally specify which helper to try first.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

require_args() {
        if [ "$#" -lt 3 ] || [ "$#" -gt 4 ]; then
                printf '%s\n' "Error: This spell requires three or four arguments: a file path, an attribute name, and a value." >&2
                return 1
        fi
}

file_exists() {
        if [ ! -e "$1" ]; then
                printf '%s\n' "Error: The file does not exist." >&2
                return 1
        fi
}

set_with_attr() {
        if command -v attr >/dev/null 2>&1; then
                attr -s "$1" -V "$2" "$3"
                return $?
        fi

        return 127
}

set_with_xattr() {
        if command -v xattr >/dev/null 2>&1; then
                xattr -w "$1" "$2" "$3"
                return $?
        fi

        return 127
}

set_with_setfattr() {
        if command -v setfattr >/dev/null 2>&1; then
                setfattr -n "$1" -v "$2" "$3"
                return $?
        fi

        return 127
}

helpers_for_preference() {
        preferred=$1
        case "$preferred" in
        "")
                printf '%s\n' attr xattr setfattr
                ;;
        attr|xattr|setfattr)
                printf '%s\n' "$preferred"
                for helper in attr xattr setfattr; do
                        if [ "$helper" != "$preferred" ]; then
                                printf '%s\n' "$helper"
                        fi
                done
                ;;
        *)
                printf '%s\n' "Error: Unknown helper '$preferred'. Choose attr, xattr, or setfattr." >&2
                return 1
                ;;
        esac
}

set_attribute() {
        key=$1
        value=$2
        file=$3
        preferred=${4-}
        helpers=$(helpers_for_preference "$preferred") || return 1

        attempted_helper=""
        attempt_status=0

        for helper in $helpers; do
                case "$helper" in
                attr)
                        set_with_attr "$key" "$value" "$file" ;;
                xattr)
                        set_with_xattr "$key" "$value" "$file" ;;
                setfattr)
                        set_with_setfattr "$key" "$value" "$file" ;;
                esac

                status=$?
                case "$status" in
                0)
                        return 0 ;;
                127)
                        ;; # Helper unavailable; try the next option.
                *)
                        attempted_helper=$helper
                        attempt_status=$status
                        ;;
                esac
        done

        if [ -n "$attempted_helper" ]; then
                printf "%s\n" "Error: Failed to set attribute using '$attempted_helper' (exit $attempt_status)." >&2
        else
                printf "%s\n" "Error: This spell requires the 'attr', 'xattr', or 'setfattr' command to be installed." >&2
        fi

        return 1
}

main() {
        if ! require_args "$@"; then
                exit 1
        fi

        file=$1
        key=$2
        value=$3
        preferred=${4-}

        if ! file_exists "$file"; then
                exit 1
        fi

        if ! set_attribute "$key" "$value" "$file" "$preferred"; then
                exit 1
        fi

        printf "The file has been enchanted with the attribute '%s' and value '%s'.\n" "$key" "$value"
}

main "$@"
