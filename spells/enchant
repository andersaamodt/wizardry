#!/bin/sh

# Enchant a file with an extended attribute.
# Usage: enchant <file> <attribute> <value> [helper]
#
# This incantation is intentionally linear: gather the ingredients, check the
# reliquary (the file), and try each tool in turn until one binds the sigil.
# The commentary stays close to the code so future wizards can trace the
# ritual without hunting through helper libraries.

require_args() {
  if [ "$#" -lt 3 ] || [ "$#" -gt 4 ]; then
    printf '%s\n' "Error: This spell requires three or four arguments: a file path, an attribute name, and a value."
    return 1
  fi
}

file_exists() {
  if [ ! -e "$1" ]; then
    printf '%s\n' "Error: The file does not exist."
    return 1
  fi
}

set_with_attr() {
  command -v attr >/dev/null 2>&1 && attr -s "$1" -V "$2" "$3"
}

set_with_xattr() {
  command -v xattr >/dev/null 2>&1 && xattr -w "$1" "$2" "$3"
}

set_with_setfattr() {
  command -v setfattr >/dev/null 2>&1 && setfattr -n "$1" -v "$2" "$3"
}

main() {
  if ! require_args "$@"; then
    exit 1
  fi

  file=$1
  key=$2
  value=$3

  if ! file_exists "$file"; then
    exit 1
  fi

  if set_with_attr "$key" "$value" "$file"; then
    :
  elif set_with_xattr "$key" "$value" "$file"; then
    :
  elif set_with_setfattr "$key" "$value" "$file"; then
    :
  else
    printf "%s\n" "Error: This spell requires the 'attr', 'xattr', or 'setfattr' command to be installed."
    exit 1
  fi

  printf "The file has been enchanted with the attribute '%s' and value '%s'.\n" "$key" "$value"
}

main "$@"
