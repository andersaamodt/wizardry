#!/bin/sh

# This spell reads a YAML front matter block and restores its keys as attributes.
# After the transfer, it trims the prologue so the file holds only its content.

show_usage() {
        cat <<'USAGE'
Usage: yaml-to-enchantment <path-to-file>

Parse a YAML front matter header, write each key/value into the file's extended
attributes, and rewrite the file without the header.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

if [ "$#" -ne 1 ]; then
    printf '%s\n' "Error: incorrect number of arguments" >&2
    show_usage >&2
    exit 1
fi

scroll=$1
if [ ! -f "$scroll" ]; then
    printf '%s\n' "Error: file does not exist" >&2
    exit 1
fi

header_count=$(awk '/^---$/{c++} END{print c}' "$scroll")
if [ "$header_count" -lt 2 ]; then
    printf '%s\n' "Error: file does not have a YAML header" >&2
    exit 1
fi

yaml_header=$(awk '
    /^---$/ {delim++; next}
    delim==1 {print}
' "$scroll")

if [ -z "$yaml_header" ]; then
    printf '%s\n' "Error: file does not have a YAML header" >&2
    exit 1
fi

set_attr() {
    key=$1
    value=$2

    if helper_path=$(resolve_helper attr); then
        if "$helper_path" -s "$key" -V "$value" "$scroll" 2>/dev/null; then
            return 0
        fi
    fi
    if helper_path=$(resolve_helper setfattr); then
        if "$helper_path" -n "$key" -v "$value" "$scroll" 2>/dev/null; then
            return 0
        fi
    fi
    if helper_path=$(resolve_helper xattr); then
        if "$helper_path" -w "$key" "$value" "$scroll" 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

resolve_helper() {
    helper=$1
    if ! command -v "$helper" >/dev/null 2>&1; then
        return 1
    fi

    helper_path=$(command -v "$helper")
    if [ "${WIZARDRY_TEST_HELPERS_ONLY-0}" -eq 1 ]; then
        case "$helper_path" in
            /usr/*|/bin/*|/sbin/*|/usr/local/*)
                return 1 ;;
        esac
    fi

    printf '%s\n' "$helper_path"
}

if ! (resolve_helper attr >/dev/null 2>&1 || resolve_helper setfattr >/dev/null 2>&1 || resolve_helper xattr >/dev/null 2>&1); then
    printf '%s\n' "Error: requires attr, setfattr, or xattr to restore enchantments" >&2
    exit 1
fi

printf '%s' "$yaml_header" |
    while IFS= read -r line || [ -n "$line" ]; do
        key=${line%%:*}
        value=${line#*:}
        value=${value# }
        if [ -z "$key" ]; then
            continue
        fi
        if ! set_attr "$key" "$value"; then
            printf '%s\n' "Error: failed to set attribute $key" >&2
            exit 1
        fi
    done || exit 1

body_tmp=$(mktemp "${TMPDIR:-/tmp}/wizardry-body.XXXXXX") || exit 1
awk '
    /^---$/ {delim++; next}
    delim<2 {next}
    {print}
' "$scroll" >"$body_tmp"
mv "$body_tmp" "$scroll"
