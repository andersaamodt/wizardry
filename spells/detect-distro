#!/usr/bin/env sh

# Identify the current operating system and print a short identifier such as
# "debian", "mac", or "nixos". When invoked with -v the script emits a more
# descriptive message while still exporting $DISTRO for callers.

set -eu

verbose=0
while getopts v opt
do
        case $opt in
        v)
                verbose=1
                ;;
        *)
                printf '%s\n' 'Usage: detect-distro [-v]' >&2
                exit 1
                ;;
        esac
done
shift $((OPTIND - 1))

if [ "$#" -ne 0 ]; then
        printf '%s\n' 'Usage: detect-distro [-v]' >&2
        exit 1
fi

detect_distro() {
        if [ -f /etc/NIXOS ] || grep -i 'ID=nixos' /etc/os-release >/dev/null 2>&1; then
                printf '%s' 'nixos'
                return 0
        fi
        if [ -f /etc/debian_version ]; then
                printf '%s' 'debian'
                return 0
        fi
        if [ -f /etc/arch-release ]; then
                printf '%s' 'arch'
                return 0
        fi
        if [ -f /etc/fedora-release ]; then
                printf '%s' 'fedora'
                return 0
        fi
        if uname >/dev/null 2>&1; then
                case $(uname) in
                Darwin)
                        printf '%s' 'mac'
                        return 0
                        ;;
                esac
        fi
        return 1
}

if distro=$(detect_distro); then
        DISTRO=$distro
        export DISTRO
else
        printf '%s\n' 'unknown'
        exit 1
fi

if [ "$verbose" -eq 1 ]; then
        case $DISTRO in
        debian)
                printf '%s\n' 'Debian, Ubuntu, or Raspbian OS detected.'
                ;;
        arch)
                printf '%s\n' 'Arch or Manjaro-based OS detected.'
                ;;
        fedora)
                printf '%s\n' 'Fedora detected as the operating system.'
                ;;
        mac)
                printf '%s\n' 'MacOS detected.'
                ;;
        nixos)
                printf '%s\n' 'NixOS detected.'
                ;;
        esac
else
        printf '%s\n' "$DISTRO"
fi
