#!/usr/bin/env sh

# This spell prints a short identifier for the current OS.
# Use -v to narrate detection while exporting DISTRO for callers.

show_usage() {
        cat <<'USAGE'
Usage: detect-distro [-v]

Detect the host operating system and print a concise identifier such as
"debian", "mac", or "nixos". With -v, also print a descriptive message while
exporting DISTRO for callers to reuse.
USAGE
}

case "${1-}" in
--help|--usage)
        show_usage
        exit 0
        ;;
esac

set -eu

# Parse flags for verbose output or help text.
verbose=0
while getopts hv opt
do
        case $opt in
        v)
                verbose=1
                ;;
        h)
                show_usage
                exit 0
                ;;
        *)
                show_usage >&2
                exit 1
                ;;
        esac
done
shift $((OPTIND - 1))

if [ "$#" -ne 0 ]; then
        show_usage >&2
        exit 1
fi

# Detect from specific markers toward the generic uname fallback.
if [ -f /etc/NIXOS ] || grep -i 'ID=nixos' /etc/os-release >/dev/null 2>&1; then
        distro='nixos'
elif [ -f /etc/debian_version ]; then
        distro='debian'
elif [ -f /etc/arch-release ]; then
        distro='arch'
elif [ -f /etc/fedora-release ]; then
        distro='fedora'
elif uname >/dev/null 2>&1 && [ "$(uname)" = "Darwin" ]; then
        distro='mac'
fi

# Export the detection so callers can key off the result.
if [ -n "${distro-}" ]; then
        DISTRO=$distro
        export DISTRO
else
        printf '%s\n' 'unknown'
        exit 1
fi

if [ "$verbose" -eq 1 ]; then
        case $DISTRO in
        debian)
                printf '%s\n' 'Debian, Ubuntu, or Raspbian OS detected.'
                ;;
        arch)
                printf '%s\n' 'Arch or Manjaro-based OS detected.'
                ;;
        fedora)
                printf '%s\n' 'Fedora detected as the operating system.'
                ;;
        mac)
                printf '%s\n' 'MacOS detected.'
                ;;
        nixos)
                printf '%s\n' 'NixOS detected.'
                ;;
        esac
else
        printf '%s\n' "$DISTRO"
fi
