#!/bin/sh

# This spell copies extended attributes into a YAML prologue within the file.
# After the runes are preserved in text, it clears the attributes from the file.

show_usage() {
        cat <<'USAGE'
Usage: enchantment-to-yaml <path-to-file>

Extract all extended attributes from the file, write them into a YAML front
matter header, and strip the original attributes from the file.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

if [ "$#" -ne 1 ]; then
    printf '%s\n' "Error: incorrect number of arguments" >&2
    show_usage >&2
    exit 1
fi

file=$1
if [ ! -f "$file" ]; then
    printf '%s\n' "Error: file does not exist" >&2
    exit 1
fi

parse_attr_output() {
    printf '%s' "$1" | sed 's/.*has a value:[[:space:]]*//'
}

list_keys() {
    target=$1
    if command -v xattr >/dev/null 2>&1; then
        if keys=$(xattr "$target" 2>/dev/null); then
            printf '%s\n' "$keys"
            return 0
        fi
    fi
    if command -v attr >/dev/null 2>&1; then
        if keys=$(attr -l "$target" 2>/dev/null); then
            printf '%s\n' "$keys" | awk -F '"' '/Attribute/ {print $2}'
            return 0
        fi
    fi
    if command -v getfattr >/dev/null 2>&1; then
        if keys=$(getfattr -d "$target" 2>/dev/null); then
            printf '%s' "$keys" | awk -F '=' '/^# / {next} {print $1}'
            return 0
        fi
    fi
    return 1
}

read_value() {
    key=$1
    target=$2

    if command -v xattr >/dev/null 2>&1; then
        if output=$(xattr -p "$key" "$target" 2>/dev/null); then
            printf '%s' "$output"
            return 0
        fi
    fi
    if command -v attr >/dev/null 2>&1; then
        if output=$(attr -g "$key" "$target" 2>/dev/null); then
            parse_attr_output "$output"
            return 0
        fi
    fi
    if command -v getfattr >/dev/null 2>&1; then
        if output=$(getfattr -n "$key" --only-values "$target" 2>/dev/null); then
            printf '%s' "$output"
            return 0
        fi
    fi
    return 1
}

keys=$(list_keys "$file")
if [ -z "$keys" ]; then
    printf '%s\n' "Error: file does not have extended attributes" >&2
    exit 1
fi

tmp=$(mktemp "${TMPDIR:-/tmp}/wizardry-yaml.XXXXXX") || exit 1
{
    printf '%s\n' '---'
    for key in $keys; do
        [ -z "$key" ] && continue
        value=$(read_value "$key" "$file" || printf '')
        printf '%s: %s\n' "$key" "$value"
    done
    printf '%s\n' '---'
    printf '\n'
} >"$tmp"
cat "$file" >>"$tmp" || exit 1
mv "$tmp" "$file"

if ! (command -v xattr >/dev/null 2>&1 || command -v attr >/dev/null 2>&1 || command -v setfattr >/dev/null 2>&1); then
    printf '%s\n' "Error: requires one of attr, xattr, or setfattr to clear attributes" >&2
    exit 1
fi

if command -v xattr >/dev/null 2>&1; then
    xattr -c "$file" 2>/dev/null || true
fi

for key in $keys; do
    [ -z "$key" ] && continue
    if command -v attr >/dev/null 2>&1; then
        attr -r "$key" "$file" 2>/dev/null || true
    fi
    if command -v setfattr >/dev/null 2>&1; then
        setfattr -x "$key" "$file" 2>/dev/null || true
    fi
    if command -v xattr >/dev/null 2>&1; then
        xattr -d "$key" "$file" 2>/dev/null || true
    fi
done
