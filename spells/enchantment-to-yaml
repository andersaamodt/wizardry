#!/bin/sh

# This spell copies extended attributes into a YAML prologue within the file.
# After the runes are preserved in text, it clears the attributes from the file.

show_usage() {
        cat <<'USAGE'
Usage: enchantment-to-yaml <path-to-file>

Extract all extended attributes from the file, write them into a YAML front
matter header, and strip the original attributes from the file.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

if [ "$#" -ne 1 ]; then
    printf '%s\n' "Error: incorrect number of arguments" >&2
    show_usage >&2
    exit 1
fi

file=$1
if [ ! -f "$file" ]; then
    printf '%s\n' "Error: file does not exist" >&2
    exit 1
fi

list_keys() {
    target=$1
    if command -v xattr >/dev/null 2>&1; then
        xattr "$target" 2>/dev/null && return 0
    fi
    if command -v attr >/dev/null 2>&1; then
        attr -l "$target" 2>/dev/null && return 0
    fi
    if command -v getfattr >/dev/null 2>&1; then
        getfattr -d "$target" 2>/dev/null |
            awk -F '=' '/^# / {next} {print $1}' && return 0
    fi
    return 1
}

keys=$(list_keys "$file")
if [ -z "$keys" ]; then
    printf '%s\n' "Error: file does not have extended attributes" >&2
    exit 1
fi

tmp=$(mktemp "${TMPDIR:-/tmp}/wizardry-yaml.XXXXXX") || exit 1
{
    printf '%s\n' '---'
    for key in $keys; do
        [ -z "$key" ] && continue
        printf '%s:\n' "$key"
    done
    printf '%s\n' '---'
    printf '\n'
} >"$tmp"
cat "$file" >>"$tmp" || exit 1
mv "$tmp" "$file"

if command -v xattr >/dev/null 2>&1; then
    xattr -c "$file" 2>/dev/null || true
fi

for key in $keys; do
    [ -z "$key" ] && continue
    if command -v attr >/dev/null 2>&1; then
        attr -r "$key" "$file" 2>/dev/null || true
    fi
    if command -v setfattr >/dev/null 2>&1; then
        setfattr -x "$key" "$file" 2>/dev/null || true
    fi
    if command -v xattr >/dev/null 2>&1; then
        xattr -d "$key" "$file" 2>/dev/null || true
    fi
done
