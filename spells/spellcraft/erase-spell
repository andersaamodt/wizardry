#!/bin/sh
. declare-globals
# erase-spell - Delete a custom spell from ~/.spellbook
# Asks for confirmation before deleting.

set -eu

resolve_spellbook_dir() {
        if [ -n "${SPELLBOOK_DIR-}" ]; then
                printf '%s' "$SPELLBOOK_DIR"
        elif [ -n "${XDG_DATA_HOME-}" ] && [ -n "$XDG_DATA_HOME" ]; then
                printf '%s' "$XDG_DATA_HOME/wizardry/spellbook"
        elif [ -n "${HOME-}" ] && [ -n "$HOME" ]; then
                printf '%s' "$HOME/.spellbook"
        else
                printf '%s' ".spellbook"
        fi
}

spellbook_dir=$(resolve_spellbook_dir)

usage() {
        cat <<'USAGE'
Usage: erase-spell NAME [--force]

Delete a custom spell from ~/.spellbook. This action cannot be undone.

Options:
  --force, -f   Skip confirmation prompt
  --help, -h    Show this help message
USAGE
}

find_custom_spell() {
        name=$1
        # Check in spellbook_dir root
        script_path="$spellbook_dir/$name"
        if [ -f "$script_path" ] && [ -x "$script_path" ]; then
                printf '%s' "$script_path"
                return 0
        fi
        # Check in spellbook_dir subfolders
        for subdir in "$spellbook_dir"/*; do
                [ -d "$subdir" ] || continue
                script_path="$subdir/$name"
                if [ -f "$script_path" ] && [ -x "$script_path" ]; then
                        printf '%s' "$script_path"
                        return 0
                fi
        done
        return 1
}

force=0
name=""

while [ "$#" -gt 0 ]; do
        case $1 in
                --help|-h)
                        usage
                        exit 0
                        ;;
                --force|-f)
                        force=1
                        shift
                        ;;
                -*)
                        printf 'erase-spell: unknown option: %s\n' "$1" >&2
                        exit 1
                        ;;
                *)
                        if [ -z "$name" ]; then
                                name=$1
                        else
                                printf 'erase-spell: unexpected argument: %s\n' "$1" >&2
                                exit 1
                        fi
                        shift
                        ;;
        esac
done

if [ -z "$name" ]; then
        usage >&2
        exit 1
fi

# Find the spell
script_path=$(find_custom_spell "$name") || {
        printf 'erase-spell: spell "%s" not found in %s\n' "$name" "$spellbook_dir" >&2
        exit 1
}

# Check if it's actually in spellbook_dir (not a built-in spell)
case "$script_path" in
        "$spellbook_dir"/*)
                : # OK, it's a custom spell
                ;;
        *)
                printf 'erase-spell: "%s" is not a custom spell and cannot be erased\n' "$name" >&2
                exit 1
                ;;
esac

# Ask for confirmation unless --force
if [ "$force" -eq 0 ]; then
        printf 'Erase spell "%s"? This cannot be undone. (y/N) ' "$name"
        read -r answer
        case $answer in
                [Yy]|[Yy][Ee][Ss])
                        : # proceed
                        ;;
                *)
                        printf 'Aborted.\n'
                        exit 0
                        ;;
        esac
fi

# Delete the spell
rm -f "$script_path"
printf 'Erased spell "%s".\n' "$name"
