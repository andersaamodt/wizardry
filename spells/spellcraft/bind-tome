#!/bin/sh

# This spell binds every file in a directory into a single tome.
# Pass -d to recycle the loose pages after the binding completes.


set -eu
usage() {
        cat <<'USAGE'
Usage: bind-tome [-d] <page-directory>

Bind every file in the provided directory into a single <dirname>.txt tome.
Pass -d to delete the original pages after binding.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        usage
        exit 0
        ;;
esac

# Parse options early so -h works even with missing args.
delete_sources=0
while getopts ":dh" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        h)
            usage
            exit 0
            ;;
        *)
            usage >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Require a directory of pages to stitch together.
if [ "$#" -lt 1 ]; then
    warn "bind-tome: folder path required."
    usage >&2
    exit 1
fi

pages_dir=$1
# Fail fast if the provided path is not a directory of pages.
is dir "$pages_dir" || { warn "Error: '$pages_dir' is not a directory."; exit 1; }

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

# Append each page with headers so the merged tome is navigable.
for page in "$pages_dir"/*; do
    there "$page" || continue
    page_name=$(basename -- "$page")
    say "----- $page_name -----" >>"$text_file"
    cat "$page" >>"$text_file"
    say "----- End of $page_name -----" >>"$text_file"
done

say "Text file created: $text_file"

# Optionally remove the original pages once the tome is complete.
if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        there "$page" || continue
        rm -- "$page"
    done
    say "Original files deleted."
fi
