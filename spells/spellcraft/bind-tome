#!/bin/sh

# This spell binds every file in a directory into a single tome.
# Pass -d to recycle the loose pages after the binding completes.

require-wizardry || exit 1

bind_tome_usage() {
cat <<'USAGE'
Usage: bind-tome [-d] <page-directory>

Bind every file in a directory into a single <dirname>.txt tome. Use -d to delete the original pages after binding if you want to keep only the finished book.
USAGE
}


bind_tome() {
case "${1-}" in
--help|--usage|-h)
  bind_tome_usage
  return 0
  ;;
esac

set -eu
. env-clear

# Parse options early so -h works even with missing args.
delete_sources=0
while getopts ":dh" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        h)
            bind_tome_usage
            return 0
            ;;
        *)
            bind_tome_usage >&2
            return 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Require a directory of pages to stitch together.
if [ "$#" -lt 1 ]; then
    warn "bind-tome: folder path required."
    bind_tome_usage >&2
    return 1
fi

pages_dir=$1
# Fail fast if the provided path is not a directory of pages.
is dir "$pages_dir" || { warn "Error: '$pages_dir' is not a directory."; return 1; }

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

# Append each page with headers so the merged tome is navigable.
# Use single-line separator with centered filename
for page in "$pages_dir"/*; do
    there "$page" || continue
    page_name=$(basename -- "$page")
    
    # Use heading-separator imp for consistent formatting
    heading-separator "$page_name" 76 "#" >>"$text_file"
    cat "$page" >>"$text_file"
done

say "Text file created: $text_file"

# Optionally remove the original pages once the tome is complete.
if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        there "$page" || continue
        rm -- "$page"
    done
    say "Original files deleted."
fi
}

# Self-execute when run directly (not sourced)
case "$0" in
  */bind-tome) bind_tome "$@" ;; esac
