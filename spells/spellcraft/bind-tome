#!/bin/sh

# This spell binds every file in a directory into a single tome.
# Pass -d to recycle the loose pages after the binding completes.

require-wizardry || return 1

bind_tome_usage() {
cat <<'USAGE'
Usage: bind-tome [-d] <page-directory>

Bind every file in a directory into a single <dirname>.txt tome. Use -d to delete the original pages after binding if you want to keep only the finished book.
USAGE
}


bind_tome() {
case "${1-}" in
--help|--usage|-h)
  bind_tome_usage
  return 0
  ;;
esac

set -eu
. env-clear

# Parse options early so -h works even with missing args.
delete_sources=0
while getopts ":dh" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        h)
            bind_tome_usage
            return 0
            ;;
        *)
            bind_tome_usage >&2
            return 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Require a directory of pages to stitch together.
if [ "$#" -lt 1 ]; then
    warn "bind-tome: folder path required."
    bind_tome_usage >&2
    return 1
fi

pages_dir=$1
# Fail fast if the provided path is not a directory of pages.
is dir "$pages_dir" || { warn "Error: '$pages_dir' is not a directory."; return 1; }

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

# Append each page with headers so the merged tome is navigable.
# Use single-line separator with centered filename
for page in "$pages_dir"/*; do
    there "$page" || continue
    page_name=$(basename -- "$page")
    
    # Use heading-separator imp for consistent formatting
    heading-separator "$page_name" 76 "#" >>"$text_file"
    cat "$page" >>"$text_file"
done

say "Text file created: $text_file"

# Optionally remove the original pages once the tome is complete.
if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        there "$page" || continue
        rm -- "$page"
    done
    say "Original files deleted."
fi
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
      _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
      _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
      _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
      _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
      _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
      [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
