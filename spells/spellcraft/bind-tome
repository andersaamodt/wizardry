#!/bin/sh

# This spell binds every file in a directory into a single tome.
# Pass -d to recycle the loose pages after the binding completes.

require-wizardry || exit 1

show_usage() {
cat <<'USAGE'
Usage: bind-tome [-d] <page-directory>

Bind every file in a directory into a single <dirname>.txt tome. Use -d to delete the original pages after binding if you want to keep only the finished book.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac
set -eu

# Parse options early so -h works even with missing args.
delete_sources=0
while getopts ":dh" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        h)
            show_usage
            exit 0
            ;;
        *)
            show_usage >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Require a directory of pages to stitch together.
if [ "$#" -lt 1 ]; then
    warn "bind-tome: folder path required."
    show_usage >&2
    exit 1
fi

pages_dir=$1
# Fail fast if the provided path is not a directory of pages.
is dir "$pages_dir" || { warn "Error: '$pages_dir' is not a directory."; exit 1; }

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

# Append each page with headers so the merged tome is navigable.
# Use single-line separator with centered filename
for page in "$pages_dir"/*; do
    there "$page" || continue
    page_name=$(basename -- "$page")
    # Create centered separator: # -------- pagename --------
    # Total width is 76 chars (matching LICENSE separator width)
    name_len=${#page_name}
    # Available space for dashes: 76 - 2 (for "# ") - name_len - 2 (spaces around name)
    # Minimum dash space of 8 ensures readable formatting even with long names
    dash_space=$((76 - 2 - name_len - 2))
    if [ "$dash_space" -lt 8 ]; then
        # Filename too long, truncate it
        max_name_len=$((76 - 2 - 8 - 2))  # Leave room for at least 8 dashes total
        page_name=$(printf '%s' "$page_name" | cut -c1-"$max_name_len")
        name_len=${#page_name}
        dash_space=$((76 - 2 - name_len - 2))
    fi
    left_dashes=$((dash_space / 2))
    right_dashes=$((dash_space - left_dashes))
    
    # Build the separator line
    separator="# "
    i=0
    while [ "$i" -lt "$left_dashes" ]; do
        separator="${separator}-"
        i=$((i + 1))
    done
    separator="${separator} ${page_name} "
    i=0
    while [ "$i" -lt "$right_dashes" ]; do
        separator="${separator}-"
        i=$((i + 1))
    done
    
    say "$separator" >>"$text_file"
    cat "$page" >>"$text_file"
done

say "Text file created: $text_file"

# Optionally remove the original pages once the tome is complete.
if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        there "$page" || continue
        rm -- "$page"
    done
    say "Original files deleted."
fi
