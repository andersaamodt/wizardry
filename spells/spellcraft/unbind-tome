#!/bin/sh

# This spell splits a bound tome back into individual page files.
# It derives filenames from page headers so the restored pages are easy to revisit.

usage() {
    cat <<'USAGE'
Usage: unbind-tome <tome-path>

Split a bound tome back into individual files, naming each page from its
contents and placing them in a directory derived from the tome name.
USAGE
}

case "${1-}" in
--help|--usage|-h)
    usage
    exit 0
    ;;
esac

if [ "$#" -lt 1 ]; then
    printf '%s\n' "Error: Please provide a file path as an argument." >&2
    usage >&2
    exit 1
fi

tome=$1
if [ ! -f "$tome" ]; then
    printf '%s\n' "Error: '$tome' is not a file." >&2
    exit 1
fi

stem=$(basename -- "$tome")
stem=${stem%.*}

pages_dir=$stem
suffix=1
while [ -e "$pages_dir" ]; do
    pages_dir="${stem}${suffix}"
    suffix=$((suffix + 1))
done
mkdir -p "$pages_dir"

page_number=1
while IFS= read -r line || [ -n "$line" ]; do
    clean_name=$(printf '%s' "$line" | tr -dc '[:alnum:] .,;_-' | tr ' ' '_')
    if [ -z "$clean_name" ]; then
        clean_name="page_${page_number}"
    fi
    printf '%s\n' "$line" >"$pages_dir/$clean_name"
    page_number=$((page_number + 1))
done <"$tome"
