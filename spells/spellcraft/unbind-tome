#!/bin/sh

# This spell splits a bound tome back into individual page files.
# It derives filenames from page headers so the restored pages are easy to revisit.


set -eu
usage() {
    cat <<'USAGE'
Usage: unbind-tome <tome-path>

Split a bound tome back into individual files, naming each page from its
contents and placing them in a directory derived from the tome name.
USAGE
}

case "${1-}" in
--help|--usage|-h)
    usage
    exit 0
    ;;
esac

if [ "$#" -lt 1 ]; then
    warn "unbind-tome: missing file path argument."
    usage >&2
    exit 1
fi

tome=$1
is file "$tome" || { warn "Error: '$tome' is not a file."; exit 1; }

stem=$(basename -- "$tome")
stem=${stem%.*}

pages_dir=$stem
suffix=1
while there "$pages_dir"; do
    pages_dir="${stem}${suffix}"
    suffix=$((suffix + 1))
done
make dir "$pages_dir"

page_number=1
while IFS= read -r line || nonempty "$line"; do
    clean_name=$(printf '%s' "$line" | tr -dc '[:alnum:] .,;_-' | tr ' ' '_')
    empty "$clean_name" && clean_name="page_${page_number}"
    say "$line" >"$pages_dir/$clean_name"
    page_number=$((page_number + 1))
done <"$tome"
