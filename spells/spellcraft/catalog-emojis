#!/bin/sh

# Catalog emoji usage across AI-facing documentation (.github/ files).
# Displays frequency table showing which emojis appear in which files.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: catalog-emojis [--verbose]

Scan .github/ directory for emoji annotations and display a frequency table
showing each emoji, how many times it appears, and which files contain it.

Options:
  --verbose    Show detailed file paths and line counts per file
  --help       Show this help message

This spell reveals emergent patterns in emoji annotations across AI-facing
documentation, helping identify symbolic clusters and semantic fields.
USAGE
  exit 0
  ;;
esac

set -eu

# Find repository root
script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
repo_dir=$(CDPATH= cd -- "$script_dir/../.." && pwd -P)

# Source env-clear with conditional fallback for standalone execution
if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/.imps/sys/env-clear" ]; then
  . "${WIZARDRY_DIR}/spells/.imps/sys/env-clear"
elif [ -f "$repo_dir/spells/.imps/sys/env-clear" ]; then
  . "$repo_dir/spells/.imps/sys/env-clear"
fi
github_dir="$repo_dir/.github"

# Check if .github directory exists
if [ ! -d "$github_dir" ]; then
  printf 'catalog-emojis: .github directory not found\n' >&2
  exit 1
fi

verbose=0
if [ "${1-}" = "--verbose" ]; then
  verbose=1
fi

# Create temp files for processing
tmpdir="${TMPDIR:-/tmp}"
emoji_list="$tmpdir/catalog-emojis-list.$$"
emoji_freq="$tmpdir/catalog-emojis-freq.$$"
emoji_files="$tmpdir/catalog-emojis-files.$$"

# Cleanup on exit
trap 'rm -f "$emoji_list" "$emoji_freq" "$emoji_files"' EXIT HUP INT TERM

# Extract all emojis from .github/ markdown files
# Use Python for portable emoji extraction (works on all platforms)
# Covers common emoji Unicode blocks but avoids ASCII and markdown symbols
find "$github_dir" -type f -name "*.md" -print0 | xargs -0 python3 -c '
import sys
import re

# Emoji Unicode ranges (common blocks)
emoji_pattern = re.compile(
    "["
    "\U0001F300-\U0001F9FF"  # Misc Symbols and Pictographs, Emoticons, Transport, etc
    "\U00002600-\U000026FF"  # Misc symbols
    "\U00002700-\U000027BF"  # Dingbats
    "\U00002300-\U000023FF"  # Misc Technical
    "\U00002B00-\U00002BFF"  # Misc Symbols and Arrows
    "\U0001F000-\U0001F02F"  # Mahjong, Domino tiles
    "\U0001F0A0-\U0001F0FF"  # Playing cards
    "\U0001F100-\U0001F64F"  # Enclosed chars, Emoticons
    "\U0001F680-\U0001F6FF"  # Transport and Map symbols
    "\U0001F900-\U0001F9FF"  # Supplemental Symbols
    "\U0001FA00-\U0001FA6F"  # Chess, Extended-A
    "\U0001FA70-\U0001FAFF"  # Symbols and Pictographs Extended-A
    "\U0000FE00-\U0000FE0F"  # Variation Selectors
    "]+"
)

for filepath in sys.argv[1:]:
    try:
        with open(filepath, "r", encoding="utf-8", errors="ignore") as f:
            content = f.read()
            for match in emoji_pattern.finditer(content):
                print(match.group())
    except Exception:
        pass
' -- "$@" > "$emoji_list" 2>/dev/null || touch "$emoji_list"

# If no emojis found, report and exit
if [ ! -s "$emoji_list" ]; then
  printf 'No emojis found in .github/ documentation.\n'
  exit 0
fi

# Count emoji frequency
sort "$emoji_list" | uniq -c | sort -rn > "$emoji_freq"

# Build file mapping for each emoji
> "$emoji_files"
while IFS= read -r line; do
  count=$(printf '%s' "$line" | awk '{print $1}')
  emoji=$(printf '%s' "$line" | awk '{print $2}')
  
  # Find files containing this emoji
  md_files=$(find "$github_dir" -type f -name "*.md" 2>/dev/null)
  files=$(printf '%s\n' "$md_files" | xargs grep -l "$emoji" 2>/dev/null | sed "s|^$repo_dir/||")
  
  if [ "$verbose" -eq 1 ]; then
    # Verbose mode: show count per file
    printf '%s\t%s\t%s\n' "$count" "$emoji" "FILES:" >> "$emoji_files"
    for file in $files; do
      file_count=$(grep -o "$emoji" "$repo_dir/$file" 2>/dev/null | wc -l | tr -d ' ')
      printf '%s\t%s\t  %s (%s)\n' "" "" "$file" "$file_count" >> "$emoji_files"
    done
  else
    # Compact mode: one line per emoji
    file_list=$(printf '%s' "$files" | tr '\n' ', ' | sed 's/,$//' | sed 's/,/, /g')
    printf '%s\t%s\t%s\n' "$count" "$emoji" "$file_list" >> "$emoji_files"
  fi
done < "$emoji_freq"

# Display results
printf '\n=== Emoji Frequency in .github/ Documentation ===\n\n'
printf 'Total unique emojis: %s\n' "$(wc -l < "$emoji_freq" | tr -d ' ')"
printf 'Total emoji instances: %s\n\n' "$(wc -l < "$emoji_list" | tr -d ' ')"

if [ "$verbose" -eq 1 ]; then
  printf '%-8s %-8s %s\n' 'COUNT' 'EMOJI' 'LOCATIONS'
  printf '%s\n' '----------------------------------------'
else
  printf '%-8s %-8s %s\n' 'COUNT' 'EMOJI' 'FILES'
  printf '%s\n' '----------------------------------------'
fi

# Display the catalog
awk -F'\t' '{printf "%-8s %-8s %s\n", $1, $2, $3}' "$emoji_files"

printf '\n'

