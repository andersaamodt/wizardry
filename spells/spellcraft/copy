#!/bin/sh

# This spell copies the text file at the specified path to the clipboard.
# It takes one argument, the path to the text file.

show_usage() {
        cat <<'USAGE'
Usage: copy <file>

Copy the contents of the specified text file to the system clipboard using
pbcopy, xsel, or xclip. Prints a confirmation when successful.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

if [ "$#" -ne 1 ]; then
        printf '%s\n' "That file does not exist."
        exit 1
fi

file=$1

if [ ! -f "$file" ]; then
        printf '%s\n' "That file does not exist."
        exit 1
fi

helper_usable() {
        helper=$1
        if ! command -v "$helper" >/dev/null 2>&1; then
                return 1
        fi

        if [ "${WIZARDRY_TEST_HELPERS_ONLY-0}" -eq 1 ]; then
                helper_path=$(command -v "$helper")
                case "$helper_path" in
                        /usr/*|/bin/*|/sbin/*|/usr/local/*)
                                return 1 ;;
                esac
        fi

        return 0
}

copied=0
if helper_usable pbcopy; then
        pbcopy <"$file"
        copied=1
elif helper_usable xsel; then
        xsel --clipboard --input <"$file"
        copied=1
elif helper_usable xclip; then
        xclip -selection clipboard <"$file"
        copied=1
fi

if [ "$copied" -ne 1 ]; then
        printf '%s\n' "Your spell fizzles. No clipboard utilities are available on this system. Please install xsel, xclip, or pbcopy (for mac)" >&2
        exit 1
fi

printf 'Copied %s to your clipboard.\n' "$file"
