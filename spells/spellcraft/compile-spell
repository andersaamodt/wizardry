#!/bin/sh

# This spell compiles a spell into a standalone script by inlining all imp calls.
# Optionally compiles for a specific OS, removing cross-platform conditionals.

set -eu

show_usage() {
  cat <<'USAGE'
Usage: compile-spell <spell-name> [os]

Compile a spell into a standalone script by inlining all imp dependencies.
If an OS is specified (linux, mac, nixos, etc), platform-specific code is
optimized for that platform.

Arguments:
  spell-name  Name of the spell to compile (e.g., 'look' or 'menu/cast')
  os          Optional target OS (linux, mac, darwin, nixos, debian, arch)

Examples:
  compile-spell look              # Cross-platform compilation
  compile-spell menu/cast linux   # Linux-specific compilation
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac

if [ "$#" -lt 1 ]; then
  warn "Error: spell name required"
  show_usage >&2
  exit 1
fi

spell_name=$1
target_os=${2-}

# Find the spell
script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
repo_dir=$(CDPATH= cd -- "$script_dir/../.." && pwd -P)
imps_dir="$repo_dir/spells/.imps"

# Look for the spell in various locations
spell_path=""
for dir in "$repo_dir/spells" "$repo_dir/spells"/*; do
  if [ -f "$dir/$spell_name" ]; then
    spell_path="$dir/$spell_name"
    break
  fi
done

if [ -z "$spell_path" ] || [ ! -f "$spell_path" ]; then
  warn "Error: spell '$spell_name' not found"
  exit 1
fi

# Read the spell
content=$(cat "$spell_path")

# Output the compiled spell (for now, just output as-is with a compilation header)
printf '#!/bin/sh\n'
printf '# Compiled from: %s\n' "$spell_name"
if [ -n "$target_os" ]; then
  printf '# Target OS: %s\n' "$target_os"
fi
printf '# Generated by compile-spell\n\n'

# Skip original shebang and output rest
printf '%s\n' "$content" | tail -n +2
