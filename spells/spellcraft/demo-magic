#!/bin/sh

# Demonstrate wizardry spells at specified levels with narrated output.
# Each demo level corresponds to a banish level and demonstrates the spells
# that are validated and tested by that banish level.

# Demo a single level using spell-levels data
demo_level() {
  level=$1
  
  # Get level name and spell list using spell-levels imp
  level_name=$(spell-levels "$level" name)
  spell_list=$(spell-levels "$level" spells)
  imp_list=$(spell-levels "$level" imps)
  
  printf '\n'
  printf '=== Level %d: %s ===\n' "$level" "$level_name"
  printf '\n'
  
  # Add level-specific narration and demonstrations
  case "$level" in
    0)
      printf 'The wizard examines the foundation of reality itself...\n'
      printf '\n'
      
      # Actually run detect-posix
      if command -v detect-posix >/dev/null 2>&1; then
        printf 'The wizard casts detect-posix...\n'
        detect-posix 2>&1 | head -5
        printf '\n'
      fi
      
      # Run detect-distro
      if command -v detect-distro >/dev/null 2>&1; then
        printf 'The wizard casts detect-distro...\n'
        printf 'Distribution: %s\n' "$(detect-distro)"
        printf '\n'
      fi
      
      # Check infrastructure  
      if [ -d "${WIZARDRY_DIR}/spells" ]; then
        spell_count=$(find "${WIZARDRY_DIR}/spells" -type f -executable 2>/dev/null | wc -l)
        printf 'The spells grimoire: %d spells inscribed\n' "$spell_count"
      fi
      
      if [ -d "${WIZARDRY_DIR}/spells/.imps" ]; then
        imp_count=$(find "${WIZARDRY_DIR}/spells/.imps" -type f 2>/dev/null | wc -l)
        printf 'The imp summoning circles: %d imps bound\n' "$imp_count"
      fi
      ;;
      
    1)
      printf 'The wizard gathers the core components of wizardry...\n'
      printf '\n'
      
      # Demonstrate validate-spells
      if command -v validate-spells >/dev/null 2>&1; then
        printf 'The wizard casts validate-spells on core infrastructure...\n'
        validate-spells banish:wards validate-spells:.wizardry 2>&1 | head -3
        printf '\n'
      fi
      
      # Show core imps
      printf 'Core imps summoned: %d foundational helpers\n' "$(printf '%s' "$imp_list" | wc -w)"
      printf 'Including: has, there, is, say, warn, die, temp-file, and more...\n'
      ;;
      
    2)
      printf 'The wizard conjures the glossary system...\n'
      printf '\n'
      
      if [ -f "${WIZARDRY_DIR}/spells/.wizardry/generate-glosses" ]; then
        printf 'The wizard has the power to cast generate-glosses...\n'
        printf '(Glossary generation extracts help text from all spells)\n'
      fi
      ;;
      
    3)
      printf 'The wizard weaves interactive menus from pure thought...\n'
      printf '\n'
      
      # Demonstrate fathom-terminal
      if command -v fathom-terminal >/dev/null 2>&1; then
        printf 'The wizard casts fathom-terminal...\n'
        if term_size=$(fathom-terminal 2>&1); then
          printf 'Terminal dimensions discovered: %s\n' "$term_size"
          printf '\n'
        else
          printf 'Terminal dimensions unavailable (no TTY)\n'
          printf '\n'
        fi
      fi
      
      # List menu capabilities
      printf 'Menu system capabilities unlocked:\n'
      printf '  • Interactive menu navigation\n'
      printf '  • Terminal size detection\n'
      printf '  • Cursor positioning\n'
      printf '  • Keypress detection\n'
      printf '  • Color support\n'
      ;;
      
    4)
      printf 'The wizard masters interactive menus and terminal control...\n'
      printf '\n'
      
      printf 'Menu system capabilities:\n'
      printf '  • menu - Interactive spell selection\n'
      printf '  • fathom-terminal - Detect terminal dimensions\n'
      printf '  • fathom-cursor - Query cursor position\n'
      printf '  • move-cursor - Position cursor on screen\n'
      printf '  • await-keypress - Capture user input\n'
      printf '  • cursor-blink - Control cursor visibility\n'
      printf '  • colors - Terminal color support\n'
      printf '  • main-menu - Launch interactive wizardry menu\n'
      ;;
      
    9)
      printf 'The wizard masters arcane file operations...\n'
      printf '\n'
      
      # Demonstrate read-magic
      if command -v read-magic >/dev/null 2>&1; then
        printf 'The wizard casts read-magic...\n'
        printf '(Reads extended attributes from files)\n'
        printf 'Reading the read-magic spell itself:\n'
        read-magic "${WIZARDRY_DIR}/spells/arcane/read-magic" 2>&1 | head -5 || printf '  (No attributes set)\n'
        printf '\n'
      fi
      
      printf 'File operations available:\n'
      printf '  • copy - Copy files with optional extended attributes\n'
      printf '  • trash - Move files to trash instead of deleting\n'
      printf '  • read-magic - Read extended attributes\n'
      printf '  • forall - Execute commands on multiple files\n'
      ;;
      
    10)
      printf 'The wizard learns basic cantrips...\n'
      printf '\n'
      
      # Demonstrate ask-yn (with auto-response via pipe)
      if command -v ask-yn >/dev/null 2>&1; then
        printf 'The wizard casts ask-yn "Is this a demonstration?" yes\n'
        printf 'y\n' | ask-yn "Is this a demonstration?" yes 2>&1 || true
        printf '\n'
      fi
      ;;
      
    5)
      printf 'The wizard enchants files with metadata...\n'
      printf '\n'
      
      # Demonstrate enchant
      if [ -f "${WIZARDRY_DIR}/spells/enchant/enchant" ]; then
        printf 'Extended attribute spells:\n'
        printf '  • enchant - Add magical properties to files\n'
        printf '  • disenchant - Remove enchantments\n'
        printf '  • enchantment-to-yaml - Export metadata\n'
        printf '  • yaml-to-enchantment - Import metadata\n'
        printf '\n'
        printf 'These spells work with filesystem extended attributes,\n'
        printf 'storing rich metadata alongside files.\n'
      fi
      ;;
      
    6)
      printf 'The wizard manages task priorities...\n'
      printf '\n'
      
      printf 'Priority management system:\n'
      printf '  • get-priority - View item priority\n'
      printf '  • prioritize - Set item priority\n'
      printf '  • deprioritize - Reduce item priority\n'
      printf '  • upvote - Increase priority\n'
      printf '  • get-card - Get priority card data\n'
      printf '  • get-new-priority - Calculate new priority value\n'
      printf '  • priorities - Interactive priority management menu\n'
      printf '\n'
      printf 'Enables tracking and sorting tasks by importance.\n'
      ;;
      
    7)
      printf 'The wizard learns translocation magic...\n'
      printf '\n'
      
      printf 'Navigation spells allow instant travel between marked locations:\n'
      printf '  • mark-location - Mark current directory for later return\n'
      printf '  • jump-to-marker - Return to a marked location\n'
      printf '\n'
      printf 'Example usage:\n'
      printf '  $ mark-location home\n'
      printf '  $ cd /tmp\n'
      printf '  $ jump-to-marker home  # Returns to original location\n'
      ;;
      
    8)
      printf 'The wizard masters the MUD realm...\n'
      printf '\n'
      
      printf 'MUD Basics provide the foundation for the Multi-User Dungeon:\n'
      printf '  • check-cd-hook - Hook for directory changes\n'
      printf '  • look - Examine current location\n'
      printf '\n'
      printf 'Extended attributes enable magical properties on files and folders.\n'
      ;;
      
    10)
      printf 'The wizard learns basic cantrips...\n'
      printf '\n'
      
      # Demo cantrips that are available
      printf 'Basic cantrips for everyday magic:\n'
      printf '  • ask, ask-yn, ask-text - Interactive prompts\n'
      printf '  • ask-number - Numeric input with validation\n'
      printf '  • max-length - Find longest string\n'
      printf '  • list-files - List files in directory\n'
      printf '  • move - Move files\n'
      printf '  • memorize - Add spells to shell init\n'
      printf '\n'
      printf 'Validation helpers are now imps:\n'
      printf '  • validate-number, validate-path, require-command\n'
      ;;
      
    11)
      printf 'The wizard advances in the cantrip arts...\n'
      printf '\n'
      
      # Demonstrate ask-number  
      if command -v ask-number >/dev/null 2>&1; then
        printf 'The wizard casts ask-number...\n'
        printf '7\n' | ask-number "Pick a lucky number" 2>&1 | head -3 || true
        printf '\n'
      fi
      
      printf 'Advanced cantrips:\n'
      printf '  • ask-number - Interactive numeric input with validation\n'
      printf '  • memorize - Add spells to shell initialization for persistence\n'
      ;;
      
    12)
      printf 'The wizard configures the system...\n'
      printf '\n'
      
      # Demonstrate package-managers
      if command -v package-managers >/dev/null 2>&1; then
        printf 'The wizard casts package-managers...\n'
        package-managers 2>&1 | head -5
        printf '\n'
      fi
      
      printf 'System configuration capabilities:\n'
      printf '  • config - Read/write configuration values\n'
      printf '  • logs - View system logs\n'
      printf '  • package-managers - Detect and use system package managers\n'
      ;;
      
    13)
      printf 'The wizard establishes the testing framework...\n'
      printf '\n'
      
      if [ -f "${WIZARDRY_DIR}/spells/.wizardry/test-magic" ]; then
        test_count=$(find "${WIZARDRY_DIR}/.tests" -name "test-*.sh" 2>/dev/null | wc -l)
        printf 'The wizard casts test-magic...\n'
        printf 'Testing infrastructure ready: %d test suites available\n' "$test_count"
        printf '\n'
        printf 'Testing framework enables:\n'
        printf '  • Automated spell validation\n'
        printf '  • Regression prevention\n'
        printf '  • Quality assurance\n'
      fi
      ;;
      
    14)
      printf 'The wizard learns system maintenance...\n'
      printf '\n'
      
      printf 'System maintenance spells:\n'
      printf '  • update-wizardry - Update wizardry to latest version\n'
      printf '  • update-all - Update all system packages\n'
      printf '  • kill-process - Gracefully terminate processes\n'
      printf '\n'
      printf 'Example: update-wizardry pulls latest changes from repository\n'
      ;;
      
    15)
      printf 'The wizard demonstrates the demonstration itself...\n'
      printf 'Recursion: demo-magic demonstrating demo-magic!\n'
      printf '\n'
      printf 'The demo-magic spell you are currently experiencing\n'
      printf 'is itself a Level 14 spell, demonstrating self-reference.\n'
      ;;
      
    16)
      printf 'The wizard practices divination...\n'
      printf '\n'
      
      # Demonstrate detect-rc-file
      if command -v detect-rc-file >/dev/null 2>&1; then
        printf 'The wizard casts detect-rc-file...\n'
        rc_file=$(detect-rc-file 2>&1 || true)
        if [ -n "$rc_file" ]; then
          printf 'Shell RC file detected: %s\n' "$rc_file"
        fi
        printf '\n'
      fi
      
      printf 'Divination spells reveal hidden knowledge:\n'
      printf '  • detect-rc-file - Find shell initialization file\n'
      printf '  • detect-magic - Discover wizardry installations\n'
      printf '  • identify-room - Determine current location context\n'
      ;;
      
    17)
      printf 'The wizard enhances the MUD realm...\n'
      printf '\n'
      
      printf 'Advanced MUD features:\n'
      printf '  • decorate - Add descriptions and names to locations\n'
      printf '  • choose-player - Choose active player identity\n'
      printf '\n'
      printf 'These spells extend the MUD metaphor, allowing rich\n'
      printf 'environmental storytelling and multi-user scenarios.\n'
      ;;
      
    18)
      printf 'The wizard delves into cryptography...\n'
      printf '\n'
      
      # Demonstrate hash with a simple example
      # Use the crypto/hash spell, not the shell builtin
      if command -v sha256sum >/dev/null 2>&1 || command -v shasum >/dev/null 2>&1; then
        printf 'The wizard casts hash to compute file checksums...\n'
        # Create a small temp file for demonstration
        demo_file="${TMPDIR:-/tmp}/wizardry-demo-$$"
        printf 'demo content\n' > "$demo_file"
        if command -v sha256sum >/dev/null 2>&1; then
          hash_result=$(sha256sum "$demo_file" 2>&1 | head -1)
          hash_result=${hash_result:-'Hash: 0xABCD1234 (example)'}
        else
          hash_result=$(shasum -a 256 "$demo_file" 2>&1 | head -1)
          hash_result=${hash_result:-'Hash: 0xABCD1234 (example)'}
        fi
        printf '%s\n' "$hash_result" | head -1
        rm -f "$demo_file"
        printf '\n'
      fi
      
      printf 'Cryptographic spells:\n'
      printf '  • hash - Generate cryptographic hashes\n'
      printf '  • evoke-hash - Hash with specific algorithm\n'
      printf '  • hashchant - Verify hash integrity\n'
      ;;
      
    19)
      printf 'The wizard opens portals to remote realms...\n'
      printf '\n'
      
      printf 'SSH and remote access capabilities:\n'
      printf '  • validate-ssh-key - Verify SSH key validity\n'
      printf '  • enchant-portkey - Create SSH connection bookmark\n'
      printf '  • follow-portkey - Connect via saved portkey\n'
      printf '  • open-portal - Establish SSH tunnel\n'
      printf '  • reload-ssh/restart-ssh - Manage SSH daemon\n'
      printf '\n'
      printf 'These spells make remote system access effortless.\n'
      ;;
      
    20)
      printf 'The wizard develops psychic abilities...\n'
      printf '\n'
      
      printf 'PSI (Process & System Info) spells:\n'
      printf '  • list-contacts - Show available process contacts\n'
      printf '  • read-contact - Read process information\n'
      printf '\n'
      printf 'Access system and process information telepathically.\n'
      ;;
      
    22)
      printf 'The wizard becomes a spellcrafter...\n'
      printf '\n'
      
      # Demonstrate lint-magic
      if command -v lint-magic >/dev/null 2>&1; then
        printf 'The wizard casts lint-magic on demo-magic itself...\n'
        lint-magic "${WIZARDRY_DIR}/spells/spellcraft/demo-magic" 2>&1 | head -3 || true
        printf '\n'
      fi
      
      printf 'Spellcraft development tools:\n'
      printf '  • scribe-spell - Create new spells\n'
      printf '  • lint-magic - Validate spell code quality\n'
      printf '  • compile-spell - Compile spells (when applicable)\n'
      printf '  • learn/forget - Manage spell knowledge\n'
      printf '  • doppelganger - Clone and modify spells\n'
      printf '\n'
      printf 'Complete toolkit for spell development and maintenance.\n'
      ;;
      
    23)
      printf 'The wizard constructs menu infrastructure...\n'
      printf '\n'
      
      printf 'Core menu system:\n'
      printf '  • spellbook - Browse available spells\n'
      printf '  • cast - Execute spells from menu\n'
      printf '  • spell-menu - Interactive spell selection\n'
      printf '\n'
      printf 'Foundation for all wizardry menu interfaces.\n'
      ;;
      
    24)
      printf 'The wizard builds system menus...\n'
      printf '\n'
      
      printf 'Configuration and management menus:\n'
      printf '  • system-menu - System administration\n'
      printf '  • install-menu - Installation options\n'
      printf '  • synonym-menu - Command alias management\n'
      printf '  • thesaurus - Synonym dictionary\n'
      printf '\n'
      printf 'High-level interfaces for system configuration.\n'
      ;;
      
    25)
      printf 'The wizard administers the MUD realm...\n'
      printf '\n'
      
      printf 'MUD administration:\n'
      printf '  • mud-menu - MUD navigation interface\n'
      printf '  • mud-settings - Configure MUD behavior\n'
      printf '  • mud-admin-menu - Administrative controls\n'
      printf '  • Player management: add-ssh-player, new-player, set-player\n'
      printf '\n'
      printf 'Complete suite for multi-user dungeon administration.\n'
      ;;
      
    26)
      printf 'The wizard creates specialized menus...\n'
      printf '\n'
      
      printf 'Domain-specific interfaces:\n'
      printf '  • network-menu - Network configuration\n'
      printf '  • services-menu - Service management\n'
      printf '  • shutdown-menu - System shutdown options\n'
      printf '  • priority-menu - Priority management interface\n'
      printf '  • users-menu - User administration\n'
      printf '\n'
      printf 'Specialized menus for specific system domains.\n'
      ;;
      
    27)
      printf 'The wizard masters service management...\n'
      printf '\n'
      
      printf 'System service spells:\n'
      printf '  • install-service-template - Create new service\n'
      printf '  • enable-service/disable-service - Control startup\n'
      printf '  • start-service/stop-service/restart-service - Service control\n'
      printf '  • service-status - Check service state\n'
      printf '  • is-service-installed - Verify installation\n'
      printf '\n'
      printf 'Complete systemd/service management toolkit.\n'
      ;;
      
    27)
      printf 'The wizard peers into the arcana...\n'
      printf '\n'
      
      if [ -d "${WIZARDRY_DIR}/spells/.arcana" ]; then
        arcana_count=$(find "${WIZARDRY_DIR}/spells/.arcana" -type f 2>/dev/null | wc -l)
        printf 'The arcana vault is accessible!\n'
        printf 'Third-party extensions found: %d items\n' "$arcana_count"
      else
        printf 'The arcana vault remains sealed.\n'
        printf 'No third-party extensions are currently installed.\n'
      fi
      printf '\n'
      printf 'Level 27 is reserved for optional extensions,\n'
      printf 'third-party integrations, and experimental spells.\n'
      ;;
      
    *)
      # For other levels, show a summary
      printf 'The wizard channels level %d energies...\n' "$level"
      printf '\n'
      
      # Count and display spells
      if [ -n "$spell_list" ]; then
        spell_count=$(printf '%s' "$spell_list" | wc -w)
        printf 'Spells at this level: %d\n' "$spell_count"
        
        # Show first few spells
        first_spells=$(printf '%s' "$spell_list" | tr ' ' '\n' | head -5 | sed 's/:.*//; s/^/  • /')
        printf '%s\n' "$first_spells"
        
        remaining=$((spell_count - 5))
        if [ "$remaining" -gt 0 ]; then
          printf '  ... and %d more\n' "$remaining"
        fi
        printf '\n'
      fi
      
      # Count imps
      if [ -n "$imp_list" ]; then
        imp_count=$(printf '%s' "$imp_list" | wc -w)
        printf 'Imps summoned: %d micro-helpers\n' "$imp_count"
      fi
      ;;
  esac
  
  # Show spell coverage for transparency
  if [ -n "$spell_list" ]; then
    printf '\n'
    printf '%s\n' '---'
    
    # List spells at this level (remove directory suffix)
    spell_names=$(printf '%s' "$spell_list" | tr ' ' '\n' | sed 's/:.*$//')
    spell_count=$(printf '%s' "$spell_names" | grep '.' | wc -l || printf '0')
    
    # Track which spells were mentioned in demonstrations
    demonstrated=""
    not_demonstrated=""
    
    # shellcheck disable=SC2086
    for spell_name in $spell_names; do
      # Check if this spell was specifically demonstrated (not just listed)
      case "$level" in
        0)
          case "$spell_name" in
            detect-posix|detect-distro|verify-posix) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        1)
          case "$spell_name" in
            validate-spells) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        3)
          case "$spell_name" in
            fathom-terminal) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        4)
          case "$spell_name" in
            look) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        7)
          case "$spell_name" in
            read-magic) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        8)
          case "$spell_name" in
            ask-yn) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        9)
          case "$spell_name" in
            validate-number) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        10)
          case "$spell_name" in
            ask-number) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        12)
          case "$spell_name" in
            package-managers) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        16)
          case "$spell_name" in
            detect-rc-file) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        18)
          case "$spell_name" in
            hash) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        24)
          case "$spell_name" in
            lint-magic) demonstrated="$demonstrated $spell_name" ;;
            *) not_demonstrated="$not_demonstrated $spell_name" ;;
          esac
          ;;
        *)
          # For levels without live demonstrations, all are just described
          not_demonstrated="$not_demonstrated $spell_name"
          ;;
      esac
    done
    
    # Display coverage summary
    demonstrated_count=$(printf '%s' "$demonstrated" | wc -w)
    not_demonstrated_count=$(printf '%s' "$not_demonstrated" | wc -w)
    
    if [ "$demonstrated_count" -gt 0 ]; then
      printf 'Spells demonstrated live: %d/%d\n' "$demonstrated_count" "$spell_count"
      if [ "$not_demonstrated_count" -gt 0 ]; then
        # Format the list nicely
        not_demo_list=$(printf '%s' "$not_demonstrated" | tr -s ' ' | sed 's/^ //; s/ /, /g')
        printf 'Described (not executed): %s\n' "$not_demo_list"
      fi
    else
      if [ "$spell_count" -gt 0 ]; then
        printf 'Spells at this level: %d (described, not executed live)\n' "$spell_count"
      fi
    fi
  fi
  
  # Explicit success return to avoid propagating non-zero exit codes from internal commands
  return 0
}

# Detect WIZARDRY_DIR if not set (for direct execution)
if [ -z "${WIZARDRY_DIR-}" ]; then
  # Try to detect from script location
  if command -v dirname >/dev/null 2>&1 && command -v cd >/dev/null 2>&1 \
     && command -v pwd >/dev/null 2>&1; then
    script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || script_dir=""
    if [ -n "$script_dir" ]; then
      wiz_root=$(CDPATH= cd -- "$script_dir/../.." 2>/dev/null && pwd -P) || wiz_root=""
      if [ -n "$wiz_root" ] && [ -d "$wiz_root/spells" ]; then
        WIZARDRY_DIR=$wiz_root
        export WIZARDRY_DIR
      fi
    fi
  fi
  
  # Fallback to standard location
  if [ -z "${WIZARDRY_DIR-}" ] && [ -n "${HOME-}" ] && [ -d "${HOME}/.wizardry/spells" ]; then
    WIZARDRY_DIR="${HOME}/.wizardry"
    export WIZARDRY_DIR
  fi
fi

# Main script logic (unwrapped from demo_magic function)
case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: demo-magic [LEVEL|all]

Demonstrate wizardry features by running checks on spells and narrating results.
Each level demonstrates spells validated by the corresponding banish level.

Arguments:
  LEVEL         Demonstration level (0-27)
  all           Demonstrate all levels (default)
                Level 0: POSIX & platform foundation
                Level 1: Wizardry installation
                Level 2: Glossary system
                Level 3: Menu system
                Level 4+: Higher-level spells (see SPELL_LEVELS.md)
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Add imps to PATH for spell demonstrations
if [ -n "${WIZARDRY_DIR-}" ]; then
  # Build imp path
  imp_path="${WIZARDRY_DIR}/spells/.imps/sys"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/cond"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/out"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/fs"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/str"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/paths"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/text"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/input"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/lex"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/menu"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/pkg"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/test"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/lang"
  PATH="$imp_path:$PATH"
  export PATH
fi

# Add spell directories to PATH for demonstrations
if [ -n "${WIZARDRY_DIR-}" ]; then
  PATH="$WIZARDRY_DIR/spells/.wizardry:$PATH"
  for dir in "$WIZARDRY_DIR"/spells/*; do
    [ -d "$dir" ] || continue
    PATH="$dir:$PATH"
  done
  export PATH
fi

# Note: validate-spells is now a flat-file spell in PATH, not a function

# Parse level argument
demo_level=27  # Default to all levels
if [ "$#" -gt 0 ]; then
  case "$1" in
    all)
      demo_level=27
      shift
      ;;
    [0-9]|[0-9][0-9])
      demo_level=$1
      shift
      ;;
    *)
      printf 'demo-magic: invalid level: %s\n' "$1" >&2
      cat <<'USAGE' >&2
Usage: demo-magic [LEVEL|all]

Demonstrate wizardry features by running checks on spells and narrating results.
Each level demonstrates spells validated by the corresponding banish level.

Arguments:
  LEVEL         Demonstration level (0-27)
  all           Demonstrate all levels (default)
                Level 0: POSIX & platform foundation
                Level 1: Wizardry installation
                Level 2: Glossary system
                Level 3: Menu system
                Level 4+: Higher-level spells (see SPELL_LEVELS.md)
USAGE
      exit 2
      ;;
  esac
fi

# Sandbox with bwrap if not in GitHub Actions and not already sandboxed
if [ "${WIZARDRY_DEMO_IN_BWRAP-0}" -ne 1 ] && [ "${WIZARDRY_DEMO_NO_BWRAP-0}" -ne 1 ]; then
  # Skip bwrap in GitHub Actions (already isolated)
  if [ -z "${GITHUB_ACTIONS-}" ] || [ "${GITHUB_ACTIONS}" != "true" ]; then
    if command -v bwrap >/dev/null 2>&1; then
      # Re-exec with bwrap sandbox
      exec bwrap --unshare-user --ro-bind / / --dev-bind /dev /dev --bind /proc /proc \
        --bind /tmp /tmp --setenv PATH "$PATH" --setenv WIZARDRY_DEMO_IN_BWRAP 1 -- \
        "$0" "$@"
    else
      # bwrap not available - offer to install
      printf 'demo-magic: bubblewrap (bwrap) not found\n' >&2
      printf 'demo-magic: Running demos in an isolated sandbox is recommended for safety.\n' >&2
      
      # Check if we can install it
      if command -v pkg-install >/dev/null 2>&1; then
        if command -v ask-yn >/dev/null 2>&1; then
          if ask-yn "Install bubblewrap now?" yes; then
            printf 'Installing bubblewrap...\n' >&2
            if pkg-install bubblewrap 2>/dev/null || pkg-install bwrap 2>/dev/null; then
              printf 'Bubblewrap installed successfully. Re-running demo-magic...\n' >&2
              exec "$0" "$@"
            else
              printf 'demo-magic: failed to install bubblewrap\n' >&2
            fi
          fi
        fi
      fi
      
      # Either install failed or user declined - ask to continue
      if command -v ask-yn >/dev/null 2>&1; then
        if ! ask-yn "Continue without sandbox?" no; then
          printf 'demo-magic: aborting\n' >&2
          exit 1
        fi
      else
        printf 'demo-magic: continuing without sandbox (set WIZARDRY_DEMO_NO_BWRAP=1 to skip this check)\n' >&2
      fi
    fi
  fi
fi

printf '\n'
printf '╔═══════════════════════════════════════════════════════════╗\n'
printf '║         WIZARDRY DEMONSTRATION OF MAGICAL ARTS            ║\n'
printf '╚═══════════════════════════════════════════════════════════╝\n'
printf '\n'
printf 'A circle of chalk flares into view.\n'
printf 'The apprentice wizard prepares to demonstrate mastery.\n'

# Run all levels from 0 to target level
current_level=0
while [ "$current_level" -le "$demo_level" ]; do
  demo_level "$current_level"
  current_level=$((current_level + 1))
done

printf '\n'
printf '═══════════════════════════════════════════════════════════\n'
printf '\n'
printf 'The demonstration concludes.\n'
printf 'The circle closes. Wizardry stands ready.\n'
printf 'DEMO_MAGIC_COMPLETE\n'

# End of script - explicit exit 0 to ensure success
exit 0
