#!/bin/sh

# Demonstrate wizardry spells at specified levels with narrated output.
# Each demo level corresponds to a banish level and demonstrates the spells
# that are validated and tested by that banish level.

# Global flag for --no-pauses
no_pauses=0

# Pause for dramatic effect
demo_pause() {
  # Skip pauses if --no-pauses flag set or WIZARDRY_DEMO_NO_PAUSE env var set
  if [ "$no_pauses" -eq 1 ] || [ "${WIZARDRY_DEMO_NO_PAUSE:-0}" -eq 1 ]; then
    return
  fi
  sleep 0.2
}

# Narrator text in cyan
say_narrator() {
  printf '%s%s%s\n' "$CYAN" "$*" "$RESET"
}

# Highlight spell name in green
spell_name() {
  printf '%s%s%s' "$GREEN" "$1" "$RESET"
}

# Demo a single level using spell-levels data
demo_level() {
  level=$1
  
  # Get level name using spell-levels imp
  level_name=$(spell-levels "$level" name)
  
  printf '\n'
  printf '%s%s=== Level %d: %s ===%s\n' "$YELLOW" "$BOLD" "$level" "$level_name" "$RESET"
  printf '\n'
  
  # Add level-specific narration and demonstrations
  case "$level" in
    0)
      say_narrator "The wizard examines the foundation of reality itself..."
      printf '\n'
      demo_pause
      
      if command -v detect-posix >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name detect-posix)" "$RESET"
        detect-posix 2>&1
        printf '\n'
        demo_pause
      fi
      
      if command -v detect-distro >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name detect-distro)" "$RESET"
        detect-distro
        printf '\n'
        demo_pause
      fi
      ;;
      
    1)
      say_narrator "The wizard gathers the core components of wizardry..."
      printf '\n'
      demo_pause
      
      if command -v validate-spells >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name validate-spells)" "$RESET"
        validate-spells banish:wards validate-spells:.wizardry 2>&1
        printf '\n'
        demo_pause
      fi
      
      printf 'Core imps summoned: foundational helpers for all spells\n'
      ;;
      
    2)
      say_narrator "The wizard conjures the glossary system..."
      printf '\n'
      demo_pause
      
      if command -v generate-glosses >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name generate-glosses)" "$RESET"
        generate-glosses 2>&1
        printf '\n'
        demo_pause
      fi
      ;;
      
    3)
      say_narrator "The wizard weaves interactive menus from pure thought..."
      printf '\n'
      demo_pause
      
      if command -v fathom-terminal >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name fathom-terminal)" "$RESET"
        fathom-terminal 2>&1 || printf '(No terminal available)\n'
        printf '\n'
        demo_pause
      fi
      ;;
      
    4)
      say_narrator "The wizard masters interactive menus and terminal control..."
      printf '\n'
      demo_pause
      
      if command -v colors >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name colors)" "$RESET"
        colors 2>&1 || printf '(Colors already loaded)\n'
        printf '\n'
        demo_pause
      fi
      ;;
      
    5)
      say_narrator "The wizard enchants files with metadata..."
      printf '\n'
      ;;
      
    6)
      say_narrator "The wizard manages task priorities..."
      printf '\n'
      ;;
      
    7)
      say_narrator "The wizard learns translocation magic..."
      printf '\n'
      demo_pause
      
      printf 'Navigation spells allow instant travel between marked locations:\n'
      printf '  • mark-location - Mark current directory for later return\n'
      printf '  • jump-to-marker - Return to a marked location\n'
      ;;
      
    8)
      say_narrator "The wizard establishes the testing framework..."
      printf '\n'
      demo_pause
      
      printf 'Testing spells:\n'
      printf '  • test-magic - Run test suites\n'
      printf '  • test-spell - Test a single spell\n'
      ;;
      
    9)
      say_narrator "The wizard masters the MUD realm..."
      printf '\n'
      demo_pause
      
      if command -v look >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name look)" "$RESET"
        look 2>&1
        printf '\n'
        demo_pause
      fi
      ;;
      
    10)
      say_narrator "The wizard enables version control magic..."
      printf '\n'
      demo_pause
      
      printf 'Arcane file operations:\n'
      printf '  • read-magic - Read file contents\n'
      printf '  • git-status-clean - Verify clean working tree\n'
      ;;
      
    11)
      say_narrator "The wizard learns basic cantrips..."
      printf '\n'
      demo_pause
      
      if command -v ask-yn >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates %s.%s\n' "$CYAN" "$(spell_name ask-yn)" "$RESET"
        printf 'y\n' | ask-yn "Is wizardry magical?" yes 2>&1
        printf '\n'
        demo_pause
      fi
      ;;
      
    12)
      say_narrator "The wizard studies package management..."
      printf '\n'
      demo_pause
      
      if command -v package-managers >/dev/null 2>&1; then
        printf '%sThe wizard casts %s.%s\n' "$CYAN" "$(spell_name package-managers)" "$RESET"
        package-managers 2>&1
        printf '\n'
        demo_pause
      fi
      ;;
      
    *)
      # Default case for all other levels
      say_narrator "The wizard channels level $level energies..."
      printf '\n'
      ;;
  esac
}

# Detect WIZARDRY_DIR if not set (for direct execution)
if [ -z "${WIZARDRY_DIR-}" ]; then
  # Try to detect from script location
  if command -v dirname >/dev/null 2>&1 && command -v cd >/dev/null 2>&1 \
     && command -v pwd >/dev/null 2>&1; then
    script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || script_dir=""
    if [ -n "$script_dir" ]; then
      wiz_root=$(CDPATH= cd -- "$script_dir/../.." 2>/dev/null && pwd -P) || wiz_root=""
      if [ -n "$wiz_root" ] && [ -d "$wiz_root/spells" ]; then
        WIZARDRY_DIR=$wiz_root
        export WIZARDRY_DIR
      fi
    fi
  fi
  
  # Fallback to standard location
  if [ -z "${WIZARDRY_DIR-}" ] && [ -n "${HOME-}" ] && [ -d "${HOME}/.wizardry/spells" ]; then
    WIZARDRY_DIR="${HOME}/.wizardry"
    export WIZARDRY_DIR
  fi
fi

# Add imps and spells to PATH early (needed for env-clear and colors)
if [ -n "${WIZARDRY_DIR-}" ]; then
  # Build imp path
  imp_path="${WIZARDRY_DIR}/spells/.imps/sys"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/cond"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/out"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/fs"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/str"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/paths"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/text"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/input"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/lex"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/menu"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/pkg"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/test"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/lang"
  PATH="$imp_path:$PATH"
  export PATH
  
  # Add spell directories to PATH
  PATH="$WIZARDRY_DIR/spells/.wizardry:$PATH"
  for dir in "$WIZARDRY_DIR"/spells/*; do
    [ -d "$dir" ] || continue
    PATH="$dir:$PATH"
  done
  export PATH
fi

# Help handler
case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: demo-magic [OPTIONS] [LEVEL|all]

Demonstrate wizardry features with narrated, guided tour of spell capabilities.
Each level demonstrates spells validated by the corresponding banish level.
The wizard narrator will guide you through each spell category with live
demonstrations and explanations.

Arguments:
  LEVEL         Demonstration level (0-27)
  RANGE         Demonstration range (e.g., 3-7)
  all           Demonstrate all levels (default)
                Level 0: POSIX & platform foundation
                Level 1: Wizardry installation
                Level 2: Glossary system
                Level 3: Menu system
                Level 4+: Higher-level spells (see SPELL_LEVELS.md)

Options:
  --no-pauses   Skip all dramatic pauses (faster demos)
  --no-bwrap    Skip bwrap sandbox isolation

Examples:
  demo-magic 0                # Demonstrate level 0 only
  demo-magic 3-7              # Demonstrate levels 3 through 7
  demo-magic --no-pauses all  # Full demonstration without pauses
  demo-magic --no-bwrap 5     # Level 5 without sandbox
  demo-magic                  # Same as 'all'
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Source colors to get color variables (suppress any debug output)
. colors >/dev/null 2>&1
colors >/dev/null 2>&1

# Parse command-line arguments
start_level=""
end_level=""
no_pauses=0
no_bwrap=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-pauses)
      no_pauses=1
      shift
      ;;
    --no-bwrap)
      no_bwrap=1
      shift
      ;;
    all)
      start_level=0
      end_level=27
      shift
      ;;
    [0-9]-[0-9]|[0-9]-[0-9][0-9]|[0-9][0-9]-[0-9]|[0-9][0-9]-[0-9][0-9])
      # Range format: N-M
      start_level="${1%%-*}"
      end_level="${1##*-}"
      shift
      ;;
    [0-9]|[0-9][0-9])
      # Single level
      start_level=$1
      end_level=$1
      shift
      ;;
    *)
      printf 'demo-magic: invalid argument: %s\n' "$1" >&2
      printf 'Run "demo-magic --help" for usage.\n' >&2
      exit 2
      ;;
  esac
done

# Default to all levels if not specified
if [ -z "$start_level" ]; then
  start_level=0
  end_level=27
fi

# Sandbox with bwrap if not in GitHub Actions and not already sandboxed
if [ "${WIZARDRY_DEMO_IN_BWRAP-0}" -ne 1 ] && [ "$no_bwrap" -ne 1 ]; then
  # Skip bwrap in GitHub Actions (already isolated)
  if [ -z "${GITHUB_ACTIONS-}" ] || [ "${GITHUB_ACTIONS}" != "true" ]; then
    if command -v bwrap >/dev/null 2>&1; then
      # Re-exec with bwrap sandbox, passing all args including flags
      exec bwrap --unshare-user --ro-bind / / --dev-bind /dev /dev --bind /proc /proc \
        --bind /tmp /tmp --setenv PATH "$PATH" --setenv WIZARDRY_DEMO_IN_BWRAP 1 -- \
        "$0" "$@"
    else
      # bwrap not available - offer to install
      printf 'demo-magic: bubblewrap (bwrap) not found\n' >&2
      printf 'demo-magic: Running demos in an isolated sandbox is recommended for safety.\n' >&2
      
      # Check if we can install it
      if command -v pkg-install >/dev/null 2>&1; then
        if command -v ask-yn >/dev/null 2>&1; then
          if ask-yn "Install bubblewrap now?" yes; then
            printf 'Installing bubblewrap...\n' >&2
            if pkg-install bubblewrap 2>/dev/null || pkg-install bwrap 2>/dev/null; then
              printf 'Bubblewrap installed successfully. Re-running demo-magic...\n' >&2
              exec "$0" "$@"
            else
              printf 'demo-magic: failed to install bubblewrap\n' >&2
            fi
          fi
        fi
      fi
      
      # Either install failed or user declined - ask to continue
      if command -v ask-yn >/dev/null 2>&1; then
        if ! ask-yn "Continue without sandbox?" no; then
          printf 'demo-magic: aborting\n' >&2
          exit 1
        fi
      else
        printf 'demo-magic: continuing without sandbox (use --no-bwrap to skip this check)\n' >&2
      fi
    fi
  fi
fi

printf '\n'
printf '╔═══════════════════════════════════════════════════════════╗\n'
printf '║         WIZARDRY DEMONSTRATION OF MAGICAL ARTS            ║\n'
printf '╚═══════════════════════════════════════════════════════════╝\n'
printf '\n'

say_narrator "A circle of chalk flares into view..."
demo_pause
say_narrator "The wizard steps forward, staff in hand."
demo_pause
say_narrator '"Welcome, observer. I shall demonstrate the extent of my powers."'
printf '\n'
demo_pause

# Run levels from start_level to end_level
current_level=$start_level
while [ "$current_level" -le "$end_level" ]; do
  demo_level "$current_level"
  
  # Pause between levels for readability
  if [ "$current_level" -lt "$end_level" ]; then
    demo_pause
  fi
  
  current_level=$((current_level + 1))
done

printf '\n'
printf '═══════════════════════════════════════════════════════════\n'
printf '\n'
demo_pause

say_narrator "The wizard lowers their staff."
demo_pause
say_narrator '"The demonstration is complete. Wizardry stands ready."'
printf '\n'
say_narrator "The circle fades. The wizard departs."
printf 'DEMO_MAGIC_COMPLETE\n'

# End of script - explicit exit 0 to ensure success
exit 0
