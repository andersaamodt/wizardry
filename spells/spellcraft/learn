#!/bin/sh

# Learn a spell or spellbook by copying or linking it into your spellbook.
# With word-of-binding, spells in ~/.spellbook are automatically available.
learn_usage() {
  cat <<'USAGE'
Usage: learn [--copy|--link] SPELL_OR_DIRECTORY
Learn a spell or spellbook by adding it to your personal spellbook.
With word-of-binding, spells in ~/.spellbook are automatically available.
Options:
  --copy    Copy the spell/spellbook (default)
  --link    Create a symbolic link instead
Examples:
  learn my-custom-spell          # Copy spell to spellbook
  learn --link ~/projects/spells # Link entire spellbook directory
USAGE
}
learn() {
case "${1-}" in
--help|--usage|-h)
  learn_usage
  return 0
  ;;
esac
set -eu
# env-clear: compliant
# Determine spellbook location
spellbook=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
# Parse options
use_link=0
--link)
  use_link=1
  shift
--copy)
  use_link=0
# Validate arguments
if [ $# -eq 0 ]; then
  printf '%s\n' "learn: spell or directory path required" >&2
  learn_usage >&2
  return 1
fi
source_path=$1
# Validate source exists
if [ ! -e "$source_path" ]; then
  printf '%s\n' "learn: path not found: $source_path" >&2
# Get absolute path
if [ -d "$source_path" ]; then
  source_path=$(cd "$source_path" && pwd -P)
elif [ -f "$source_path" ]; then
  source_dir=$(cd "$(dirname "$source_path")" && pwd -P)
  source_name=$(basename "$source_path")
  source_path="$source_dir/$source_name"
# Create spellbook directory if needed
if [ ! -d "$spellbook" ]; then
  mkdir -p "$spellbook"
  printf '%s\n' "Created spellbook directory: $spellbook"
# Determine target name
target_name=$(basename "$source_path")
# Check if already exists
target_path="$spellbook/$target_name"
if [ -e "$target_path" ] || [ -L "$target_path" ]; then
  printf '%s\n' "learn: '$target_name' already exists in spellbook" >&2
  printf '%s\n' "  Remove it first with: forget $target_name" >&2
# Copy or link
if [ "$use_link" -eq 1 ]; then
  ln -s "$source_path" "$target_path"
  printf '%s\n' "Linked $target_name to spellbook"
  printf '%s\n' "  Source: $source_path"
  printf '%s\n' "  Target: $target_path"
else
  if [ -d "$source_path" ]; then
    cp -r "$source_path" "$target_path"
    printf '%s\n' "Copied spellbook $target_name"
  else
    cp "$source_path" "$target_path"
    chmod +x "$target_path"
    printf '%s\n' "Copied spell $target_name"
  fi
  printf '%s\n' "  Location: $target_path"
printf '%s\n' ""
printf '%s\n' "The spell is now available. Try it:"
printf '%s\n' "  $target_name --help"
# Self-execute when run directly (not sourced)
case "$0" in
  */learn) learn "$@" ;; esac
