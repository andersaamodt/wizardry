#!/bin/sh
# This spell deletes a custom synonym.

delete_synonym_usage() {
  cat <<'USAGE'
Usage: delete-synonym WORD

Delete a custom synonym. Cannot delete default synonyms.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  delete_synonym_usage
  exit 0
  ;;
esac

require-wizardry || return 1

set -eu
. env-clear

delete_synonym() {
  if [ "$#" -lt 1 ]; then
    printf '%s\n' "delete-synonym: requires WORD argument" >&2
    return 2
  fi

  synonym_word=$1

  spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
  custom_file="$spell_home/.synonyms"
  default_file="$spell_home/.default-synonyms"

  # Check which file contains the synonym
  if [ -f "$custom_file" ] && grep -q "^alias $synonym_word=" "$custom_file" 2>/dev/null; then
    # Found in custom - OK to delete
    temp_file=$(temp-file synonyms) || return 1
    grep -v "^alias $synonym_word=" "$custom_file" > "$temp_file" || true
    mv "$temp_file" "$custom_file"
    success "Synonym deleted: $synonym_word"
  elif [ -f "$default_file" ] && grep -q "^alias $synonym_word=" "$default_file" 2>/dev/null; then
    # Found in default - can't delete
    printf '%s\n' "delete-synonym: cannot delete default synonym '$synonym_word'" >&2
    printf '%s\n' "Use 'reset-default-synonyms' to reset all defaults" >&2
    return 1
  else
    printf '%s\n' "delete-synonym: synonym '$synonym_word' not found" >&2
    return 1
  fi
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="$(cd "$(dirname "$0")" && cd .. && cd .. && pwd)/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="$(cd "$(dirname "$0")" && cd .. && cd .. && pwd)/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
