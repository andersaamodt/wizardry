#!/bin/sh
# This spell deletes a synonym (alias) from your spellbook.
# Removes the alias from SPELLBOOK_DIR/.synonyms.

show_usage() {
  cat <<'USAGE'
Usage: delete-synonym [WORD]

Delete a synonym (alias) from your spellbook. Without arguments,
prompts for the synonym word to delete.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
synonyms_file="$spell_home/.synonyms"

# Parse arguments
synonym_word=""

if [ "$#" -ge 1 ]; then
  synonym_word=$1
else
  # Interactive mode
  printf 'Synonym word to delete: ' >&2
  if ! IFS= read -r synonym_word; then
    printf '%s\n' "delete-synonym: failed to read synonym word" >&2
    exit 1
  fi
fi

# Validate synonym word
if [ -z "$synonym_word" ]; then
  printf '%s\n' "delete-synonym: synonym word cannot be empty" >&2
  exit 2
fi

# Check if synonyms file exists
if [ ! -f "$synonyms_file" ]; then
  printf '%s\n' "delete-synonym: no synonyms defined" >&2
  exit 1
fi

# Check if synonym exists
if ! grep -q "^alias $synonym_word=" "$synonyms_file"; then
  printf '%s\n' "delete-synonym: synonym '$synonym_word' not found" >&2
  exit 1
fi

# Remove the alias from the file
temp_file=$(temp-file synonyms) || exit 1
if ! grep -v "^alias $synonym_word=" "$synonyms_file" > "$temp_file"; then
  rm -f "$temp_file"
  printf '%s\n' "delete-synonym: could not delete synonym" >&2
  exit 1
fi

mv "$temp_file" "$synonyms_file"

success "Synonym deleted: $synonym_word"
