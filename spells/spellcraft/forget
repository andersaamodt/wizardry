#!/bin/sh

# This spell forgets (removes) a spell from the Cast menu.
# Use this to remove memorized spells from the Cast menu.

set -eu

SCRIPT_NAME=$(basename "$0")
SCRIPT_SOURCE=$0
case $SCRIPT_SOURCE in
*/*)
        SCRIPT_DIR=${SCRIPT_SOURCE%/*}
        ;;
*)
        SCRIPT_DIR=.
        ;;
esac
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd -P)
SPELLS_DIR=${SCRIPT_DIR%/*}

# Find memorize-spell helper
memorizer_override=0
if [ -n "${MEMORIZE_SPELL_HELPER-}" ]; then
        memorizer_override=1
        MEMORIZER=$MEMORIZE_SPELL_HELPER
else
        MEMORIZER=$SPELLS_DIR/cantrips/memorize-spell
fi

if [ ! -x "$MEMORIZER" ] && [ "$memorizer_override" -eq 0 ]; then
        if command -v memorize-spell >/dev/null 2>&1; then
                MEMORIZER=$(command -v memorize-spell)
        fi
fi

usage() {
        cat <<USAGE
Usage: $SCRIPT_NAME SPELL_NAME
       $SCRIPT_NAME --help

Remove a spell from the Cast menu.

Arguments:
  SPELL_NAME  The name of the spell to forget.

Examples:
  $SCRIPT_NAME my-custom-spell
  $SCRIPT_NAME colors
USAGE
}

case ${1-} in
-h|--help)
        usage
        exit 0
        ;;
"")
        printf '%s\n' "$SCRIPT_NAME: spell name required." >&2
        usage >&2
        exit 1
        ;;
-*)
        printf '%s\n' "$SCRIPT_NAME: unknown option '$1'" >&2
        usage >&2
        exit 1
        ;;
esac

spell_name=$1

if [ -z "$MEMORIZER" ] || [ ! -x "$MEMORIZER" ]; then
        printf '%s\n' "$SCRIPT_NAME: memorize-spell helper is unavailable." >&2
        exit 1
fi

if "$MEMORIZER" remove "$spell_name"; then
        printf "Forgotten: %s\n" "$spell_name"
        exit 0
fi
exit 1
