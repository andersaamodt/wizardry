#!/bin/sh

# This spell binds every file in a directory into a single tome.
# Pass -d to recycle the loose pages after the binding completes.

usage() {
        cat <<'USAGE'
Usage: bind-tome [-d] <page-directory>

Bind every file in the provided directory into a single <dirname>.txt tome.
Pass -d to delete the original pages after binding.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        usage
        exit 0
        ;;
esac

# Parse options early so -h works even with missing args.
delete_sources=0
while getopts ":dh" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        h)
            usage
            exit 0
            ;;
        *)
            usage >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Require a directory of pages to stitch together.
if [ "$#" -lt 1 ]; then
    printf '%s\n' "Error: Please provide a folder path as an argument." >&2
    usage >&2
    exit 1
fi

pages_dir=$1
# Fail fast if the provided path is not a directory of pages.
if [ ! -d "$pages_dir" ]; then
    printf '%s\n' "Error: '$pages_dir' is not a directory." >&2
    exit 1
fi

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

# Append each page with headers so the merged tome is navigable.
for page in "$pages_dir"/*; do
    [ -e "$page" ] || continue
    page_name=$(basename -- "$page")
    printf '%s\n' "----- $page_name -----" >>"$text_file"
    cat "$page" >>"$text_file"
    printf '%s\n' "----- End of $page_name -----" >>"$text_file"
done

printf '%s\n' "Text file created: $text_file"

# Optionally remove the original pages once the tome is complete.
if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        [ -e "$page" ] || continue
        rm -- "$page"
    done
    printf '%s\n' "Original files deleted."
fi
