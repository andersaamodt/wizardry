#!/bin/sh

# Tome Fusion Spell
# This incantation threads scattered parchment pages into a single tome while
# narrating each binding so the ritual remains transparent. Offer a directory
# of pages; add -d to let the wind carry the loose pages away after the tome is
# sealed.

usage() {
    printf '%s\n' "Usage: bind-tome [-d] <page-directory>"
}

delete_sources=0
while getopts ":d" opt; do
    case "$opt" in
        d)
            delete_sources=1
            ;;
        *)
            usage >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

if [ "$#" -lt 1 ]; then
    printf '%s\n' "Error: Please provide a folder path as an argument." >&2
    usage >&2
    exit 1
fi

pages_dir=$1
if [ ! -d "$pages_dir" ]; then
    printf '%s\n' "Error: '$pages_dir' is not a directory." >&2
    exit 1
fi

folder_name=$(basename -- "$pages_dir")
text_file="${folder_name}.txt"
: >"$text_file"

for page in "$pages_dir"/*; do
    [ -e "$page" ] || continue
    page_name=$(basename -- "$page")
    printf '%s\n' "----- $page_name -----" >>"$text_file"
    cat "$page" >>"$text_file"
    printf '%s\n' "----- End of $page_name -----" >>"$text_file"
done

printf '%s\n' "Text file created: $text_file"

if [ "$delete_sources" -eq 1 ]; then
    for page in "$pages_dir"/*; do
        [ -e "$page" ] || continue
        rm -- "$page"
    done
    printf '%s\n' "Original files deleted."
fi
