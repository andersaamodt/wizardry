#!/bin/sh

# ask-number keeps watch over numeric ranges, nudging travelers toward a value
# between the provided bounds.  It repeats until a valid integer arrives.

show_usage() {
        cat <<'USAGE' >&2
Usage: ask-number "Question" MIN MAX

Prompts until the user supplies an integer within the inclusive range.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

if [ "$#" -ne 3 ]; then
        show_usage
        exit 1
fi

question=$1
min=$2
max=$3

case $min in
*[!0-9-]*|"")
        printf '%s\n' "ask-number: MIN must be an integer." >&2
        exit 1
        ;;
*) : ;;
esac
case $max in
*[!0-9-]*|"")
        printf '%s\n' "ask-number: MAX must be an integer." >&2
        exit 1
        ;;
*) : ;;
esac

min=$(printf '%s' "$min")
max=$(printf '%s' "$max")

if [ "$min" -gt "$max" ]; then
        printf '%s\n' "ask-number: MIN must be less than or equal to MAX." >&2
        exit 1
fi

# Support both ASK_CANTRIP_INPUT (legacy) and SELECT_INPUT_MODE (imp convention)
if [ -n "${ASK_CANTRIP_INPUT-}" ] && [ -z "${SELECT_INPUT_MODE-}" ]; then
        SELECT_INPUT_MODE=$ASK_CANTRIP_INPUT
        export SELECT_INPUT_MODE
fi

while :; do
        # Prompt user
        printf '%s [%s-%s] ' "$question" "$min" "$max" >&2
        
        # Read input using select-input imp
        if ! input=$(select-input); then
                printf '%s\n' "ask-number: No interactive input available." >&2
                exit 1
        fi
        
        # Read value based on input source
        case $input in
        stdin)
                IFS= read -r response || response=
                ;;
        tty)
                IFS= read -r response </dev/tty || response=
                ;;
        *)
                printf '%s\n' "ask-number: No interactive input available." >&2
                exit 1
                ;;
        esac

        case $response in
        *[!0-9-]*|"")
                printf '%s\n' "Whole number expected." >&2
                continue
                ;;
        esac

        if [ "$response" -lt "$min" ] || [ "$response" -gt "$max" ]; then
                printf '%s\n' "Number must be between $min and $max." >&2
                continue
        fi

        printf '%s\n' "$response"
        exit 0

done
