#!/bin/sh

# install-service-template copies a template into /etc/systemd/system after
# substituting placeholders. It prefers interactive prompts so the services menu
# can call it without arguments.

SCRIPT_NAME=$(basename "$0")
SERVICE_DIR=${SERVICE_DIR:-/etc/systemd/system}

install_service_template_usage() {
        cat <<USAGE >&2
Usage: $SCRIPT_NAME /path/to/template [KEY=value ...]

Copies a systemd service template into the system directory, substituting
KEY=value pairs into the file. Prompts for missing values to keep
menu-driven installs friendly.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        install_service_template_usage
        exit 0
        ;;
esac

set -eu

# Helper to run commands with privilege escalation if needed
require_privilege() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return 0
  fi
  if [ -w "$SERVICE_DIR" ]; then
    "$@"
    return 0
  fi
  if command -v sudo >/dev/null 2>&1; then
    sudo "$@"
    return 0
  fi
  printf '%s\n' "$SCRIPT_NAME: run as root or install sudo to write $SERVICE_DIR." >&2
  exit 1
}

# Find script directory for relative helper lookup
SCRIPT_SOURCE=$0
case $SCRIPT_SOURCE in
*/*)
        SCRIPT_DIR=${SCRIPT_SOURCE%/*}
        ;;
*)
        resolved=$(command -v "$SCRIPT_SOURCE" 2>/dev/null || printf '%s' "$SCRIPT_SOURCE")
        SCRIPT_DIR=${resolved%/*}
        SCRIPT_SOURCE=$resolved
        ;;
esac
if [ -z "$SCRIPT_DIR" ] || [ "$SCRIPT_DIR" = "$SCRIPT_SOURCE" ]; then
        SCRIPT_DIR=.
fi
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd -P)

# Find ask-yn helper
if [ -n "${INSTALL_SERVICE_TEMPLATE_ASK_YN-}" ]; then
  ASK_YN=$INSTALL_SERVICE_TEMPLATE_ASK_YN
elif command -v ask-yn >/dev/null 2>&1; then
  ASK_YN=$(command -v ask-yn)
elif [ -x "$SCRIPT_DIR/ask-yn" ]; then
  ASK_YN=$SCRIPT_DIR/ask-yn
else
  printf '%s\n' "$SCRIPT_NAME: unable to locate helper 'ask-yn'." >&2
  exit 1
fi

# Find ask-text helper
if [ -n "${INSTALL_SERVICE_TEMPLATE_ASK_TEXT-}" ]; then
  ASK_TEXT=$INSTALL_SERVICE_TEMPLATE_ASK_TEXT
elif command -v ask-text >/dev/null 2>&1; then
  ASK_TEXT=$(command -v ask-text)
elif [ -x "$SCRIPT_DIR/ask-text" ]; then
  ASK_TEXT=$SCRIPT_DIR/ask-text
else
  printf '%s\n' "$SCRIPT_NAME: unable to locate helper 'ask-text'." >&2
  exit 1
fi

# Check for systemctl
if command -v systemctl >/dev/null 2>&1; then
        SYSTEMCTL=$(command -v systemctl)
else
        printf '%s\n' "$SCRIPT_NAME: systemctl is required for this spell." >&2
        exit 1
fi

# Get template path
template_path=${1-}
if [ -n "$template_path" ]; then
        shift
else
        template_path=$("$ASK_TEXT" "Path to the service template:")
fi
if [ -z "$template_path" ]; then
        install_service_template_usage
        exit 1
fi
if [ ! -f "$template_path" ]; then
        printf '%s\n' "$SCRIPT_NAME: template '$template_path' not found." >&2
        exit 1
fi

service_file=$(basename "$template_path")
service_path="$SERVICE_DIR/$service_file"

# Check if service already exists
if [ -f "$service_path" ]; then
        if ! "$ASK_YN" "Service $service_file exists. Overwrite?" no >/dev/null; then
                printf '%s\n' "Installation cancelled."
                exit 1
        fi
fi

# Create temporary working copy
tmp_file=$(temp-file wizardry-service)
trap 'rm -f "$tmp_file"' EXIT HUP INT TERM

cp "$template_path" "$tmp_file"

# Process command-line substitutions
for arg in "$@"; do
        case $arg in
        *=*)
                key=${arg%%=*}
                value=${arg#*=}
                # Escape value for sed replacement
                escaped=$(printf '%s' "$value" | sed 's/[\\&|$"]/\\&/g')
                tmp_swap=$(temp-file wizardry-service) || exit 1
                pattern=$(printf '\\$%s' "$key")
                sed "s|$pattern|$escaped|g" "$tmp_file" >"$tmp_swap"
                mv "$tmp_swap" "$tmp_file"
                ;;
        *)
                printf '%s\n' "$SCRIPT_NAME: ignoring malformed substitution '$arg'." >&2
                ;;
        esac
done

# Collect remaining placeholders and prompt for values
placeholders_file=$(temp-file wizardry-placeholders) || exit 1
awk '{
  line=$0
  while (match(line, /\$[A-Z_][A-Z0-9_]*/)) {
    var=substr(line, RSTART+1, RLENGTH-1)
    print var
    line=substr(line, RSTART+RLENGTH)
  }
}' "$tmp_file" | sort -u >"$placeholders_file"

if [ -s "$placeholders_file" ]; then
  while IFS= read -r var; do
    if [ -z "$var" ]; then
      continue
    fi
    value=$("$ASK_TEXT" "Enter a value for $var:")
    # Escape and substitute
    escaped=$(printf '%s' "$value" | sed 's/[\\&|$"]/\\&/g')
    tmp_swap=$(temp-file wizardry-service) || exit 1
    pattern=$(printf '\\$%s' "$var")
    sed "s|$pattern|$escaped|g" "$tmp_file" >"$tmp_swap"
    mv "$tmp_swap" "$tmp_file"
  done <"$placeholders_file"
fi
rm -f "$placeholders_file"

# Install the service file
require_privilege cp "$tmp_file" "$service_path"
require_privilege chmod 644 "$service_path"
require_privilege "$SYSTEMCTL" daemon-reload

printf '%s\n' "Service installed at $service_path"
