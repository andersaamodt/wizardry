#!/bin/sh

# Recursively list all files in a directory and its subdirectories.
# Useful for discovering all scripts, spells, or files in a tree.

list_files_usage() {
  cat <<'USAGE'
Usage: list-files <directory> [options]

Recursively list all files in a directory and subdirectories.

Options:
  -x, --executable  Only list executable files
  -t, --type TYPE   Only list files of type (f=file, d=directory)

Examples:
  list-files spells              # All files in spells/
  list-files spells -x           # Only executable files
  list-files spells -t f         # Only regular files
USAGE
}


list_files() {
case "${1-}" in
--help|--usage|-h)
  list_files_usage
  return 0
  ;;
esac

require-wizardry || return 1

set -eu
. env-clear

if [ "$#" -lt 1 ]; then
  usage-error "list-files" "directory required"
fi

directory=$1
shift

# Parse options
only_executable=0
file_type=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -x|--executable)
      only_executable=1
      shift
      ;;
    -t|--type)
      if [ "$#" -lt 2 ]; then
        usage-error "list-files" "-t requires an argument"
      fi
      file_type=$2
      shift 2
      ;;
    *)
      usage-error "list-files" "unknown option: $1"
      ;;
  esac
done

if [ ! -d "$directory" ]; then
  die "list-files: not a directory: $directory"
fi

# Build find command
if [ "$only_executable" = "1" ]; then
  if [ -n "$file_type" ]; then
    find "$directory" -type "$file_type" -perm -111 2>/dev/null
  else
    find "$directory" -type f -perm -111 2>/dev/null
  fi
elif [ -n "$file_type" ]; then
  find "$directory" -type "$file_type" 2>/dev/null
else
  find "$directory" 2>/dev/null
fi
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
      _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
      _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
      _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
      _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
      _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
      [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
