#!/bin/sh

# Recursively list all files in a directory and its subdirectories.
# Useful for discovering all scripts, spells, or files in a tree.

list_files_usage() {
  cat <<'USAGE'
Usage: list-files <directory> [options]

Recursively list all files in a directory and subdirectories.

Options:
  -x, --executable  Only list executable files
  -t, --type TYPE   Only list files of type (f=file, d=directory)

Examples:
  list-files spells              # All files in spells/
  list-files spells -x           # Only executable files
  list-files spells -t f         # Only regular files
USAGE
}


list_files() {
case "${1-}" in
--help|--usage|-h)
  list_files_usage
  return 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

if [ "$#" -lt 1 ]; then
  usage-error "list-files" "directory required"
fi

directory=$1
shift

# Parse options
only_executable=0
file_type=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -x|--executable)
      only_executable=1
      shift
      ;;
    -t|--type)
      if [ "$#" -lt 2 ]; then
        usage-error "list-files" "-t requires an argument"
      fi
      file_type=$2
      shift 2
      ;;
    *)
      usage-error "list-files" "unknown option: $1"
      ;;
  esac
done

if [ ! -d "$directory" ]; then
  die "list-files: not a directory: $directory"
fi

# Build find command
if [ "$only_executable" = "1" ]; then
  if [ -n "$file_type" ]; then
    find "$directory" -type "$file_type" -perm -111 2>/dev/null
  else
    find "$directory" -type f -perm -111 2>/dev/null
  fi
elif [ -n "$file_type" ]; then
  find "$directory" -type "$file_type" 2>/dev/null
else
  find "$directory" 2>/dev/null
fi
}


# Source castable imp if not already available (for direct execution)
if ! command -v castable >/dev/null 2>&1; then
  # Try to find imps directory relative to this spell
  _spell_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _repo_root=$(cd "$_spell_dir" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  WIZARDRY_IMPS_SYS="${WIZARDRY_DIR:-${_repo_root}}/spells/.imps/sys"
  if [ -f "$WIZARDRY_IMPS_SYS/castable" ]; then
    . "$WIZARDRY_IMPS_SYS/castable"
  fi
fi

castable "$@"
