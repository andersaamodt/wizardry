#!/bin/sh

# Recursively list all files in a directory and its subdirectories.
# Useful for discovering all scripts, spells, or files in a tree.

show_usage() {
  cat <<'USAGE'
Usage: list-files <directory> [options]

Recursively list all files in a directory and subdirectories.

Options:
  -x, --executable  Only list executable files
  -t, --type TYPE   Only list files of type (f=file, d=directory)

Examples:
  list-files spells              # All files in spells/
  list-files spells -x           # Only executable files
  list-files spells -t f         # Only regular files
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac
set -eu

if [ "$#" -lt 1 ]; then
  printf '%s\n' "list-files: directory required" >&2
  show_usage >&2
  exit 1
fi

directory=$1
shift

# Parse options
only_executable=0
file_type=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -x|--executable)
      only_executable=1
      shift
      ;;
    -t|--type)
      if [ "$#" -lt 2 ]; then
        printf '%s\n' "list-files: -t requires an argument" >&2
        exit 1
      fi
      file_type=$2
      shift 2
      ;;
    *)
      printf '%s\n' "list-files: unknown option: $1" >&2
      exit 1
      ;;
  esac
done

if [ ! -d "$directory" ]; then
  printf '%s\n' "list-files: not a directory: $directory" >&2
  exit 1
fi

# Build find command
if [ "$only_executable" = "1" ]; then
  if [ -n "$file_type" ]; then
    find "$directory" -type "$file_type" -perm -111 2>/dev/null
  else
    find "$directory" -type f -perm -111 2>/dev/null
  fi
elif [ -n "$file_type" ]; then
  find "$directory" -type "$file_type" 2>/dev/null
else
  find "$directory" 2>/dev/null
fi
