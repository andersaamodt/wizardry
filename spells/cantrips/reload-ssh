#!/bin/sh

# This spell reloads the SSH service configuration without restarting.
# Use it after modifying sshd_config to apply changes.

reload_ssh_usage() {
cat <<'USAGE'
Usage: reload-ssh

Reload the SSH daemon configuration without a full restart. Detects the operating system and calls the right service manager so sshd_config changes take effect immediately.
USAGE
}



reload_ssh() {
case "${1-}" in
--help|--usage|-h)
  reload_ssh_usage
  return 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

current_os=$(os)

case "$current_os" in
        debian|arch|fedora|nixos|linux)
                if has systemctl; then
                        sudo systemctl reload sshd 2>/dev/null || sudo systemctl reload ssh
                elif has service; then
                        sudo service ssh reload 2>/dev/null || sudo service sshd reload
                else
                        die "reload-ssh: no service manager found."
                fi
                ;;
        mac)
                sudo launchctl stop com.openssh.sshd
                sudo launchctl start com.openssh.sshd
                ;;
        *)
                die "reload-ssh: unsupported OS: $current_os"
                ;;
esac

say "SSH service reloaded."
}


# Source castable imp if not already available (for direct execution)
if ! command -v castable >/dev/null 2>&1; then
  # Try to find imps directory relative to this spell
  _spell_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _repo_root=$(cd "$_spell_dir" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  WIZARDRY_IMPS_SYS="${WIZARDRY_DIR:-${_repo_root}}/spells/.imps/sys"
  if [ -f "$WIZARDRY_IMPS_SYS/castable" ]; then
    . "$WIZARDRY_IMPS_SYS/castable"
  fi
fi

castable "$@"
