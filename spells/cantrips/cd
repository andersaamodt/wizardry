#!/bin/sh

warn() {
        printf '%s\n' "cd cantrip: $1" >&2
}

resolve_cd_path() {
        if [ -n "${WIZARDRY_CD_CANTRIP-}" ]; then
                printf '%s\n' "$WIZARDRY_CD_CANTRIP"
                return 0
        fi
        if [ -n "${WIZARDRY_MEMORIZE_TARGET-}" ]; then
                printf '%s\n' "$WIZARDRY_MEMORIZE_TARGET"
                return 0
        fi
        if [ -n "${0-}" ] && [ -f "$0" ]; then
                case $0 in
                /*)
                        printf '%s\n' "$0"
                        return 0
                        ;;
                *)
                        printf '%s/%s\n' "${PWD:-.}" "$0"
                        return 0
                        ;;
                esac
        fi
        return 1
}

canonicalize_path() {
        file=$1
        case $file in
        /*)
                printf '%s\n' "$file"
                return 0
                ;;
        esac
        dir=${file%/*}
        base=${file##*/}
        if [ "$dir" = "$file" ]; then
                dir=.
                base=$file
        fi
        if ! abs_dir=$(cd "$dir" 2>/dev/null && pwd -P); then
                return 1
        fi
        printf '%s/%s\n' "$abs_dir" "$base"
}

resolve_rc_file() {
        if [ -n "${WIZARDRY_RC_FILE-}" ]; then
                printf '%s\n' "$WIZARDRY_RC_FILE"
                return 0
        fi
        if [ -z "${HOME-}" ]; then
                warn "HOME is not set; cannot determine rc file."
                return 1
        fi
        printf '%s/.bashrc\n' "$HOME"
}

install() {
        if ! cd_target=$(resolve_cd_path); then
                warn "unable to determine spell location for installation."
                return 1
        fi
        if ! cd_spell=$(canonicalize_path "$cd_target"); then
                warn "unable to canonicalize '$cd_target'."
                return 1
        fi
        cd_dir=${cd_spell%/*}
        if [ "$cd_dir" = "$cd_spell" ]; then
                cd_dir=.
        fi
        if ! parent_dir=$(cd "$cd_dir/.." 2>/dev/null && pwd -P); then
                warn "unable to locate wizardry spell directory."
                return 1
        fi
        look_spell="$parent_dir/look"
        if ! [ -x "$look_spell" ]; then
                warn "look spell is missing; expected at '$look_spell'."
                return 1
        fi
        rc_file=$(resolve_rc_file) || return 1
        rc_dir=${rc_file%/*}
        if [ "$rc_dir" = "$rc_file" ]; then
                rc_dir=.
        fi
        if ! mkdir -p "$rc_dir"; then
                warn "unable to create directory '$rc_dir'."
                return 1
        fi
        tmp_file=$(mktemp "${TMPDIR:-/tmp}/wizardry-cd.XXXXXX") || return 1
        if [ -f "$rc_file" ]; then
                sed '/^# >>> wizardry cd cantrip >>>$/,/^# <<< wizardry cd cantrip <<</d' "$rc_file" >"$tmp_file"
        else
                : >"$tmp_file"
        fi
        cat <<HOOK >>"$tmp_file"
# >>> wizardry cd cantrip >>>
WIZARDRY_CD_CANTRIP='$cd_spell'
WIZARDRY_LOOK_SPELL='$look_spell'
alias cd='. "$WIZARDRY_CD_CANTRIP"'
alias look='$WIZARDRY_LOOK_SPELL'
# <<< wizardry cd cantrip <<<
HOOK
        if ! mv "$tmp_file" "$rc_file"; then
                rm -f "$tmp_file"
                warn "unable to update '$rc_file'."
                return 1
        fi
        printf '%s\n' "cd cantrip: installed wizardry hooks in '$rc_file'."
}

wizardry_cd_cast_look() {
        look_spell_path=""
        if [ -n "${WIZARDRY_LOOK_SPELL-}" ] && [ -x "$WIZARDRY_LOOK_SPELL" ]; then
                look_spell_path=$WIZARDRY_LOOK_SPELL
        else
                cd_target=$(resolve_cd_path)
                if [ -n "$cd_target" ] && look_candidate=$(canonicalize_path "$cd_target" 2>/dev/null); then
                        cd_dir=${look_candidate%/*}
                        if [ "$cd_dir" = "$look_candidate" ]; then
                                cd_dir=.
                        fi
                        if parent_dir=$(cd "$cd_dir/.." 2>/dev/null && pwd -P); then
                                if [ -x "$parent_dir/look" ]; then
                                        look_spell_path="$parent_dir/look"
                                fi
                        fi
                fi
        fi
        if [ -n "$look_spell_path" ]; then
                "$look_spell_path" "$@"
                return
        fi
        if command -v look >/dev/null 2>&1; then
                command look "$@"
                return
        fi
        warn "look spell is not available."
}

wizardry_cd_main() {
        if ! \cd "$@"; then
                return $?
        fi
        wizardry_cd_cast_look
}

if [ -z "${WIZARDRY_MEMORIZE_TARGET-}" ]; then
        wizardry_cd_main "$@"
fi
