#!/usr/bin/env sh

# Report terminal dimensions using terminfo via tput.

usage() {
    printf '%s\n' 'Usage: fathom-terminal [-v|--verbose] [-w|--width] [-h|--height]' >&2
    exit 1
}

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Share the same require-command lookup logic with the other cantrips.
if [ -n "${REQUIRE_COMMAND-}" ]; then
    require_cmd=$REQUIRE_COMMAND
elif [ -x "$script_dir/require-command" ]; then
    require_cmd="$script_dir/require-command"
else
    require_cmd=require-command
fi

require() {
    "$require_cmd" "$@"
}

verbose=0
want_width=0
want_height=0

# Parse the small option set understood by the menu helper.
while [ "$#" -gt 0 ]; do
    case "$1" in
        -v|--verbose)
            verbose=1
            ;;
        -w|--width)
            want_width=1
            ;;
        -h|--height)
            want_height=1
            ;;
        --help)
            usage
            ;;
        --)
            shift
            break
            ;;
        -*)
            usage
            ;;
        *)
            break
            ;;
    esac
    shift
done

# Unless told otherwise, report both width and height.
if [ "$want_width" -eq 0 ] && [ "$want_height" -eq 0 ]; then
    want_width=1
    want_height=1
fi

# tput is our interface to terminfo; fail loudly when it is absent.
if ! require tput "The fathom-terminal spell needs 'tput' to query terminfo."; then
    exit 1
fi

cols=$(tput cols 2>/dev/null)
cols_status=$?
lines=$(tput lines 2>/dev/null)
lines_status=$?

if [ "$want_width" -eq 1 ]; then
    if [ $cols_status -ne 0 ] || [ -z "$cols" ]; then
        printf '%s\n' 'fathom-terminal: unable to determine terminal width' >&2
        exit 1
    fi
fi

if [ "$want_height" -eq 1 ]; then
    if [ $lines_status -ne 0 ] || [ -z "$lines" ]; then
        printf '%s\n' 'fathom-terminal: unable to determine terminal height' >&2
        exit 1
    fi
fi

print_dimension() {
    label=$1
    value=$2
    if [ "$verbose" -eq 1 ]; then
        printf '%s: %s\n' "$label" "$value"
    else
        printf '%s\n' "$value"
    fi
}

# Honour the caller's selection of width, height, or both.
if [ "$want_width" -eq 1 ] && [ "$want_height" -eq 1 ]; then
    print_dimension 'Width' "$cols"
    print_dimension 'Height' "$lines"
elif [ "$want_width" -eq 1 ]; then
    print_dimension 'Width' "$cols"
else
    print_dimension 'Height' "$lines"
fi
