#!/bin/sh




# ask-text poses gentle questions, echoing whatever reply the wanderer offers.
# When a default is whispered, pressing Enter adopts it so scripts can fall
# through gracefully even when silence answers back.


ask_text_usage() {
  cat <<'USAGE' >&2
Usage: ask-text "Question" [default]

Prompts the user with the provided question and echoes their response.
When a default is supplied it will be used if the user presses Enter.
USAGE
}


ask_text() {
case "${1-}" in
--help|--usage|-h)
  ask_text_usage
  return 0
  ;;
esac

require_wizardry || return 1

set -eu
env_clear

if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
  ask_text_usage
  return 1
fi

question=$1
default_value=${2-}
default_hint=""
if [ "$#" -eq 2 ]; then
  default_hint=" [$default_value]"
fi

# Inline ask_text_prompt - only used once
printf '%s%s ' "$question" "$default_hint" >&2

# Inline read_line with inlined ask_text_select_input
case ${ASK_CANTRIP_INPUT:-auto} in
stdin)
  input_source=stdin
  ;;
none)
  input_source=none
  ;;
*)
  # Use /dev/fd/0 instead of /dev/stdin for cross-platform compatibility.
  # On macOS, /dev/stdin is a symlink and tests may fail on the symlink itself.
  if [ -t 0 ] || [ -p /dev/fd/0 ] || [ -s /dev/fd/0 ]; then
    input_source=stdin
  elif [ -r /dev/tty ]; then
    input_source=tty
  else
    input_source=none
  fi
  ;;
esac

case $input_source in
stdin)
  IFS= read -r response || response=
  ;;
tty)
  IFS= read -r response </dev/tty || response=
  ;;
*)
  if [ -n "$default_value" ]; then
    printf '%s\n' "$default_value"
    return 0
  fi
  die "ask-text: No interactive input available." || return 1
  ;;
esac

if [ -z "$response" ] && [ -n "$default_value" ]; then
  response=$default_value
fi

printf '%s\n' "$response"
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
