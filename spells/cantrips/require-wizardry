#!/bin/sh

# Guard a script against wizardry not being installed by exiting with a
# descriptive error or offering to install wizardry.

require_wizardry_usage() {
cat <<'USAGE'
Usage: require-wizardry [--check|--offer|--snippet]

Verify wizardry is available before running scripts that depend on it. Run with no flag or --check for a silent status check, --offer to guide the user through installing, or --snippet to print embeddable guard code.
USAGE
}



require_wizardry() {
case "${1-}" in
--help|--usage|-h)
  require_wizardry_usage
  return 0
  ;;
esac

set -eu
. env-clear

mode=${1:---offer}

case $mode in
--check)
# Check if wizardry is installed by looking for a core spell
if command -v menu >/dev/null 2>&1; then
return 0
else
return 1
fi
;;
--offer)
# Check if wizardry is installed
if command -v menu >/dev/null 2>&1; then
return 0
fi

# Offer to install
printf '%s\n' "Wizardry is not installed or not in PATH." >&2
printf '%s\n' "" >&2

# Check if we're in interactive mode
if [ -t 0 ]; then
printf '%s' "Would you like to install wizardry? [y/N] " >&2
IFS= read -r reply || reply=""
case $reply in
y|Y|yes|YES)
printf '%s\n' "" >&2
printf '%s\n' "Installing wizardry..." >&2
# Download and run the install script
if command -v curl >/dev/null 2>&1; then
curl -fsSL https://raw.githubusercontent.com/andersaamodt/wizardry/main/install | sh
return 1 $?
elif command -v wget >/dev/null 2>&1; then
wget -qO- https://raw.githubusercontent.com/andersaamodt/wizardry/main/install | sh
return 1 $?
else
printf '%s\n' "Error: neither curl nor wget is available to download wizardry." >&2
return 1
fi
;;
*)
printf '%s\n' "" >&2
printf '%s\n' "To install wizardry, run:" >&2
printf '%s\n' "  curl -fsSL https://raw.githubusercontent.com/andersaamodt/wizardry/main/install | sh" >&2
return 1
;;
esac
else
printf '%s\n' "This script requires wizardry. To install:" >&2
printf '%s\n' "  curl -fsSL https://raw.githubusercontent.com/andersaamodt/wizardry/main/install | sh" >&2
printf '%s\n' "" >&2
printf '%s\n' "Or clone and install with git:" >&2
printf '%s\n' "  git clone https://github.com/andersaamodt/wizardry ~/.wizardry" >&2
printf '%s\n' "  cd ~/.wizardry && ./install" >&2
return 1
fi
;;
--snippet)
# Print embeddable snippet
cat <<'SNIPPET'
# --- require-wizardry snippet ---
# Copy this block into scripts that depend on wizardry but cannot assume it's installed.
# This check runs before any imps are called, providing a clear error if wizardry is missing.

_require_wizardry() {
# Check for a core wizardry spell to verify installation
if command -v menu >/dev/null 2>&1; then
return 0
fi

printf '%s\n' "Error: wizardry is not installed or not in PATH." >&2
printf '%s\n' "" >&2
printf '%s\n' "This script requires wizardry. To install:" >&2
printf '%s\n' "  curl -fsSL https://raw.githubusercontent.com/andersaamodt/wizardry/main/install | sh" >&2
printf '%s\n' "" >&2
printf '%s\n' "Or clone and install with git:" >&2
printf '%s\n' "  git clone https://github.com/andersaamodt/wizardry ~/.wizardry" >&2
printf '%s\n' "  cd ~/.wizardry && ./install" >&2
return 1
}

_require_wizardry
# --- end require-wizardry snippet ---
SNIPPET
return 0
;;
*)
require_wizardry_usage >&2
return 1
;;
esac
}

# Self-execute when run directly (not sourced)
case "$0" in
  */require-wizardry) require_wizardry "$@" ;; esac
