#!/bin/sh

# Toggle Tor hidden service hosting for a specific site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: toggle-site-tor-hosting SITENAME

Enable or disable Tor hidden service hosting for a specific site.
If enabling and tor is not set up, walks through the setup process.

Examples:
  toggle-site-tor-hosting mysite
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. declare-globals

site_name="${1-}"
if [ -z "$site_name" ]; then
  die 2 "toggle-site-tor-hosting: SITENAME required"
fi

WEB_ROOT="${WIZARDRY_SITES_DIR}"
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "toggle-site-tor-hosting: site '$site_name' not found"
fi

# Get the site's port
port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")

# Only check tor dependencies when ENABLING (not when disabling)
# Check if this site already has a hidden service configured
tor_config_path=$(torrc-path) || exit 1
hs_configured=0
if grep -q "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null; then
  hs_configured=1
fi

# Only do tor checks/prompts when enabling (hs_configured=0)
if [ "$hs_configured" -eq 0 ]; then
  # Check if tor is installed
  if ! is-tor-installed; then
    printf '%s\n' "Tor is not installed."
    printf '%s' "Would you like to install Tor now? [y/n]: "
    IFS= read -r install_choice || exit 1
    case $install_choice in
    y|Y)
      install-tor || exit 1
      ;;
    *)
      printf '%s\n' "Tor installation skipped. Cannot set up hidden service without Tor."
      exit 0
      ;;
    esac
  fi

  # Check if tor daemon is enabled
  if ! is-tor-daemon-enabled; then
    printf '%s\n' "Tor daemon is not set to start at startup."
    printf '%s' "Would you like to enable Tor daemon to start at startup? [y/n]: "
    IFS= read -r daemon_choice || exit 1
    case $daemon_choice in
    y|Y)
      enable-tor-daemon || exit 1
      ;;
    *)
      printf '%s\n' "Note: Tor daemon not enabled for automatic startup."
      ;;
    esac
  fi

  # Auto-start tor if not running (no prompt needed)
  if ! is-tor-running; then
    printf '%s\n' "Starting tor..."
    start-tor || exit 1
  fi
fi

# Detect platform for proper paths
if command -v detect-distro >/dev/null 2>&1; then
  distro=$(detect-distro)
else
  distro=$(os)
fi

# Detect tor's data directory
data_dir=$(grep "^DataDirectory" "$tor_config_path" 2>/dev/null \
    | awk '{print $2}' | tr -d '"' || echo "")

# Set platform-specific hidden service directory for this site
case $distro in
mac|macos)
  if [ -n "$data_dir" ]; then
    hs_dir="${data_dir}/${site_name}/"
  elif [ -d "/opt/homebrew/var/lib/tor" ]; then
    hs_dir="/opt/homebrew/var/lib/tor/${site_name}/"
  elif [ -d "/usr/local/var/lib/tor" ]; then
    hs_dir="/usr/local/var/lib/tor/${site_name}/"
  elif [ -d "/opt/local/var/lib/tor" ]; then
    hs_dir="/opt/local/var/lib/tor/${site_name}/"
  else
    hs_dir="/var/lib/tor/${site_name}/"
  fi
  ;;
*)
  if [ -n "$data_dir" ]; then
    hs_dir="${data_dir}/${site_name}/"
  else
    hs_dir="/var/lib/tor/${site_name}/"
  fi
  ;;
esac

# Check if this site already has a hidden service configured
hs_configured=0
if grep -q "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null; then
  hs_configured=1
fi

if [ "$hs_configured" -eq 1 ]; then
  # Site is configured - disable it automatically (user already clicked toggle)
    # Remove the hidden service configuration from torrc
    # Create temp file and remove lines for this site
    temp_torrc=$(mktemp)
    in_hs_block=0
    while IFS= read -r line; do
      if printf '%s' "$line" | grep -q "^HiddenServiceDir.*${site_name}"; then
        in_hs_block=1
        continue
      fi
      if [ "$in_hs_block" -eq 1 ]; then
        if printf '%s' "$line" | grep -q "^HiddenServiceVersion"; then
          continue
        fi
        if printf '%s' "$line" | grep -q "^HiddenServicePort"; then
          in_hs_block=0
          continue
        fi
      fi
      printf '%s\n' "$line" >> "$temp_torrc"
    done < "$tor_config_path"
    
    sudo cp "$temp_torrc" "$tor_config_path"
    # Ensure torrc remains readable after modification
    sudo chmod 644 "$tor_config_path"
    rm -f "$temp_torrc"
    
    printf '%s\n' "Tor hidden service disabled for site '$site_name'"
    repair-tor-permissions >/dev/null 2>&1 || true
    restart-tor || true
else
  # Site is not configured - enable it
  # Create the hidden service directory
    sudo mkdir -p "$hs_dir" || exit 1
    sudo chown -R _tor:wheel "$hs_dir" 2>/dev/null \
        || sudo chown -R tor:tor "$hs_dir" 2>/dev/null || true
    sudo chmod 700 "$hs_dir" || true
    
  # Add hidden service configuration to torrc
  printf '\n# Hidden service for site: %s\n' "$site_name" | sudo tee -a "$tor_config_path" >/dev/null
  printf 'HiddenServiceDir %s\n' "$hs_dir" | sudo tee -a "$tor_config_path" >/dev/null
  printf '%s\n' "HiddenServiceVersion 3" | sudo tee -a "$tor_config_path" >/dev/null
  printf 'HiddenServicePort 80 127.0.0.1:%s\n' "$port" | sudo tee -a "$tor_config_path" >/dev/null
  
  # Ensure torrc remains readable after modification
  sudo chmod 644 "$tor_config_path"
  
  printf '%s\n' "Hidden service configured for site '$site_name'"
  repair-tor-permissions >/dev/null 2>&1 || true
  
  restart-tor || true
fi
