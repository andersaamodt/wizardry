#!/bin/sh
# Diagnose SSE buffering configuration

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: diagnose-sse-buffering SITENAME

Checks SSE buffering configuration for a site.
Helps diagnose "one message behind" issues.

Example: diagnose-sse-buffering mysite
USAGE
  exit 0
  ;;
esac

set -eu

site_name=${1-}
if [ -z "$site_name" ]; then
  printf 'Usage: diagnose-sse-buffering SITENAME\n' >&2
  exit 2
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITE_DIR="$WEB_ROOT/$site_name"

echo "======================================================================"
echo "SSE Buffering Diagnostic for: $site_name"
echo "======================================================================"
echo ""

# Check 1: stdbuf/script availability
echo "CHECK 1: Unbuffering tools availability"
if command -v stdbuf >/dev/null 2>&1; then
  echo "  ✓ stdbuf is available (Linux/GNU)"
  stdbuf --version 2>&1 | head -1
elif command -v script >/dev/null 2>&1; then
  echo "  ✓ script command is available (macOS/BSD - uses pty for unbuffering)"
  echo "    This will be used to unbuffer fcgiwrap"
else
  echo "  ✗ Neither stdbuf nor script available"
  echo "    SSE will be buffered - install coreutils for stdbuf"
fi
echo ""

# Check 2: fcgiwrap process
echo "CHECK 2: fcgiwrap process"
if [ -f "$SITE_DIR/nginx/fcgiwrap.pid" ]; then
  fcgi_pid=$(cat "$SITE_DIR/nginx/fcgiwrap.pid")
  if kill -0 "$fcgi_pid" 2>/dev/null; then
    echo "  ✓ fcgiwrap running (PID: $fcgi_pid)"
    
    # Check if running with stdbuf or script
    cmd=$(ps -p "$fcgi_pid" -o command= 2>/dev/null || echo "")
    if echo "$cmd" | grep -q stdbuf; then
      echo "  ✓ fcgiwrap started WITH stdbuf (unbuffered - Linux/GNU)"
      echo "    Command: $cmd"
    elif echo "$cmd" | grep -q "script.*fcgiwrap"; then
      echo "  ✓ fcgiwrap started WITH script/pty (unbuffered - macOS/BSD)"
      echo "    Command: $cmd"
    else
      echo "  ✗ fcgiwrap started WITHOUT unbuffering (BUFFERED!)"
      echo "    Command: $cmd"
      echo "    FIX: Stop and restart web server"
    fi
  else
    echo "  ✗ fcgiwrap not running (PID file stale)"
  fi
else
  echo "  ✗ fcgiwrap PID file not found"
fi
echo ""

# Check 3: nginx config
echo "CHECK 3: nginx FastCGI buffering config"
if [ -f "$SITE_DIR/nginx/nginx.conf" ]; then
  echo "  Checking for required nginx settings:"
  
  if grep -q "fastcgi_buffering off" "$SITE_DIR/nginx/nginx.conf"; then
    echo "  ✓ fastcgi_buffering off"
  else
    echo "  ✗ fastcgi_buffering off NOT found"
  fi
  
  if grep -q "fastcgi_keep_conn on" "$SITE_DIR/nginx/nginx.conf"; then
    echo "  ✓ fastcgi_keep_conn on (required for SSE)"
  else
    echo "  ✗ fastcgi_keep_conn on NOT found (REQUIRED!)"
    echo "    This is needed for long-lived FastCGI connections"
  fi
  
  if grep -q "gzip off" "$SITE_DIR/nginx/nginx.conf"; then
    echo "  ✓ gzip off (prevents buffering)"
  else
    echo "  ✗ gzip off NOT found (may cause buffering)"
  fi
  
  if grep -q "fastcgi_request_buffering off" "$SITE_DIR/nginx/nginx.conf"; then
    echo "  ✓ fastcgi_request_buffering off"
  else
    echo "  ✗ fastcgi_request_buffering off NOT found"
  fi
else
  echo "  ✗ nginx.conf not found"
fi
echo ""

# Check 4: chat-stream version
echo "CHECK 4: chat-stream script version"
WIZARDRY_DIR=${WIZARDRY_DIR:-$HOME/.wizardry}
if [ -f "$WIZARDRY_DIR/spells/.imps/cgi/chat-stream" ]; then
  version=$(grep "VERSION:" "$WIZARDRY_DIR/spells/.imps/cgi/chat-stream" | head -1)
  echo "  $version"
  
  if grep -q "UNBUFFERED_ACTIVE" "$WIZARDRY_DIR/spells/.imps/cgi/chat-stream"; then
    echo "  ✓ Script has stdbuf re-exec logic"
  else
    echo "  ✗ Script missing stdbuf re-exec logic"
  fi
else
  echo "  ✗ chat-stream not found"
fi
echo ""

# Check 5: Error log for diagnostic messages
echo "CHECK 5: Recent error log messages"
if [ -f "$SITE_DIR/nginx/error.log" ]; then
  echo "  Last 10 chat-stream startup messages:"
  grep "chat-stream.*SCRIPT STARTED" "$SITE_DIR/nginx/error.log" 2>/dev/null | tail -5 || echo "  (none found)"
  echo ""
  echo "  Last unbuffering mode message:"
  grep -E "MODE:|Using stdbuf|Using dd flush" "$SITE_DIR/nginx/error.log" 2>/dev/null | tail -3 || echo "  (none found)"
else
  echo "  ✗ Error log not found"
fi
echo ""

# Summary
echo "======================================================================"
echo "SUMMARY"
echo "======================================================================"
echo ""
echo "For SSE to work without buffering delays, ALL must be true:"
echo "  1. stdbuf OR script command available (for unbuffering)"
echo "  2. fcgiwrap started with unbuffering (stdbuf or script)"
echo "  3. nginx config has required settings (fastcgi_buffering off, etc)"
echo "  4. chat-stream uses internal unbuffering"
echo ""
echo "If any check failed, restart the web server:"
echo "  web-stop-site $site_name"
echo "  web-serve-site $site_name"
echo ""
echo "macOS users: 'script' command creates a pty for unbuffering"
echo "Linux users: 'stdbuf' directly unbuffers output"
echo ""
