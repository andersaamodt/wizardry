#!/bin/sh

# Show menu for managing a specific site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: site-menu [SITENAME]

Shows an interactive menu for managing a specific website.

If SITENAME is not provided, attempts to auto-detect the site
from the current directory (must be within a site directory).

Examples:
  web-site-menu mysite    # Explicit site name
  cd ~/sites/mysite && web-site-menu  # Auto-detect from current dir
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear
. colors

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}

# Try to auto-detect site from current directory if no arg given
site_name=${1-}
if [ -z "$site_name" ]; then
  current_dir=$(pwd -P)
  
  # Check if current directory is within WEB_ROOT
  case "$current_dir" in
    "$WEB_ROOT"/*)
      # Extract site name from path
      site_path="${current_dir#"$WEB_ROOT"/}"
      site_name="${site_path%%/*}"
      
      # Verify this is a valid site directory
      if [ -n "$site_name" ] && [ -d "$WEB_ROOT/$site_name/site" ]; then
        info "Auto-detected site: $site_name"
      else
        die 2 "site-menu: not in a valid site directory. Current: $current_dir"
      fi
      ;;
    *)
      die 2 "site-menu: SITENAME required (not in $WEB_ROOT)"
      ;;
  esac
fi

SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "site-menu: site '$site_name' not found"
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

while true; do
  # Build menu based on site status
  status=$(site-status "$site_name")
  
  # Check if site is being served
  is_serving=0
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
    fi
  fi
  
  # Get port from config
  port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
  
  exit_label=$(exit-label)
  
  if [ "$is_serving" -eq 1 ]; then
    set -- \
      "Open in browser%command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:$port || command -v open >/dev/null 2>&1 && open http://localhost:$port || printf 'Visit: http://localhost:$port\n'" \
      "Build All & Restart Server%build \"$site_name\" --full && stop-site \"$site_name\" && serve-site \"$site_name\"" \
      "Build%build \"$site_name\"" \
      "Build All%build \"$site_name\" --full" \
      "Stop Server%stop-site \"$site_name\"" \
      "Build nginx.conf%configure-nginx \"$site_name\"" \
      "Fix permissions%[ -d \"$SITE_DIR/build\" ] && find \"$SITE_DIR/build\" -type d -exec chmod 755 {} \\; && find \"$SITE_DIR/build\" -type f -exec chmod 644 {} \\; && printf 'Permissions fixed\\n' || printf 'No build directory found\\n'" \
      "Open site directory%cd \"$SITE_DIR\" && \$SHELL" \
      "Delete site%delete-site \"$site_name\"" \
      "${exit_label}%kill -TERM \$PPID"
  else
    set -- \
      "Build All & Start Server%build \"$site_name\" --full && serve-site \"$site_name\"" \
      "Build%build \"$site_name\"" \
      "Build All%build \"$site_name\" --full" \
      "Serve site%serve-site \"$site_name\"" \
      "Build nginx.conf%configure-nginx \"$site_name\"" \
      "Fix permissions%[ -d \"$SITE_DIR/build\" ] && find \"$SITE_DIR/build\" -type d -exec chmod 755 {} \\; && find \"$SITE_DIR/build\" -type f -exec chmod 644 {} \\; && printf 'Permissions fixed\\n' || printf 'No build directory found\\n'" \
      "Open site directory%cd \"$SITE_DIR\" && \$SHELL" \
      "Delete site%delete-site \"$site_name\"" \
      "${exit_label}%kill -TERM \$PPID"
  fi

  menu "${BOLD}${CYAN}Site: $site_name${RESET} ($status)" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
