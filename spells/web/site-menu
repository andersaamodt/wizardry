#!/bin/sh

# Show menu for managing a specific site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: site-menu [SITENAME]

Shows an interactive menu for managing a specific website.

If SITENAME is not provided, attempts to auto-detect the site
from the current directory (must be within a site directory).

Examples:
  web-site-menu mysite    # Explicit site name
  cd ~/sites/mysite && web-site-menu  # Auto-detect from current dir
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear
. colors
. declare-globals

WEB_ROOT="${WIZARDRY_SITES_DIR}"

# Try to auto-detect site from current directory if no arg given
site_name=${1-}
if [ -z "$site_name" ]; then
  current_dir=$(pwd -P)

  # Check if current directory is within WEB_ROOT
  case "$current_dir" in
    "$WEB_ROOT"/*)
      # Extract site name from path
      site_path="${current_dir#"$WEB_ROOT"/}"
      site_name="${site_path%%/*}"

      # Verify this is a valid site directory
      if [ -n "$site_name" ] && [ -d "$WEB_ROOT/$site_name/site" ]; then
        info "Auto-detected site: $site_name"
      else
        die 2 "site-menu: not in a valid site directory. Current: $current_dir"
      fi
      ;;
    *)
      die 2 "site-menu: SITENAME required (not in $WEB_ROOT)"
      ;;
  esac
fi

SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"
SITE_DATA_DIR="$SITES_DIR/.sitedata/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "site-menu: site '$site_name' not found"
fi

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_DIR/site.conf" site-user 2>/dev/null || printf '')
[ -z "$site_user" ] && site_user="$site_user_default"

# Note: We don't re-exec as site user here - individual commands will use sudo if needed
# This allows "Open site directory" and "Open site data" to work as the actual user
if [ -n "$site_user" ] && ! id -u "$site_user" >/dev/null 2>&1; then
  warn "site-menu: This site's user, $site_user, is missing."
  warn "site-menu: You can repair this with \"Fix permissions\"."
fi

# Use temp file for selection tracking (same pattern as core-menu)
SELECTION_FILE=$(temp-file site-menu-selection)
export SELECTION_FILE

# Catch Ctrl-C and TERM signal to exit cleanly and clean up
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 130' INT
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 0' TERM
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true' EXIT

while true; do
  # Read last selected position from temp file, default to 1
  if [ -f "$SELECTION_FILE" ]; then
    start_selection=$(cat "$SELECTION_FILE" 2>/dev/null || printf '1')
    # Handle empty file
    if [ -z "$start_selection" ]; then
      start_selection=1
    fi
  else
    start_selection=1
  fi

  # Build menu based on site status
  status=$(site-status "$site_name")

  # Check if site is being served
  is_serving=0
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
    fi
  fi

  # Get port from config
  port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || true)
  [ -z "$port" ] && port=8080

  # Check if tor hosting is enabled for this site
  # Only show tor hosting option if tor is installed
  tor_hosting_enabled=0
  tor_hosting_option=""
  if is-tor-installed; then
    if command -v torrc-path >/dev/null 2>&1; then
      tor_config_path=$(torrc-path 2>/dev/null || echo "")
      if [ -n "$tor_config_path" ] && [ -f "$tor_config_path" ]; then
        if grep -q "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null; then
          tor_hosting_enabled=1
          tor_hosting_option="[X] Tor hosting%toggle-site-tor-hosting \"$site_name\""
        else
          tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
        fi
      else
        tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
      fi
    else
      tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
    fi
  fi

  # Check for site-specific hidden service hostname file
  copy_site_onion=""
  if [ "$tor_hosting_enabled" -eq 1 ] && [ -n "$tor_config_path" ]; then
    # Extract the HiddenServiceDir path from torrc for this site
    site_hostname_dir=$(grep "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null \
      | awk '{print $2}' | head -1)
    if [ -n "$site_hostname_dir" ]; then
      # Remove trailing slash if present
      site_hostname_dir="${site_hostname_dir%/}"
      site_hostname_file="$site_hostname_dir/hostname"
      copy_cmd="clip-copy \"\$(sudo cat \"$site_hostname_file\" 2>/dev/null"
      copy_cmd="$copy_cmd || cat \"$site_hostname_file\")\""
      copy_site_onion="Copy .onion address%$copy_cmd"
    fi
  fi

  # Check HTTPS status to show appropriate menu options
  https_option=""
  if check-https-status "$site_name" 2>/dev/null; then
    # HTTPS is configured - show renew and disable options
    https_option="Renew HTTPS%renew-https \"$site_name\""
    https_disable_option="Disable HTTPS%disable-https \"$site_name\""
  else
    # HTTPS is not configured - show setup option
    https_option="Set up HTTPS%setup-https \"$site_name\""
    https_disable_option=""
  fi

  serve_on_startup_option=""
  if is-site-daemon-enabled "$site_name" 2>/dev/null; then
    serve_on_startup_option="[X] Serve on startup%disable-site-daemon \"$site_name\""
  else
    serve_on_startup_option="[ ] Serve on startup%enable-site-daemon \"$site_name\""
  fi

  exit_label=$(exit-label)

  if has systemctl; then
    daemon_artifact="${SERVICE_DIR:-/etc/systemd/system}/wizardry-site-${site_name}.service"
  else
    daemon_artifact="/Library/LaunchDaemons/org.wizardry.web.${site_name}.plist"
  fi
  daemon_label="Repair server daemon"
  if [ ! -f "$daemon_artifact" ]; then
    daemon_label="Create server daemon"
  fi

  # Helper to wrap command with selection memory (entry_index is passed as arg)
  wrap_cmd() {
    entry_index=$1
    cmd=$2
    printf '%s; echo %s > "%s"' "$cmd" "$entry_index" "$SELECTION_FILE"
  }

  if [ "$is_serving" -eq 1 ]; then
    entry_index=0
    entry_index=$((entry_index + 1))
    open_browser_cmd="command -v xdg-open >/dev/null 2>&1"
    open_browser_cmd="$open_browser_cmd && xdg-open http://localhost:$port"
    open_browser_cmd="$open_browser_cmd || command -v open >/dev/null 2>&1"
    open_browser_cmd="$open_browser_cmd && open http://localhost:$port"
    open_browser_cmd="$open_browser_cmd || printf 'Visit: http://localhost:$port\n'"
    cmd1=$(wrap_cmd "$entry_index" "$open_browser_cmd")
    entry_index=$((entry_index + 1))
    build_restart_cmd="build \"$site_name\" --full"
    build_restart_cmd="$build_restart_cmd && stop-site \"$site_name\""
    build_restart_cmd="$build_restart_cmd && serve-site \"$site_name\""
    cmd2=$(wrap_cmd "$entry_index" "$build_restart_cmd")
    entry_index=$((entry_index + 1))
    cmd3=$(wrap_cmd "$entry_index" "update-from-template \"$site_name\"")
    if [ -n "$copy_site_onion" ]; then
      entry_index=$((entry_index + 1))
      copy_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$copy_site_onion" | cut -d% -f2-)")
      copy_site_onion="Copy .onion address%$copy_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd4=$(wrap_cmd "$entry_index" "cd \"$SITE_DIR\" && exec \$SHELL")
    entry_index=$((entry_index + 1))
    open_data_cmd="[ -d \"$SITE_DATA_DIR\" ]"
    open_data_cmd="$open_data_cmd && cd \"$SITE_DATA_DIR\" && exec \$SHELL"
    open_data_cmd="$open_data_cmd || { printf 'No site data yet"
    open_data_cmd="$open_data_cmd (will be created when needed)\\n';"
    open_data_cmd="$open_data_cmd read -r dummy; }"
    cmd5=$(wrap_cmd "$entry_index" "$open_data_cmd")
    # --- separator
    entry_index=$((entry_index + 1))  # Increment for separator
    entry_index=$((entry_index + 1))
    cmd6=$(wrap_cmd "$entry_index" "build \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd7=$(wrap_cmd "$entry_index" "build \"$site_name\" --full")
    entry_index=$((entry_index + 1))
    cmd8=$(wrap_cmd "$entry_index" \
      "stop-site \"$site_name\" && serve-site \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd9=$(wrap_cmd "$entry_index" "stop-site \"$site_name\"")
    # --- separator
    entry_index=$((entry_index + 1))  # Increment for separator
    if [ -n "$tor_hosting_option" ]; then
      entry_index=$((entry_index + 1))
      tor_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$tor_hosting_option" | cut -d% -f2-)")
      tor_label=$(printf '%s' "$tor_hosting_option" | cut -d% -f1)
      tor_hosting_option="${tor_label}%$tor_cmd_wrapped"
    fi
    if [ -n "$serve_on_startup_option" ]; then
      entry_index=$((entry_index + 1))
      startup_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$serve_on_startup_option" | cut -d% -f2-)")
      startup_label=$(printf '%s' "$serve_on_startup_option" | cut -d% -f1)
      serve_on_startup_option="${startup_label}%$startup_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd10=$(wrap_cmd "$entry_index" "change-site-port \"$site_name\"")
    if [ -n "$https_option" ]; then
      entry_index=$((entry_index + 1))
      https_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$https_option" | cut -d% -f2-)")
      https_label=$(printf '%s' "$https_option" | cut -d% -f1)
      https_option="${https_label}%$https_cmd_wrapped"
    fi
    if [ -n "$https_disable_option" ]; then
      entry_index=$((entry_index + 1))
      https_disable_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$https_disable_option" | cut -d% -f2-)")
      https_disable_label=$(printf '%s' "$https_disable_option" | cut -d% -f1)
      https_disable_option="${https_disable_label}%$https_disable_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd11=$(wrap_cmd "$entry_index" "configure-nginx \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd12=$(wrap_cmd "$entry_index" "repair-site-daemon \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd13=$(wrap_cmd "$entry_index" "fix-site-security \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd14=$(wrap_cmd "$entry_index" "manage-allowed-dirs \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd15=$(wrap_cmd "$entry_index" "delete-site \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd_exit=$(wrap_cmd "$entry_index" "kill -TERM \$PPID")

    set -- \
      "Open in browser%$cmd1" \
      "Build All & Restart Server%$cmd2" \
      "Update from template%$cmd3" \
      ${copy_site_onion:+"$copy_site_onion"} \
      "Open site directory%$cmd4" \
      "Open site data%$cmd5" \
      "---" \
      "Build%$cmd6" \
      "Build All%$cmd7" \
      "Restart server%$cmd8" \
      "Stop server%$cmd9" \
      "---" \
      ${tor_hosting_option:+"$tor_hosting_option"} \
      ${serve_on_startup_option:+"$serve_on_startup_option"} \
      "Change port (current: $port)%$cmd10" \
      ${https_option:+"$https_option"} \
      ${https_disable_option:+"$https_disable_option"} \
      "Rebuild nginx.conf%$cmd11" \
      "$daemon_label%$cmd12" \
      "Fix permissions%$cmd13" \
      "Manage allowed dirs%$cmd14" \
      "Delete site%$cmd15" \
      "${exit_label}%$cmd_exit"
  else
    entry_index=0
    entry_index=$((entry_index + 1))
    build_restart_cmd="build \"$site_name\" --full"
    build_restart_cmd="$build_restart_cmd && stop-site \"$site_name\""
    build_restart_cmd="$build_restart_cmd && serve-site \"$site_name\""
    cmd1=$(wrap_cmd "$entry_index" "$build_restart_cmd")
    entry_index=$((entry_index + 1))
    cmd2=$(wrap_cmd "$entry_index" "update-from-template \"$site_name\"")
    if [ -n "$copy_site_onion" ]; then
      entry_index=$((entry_index + 1))
      copy_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$copy_site_onion" | cut -d% -f2-)")
      copy_site_onion="Copy .onion address%$copy_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd3=$(wrap_cmd "$entry_index" "cd \"$SITE_DIR\" && exec \$SHELL")
    entry_index=$((entry_index + 1))
    open_data_cmd="[ -d \"$SITE_DATA_DIR\" ]"
    open_data_cmd="$open_data_cmd && cd \"$SITE_DATA_DIR\" && exec \$SHELL"
    open_data_cmd="$open_data_cmd || { printf 'No site data yet"
    open_data_cmd="$open_data_cmd (will be created when needed)\\n';"
    open_data_cmd="$open_data_cmd read -r dummy; }"
    cmd4=$(wrap_cmd "$entry_index" "$open_data_cmd")
    # --- separator
    entry_index=$((entry_index + 1))  # Increment for separator
    entry_index=$((entry_index + 1))
    cmd5=$(wrap_cmd "$entry_index" "build \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd6=$(wrap_cmd "$entry_index" "build \"$site_name\" --full")
    entry_index=$((entry_index + 1))
    cmd7=$(wrap_cmd "$entry_index" \
      "stop-site \"$site_name\" && serve-site \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd8=$(wrap_cmd "$entry_index" "serve-site \"$site_name\"")
    # --- separator
    entry_index=$((entry_index + 1))  # Increment for separator
    if [ -n "$tor_hosting_option" ]; then
      entry_index=$((entry_index + 1))
      tor_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$tor_hosting_option" | cut -d% -f2-)")
      tor_label=$(printf '%s' "$tor_hosting_option" | cut -d% -f1)
      tor_hosting_option="${tor_label}%$tor_cmd_wrapped"
    fi
    if [ -n "$serve_on_startup_option" ]; then
      entry_index=$((entry_index + 1))
      startup_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$serve_on_startup_option" | cut -d% -f2-)")
      startup_label=$(printf '%s' "$serve_on_startup_option" | cut -d% -f1)
      serve_on_startup_option="${startup_label}%$startup_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd9=$(wrap_cmd "$entry_index" "change-site-port \"$site_name\"")
    if [ -n "$https_option" ]; then
      entry_index=$((entry_index + 1))
      https_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$https_option" | cut -d% -f2-)")
      https_label=$(printf '%s' "$https_option" | cut -d% -f1)
      https_option="${https_label}%$https_cmd_wrapped"
    fi
    if [ -n "$https_disable_option" ]; then
      entry_index=$((entry_index + 1))
      https_disable_cmd_wrapped=$(wrap_cmd "$entry_index" \
        "$(printf '%s' "$https_disable_option" | cut -d% -f2-)")
      https_disable_label=$(printf '%s' "$https_disable_option" | cut -d% -f1)
      https_disable_option="${https_disable_label}%$https_disable_cmd_wrapped"
    fi
    entry_index=$((entry_index + 1))
    cmd10=$(wrap_cmd "$entry_index" "configure-nginx \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd11=$(wrap_cmd "$entry_index" "repair-site-daemon \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd12=$(wrap_cmd "$entry_index" "fix-site-security \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd13=$(wrap_cmd "$entry_index" "manage-allowed-dirs \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd14=$(wrap_cmd "$entry_index" "delete-site \"$site_name\"")
    entry_index=$((entry_index + 1))
    cmd_exit=$(wrap_cmd "$entry_index" "kill -TERM \$PPID")

    set -- \
      "Build All & Restart Server%$cmd1" \
      "Update from template%$cmd2" \
      ${copy_site_onion:+"$copy_site_onion"} \
      "Open site directory%$cmd3" \
      "Open site data%$cmd4" \
      "---" \
      "Build%$cmd5" \
      "Build All%$cmd6" \
      "Restart server%$cmd7" \
      "Start server%$cmd8" \
      "---" \
      ${tor_hosting_option:+"$tor_hosting_option"} \
      ${serve_on_startup_option:+"$serve_on_startup_option"} \
      "Change port (current: $port)%$cmd9" \
      ${https_option:+"$https_option"} \
      ${https_disable_option:+"$https_disable_option"} \
      "Rebuild nginx.conf%$cmd10" \
      "$daemon_label%$cmd11" \
      "Fix permissions%$cmd12" \
      "Manage allowed dirs%$cmd13" \
      "Delete site%$cmd14" \
      "${exit_label}%$cmd_exit"
  fi

  menu_title="${BOLD}${CYAN}Site: $site_name${RESET} ($status)"
  menu --start-selection "$start_selection" "$menu_title" "$@" \
    || menu_status=$?
  menu_status=${menu_status:-0}

  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
