#!/bin/sh

# Show menu for managing a specific site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: site-menu [SITENAME]

Shows an interactive menu for managing a specific website.

If SITENAME is not provided, attempts to auto-detect the site
from the current directory (must be within a site directory).

Examples:
  web-site-menu mysite    # Explicit site name
  cd ~/sites/mysite && web-site-menu  # Auto-detect from current dir
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear
. colors
. declare-globals

WEB_ROOT="${WIZARDRY_SITES_DIR}"

# Try to auto-detect site from current directory if no arg given
site_name=${1-}
if [ -z "$site_name" ]; then
  current_dir=$(pwd -P)
  
  # Check if current directory is within WEB_ROOT
  case "$current_dir" in
    "$WEB_ROOT"/*)
      # Extract site name from path
      site_path="${current_dir#"$WEB_ROOT"/}"
      site_name="${site_path%%/*}"
      
      # Verify this is a valid site directory
      if [ -n "$site_name" ] && [ -d "$WEB_ROOT/$site_name/site" ]; then
        info "Auto-detected site: $site_name"
      else
        die 2 "site-menu: not in a valid site directory. Current: $current_dir"
      fi
      ;;
    *)
      die 2 "site-menu: SITENAME required (not in $WEB_ROOT)"
      ;;
  esac
fi

SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"
SITE_DATA_DIR="$SITES_DIR/.sitedata/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "site-menu: site '$site_name' not found"
fi

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_DIR/site.conf" site-user 2>/dev/null || printf '')
[ -z "$site_user" ] && site_user="$site_user_default"
if [ -n "$site_user" ] && [ "$(id -un)" != "$site_user" ] && [ -z "${WIZARDRY_SITE_USER_REEXEC-}" ]; then
  can_sudo=0
  if [ "$(id -u)" -eq 0 ] && has sudo; then
    can_sudo=1
  fi
  if ! id -u "$site_user" >/dev/null 2>&1; then
    warn "site-menu: This site's user, $site_user, is missing. You can repair this with \"Repair permissions\"."
  fi
  if id -u "$site_user" >/dev/null 2>&1; then
    if [ "$can_sudo" -eq 1 ]; then
      exec sudo -u "$site_user" -- env WIZARDRY_SITE_USER_REEXEC=1 "$0" "$site_name" "$@"
    fi
  fi
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

while true; do
  # Build menu based on site status
  status=$(site-status "$site_name")
  
  # Check if site is being served
  is_serving=0
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
    fi
  fi
  
  # Get port from config
  port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || true)
  [ -z "$port" ] && port=8080
  
  # Check if tor hosting is enabled for this site
  # Only show tor hosting option if tor is installed
  tor_hosting_enabled=0
  tor_hosting_option=""
  if is-tor-installed; then
    if command -v torrc-path >/dev/null 2>&1; then
      tor_config_path=$(torrc-path 2>/dev/null || echo "")
      if [ -n "$tor_config_path" ] && [ -f "$tor_config_path" ]; then
        if grep -q "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null; then
          tor_hosting_enabled=1
          tor_hosting_option="[X] Tor hosting%toggle-site-tor-hosting \"$site_name\""
        else
          tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
        fi
      else
        tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
      fi
    else
      tor_hosting_option="[ ] Tor hosting%toggle-site-tor-hosting \"$site_name\""
    fi
  fi
  
  # Check for site-specific hidden service hostname file
  copy_site_onion=""
  if [ "$tor_hosting_enabled" -eq 1 ] && [ -n "$tor_config_path" ]; then
    # Extract the HiddenServiceDir path from torrc for this site
    site_hostname_dir=$(grep "^HiddenServiceDir.*${site_name}" "$tor_config_path" 2>/dev/null \
      | awk '{print $2}' | head -1)
    if [ -n "$site_hostname_dir" ]; then
      # Remove trailing slash if present
      site_hostname_dir="${site_hostname_dir%/}"
      site_hostname_file="$site_hostname_dir/hostname"
      copy_cmd="clip-copy \"\$(sudo cat \"$site_hostname_file\" 2>/dev/null"
      copy_cmd="$copy_cmd || cat \"$site_hostname_file\")\""
      copy_site_onion="Copy .onion address%$copy_cmd"
    fi
  fi
  
  # Check HTTPS status to show appropriate menu options
  https_option=""
  if check-https-status "$site_name" 2>/dev/null; then
    # HTTPS is configured - show renew and disable options
    https_option="Renew HTTPS%renew-https \"$site_name\""
    https_disable_option="Disable HTTPS%disable-https \"$site_name\""
  else
    # HTTPS is not configured - show setup option
    https_option="Set up HTTPS%setup-https \"$site_name\""
    https_disable_option=""
  fi

  serve_on_startup_option=""
  if is-site-daemon-enabled "$site_name" 2>/dev/null; then
    serve_on_startup_option="[X] Serve on startup%disable-site-daemon \"$site_name\""
  else
    serve_on_startup_option="[ ] Serve on startup%enable-site-daemon \"$site_name\""
  fi
  
  exit_label=$(exit-label)
  
  if [ "$is_serving" -eq 1 ]; then
    set -- \
      "Open in browser%command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:$port || command -v open >/dev/null 2>&1 && open http://localhost:$port || printf 'Visit: http://localhost:$port\n'" \
      "Build All & Restart Server%build \"$site_name\" --full && stop-site \"$site_name\" && serve-site \"$site_name\"" \
      "Update from template%update-from-template \"$site_name\"" \
      ${copy_site_onion:+"$copy_site_onion"} \
      "Open site directory%cd \"$SITE_DIR\" && exec \$SHELL" \
      "Open site data%[ -d \"$SITE_DATA_DIR\" ] && cd \"$SITE_DATA_DIR\" && exec \$SHELL || { printf 'No site data yet (will be created when needed)\\n'; read -r dummy; }" \
      "---" \
      "Build%build \"$site_name\"" \
      "Build All%build \"$site_name\" --full" \
      "Restart server%stop-site \"$site_name\" && serve-site \"$site_name\"" \
      "Stop server%stop-site \"$site_name\"" \
      "---" \
      ${tor_hosting_option:+"$tor_hosting_option"} \
      ${serve_on_startup_option:+"$serve_on_startup_option"} \
      "Change port (current: $port)%change-site-port \"$site_name\"" \
      ${https_option:+"$https_option"} \
      ${https_disable_option:+"$https_disable_option"} \
      "Rebuild nginx.conf%configure-nginx \"$site_name\"" \
      "Repair server daemon%repair-site-daemon \"$site_name\"" \
      "Fix permissions%fix-site-security \"$site_name\"" \
      "Manage allowed dirs%manage-allowed-dirs \"$site_name\"" \
      "Delete site%delete-site \"$site_name\"" \
      "${exit_label}%kill -TERM \$PPID"
  else
    set -- \
      "Build All & Restart Server%build \"$site_name\" --full && stop-site \"$site_name\" && serve-site \"$site_name\"" \
      "Update from template%update-from-template \"$site_name\"" \
      ${copy_site_onion:+"$copy_site_onion"} \
      "Open site directory%cd \"$SITE_DIR\" && exec \$SHELL" \
      "Open site data%[ -d \"$SITE_DATA_DIR\" ] && cd \"$SITE_DATA_DIR\" && exec \$SHELL || { printf 'No site data yet (will be created when needed)\\n'; read -r dummy; }" \
      "---" \
      "Build%build \"$site_name\"" \
      "Build All%build \"$site_name\" --full" \
      "Restart server%stop-site \"$site_name\" && serve-site \"$site_name\"" \
      "Start server%serve-site \"$site_name\"" \
      "---" \
      ${tor_hosting_option:+"$tor_hosting_option"} \
      ${serve_on_startup_option:+"$serve_on_startup_option"} \
      "Change port (current: $port)%change-site-port \"$site_name\"" \
      ${https_option:+"$https_option"} \
      ${https_disable_option:+"$https_disable_option"} \
      "Rebuild nginx.conf%configure-nginx \"$site_name\"" \
      "Repair server daemon%repair-site-daemon \"$site_name\"" \
      "Fix permissions%fix-site-security \"$site_name\"" \
      "Manage allowed dirs%manage-allowed-dirs \"$site_name\"" \
      "Delete site%delete-site \"$site_name\"" \
      "${exit_label}%kill -TERM \$PPID"
  fi

  menu "${BOLD}${CYAN}Site: $site_name${RESET} ($status)" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
