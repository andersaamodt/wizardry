#!/bin/sh

# Stop serving a wizardry web site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: stop-site SITENAME

Stops nginx for a website.

Example: web-stop-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "stop-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "stop-site: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "stop-site: root or sudo is required"
}

# Determine which daemon system to use
if has systemctl; then
  unit="wizardry-site-${site_name}.service"
  daemon_artifact="${SERVICE_DIR:-/etc/systemd/system}/$unit"
elif [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  label="org.wizardry.web.${site_name}"
  daemon_artifact="/Library/LaunchDaemons/${label}.plist"
else
  die "stop-site: systemd or launchd is required"
fi

# Check if daemon configuration exists
if [ ! -f "$daemon_artifact" ]; then
  warn "stop-site: daemon not configured for '$site_name'"
  exit 0
fi

# Stop the daemon
step "Stopping daemon for $site_name..."

if has systemctl; then
  # Check if service is active
  if systemctl is-active --quiet "$unit" 2>/dev/null; then
    run_priv systemctl stop "$unit"
    success "Site '$site_name' stopped"
  else
    warn "stop-site: site '$site_name' is not running"
  fi
elif [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  # Check if service is loaded
  if launchctl list | grep -q "$label" 2>/dev/null; then
    # Unload without -w (don't disable boot start, just stop now)
    run_priv launchctl unload "$daemon_artifact"
    success "Site '$site_name' stopped"
  else
    warn "stop-site: site '$site_name' is not running"
  fi
fi
