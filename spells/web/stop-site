#!/bin/sh

# Stop serving a wizardry web site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: stop-site SITENAME

Stops nginx for a website.

Example: web-stop-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "stop-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "stop-site: site '$site_name' not found"
fi

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_DIR/site.conf" site-user 2>/dev/null || printf '')
[ -z "$site_user" ] && site_user="$site_user_default"

run_as_site_user() {
  if [ -z "$site_user" ] || [ "$(id -un)" = "$site_user" ]; then
    "$@"
    return
  fi

  if has sudo; then
    sudo -u "$site_user" -- "$@"
    return
  fi

  die "stop-site: root or sudo is required to run as $site_user"
}

# Stop nginx
if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
  pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
  if [ -n "$pid" ] && run_as_site_user kill -0 "$pid" 2>/dev/null; then
    step "Stopping nginx for $site_name (pid: $pid)..."
    run_as_site_user kill "$pid" 2>/dev/null || true
    rm -f "$SITE_DIR/nginx/nginx.pid"
    success "nginx stopped"
  else
    info "nginx not running for $site_name"
    rm -f "$SITE_DIR/nginx/nginx.pid"
  fi
else
  info "nginx not running for $site_name"
fi

# Stop fcgiwrap
if [ -f "$SITE_DIR/nginx/fcgiwrap.pid" ]; then
  pid=$(cat "$SITE_DIR/nginx/fcgiwrap.pid" 2>/dev/null || echo "")
  if [ -n "$pid" ] && run_as_site_user kill -0 "$pid" 2>/dev/null; then
    step "Stopping fcgiwrap (pid: $pid)..."
    run_as_site_user kill "$pid" 2>/dev/null || true
    rm -f "$SITE_DIR/nginx/fcgiwrap.pid"
    rm -f "$SITE_DIR/nginx/fcgiwrap.sock"
    success "fcgiwrap stopped"
  else
    rm -f "$SITE_DIR/nginx/fcgiwrap.pid"
    rm -f "$SITE_DIR/nginx/fcgiwrap.sock"
  fi
fi

success "Site '$site_name' stopped"
