#!/bin/sh

# Ensure per-site user exists and fix directory permissions.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: fix-site-security SITENAME

Ensures a per-site user exists and tightens permissions for:
  - site directory
  - .sitedata directory
  - allowlisted directories from site.allowlist

Example: web-fix-site-security mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "fix-site-security: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"
SITE_DATA_DIR="$SITES_DIR/.sitedata/$site_name"
SITE_CONFIG="$SITE_DIR/site.conf"
ALLOWLIST_FILE="$SITE_DIR/site.allowlist"

if [ ! -d "$SITE_DIR" ]; then
  die "fix-site-security: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi

  if has sudo; then
    sudo "$@"
    return
  fi

  die "fix-site-security: root or sudo is required"
}

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_CONFIG" site-user 2>/dev/null || printf '')
if [ -z "$site_user" ]; then
  site_user="$site_user_default"
  if [ -w "$SITE_CONFIG" ]; then
    config-set "$SITE_CONFIG" site-user "$site_user"
  elif [ "$(id -u)" -eq 0 ] || has sudo; then
    run_priv config-set "$SITE_CONFIG" site-user "$site_user"
  else
    warn "fix-site-security: cannot update site.conf without root or sudo"
  fi
fi
site_group="$site_user"
shared_group=""
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  shared_group="staff"
else
  shared_group=$(id -gn 2>/dev/null || printf '')
fi
if [ -n "$shared_group" ]; then
  site_group="$shared_group"
fi

group_exists() {
  if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has dscl; then
    dscl . -read "/Groups/$1" >/dev/null 2>&1
    return $?
  fi
  if has getent; then
    getent group "$1" >/dev/null 2>&1
    return $?
  fi
  grep -q "^$1:" /etc/group 2>/dev/null
}

ensure_site_group() {
  if [ "$(uname -s 2>/dev/null)" != "Darwin" ] || ! has dscl; then
    return 0
  fi
  if group_exists "$site_group"; then
    return 0
  fi

  max_gid=$(dscl . -list /Groups PrimaryGroupID 2>/dev/null | awk '{print $2}' | sort -n | tail -1)
  case "$max_gid" in
    ''|*[!0-9]*) max_gid=500 ;;
  esac
  gid=$((max_gid + 1))

  run_priv dscl . -create "/Groups/$site_group"
  run_priv dscl . -create "/Groups/$site_group" PrimaryGroupID "$gid"
  run_priv dscl . -create "/Groups/$site_group" RealName "Wizardry Site $site_name"
  run_priv dscl . -create "/Groups/$site_group" GroupMembership "$site_user"
  run_priv dscl . -create "/Users/$site_user" PrimaryGroupID "$gid"
}

ensure_staff_membership() {
  if [ "$(uname -s 2>/dev/null)" != "Darwin" ] || ! has dscl; then
    return 0
  fi
  run_priv dscl . -append /Groups/staff GroupMembership "$site_user" >/dev/null 2>&1 || true
}

ensure_shared_group_membership() {
  if [ -z "$shared_group" ]; then
    return 0
  fi

  if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has dscl; then
    run_priv dscl . -append "/Groups/$shared_group" GroupMembership "$site_user" >/dev/null 2>&1 || true
    return 0
  fi

  if has usermod; then
    run_priv usermod -a -G "$shared_group" "$site_user" >/dev/null 2>&1 || true
    return 0
  fi

  if has adduser; then
    run_priv adduser "$site_user" "$shared_group" >/dev/null 2>&1 || true
    return 0
  fi

  if has gpasswd; then
    run_priv gpasswd -a "$site_user" "$shared_group" >/dev/null 2>&1 || true
    return 0
  fi
}

ensure_site_user() {
  if id -u "$site_user" >/dev/null 2>&1; then
    return 0
  fi

  if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has dscl; then
    max_uid=$(dscl . -list /Users UniqueID 2>/dev/null | awk '{print $2}' | sort -n | tail -1)
    case "$max_uid" in
      ''|*[!0-9]*) max_uid=500 ;;
    esac
    uid=$((max_uid + 1))
    max_gid=$(dscl . -list /Groups PrimaryGroupID 2>/dev/null | awk '{print $2}' | sort -n | tail -1)
    case "$max_gid" in
      ''|*[!0-9]*) max_gid=500 ;;
    esac
    gid=$((max_gid + 1))
    run_priv dscl . -create "/Users/$site_user"
    run_priv dscl . -create "/Users/$site_user" UserShell /usr/sbin/nologin
    run_priv dscl . -create "/Users/$site_user" RealName "Wizardry Site $site_name"
    run_priv dscl . -create "/Users/$site_user" UniqueID "$uid"
    run_priv dscl . -create "/Groups/$site_user"
    run_priv dscl . -create "/Groups/$site_user" PrimaryGroupID "$gid"
    run_priv dscl . -create "/Groups/$site_user" RealName "Wizardry Site $site_name"
    run_priv dscl . -create "/Groups/$site_user" GroupMembership "$site_user"
    run_priv dscl . -create "/Users/$site_user" PrimaryGroupID "$gid"
    run_priv dscl . -create "/Users/$site_user" NFSHomeDirectory /var/empty
    return 0
  fi

  useradd_supports() {
    flag=$1
    if useradd --help 2>&1 | grep -q -- " $flag"; then
      return 0
    fi
    useradd -h 2>&1 | grep -q -- " $flag"
  }

  if has useradd; then
    if useradd_supports -m && useradd_supports -s; then
      run_priv useradd -m -s /usr/sbin/nologin "$site_user"
    elif useradd_supports -m; then
      run_priv useradd -m "$site_user"
    elif useradd_supports -s; then
      run_priv useradd -s /usr/sbin/nologin "$site_user"
    else
      run_priv useradd "$site_user"
    fi
    return 0
  fi

  if has adduser; then
    run_priv adduser --disabled-login --gecos "" --shell /usr/sbin/nologin "$site_user"
    return 0
  fi

  die "fix-site-security: unable to create user '$site_user' (missing useradd/adduser)"
}

set_secure_perms() {
  target=$1
  if [ ! -e "$target" ]; then
    return 0
  fi

  dir_mode=750
  file_mode=640
  if [ -n "$shared_group" ]; then
    dir_mode=775
    file_mode=664
  fi

  run_priv find "$target" -type d -exec chmod "$dir_mode" {} +
  run_priv find "$target" -type f -exec chmod "$file_mode" {} +
}

apply_allowlist() {
  if [ ! -f "$ALLOWLIST_FILE" ]; then
    return 0
  fi

  while IFS= read -r line || [ -n "$line" ]; do
    line=$(printf '%s' "$line" | sed 's/#.*$//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    case "$line" in
      /*) ;;
      *)
        warn "fix-site-security: allowlist path must be absolute: $line"
        continue
        ;;
    esac

    if [ ! -e "$line" ]; then
      warn "fix-site-security: allowlist path not found: $line"
      continue
    fi

    run_priv chown -R "$site_user":"$site_group" "$line"
    set_secure_perms "$line"
  done < "$ALLOWLIST_FILE"
}

ensure_site_user
ensure_site_group
ensure_staff_membership
ensure_shared_group_membership
if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && ! group_exists "$site_group"; then
  site_group=staff
fi

run_priv mkdir -p "$SITES_DIR/.sitedata" "$SITE_DATA_DIR"
run_priv chown -R "$site_user":"$site_group" "$SITE_DIR"
run_priv chown -R "$site_user":"$site_group" "$SITE_DATA_DIR"

set_secure_perms "$SITE_DIR"
set_secure_perms "$SITE_DATA_DIR"
apply_allowlist

if [ -f "$ALLOWLIST_FILE" ]; then
  run_priv chown "$site_user":"$site_group" "$ALLOWLIST_FILE"
  allowlist_mode=640
  if [ -n "$shared_group" ]; then
    allowlist_mode=664
  fi
  run_priv chmod "$allowlist_mode" "$ALLOWLIST_FILE"
fi

if [ -f "$SITE_CONFIG" ]; then
  run_priv chown "$site_user":"$site_group" "$SITE_CONFIG"
  config_mode=644
  if [ -n "$shared_group" ]; then
    config_mode=664
  fi
  run_priv chmod "$config_mode" "$SITE_CONFIG"
fi

success "Site security fixed for '$site_name' (user: $site_user)"
