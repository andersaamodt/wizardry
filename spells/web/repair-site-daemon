#!/bin/sh

# Repair or install the daemon configuration for a wizardry site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: repair-site-daemon SITENAME

Ensures the systemd/launchd daemon is configured for a site.

Example: repair-site-daemon mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "repair-site-daemon: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"
SITE_CONFIG="$SITE_DIR/site.conf"

if [ ! -d "$SITE_DIR" ]; then
  die "repair-site-daemon: site '$site_name' not found"
fi

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_CONFIG" site-user 2>/dev/null || printf '')
[ -z "$site_user" ] && site_user="$site_user_default"
if ! id -u "$site_user" >/dev/null 2>&1; then
  warn "repair-site-daemon: site user '$site_user' missing; run fix-site-security first"
fi

wizardry_dir=${WIZARDRY_DIR:-$HOME/.wizardry}
daemon_script="$wizardry_dir/spells/web/run-site-daemon"

if [ ! -x "$daemon_script" ]; then
  die "repair-site-daemon: daemon script not found at $daemon_script"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return 0
  fi
  if has sudo; then
    sudo "$@"
    return 0
  fi
  die "repair-site-daemon: root or sudo is required"
}

systemd_install() {
  service_dir=${SERVICE_DIR:-/etc/systemd/system}
  unit="wizardry-site-${site_name}.service"
  unit_path="$service_dir/$unit"

  base_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  wizardry_path="$wizardry_dir/spells:$wizardry_dir/spells/.imps:$wizardry_dir/spells/.imps/sys:$wizardry_dir/spells/.imps/fs:$wizardry_dir/spells/.imps/paths:$wizardry_dir/spells/.imps/str:$wizardry_dir/spells/.imps/text:$wizardry_dir/spells/.imps/input:$wizardry_dir/spells/.imps/out:$wizardry_dir/spells/.imps/cond:$wizardry_dir/spells/.imps/pkg:$wizardry_dir/spells/.imps/menu"
  daemon_path="$wizardry_path:$base_path"

  temp_unit=$(temp-file wizardry-site-daemon)
  cat > "$temp_unit" <<EOF
[Unit]
Description=Wizardry site $site_name
After=network.target

[Service]
Type=simple
User=$site_user
WorkingDirectory=$SITE_DIR
Environment=WIZARDRY_DIR=$wizardry_dir
Environment=WIZARDRY_SITES_DIR=$SITES_DIR
Environment=PATH=$daemon_path
ExecStart=$daemon_script $site_name
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

  run_priv mkdir -p "$service_dir"
  run_priv cp "$temp_unit" "$unit_path"
  run_priv chmod 644 "$unit_path"
  rm -f "$temp_unit"

  run_priv systemctl daemon-reload
  success "Daemon repaired for $site_name (systemd)"
}

launchd_install() {
  launch_dir="/Library/LaunchDaemons"
  label="org.wizardry.web.${site_name}"
  plist_file="$launch_dir/${label}.plist"

  run_priv mkdir -p "$launch_dir" "$SITE_DIR/nginx"
  # Note: nginx/ ownership is managed by fix-site-security
  # (owned by actual user so configure-nginx can write configs)

  temp_plist=$(temp-file wizardry-site-daemon)
  cat > "$temp_plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>$label</string>
  <key>ProgramArguments</key>
  <array>
    <string>$daemon_script</string>
    <string>$site_name</string>
  </array>
  <key>EnvironmentVariables</key>
  <dict>
    <key>WIZARDRY_DIR</key>
    <string>$wizardry_dir</string>
    <key>WIZARDRY_SITES_DIR</key>
    <string>$SITES_DIR</string>
    <key>PATH</key>
    <string>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
  </dict>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
  <key>UserName</key>
  <string>$site_user</string>
  <key>StandardOutPath</key>
  <string>$SITE_DIR/nginx/daemon.log</string>
  <key>StandardErrorPath</key>
  <string>$SITE_DIR/nginx/daemon-error.log</string>
</dict>
</plist>
EOF

  run_priv cp "$temp_plist" "$plist_file"
  run_priv chmod 644 "$plist_file"
  rm -f "$temp_plist"

  success "Daemon repaired for $site_name (launchd)"
}

if has systemctl; then
  systemd_install
  exit 0
fi

if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  launchd_install
  exit 0
fi

die "repair-site-daemon: systemd or launchd is required"
