#!/bin/sh

# Enable the site daemon to start on boot.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: enable-site-daemon SITENAME

Enables the systemd/launchd daemon to start on boot for a site.

Example: enable-site-daemon mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "enable-site-daemon: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "enable-site-daemon: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "enable-site-daemon: root or sudo is required"
}

unit="wizardry-site-${site_name}.service"
plist="/Library/LaunchDaemons/org.wizardry.web.${site_name}.plist"

if has systemctl; then
  # Check if daemon configuration exists
  daemon_artifact="${SERVICE_DIR:-/etc/systemd/system}/$unit"
  if [ ! -f "$daemon_artifact" ]; then
    die "enable-site-daemon: daemon not configured - run 'repair-site-daemon $site_name' first"
  fi
  
  run_priv systemctl enable "$unit"
  success "Daemon enabled on startup for $site_name"
  exit 0
fi

if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  if [ ! -f "$plist" ]; then
    die "enable-site-daemon: daemon not configured - run 'repair-site-daemon $site_name' first"
  fi
  
  # Load with -w to enable on boot
  run_priv launchctl load -w "$plist"
  success "Daemon enabled on startup for $site_name"
  exit 0
fi

die "enable-site-daemon: systemd or launchd is required"
