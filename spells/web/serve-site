#!/bin/sh

# Start serving a wizardry web site with nginx.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: serve-site SITENAME

Starts nginx to serve a website. Generates nginx configuration if needed.

Example: web-serve-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "serve-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "serve-site: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "serve-site: root or sudo is required"
}

# Check if nginx is installed
if ! has nginx; then
  die "serve-site: nginx is not installed"
fi

# Check if nginx.conf exists - if not, run configure-nginx
if [ ! -f "$SITE_DIR/nginx/nginx.conf" ]; then
  step "Generating nginx configuration..."
  configure-nginx "$site_name"
fi

# Check if site is already running
if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
  pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    warn "serve-site: $site_name is already running (PID $pid)"
    # Read port and show URL
    port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
    domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")
    info "URL: http://$domain:$port"
    info "Stop with: web-stop-site $site_name"
    exit 0
  fi
  # Stale PID file - remove it
  rm -f "$SITE_DIR/nginx/nginx.pid"
  rm -f "$SITE_DIR/nginx/daemon.pid"
fi

# Start nginx directly without systemd/launchd (no sudo needed!)
step "Starting nginx for $site_name..."

# Run in background using run-site-daemon
nohup run-site-daemon "$site_name" >/dev/null 2>&1 &
daemon_pid=$!

# Save daemon PID so stop-site can kill it properly
printf '%s\n' "$daemon_pid" > "$SITE_DIR/nginx/daemon.pid"

# Read port from config
port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")

is_serving=0
for _ in 1 2 3 4 5; do
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
      break
    fi
  fi
  sleep 1
done

if [ "$is_serving" -eq 1 ]; then
  success "Site '$site_name' is now serving"
  info "URL: http://$domain:$port"
  info "Stop with: web-stop-site $site_name"
else
  # Show error logs to help diagnose the failure
  warn "serve-site: daemon for '$site_name' failed to start"
  
  # Check nginx error log
  if [ -f "$SITE_DIR/nginx/error.log" ] && [ -s "$SITE_DIR/nginx/error.log" ]; then
    warn "Nginx error log (last 20 lines):"
    tail -20 "$SITE_DIR/nginx/error.log" >&2
  fi
  
  # Check startup log from run-site-daemon
  if [ -f "$SITE_DIR/nginx/startup.log" ] && [ -s "$SITE_DIR/nginx/startup.log" ]; then
    warn "Nginx startup errors:"
    cat "$SITE_DIR/nginx/startup.log" >&2
  fi
  
  die "serve-site: check the error output above for details"
fi
