#!/bin/sh

# Start serving a wizardry web site with nginx.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: serve-site SITENAME

Starts nginx to serve a website. Generates nginx configuration if needed.

Example: web-serve-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "serve-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "serve-site: site '$site_name' not found"
fi

run_as_site_user() {
  if [ -n "${site_user-}" ] && [ "$(id -un)" = "$site_user" ]; then
    "$@"
    return
  fi

  if [ -z "${site_user-}" ]; then
    "$@"
    return
  fi

  if has sudo; then
    sudo -u "$site_user" -- "$@"
    return
  fi

  die "serve-site: root or sudo is required to run as $site_user"
}

# Check if nginx is installed
if ! has nginx; then
  die "serve-site: nginx is not installed"
fi

# Ensure per-site permissions and user exist before running services
fix-site-security "$site_name"

site_user_default="ww_$(printf '%s' "$site_name" | tr 'A-Z' 'a-z' | tr '-' '_')"
site_user=$(config-get "$SITE_DIR/site.conf" site-user 2>/dev/null || printf '')
[ -z "$site_user" ] && site_user="$site_user_default"

# Build site if not built
if [ ! -f "$SITE_DIR/build/pages/index.html" ]; then
  step "Building site before serving..."
  run_as_site_user build "$site_name"
fi

# Generate nginx config if not exists
if [ ! -f "$SITE_DIR/nginx/nginx.conf" ]; then
  step "Generating nginx configuration..."
  run_as_site_user configure-nginx "$site_name"
fi

# Check if already running
if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
  pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
  if [ -n "$pid" ] && run_as_site_user kill -0 "$pid" 2>/dev/null; then
    warn "serve-site: nginx already running for $site_name (pid: $pid)"
    exit 0
  fi
fi

# Start fcgiwrap if available (for CGI support)
if has fcgiwrap; then
  FCGI_SOCK="$SITE_DIR/nginx/fcgiwrap.sock"
  if [ ! -S "$FCGI_SOCK" ]; then
    # Number of fcgiwrap workers (for concurrent SSE connections)
    # Default: 10 workers = 10 concurrent long-lived connections
    FCGIWRAP_WORKERS="${FCGIWRAP_WORKERS:-10}"
    
    # Ensure WIZARDRY_DIR is set for CGI scripts
    if [ -z "${WIZARDRY_DIR-}" ]; then
      WIZARDRY_DIR="${HOME}/.wizardry"
    fi
    
    # Build PATH with wizardry spell directories
    # This ensures CGI scripts can call other wizardry commands
    FCGI_PATH="$PATH"
    if [ -d "$WIZARDRY_DIR/spells" ]; then
      for dir in "$WIZARDRY_DIR/spells"/* "$WIZARDRY_DIR/spells"/.*; do
        [ -d "$dir" ] || continue
        case "$dir" in */.|*/..) continue ;; esac
        FCGI_PATH="$dir:$FCGI_PATH"
      done
    fi
    
    # Export environment vars that CGI scripts need
    export WIZARDRY_DIR
    export WIZARDRY_SITES_DIR="$SITES_DIR"
    export WIZARDRY_SITE_NAME="$site_name"
    
    step "Starting fcgiwrap with $FCGIWRAP_WORKERS workers..."
    info "chat-stream now uses polling (0.5s) for real-time delivery"
    
    # Start fcgiwrap with wizardry-enabled PATH
    fcgi_pid=$(run_as_site_user sh -c "env PATH=\"$FCGI_PATH\" WIZARDRY_DIR=\"$WIZARDRY_DIR\" WIZARDRY_SITES_DIR=\"$SITES_DIR\" WIZARDRY_SITE_NAME=\"$site_name\" fcgiwrap -c \"$FCGIWRAP_WORKERS\" -s \"unix:$FCGI_SOCK\" >/dev/null 2>&1 & echo \$!")
    printf '%s\n' "$fcgi_pid" > "$SITE_DIR/nginx/fcgiwrap.pid"
    sleep 1
  fi
fi

# Start nginx
step "Starting nginx for $site_name..."
nginx_pid=$(run_as_site_user sh -c "nginx -p \"$SITE_DIR\" -e \"$SITE_DIR/nginx/error.log\" -c \"$SITE_DIR/nginx/nginx.conf\" >/dev/null 2>&1 & echo \$!")

# Give nginx a moment to start
sleep 1

# Check if nginx started successfully
if ! run_as_site_user kill -0 "$nginx_pid" 2>/dev/null; then
  die "serve-site: nginx failed to start"
fi

# Read port from config
port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")

success "Site '$site_name' is now serving"
info "URL: http://$domain:$port"
info "PID: $nginx_pid"
info "Stop with: web-stop-site $site_name"
