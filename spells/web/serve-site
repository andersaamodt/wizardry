#!/bin/sh

# Start serving a wizardry web site with nginx.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: serve-site SITENAME

Starts nginx to serve a website. Generates nginx configuration if needed.

Example: web-serve-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "serve-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "serve-site: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "serve-site: root or sudo is required"
}

# Check if nginx is installed
if ! has nginx; then
  die "serve-site: nginx is not installed"
fi

# Check if nginx.conf exists - if not, run configure-nginx
if [ ! -f "$SITE_DIR/nginx/nginx.conf" ]; then
  step "Generating nginx configuration..."
  configure-nginx "$site_name"
fi

# Check if site is already running
if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
  pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    warn "serve-site: $site_name is already running (PID $pid)"
    # Read port and show URL
    port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
    domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")
    info "URL: http://$domain:$port"
    info "Stop with: web-stop-site $site_name"
    exit 0
  fi
  # Stale PID file - remove it
  rm -f "$SITE_DIR/nginx/nginx.pid"
fi

# Check if daemon configuration exists
if has systemctl; then
  unit="wizardry-site-${site_name}.service"
  daemon_artifact="${SERVICE_DIR:-/etc/systemd/system}/$unit"
elif [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  daemon_artifact="/Library/LaunchDaemons/org.wizardry.web.${site_name}.plist"
else
  die "serve-site: systemd or launchd is required"
fi

if [ ! -f "$daemon_artifact" ]; then
  die "serve-site: daemon not configured - run 'repair-site-daemon $site_name' first"
fi

# Start the daemon
step "Starting daemon for $site_name..."

if has systemctl; then
  # Check if service is already active
  if systemctl is-active --quiet "$unit" 2>/dev/null; then
    info "Site '$site_name' is already running"
  else
    run_priv systemctl start "$unit"
  fi
elif [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  # Check if service is already loaded
  label="org.wizardry.web.${site_name}"
  if launchctl list | grep -q "$label" 2>/dev/null; then
    info "Site '$site_name' is already running"
  else
    # Load without -w (don't enable on boot, just start now)
    # Capture any errors from launchctl
    load_output=$(run_priv launchctl load "$daemon_artifact" 2>&1) || load_failed=$?
    if [ "${load_failed:-0}" -ne 0 ]; then
      warn "serve-site: launchctl load failed"
      warn "Error: $load_output"
      die "serve-site: try running 'repair-site-daemon $site_name' to fix configuration"
    fi
  fi
fi

# Read port from config
port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")

is_serving=0
for _ in 1 2 3 4 5; do
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
      break
    fi
  fi
  sleep 1
done

if [ "$is_serving" -eq 1 ]; then
  success "Site '$site_name' is now serving"
  info "URL: http://$domain:$port"
  info "Stop with: web-stop-site $site_name"
else
  # Show error logs to help diagnose the failure
  warn "serve-site: daemon for '$site_name' failed to start"
  
  # Check nginx error log
  if [ -f "$SITE_DIR/nginx/error.log" ] && [ -s "$SITE_DIR/nginx/error.log" ]; then
    warn "Nginx error log (last 20 lines):"
    tail -20 "$SITE_DIR/nginx/error.log" >&2
  fi
  
  # Check startup log from run-site-daemon
  if [ -f "$SITE_DIR/nginx/startup.log" ] && [ -s "$SITE_DIR/nginx/startup.log" ]; then
    warn "Nginx startup errors:"
    cat "$SITE_DIR/nginx/startup.log" >&2
  fi
  
  die "serve-site: check the error output above for details"
fi
