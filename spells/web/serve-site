#!/bin/sh

# Start serving a wizardry web site with nginx.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: serve-site SITENAME

Starts nginx to serve a website. Generates nginx configuration if needed.

Example: web-serve-site mysite
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "serve-site: SITENAME required"
fi

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "serve-site: site '$site_name' not found"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "serve-site: root or sudo is required"
}

# Check if nginx is installed
if ! has nginx; then
  die "serve-site: nginx is not installed"
fi

repair-site-daemon "$site_name"

unit="wizardry-site-${site_name}.service"
plist="/Library/LaunchDaemons/org.wizardry.web.${site_name}.plist"
label="org.wizardry.web.${site_name}"

if has systemctl; then
  if systemctl is-active --quiet "$unit" 2>/dev/null; then
    warn "serve-site: $site_name daemon already running"
    exit 0
  fi
  step "Starting daemon for $site_name..."
  if ! run_priv systemctl start "$unit"; then
    warn "serve-site: failed to start daemon for $site_name"
  fi
elif [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  if launchctl list "$label" >/dev/null 2>&1; then
    warn "serve-site: $site_name daemon already running"
    exit 0
  fi
  step "Starting daemon for $site_name..."
  if ! run_priv sh -c "launchctl load -w \"$plist\" >/dev/null 2>&1"; then
    warn "serve-site: failed to load launchd plist"
  fi
else
  die "serve-site: systemd or launchd is required"
fi

# Read port from config
port=$(config-get "$SITE_DIR/site.conf" port 2>/dev/null || echo "8080")
domain=$(config-get "$SITE_DIR/site.conf" domain 2>/dev/null || echo "localhost")

is_serving=0
for _ in 1 2 3 4 5; do
  if [ -f "$SITE_DIR/nginx/nginx.pid" ]; then
    pid=$(cat "$SITE_DIR/nginx/nginx.pid" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      is_serving=1
      break
    fi
  fi
  sleep 1
done

if [ "$is_serving" -eq 1 ]; then
  success "Site '$site_name' is now serving"
else
  warn "serve-site: daemon for '$site_name' is not active"
fi
info "URL: http://$domain:$port"
info "Stop with: web-stop-site $site_name"
