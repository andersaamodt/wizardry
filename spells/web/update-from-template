#!/bin/sh

# Update a site by re-copying files from its template.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: update-from-template SITENAME [--force]

Updates a site by re-copying files from its original template.

This will overwrite any customizations made to template files.
Content in site/uploads and site data directories are preserved.

Options:
  --force   Skip confirmation prompt

Examples:
  update-from-template mysite         # Interactive
  update-from-template mysite --force # Non-interactive
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
force_flag=0

if [ -z "$site_name" ]; then
  die 2 "update-from-template: SITENAME required"
fi

# Parse options
shift
while [ $# -gt 0 ]; do
  case "$1" in
    --force) force_flag=1; shift ;;
    *) die 2 "update-from-template: unknown option '$1'" ;;
  esac
done

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

# Check if site exists
if [ ! -d "$SITE_DIR" ]; then
  die "update-from-template: site '$site_name' not found"
fi

# Note: We don't re-exec as site user here - template updates modify source files
# which should be owned by the actual user, not the site user.
# Only build/, nginx/, and .web-libs/ directories are owned by the site user.

# Get template name from site.conf if it exists, otherwise try to detect it
template=""
if [ -f "$SITE_DIR/site.conf" ]; then
  template=$(config-get "$SITE_DIR/site.conf" template 2>/dev/null || echo "")
fi

# If no template found and site.conf doesn't exist, create a basic one
if [ -z "$template" ] && [ ! -f "$SITE_DIR/site.conf" ]; then
  warn "No site.conf found - creating one. Assuming 'demo' template."
  info "You can edit $SITE_DIR/site.conf to change the template."
  template="demo"
  cat > "$SITE_DIR/site.conf" <<EOF
# Site configuration for $site_name
site-name=$site_name
site-user=
template=$template
port=8080
domain=localhost
https=false
EOF
fi

# If template is missing, prompt user to select one
if [ -z "$template" ]; then
  warn "No template specified in site.conf"
  info "Please select a template to use for '$site_name':"
  info ""
  
  # Get WIZARDRY_DIR to find templates
  WIZARDRY_DIR=${WIZARDRY_DIR:-$HOME/.wizardry}
  template_list_dir="$WIZARDRY_DIR/.templates"
  
  # Check if templates exist
  if [ ! -d "$template_list_dir" ] || [ -z "$(ls -A "$template_list_dir" 2>/dev/null)" ]; then
    die "update-from-template: no templates found in $template_list_dir"
  fi
  
  # Show menu to select template
  if ! require menu "Template selection needs the 'menu' command."; then
    die "update-from-template: cannot select template without menu command"
  fi
  
  # Create temp file for template selection
  template_choice_file=$(temp-file template-choice)
  template_choice_file="${template_choice_file?update-from-template: failed to create temp file}"
  cleanup-file "$template_choice_file"
  
  # Build menu arguments - one per template directory
  set -- "Select Template for '$site_name'"
  for template_path in "$template_list_dir"/*; do
    if [ -d "$template_path" ]; then
      tmpl=$(basename "$template_path")
      set -- "$@" "$tmpl%printf '%s' '$tmpl' > '$template_choice_file'"
    fi
  done
  
  # Show menu and capture result
  menu "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  if [ "$menu_status" -ne 0 ]; then
    info "Cancelled"
    exit 0
  fi
  
  # Read selected template from file
  if [ -f "$template_choice_file" ]; then
    template=$(cat "$template_choice_file" 2>/dev/null || echo "")
  fi
  
  if [ -z "$template" ]; then
    die "update-from-template: no template selected"
  fi
  
  info "Selected template: $template"
  
  # Update site.conf with selected template
  if [ -f "$SITE_DIR/site.conf" ]; then
    config-set "$SITE_DIR/site.conf" template "$template"
  else
    # Create site.conf if it doesn't exist
    cat > "$SITE_DIR/site.conf" <<EOF
# Site configuration for $site_name
site-name=$site_name
site-user=
template=$template
port=8080
domain=localhost
https=false
EOF
  fi
  
  success "Template '$template' saved to site.conf"
fi

# Get WIZARDRY_DIR to find templates
WIZARDRY_DIR=${WIZARDRY_DIR:-$HOME/.wizardry}
template_dir="$WIZARDRY_DIR/.templates/$template"

if [ ! -d "$template_dir" ]; then
  die "update-from-template: template '$template' not found at $template_dir"
fi

# Ask for confirmation unless --force
if [ "$force_flag" -eq 0 ]; then
  warn "This will overwrite customizations to template files in '$site_name'"
  info "Template: $template"
  info "Site directory: $SITE_DIR"
  info ""
  info "Content in site/uploads and site data will be preserved."
  printf 'Continue? [y/N] '
  read -r response
  case "$response" in
    [yY]|[yY][eE][sS])
      # Continue
      ;;
    *)
      info "Cancelled"
      exit 0
      ;;
  esac
fi

step "Updating site '$site_name' from template '$template'..."

# Backup site.conf temporarily
temp_conf=$(temp-file site-conf)
cp "$SITE_DIR/site.conf" "$temp_conf"

# Remove old template files (but preserve uploads and build)
info "Removing old template files..."
if [ -d "$SITE_DIR/site/pages" ]; then
  rm -rf "$SITE_DIR/site/pages"
fi
if [ -d "$SITE_DIR/site/static" ]; then
  rm -rf "$SITE_DIR/site/static"
fi
if [ -d "$SITE_DIR/site/includes" ]; then
  rm -rf "$SITE_DIR/site/includes"
fi
if [ -d "$SITE_DIR/cgi" ]; then
  rm -rf "$SITE_DIR/cgi"
fi
# Remove README if it exists (comes from template)
if [ -f "$SITE_DIR/README.md" ]; then
  rm -f "$SITE_DIR/README.md"
fi

# Copy fresh template files
info "Copying template files..."
mkdir -p "$SITE_DIR/site"

if [ -d "$template_dir/pages" ]; then
  cp -r "$template_dir/pages" "$SITE_DIR/site/"
fi

if [ -d "$template_dir/static" ]; then
  cp -r "$template_dir/static" "$SITE_DIR/site/"
fi

if [ -d "$template_dir/includes" ]; then
  cp -r "$template_dir/includes" "$SITE_DIR/site/"
fi

if [ -d "$template_dir/cgi" ]; then
  cp -r "$template_dir/cgi" "$SITE_DIR/"
fi

if [ -f "$template_dir/README.md" ]; then
  cp "$template_dir/README.md" "$SITE_DIR/"
fi

# Restore site.conf
cp "$temp_conf" "$SITE_DIR/site.conf"
rm -f "$temp_conf"

# Ensure uploads directory exists
mkdir -p "$SITE_DIR/site/uploads"

success "Site '$site_name' updated from template '$template'"
info ""
info "Next steps:"
info "  1. Review changes: cd $SITE_DIR/site"
info "  2. Rebuild: build $site_name --full"
