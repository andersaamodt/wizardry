#!/bin/sh

# Configure nginx for a wizardry web site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: configure-nginx SITENAME [OPTIONS]

Generates nginx configuration for a website.

Options:
  --port PORT       Port number (default: 8080)
  --domain DOMAIN   Domain name (default: localhost)
  --https           Enable HTTPS with Let's Encrypt

Examples:
  web-configure-nginx mysite
  web-configure-nginx mysite --port 80 --domain example.com --https
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "configure-nginx: SITENAME required"
fi
shift

# Parse options
port=8080
domain=localhost
use_https=false

while [ $# -gt 0 ]; do
  case "$1" in
    --port)
      port=${2-}
      if [ -z "$port" ]; then
        die 2 "configure-nginx: --port requires value"
      fi
      shift 2
      ;;
    --domain)
      domain=${2-}
      if [ -z "$domain" ]; then
        die 2 "configure-nginx: --domain requires value"
      fi
      shift 2
      ;;
    --https)
      use_https=true
      shift
      ;;
    *)
      die 2 "configure-nginx: unknown option '$1'"
      ;;
  esac
done

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "configure-nginx: site '$site_name' not found"
fi

# Create nginx config directory
NGINX_CONF_DIR="$SITE_DIR/nginx"
mkdir -p "$NGINX_CONF_DIR"

# Create nginx temp directories (to avoid permission issues with system paths)
mkdir -p "$NGINX_CONF_DIR/temp/client_body"
mkdir -p "$NGINX_CONF_DIR/temp/proxy"
mkdir -p "$NGINX_CONF_DIR/temp/fastcgi"
mkdir -p "$NGINX_CONF_DIR/temp/uwsgi"
mkdir -p "$NGINX_CONF_DIR/temp/scgi"

# Path to CGI scripts
WIZARDRY_DIR=${WIZARDRY_DIR:-$HOME/.wizardry}
CGI_DIR="$WIZARDRY_DIR/spells/.imps/cgi"

# Copy mime.types to local directory if not exists
MIME_TYPES="$NGINX_CONF_DIR/mime.types"
if [ ! -f "$MIME_TYPES" ]; then
  if [ -f /etc/nginx/mime.types ]; then
    cp /etc/nginx/mime.types "$MIME_TYPES"
  else
    # Create minimal mime.types if system one doesn't exist
    cat > "$MIME_TYPES" <<'MIMETYPES'
types {
    text/html                                        html htm shtml;
    text/css                                         css;
    text/xml                                         xml;
    image/gif                                        gif;
    image/jpeg                                       jpeg jpg;
    application/javascript                           js;
    application/json                                 json;
    text/plain                                       txt;
    image/png                                        png;
    image/svg+xml                                    svg svgz;
    image/webp                                       webp;
    application/pdf                                  pdf;
    application/zip                                  zip;
}
MIMETYPES
  fi
fi

# Generate nginx configuration
NGINX_CONF="$NGINX_CONF_DIR/nginx.conf"

step "Generating nginx configuration for $site_name"

cat > "$NGINX_CONF" <<EOF
# nginx configuration for $site_name
# Generated by web-wizardry
# Config version: 2

worker_processes 1;
daemon off;
error_log $SITE_DIR/nginx/error.log warn;
pid $SITE_DIR/nginx/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include $NGINX_CONF_DIR/mime.types;
    default_type application/octet-stream;
    
    # Use local temp directories instead of system paths
    client_body_temp_path $NGINX_CONF_DIR/temp/client_body;
    proxy_temp_path $NGINX_CONF_DIR/temp/proxy;
    fastcgi_temp_path $NGINX_CONF_DIR/temp/fastcgi;
    uwsgi_temp_path $NGINX_CONF_DIR/temp/uwsgi;
    scgi_temp_path $NGINX_CONF_DIR/temp/scgi;
    
    access_log $SITE_DIR/nginx/access.log;
    
    sendfile on;
    keepalive_timeout 65;
    
    # Allow larger file uploads (25MB)
    client_max_body_size 25M;
    
    server {
        listen $port;
        server_name $domain;
        
        root $SITE_DIR/build;
        
        # Disable directory listing
        autoindex off;
        
        # Root path - serve main index page
        location = / {
            try_files /pages/index.html =404;
        }
        
        # Serve pages
        location /pages/ {
            index index.html;
            try_files \$uri \$uri.html \$uri/index.html =404;
        }
        
        # Serve static files
        location /static/ {
            alias $SITE_DIR/build/static/;
        }
        
        # Serve uploaded files (from site data directory)
        location /uploads/ {
            alias $SITES_DIR/.sitedata/$site_name/uploads/;
        }
        
        # CGI execution (only from spells/.imps/cgi/)
        location ~ ^/cgi/(.+)$ {
            # Only allow execution of scripts in the CGI directory
            root $CGI_DIR;
            
            # FastCGI configuration
            fastcgi_pass unix:$SITE_DIR/nginx/fcgiwrap.sock;
            fastcgi_param SCRIPT_FILENAME $CGI_DIR/\$1;
            fastcgi_param QUERY_STRING \$query_string;
            fastcgi_param REQUEST_METHOD \$request_method;
            fastcgi_param CONTENT_TYPE \$content_type;
            fastcgi_param CONTENT_LENGTH \$content_length;
            fastcgi_param GATEWAY_INTERFACE CGI/1.1;
            fastcgi_param SERVER_SOFTWARE nginx;
            fastcgi_param REMOTE_ADDR \$remote_addr;
            fastcgi_param REMOTE_PORT \$remote_port;
            fastcgi_param SERVER_ADDR \$server_addr;
            fastcgi_param SERVER_PORT \$server_port;
            fastcgi_param SERVER_NAME \$server_name;
            fastcgi_param SERVER_PROTOCOL \$server_protocol;
            fastcgi_param WIZARDRY_SITE_NAME $site_name;
            fastcgi_param WIZARDRY_DIR $WIZARDRY_DIR;
            fastcgi_param PATH $WIZARDRY_DIR/spells/.imps/cgi:$WIZARDRY_DIR/spells/.imps/out:$WIZARDRY_DIR/spells/.imps/fs:$WIZARDRY_DIR/spells/.imps/data:$WIZARDRY_DIR/spells/.imps/sys:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin;
        }
    }
}
EOF

# Update site config
config-set "$SITE_DIR/site.conf" port "$port"
config-set "$SITE_DIR/site.conf" domain "$domain"
config-set "$SITE_DIR/site.conf" https "$use_https"

success "nginx configuration written to $NGINX_CONF"
info "Port: $port"
info "Domain: $domain"

if [ "$use_https" = "true" ]; then
  info "HTTPS: enabled (requires Let's Encrypt setup)"
else
  info "HTTPS: disabled"
fi
