#!/bin/sh

# Configure nginx for a wizardry web site.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: configure-nginx SITENAME [OPTIONS]

Generates nginx configuration for a website.

Options:
  --port PORT       Port number (default: 8080)
  --domain DOMAIN   Domain name (default: localhost)
  --https           Enable HTTPS with Let's Encrypt

Examples:
  web-configure-nginx mysite
  web-configure-nginx mysite --port 80 --domain example.com --https
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

site_name=${1-}
if [ -z "$site_name" ]; then
  die 2 "configure-nginx: SITENAME required"
fi
shift

# Parse options
port=8080
domain=localhost
use_https=false

while [ $# -gt 0 ]; do
  case "$1" in
    --port)
      port=${2-}
      if [ -z "$port" ]; then
        die 2 "configure-nginx: --port requires value"
      fi
      shift 2
      ;;
    --domain)
      domain=${2-}
      if [ -z "$domain" ]; then
        die 2 "configure-nginx: --domain requires value"
      fi
      shift 2
      ;;
    --https)
      use_https=true
      shift
      ;;
    *)
      die 2 "configure-nginx: unknown option '$1'"
      ;;
  esac
done

WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
SITES_DIR="$WEB_ROOT"
SITE_DIR="$SITES_DIR/$site_name"

if [ ! -d "$SITE_DIR" ]; then
  die "configure-nginx: site '$site_name' not found"
fi

# Create nginx config directory
NGINX_CONF_DIR="$SITE_DIR/nginx"
mkdir -p "$NGINX_CONF_DIR"

# Path to CGI scripts
WIZARDRY_DIR=${WIZARDRY_DIR:-$HOME/.wizardry}
CGI_DIR="$WIZARDRY_DIR/spells/.imps/cgi"

# Generate nginx configuration
NGINX_CONF="$NGINX_CONF_DIR/nginx.conf"

step "Generating nginx configuration for $site_name"

cat > "$NGINX_CONF" <<EOF
# nginx configuration for $site_name
# Generated by web-wizardry

worker_processes 1;
daemon off;
error_log $SITE_DIR/nginx/error.log warn;
pid $SITE_DIR/nginx/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log $SITE_DIR/nginx/access.log;
    
    sendfile on;
    keepalive_timeout 65;
    
    server {
        listen $port;
        server_name $domain;
        
        root $SITE_DIR/build;
        
        # Serve index.html for directory requests
        location / {
            try_files \$uri \$uri/ /pages/index.html;
        }
        
        # Serve pages
        location /pages/ {
            try_files \$uri \$uri.html =404;
        }
        
        # Serve static files
        location /static/ {
            alias $SITE_DIR/build/static/;
        }
        
        # Serve uploaded files
        location /uploads/ {
            alias $SITE_DIR/site/uploads/;
        }
        
        # CGI execution (only from spells/.imps/cgi/)
        location ~ ^/cgi/(.+)$ {
            # Only allow execution of scripts in the CGI directory
            root $CGI_DIR;
            
            # FastCGI configuration
            fastcgi_pass unix:$SITE_DIR/nginx/fcgiwrap.sock;
            fastcgi_param SCRIPT_FILENAME $CGI_DIR/\$1;
            fastcgi_param QUERY_STRING \$query_string;
            fastcgi_param REQUEST_METHOD \$request_method;
            fastcgi_param CONTENT_TYPE \$content_type;
            fastcgi_param CONTENT_LENGTH \$content_length;
            fastcgi_param GATEWAY_INTERFACE CGI/1.1;
            fastcgi_param SERVER_SOFTWARE nginx;
            fastcgi_param REMOTE_ADDR \$remote_addr;
            fastcgi_param REMOTE_PORT \$remote_port;
            fastcgi_param SERVER_ADDR \$server_addr;
            fastcgi_param SERVER_PORT \$server_port;
            fastcgi_param SERVER_NAME \$server_name;
            fastcgi_param SERVER_PROTOCOL \$server_protocol;
        }
    }
}
EOF

# Update site config
config-set "$SITE_DIR/site.conf" port "$port"
config-set "$SITE_DIR/site.conf" domain "$domain"
config-set "$SITE_DIR/site.conf" https "$use_https"

success "nginx configuration written to $NGINX_CONF"
info "Port: $port"
info "Domain: $domain"

if [ "$use_https" = "true" ]; then
  info "HTTPS: enabled (requires Let's Encrypt setup)"
else
  info "HTTPS: disabled"
fi
