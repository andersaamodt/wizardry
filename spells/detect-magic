#!/bin/sh

# This spell surveys the current directory for enchanted files via read-magic.
# It tallies each file's attributes and narrates the ambience with gentle colour.

# The flow stays linear: discover the helper, choose colour, scan the room, then
# summarize the ambience so new spellwrights can follow along.

show_usage() {
        cat <<'USAGE'
Usage: detect-magic

Scan the current directory for files with extended attributes using the
read-magic spell, tally how many enchantments each file holds, and print a
whimsical summary of the ambient magic.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd -P)

# Let tests or callers override the helper path; otherwise look beside this
# script first, then in PATH so the spell still works when installed globally.
# This keeps installation optional while preserving predictability.
READ_MAGIC=${DETECT_MAGIC_READ_MAGIC-}
if [ -z "$READ_MAGIC" ]; then
        if [ -x "$SCRIPT_DIR/read-magic" ]; then
                READ_MAGIC="$SCRIPT_DIR/read-magic"
        elif command -v read-magic >/dev/null 2>&1; then
                READ_MAGIC=$(command -v read-magic)
        else
                printf '%s\n' "detect-magic: read-magic spell is missing." >&2
                exit 1
        fi
fi

# Disable colour on plain terminals so the narration stays legible. The
# keyword helpers collapse to plain words when colour disappears so the rest of
# the spell can sprinkle colour without conditional branches.
# We avoid external tput/printf colour helpers to stay POSIX-clean.
if [ "${NO_COLOR-}" = "1" ] || [ "${NO_COLOR-}" = "true" ] || [ "${TERM:-}" = "dumb" ]; then
        blue=""
        purple=""
        reset=""
else
        blue="\033[36m"
        purple='\033[0;35m'
        reset='\033[0m'
fi
magic_word="${purple}magic${reset}"
enchanted_word="${purple}enchanted${reset}"
enchantments_word="${purple}enchantments${reset}"

total=0
found_any=0

# Open with a header so seers know which column holds names and which counts.
printf "%s%-30s %s%s%s\n" "$blue" "File" "$purple" "$enchantments_word" "$reset"

for entry in *; do
        # Skip globs that did not match files and ignore directories.
        [ -e "$entry" ] || continue
        [ -f "$entry" ] || continue

        # read-magic reports every incantation decorating the file. We quietly
        # ignore unreadable files so the rest of the room still reports.
        if attrs_output=$("$READ_MAGIC" "$entry" 2>&1); then
                :
        else
                printf '%s\n' "detect-magic: failed to read $entry: $attrs_output" >&2
                continue
        fi

        set +e
        clean_attrs=$(printf '%s\n' "$attrs_output" | awk '
                $0 == "" {next}
                $0 == "No enchanted attributes found." {next}
                index($0, ":") == 0 {bad=1; next}
                {print}
                END { if (bad) exit 97 }
        ')
        filter_status=$?
        set -e

        if [ "$filter_status" -eq 97 ]; then
                printf '%s\n' "detect-magic: ignoring malformed output from $entry" >&2
                continue
        elif [ "$filter_status" -ne 0 ]; then
                printf '%s\n' "detect-magic: failed to parse output from $entry" >&2
                continue
        fi

        # Count only non-blank lines so empty outputs do not skew totals.
        count=$(printf '%s\n' "$clean_attrs" | awk 'NF{c++} END{print c+0}')
        if [ "$count" -eq 0 ]; then
                continue
        fi

        printf '%-40s %s%d%s\n' "$entry" "$purple" "$count" "$reset"
        total=$((total + count))
        found_any=1

done

if [ "$found_any" -eq 1 ]; then
        # Rotate through themed whispers based on how many charms fill the room.
        message_pool=''
        if [ "$total" -gt 120 ]; then
                message_pool=$(cat <<'LINES'
Whoa, this room is seriously __ENCHANTED__!
I can feel the __MAGIC__ emanating from these files!
This room is practically pulsating with __MAGIC__!
I've never sensed this much __MAGIC__ in one place before!
The amount of __MAGIC__ in this room is off the charts!
These files are practically glowing with __MAGIC__!
I can hardly contain all this __MAGIC__!
LINES
)
        elif [ "$total" -gt 50 ]; then
                message_pool=$(cat <<'LINES'
I can feel the __MAGIC__ in the air.
There seems to be quite a bit of __MAGIC__ in this room.
This room is positively brimming with __MAGIC__.
These files are infused with __MAGIC__.
The __MAGIC__ in this room is palpable.
The __MAGIC__ in these files is almost tangible.
This room is filled with __MAGIC__.
LINES
)
        elif [ "$total" -gt 15 ]; then
                message_pool=$(cat <<'LINES'
I sense a bit of __MAGIC__ in this room.
There seems to be a hint of __MAGIC__ in these files.
I can feel a faint aura of __MAGIC__ in this room.
These files have a touch of __MAGIC__.
I detect a faint trace of __MAGIC__ in this room.
There is a subtle essence of __MAGIC__ in these files.
This room has a faint glimmer of __MAGIC__.
LINES
)
        fi

        if [ -n "$message_pool" ]; then
                lines=$(printf '%s\n' "$message_pool" | wc -l | tr -d ' ')
                line_to_print=$((total % lines + 1))
                printf '%s\n' "$message_pool" | awk -v line="$line_to_print" -v mark="$magic_word" -v glow="$enchanted_word" \
                        'NR==line { gsub("__MAGIC__", mark); gsub("__ENCHANTED__", glow); print; exit }'
        fi
        printf 'I can feel the %smagic%s in the air.\n' "$purple" "$reset"
else
        printf 'No enchantments reveal themselves today.\n'
fi

printf '%s' "$reset"
