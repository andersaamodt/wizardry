#!/bin/sh
# pluralize WORD COUNT [PLURAL] - pluralize WORD based on COUNT.
# If PLURAL is provided, it is used when COUNT != 1.
# Otherwise, applies English pluralization rules with common irregulars.
# Example: pluralize "spell" 1  # -> spell
# Example: pluralize "spell" 2  # -> spells
set -eu

  if [ "$#" -lt 2 ]; then
    printf '%s\n' "pluralize: WORD COUNT [PLURAL]" >&2
    exit 2
  fi

  pluralize_word=$1
  pluralize_count=$2
  pluralize_plural=${3-}

  if [ "$pluralize_count" -eq 1 ]; then
    printf '%s' "$pluralize_word"
  exit 0
  fi

  if [ -n "$pluralize_plural" ]; then
    printf '%s' "$pluralize_plural"
  exit 0
  fi

  pluralize_lower=$(printf '%s' "$pluralize_word" | tr 'A-Z' 'a-z')
  pluralize_result=""

  case "$pluralize_lower" in
    child) pluralize_result=children ;;
    person) pluralize_result=people ;;
    man) pluralize_result=men ;;
    woman) pluralize_result=women ;;
    mouse) pluralize_result=mice ;;
    goose) pluralize_result=geese ;;
    tooth) pluralize_result=teeth ;;
    foot) pluralize_result=feet ;;
    louse) pluralize_result=lice ;;
    ox) pluralize_result=oxen ;;
    die) pluralize_result=dice ;;
    cactus) pluralize_result=cacti ;;
    focus) pluralize_result=foci ;;
    fungus) pluralize_result=fungi ;;
    nucleus) pluralize_result=nuclei ;;
    syllabus) pluralize_result=syllabi ;;
    analysis) pluralize_result=analyses ;;
    diagnosis) pluralize_result=diagnoses ;;
    synopsis) pluralize_result=synopses ;;
    thesis) pluralize_result=theses ;;
    crisis) pluralize_result=crises ;;
    phenomenon) pluralize_result=phenomena ;;
    criterion) pluralize_result=criteria ;;
    datum) pluralize_result=data ;;
    medium) pluralize_result=media ;;
    bacterium) pluralize_result=bacteria ;;
    curriculum) pluralize_result=curricula ;;
    memorandum) pluralize_result=memoranda ;;
    stadium) pluralize_result=stadia ;;
    addendum) pluralize_result=addenda ;;
    stratum) pluralize_result=strata ;;
    bureau) pluralize_result=bureaux ;;
    index) pluralize_result=indices ;;
    appendix) pluralize_result=appendices ;;
    matrix) pluralize_result=matrices ;;
    vertex) pluralize_result=vertices ;;
    vortex) pluralize_result=vortices ;;
    axis) pluralize_result=axes ;;
    basis) pluralize_result=bases ;;
    oasis) pluralize_result=oases ;;
    radius) pluralize_result=radii ;;
    stimulus) pluralize_result=stimuli ;;
    alumnus) pluralize_result=alumni ;;
    alumna) pluralize_result=alumnae ;;
    vertebra) pluralize_result=vertebrae ;;
    formula) pluralize_result=formulae ;;
    antenna) pluralize_result=antennae ;;
    nebula) pluralize_result=nebulae ;;
    millennium) pluralize_result=millennia ;;
    genus) pluralize_result=genera ;;
    corpus) pluralize_result=corpora ;;
    opus) pluralize_result=opera ;;
    status) pluralize_result=statuses ;;
    bus) pluralize_result=buses ;;
    alias) pluralize_result=aliases ;;
    embargo) pluralize_result=embargoes ;;
    hero) pluralize_result=heroes ;;
    potato) pluralize_result=potatoes ;;
    tomato) pluralize_result=tomatoes ;;
    echo) pluralize_result=echoes ;;
    torpedo) pluralize_result=torpedoes ;;
    veto) pluralize_result=vetoes ;;
    calf) pluralize_result=calves ;;
    leaf) pluralize_result=leaves ;;
    life) pluralize_result=lives ;;
    loaf) pluralize_result=loaves ;;
    self) pluralize_result=selves ;;
    elf) pluralize_result=elves ;;
    shelf) pluralize_result=shelves ;;
    wolf) pluralize_result=wolves ;;
    knife) pluralize_result=knives ;;
    wife) pluralize_result=wives ;;
    thief) pluralize_result=thieves ;;
    scarf) pluralize_result=scarves ;;
    hoof) pluralize_result=hooves ;;
    dwarf) pluralize_result=dwarves ;;
    wharf) pluralize_result=wharves ;;
    fish) pluralize_result=fish ;;
    sheep) pluralize_result=sheep ;;
    deer) pluralize_result=deer ;;
    series) pluralize_result=series ;;
    species) pluralize_result=species ;;
    aircraft) pluralize_result=aircraft ;;
    moose) pluralize_result=moose ;;
    salmon) pluralize_result=salmon ;;
    trout) pluralize_result=trout ;;
    bison) pluralize_result=bison ;;
    means) pluralize_result=means ;;
    news) pluralize_result=news ;;
    police) pluralize_result=police ;;
    cattle) pluralize_result=cattle ;;
    *man)
      pluralize_result=${pluralize_lower%man}men
      ;;
    *mouse)
      pluralize_result=${pluralize_lower%mouse}mice
      ;;
    *goose)
      pluralize_result=${pluralize_lower%goose}geese
      ;;
    *tooth)
      pluralize_result=${pluralize_lower%tooth}teeth
      ;;
    *foot)
      pluralize_result=${pluralize_lower%foot}feet
      ;;
    *louse)
      pluralize_result=${pluralize_lower%louse}lice
      ;;
    *[sxz]|*ch|*sh)
      pluralize_result=${pluralize_lower}es
      ;;
    *[!aeiou]y)
      pluralize_result=${pluralize_lower%y}ies
      ;;
    *fe)
      pluralize_result=${pluralize_lower%fe}ves
      ;;
    *f)
      pluralize_result=${pluralize_lower%f}ves
      ;;
    *[!aeiou]o)
      pluralize_result=${pluralize_lower}es
      ;;
    *us)
      pluralize_result=${pluralize_lower}es
      ;;
    *is)
      pluralize_result=${pluralize_lower%is}es
      ;;
    *)
      pluralize_result=${pluralize_lower}s
      ;;
  esac

  # DEBUG: Show what we're working with
  if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
    printf '[DEBUG] Original word: [%s]\n' "$pluralize_word" >&2
    printf '[DEBUG] Lowercase result: [%s]\n' "$pluralize_result" >&2
  fi

  # Check capitalization using tr (locale-independent)
  # Avoid case patterns with [A-Z] which are locale-dependent on macOS
  pluralize_word_lower=$(printf '%s' "$pluralize_word" | tr 'A-Z' 'a-z')
  pluralize_word_upper=$(printf '%s' "$pluralize_word" | tr 'a-z' 'A-Z')
  
  if [ "$pluralize_word" != "$pluralize_word_lower" ] && \
     [ "$pluralize_word" != "$pluralize_word_upper" ]; then
    # Mixed case (has both upper and lower)
    pluralize_rest=${pluralize_word#?}
    if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
      printf '[DEBUG] Matched mixed case pattern\n' >&2
      printf '[DEBUG] Rest of word: [%s]\n' "$pluralize_rest" >&2
    fi
    
    # Check if rest contains uppercase by comparing with lowercase version
    pluralize_rest_lower=$(printf '%s' "$pluralize_rest" | tr 'A-Z' 'a-z')
    if [ "$pluralize_rest" != "$pluralize_rest_lower" ]; then
      if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
        printf '[DEBUG] Rest has uppercase (verified) - output lowercase\n' >&2
      fi
      printf '%s' "$pluralize_result"
    else
      if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
        printf '[DEBUG] Rest is lowercase - capitalizing first letter\n' >&2
      fi
          
          # Method 1: Pure POSIX parameter expansion
          pluralize_upper=$(printf '%s' "$pluralize_result" | tr 'a-z' 'A-Z')
          pluralize_first=${pluralize_upper%"${pluralize_upper#?}"}
          pluralize_tail=${pluralize_result#?}
          
          if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
            printf '[DEBUG] Method 1 (POSIX expansion):\n' >&2
            printf '[DEBUG]   Upper: [%s]\n' "$pluralize_upper" >&2
            printf '[DEBUG]   First: [%s]\n' "$pluralize_first" >&2
            printf '[DEBUG]   Tail: [%s]\n' "$pluralize_tail" >&2
            printf '[DEBUG]   Result: [%s%s]\n' \
              "$pluralize_first" "$pluralize_tail" >&2
            
            # Try alternative methods for comparison
            test_awk=$(printf '%s' "$pluralize_result" | \
              awk '{print substr($0,1,1)}' 2>/dev/null || printf 'FAILED')
            test_sed=$(printf '%s' "$pluralize_result" | \
              sed 's/^\(.\).*/\1/' 2>/dev/null || printf 'FAILED')
            test_dd=$(printf '%s' "$pluralize_result" | \
              dd bs=1 count=1 2>/dev/null || printf 'FAILED')
            test_cut=$(printf '%s' "$pluralize_result" | \
              cut -c1 2>/dev/null || printf 'FAILED')
            
            printf '[DEBUG] Method 2 (awk): first=[%s]\n' "$test_awk" >&2
            printf '[DEBUG] Method 3 (sed): first=[%s]\n' "$test_sed" >&2
            printf '[DEBUG] Method 4 (dd): first=[%s]\n' "$test_dd" >&2
            printf '[DEBUG] Method 5 (cut): first=[%s]\n' "$test_cut" >&2
          fi
          
          printf '%s%s' "$pluralize_first" "$pluralize_tail"
        fi
  elif [ "$pluralize_word" != "$pluralize_word_lower" ]; then
    # All uppercase
    if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
      printf '[DEBUG] Matched all uppercase pattern\n' >&2
    fi
    printf '%s' "$(printf '%s' "$pluralize_result" | tr 'a-z' 'A-Z')"
  else
    # All lowercase
    if [ "${PLURALIZE_DEBUG:-0}" = "1" ]; then
      printf '[DEBUG] Matched lowercase pattern\n' >&2
    fi
    printf '%s' "$pluralize_result"
  fi
