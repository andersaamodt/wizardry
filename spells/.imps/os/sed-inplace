#!/bin/sh
# sed-inplace PATTERN FILE - perform in-place sed substitution portably (mac/linux)
# Example: sed-inplace 's/foo/bar/g' config.txt


usage() {
        cat <<'USAGE' >&2
Usage: sed-inplace PATTERN FILE

Perform in-place sed substitution portably (mac/linux). Example: sed-inplace 's/foo/bar/g' config.txt.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        usage
        exit 0
        ;;
esac

pattern=${1:-}
file=${2:-}

if [ -z "$pattern" ] || [ -z "$file" ]; then
  printf '%s\n' "sed-inplace: requires PATTERN and FILE arguments" >&2
  exit 1
fi

if [ ! -f "$file" ]; then
  printf '%s\n' "sed-inplace: not a file: $file" >&2
  exit 1
fi

# macOS sed requires -i '' while GNU sed requires -i without argument
# Use a temp file approach for maximum portability
tmpfile="${file}.sed.$$"
if sed "$pattern" "$file" > "$tmpfile" 2>/dev/null; then
  mv "$tmpfile" "$file"
else
  rm -f "$tmpfile"
  exit 1
fi
