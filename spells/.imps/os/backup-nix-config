#!/bin/sh
# backup-nix-config FILE - back up nix config file before editing
# Prints the backup path to stderr for user notification.
# Callers are responsible for calling this only once per operation.
# Example: backup-nix-config /etc/nixos/configuration.nix


usage() {
        cat <<'USAGE' >&2
Usage: backup-nix-config FILE

Back up nix config file before editing Prints the backup path to stderr for user notification. Callers are responsible for calling this only once per operation.. Example: backup-nix-config /etc/nixos/configuration.nix.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        usage
        exit 0
        ;;
esac

set -eu

file=${1:-}

if [ -z "$file" ]; then
  printf '%s\n' "backup-nix-config: file path required" >&2
  exit 1
fi

if [ ! -f "$file" ]; then
  exit 0
fi

timestamp=$(date +%Y%m%d%H%M%S 2>/dev/null || date +%s 2>/dev/null || printf 'pid%s' "$$")
backup="${file}.wizardry.${timestamp}"

# Determine if we need sudo for system-level files
needs_sudo=0
case $file in
/etc/*)
  if [ ! -w "$file" ] && [ ! -w "$(dirname "$file")" ] 2>/dev/null; then
    needs_sudo=1
  fi
  ;;
esac

if [ "$needs_sudo" -eq 1 ]; then
  if command -v sudo >/dev/null 2>&1; then
    sudo cp "$file" "$backup"
  elif command -v doas >/dev/null 2>&1; then
    doas cp "$file" "$backup"
  else
    cp "$file" "$backup"
  fi
else
  cp "$file" "$backup"
fi || {
  printf '%s\n' "backup-nix-config: unable to back up '$file'" >&2
  exit 1
}

printf '%s\n' "Backed up '$file' to '$backup'" >&2
