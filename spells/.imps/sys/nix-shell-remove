#!/bin/sh
# nix-shell-remove NAME FILE - remove shell init block from nix config
# Example: nix-shell-remove myspell home.nix
set -eu


  nsr_block_name=${1:-}
  nsr_nix_file=${2:-}

  if [ -z "$nsr_block_name" ] || [ -z "$nsr_nix_file" ]; then
    printf '%s\n' "nix-shell-remove: NAME and FILE are required" >&2
  exit 1
  fi

  nsr_marker="# wizardry: $nsr_block_name"

  nsr_needs_sudo=0
  if [ -f "$nsr_nix_file" ] && [ ! -w "$nsr_nix_file" ]; then
    nsr_needs_sudo=1
  fi

  if [ ! -f "$nsr_nix_file" ]; then
    printf '%s\n' "nix-shell-remove: file not found: $nsr_nix_file" >&2
  exit 1
  fi
  if ! grep -Fq "$nsr_marker" "$nsr_nix_file" 2>/dev/null; then exit 0; fi
  nsr_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-remove.XXXXXX") || exit 1
  if [ "$nsr_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cat "$nsr_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cat "$nsr_nix_file"
    else cat "$nsr_nix_file"; fi
  else
    cat "$nsr_nix_file"
  fi | grep -v -F "$nsr_marker" > "$nsr_tmp_file"
  if [ "$nsr_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cp "$nsr_tmp_file" "$nsr_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cp "$nsr_tmp_file" "$nsr_nix_file"
    else cp "$nsr_tmp_file" "$nsr_nix_file"; fi
  else
    mv "$nsr_tmp_file" "$nsr_nix_file"
  fi
  rm -f "$nsr_tmp_file"
  exit 0
