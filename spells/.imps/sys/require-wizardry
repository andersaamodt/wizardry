#!/bin/sh
# require-wizardry - check if wizardry is installed, offer to install if not
# Returns 0 if wizardry is installed
# Returns 1 if wizardry is not installed and user declined/failed to install
# In test mode (WIZARDRY_TEST_HELPERS_ONLY=1), always returns 0
set -eu

_require_wizardry() {
  # In test mode, assume wizardry is available (tests set up their own PATH)
  if [ "${WIZARDRY_TEST_HELPERS_ONLY:-}" = "1" ]; then
    return 0
  fi
  
  # Check if wizardry is installed by checking for WIZARDRY_DIR environment variable
  # This is set by invoke-wizardry when sourced in shell startup
  if [ -n "${WIZARDRY_DIR-}" ] && [ -d "${WIZARDRY_DIR}/spells" ]; then
    return 0
  fi
  
  # Fallback: check if invoke-wizardry exists in standard location
  if [ -f "${HOME-}/.wizardry/spells/.imps/sys/invoke-wizardry" ]; then
    return 0
  fi
  
  # Wizardry not found - print error and offer to install
  printf '%s\n' "Error: wizardry is not installed or not in PATH." >&2
  printf '%s\n' "" >&2
  
  # Offer to install wizardry
  if ask-install-wizardry; then
    # Installation succeeded - verify it worked by checking for WIZARDRY_DIR or standard location
    if [ -n "${WIZARDRY_DIR-}" ] && [ -d "${WIZARDRY_DIR}/spells" ]; then
      return 0
    elif [ -f "${HOME-}/.wizardry/spells/.imps/sys/invoke-wizardry" ]; then
      return 0
    else
      printf '%s\n' "Installation completed but wizardry is still not available." >&2
      printf '%s\n' "You may need to restart your shell or run: source ~/.bashrc" >&2
      return 1
    fi
  else
    # User declined or installation failed
    return 1
  fi
}

# Self-execute when run directly (not sourced)
case "$0" in
  */require-wizardry) _require_wizardry "$@" ;; esac

