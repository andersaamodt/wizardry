#!/bin/sh
# nix-shell-init ACTION --name NAME --file FILE [--shell SHELL] - manage shell init in nix configs
# Actions: add (from stdin), remove, status. Manages programs.bash.initExtra blocks.
# Example: echo 'source "/path/to/spell"' | nix-shell-init add --name myspell --file home.nix

_nix_shell_init() {
  _nsi_action=""
  _nsi_shell_type="bash"
  _nsi_block_name=""
  _nsi_nix_file=""

  while [ "$#" -gt 0 ]; do
    case $1 in
      add|remove|status) _nsi_action=$1; shift ;;
      --shell) _nsi_shell_type=$2; shift 2 ;;
      --shell=*) _nsi_shell_type=${1#*=}; shift ;;
      --name) _nsi_block_name=$2; shift 2 ;;
      --name=*) _nsi_block_name=${1#*=}; shift ;;
      --file) _nsi_nix_file=$2; shift 2 ;;
      --file=*) _nsi_nix_file=${1#*=}; shift ;;
      *) printf '%s\n' "nix-shell-init: unknown argument '$1'" >&2; return 1 ;;
    esac
  done

  if [ -z "$_nsi_action" ] || [ -z "$_nsi_block_name" ] || [ -z "$_nsi_nix_file" ]; then
    printf '%s\n' "nix-shell-init: action, --name, and --file are required" >&2
    return 1
  fi

  case $_nsi_shell_type in
    bash|zsh) : ;;
    *) printf '%s\n' "nix-shell-init: shell must be 'bash' or 'zsh'" >&2; return 1 ;;
  esac

  _nsi_is_system_config=0
  case $_nsi_nix_file in /etc/nixos/*) _nsi_is_system_config=1 ;; esac

  if [ "$_nsi_is_system_config" -eq 1 ]; then
    case $_nsi_shell_type in
      bash) _nsi_nix_option="programs.bash.interactiveShellInit" ;;
      zsh)  _nsi_nix_option="programs.zsh.interactiveShellInit" ;;
    esac
  else
    case $_nsi_shell_type in
      bash) _nsi_nix_option="programs.bash.initExtra" ;;
      zsh)  _nsi_nix_option="programs.zsh.initExtra" ;;
    esac
  fi

  _nsi_marker="# wizardry: $_nsi_block_name"

  _nsi_needs_sudo=0
  if [ -f "$_nsi_nix_file" ] && [ ! -w "$_nsi_nix_file" ]; then
    _nsi_needs_sudo=1
  fi

  case $_nsi_action in
    status)
      [ -f "$_nsi_nix_file" ] && grep -Fq "$_nsi_marker" "$_nsi_nix_file" 2>/dev/null
      return $?
      ;;
    remove)
      if [ ! -f "$_nsi_nix_file" ]; then
        printf '%s\n' "nix-shell-init: file not found: $_nsi_nix_file" >&2
        return 1
      fi
      if ! grep -Fq "$_nsi_marker" "$_nsi_nix_file" 2>/dev/null; then return 0; fi
      _nsi_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-init.XXXXXX") || return 1
      if [ "$_nsi_needs_sudo" -eq 1 ]; then
        if command -v sudo >/dev/null 2>&1; then sudo cat "$_nsi_nix_file"
        elif command -v doas >/dev/null 2>&1; then doas cat "$_nsi_nix_file"
        else cat "$_nsi_nix_file"; fi
      else
        cat "$_nsi_nix_file"
      fi | grep -v -F "$_nsi_marker" > "$_nsi_tmp_file"
      if [ "$_nsi_needs_sudo" -eq 1 ]; then
        if command -v sudo >/dev/null 2>&1; then sudo cp "$_nsi_tmp_file" "$_nsi_nix_file"
        elif command -v doas >/dev/null 2>&1; then doas cp "$_nsi_tmp_file" "$_nsi_nix_file"
        else cp "$_nsi_tmp_file" "$_nsi_nix_file"; fi
      else
        mv "$_nsi_tmp_file" "$_nsi_nix_file"
      fi
      rm -f "$_nsi_tmp_file"
      return 0
      ;;
    add)
      if [ -f "$_nsi_nix_file" ] && grep -Fq "$_nsi_marker" "$_nsi_nix_file" 2>/dev/null; then return 0; fi
      _nsi_shell_code=""
      while IFS= read -r _nsi_line || [ -n "$_nsi_line" ]; do
        if [ -z "$_nsi_shell_code" ]; then _nsi_shell_code=$_nsi_line
        else _nsi_shell_code="$_nsi_shell_code
$_nsi_line"; fi
      done
      if [ -z "$_nsi_shell_code" ]; then
        printf '%s\n' "nix-shell-init: no shell code provided on stdin" >&2
        return 1
      fi
      _nsi_escaped_code=$(printf '%s' "$_nsi_shell_code" | sed "s/''/'''/g; s/\\\${/''\${/g")
      _nsi_marked_code=$(printf '%s' "$_nsi_escaped_code" | sed "s/$/ $_nsi_marker/")
      if [ ! -f "$_nsi_nix_file" ]; then
        _nsi_dir=${_nsi_nix_file%/*}
        [ "$_nsi_dir" != "$_nsi_nix_file" ] && [ ! -d "$_nsi_dir" ] && mkdir -p "$_nsi_dir"
        printf '{ config, pkgs, ... }:\n\n{\n}\n' > "$_nsi_nix_file"
      fi
      _nsi_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-init.XXXXXX") || return 1
      # Read file content inline
      if [ "$_nsi_needs_sudo" -eq 1 ]; then
        if command -v sudo >/dev/null 2>&1; then _nsi_content=$(sudo cat "$_nsi_nix_file")
        elif command -v doas >/dev/null 2>&1; then _nsi_content=$(doas cat "$_nsi_nix_file")
        else _nsi_content=$(cat "$_nsi_nix_file"); fi
      else _nsi_content=$(cat "$_nsi_nix_file"); fi
      
      if printf '%s\n' "$_nsi_content" | grep -q "$_nsi_nix_option[[:space:]]*="; then
        _nsi_input_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-init-input.XXXXXX") || return 1
        printf '%s\n' "$_nsi_content" > "$_nsi_input_file"
        _nsi_in_block=0
        while IFS= read -r _nsi_line; do
          if printf '%s\n' "$_nsi_line" | grep -q "$_nsi_nix_option[[:space:]]*=" && printf '%s\n' "$_nsi_line" | grep -q "''"; then
            _nsi_in_block=1; printf '%s\n' "$_nsi_line"; continue
          fi
          if [ "$_nsi_in_block" -eq 1 ] && printf '%s\n' "$_nsi_line" | grep -q "^[[:space:]]*'';"; then
            printf '%s\n' "$_nsi_marked_code"; printf '%s\n' "$_nsi_line"; _nsi_in_block=0; continue
          fi
          printf '%s\n' "$_nsi_line"
        done < "$_nsi_input_file" > "$_nsi_tmp_file"
        rm -f "$_nsi_input_file"
      else
        # Write the block to a temp file and use it with awk (macOS awk compatible)
        _nsi_block_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-init-block.XXXXXX") || return 1
        printf '%s\n' "  $_nsi_nix_option = ''" > "$_nsi_block_file"
        printf '%s\n' "$_nsi_marked_code" >> "$_nsi_block_file"
        printf '%s\n' "  '';" >> "$_nsi_block_file"
        
        printf '%s\n' "$_nsi_content" | awk -v blockfile="$_nsi_block_file" '
        BEGIN { while ((getline line < blockfile) > 0) block = block line "\n" }
        { lines[NR] = $0 }
        END {
          last = NR; while (last > 0 && lines[last] ~ /^[[:space:]]*$/) last--
          if (last > 0 && lines[last] ~ /^[[:space:]]*}/) {
            for (i = 1; i < last; i++) print lines[i]; print ""; printf "%s", block; print lines[last]
            for (i = last + 1; i <= NR; i++) print lines[i]
          } else { for (i = 1; i <= NR; i++) print lines[i]; print ""; printf "%s", block }
        }' > "$_nsi_tmp_file"
        rm -f "$_nsi_block_file"
      fi
      if [ "$_nsi_needs_sudo" -eq 1 ]; then
        if command -v sudo >/dev/null 2>&1; then sudo cp "$_nsi_tmp_file" "$_nsi_nix_file"
        elif command -v doas >/dev/null 2>&1; then doas cp "$_nsi_tmp_file" "$_nsi_nix_file"
        else cp "$_nsi_tmp_file" "$_nsi_nix_file"; fi
      else mv "$_nsi_tmp_file" "$_nsi_nix_file"; fi
      rm -f "$_nsi_tmp_file"
      return 0
      ;;
  esac
}

# Self-execute when run directly (not sourced)
case "$0" in
  */nix-shell-init) _nix_shell_init "$@" ;; esac
