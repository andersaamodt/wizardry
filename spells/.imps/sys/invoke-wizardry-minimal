#!/bin/sh
# invoke-wizardry - set up wizardry environment at shell startup (MINIMAL VERSION)
# Source this script to make spells and imps available.
# Example in .bashrc: . ~/.wizardry/spells/.imps/sys/invoke-wizardry

# SPIRAL DEBUG PHASE 1: Minimal version - only load what's needed for menu

# Ensure baseline PATH before anything else
baseline_path="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
case ":${PATH-}:" in
  *":/usr/bin:"*|*":/bin:"*) ;;
  *)
    PATH="${baseline_path}${PATH:+:}${PATH-}"
    export PATH
    ;;
esac

# Permissive mode - this file is sourced into user's shell
set +eu

# Prevent recursive sourcing
if [ "${_WIZARDRY_INVOKED-}" = "1" ]; then
  return 0
fi
_WIZARDRY_INVOKED=1
export _WIZARDRY_INVOKED

_invoke_wizardry() {
  # Detect WIZARDRY_DIR
  if [ -z "${WIZARDRY_DIR-}" ]; then
    # Capture script path - in bash use BASH_SOURCE, in zsh use $0
    _iw_script_path=""
    if eval '[ -n "${BASH_VERSION-}" ]' 2>/dev/null; then
      _iw_script_path=$(eval 'printf "%s" "${BASH_SOURCE[0]-}"')
    elif [ -n "${ZSH_VERSION-}" ]; then
      _iw_script_path="$0"
    fi
    
    # Fallback to command -v
    if [ -z "$_iw_script_path" ]; then
      _iw_script_path=$(command -v invoke-wizardry 2>/dev/null | head -1) || :
    fi
    
    # Fallback to default location
    if [ -z "$_iw_script_path" ] && [ -n "${HOME-}" ]; then
      _iw_script_path="$HOME/.wizardry/spells/.imps/sys/invoke-wizardry"
    fi
    
    # Derive WIZARDRY_DIR from script path
    if [ -n "$_iw_script_path" ] && [ -f "$_iw_script_path" ]; then
      _iw_script_dir=$(CDPATH= cd -- "$(dirname "$_iw_script_path")" 2>/dev/null && pwd -P) || :
      if [ -n "$_iw_script_dir" ]; then
        WIZARDRY_DIR=$(CDPATH= cd -- "$_iw_script_dir/../../.." 2>/dev/null && pwd -P) || :
      fi
    fi
  fi
  
  # Validate WIZARDRY_DIR
  if [ -z "${WIZARDRY_DIR-}" ] || [ ! -d "${WIZARDRY_DIR-}/spells" ]; then
    printf '%s\n' "invoke-wizardry: ERROR - WIZARDRY_DIR not found" >&2
    return 1
  fi
  
  export WIZARDRY_DIR
  
  # Set up SPELLBOOK_DIR
  : "${SPELLBOOK_DIR:=${HOME-}/.spellbook}"
  export SPELLBOOK_DIR
  
  # Add wizardry directories to PATH
  # This is the simple approach - just add the directories to PATH
  _iw_spells_dir="$WIZARDRY_DIR/spells"
  _iw_imps_path=""
  
  # Build imps PATH from all families
  for _iw_family_dir in "$WIZARDRY_DIR"/spells/.imps/*; do
    [ -d "$_iw_family_dir" ] || continue
    # Skip test family
    case "$(basename "$_iw_family_dir")" in
      test) continue ;;
    esac
    _iw_imps_path="${_iw_imps_path}${_iw_imps_path:+:}${_iw_family_dir}"
  done
  
  # Add all spell categories to PATH
  for _iw_spell_cat in "$WIZARDRY_DIR"/spells/*; do
    [ -d "$_iw_spell_cat" ] || continue
    # Skip hidden directories
    case "$(basename "$_iw_spell_cat")" in
      .*) continue ;;
    esac
    PATH="${_iw_spell_cat}:${PATH}"
  done
  
  # Add imps to PATH
  if [ -n "$_iw_imps_path" ]; then
    PATH="${_iw_imps_path}:${PATH}"
  fi
  
  # Add spellbook to PATH
  if [ -d "$SPELLBOOK_DIR" ]; then
    PATH="${SPELLBOOK_DIR}:${PATH}"
  fi
  
  export PATH
  
  # MINIMAL: No spell/imp pre-loading, no command-not-found handler
  # Just PATH is enough for basic functionality
  
  return 0
}

# Run the setup
_invoke_wizardry
_iw_status=$?
return $_iw_status
