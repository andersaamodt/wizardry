#!/bin/sh
# nix-shell-add NAME FILE [SHELL] - add shell init code to nix config (from stdin)
# Example: echo 'source "/path/to/spell"' | nix-shell-add myspell home.nix
# SHELL defaults to 'bash'; valid values: bash, zsh
set -eu


  nsa_block_name=${1:-}
  nsa_nix_file=${2:-}
  nsa_shell_type=${3:-bash}

  if [ -z "$nsa_block_name" ] || [ -z "$nsa_nix_file" ]; then
    printf '%s\n' "nix-shell-add: NAME and FILE are required" >&2
  exit 1
  fi

  case $nsa_shell_type in
    bash|zsh) : ;;
    *) printf '%s\n' "nix-shell-add: shell must be 'bash' or 'zsh'" >&2; exit 1 ;;
  esac

  nsa_is_system_config=0
  case $nsa_nix_file in /etc/nixos/*) nsa_is_system_config=1 ;; esac

  if [ "$nsa_is_system_config" -eq 1 ]; then
    case $nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.interactiveShellInit" ;;
      zsh)  _nsa_nix_option="programs.zsh.interactiveShellInit" ;;
    esac
  else
    case $nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.initExtra" ;;
      zsh)  _nsa_nix_option="programs.zsh.initExtra" ;;
    esac
  fi

  nsa_marker="# wizardry: $nsa_block_name"

  nsa_needs_sudo=0
  if [ -f "$nsa_nix_file" ] && [ ! -w "$nsa_nix_file" ]; then
    nsa_needs_sudo=1
  fi

  has_marker="no"
  if [ -f "$nsa_nix_file" ] && grep -Fq "$nsa_marker" "$nsa_nix_file" 2>/dev/null; then
    has_marker="yes"
  fi

  if [ "$has_marker" = "yes" ]; then
  exit 0
  fi
  nsa_shell_code=""
  while IFS= read -r _nsa_line || [ -n "$_nsa_line" ]; do
    if [ -z "$nsa_shell_code" ]; then nsa_shell_code=$_nsa_line
    else nsa_shell_code="$nsa_shell_code
$_nsa_line"; fi
  done
  if [ -z "$nsa_shell_code" ]; then
    printf '%s\n' "nix-shell-add: no shell code provided on stdin" >&2
  exit 1
  fi
  nsa_escaped_code=$(printf '%s' "$nsa_shell_code" | sed "s/''/'''/g; s/\\\${/''\${/g")
  nsa_marked_code=$(printf '%s' "$nsa_escaped_code" | sed "s/$/ $nsa_marker/")
  if [ ! -f "$nsa_nix_file" ]; then
    nsa_dir=nsa_nix_file%/*}
    [ "$nsa_dir" != "$nsa_nix_file" ] && [ ! -d "$nsa_dir" ] && mkdir -p "$nsa_dir"
    printf '{ config, pkgs, ... }:\n\n{\n}\n' > "$nsa_nix_file"
  fi
  nsa_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add.XXXXXX") || exit 1
  # Read file content inline
  if [ "$nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then _nsa_content=$(sudo cat "$nsa_nix_file")
    elif command -v doas >/dev/null 2>&1; then _nsa_content=$(doas cat "$nsa_nix_file")
    else _nsa_content=$(cat "$nsa_nix_file"); fi
  else _nsa_content=$(cat "$nsa_nix_file"); fi

  if printf '%s\n' "$_nsa_content" | grep -q "$_nsa_nix_option[[:space:]]*="; then
    nsa_input_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-input.XXXXXX") || exit 1
    printf '%s\n' "$_nsa_content" > "$nsa_input_file"
    nsa_in_block=0
    while IFS= read -r _nsa_line; do
      has_option="no"
      if printf '%s\n' "$_nsa_line" | grep -q "$_nsa_nix_option[[:space:]]*="; then
        has_option="yes"
      fi
    
      has_quote="no"
      if printf '%s\n' "$_nsa_line" | grep -q "''"; then
        has_quote="yes"
      fi
    
      if [ "$has_option" = "yes" ] && [ "$has_quote" = "yes" ]; then
        nsa_in_block=1
        printf '%s\n' "$_nsa_line"
        continue
      fi
      # Check if we're at the end of a packages list block
      nsa_is_end_block=0
      if [ "$nsa_in_block" -eq 1 ]; then
        if printf '%s\n' "$_nsa_line" | grep -q "^[[:space:]]*'';"; then
          nsa_is_end_block=1
        fi
      fi
      if [ "$nsa_is_end_block" -eq 1 ]; then
        printf '%s\n' "$nsa_marked_code"
        printf '%s\n' "$_nsa_line"
        nsa_in_block=0
        continue
      fi
      printf '%s\n' "$_nsa_line"
    done < "$nsa_input_file" > "$nsa_tmp_file"
    rm -f "$nsa_input_file"
  else
    # Write the block to a temp file and use it with awk (macOS awk compatible)
    nsa_block_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-block.XXXXXX") || exit 1
    printf '%s\n' "  $_nsa_nix_option = ''" > "$nsa_block_file"
    printf '%s\n' "$nsa_marked_code" >> "$nsa_block_file"
    printf '%s\n' "  '';" >> "$nsa_block_file"
  
    printf '%s\n' "$_nsa_content" | awk -v blockfile="$nsa_block_file" '
    BEGIN { while ((getline line < blockfile) > 0) block = block line "\n" }
    { lines[NR] = $0 }
    END {
      last = NR; while (last > 0 && lines[last] ~ /^[[:space:]]*$/) last--
      if (last > 0 && lines[last] ~ /^[[:space:]]*}/) {
        for (i = 1; i < last; i++) print lines[i]; print ""; printf "%s", block; print lines[last]
        for (i = last + 1; i <= NR; i++) print lines[i]
      } else { for (i = 1; i <= NR; i++) print lines[i]; print ""; printf "%s", block }
    }' > "$nsa_tmp_file"
    rm -f "$nsa_block_file"
  fi
  if [ "$nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cp "$nsa_tmp_file" "$nsa_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cp "$nsa_tmp_file" "$nsa_nix_file"
    else cp "$nsa_tmp_file" "$nsa_nix_file"; fi
  else mv "$nsa_tmp_file" "$nsa_nix_file"; fi
  rm -f "$nsa_tmp_file"
  exit 0
