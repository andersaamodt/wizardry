#!/bin/sh
# nix-shell-add NAME FILE [SHELL] - add shell init code to nix config (from stdin)
# Example: echo 'source "/path/to/spell"' | nix-shell-add myspell home.nix
# SHELL defaults to 'bash'; valid values: bash, zsh
set -eu

  _nsa_block_name=${1:-}
  _nsa_nix_file=${2:-}
  _nsa_shell_type=${3:-bash}

  if [ -z "$_nsa_block_name" ] || [ -z "$_nsa_nix_file" ]; then
    printf '%s\n' "nix-shell-add: NAME and FILE are required" >&2
    exit 1
  fi

  case $_nsa_shell_type in
    bash|zsh) : ;;
    *) printf '%s\n' "nix-shell-add: shell must be 'bash' or 'zsh'" >&2; exit 1 ;;
  esac

  _nsa_is_system_config=0
  case $_nsa_nix_file in /etc/nixos/*) _nsa_is_system_config=1 ;; esac

  if [ "$_nsa_is_system_config" -eq 1 ]; then
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.interactiveShellInit" ;;
      zsh)  _nsa_nix_option="programs.zsh.interactiveShellInit" ;;
    esac
  else
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.initExtra" ;;
      zsh)  _nsa_nix_option="programs.zsh.initExtra" ;;
    esac
  fi

  _nsa_marker="# wizardry: $_nsa_block_name"

  _nsa_needs_sudo=0
  if [ -f "$_nsa_nix_file" ] && [ ! -w "$_nsa_nix_file" ]; then
    _nsa_needs_sudo=1
  fi

  has_marker="no"
  if [ -f "$_nsa_nix_file" ] && grep -Fq "$_nsa_marker" "$_nsa_nix_file" 2>/dev/null; then
    has_marker="yes"
  fi
  
  if [ "$has_marker" = "yes" ]; then
    exit 0
  fi
  _nsa_shell_code=""
  while IFS= read -r _nsa_line || [ -n "$_nsa_line" ]; do
    if [ -z "$_nsa_shell_code" ]; then _nsa_shell_code=$_nsa_line
    else _nsa_shell_code="$_nsa_shell_code
$_nsa_line"; fi
  done
  if [ -z "$_nsa_shell_code" ]; then
    printf '%s\n' "nix-shell-add: no shell code provided on stdin" >&2
    exit 1
  fi
  _nsa_escaped_code=$(printf '%s' "$_nsa_shell_code" | sed "s/''/'''/g; s/\\\${/''\${/g")
  _nsa_marked_code=$(printf '%s' "$_nsa_escaped_code" | sed "s/$/ $_nsa_marker/")
  if [ ! -f "$_nsa_nix_file" ]; then
    _nsa_dir=${_nsa_nix_file%/*}
    [ "$_nsa_dir" != "$_nsa_nix_file" ] && [ ! -d "$_nsa_dir" ] && mkdir -p "$_nsa_dir"
    printf '{ config, pkgs, ... }:\n\n{\n}\n' > "$_nsa_nix_file"
  fi
  _nsa_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add.XXXXXX") || exit 1
  # Read file content inline
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then _nsa_content=$(sudo cat "$_nsa_nix_file")
    elif command -v doas >/dev/null 2>&1; then _nsa_content=$(doas cat "$_nsa_nix_file")
    else _nsa_content=$(cat "$_nsa_nix_file"); fi
  else _nsa_content=$(cat "$_nsa_nix_file"); fi
  
  if printf '%s\n' "$_nsa_content" | grep -q "$_nsa_nix_option[[:space:]]*="; then
    _nsa_input_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-input.XXXXXX") || exit 1
    printf '%s\n' "$_nsa_content" > "$_nsa_input_file"
    _nsa_in_block=0
    while IFS= read -r _nsa_line; do
      has_option="no"
      if printf '%s\n' "$_nsa_line" | grep -q "$_nsa_nix_option[[:space:]]*="; then
        has_option="yes"
      fi
      
      has_quote="no"
      if printf '%s\n' "$_nsa_line" | grep -q "''"; then
        has_quote="yes"
      fi
      
      if [ "$has_option" = "yes" ] && [ "$has_quote" = "yes" ]; then
        _nsa_in_block=1
        printf '%s\n' "$_nsa_line"
        continue
      fi
      if [ "$_nsa_in_block" -eq 1 ] && printf '%s\n' "$_nsa_line" | grep -q "^[[:space:]]*'';"; then
        printf '%s\n' "$_nsa_marked_code"; printf '%s\n' "$_nsa_line"; _nsa_in_block=0; continue
      fi
      printf '%s\n' "$_nsa_line"
    done < "$_nsa_input_file" > "$_nsa_tmp_file"
    rm -f "$_nsa_input_file"
  else
    # Write the block to a temp file and use it with awk (macOS awk compatible)
    _nsa_block_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-block.XXXXXX") || exit 1
    printf '%s\n' "  $_nsa_nix_option = ''" > "$_nsa_block_file"
    printf '%s\n' "$_nsa_marked_code" >> "$_nsa_block_file"
    printf '%s\n' "  '';" >> "$_nsa_block_file"
    
    printf '%s\n' "$_nsa_content" | awk -v blockfile="$_nsa_block_file" '
    BEGIN { while ((getline line < blockfile) > 0) block = block line "\n" }
    { lines[NR] = $0 }
    END {
      last = NR; while (last > 0 && lines[last] ~ /^[[:space:]]*$/) last--
      if (last > 0 && lines[last] ~ /^[[:space:]]*}/) {
        for (i = 1; i < last; i++) print lines[i]; print ""; printf "%s", block; print lines[last]
        for (i = last + 1; i <= NR; i++) print lines[i]
      } else { for (i = 1; i <= NR; i++) print lines[i]; print ""; printf "%s", block }
    }' > "$_nsa_tmp_file"
    rm -f "$_nsa_block_file"
  fi
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cp "$_nsa_tmp_file" "$_nsa_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cp "$_nsa_tmp_file" "$_nsa_nix_file"
    else cp "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  else mv "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  rm -f "$_nsa_tmp_file"
  exit 0
