#!/bin/sh
# env-clear - clear environment variables while preserving wizardry and system essentials
# This file must be sourced, not executed

# Guard against direct execution (inline check instead of calling uncastable)
env_clear_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) _env_clear_sourced=1 ;;
  esac
else
  _env_clear_base=${0##*/}
  case "$env_clear_base" in
    sh|dash|bash|zsh|ksh|mksh) _env_clear_sourced=1 ;;
    env-clear) _env_clear_sourced=0 ;;
    *) _env_clear_sourced=1 ;;
  esac
fi

if [ "$env_clear_sourced" -eq 0 ]; then
  printf '%s\n' "env-clear: must be sourced, not executed" >&2
  printf '%s\n' "Usage: . env-clear" >&2
  exit 1
fi
unset _env_clear_sourced _env_clear_base

# Explicitly use permissive mode - this imp mutates the caller's environment.
set +eu

# Skip env clearing when running in test mode (all test vars are preserved)
if [ "${WIZARDRY_TEST_HELPERS_ONLY:-0}" = "1" ]; then
  return 0
fi

# Skip env clearing when being sourced by invoke-wizardry during spell loading
# This prevents clearing parent's loop variables
if [ "${_WIZARDRY_LOADING_SPELLS:-0}" = "1" ]; then
  return 0
fi

# Preserve standard system environment variables
saved_path="${PATH:-}"
saved_home="${HOME:-}"
saved_user="${USER:-}"
saved_shell="${SHELL:-}"
saved_term="${TERM:-}"
saved_lang="${LANG:-}"
saved_tmpdir="${TMPDIR:-}"
saved_pwd="${PWD:-}"
saved_oldpwd="${OLDPWD:-}"

# Preserve wizardry declared globals (from declare-globals)
saved_wizardry_dir="${WIZARDRY_DIR:-}"
saved_wizardry_invoked="${_WIZARDRY_INVOKED:-}"
saved_spellbook_dir="${SPELLBOOK_DIR:-}"
saved_mud_dir="${MUD_DIR:-}"
saved_log_level="${WIZARDRY_LOG_LEVEL:-}"

# Preserve package manager override variables (used by pkg-install in arcana)
saved_nix_pkg="${NIX_PACKAGE:-}"
saved_apt_pkg="${APT_PACKAGE:-}"
saved_dnf_pkg="${DNF_PACKAGE:-}"
saved_yum_pkg="${YUM_PACKAGE:-}"
saved_zypper_pkg="${ZYPPER_PACKAGE:-}"
saved_pacman_pkg="${PACMAN_PACKAGE:-}"
saved_apk_pkg="${APK_PACKAGE:-}"
saved_pkgin_pkg="${PKGIN_PACKAGE:-}"
saved_brew_pkg="${BREW_PACKAGE:-}"

# Preserve test infrastructure variables (when running tests)
saved_test_failure="${TEST_FAILURE_REASON:-}"
saved_test_skip="${TEST_SKIP_REASON:-}"
saved_wiz_tmpdir="${WIZARDRY_TMPDIR:-}"
saved_global_subtest="${WIZARDRY_GLOBAL_SUBTEST_NUM:-}"
saved_test_compiled="${WIZARDRY_TEST_COMPILED:-}"
saved_test_helpers="${WIZARDRY_TEST_HELPERS_ONLY:-}"
saved_system_path="${WIZARDRY_SYSTEM_PATH:-}"
saved_ask_input="${ASK_CANTRIP_INPUT:-}"
saved_choose_input="${CHOOSE_INPUT_MODE:-}"
saved_menu_loop_limit="${MENU_LOOP_LIMIT:-}"
saved_require_command="${REQUIRE_COMMAND:-}"
saved_menu_log="${MENU_LOG:-}"
saved_git_log="${GIT_LOG:-}"
saved_require_log="${REQUIRE_LOG:-}"
saved_mock_toplevel="${MOCK_TOPLEVEL:-}"
saved_pull_status="${PULL_STATUS:-}"
saved_await_buffer_file="${AWAIT_KEYPRESS_BUFFER_FILE:-}"

# Preserve bootstrap/installer variables
saved_assume_yes="${ASSUME_YES:-}"
saved_force_install="${FORCE_INSTALL:-}"
saved_root_dir="${ROOT_DIR:-}"

# Preserve RC detection variables
saved_platform="${WIZARDRY_PLATFORM:-}"
saved_rc_file="${WIZARDRY_RC_FILE:-}"
saved_rc_format="${WIZARDRY_RC_FORMAT:-}"

# Preserve special feature flags
saved_await_keep_raw="${AWAIT_KEYPRESS_KEEP_RAW:-}"
saved_disable_sandbox="${WIZARDRY_DISABLE_SANDBOX:-}"
saved_bwrap_warning="${WIZARDRY_BWRAP_WARNING:-}"
saved_colors_available="${WIZARDRY_COLORS_AVAILABLE:-}"

# Preserve GitHub Actions environment variables (for CI/CD workflows)
saved_github_env="${GITHUB_ENV:-}"
saved_github_path="${GITHUB_PATH:-}"
saved_github_output="${GITHUB_OUTPUT:-}"
saved_github_step_summary="${GITHUB_STEP_SUMMARY:-}"
saved_github_workspace="${GITHUB_WORKSPACE:-}"
saved_github_action="${GITHUB_ACTION:-}"
saved_github_actions="${GITHUB_ACTIONS:-}"
saved_github_actor="${GITHUB_ACTOR:-}"
saved_github_repository="${GITHUB_REPOSITORY:-}"
saved_github_sha="${GITHUB_SHA:-}"
saved_github_ref="${GITHUB_REF:-}"
saved_github_ref_name="${GITHUB_REF_NAME:-}"
saved_github_head_ref="${GITHUB_HEAD_REF:-}"
saved_github_base_ref="${GITHUB_BASE_REF:-}"
saved_runner_os="${RUNNER_OS:-}"
saved_runner_temp="${RUNNER_TEMP:-}"
saved_runner_tool_cache="${RUNNER_TOOL_CACHE:-}"

# Clear all environment variables
for _var in $(env | cut -d= -f1); do
  unset "$var" 2>/dev/null || true
done

# Restore essential variables
export PATH="$saved_path"
export HOME="$saved_home"
export USER="$saved_user"
export SHELL="$saved_shell"
export TERM="$saved_term"
export LANG="$saved_lang"
export TMPDIR="$saved_tmpdir"
export PWD="$saved_pwd"
export OLDPWD="$saved_oldpwd"

# Restore wizardry globals
[ -n "$saved_wizardry_dir" ] && export WIZARDRY_DIR="$saved_wizardry_dir"
[ -n "$saved_wizardry_invoked" ] && export _WIZARDRY_INVOKED="$saved_wizardry_invoked"
[ -n "$saved_spellbook_dir" ] && export SPELLBOOK_DIR="$saved_spellbook_dir"
[ -n "$saved_mud_dir" ] && export MUD_DIR="$saved_mud_dir"
[ -n "$saved_log_level" ] && export WIZARDRY_LOG_LEVEL="$saved_log_level"

# Restore package manager overrides
[ -n "$saved_nix_pkg" ] && export NIX_PACKAGE="$saved_nix_pkg"
[ -n "$saved_apt_pkg" ] && export APT_PACKAGE="$saved_apt_pkg"
[ -n "$saved_dnf_pkg" ] && export DNF_PACKAGE="$saved_dnf_pkg"
[ -n "$saved_yum_pkg" ] && export YUM_PACKAGE="$saved_yum_pkg"
[ -n "$saved_zypper_pkg" ] && export ZYPPER_PACKAGE="$saved_zypper_pkg"
[ -n "$saved_pacman_pkg" ] && export PACMAN_PACKAGE="$saved_pacman_pkg"
[ -n "$saved_apk_pkg" ] && export APK_PACKAGE="$saved_apk_pkg"
[ -n "$saved_pkgin_pkg" ] && export PKGIN_PACKAGE="$saved_pkgin_pkg"
[ -n "$saved_brew_pkg" ] && export BREW_PACKAGE="$saved_brew_pkg"

# Restore test infrastructure
[ -n "$saved_test_failure" ] && export TEST_FAILURE_REASON="$saved_test_failure"
[ -n "$saved_test_skip" ] && export TEST_SKIP_REASON="$saved_test_skip"
[ -n "$saved_wiz_tmpdir" ] && export WIZARDRY_TMPDIR="$saved_wiz_tmpdir"
[ -n "$saved_global_subtest" ] && export WIZARDRY_GLOBAL_SUBTEST_NUM="$saved_global_subtest"
[ -n "$saved_test_compiled" ] && export WIZARDRY_TEST_COMPILED="$saved_test_compiled"
[ -n "$saved_test_helpers" ] && export WIZARDRY_TEST_HELPERS_ONLY="$saved_test_helpers"
[ -n "$saved_system_path" ] && export WIZARDRY_SYSTEM_PATH="$saved_system_path"
[ -n "$saved_ask_input" ] && export ASK_CANTRIP_INPUT="$saved_ask_input"
[ -n "$saved_choose_input" ] && export CHOOSE_INPUT_MODE="$saved_choose_input"
[ -n "$saved_menu_loop_limit" ] && export MENU_LOOP_LIMIT="$saved_menu_loop_limit"
[ -n "$saved_require_command" ] && export REQUIRE_COMMAND="$saved_require_command"
[ -n "$saved_menu_log" ] && export MENU_LOG="$saved_menu_log"
[ -n "$saved_git_log" ] && export GIT_LOG="$saved_git_log"
[ -n "$saved_require_log" ] && export REQUIRE_LOG="$saved_require_log"
[ -n "$saved_mock_toplevel" ] && export MOCK_TOPLEVEL="$saved_mock_toplevel"
[ -n "$saved_pull_status" ] && export PULL_STATUS="$saved_pull_status"
if [ -n "$saved_await_buffer_file" ]; then
  export AWAIT_KEYPRESS_BUFFER_FILE="$saved_await_buffer_file"
fi

# Restore bootstrap variables
[ -n "$saved_assume_yes" ] && export ASSUME_YES="$saved_assume_yes"
[ -n "$saved_force_install" ] && export FORCE_INSTALL="$saved_force_install"
[ -n "$saved_root_dir" ] && export ROOT_DIR="$saved_root_dir"

# Restore RC detection
[ -n "$saved_platform" ] && export WIZARDRY_PLATFORM="$saved_platform"
[ -n "$saved_rc_file" ] && export WIZARDRY_RC_FILE="$saved_rc_file"
[ -n "$saved_rc_format" ] && export WIZARDRY_RC_FORMAT="$saved_rc_format"

# Restore feature flags
[ -n "$saved_await_keep_raw" ] && export AWAIT_KEYPRESS_KEEP_RAW="$saved_await_keep_raw"
[ -n "$saved_disable_sandbox" ] && export WIZARDRY_DISABLE_SANDBOX="$saved_disable_sandbox"
[ -n "$saved_bwrap_warning" ] && export WIZARDRY_BWRAP_WARNING="$saved_bwrap_warning"
[ -n "$saved_colors_available" ] && export WIZARDRY_COLORS_AVAILABLE="$saved_colors_available"

# Restore GitHub Actions variables
[ -n "$saved_github_env" ] && export GITHUB_ENV="$saved_github_env"
[ -n "$saved_github_path" ] && export GITHUB_PATH="$saved_github_path"
[ -n "$saved_github_output" ] && export GITHUB_OUTPUT="$saved_github_output"
[ -n "$saved_github_step_summary" ] && export GITHUB_STEP_SUMMARY="$saved_github_step_summary"
[ -n "$saved_github_workspace" ] && export GITHUB_WORKSPACE="$saved_github_workspace"
[ -n "$saved_github_action" ] && export GITHUB_ACTION="$saved_github_action"
[ -n "$saved_github_actions" ] && export GITHUB_ACTIONS="$saved_github_actions"
[ -n "$saved_github_actor" ] && export GITHUB_ACTOR="$saved_github_actor"
[ -n "$saved_github_repository" ] && export GITHUB_REPOSITORY="$saved_github_repository"
[ -n "$saved_github_sha" ] && export GITHUB_SHA="$saved_github_sha"
[ -n "$saved_github_ref" ] && export GITHUB_REF="$saved_github_ref"
[ -n "$saved_github_ref_name" ] && export GITHUB_REF_NAME="$saved_github_ref_name"
[ -n "$saved_github_head_ref" ] && export GITHUB_HEAD_REF="$saved_github_head_ref"
[ -n "$saved_github_base_ref" ] && export GITHUB_BASE_REF="$saved_github_base_ref"
[ -n "$saved_runner_os" ] && export RUNNER_OS="$saved_runner_os"
[ -n "$saved_runner_temp" ] && export RUNNER_TEMP="$saved_runner_temp"
[ -n "$saved_runner_tool_cache" ] && export RUNNER_TOOL_CACHE="$saved_runner_tool_cache"

# Clean up temporary variables
unset _saved_path _saved_home _saved_user _saved_shell _saved_term _saved_lang
unset _saved_tmpdir _saved_pwd _saved_oldpwd _saved_wizardry_dir _saved_wizardry_invoked
unset _saved_spellbook_dir _saved_mud_dir _saved_log_level _saved_nix_pkg _saved_apt_pkg
unset _saved_yum_pkg _saved_zypper_pkg _saved_pacman_pkg _saved_apk_pkg _saved_pkgin_pkg
unset _saved_brew_pkg _saved_test_failure _saved_test_skip _saved_wiz_tmpdir
unset _saved_global_subtest _saved_test_compiled _saved_test_helpers _saved_system_path
unset _saved_ask_input _saved_choose_input _saved_menu_loop_limit _saved_require_command
unset _saved_menu_log _saved_await_buffer_file _saved_assume_yes
unset _saved_force_install _saved_root_dir
unset _saved_platform _saved_rc_file _saved_rc_format _saved_await_keep_raw
unset _saved_disable_sandbox _saved_bwrap_warning _saved_colors_available
unset _saved_github_env _saved_github_path _saved_github_output _saved_github_step_summary
unset _saved_github_workspace _saved_github_action _saved_github_actions _saved_github_actor
unset _saved_github_repository _saved_github_sha _saved_github_ref _saved_github_ref_name
unset _saved_github_head_ref _saved_github_base_ref _saved_runner_os _saved_runner_temp
unset _saved_runner_tool_cache _var

# Re-enable strict mode for the calling spell
# The spell set `-eu` before sourcing this file, so we restore that state
set -eu

# Return 0 explicitly (some shells exit with the exit code of the last unset)
return 0
