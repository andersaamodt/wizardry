#!/bin/sh
# env-clear - clear environment variables except wizardry globals and system vars
# Prevents env var antipattern by clearing all non-essential environment variables.
# Usage: . env-clear (must be sourced, call near top of spell after opening comment)

# This imp must be sourced to affect the calling shell's environment.
# It clears all environment variables except approved globals and system vars.

# Preserve standard system environment variables
_saved_path="${PATH:-}"
_saved_home="${HOME:-}"
_saved_user="${USER:-}"
_saved_shell="${SHELL:-}"
_saved_term="${TERM:-}"
_saved_lang="${LANG:-}"
_saved_tmpdir="${TMPDIR:-}"
_saved_pwd="${PWD:-}"
_saved_oldpwd="${OLDPWD:-}"

# Preserve wizardry declared globals (from declare-globals)
_saved_wizardry_dir="${WIZARDRY_DIR:-}"
_saved_spellbook_dir="${SPELLBOOK_DIR:-}"
_saved_mud_dir="${MUD_DIR:-}"
_saved_log_level="${WIZARDRY_LOG_LEVEL:-}"

# Preserve package manager override variables (used by pkg-install in arcana)
_saved_nix_pkg="${NIX_PACKAGE:-}"
_saved_apt_pkg="${APT_PACKAGE:-}"
_saved_dnf_pkg="${DNF_PACKAGE:-}"
_saved_yum_pkg="${YUM_PACKAGE:-}"
_saved_zypper_pkg="${ZYPPER_PACKAGE:-}"
_saved_pacman_pkg="${PACMAN_PACKAGE:-}"
_saved_apk_pkg="${APK_PACKAGE:-}"
_saved_pkgin_pkg="${PKGIN_PACKAGE:-}"
_saved_brew_pkg="${BREW_PACKAGE:-}"

# Preserve test infrastructure variables (when running tests)
_saved_test_failure="${TEST_FAILURE_REASON:-}"
_saved_test_skip="${TEST_SKIP_REASON:-}"
_saved_wiz_tmpdir="${WIZARDRY_TMPDIR:-}"
_saved_global_subtest="${WIZARDRY_GLOBAL_SUBTEST_NUM:-}"
_saved_test_compiled="${WIZARDRY_TEST_COMPILED:-}"
_saved_test_helpers="${WIZARDRY_TEST_HELPERS_ONLY:-}"
_saved_system_path="${WIZARDRY_SYSTEM_PATH:-}"
_saved_ask_input="${ASK_CANTRIP_INPUT:-}"
_saved_select_input="${SELECT_INPUT_MODE:-}"
_saved_menu_loop_limit="${MENU_LOOP_LIMIT:-}"
_saved_require_command="${REQUIRE_COMMAND:-}"
_saved_menu_log="${MENU_LOG:-}"

# Preserve bootstrap/installer variables
_saved_assume_yes="${ASSUME_YES:-}"
_saved_force_install="${FORCE_INSTALL:-}"
_saved_root_dir="${ROOT_DIR:-}"

# Preserve RC detection variables
_saved_platform="${WIZARDRY_PLATFORM:-}"
_saved_rc_file="${WIZARDRY_RC_FILE:-}"
_saved_rc_format="${WIZARDRY_RC_FORMAT:-}"

# Preserve special feature flags
_saved_await_keep_raw="${AWAIT_KEYPRESS_KEEP_RAW:-}"
_saved_disable_sandbox="${WIZARDRY_DISABLE_SANDBOX:-}"
_saved_bwrap_warning="${WIZARDRY_BWRAP_WARNING:-}"
_saved_colors_available="${WIZARDRY_COLORS_AVAILABLE:-}"

# Clear all environment variables
for _var in $(env | cut -d= -f1); do
  unset "$_var" 2>/dev/null || true
done

# Restore essential variables
export PATH="$_saved_path"
export HOME="$_saved_home"
export USER="$_saved_user"
export SHELL="$_saved_shell"
export TERM="$_saved_term"
export LANG="$_saved_lang"
export TMPDIR="$_saved_tmpdir"
export PWD="$_saved_pwd"
export OLDPWD="$_saved_oldpwd"

# Restore wizardry globals
[ -n "$_saved_wizardry_dir" ] && export WIZARDRY_DIR="$_saved_wizardry_dir"
[ -n "$_saved_spellbook_dir" ] && export SPELLBOOK_DIR="$_saved_spellbook_dir"
[ -n "$_saved_mud_dir" ] && export MUD_DIR="$_saved_mud_dir"
[ -n "$_saved_log_level" ] && export WIZARDRY_LOG_LEVEL="$_saved_log_level"

# Restore package manager variables
[ -n "$_saved_nix_pkg" ] && export NIX_PACKAGE="$_saved_nix_pkg"
[ -n "$_saved_apt_pkg" ] && export APT_PACKAGE="$_saved_apt_pkg"
[ -n "$_saved_dnf_pkg" ] && export DNF_PACKAGE="$_saved_dnf_pkg"
[ -n "$_saved_yum_pkg" ] && export YUM_PACKAGE="$_saved_yum_pkg"
[ -n "$_saved_zypper_pkg" ] && export ZYPPER_PACKAGE="$_saved_zypper_pkg"
[ -n "$_saved_pacman_pkg" ] && export PACMAN_PACKAGE="$_saved_pacman_pkg"
[ -n "$_saved_apk_pkg" ] && export APK_PACKAGE="$_saved_apk_pkg"
[ -n "$_saved_pkgin_pkg" ] && export PKGIN_PACKAGE="$_saved_pkgin_pkg"
[ -n "$_saved_brew_pkg" ] && export BREW_PACKAGE="$_saved_brew_pkg"

# Restore test variables
[ -n "$_saved_test_failure" ] && export TEST_FAILURE_REASON="$_saved_test_failure"
[ -n "$_saved_test_skip" ] && export TEST_SKIP_REASON="$_saved_test_skip"
[ -n "$_saved_wiz_tmpdir" ] && export WIZARDRY_TMPDIR="$_saved_wiz_tmpdir"
[ -n "$_saved_global_subtest" ] && export WIZARDRY_GLOBAL_SUBTEST_NUM="$_saved_global_subtest"
[ -n "$_saved_test_compiled" ] && export WIZARDRY_TEST_COMPILED="$_saved_test_compiled"
[ -n "$_saved_test_helpers" ] && export WIZARDRY_TEST_HELPERS_ONLY="$_saved_test_helpers"
[ -n "$_saved_system_path" ] && export WIZARDRY_SYSTEM_PATH="$_saved_system_path"
[ -n "$_saved_ask_input" ] && export ASK_CANTRIP_INPUT="$_saved_ask_input"
[ -n "$_saved_select_input" ] && export SELECT_INPUT_MODE="$_saved_select_input"
[ -n "$_saved_menu_loop_limit" ] && export MENU_LOOP_LIMIT="$_saved_menu_loop_limit"
[ -n "$_saved_require_command" ] && export REQUIRE_COMMAND="$_saved_require_command"
[ -n "$_saved_menu_log" ] && export MENU_LOG="$_saved_menu_log"

# Restore bootstrap variables
[ -n "$_saved_assume_yes" ] && export ASSUME_YES="$_saved_assume_yes"
[ -n "$_saved_force_install" ] && export FORCE_INSTALL="$_saved_force_install"
[ -n "$_saved_root_dir" ] && export ROOT_DIR="$_saved_root_dir"

# Restore RC detection variables
[ -n "$_saved_platform" ] && export WIZARDRY_PLATFORM="$_saved_platform"
[ -n "$_saved_rc_file" ] && export WIZARDRY_RC_FILE="$_saved_rc_file"
[ -n "$_saved_rc_format" ] && export WIZARDRY_RC_FORMAT="$_saved_rc_format"

# Restore feature flags
[ -n "$_saved_await_keep_raw" ] && export AWAIT_KEYPRESS_KEEP_RAW="$_saved_await_keep_raw"
[ -n "$_saved_disable_sandbox" ] && export WIZARDRY_DISABLE_SANDBOX="$_saved_disable_sandbox"
[ -n "$_saved_bwrap_warning" ] && export WIZARDRY_BWRAP_WARNING="$_saved_bwrap_warning"
[ -n "$_saved_colors_available" ] && export WIZARDRY_COLORS_AVAILABLE="$_saved_colors_available"

# Ensure env-clear always exits successfully when sourced
# (last conditional may return 1 if variable is empty)
true
