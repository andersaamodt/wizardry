#!/bin/sh
# env-clear - clear environment variables while preserving wizardry and system essentials
# This file must be sourced, not executed

# Uncastable pattern - ensures spell is sourced, not executed
env_clear_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) env_clear_sourced=1 ;;
  esac
else
  env_clear_base=${0##*/}
  case "$env_clear_base" in
    sh|dash|bash|zsh|ksh|mksh) env_clear_sourced=1 ;;
    env-clear) env_clear_sourced=0 ;;
    *) env_clear_sourced=1 ;;
  esac
fi

if [ "$env_clear_sourced" -eq 0 ]; then
  printf '%s\n' "This spell cannot be cast directly. Invoke it with: . env-clear" >&2
  return 1 2>/dev/null || exit 1
fi
unset env_clear_sourced env_clear_base

# Explicitly use permissive mode - this imp mutates the caller's environment.
set +eu

# Skip env clearing when running in test mode (all test vars are preserved)
if [ "${WIZARDRY_TEST_HELPERS_ONLY:-0}" = "1" ]; then
  set -eu
  return 0
fi

# Skip env clearing when being sourced by invoke-wizardry during spell loading
# This prevents clearing parent's loop variables
if [ "${_WIZARDRY_LOADING_SPELLS:-0}" = "1" ]; then
  set -eu
  return 0
fi

# Preserve standard system environment variables
ec_saved_path="${PATH:-}"
ec_saved_home="${HOME:-}"
ec_saved_user="${USER:-}"
ec_saved_shell="${SHELL:-}"
ec_saved_term="${TERM:-}"
ec_saved_lang="${LANG:-}"
ec_saved_tmpdir="${TMPDIR:-}"
ec_saved_pwd="${PWD:-}"
ec_saved_oldpwd="${OLDPWD:-}"

# Preserve wizardry declared globals (from declare-globals)
ec_saved_wizardry_dir="${WIZARDRY_DIR:-}"
ec_saved_wizardry_invoked="${WIZARDRY_INVOKED:-}"
ec_saved_spellbook_dir="${SPELLBOOK_DIR:-}"
ec_saved_mud_dir="${MUD_DIR:-}"
ec_saved_log_level="${WIZARDRY_LOG_LEVEL:-}"

# Preserve package manager override variables (used by pkg-install in arcana)
# Officially supported platforms only: debian, arch, nixos, mac
ec_saved_nix_pkg="${NIX_PACKAGE:-}"
ec_saved_apt_pkg="${APT_PACKAGE:-}"
ec_saved_pacman_pkg="${PACMAN_PACKAGE:-}"
ec_saved_pkgin_pkg="${PKGIN_PACKAGE:-}"

# Preserve test infrastructure variables (when running tests)
ec_saved_test_failure="${TEST_FAILURE_REASON:-}"
ec_saved_test_skip="${TEST_SKIP_REASON:-}"
ec_saved_wiz_tmpdir="${WIZARDRY_TMPDIR:-}"
ec_saved_global_subtest="${WIZARDRY_GLOBAL_SUBTEST_NUM:-}"
ec_saved_test_compiled="${WIZARDRY_TEST_COMPILED:-}"
ec_saved_test_helpers="${WIZARDRY_TEST_HELPERS_ONLY:-}"
ec_saved_system_path="${WIZARDRY_SYSTEM_PATH:-}"
ec_saved_ask_input="${ASK_CANTRIP_INPUT:-}"
ec_saved_choose_input="${CHOOSE_INPUT_MODE:-}"
ec_saved_menu_loop_limit="${MENU_LOOP_LIMIT:-}"
ec_saved_require_command="${REQUIRE_COMMAND:-}"
ec_saved_menu_log="${MENU_LOG:-}"
ec_saved_git_log="${GIT_LOG:-}"
ec_saved_require_log="${REQUIRE_LOG:-}"
ec_saved_mock_toplevel="${MOCK_TOPLEVEL:-}"
ec_saved_pull_status="${PULL_STATUS:-}"
ec_saved_await_buffer_file="${AWAIT_KEYPRESS_BUFFER_FILE:-}"

# Preserve bootstrap/installer variables
ec_saved_assume_yes="${ASSUME_YES:-}"
ec_saved_force_install="${FORCE_INSTALL:-}"
ec_saved_root_dir="${ROOT_DIR:-}"

# Preserve RC detection variables
ec_saved_platform="${WIZARDRY_PLATFORM:-}"
ec_saved_rc_file="${WIZARDRY_RC_FILE:-}"
ec_saved_rc_format="${WIZARDRY_RC_FORMAT:-}"

# Preserve special feature flags
ec_saved_await_keep_raw="${AWAIT_KEYPRESS_KEEP_RAW:-}"
ec_saved_disable_sandbox="${WIZARDRY_DISABLE_SANDBOX:-}"
ec_saved_bwrap_warning="${WIZARDRY_BWRAP_WARNING:-}"
ec_saved_colors_available="${WIZARDRY_COLORS_AVAILABLE:-}"

# Preserve GitHub Actions environment variables (for CI/CD workflows)
ec_saved_github_env="${GITHUB_ENV:-}"
ec_saved_github_path="${GITHUB_PATH:-}"
ec_saved_github_output="${GITHUB_OUTPUT:-}"
ec_saved_github_step_summary="${GITHUB_STEP_SUMMARY:-}"
ec_saved_github_workspace="${GITHUB_WORKSPACE:-}"
ec_saved_github_action="${GITHUB_ACTION:-}"
ec_saved_github_actions="${GITHUB_ACTIONS:-}"
ec_saved_github_actor="${GITHUB_ACTOR:-}"
ec_saved_github_repository="${GITHUB_REPOSITORY:-}"
ec_saved_github_sha="${GITHUB_SHA:-}"
ec_saved_github_ref="${GITHUB_REF:-}"
ec_saved_github_ref_name="${GITHUB_REF_NAME:-}"
ec_saved_github_head_ref="${GITHUB_HEAD_REF:-}"
ec_saved_github_base_ref="${GITHUB_BASE_REF:-}"
ec_saved_runner_os="${RUNNER_OS:-}"
ec_saved_runner_temp="${RUNNER_TEMP:-}"
ec_saved_runner_tool_cache="${RUNNER_TOOL_CACHE:-}"

# Clear all environment variables
for env_var in $(env | cut -d= -f1); do
  unset "$env_var" 2>/dev/null || true
done

# Restore essential variables (unconditionally - even if empty)
export PATH="${ec_saved_path}"
export HOME="${ec_saved_home}"
export USER="$ec_saved_user"
export SHELL="$ec_saved_shell"
export TERM="$ec_saved_term"
export LANG="$ec_saved_lang"
export TMPDIR="$ec_saved_tmpdir"
export PWD="$ec_saved_pwd"
export OLDPWD="$ec_saved_oldpwd"

# Restore wizardry globals
[ -n "$ec_saved_wizardry_dir" ] && export WIZARDRY_DIR="$ec_saved_wizardry_dir"
[ -n "$ec_saved_wizardry_invoked" ] && export WIZARDRY_INVOKED="$ec_saved_wizardry_invoked"
[ -n "$ec_saved_spellbook_dir" ] && export SPELLBOOK_DIR="$ec_saved_spellbook_dir"
[ -n "$ec_saved_mud_dir" ] && export MUD_DIR="$ec_saved_mud_dir"
[ -n "$ec_saved_log_level" ] && export WIZARDRY_LOG_LEVEL="$ec_saved_log_level"

# Restore package manager overrides (officially supported platforms only)
[ -n "$ec_saved_nix_pkg" ] && export NIX_PACKAGE="$ec_saved_nix_pkg"
[ -n "$ec_saved_apt_pkg" ] && export APT_PACKAGE="$ec_saved_apt_pkg"
[ -n "$ec_saved_pacman_pkg" ] && export PACMAN_PACKAGE="$ec_saved_pacman_pkg"
[ -n "$ec_saved_pkgin_pkg" ] && export PKGIN_PACKAGE="$ec_saved_pkgin_pkg"

# Restore test infrastructure
[ -n "$ec_saved_test_failure" ] && export TEST_FAILURE_REASON="$ec_saved_test_failure"
[ -n "$ec_saved_test_skip" ] && export TEST_SKIP_REASON="$ec_saved_test_skip"
[ -n "$ec_saved_wiz_tmpdir" ] && export WIZARDRY_TMPDIR="$ec_saved_wiz_tmpdir"
[ -n "$ec_saved_global_subtest" ] && export WIZARDRY_GLOBAL_SUBTEST_NUM="$ec_saved_global_subtest"
[ -n "$ec_saved_test_compiled" ] && export WIZARDRY_TEST_COMPILED="$ec_saved_test_compiled"
[ -n "$ec_saved_test_helpers" ] && export WIZARDRY_TEST_HELPERS_ONLY="$ec_saved_test_helpers"
[ -n "$ec_saved_system_path" ] && export WIZARDRY_SYSTEM_PATH="$ec_saved_system_path"
[ -n "$ec_saved_ask_input" ] && export ASK_CANTRIP_INPUT="$ec_saved_ask_input"
[ -n "$ec_saved_choose_input" ] && export CHOOSE_INPUT_MODE="$ec_saved_choose_input"
[ -n "$ec_saved_menu_loop_limit" ] && export MENU_LOOP_LIMIT="$ec_saved_menu_loop_limit"
[ -n "$ec_saved_require_command" ] && export REQUIRE_COMMAND="$ec_saved_require_command"
[ -n "$ec_saved_menu_log" ] && export MENU_LOG="$ec_saved_menu_log"
[ -n "$ec_saved_git_log" ] && export GIT_LOG="$ec_saved_git_log"
[ -n "$ec_saved_require_log" ] && export REQUIRE_LOG="$ec_saved_require_log"
[ -n "$ec_saved_mock_toplevel" ] && export MOCK_TOPLEVEL="$ec_saved_mock_toplevel"
[ -n "$ec_saved_pull_status" ] && export PULL_STATUS="$ec_saved_pull_status"
if [ -n "$ec_saved_await_buffer_file" ]; then
  export AWAIT_KEYPRESS_BUFFER_FILE="$ec_saved_await_buffer_file"
fi

# Restore bootstrap variables
[ -n "$ec_saved_assume_yes" ] && export ASSUME_YES="$ec_saved_assume_yes"
[ -n "$ec_saved_force_install" ] && export FORCE_INSTALL="$ec_saved_force_install"
[ -n "$ec_saved_root_dir" ] && export ROOT_DIR="$ec_saved_root_dir"

# Restore RC detection
[ -n "$ec_saved_platform" ] && export WIZARDRY_PLATFORM="$ec_saved_platform"
[ -n "$ec_saved_rc_file" ] && export WIZARDRY_RC_FILE="$ec_saved_rc_file"
[ -n "$ec_saved_rc_format" ] && export WIZARDRY_RC_FORMAT="$ec_saved_rc_format"

# Restore feature flags
[ -n "$ec_saved_await_keep_raw" ] && export AWAIT_KEYPRESS_KEEP_RAW="$ec_saved_await_keep_raw"
[ -n "$ec_saved_disable_sandbox" ] && export WIZARDRY_DISABLE_SANDBOX="$ec_saved_disable_sandbox"
[ -n "$ec_saved_bwrap_warning" ] && export WIZARDRY_BWRAP_WARNING="$ec_saved_bwrap_warning"
[ -n "$ec_saved_colors_available" ] && export WIZARDRY_COLORS_AVAILABLE="$ec_saved_colors_available"

# Restore GitHub Actions variables
[ -n "$ec_saved_github_env" ] && export GITHUB_ENV="$ec_saved_github_env"
[ -n "$ec_saved_github_path" ] && export GITHUB_PATH="$ec_saved_github_path"
[ -n "$ec_saved_github_output" ] && export GITHUB_OUTPUT="$ec_saved_github_output"
[ -n "$ec_saved_github_step_summary" ] && export GITHUB_STEP_SUMMARY="$ec_saved_github_step_summary"
[ -n "$ec_saved_github_workspace" ] && export GITHUB_WORKSPACE="$ec_saved_github_workspace"
[ -n "$ec_saved_github_action" ] && export GITHUB_ACTION="$ec_saved_github_action"
[ -n "$ec_saved_github_actions" ] && export GITHUB_ACTIONS="$ec_saved_github_actions"
[ -n "$ec_saved_github_actor" ] && export GITHUB_ACTOR="$ec_saved_github_actor"
[ -n "$ec_saved_github_repository" ] && export GITHUB_REPOSITORY="$ec_saved_github_repository"
[ -n "$ec_saved_github_sha" ] && export GITHUB_SHA="$ec_saved_github_sha"
[ -n "$ec_saved_github_ref" ] && export GITHUB_REF="$ec_saved_github_ref"
[ -n "$ec_saved_github_ref_name" ] && export GITHUB_REF_NAME="$ec_saved_github_ref_name"
[ -n "$ec_saved_github_head_ref" ] && export GITHUB_HEAD_REF="$ec_saved_github_head_ref"
[ -n "$ec_saved_github_base_ref" ] && export GITHUB_BASE_REF="$ec_saved_github_base_ref"
[ -n "$ec_saved_runner_os" ] && export RUNNER_OS="$ec_saved_runner_os"
[ -n "$ec_saved_runner_temp" ] && export RUNNER_TEMP="$ec_saved_runner_temp"
[ -n "$ec_saved_runner_tool_cache" ] && export RUNNER_TOOL_CACHE="$ec_saved_runner_tool_cache"

# Clean up temporary variables
unset ec_saved_path ec_saved_home ec_saved_user ec_saved_shell ec_saved_term
unset ec_saved_lang ec_saved_tmpdir ec_saved_pwd ec_saved_oldpwd
unset ec_saved_wizardry_dir ec_saved_wizardry_invoked ec_saved_spellbook_dir
unset ec_saved_mud_dir ec_saved_log_level ec_saved_nix_pkg ec_saved_apt_pkg
unset ec_saved_pacman_pkg ec_saved_pkgin_pkg ec_saved_test_failure
unset ec_saved_test_skip ec_saved_wiz_tmpdir ec_saved_global_subtest
unset ec_saved_test_compiled ec_saved_test_helpers ec_saved_system_path
unset ec_saved_ask_input ec_saved_choose_input ec_saved_menu_loop_limit
unset ec_saved_require_command ec_saved_menu_log ec_saved_await_buffer_file
unset ec_saved_assume_yes ec_saved_force_install ec_saved_root_dir
unset ec_saved_platform ec_saved_rc_file ec_saved_rc_format
unset ec_saved_await_keep_raw ec_saved_disable_sandbox ec_saved_bwrap_warning
unset ec_saved_colors_available ec_saved_github_env ec_saved_github_path
unset ec_saved_github_output ec_saved_github_step_summary
unset ec_saved_github_workspace ec_saved_github_action ec_saved_github_actions
unset ec_saved_github_actor ec_saved_github_repository ec_saved_github_sha
unset ec_saved_github_ref ec_saved_github_ref_name ec_saved_github_head_ref
unset ec_saved_github_base_ref ec_saved_runner_os ec_saved_runner_temp
unset ec_saved_runner_tool_cache env_var

# Re-enable strict mode for the calling spell
# The spell set `-eu` before sourcing this file, so we restore that state
set -eu

# Return 0 explicitly (some shells exit with the exit code of the last unset)
return 0
