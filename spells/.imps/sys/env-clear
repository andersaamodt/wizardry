#!/bin/sh
# env-clear - clear environment variables while preserving wizardry and system essentials
# This file must be sourced, not executed

# Guard against direct execution (inline check instead of calling uncastable)
_env_clear_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) _env_clear_sourced=1 ;;
  esac
else
  _env_clear_base=${0##*/}
  case "$_env_clear_base" in
    sh|dash|bash|zsh|ksh|mksh) _env_clear_sourced=1 ;;
    env-clear) _env_clear_sourced=0 ;;
    *) _env_clear_sourced=1 ;;
  esac
fi

if [ "$_env_clear_sourced" -eq 0 ]; then
  printf '%s\n' "env-clear: must be sourced, not executed" >&2
  printf '%s\n' "Usage: . env-clear" >&2
  exit 1
fi
unset _env_clear_sourced _env_clear_base

# Explicitly use permissive mode - this imp mutates the caller's environment.
set +eu

# Skip env clearing when running in test mode (all test vars are preserved)
if [ "${WIZARDRY_TEST_HELPERS_ONLY:-0}" = "1" ]; then
  exit 0
fi

# Skip env clearing when being sourced by invoke-wizardry during spell loading
# This prevents clearing parent's loop variables
if [ "${_WIZARDRY_LOADING_SPELLS:-0}" = "1" ]; then
  exit 0
fi

# Preserve standard system environment variables
_saved_path="${PATH:-}"
_saved_home="${HOME:-}"
_saved_user="${USER:-}"
_saved_shell="${SHELL:-}"
_saved_term="${TERM:-}"
_saved_lang="${LANG:-}"
_saved_tmpdir="${TMPDIR:-}"
_saved_pwd="${PWD:-}"
_saved_oldpwd="${OLDPWD:-}"

# Preserve wizardry declared globals (from declare-globals)
_saved_wizardry_dir="${WIZARDRY_DIR:-}"
_saved_wizardry_invoked="${_WIZARDRY_INVOKED:-}"
_saved_spellbook_dir="${SPELLBOOK_DIR:-}"
_saved_mud_dir="${MUD_DIR:-}"
_saved_log_level="${WIZARDRY_LOG_LEVEL:-}"

# Preserve package manager override variables (used by pkg-install in arcana)
_saved_nix_pkg="${NIX_PACKAGE:-}"
_saved_apt_pkg="${APT_PACKAGE:-}"
_saved_dnf_pkg="${DNF_PACKAGE:-}"
_saved_yum_pkg="${YUM_PACKAGE:-}"
_saved_zypper_pkg="${ZYPPER_PACKAGE:-}"
_saved_pacman_pkg="${PACMAN_PACKAGE:-}"
_saved_apk_pkg="${APK_PACKAGE:-}"
_saved_pkgin_pkg="${PKGIN_PACKAGE:-}"
_saved_brew_pkg="${BREW_PACKAGE:-}"

# Preserve test infrastructure variables (when running tests)
_saved_test_failure="${TEST_FAILURE_REASON:-}"
_saved_test_skip="${TEST_SKIP_REASON:-}"
_saved_wiz_tmpdir="${WIZARDRY_TMPDIR:-}"
_saved_global_subtest="${WIZARDRY_GLOBAL_SUBTEST_NUM:-}"
_saved_test_compiled="${WIZARDRY_TEST_COMPILED:-}"
_saved_test_helpers="${WIZARDRY_TEST_HELPERS_ONLY:-}"
_saved_system_path="${WIZARDRY_SYSTEM_PATH:-}"
_saved_ask_input="${ASK_CANTRIP_INPUT:-}"
_saved_choose_input="${CHOOSE_INPUT_MODE:-}"
_saved_menu_loop_limit="${MENU_LOOP_LIMIT:-}"
_saved_require_command="${REQUIRE_COMMAND:-}"
_saved_menu_log="${MENU_LOG:-}"
_saved_git_log="${GIT_LOG:-}"
_saved_require_log="${REQUIRE_LOG:-}"
_saved_mock_toplevel="${MOCK_TOPLEVEL:-}"
_saved_pull_status="${PULL_STATUS:-}"
_saved_await_buffer_file="${AWAIT_KEYPRESS_BUFFER_FILE:-}"

# Preserve bootstrap/installer variables
_saved_assume_yes="${ASSUME_YES:-}"
_saved_force_install="${FORCE_INSTALL:-}"
_saved_root_dir="${ROOT_DIR:-}"

# Preserve RC detection variables
_saved_platform="${WIZARDRY_PLATFORM:-}"
_saved_rc_file="${WIZARDRY_RC_FILE:-}"
_saved_rc_format="${WIZARDRY_RC_FORMAT:-}"

# Preserve special feature flags
_saved_await_keep_raw="${AWAIT_KEYPRESS_KEEP_RAW:-}"
_saved_disable_sandbox="${WIZARDRY_DISABLE_SANDBOX:-}"
_saved_bwrap_warning="${WIZARDRY_BWRAP_WARNING:-}"
_saved_colors_available="${WIZARDRY_COLORS_AVAILABLE:-}"

# Preserve GitHub Actions environment variables (for CI/CD workflows)
_saved_github_env="${GITHUB_ENV:-}"
_saved_github_path="${GITHUB_PATH:-}"
_saved_github_output="${GITHUB_OUTPUT:-}"
_saved_github_step_summary="${GITHUB_STEP_SUMMARY:-}"
_saved_github_workspace="${GITHUB_WORKSPACE:-}"
_saved_github_action="${GITHUB_ACTION:-}"
_saved_github_actions="${GITHUB_ACTIONS:-}"
_saved_github_actor="${GITHUB_ACTOR:-}"
_saved_github_repository="${GITHUB_REPOSITORY:-}"
_saved_github_sha="${GITHUB_SHA:-}"
_saved_github_ref="${GITHUB_REF:-}"
_saved_github_ref_name="${GITHUB_REF_NAME:-}"
_saved_github_head_ref="${GITHUB_HEAD_REF:-}"
_saved_github_base_ref="${GITHUB_BASE_REF:-}"
_saved_runner_os="${RUNNER_OS:-}"
_saved_runner_temp="${RUNNER_TEMP:-}"
_saved_runner_tool_cache="${RUNNER_TOOL_CACHE:-}"

# Clear all environment variables
for _var in $(env | cut -d= -f1); do
  unset "$_var" 2>/dev/null || true
done

# Restore essential variables
export PATH="$_saved_path"
export HOME="$_saved_home"
export USER="$_saved_user"
export SHELL="$_saved_shell"
export TERM="$_saved_term"
export LANG="$_saved_lang"
export TMPDIR="$_saved_tmpdir"
export PWD="$_saved_pwd"
export OLDPWD="$_saved_oldpwd"

# Restore wizardry globals
[ -n "$_saved_wizardry_dir" ] && export WIZARDRY_DIR="$_saved_wizardry_dir"
[ -n "$_saved_wizardry_invoked" ] && export _WIZARDRY_INVOKED="$_saved_wizardry_invoked"
[ -n "$_saved_spellbook_dir" ] && export SPELLBOOK_DIR="$_saved_spellbook_dir"
[ -n "$_saved_mud_dir" ] && export MUD_DIR="$_saved_mud_dir"
[ -n "$_saved_log_level" ] && export WIZARDRY_LOG_LEVEL="$_saved_log_level"

# Restore package manager overrides
[ -n "$_saved_nix_pkg" ] && export NIX_PACKAGE="$_saved_nix_pkg"
[ -n "$_saved_apt_pkg" ] && export APT_PACKAGE="$_saved_apt_pkg"
[ -n "$_saved_dnf_pkg" ] && export DNF_PACKAGE="$_saved_dnf_pkg"
[ -n "$_saved_yum_pkg" ] && export YUM_PACKAGE="$_saved_yum_pkg"
[ -n "$_saved_zypper_pkg" ] && export ZYPPER_PACKAGE="$_saved_zypper_pkg"
[ -n "$_saved_pacman_pkg" ] && export PACMAN_PACKAGE="$_saved_pacman_pkg"
[ -n "$_saved_apk_pkg" ] && export APK_PACKAGE="$_saved_apk_pkg"
[ -n "$_saved_pkgin_pkg" ] && export PKGIN_PACKAGE="$_saved_pkgin_pkg"
[ -n "$_saved_brew_pkg" ] && export BREW_PACKAGE="$_saved_brew_pkg"

# Restore test infrastructure
[ -n "$_saved_test_failure" ] && export TEST_FAILURE_REASON="$_saved_test_failure"
[ -n "$_saved_test_skip" ] && export TEST_SKIP_REASON="$_saved_test_skip"
[ -n "$_saved_wiz_tmpdir" ] && export WIZARDRY_TMPDIR="$_saved_wiz_tmpdir"
[ -n "$_saved_global_subtest" ] && export WIZARDRY_GLOBAL_SUBTEST_NUM="$_saved_global_subtest"
[ -n "$_saved_test_compiled" ] && export WIZARDRY_TEST_COMPILED="$_saved_test_compiled"
[ -n "$_saved_test_helpers" ] && export WIZARDRY_TEST_HELPERS_ONLY="$_saved_test_helpers"
[ -n "$_saved_system_path" ] && export WIZARDRY_SYSTEM_PATH="$_saved_system_path"
[ -n "$_saved_ask_input" ] && export ASK_CANTRIP_INPUT="$_saved_ask_input"
[ -n "$_saved_choose_input" ] && export CHOOSE_INPUT_MODE="$_saved_choose_input"
[ -n "$_saved_menu_loop_limit" ] && export MENU_LOOP_LIMIT="$_saved_menu_loop_limit"
[ -n "$_saved_require_command" ] && export REQUIRE_COMMAND="$_saved_require_command"
[ -n "$_saved_menu_log" ] && export MENU_LOG="$_saved_menu_log"
[ -n "$_saved_git_log" ] && export GIT_LOG="$_saved_git_log"
[ -n "$_saved_require_log" ] && export REQUIRE_LOG="$_saved_require_log"
[ -n "$_saved_mock_toplevel" ] && export MOCK_TOPLEVEL="$_saved_mock_toplevel"
[ -n "$_saved_pull_status" ] && export PULL_STATUS="$_saved_pull_status"
if [ -n "$_saved_await_buffer_file" ]; then
  export AWAIT_KEYPRESS_BUFFER_FILE="$_saved_await_buffer_file"
fi

# Restore bootstrap variables
[ -n "$_saved_assume_yes" ] && export ASSUME_YES="$_saved_assume_yes"
[ -n "$_saved_force_install" ] && export FORCE_INSTALL="$_saved_force_install"
[ -n "$_saved_root_dir" ] && export ROOT_DIR="$_saved_root_dir"

# Restore RC detection
[ -n "$_saved_platform" ] && export WIZARDRY_PLATFORM="$_saved_platform"
[ -n "$_saved_rc_file" ] && export WIZARDRY_RC_FILE="$_saved_rc_file"
[ -n "$_saved_rc_format" ] && export WIZARDRY_RC_FORMAT="$_saved_rc_format"

# Restore feature flags
[ -n "$_saved_await_keep_raw" ] && export AWAIT_KEYPRESS_KEEP_RAW="$_saved_await_keep_raw"
[ -n "$_saved_disable_sandbox" ] && export WIZARDRY_DISABLE_SANDBOX="$_saved_disable_sandbox"
[ -n "$_saved_bwrap_warning" ] && export WIZARDRY_BWRAP_WARNING="$_saved_bwrap_warning"
[ -n "$_saved_colors_available" ] && export WIZARDRY_COLORS_AVAILABLE="$_saved_colors_available"

# Restore GitHub Actions variables
[ -n "$_saved_github_env" ] && export GITHUB_ENV="$_saved_github_env"
[ -n "$_saved_github_path" ] && export GITHUB_PATH="$_saved_github_path"
[ -n "$_saved_github_output" ] && export GITHUB_OUTPUT="$_saved_github_output"
[ -n "$_saved_github_step_summary" ] && export GITHUB_STEP_SUMMARY="$_saved_github_step_summary"
[ -n "$_saved_github_workspace" ] && export GITHUB_WORKSPACE="$_saved_github_workspace"
[ -n "$_saved_github_action" ] && export GITHUB_ACTION="$_saved_github_action"
[ -n "$_saved_github_actions" ] && export GITHUB_ACTIONS="$_saved_github_actions"
[ -n "$_saved_github_actor" ] && export GITHUB_ACTOR="$_saved_github_actor"
[ -n "$_saved_github_repository" ] && export GITHUB_REPOSITORY="$_saved_github_repository"
[ -n "$_saved_github_sha" ] && export GITHUB_SHA="$_saved_github_sha"
[ -n "$_saved_github_ref" ] && export GITHUB_REF="$_saved_github_ref"
[ -n "$_saved_github_ref_name" ] && export GITHUB_REF_NAME="$_saved_github_ref_name"
[ -n "$_saved_github_head_ref" ] && export GITHUB_HEAD_REF="$_saved_github_head_ref"
[ -n "$_saved_github_base_ref" ] && export GITHUB_BASE_REF="$_saved_github_base_ref"
[ -n "$_saved_runner_os" ] && export RUNNER_OS="$_saved_runner_os"
[ -n "$_saved_runner_temp" ] && export RUNNER_TEMP="$_saved_runner_temp"
[ -n "$_saved_runner_tool_cache" ] && export RUNNER_TOOL_CACHE="$_saved_runner_tool_cache"

# Clean up temporary variables
unset _saved_path _saved_home _saved_user _saved_shell _saved_term _saved_lang
unset _saved_tmpdir _saved_pwd _saved_oldpwd _saved_wizardry_dir _saved_wizardry_invoked
unset _saved_spellbook_dir _saved_mud_dir _saved_log_level _saved_nix_pkg _saved_apt_pkg
unset _saved_yum_pkg _saved_zypper_pkg _saved_pacman_pkg _saved_apk_pkg _saved_pkgin_pkg
unset _saved_brew_pkg _saved_test_failure _saved_test_skip _saved_wiz_tmpdir
unset _saved_global_subtest _saved_test_compiled _saved_test_helpers _saved_system_path
unset _saved_ask_input _saved_choose_input _saved_menu_loop_limit _saved_require_command
unset _saved_menu_log _saved_await_buffer_file _saved_assume_yes
unset _saved_force_install _saved_root_dir
unset _saved_platform _saved_rc_file _saved_rc_format _saved_await_keep_raw
unset _saved_disable_sandbox _saved_bwrap_warning _saved_colors_available
unset _saved_github_env _saved_github_path _saved_github_output _saved_github_step_summary
unset _saved_github_workspace _saved_github_action _saved_github_actions _saved_github_actor
unset _saved_github_repository _saved_github_sha _saved_github_ref _saved_github_ref_name
unset _saved_github_head_ref _saved_github_base_ref _saved_runner_os _saved_runner_temp
unset _saved_runner_tool_cache _var

# Re-enable strict mode for the calling spell
# The spell set `-eu` before sourcing this file, so we restore that state
set -eu

# Return 0 explicitly (some shells exit with the exit code of the last unset)
exit 0
