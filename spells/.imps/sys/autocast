#!/bin/sh
# autocast [SPELL_NAME]
# Automatically execute spell function when sourced, while still allowing direct execution.
# Use for environment setup spells that define variables (like colors).
# SPELL_NAME is optional - if not provided, autocast will detect the true-name function.
# Example: autocast colors
# Example: autocast  (auto-detects function)

set -eu

autocast_name=${1:-}
[ "$#" -gt 0 ] && shift  # Remove first arg if present

# Try to detect spell name if not provided
if [ -z "$autocast_name" ]; then
  autocast_name=${0##*/}  # Equivalent to basename, avoids external command
fi

# Detect if being executed vs sourced
autocast_executed=0
autocast_base=${0##*/}
case "$autocast_base" in
  sh|dash|bash|zsh|ksh|mksh)
    autocast_executed=0  # sourced
    # When sourced, basename might be shell name, try to find actual function
    if [ -z "$autocast_name" ] || [ "$autocast_name" = "$autocast_base" ]; then
      # Try common function name patterns based on caller's file name
      # Check if any snake_case function exists that isn't internal
      autocast_name=""
      autocast_func=""
    fi
    ;;
  *)
    # Check if executed directly
    if [ "$autocast_base" = "$autocast_name" ]; then
      autocast_executed=1
    else
      autocast_executed=0  # sourced from another script
    fi
    ;;
esac

# Determine function name to call
autocast_func=""
if [ -n "$autocast_name" ]; then
  # Convert hyphenated spell name to underscored function name (pure shell)
  autocast_func="$autocast_name"
  autocast_i=0
  while [ "$autocast_i" -lt 20 ]; do
    case "$autocast_func" in
      *-*)
        autocast_func="${autocast_func%%-*}_${autocast_func#*-}"
        autocast_i=$((autocast_i + 1))
        ;;
      *)
        break
        ;;
    esac
  done
fi

# If we don't have a function name yet, we're being sourced without explicit name
# The spell should have defined its true-name function already
# Just return silently - this is fine for spells that don't follow autocast pattern
if [ -z "$autocast_func" ]; then
  exit 0
fi

# If executed directly, call the function with remaining arguments
if [ "$autocast_executed" -eq 1 ]; then
  if command -v "$autocast_func" >/dev/null 2>&1; then
    "$autocast_func" "$@"
  else
    # Function not found - this is an error when executed
    printf '%s\n' "autocast: function $autocast_func not found" >&2
    exit 2
  fi
else
  # If sourced, automatically call the function (this is what makes it "autocast")
  # Only call if function exists - silently skip if not
  if command -v "$autocast_func" >/dev/null 2>&1; then
    "$autocast_func" "$@"
  fi
fi
exit 0
