#!/bin/sh
# autocast SPELL_NAME
# Automatically execute spell function when sourced, while still allowing direct execution.
# Use for environment setup spells that define variables (like colors).
# Example: autocast colors

set -eu

_autocast() {
  _autocast_name=${1:-}
  
  if [ -z "$_autocast_name" ]; then
    _autocast_name=$(basename "${0-}")
  fi
  
  # Convert hyphenated name to underscored function name
  _autocast_func=$(printf '%s' "$_autocast_name" | tr '-' '_')
  
  # Detect if being executed vs sourced
  _autocast_executed=0
  if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
    case "${ZSH_EVAL_CONTEXT-}" in
      *:file) _autocast_executed=0 ;;  # sourced
      *) _autocast_executed=1 ;;  # executed
    esac
  else
    _autocast_base=${0##*/}
    case "$_autocast_base" in
      sh|dash|bash|zsh|ksh|mksh) _autocast_executed=0 ;;  # sourced
      "$_autocast_name") _autocast_executed=1 ;;  # executed directly
      *) _autocast_executed=0 ;;  # probably sourced
    esac
  fi
  
  # If executed directly, call the function with arguments
  if [ "$_autocast_executed" -eq 1 ]; then
    if command -v "$_autocast_func" >/dev/null 2>&1; then
      "$_autocast_func" "$@"
    else
      printf '%s\n' "autocast: function $_autocast_func not found" >&2
      return 2
    fi
  else
    # If sourced, automatically call the function (this is what makes it "autocast")
    if command -v "$_autocast_func" >/dev/null 2>&1; then
      "$_autocast_func"
    fi
  fi
}

# Self-execute when run directly (not sourced)
case "$0" in
  */autocast) _autocast "$@" ;; esac
