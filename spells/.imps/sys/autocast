#!/bin/sh
# autocast [SPELL_NAME]
# Automatically execute spell function when sourced, while still allowing direct execution.
# Use for environment setup spells that define variables (like colors).
# SPELL_NAME is optional - if not provided, autocast will detect the true-name function.
# Example: autocast colors
# Example: autocast  (auto-detects function)

set -eu

# Detect if being executed vs sourced FIRST, before consuming arguments
_autocast_executed=0
_autocast_base=${0##*/}
case "$_autocast_base" in
  sh|dash|bash|zsh|ksh|mksh)
    _autocast_executed=0  # sourced
    ;;
  autocast)
    _autocast_executed=1  # executed directly as a command
    ;;
  *)
    # Could be sourced from another script - check ZSH_EVAL_CONTEXT if available
    if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
      case "${ZSH_EVAL_CONTEXT-}" in
        *:file) _autocast_executed=0 ;; # sourced
        *) _autocast_executed=1 ;; # executed
      esac
    else
      # In POSIX shells, if $0 basename isn't a shell name, assume executed
      # This isn't perfect but works for most cases
      _autocast_executed=1
    fi
    ;;
esac

# Determine spell name based on context
_autocast_name=""
if [ "$_autocast_executed" -eq 1 ]; then
  # When executed as a command, accept spell name as argument
  _autocast_name=${1:-}
  [ "$#" -gt 0 ] && shift
  
  # If no argument provided, try to detect from $0
  if [ -z "$_autocast_name" ]; then
    _autocast_name=${0##*/}
  fi
else
  # When sourced, ALWAYS use $0 (the calling script's name)
  # Never consume arguments - they belong to the calling script
  _autocast_name=${0##*/}
fi

  # Determine function name to call
  _autocast_func=""
  if [ -n "$_autocast_name" ]; then
    # Convert hyphenated spell name to underscored function name (pure shell)
    _autocast_func="$_autocast_name"
    _autocast_i=0
    while [ "$_autocast_i" -lt 20 ]; do
      case "$_autocast_func" in
        *-*)
          _autocast_func="${_autocast_func%%-*}_${_autocast_func#*-}"
          _autocast_i=$((_autocast_i + 1))
          ;;
        *)
          break
          ;;
      esac
    done
  fi

  # If we don't have a function name yet, we're being sourced without explicit name
  # The spell should have defined its true-name function already
  # Just return silently - this is fine for spells that don't follow autocast pattern
  if [ -z "$_autocast_func" ]; then
  return 0
  fi

  # If executed directly, call the function with remaining arguments
  if [ "$_autocast_executed" -eq 1 ]; then
    if command -v "$_autocast_func" >/dev/null 2>&1; then
      "$_autocast_func" "$@"
    else
      # Function not found - this is an error when executed
      printf '%s\n' "autocast: function $_autocast_func not found" >&2
      exit 2
    fi
  else
    # If sourced, automatically call the function (this is what makes it "autocast")
    # Only call if function exists - silently skip if not
    if command -v "$_autocast_func" >/dev/null 2>&1; then
      "$_autocast_func" "$@"
    fi
  fi
