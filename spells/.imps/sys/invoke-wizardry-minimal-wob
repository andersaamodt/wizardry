#!/bin/sh
# invoke-wizardry - set up wizardry environment at shell startup
# MINIMAL word-of-binding implementation for spiral debug Phase 1
# Source this script to enable on-demand spell loading.

# Ensure baseline PATH before anything else (macOS may have empty PATH)

invoke_wizardry_minimal_wob() {
  baseline_path="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  case ":${PATH-}:" in
    *":/usr/bin:"*|*":/bin:"*) ;;
    *)
      PATH="${baseline_path}${PATH:+:}${PATH-}"
      export PATH
      ;;
  esac

  # Permissive mode - this file is sourced into user's shell
  set +eu

  # Prevent recursive sourcing
  if [ "${_WIZARDRY_INVOKED-}" = "1" ]; then
    return 0
  fi
  _WIZARDRY_INVOKED=1
  export _WIZARDRY_INVOKED

  invoke_wizardry() {
    # Detect WIZARDRY_DIR
    if [ -z "${WIZARDRY_DIR-}" ]; then
      # Capture script path - in bash use BASH_SOURCE, in zsh use $0
      _iw_script_path=""
      if eval '[ -n "${BASH_VERSION-}" ]' 2>/dev/null; then
        _iw_script_path=$(eval 'printf "%s" "${BASH_SOURCE[0]-}"')
      elif [ -n "${ZSH_VERSION-}" ]; then
        _iw_script_path="$0"
      fi
    
      # Fallback to command -v
      if [ -z "$_iw_script_path" ]; then
        _iw_script_path=$(command -v invoke-wizardry 2>/dev/null | head -1) || :
      fi
    
      # Fallback to default location
      if [ -z "$_iw_script_path" ] && [ -n "${HOME-}" ]; then
        _iw_script_path="$HOME/.wizardry/spells/.imps/sys/invoke-wizardry"
      fi
    
      # Derive WIZARDRY_DIR from script path
      if [ -n "$_iw_script_path" ] && [ -f "$_iw_script_path" ]; then
        _iw_script_dir=$(CDPATH= cd -- "$(dirname "$_iw_script_path")" 2>/dev/null && pwd -P) || :
        if [ -n "$_iw_script_dir" ]; then
          WIZARDRY_DIR=$(CDPATH= cd -- "$_iw_script_dir/../../.." 2>/dev/null && pwd -P) || :
        fi
      fi
    fi
  
    # Validate WIZARDRY_DIR
    if [ -z "${WIZARDRY_DIR-}" ] || [ ! -d "${WIZARDRY_DIR-}/spells" ]; then
      printf '%s\n' "invoke-wizardry: ERROR - WIZARDRY_DIR not found" >&2
      return 1
    fi
  
    export WIZARDRY_DIR
  
    # Set up SPELLBOOK_DIR
    : "${SPELLBOOK_DIR:=${HOME-}/.spellbook}"
    export SPELLBOOK_DIR
  
    # Wizardry initialization complete (minimal mode)
    return 0
  }

  # Run the setup
  invoke_wizardry
  _iw_status=$?
  return $_iw_status
}

# Self-execute when run directly (not sourced)
case "$0" in
  */invoke-wizardry-minimal-wob) invoke_wizardry_minimal_wob "$@" ;; esac