#!/bin/sh
# invoke-thesaurus - load or reload synonyms (aliases) into the current shell
# Source this script to activate synonyms without restarting your shell.
# Also initializes default synonyms if not already set up.

# This script must be sourced, not executed
case "$0" in
  */invoke-thesaurus|invoke-thesaurus)
    printf '%s\n' "invoke-thesaurus: must be sourced, not executed" >&2
    printf '%s\n' "Usage: . invoke-thesaurus" >&2
    exit 1
    ;;
esac

# Explicitly use permissive mode - this file is sourced into user's shell
set +eu

_invoke_thesaurus() {
  : "${SPELLBOOK_DIR:=${HOME-}/.spellbook}"
  
  _it_custom_file="${SPELLBOOK_DIR}/.synonyms"
  _it_default_file="${SPELLBOOK_DIR}/.default-synonyms"
  
  # Initialize custom synonyms file if it doesn't exist
  if [ ! -f "$_it_custom_file" ]; then
    mkdir -p "$SPELLBOOK_DIR" 2>/dev/null || true
    cat > "$_it_custom_file" << 'HEADER'
# Wizardry Custom Synonyms
# This file contains your custom shell aliases.
# Loaded automatically by invoke-wizardry at shell startup.
# Reload with: . invoke-thesaurus

HEADER
  fi
  
  # Initialize default synonyms file if it doesn't exist
  _it_default_initialized="${SPELLBOOK_DIR}/.default-synonyms-initialized"
  if [ ! -f "$_it_default_initialized" ]; then
    mkdir -p "$SPELLBOOK_DIR" 2>/dev/null || true
    cat > "$_it_default_file" << 'HEADER'
# Wizardry Default Synonyms
# These are built-in synonyms that can be reset with reset-default-synonyms.
# To override a default, add your custom version to .synonyms instead.

HEADER
    
    # Define default synonyms (word -> spell)
    # Spell synonyms
    _it_defaults="detect-os detect-distro
home jump
ls-magic identify-room
read-file read-magic
copy-file copy
move-file move
delete-file trash
remove-file trash
erase-file trash
edit-file edit-magic
find-file file-list
search-file file-list
list-files file-list
where-am-i identify-room
where identify-room
goto jump
cd-to jump
teleport jump
portal jump"
    
    # Also add common system command aliases
    _it_defaults="$_it_defaults
delete rm
remove rm
erase rm
list ls
show cat
display cat
copy cp
move mv
rename mv
link ln
make-link ln
directory pwd
where-is which
find-command which"
    
    printf '%s\n' "$_it_defaults" | while IFS=' ' read -r _word _spell; do
      [ -n "$_word" ] && [ -n "$_spell" ] || continue
      printf "alias %s='%s'\n" "$_word" "$_spell" >> "$_it_default_file"
    done
    
    touch "$_it_default_initialized" 2>/dev/null || true
  fi
  
  # Check if synonyms are enabled
  _it_enabled_file="${SPELLBOOK_DIR}/.synonyms-enabled"
  _it_enabled=1
  if [ -f "$_it_enabled_file" ]; then
    _it_enabled=$(cat "$_it_enabled_file" 2>/dev/null || printf '1')
    case $_it_enabled in
      0) _it_enabled=0 ;;
      *) _it_enabled=1 ;;
    esac
  fi
  
  if [ "$_it_enabled" -eq 0 ]; then
    printf '%s\n' "invoke-thesaurus: synonyms are disabled" >&2
    printf '%s\n' "Enable synonyms through the thesaurus menu or by running:" >&2
    printf '%s\n' "  printf '1' > \$SPELLBOOK_DIR/.synonyms-enabled" >&2
    return 1
  fi
  
  # Check if default synonyms are enabled
  _it_default_enabled_file="${SPELLBOOK_DIR}/.default-synonyms-enabled"
  _it_default_enabled=1
  if [ -f "$_it_default_enabled_file" ]; then
    _it_default_enabled=$(cat "$_it_default_enabled_file" 2>/dev/null || printf '1')
    case $_it_default_enabled in
      0) _it_default_enabled=0 ;;
      *) _it_default_enabled=1 ;;
    esac
  fi
  
  # Check if custom synonyms are enabled
  _it_custom_enabled_file="${SPELLBOOK_DIR}/.custom-synonyms-enabled"
  _it_custom_enabled=1
  if [ -f "$_it_custom_enabled_file" ]; then
    _it_custom_enabled=$(cat "$_it_custom_enabled_file" 2>/dev/null || printf '1')
    case $_it_custom_enabled in
      0) _it_custom_enabled=0 ;;
      *) _it_custom_enabled=1 ;;
    esac
  fi
  
  # Source both files to load all aliases
  # Default synonyms first, then custom (so custom can override)
  _it_count=0
  
  if [ "$_it_default_enabled" -eq 1 ] && [ -f "$_it_default_file" ]; then
    # shellcheck disable=SC1090
    . "$_it_default_file" 2>/dev/null || true
    _it_default_count=$(grep -c "^alias " "$_it_default_file" 2>/dev/null || printf '0')
    # Ensure it's a valid number
    case "$_it_default_count" in
      ''|*[!0-9]*) _it_default_count=0 ;;
    esac
    _it_count=$((_it_count + _it_default_count))
  fi
  
  if [ "$_it_custom_enabled" -eq 1 ] && [ -f "$_it_custom_file" ]; then
    # shellcheck disable=SC1090
    . "$_it_custom_file" 2>/dev/null || true
    _it_custom_count=$(grep -c "^alias " "$_it_custom_file" 2>/dev/null || printf '0')
    # Ensure it's a valid number
    case "$_it_custom_count" in
      ''|*[!0-9]*) _it_custom_count=0 ;;
    esac
    _it_count=$((_it_count + _it_custom_count))
  fi
  
  # Don't print during shell initialization - it can block terminal on macOS
  # Only print if explicitly requested (INVOKE_THESAURUS_VERBOSE=1)
  if [ "${INVOKE_THESAURUS_VERBOSE-}" = "1" ]; then
    printf '%s\n' "invoke-thesaurus: loaded $_it_count synonym(s)"
  fi
  return 0
}

# Run the function
_invoke_thesaurus
