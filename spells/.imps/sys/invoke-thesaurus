#!/bin/sh
# invoke-thesaurus - load or reload synonyms (aliases) into the current shell
# Source this script to activate synonyms without restarting your shell.
# Also initializes default synonyms if not already set up.

# This script must be sourced, not executed

# Uncastable pattern - ensures spell is sourced, not executed
it_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) it_sourced=1 ;;
  esac
else
  it_base=${0##*/}
  case "$it_base" in
    sh|dash|bash|zsh|ksh|mksh) it_sourced=1 ;;
    invoke-thesaurus) it_sourced=0 ;;
    *) it_sourced=1 ;;
  esac
fi

if [ "$it_sourced" -eq 0 ]; then
  printf '%s\n' "This spell cannot be cast directly. Invoke it with: . invoke-thesaurus" >&2
  return 1 2>/dev/null || exit 1
fi
unset it_sourced _it_base

# Explicitly use permissive mode - this file is sourced into user's shell

# Use global SPELLBOOK_DIR if set, otherwise use default
# Use a local variable to avoid modifying the global
if [ -n "${SPELLBOOK_DIR-}" ]; then
  it_spellbook_dir="${SPELLBOOK_DIR-}"
else
  it_spellbook_dir="${HOME-}/.spellbook"
fi

# Determine wizardry directory for spell detection
if [ -n "${WIZARDRY_DIR-}" ]; then
  it_wizardry_dir="${WIZARDRY_DIR-}"
else
  it_wizardry_dir="${HOME-}/.wizardry"
fi

it_custom_file="${it_spellbook_dir}/.synonyms"
it_default_file="${it_spellbook_dir}/.default-synonyms"

# Initialize custom synonyms file if it doesn't exist
if [ ! -f "$it_custom_file" ]; then
  mkdir -p "$it_spellbook_dir" 2>/dev/null || true
  cat > "$it_custom_file" << 'HEADER'
# Wizardry Custom Synonyms
# This file contains your custom shell aliases.
# Loaded automatically by invoke-wizardry at shell startup.
# Reload with: . invoke-thesaurus

HEADER
fi

# Initialize default synonyms file if it doesn't exist
it_default_initialized="${it_spellbook_dir}/.default-synonyms-initialized"
if [ ! -f "$it_default_initialized" ]; then
  mkdir -p "$it_spellbook_dir" 2>/dev/null || true
  cat > "$it_default_file" << 'HEADER'
# Wizardry Default Synonyms
# Format: word=target
# These are built-in synonyms that can be reset with reset-default-synonyms.
# To override a default, add your custom version to .synonyms instead.

HEADER
  
  # Define default synonyms (word -> spell)
  # Spell synonyms (sorted alphabetically)
  it_defaults="cd-to jump-to-marker
copy-file copy
delete-file trash
detect-os detect-distro
edit-file edit-magic
erase-file trash
find-file file-list
goto jump-to-marker
home jump-to-marker
jump jump-to-marker
jump-to-location jump-to-marker
list-files file-list
ls-magic identify-room
mark mark-location
move-file move
portal jump-to-marker
read-file read-magic
remove-file trash
search-file file-list
teleport jump-to-marker
up go-up
where identify-room
where-am-i identify-room"
  
  # Also add common system command aliases (sorted alphabetically)
  it_defaults="$it_defaults
copy cp
delete rm
directory pwd
display cat
erase rm
find-command which
link ln
list ls
make-link ln
move mv
remove rm
rename mv
show cat
where-is which"
  
  printf '%s\n' "$it_defaults" | while IFS=' ' read -r _word _spell; do
    [ -n "$_word" ] && [ -n "$_spell" ] || continue
    
    # Write in equals format: word=target
    printf "%s=%s\n" "$_word" "$_spell" >> "$it_default_file"
  done
  
  touch "$it_default_initialized" 2>/dev/null || true
fi

# Check if synonyms are enabled
it_enabled_file="${it_spellbook_dir}/.synonyms-enabled"
it_enabled=1
if [ -f "$it_enabled_file" ]; then
  it_enabled=$(cat "$it_enabled_file" 2>/dev/null || printf '1')
  case $it_enabled in
    0) it_enabled=0 ;;
    *) it_enabled=1 ;;
  esac
fi

if [ "$it_enabled" -eq 0 ]; then
  # Synonyms disabled - print message to stderr for visibility
  printf '%s\n' "invoke-thesaurus: synonyms are disabled" >&2
  return 0
fi

# Check if default synonyms are enabled
it_default_enabled_file="${it_spellbook_dir}/.default-synonyms-enabled"
it_default_enabled=1
if [ -f "$it_default_enabled_file" ]; then
  it_default_enabled=$(cat "$it_default_enabled_file" 2>/dev/null || printf '1')
  case $it_default_enabled in
    0) it_default_enabled=0 ;;
    *) it_default_enabled=1 ;;
  esac
fi

# Check if custom synonyms are enabled
it_custom_enabled_file="${it_spellbook_dir}/.custom-synonyms-enabled"
it_custom_enabled=1
if [ -f "$it_custom_enabled_file" ]; then
  it_custom_enabled=$(cat "$it_custom_enabled_file" 2>/dev/null || printf '1')
  case $it_custom_enabled in
    0) it_custom_enabled=0 ;;
    *) it_custom_enabled=1 ;;
  esac
fi

# Load synonyms via generate-glosses
# Synonyms are now in simple word=target format in the files
# generate-glosses creates functions/aliases and we eval them
it_count=0

if command -v generate-glosses >/dev/null 2>&1; then
  # Generate glosses and eval them into current shell
  if _it_gloss_output=$(generate-glosses --quiet 2>&1); then
    if [ -n "$_it_gloss_output" ]; then
      eval "$_it_gloss_output"
      
      # Count synonyms (approximate - count functions and aliases in output)
      it_count=$(printf '%s' "$_it_gloss_output" | grep -c "^alias \|() {" || printf '0')
    fi
  else
    printf '%s\n' "invoke-thesaurus: generate-glosses failed" >&2
  fi
else
  printf '%s\n' "invoke-thesaurus: generate-glosses not found" >&2
fi

# Only print loading message if WIZARDRY_DEBUG is enabled
if [ "${WIZARDRY_DEBUG-}" = "1" ]; then
  printf '%s\n' "invoke-thesaurus: loaded $it_count function(s) and alias(es)"
fi
return 0

# Run the function

