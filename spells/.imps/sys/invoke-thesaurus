#!/bin/sh
# invoke-thesaurus - load or reload synonyms (aliases) into the current shell
# Source this script to activate synonyms without restarting your shell.
# Also initializes default synonyms if not already set up.

# This script must be sourced, not executed
# Guard against direct execution (inline check instead of calling uncastable)
_it_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) _it_sourced=1 ;;
  esac
else
  _it_base=${0##*/}
  case "$_it_base" in
    sh|dash|bash|zsh|ksh|mksh) _it_sourced=1 ;;
    invoke-thesaurus) _it_sourced=0 ;;
    *) _it_sourced=1 ;;
  esac
fi

if [ "$_it_sourced" -eq 0 ]; then
  printf '%s\n' "invoke-thesaurus: must be sourced, not executed" >&2
  printf '%s\n' "Usage: . invoke-thesaurus" >&2
  exit 1
fi
unset _it_sourced _it_base

# Explicitly use permissive mode - this file is sourced into user's shell

# Use global SPELLBOOK_DIR if set, otherwise use default
# Use a local variable to avoid modifying the global
if [ -n "${SPELLBOOK_DIR-}" ]; then
  _it_spellbook_dir="${SPELLBOOK_DIR-}"
else
  _it_spellbook_dir="${HOME-}/.spellbook"
fi

# Determine wizardry directory for spell detection
if [ -n "${WIZARDRY_DIR-}" ]; then
  _it_wizardry_dir="${WIZARDRY_DIR-}"
else
  _it_wizardry_dir="${HOME-}/.wizardry"
fi

_it_custom_file="${_it_spellbook_dir}/.synonyms"
_it_default_file="${_it_spellbook_dir}/.default-synonyms"

# Initialize custom synonyms file if it doesn't exist
if [ ! -f "$_it_custom_file" ]; then
  mkdir -p "$_it_spellbook_dir" 2>/dev/null || true
  cat > "$_it_custom_file" << 'HEADER'
# Wizardry Custom Synonyms
# This file contains your custom shell aliases.
# Loaded automatically by invoke-wizardry at shell startup.
# Reload with: . invoke-thesaurus

HEADER
fi

# Initialize default synonyms file if it doesn't exist
_it_default_initialized="${_it_spellbook_dir}/.default-synonyms-initialized"
if [ ! -f "$_it_default_initialized" ]; then
  mkdir -p "$_it_spellbook_dir" 2>/dev/null || true
  cat > "$_it_default_file" << 'HEADER'
# Wizardry Default Synonyms
# These are built-in synonyms that can be reset with reset-default-synonyms.
# To override a default, add your custom version to .synonyms instead.

HEADER
  
  # Define default synonyms (word -> spell)
  # Spell synonyms (sorted alphabetically)
  _it_defaults="cd-to jump-to-marker
copy-file copy
delete-file trash
detect-os detect-distro
edit-file edit-magic
erase-file trash
find-file file-list
goto jump-to-marker
home jump-to-marker
jump jump-to-marker
list-files file-list
ls-magic identify-room
mark mark-location
move-file move
portal jump-to-marker
read-file read-magic
remove-file trash
search-file file-list
teleport jump-to-marker
where identify-room
where-am-i identify-room"
  
  # Also add common system command aliases (sorted alphabetically)
  _it_defaults="$_it_defaults
copy cp
delete rm
directory pwd
display cat
erase rm
find-command which
link ln
list ls
make-link ln
move mv
remove rm
rename mv
show cat
where-is which"
  
  # Helper function to check if a spell must be sourced
  # Checks the spell file for uncastable usage (the standard way to enforce sourcing)
  _it_spell_must_be_sourced() {
    _spell_name="$1"
    _spell_path=""
    
    # Try to find the spell in wizardry directories
    if [ -f "${_it_wizardry_dir}/spells/$_spell_name" ]; then
      _spell_path="${_it_wizardry_dir}/spells/$_spell_name"
    else
      # Try to find in common spell directories
      _spell_dirs="translocation cantrips arcane divination enchant psi"
      _spell_dirs="$_spell_dirs crypto wards mud spellcraft menu system"
      for _dir in $_spell_dirs; do
        if [ -f "${_it_wizardry_dir}/spells/${_dir}/${_spell_name}" ]; then
          _spell_path="${_it_wizardry_dir}/spells/${_dir}/${_spell_name}"
          break
        fi
      done
    fi
    
    # If spell file found, check for uncastable usage
    if [ -n "$_spell_path" ] && [ -f "$_spell_path" ]; then
      # Read first 30 lines and check if spell sources or checks for uncastable
      if head -30 "$_spell_path" 2>/dev/null | grep -q "uncastable"; then
        return 0
      fi
    fi
    return 1
  }
  
  printf '%s\n' "$_it_defaults" | while IFS=' ' read -r _word _spell; do
    [ -n "$_word" ] && [ -n "$_spell" ] || continue
    
    # Write as simple key-value pair (synonym files should be inert)
    # generate-glosses will convert these to appropriate aliases/functions
    printf "%s %s\n" "$_word" "$_spell" >> "$_it_default_file"
  done
  
  touch "$_it_default_initialized" 2>/dev/null || true
fi

# Check if synonyms are enabled
_it_enabled_file="${_it_spellbook_dir}/.synonyms-enabled"
_it_enabled=1
if [ -f "$_it_enabled_file" ]; then
  _it_enabled=$(cat "$_it_enabled_file" 2>/dev/null || printf '1')
  case $_it_enabled in
    0) _it_enabled=0 ;;
    *) _it_enabled=1 ;;
  esac
fi

if [ "$_it_enabled" -eq 0 ]; then
  # Synonyms disabled - print message to stderr for visibility
  printf '%s\n' "invoke-thesaurus: synonyms are disabled" >&2
  return 0
fi

# Check if default synonyms are enabled
_it_default_enabled_file="${_it_spellbook_dir}/.default-synonyms-enabled"
_it_default_enabled=1
if [ -f "$_it_default_enabled_file" ]; then
  _it_default_enabled=$(cat "$_it_default_enabled_file" 2>/dev/null || printf '1')
  case $_it_default_enabled in
    0) _it_default_enabled=0 ;;
    *) _it_default_enabled=1 ;;
  esac
fi

# Check if custom synonyms are enabled
_it_custom_enabled_file="${_it_spellbook_dir}/.custom-synonyms-enabled"
_it_custom_enabled=1
if [ -f "$_it_custom_enabled_file" ]; then
  _it_custom_enabled=$(cat "$_it_custom_enabled_file" 2>/dev/null || printf '1')
  case $_it_custom_enabled in
    0) _it_custom_enabled=0 ;;
    *) _it_custom_enabled=1 ;;
  esac
fi

# Source both files to load all aliases
# Default synonyms first, then custom (so custom can override)
_it_count=0

if [ "$_it_default_enabled" -eq 1 ] && [ -f "$_it_default_file" ]; then
  # shellcheck disable=SC1090
  . "$_it_default_file" 2>/dev/null || true
  _it_default_count=$(grep -c "^alias " "$_it_default_file" 2>/dev/null || printf '0')
  # Ensure it's a valid number
  case "$_it_default_count" in
    ''|*[!0-9]*) _it_default_count=0 ;;
  esac
  _it_count=$((_it_count + _it_default_count))
fi

if [ "$_it_custom_enabled" -eq 1 ] && [ -f "$_it_custom_file" ]; then
  # shellcheck disable=SC1090
  . "$_it_custom_file" 2>/dev/null || true
  _it_custom_count=$(grep -c "^alias " "$_it_custom_file" 2>/dev/null || printf '0')
  # Ensure it's a valid number
  case "$_it_custom_count" in
    ''|*[!0-9]*) _it_custom_count=0 ;;
  esac
  _it_count=$((_it_count + _it_custom_count))
fi

# Only print loading message if WIZARDRY_DEBUG is enabled
if [ "${WIZARDRY_DEBUG-}" = "1" ]; then
  printf '%s\n' "invoke-thesaurus: loaded $_it_count synonym(s)"
fi
return 0

# Run the function

