#!/bin/sh
# invoke-thesaurus - load or reload synonyms (aliases) into the current shell
# Source this script to activate synonyms without restarting your shell.
# Also initializes default synonyms if not already set up.

# This script must be sourced, not executed
case "$0" in
  */invoke-thesaurus|invoke-thesaurus)
    printf '%s\n' "invoke-thesaurus: must be sourced, not executed" >&2
    printf '%s\n' "Usage: . invoke-thesaurus" >&2
    exit 1
    ;;
esac

# Explicitly use permissive mode - this file is sourced into user's shell
set +eu

_invoke_thesaurus() {
  : "${SPELLBOOK_DIR:=${HOME-}/.spellbook}"
  
  _it_synonyms_file="${SPELLBOOK_DIR}/.synonyms"
  
  # Initialize synonyms file if it doesn't exist
  if [ ! -f "$_it_synonyms_file" ]; then
    mkdir -p "$SPELLBOOK_DIR" 2>/dev/null || true
    cat > "$_it_synonyms_file" << 'HEADER'
# Wizardry Synonyms
# This file contains shell aliases for wizardry spells.
# Loaded automatically by invoke-wizardry at shell startup.
# Reload with: . invoke-thesaurus

HEADER
  fi
  
  # Add default synonyms if not already present
  _it_initialized="${SPELLBOOK_DIR}/.synonyms-initialized"
  if [ ! -f "$_it_initialized" ]; then
    # Define default synonyms (word -> spell)
    # Spell synonyms
    _it_defaults="detect-os detect-distro
home jump
ls-magic identify-room
read-file read-magic
copy-file copy
move-file move
delete-file trash
remove-file trash
erase-file trash
edit-file edit-magic
find-file file-list
search-file file-list
list-files file-list
where-am-i identify-room
where identify-room
goto jump
cd-to jump
teleport jump
portal jump"
    
    # Also add common system command aliases
    _it_defaults="$_it_defaults
delete rm
remove rm
erase rm
list ls
show cat
display cat
copy cp
move mv
rename mv
link ln
make-link ln
directory pwd
where-is which
find-command which"
    
    printf '%s\n' "$_it_defaults" | while IFS=' ' read -r _word _spell; do
      [ -n "$_word" ] && [ -n "$_spell" ] || continue
      if ! grep -q "^alias $_word=" "$_it_synonyms_file" 2>/dev/null; then
        printf "alias %s='%s'\n" "$_word" "$_spell" >> "$_it_synonyms_file"
      fi
    done
    
    touch "$_it_initialized" 2>/dev/null || true
  fi
  
  # Check if synonyms are enabled
  _it_enabled_file="${SPELLBOOK_DIR}/.synonyms-enabled"
  _it_enabled=1
  if [ -f "$_it_enabled_file" ]; then
    _it_enabled=$(cat "$_it_enabled_file" 2>/dev/null || printf '1')
    case $_it_enabled in
      0) _it_enabled=0 ;;
      *) _it_enabled=1 ;;
    esac
  fi
  
  if [ "$_it_enabled" -eq 0 ]; then
    printf '%s\n' "invoke-thesaurus: synonyms are disabled" >&2
    printf '%s\n' "Enable synonyms through the thesaurus menu or by running:" >&2
    printf '%s\n' "  printf '1' > \$SPELLBOOK_DIR/.synonyms-enabled" >&2
    return 1
  fi
  
  # Source the synonyms file to load all aliases
  # shellcheck disable=SC1090
  . "$_it_synonyms_file" 2>/dev/null || {
    printf '%s\n' "invoke-thesaurus: failed to load synonyms" >&2
    return 1
  }
  
  # Count number of aliases loaded
  _it_count=$(grep -c "^alias " "$_it_synonyms_file" 2>/dev/null || printf '0')
  
  printf '%s\n' "invoke-thesaurus: loaded $_it_count synonym(s)"
  return 0
}

# Run the function
_invoke_thesaurus
