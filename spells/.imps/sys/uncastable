#!/bin/sh
# uncastable [SPELL_NAME] [USAGE]
# Enforce sourced-only behavior for scripts that must not be executed.
# If SPELL_NAME is omitted, it is derived from $0.
# If USAGE is omitted, it defaults to "Usage: . <spell-name>".
# Example: uncastable invoke-thesaurus "Usage: . invoke-thesaurus"
set -eu

_uncastable() {
  _uncast_name=${1-}
  if [ -n "$_uncast_name" ]; then
    shift
  fi

  if [ -z "$_uncast_name" ]; then
    _uncast_name=$(basename "${0-}")
  fi

  _uncast_sourced=0
  if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
    case "${ZSH_EVAL_CONTEXT-}" in
      *:file) _uncast_sourced=1 ;;
    esac
  elif eval '[ -n "${BASH_VERSION+x}" ]' 2>/dev/null; then
    if [ "${BASH_SOURCE[0]-}" != "$0" ]; then
      _uncast_sourced=1
    fi
  else
    _uncast_shell=0
    case "${0##*/}" in
      sh|dash|bash|zsh|ksh|mksh) _uncast_shell=1 ;;
    esac
    if [ "$_uncast_shell" -eq 1 ] && (return 0 2>/dev/null); then
      _uncast_sourced=1
    fi
  fi

  if [ "$_uncast_sourced" -eq 1 ]; then
    return 0
  fi

  printf '%s\n' "${_uncast_name}: must be sourced, not executed" >&2
  if [ "$#" -gt 0 ]; then
    printf '%s\n' "$*" >&2
  elif [ -n "$_uncast_name" ]; then
    printf '%s\n' "Usage: . $_uncast_name" >&2
  fi
  exit 1
}

# Self-execute when run directly (not sourced)
case "$0" in
  */uncastable) _uncastable "$@" ;; esac
