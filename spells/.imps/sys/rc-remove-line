#!/bin/sh
# rc-remove-line MARKER RC_FILE - remove lines with marker from rc file
# Example: rc-remove-line cd-hook ~/.zshrc
set -eu


rrl_marker=${1:-}
rrl_rc_file=${2:-}

if [ -z "$rrl_marker" ] || [ -z "$rrl_rc_file" ]; then
  printf '%s\n' "rc-remove-line: MARKER and RC_FILE are required" >&2
  exit 1
fi

if [ ! -f "$rrl_rc_file" ]; then
  # File doesn't exist, nothing to remove
  exit 0
fi

rrl_full_marker="# wizardry: $rrl_marker"

# Check if marker exists
if ! grep -qF "$rrl_full_marker" "$rrl_rc_file" 2>/dev/null; then
  # Marker doesn't exist, nothing to remove
  exit 0
fi

# Remove lines containing the marker
rrl_tmp_file="${rrl_rc_file}.wizardry.$$"
if grep -vF "$rrl_full_marker" "$rrl_rc_file" > "$rrl_tmp_file" 2>/dev/null; then
  mv "$rrl_tmp_file" "$rrl_rc_file"
else
  rm -f "$rrl_tmp_file"
  printf '%s\n' "rc-remove-line: failed to remove marker from $rrl_rc_file" >&2
  exit 1
fi

exit 0
