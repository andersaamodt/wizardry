#!/bin/sh
# has-ancestor COMMAND - test if command is running in process ancestry
# Example: has-ancestor banish && echo "running inside banish"
# Example: has-ancestor vim && echo "running inside vim"


search_cmd=${1-}

# Require command argument
if [ -z "$search_cmd" ]; then
  return 1
fi

# Check if ps command is available
if ! command -v ps >/dev/null 2>&1; then
  # Without ps, we can't detect, so assume not in ancestry
  return 1
fi

# Walk up the process tree checking each ancestor
pid=$$
while [ "$pid" -gt 1 ]; do
  # Get parent PID - try different ps formats for portability
  ppid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ' || ps -p "$pid" -o ppid= 2>/dev/null | tr -d ' ')
  [ -z "$ppid" ] && break
  [ "$ppid" = "$pid" ] && break
  [ "$ppid" -le 1 ] && break

  # Check if parent process matches the search command
  # Try different ps command formats for portability
  cmd_name=$(ps -o comm= -p "$ppid" 2>/dev/null || ps -p "$ppid" -o comm= 2>/dev/null)
  if [ -n "$cmd_name" ]; then
    # Check if command name contains the search string
    case "$cmd_name" in
      *"$search_cmd"*) return 0 ;;
    esac
  fi

  pid=$ppid
done

return 1

