#!/bin/sh
# poll-vote - Simple polling system
set -eu

http-ok-html

poll_file="${TMPDIR:-/tmp}/wizardry-poll.txt"
choice=$(get-query-param "vote")

# Initialize poll file
if [ ! -f "$poll_file" ]; then
  printf "0 0 0\n" > "$poll_file"
fi

# Read current votes
read a b c < "$poll_file"

# Increment vote
case "$choice" in
  A) a=$((a + 1)) ;;
  B) b=$((b + 1)) ;;
  C) c=$((c + 1)) ;;
esac

# Save votes
printf "%d %d %d\n" "$a" "$b" "$c" > "$poll_file"

total=$((a + b + c))
if [ "$total" -gt 0 ]; then
  pct_a=$((a * 100 / total))
  pct_b=$((b * 100 / total))
  pct_c=$((c * 100 / total))
else
  pct_a=0 pct_b=0 pct_c=0
fi

cat <<HTML
<div id="poll-results" class="demo-result poll" style="background: transparent; border: none; padding: 1rem;">
  <h3 style="color: white; margin-top: 0;">Poll Results</h3>
  <div class="poll-option">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <span style="color: white; font-weight: bold;">ðŸ”µ Functional Programming</span>
      <span style="color: white;">$a votes (${pct_a}%)</span>
    </div>
    <div class="poll-bar" style="width: ${pct_a}%; background: rgba(255,255,255,0.5); height: 30px; border-radius: 15px;"></div>
  </div>
  <div class="poll-option">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <span style="color: white; font-weight: bold;">ðŸŸ¢ Object-Oriented</span>
      <span style="color: white;">$b votes (${pct_b}%)</span>
    </div>
    <div class="poll-bar" style="width: ${pct_b}%; background: rgba(255,255,255,0.5); height: 30px; border-radius: 15px;"></div>
  </div>
  <div class="poll-option">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <span style="color: white; font-weight: bold;">ðŸŸ¡ Procedural</span>
      <span style="color: white;">$c votes (${pct_c}%)</span>
    </div>
    <div class="poll-bar" style="width: ${pct_c}%; background: rgba(255,255,255,0.5); height: 30px; border-radius: 15px;"></div>
  </div>
  <p class="meta" style="color: rgba(255,255,255,0.8); margin-top: 1.5rem; font-size: 1rem;">Total votes: $total</p>
</div>
HTML
