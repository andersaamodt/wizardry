#!/bin/sh
# ssh-auth-list-delegates - List WebAuthn delegates for a user

set -eu

http-status 200 "OK"
http-header "Content-Type" "application/json"
http-end-headers

# Parse query parameters
username=$(get-query-param "username")

# Validate inputs
if [ -z "$username" ]; then
  printf '{"success":false,"error":"Missing username"}\n'
  exit 0
fi

# Get data directory
data_dir=$(get-site-data-dir "ssh-auth")
user_dir="$data_dir/users/$username"

# Verify user exists
if [ ! -d "$user_dir" ]; then
  printf '{"success":false,"error":"User not found"}\n'
  exit 0
fi

delegates_dir="$user_dir/delegates"
if [ ! -d "$delegates_dir" ]; then
  printf '{"success":true,"delegates":[],"fingerprint":"%s"}\n' "$(cat "$user_dir/ssh_fingerprint")"
  exit 0
fi

# List all delegates
fingerprint=$(cat "$user_dir/ssh_fingerprint")
printf '{"success":true,"fingerprint":"%s","delegates":[' "$fingerprint"

first=1
if [ -d "$delegates_dir" ]; then
  for delegate_file in "$delegates_dir"/*; do
    if [ ! -f "$delegate_file" ]; then
      continue
    fi
    
    if [ "$first" -eq 0 ]; then
      printf ','
    fi
    first=0
    
    delegate_id=$(basename "$delegate_file")
    credential_id=$(grep -o '"credential_id":"[^"]*"' "$delegate_file" | cut -d'"' -f4)
    created_at=$(grep -o '"created_at":"[^"]*"' "$delegate_file" | cut -d'"' -f4)
    
    printf '{"delegate_id":"%s","credential_id":"%s","created_at":"%s"}' \
      "$delegate_id" "$credential_id" "$created_at"
  done
fi

printf ']}\n'
