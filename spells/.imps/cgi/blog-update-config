#!/bin/sh
# blog-update-config - Update blog configuration (admin only)

set -eu

http-status 200 "OK"
http-header "Content-Type" "application/json"
http-end-headers

# Parse query parameters
session_token=$(get-query-param "session_token")
registration_enabled=$(get-query-param "registration_enabled")
site_title=$(get-query-param "site_title")
theme=$(get-query-param "theme")

# Validate session
if [ -z "$session_token" ]; then
  printf '{"success":false,"error":"Not authenticated"}\n'
  exit 0
fi

# Get data directory
data_dir=$(get-site-data-dir "ssh-auth")
sessions_dir="$data_dir/sessions"
session_file="$sessions_dir/$session_token"

# Check if session exists
if [ ! -f "$session_file" ]; then
  printf '{"success":false,"error":"Invalid session"}\n'
  exit 0
fi

# Get username from session
username=$(grep -o '"username":"[^"]*"' "$session_file" | cut -d'"' -f4)

# Check if user is admin
is_admin="false"
if id "$username" >/dev/null 2>&1; then
  if id -nG "$username" 2>/dev/null | grep -q "blog-admin"; then
    is_admin="true"
  fi
fi

if [ "$is_admin" != "true" ]; then
  printf '{"success":false,"error":"Admin permission required"}\n'
  exit 0
fi

# Update site config
site_root=$(get-site-data-dir "..")
site_config="$site_root/site.conf"

# Create or update config file
if [ -n "$registration_enabled" ]; then
  config-set "$site_config" registration_enabled "$registration_enabled"
fi

if [ -n "$site_title" ]; then
  config-set "$site_config" site_title "$site_title"
fi

if [ -n "$theme" ]; then
  config-set "$site_config" theme "$theme"
fi

printf '{"success":true,"message":"Configuration updated"}\n'
