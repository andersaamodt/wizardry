#!/bin/sh
# chat-rename-avatar - Rename a user's avatar in a chat room
set -eu

http-ok-html

# Parse POST data from stdin (format: room=ROOM&old_user=OLD&new_user=NEW)
if [ "${REQUEST_METHOD:-}" = "POST" ]; then
  post_data=$(cat)
else
  # Fallback to query string
  post_data="${QUERY_STRING:-}"
fi

# Parse parameters using get-query-param
room_name=$(get-query-param "room" "$post_data")
old_user=$(get-query-param "old_user" "$post_data")
new_user=$(get-query-param "new_user" "$post_data")

# Validate inputs
if [ -z "$room_name" ] || [ -z "$old_user" ] || [ -z "$new_user" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room, old username, and new username required</p>
</div>
HTML
  exit 0
fi

# Chat rooms directory - use site-specific location
CHAT_DIR=$(get-site-data-dir "chatrooms")
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room not found</p>
</div>
HTML
  exit 0
fi

# Check if old avatar exists
old_avatar="$ROOM_DIR/.$old_user"
if [ ! -d "$old_avatar" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Old avatar not found</p>
</div>
HTML
  exit 0
fi

# Check if new avatar already exists
new_avatar="$ROOM_DIR/.$new_user"
if [ -d "$new_avatar" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>New username already exists</p>
</div>
HTML
  exit 0
fi

# Rename the avatar folder
if mv "$old_avatar" "$new_avatar" 2>/dev/null; then
  # Log the name change with duplicate detection
  LOG_FILE="$ROOM_DIR/.log"
  timestamp=$(log-timestamp)
  chat-log-if-unique "$LOG_FILE" "[$timestamp] log: $old_user changed their name to $new_user."
  
  cat <<HTML
<div class="demo-result success">
  <p>âœ“ Avatar renamed</p>
</div>
HTML
else
  cat <<HTML
<div class="demo-result error">
  <p>Failed to rename avatar</p>
</div>
HTML
fi
