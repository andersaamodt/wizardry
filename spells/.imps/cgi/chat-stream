#!/bin/sh
# chat-stream - SSE endpoint for real-time chat messages (VERSION: 2026-01-31-v30-TAIL-F)
# Streams chat messages as Server-Sent Events using tail -f for immediate delivery
# Self-contained - no external imp dependencies
# Accepts query parameter: room=ROOM&since=TIMESTAMP
#
# CONCURRENCY: Each fcgiwrap worker handles one connection. Configure fcgiwrap with
# multiple workers (-c N) to support N concurrent SSE connections. Default: 10 workers.

set -eu

# Diagnostic logging
printf '[chat-stream] ========== v30-TAIL-F: Using tail -f for real-time delivery ==========\n' >&2
printf '[chat-stream] QUERY_STRING: %s\n' "${QUERY_STRING:-}" >&2

# Send SSE headers
http-status 200 "OK"
http-header "Content-Type" "text/event-stream"
http-header "Cache-Control" "no-cache"
http-header "Connection" "keep-alive"
printf '\r\n'

# SSE event sender - simple, no padding needed
send_sse_event() {
  event_type="$1"
  event_data="$2"
  printf 'event: %s\ndata: %s\n\n' "$event_type" "$event_data"
}

# Parse room name from query string
room_name="${QUERY_STRING:-}"
room_name=$(printf '%s' "$room_name" | sed 's/.*room=\([^&]*\).*/\1/')
room_name=$(url-decode "$room_name" || printf '%s' "$room_name")
room_name=$(printf '%s' "$room_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# Validate room name
if ! printf '%s' "$room_name" | grep -q '^[a-zA-Z0-9_ -]\+$'; then
  printf '[chat-stream] ERROR: Invalid room name\n' >&2
  send_sse_event error "Invalid room name"
  exit 0
fi

# Parse optional 'since' timestamp
since_timestamp=""
if printf '%s' "${QUERY_STRING:-}" | grep -q 'since='; then
  since_timestamp=$(printf '%s' "${QUERY_STRING:-}" | sed 's/.*since=\([^&]*\).*/\1/')
  since_timestamp=$(url-decode "$since_timestamp" || printf '%s' "$since_timestamp")
  since_timestamp=$(printf '%s' "$since_timestamp" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
fi

if [ -z "$room_name" ]; then
  send_sse_event error "No room specified"
  exit 0
fi

# Chat rooms directory
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
ROOM_DIR="$CHAT_DIR/$room_name"
LOG_FILE="$ROOM_DIR/.log"

printf '[chat-stream] Room: %s, Log: %s\n' "$room_name" "$LOG_FILE" >&2

if [ ! -d "$ROOM_DIR" ]; then
  send_sse_event error "Room not found"
  exit 0
fi

# Send initial batch of messages
if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
  if [ -n "$since_timestamp" ]; then
    # Filter messages after 'since' timestamp
    while IFS= read -r line || [ -n "$line" ]; do
      msg_timestamp=$(printf '%s' "$line" | sed 's/^\[\([^]]*\)\].*/\1/')
      latest=$(printf '%s\n%s' "$msg_timestamp" "$since_timestamp" | sort | tail -1)
      if [ "$latest" = "$msg_timestamp" ]; then
        send_sse_event message "$line"
      fi
    done < "$LOG_FILE"
  else
    # Send last 50 messages
    tail -50 "$LOG_FILE" 2>/dev/null | while IFS= read -r line; do
      send_sse_event message "$line"
    done
  fi
fi

# Send initial members list
if [ -f "$ROOM_DIR/.members" ]; then
  members_json=$(cat "$ROOM_DIR/.members" 2>/dev/null || printf '[]')
  send_sse_event members "$members_json"
fi

printf '[chat-stream] Initial messages sent, starting tail -f...\n' >&2

# Use tail -f to watch for new messages in real-time
# tail -f uses kqueue (macOS) / inotify (Linux) for immediate notification
# No polling delay - messages appear within milliseconds
tail -f "$LOG_FILE" 2>/dev/null | while IFS= read -r line; do
  send_sse_event message "$line"
done &
tail_pid=$!

# Watch members file for changes
while true; do
  sleep 2
  if [ -f "$ROOM_DIR/.members" ]; then
    members_json=$(cat "$ROOM_DIR/.members" 2>/dev/null || printf '[]')
    send_sse_event members "$members_json"
  fi
  
  # Check if room still exists
  if [ ! -d "$ROOM_DIR" ]; then
    printf '[chat-stream] Room deleted, exiting\n' >&2
    kill $tail_pid 2>/dev/null || true
    exit 0
  fi
  
  # Send periodic comment to keep connection alive
  printf ': keepalive\n\n'
done
