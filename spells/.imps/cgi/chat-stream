#!/bin/sh
# chat-stream - SSE endpoint for real-time chat messages
# Streams chat messages as Server-Sent Events
# Accepts query parameter: room=ROOM&since=TIMESTAMP
set -eu

# Start SSE stream
sse-start

# Parse room name from query string
room_name="${QUERY_STRING:-}"
room_name=$(printf '%s' "$room_name" | sed 's/.*room=\([^&]*\).*/\1/')
room_name=$(url-decode "$room_name" || printf '%s' "$room_name")
room_name=$(printf '%s' "$room_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# Parse optional 'since' timestamp from query string
since_timestamp=""
if printf '%s' "${QUERY_STRING:-}" | grep -q 'since='; then
  since_timestamp=$(printf '%s' "${QUERY_STRING:-}" | sed 's/.*since=\([^&]*\).*/\1/')
  since_timestamp=$(url-decode "$since_timestamp" || printf '%s' "$since_timestamp")
  since_timestamp=$(printf '%s' "$since_timestamp" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
fi

if [ -z "$room_name" ]; then
  sse-event error "No room specified"
  exit 0
fi

# Chat rooms directory - use site-specific location
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  sse-event error "Room not found"
  exit 0
fi

LOG_FILE="$ROOM_DIR/.log"

# Send initial batch of messages
if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
  # If since timestamp provided, filter messages after that timestamp
  if [ -n "$since_timestamp" ]; then
    # Filter messages that come after the 'since' timestamp
    # Format: [YYYY-MM-DD HH:MM:SS] username: message
    # Compare timestamps directly (they're in ISO-like format)
    tail -200 "$LOG_FILE" | while IFS= read -r line || [ -n "$line" ]; do
      # Extract timestamp from line
      msg_timestamp=$(printf '%s' "$line" | sed 's/^\[\([^]]*\)\].*/\1/')
      
      # Compare timestamps lexicographically (works for ISO format)
      if [ "$msg_timestamp" '>' "$since_timestamp" ] 2>/dev/null || [ "$msg_timestamp" = "$since_timestamp" ]; then
        sse-event message "$line"
      fi
    done
  else
    # Send last 200 messages if no 'since' provided
    tail -200 "$LOG_FILE" | while IFS= read -r line || [ -n "$line" ]; do
      sse-event message "$line"
    done
  fi
  
  # Record the last line count for tracking new messages
  last_line_count=$(wc -l < "$LOG_FILE" 2>/dev/null || echo "0")
else
  # No messages yet
  sse-event empty "No messages yet"
  last_line_count=0
fi

# Keep connection alive and stream new messages
# Poll the log file for changes every 1 second
# This is more reliable than tail -f in CGI context
heartbeat_counter=0
while true; do
  sleep 1
  
  # Check if log file has new lines
  if [ -f "$LOG_FILE" ]; then
    current_line_count=$(wc -l < "$LOG_FILE" 2>/dev/null || echo "0")
    
    if [ "$current_line_count" -gt "$last_line_count" ]; then
      # New messages available - send them
      new_message_count=$((current_line_count - last_line_count))
      tail -n "$new_message_count" "$LOG_FILE" | while IFS= read -r line || [ -n "$line" ]; do
        sse-event message "$line"
      done
      last_line_count=$current_line_count
      heartbeat_counter=0  # Reset heartbeat counter
    fi
  fi
  
  # Send heartbeat comment every 15 seconds to keep connection alive
  heartbeat_counter=$((heartbeat_counter + 1))
  if [ "$heartbeat_counter" -ge 15 ]; then
    printf ': heartbeat\n\n'
    heartbeat_counter=0
  fi
done
