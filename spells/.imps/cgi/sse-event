#!/bin/sh
# sse-event EVENT_TYPE DATA - Output SSE event with padding
# Adds padding to force fcgiwrap buffer flush on macOS
# Example: sse-event message "Hello world"
set -eu

event_type="${1:-message}"
# Only shift if we have at least one argument
if [ $# -gt 0 ]; then
  shift
fi
data="${*:-}"

# Output event type
printf 'event: %s\n' "$event_type"

# Output data (can be multi-line)
printf '%s\n' "$data" | while IFS= read -r line || [ -n "$line" ]; do
  printf 'data: %s\n' "$line"
done

# CRITICAL: Add 2KB padding as SSE comment to force buffer flush
# SSE comments (lines starting with :) are ignored by browser
# But they force fcgiwrap to flush the buffer to nginx
sse-padding 2

# End event with blank line
printf '\n'
