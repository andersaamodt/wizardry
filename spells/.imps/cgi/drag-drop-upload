#!/bin/sh
# drag-drop-upload - Handle drag-and-drop file uploads with auto-display

set -eu

# Only handle POST requests
if [ "${REQUEST_METHOD:-}" != "POST" ]; then
  http-status 405 "Method Not Allowed"
  http-header "Content-Type" "text/html"
  http-end-headers
  printf '<p>Only POST requests allowed</p>\n'
  exit 0
fi

# Create uploads directory if needed
WEB_ROOT=${WEB_WIZARDRY_ROOT:-$HOME/sites}
# Try to extract site name from script path or use default
SITE_NAME=${SITE_NAME:-$(basename "$(pwd)")}
UPLOAD_DIR="$WEB_ROOT/$SITE_NAME/site/uploads"
mkdir -p "$UPLOAD_DIR"

# Read multipart boundary from Content-Type header
boundary=$(printf '%s' "${CONTENT_TYPE:-}" | sed 's/.*boundary=//')

if [ -z "$boundary" ]; then
  http-status 200 "OK"
  http-header "Content-Type" "text/html"
  http-end-headers
  printf '<p class="error">No boundary found in Content-Type</p>\n'
  exit 0
fi

# Save uploaded content to temp file
temp_file=$(temp-file drag-upload)
cat > "$temp_file"

# Extract filename from Content-Disposition header
content_disp=$(grep -a "Content-Disposition" "$temp_file" | head -1)
filename=$(printf '%s' "$content_disp" | sed 's/.*filename="//' | sed 's/".*//')
filename=$(url-decode "$filename" || echo "upload")

# Sanitize filename - remove path components
filename=$(basename "$filename")

# Generate unique filename with timestamp
timestamp=$(date +%Y-%m-%d-%H%M%S)
save_name="${timestamp}-${filename}"
save_path="$UPLOAD_DIR/$save_name"

# Extract file data - more robust approach
# Find line with blank line after Content-Type, then get everything until final boundary
awk '
BEGIN { RS="\r\n"; in_data=0; }
/^Content-Type:/ { next; }
/^$/ && !in_data { in_data=1; next; }
in_data { 
  if (index($0, "--'$boundary'") == 1) exit;
  print $0;
}
' "$temp_file" > "$save_path.tmp"

# Remove final CRLF if present
if [ -f "$save_path.tmp" ]; then
  # Use dd to copy all but last 2 bytes if file ends with CRLF
  size=$(wc -c < "$save_path.tmp")
  if [ "$size" -gt 2 ]; then
    dd if="$save_path.tmp" of="$save_path" bs=1 count=$((size - 2)) 2>/dev/null || \
      cp "$save_path.tmp" "$save_path"
  else
    cp "$save_path.tmp" "$save_path"
  fi
  rm -f "$save_path.tmp"
fi

# Detect MIME type
mime_type="application/octet-stream"
if command -v file >/dev/null 2>&1; then
  mime_type=$(file --mime-type -b "$save_path" 2>/dev/null || echo "application/octet-stream")
fi

# Get file size
file_size=$(wc -c < "$save_path" | tr -d ' ')

# Generate download URL
download_url="/uploads/$save_name"

# Generate appropriate display HTML based on MIME type
display_html=""
case "$mime_type" in
  image/*)
    img_style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;"
    display_html="<img src=\"$download_url\" alt=\"Uploaded image\" style=\"$img_style\">"
    ;;
  video/*)
    video_style="max-width: 100%; height: auto;"
    display_html="<video controls style=\"$video_style\">"
    display_html="$display_html<source src=\"$download_url\" type=\"$mime_type\">"
    display_html="${display_html}Your browser doesn't support video.</video>"
    ;;
  audio/*)
    audio_style="width: 100%;"
    display_html="<audio controls style=\"$audio_style\">"
    display_html="$display_html<source src=\"$download_url\" type=\"$mime_type\">"
    display_html="${display_html}Your browser doesn't support audio.</audio>"
    ;;
  application/pdf)
    pdf_style="border: 1px solid #ddd;"
    display_html="<embed src=\"$download_url\" type=\"application/pdf\" "
    display_html="${display_html}width=\"100%\" height=\"600px\" style=\"$pdf_style\">"
    ;;
  text/*)
    # For text files, read and display content
    content=$(cat "$save_path" | head -c 10000)
    escaped=$(printf '%s' "$content" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
    pre_style="background: #f5f5f5; padding: 1em; border-radius: 4px; overflow-x: auto;"
    display_html="<pre style=\"$pre_style\">$escaped</pre>"
    ;;
  *)
    display_html="<p><em>Preview not available for this file type ($mime_type)</em></p>"
    ;;
esac

# Clean up temp file
rm -f "$temp_file"

# Return success response
http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers
# Styles for HTML output
info_style="background: #f8f9fa; padding: 0.75em; border-radius: 4px; margin: 1em 0;"
display_style="margin: 1em 0; padding: 1em; border: 1px solid #ddd;"
display_style="$display_style border-radius: 4px; background: white;"
link_style="display: inline-block; padding: 0.5em 1em; background: #007bff;"
link_style="$link_style color: white; text-decoration: none; border-radius: 4px;"

cat <<HTML
<div class="upload-result">
  <h4 style="color: #28a745; margin-top: 0;">✓ Upload Successful!</h4>
  
  <div class="file-info" style="$info_style">
    <p style="margin: 0.25em 0;"><strong>Filename:</strong> $filename</p>
    <p style="margin: 0.25em 0;"><strong>Type:</strong> $mime_type</p>
    <p style="margin: 0.25em 0;"><strong>Size:</strong> $file_size bytes</p>
  </div>
  
  <div class="file-display" style="$display_style">
    $display_html
  </div>
  
  <p style="margin-top: 1em;">
    <a href="$download_url" download="$filename" style="$link_style">
      ⬇ Download File
    </a>
  </p>
</div>
HTML
