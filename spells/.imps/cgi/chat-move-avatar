#!/bin/sh
# Move an avatar from one room to another

set -eu

# Send HTTP headers immediately (before any processing that might fail)
http-status 200 "OK"
http-header "Content-Type" "application/json"
http-end-headers

# Read CGI parameters
read -r input || true

# Extract room name from JSON
room_pattern='"room":"[^"]*"'
room_name=$(printf '%s' "$input" | grep -o "$room_pattern" | \
  sed 's/"room":"//' | sed 's/"$//' || printf '')

# Extract username from JSON
user_pattern='"username":"[^"]*"'
user_name=$(printf '%s' "$input" | grep -o "$user_pattern" | \
  sed 's/"username":"//' | sed 's/"$//' || printf '')

# Extract old room from JSON
old_pattern='"oldRoom":"[^"]*"'
old_room=$(printf '%s' "$input" | grep -o "$old_pattern" | \
  sed 's/"oldRoom":"//' | sed 's/"$//' || printf '')

# Validate input - return JSON errors instead of HTTP errors
if [ -z "$room_name" ] || [ -z "$user_name" ] || [ -z "$old_room" ]; then
  printf '{"error":"Missing required parameters"}\n'
  exit 0
fi

# Validate username doesn't contain invalid characters (allow only alphanumeric, underscore, hyphen)
case "$user_name" in
  *[!a-zA-Z0-9_-]*)
    printf '{"error":"Username contains invalid characters"}\n'
    exit 0
    ;;
esac

# Validate room names don't contain path traversal sequences
case "$room_name" in
  *..*|*/*|*\\*)
    printf '{"error":"Invalid room name"}\n'
    exit 0
    ;;
esac

case "$old_room" in
  *..*|*/*|*\\*)
    printf '{"error":"Invalid old room name"}\n'
    exit 0
    ;;
esac

# Chat rooms directory - use site-specific location (same as other chat scripts)
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
OLD_ROOM_DIR="$CHAT_DIR/$old_room"
NEW_ROOM_DIR="$CHAT_DIR/$room_name"

# Ensure new room exists
mkdir -p "$NEW_ROOM_DIR"
touch "$NEW_ROOM_DIR/.log"

# Check if avatar exists in old room
OLD_AVATAR="$OLD_ROOM_DIR/.$user_name"
NEW_AVATAR="$NEW_ROOM_DIR/.$user_name"

if [ -d "$OLD_AVATAR" ]; then
  # Avatar exists in old room - move it
  
  # Log "left the room" in old room (before moving)
  OLD_LOG="$OLD_ROOM_DIR/.log"
  if [ -f "$OLD_LOG" ]; then
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    message="log: $user_name left the room."
    chat-log-if-unique "$OLD_LOG" "[$timestamp] $message" 2>/dev/null || true
  fi
  
  # Move avatar directory
  mv "$OLD_AVATAR" "$NEW_AVATAR" 2>/dev/null || {
    # If move fails, try copy and delete
    cp -r "$OLD_AVATAR" "$NEW_AVATAR" 2>/dev/null || true
    rm -rf "$OLD_AVATAR" 2>/dev/null || true
  }
  
  # Update last activity timestamp
  enchant "$NEW_AVATAR" "last_activity=$(date +%s)" 2>/dev/null || true
  
  # Log "joined the room" in new room
  NEW_LOG="$NEW_ROOM_DIR/.log"
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  message="log: $user_name joined the room."
  chat-log-if-unique "$NEW_LOG" "[$timestamp] $message" 2>/dev/null || true
  
  printf '{"success":true,"moved":true}\n'
else
  # Avatar doesn't exist in old room - create new one
  NEW_LOG="$NEW_ROOM_DIR/.log"
  
  # Check if avatar already exists in new room
  if [ ! -d "$NEW_AVATAR" ]; then
    # Create new avatar
    mkdir -p "$NEW_AVATAR"
    
    # Mark as web avatar
    enchant "$NEW_AVATAR" "web_avatar=1" 2>/dev/null || true
    enchant "$NEW_AVATAR" "is_avatar=1" 2>/dev/null || true
    
    # Set last activity
    enchant "$NEW_AVATAR" "last_activity=$(date +%s)" 2>/dev/null || true
    
    # Log join message
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    message="log: $user_name joined the room."
    chat-log-if-unique "$NEW_LOG" "[$timestamp] $message" 2>/dev/null || true
  fi
  
  printf '{"success":true,"moved":false,"created":true}\n'
fi
