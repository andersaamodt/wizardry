#!/bin/sh
# counter - Increment a counter stored in a file
set -eu

http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers

# Use site-specific counter in site data directory
# For local development, use "default" instead of HTTP_HOST to avoid port in path
if [ -z "${HTTP_HOST:-}" ] || printf '%s' "${HTTP_HOST}" | grep -q "localhost"; then
  site_id="default"
else
  site_id=$(printf '%s' "${HTTP_HOST}" | sed 's/[^a-zA-Z0-9]/-/g')
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
counter_dir="$SITES_DIR/.sitedata/$site_id"
mkdir -p "$counter_dir"
counter_file="$counter_dir/counter.txt"

# Initialize if doesn't exist
if [ ! -f "$counter_file" ]; then
  echo "0" > "$counter_file"
fi

# Increment
count=$(cat "$counter_file")
count=$((count + 1))
echo "$count" > "$counter_file"

cat <<HTML
<div class="demo-result counter">
  <h2>$count</h2>
  <p class="meta">Button clicks since last reset</p>
</div>
HTML
