#!/bin/sh
# get-query-param PARAM_NAME [QUERY_STRING] - extract and URL-decode a parameter from query string
# Example: get-query-param "text" "$QUERY_STRING" â†’ decoded value of text parameter
# If QUERY_STRING not provided, uses $QUERY_STRING environment variable
set -eu

param_name="${1-}"
query_string="${2:-${QUERY_STRING:-}}"

if [ -z "$param_name" ]; then
  printf ''
  exit 0
fi

if [ -z "$query_string" ]; then
  printf ''
  exit 0
fi

# Extract param=value from query string
# Handles both start of string and after & (e.g., "text=hello" and "foo=1&text=hello")
# The [?&]\\? makes the preceding separator optional, matching param at start or after &
encoded=$(printf '%s' "$query_string" | sed -n "s/.*[?&]\\?${param_name}=\\([^&]*\\).*/\\1/p" | head -1)

if [ -z "$encoded" ]; then
  printf ''
  exit 0
fi

# Decode the URL-encoded value
url-decode "$encoded"
