#!/bin/sh
# get-query-param PARAM_NAME [QUERY_STRING] - extract and URL-decode a parameter from query string
# Example: get-query-param "text" "$QUERY_STRING" â†’ decoded value of text parameter
# If QUERY_STRING not provided, uses $QUERY_STRING environment variable
set -eu

param_name="${1-}"
query_string="${2:-${QUERY_STRING:-}}"

if [ -z "$param_name" ]; then
  printf ''
  exit 0
fi

if [ -z "$query_string" ]; then
  printf ''
  exit 0
fi

# Extract param=value from query string
# First try to match param at the beginning, then anywhere after &
encoded=$(printf '%s&' "$query_string" | sed -n "s/.*[&?]${param_name}=\([^&]*\).*/\1/p" | head -1)

# If extraction failed (param not found), return empty
if [ -z "$encoded" ]; then
  # Try matching at the very start (no preceding & or ?)
  encoded=$(printf '%s' "$query_string" | sed -n "s/^${param_name}=\([^&]*\).*/\1/p")
fi

if [ -z "$encoded" ]; then
  printf ''
  exit 0
fi

# Decode the URL-encoded value
url-decode "$encoded"
