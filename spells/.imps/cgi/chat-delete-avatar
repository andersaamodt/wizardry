#!/bin/sh
# chat-delete-avatar - Delete an avatar from a chat room
set -eu

http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers

# Parse POST data from stdin (format: room=ROOM&user=USER)
if [ "${REQUEST_METHOD:-}" = "POST" ]; then
  post_data=$(cat)
else
  # Fallback to query string
  post_data="${QUERY_STRING:-}"
fi

# Parse parameters
room_name=$(printf '%s' "$post_data" | sed 's/.*room=\([^&]*\).*/\1/')
room_name=$(url-decode "$room_name" 2>/dev/null || \
  printf '%s' "$room_name" | sed 's/+/ /g;s/%20/ /g')
user_name=$(printf '%s' "$post_data" | sed 's/.*user=\([^&]*\).*/\1/')
user_name=$(url-decode "$user_name" 2>/dev/null || \
  printf '%s' "$user_name" | sed 's/+/ /g;s/%20/ /g')

# Validate inputs
if [ -z "$room_name" ] || [ -z "$user_name" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room and user required</p>
</div>
HTML
  exit 0
fi

# Chat rooms directory - use site-specific location
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room not found</p>
</div>
HTML
  exit 0
fi

# Remove avatar directory
avatar_path="$ROOM_DIR/.$user_name"

if [ -d "$avatar_path" ]; then
  # Check if it's a web avatar before logging (only log for web avatars leaving)
  is_web_avatar=0
  if read-magic "$avatar_path" "web_avatar" >/dev/null 2>&1; then
    is_web_avatar=1
  elif ! read-magic "$avatar_path" "is_avatar" >/dev/null 2>&1; then
    is_web_avatar=1
  fi
  
  # Log leave message for web avatars
  if [ "$is_web_avatar" = "1" ]; then
    LOG_FILE="$ROOM_DIR/.log"
    timestamp=$(log-timestamp)
    printf '[%s] log: %s left the room.\n' "$timestamp" "$user_name" >> "$LOG_FILE" 2>/dev/null || true
  fi
  
  rm -rf "$avatar_path" 2>/dev/null || {
    cat <<HTML
<div class="demo-result error">
  <p>Failed to delete avatar</p>
</div>
HTML
    exit 0
  }
fi

cat <<HTML
<div class="demo-result success">
  <p>âœ“ Avatar deleted</p>
</div>
HTML
