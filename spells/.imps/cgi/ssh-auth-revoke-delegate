#!/bin/sh
# ssh-auth-revoke-delegate - Revoke a WebAuthn delegate

set -eu

http-status 200 "OK"
http-header "Content-Type" "application/json"
http-end-headers

# Parse query parameters
query_string="${QUERY_STRING-}"
username=""
delegate_id=""

if [ -n "$query_string" ]; then
  for param in $(printf '%s' "$query_string" | tr '&' '\n'); do
    case "$param" in
      username=*)
        username=$(printf '%s' "$param" | cut -d= -f2- | url-decode)
        ;;
      delegate_id=*)
        delegate_id=$(printf '%s' "$param" | cut -d= -f2- | url-decode)
        ;;
    esac
  done
fi

# Validate inputs
if [ -z "$username" ] || [ -z "$delegate_id" ]; then
  printf '{"success":false,"error":"Missing username or delegate_id"}\n'
  exit 0
fi

# Get data directory
data_dir=$(get-site-data-dir "ssh-auth")
user_dir="$data_dir/users/$username"

# Verify user exists
if [ ! -d "$user_dir" ]; then
  printf '{"success":false,"error":"User not found"}\n'
  exit 0
fi

delegates_dir="$user_dir/delegates"
delegate_file="$delegates_dir/$delegate_id"

# Verify delegate exists
if [ ! -f "$delegate_file" ]; then
  printf '{"success":false,"error":"Delegate not found"}\n'
  exit 0
fi

# Remove delegate
rm -f "$delegate_file"

# Return success
printf '{"success":true,"username":"%s","delegate_id":"%s","revoked":true}\n' \
  "$username" "$delegate_id"
