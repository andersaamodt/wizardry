#!/bin/sh
# chat-count-avatars - Count avatars in a chat room
set -eu

http-status 200 "OK"
http-header "Content-Type" "application/json"
http-end-headers

# Parse room name from query string
room_name="${QUERY_STRING:-}"
room_name=$(printf '%s' "$room_name" | sed 's/room=//' | sed 's/&.*//')
room_name=$(url-decode "$room_name" 2>/dev/null || printf '%s' "$room_name")

# Trim whitespace
room_name=$(printf '%s' "$room_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

if [ -z "$room_name" ]; then
  printf '{"error": "Room name required"}\n'
  exit 0
fi

# Chat rooms directory - use site-specific location
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  printf '{"error": "Room not found"}\n'
  exit 0
fi

# Auto-cleanup inactive web avatars
chat-cleanup-inactive-avatars "$ROOM_DIR"

# Count .username directories (avatars)
count=0
for avatar_dir in "$ROOM_DIR"/.*; do
  [ -d "$avatar_dir" ] || continue
  avatar_name=$(basename "$avatar_dir")
  
  # Skip . and ..
  case "$avatar_name" in
    .|..) continue ;;
    .log) continue ;;
  esac
  
  count=$((count + 1))
done

printf '{"count": %d}\n' "$count"
