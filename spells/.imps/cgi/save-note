#!/bin/sh
# save-note - CGI script that saves text to a file
set -eu

http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers

# Parse POST data from stdin
if [ "${REQUEST_METHOD:-}" = "POST" ]; then
  note=$(cat)
  note=$(printf '%s' "$note" | sed 's/note=//' | url-decode)
  
  # Use site-specific notes in site data directory
  # For local development, use "default" instead of HTTP_HOST to avoid port in path
  if [ -z "${HTTP_HOST:-}" ] || printf '%s' "${HTTP_HOST}" | grep -q "localhost"; then
    site_id="default"
  else
    site_id=$(printf '%s' "${HTTP_HOST}" | sed 's/[^a-zA-Z0-9]/-/g')
  fi
  SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
  notes_dir="$SITES_DIR/.sitedata/$site_id"
  mkdir -p "$notes_dir"
  notes_file="$notes_dir/notes.txt"
  printf '%s\n' "$note" >> "$notes_file"
  
  cat <<HTML
<div class="demo-result success">
  <p>✓ Note saved at $(date '+%H:%M:%S')</p>
  <p class="meta">Total notes: $(wc -l < "$notes_file" 2>/dev/null || echo 0)</p>
</div>
HTML
else
  cat <<HTML
<div class="demo-result error">
  <p>✗ Invalid request method</p>
</div>
HTML
fi
