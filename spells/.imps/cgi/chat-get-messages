#!/bin/sh
# chat-get-messages - Get messages from a chat room
set -eu

http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers

# Parse room name from query string
room_name="${QUERY_STRING:-}"
room_name=$(printf '%s' "$room_name" | sed 's/room=//' | sed 's/&.*//')
room_name=$(url-decode "$room_name" || printf '%s' "$room_name")

# Trim whitespace
room_name=$(printf '%s' "$room_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

if [ -z "$room_name" ]; then
  cat <<HTML
<div id="chat-messages" class="chat-display">
<div class="chat-messages">
  <p style="color: #666; font-style: italic;">Select a room to start chatting</p>
</div>
</div>
HTML
  exit 0
fi

# Chat rooms directory - use site-specific location
# Use WIZARDRY_SITE_NAME if available (set by nginx), otherwise default
if [ -n "${WIZARDRY_SITE_NAME:-}" ]; then
  site_id="$WIZARDRY_SITE_NAME"
else
  site_id="default"
fi
SITES_DIR="${WIZARDRY_SITES_DIR:-$HOME/sites}"
CHAT_DIR="$SITES_DIR/.sitedata/$site_id/chatrooms"
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  cat <<HTML
<div id="chat-messages" class="chat-display">
<div class="demo-result error">
  <p>Room not found</p>
</div>
</div>
HTML
  exit 0
fi

# Read messages from .log file (same format as MUD 'say' command)
LOG_FILE="$ROOM_DIR/.log"

if [ ! -f "$LOG_FILE" ] || [ ! -s "$LOG_FILE" ]; then
  cat <<HTML
<div id="chat-messages" class="chat-display">
<div class="chat-messages">
  <p class="meta">No messages yet. Be the first to say something!</p>
</div>
</div>
HTML
else
  cat <<HTML
<div id="chat-messages" class="chat-display">
<div class="chat-messages">
HTML
  
  # Display last 200 messages
  tail -200 "$LOG_FILE" | while IFS= read -r line; do
    # Parse format: [HH:MM] player_name: message
    # Escape HTML special characters
    escaped_line=$(printf '%s' "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
    
    # Extract username and colorize it
    # Format: [HH:MM] username: message
    if printf '%s' "$escaped_line" | grep -q '\] [^:]*:'; then
      # Extract timestamp, username, and message parts
      timestamp=$(printf '%s' "$escaped_line" | sed 's/^\(\[[^]]*\]\).*/\1/')
      rest=$(printf '%s' "$escaped_line" | sed 's/^\[[^]]*\] //')
      username=$(printf '%s' "$rest" | sed 's/:.*//')
      message=$(printf '%s' "$rest" | sed 's/[^:]*://')
      
      # Generate a color hash from username (simple hash to 0-359 for hue)
      # Use sum of character codes modulo 360
      hash=0
      for i in $(seq 1 ${#username}); do
        char=$(printf '%s' "$username" | cut -c"$i")
        # Get ASCII value and add to hash
        hash=$((hash + $(printf '%d' "'$char")))
      done
      hue=$((hash % 360))
      
      # Use HSL with fixed saturation (70%) and lightness (35%) for legibility
      # These values ensure colors are vibrant but readable on white background
      color="hsl($hue, 70%, 35%)"
      
      # Output with colored, bold username
      printf '  <div class="chat-msg">%s <span class="username" style="color: %s; font-weight: bold;">%s:</span>%s</div>\n' \
        "$timestamp" "$color" "$username" "$message"
    else
      # No username found, display as-is
      printf '  <div class="chat-msg">%s</div>\n' "$escaped_line"
    fi
  done
  
  cat <<HTML
</div>
</div>
HTML
fi
