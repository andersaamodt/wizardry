#!/bin/sh
# chat-list-avatars - List avatars in a chat room
set -eu

http-ok-json

# Parse room name from query string
room_name=$(get-query-param "room")

# Trim whitespace
room_name=$(printf '%s' "$room_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

if [ -z "$room_name" ]; then
  printf '{"error": "Room name required"}\n'
  exit 0
fi

# Chat rooms directory - use site-specific location
CHAT_DIR=$(get-site-data-dir "chatrooms")
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  printf '{"error": "Room not found"}\n'
  exit 0
fi

# List all .username directories (avatars)
printf '{"avatars": ['
first=1
for avatar_dir in "$ROOM_DIR"/.*; do
  [ -d "$avatar_dir" ] || continue
  avatar_name=$(basename "$avatar_dir")
  
  # Skip . and .. and .log
  case "$avatar_name" in
    .|..|.log) continue ;;
  esac
  
  # Check if it's a web avatar
  is_web="false"
  if get-attribute "user.web_avatar" "$avatar_dir" >/dev/null 2>&1; then
    is_web="true"
  fi
  
  # Remove leading dot from username
  username=$(printf '%s' "$avatar_name" | sed 's/^\.//')
  
  if [ "$first" -eq 1 ]; then
    first=0
  else
    printf ', '
  fi
  
  printf '{"username": "%s", "is_web": %s}' "$username" "$is_web"
done
printf ']}\n'
