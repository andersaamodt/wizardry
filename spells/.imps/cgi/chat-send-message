#!/bin/sh
# chat-send-message - Send a message to a chat room (MUD-compatible format)
set -eu

http-ok-html

# Parse POST data from stdin (format: room=ROOM&user=USER&msg=MESSAGE)
if [ "${REQUEST_METHOD:-}" = "POST" ]; then
  post_data=$(cat)
else
  # Fallback to query string
  post_data="${QUERY_STRING:-}"
fi

# Parse parameters using get-query-param
room_name=$(get-query-param "room" "$post_data")
user_name=$(get-query-param "user" "$post_data")
message=$(get-query-param "msg" "$post_data")

# Validate inputs
if [ -z "$room_name" ] || [ -z "$message" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room and message required</p>
</div>
HTML
  exit 0
fi

# Validate room name to prevent path traversal
if ! validate-room-name "$room_name"; then
  cat <<HTML
<div class="demo-result error">
  <p>Invalid room name</p>
</div>
HTML
  exit 0
fi

# Default user if not provided
if [ -z "$user_name" ]; then
  user_name="Anonymous"
fi

# Validate username
if ! validate-username "$user_name"; then
  cat <<HTML
<div class="demo-result error">
  <p>Invalid username. Only alphanumeric, underscore, and hyphen allowed.</p>
</div>
HTML
  exit 0
fi

# Sanitize username - reject reserved names that would conflict with room metadata
case "$user_name" in
  log|.log|.|..)
    cat <<HTML
<div class="demo-result error">
  <p>Invalid username. 'log' is a reserved name.</p>
</div>
HTML
    exit 0
    ;;
esac

# Chat rooms directory - use site-specific location
CHAT_DIR=$(get-site-data-dir "chatrooms")
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room not found</p>
</div>
HTML
  exit 0
fi

LOG_FILE="$ROOM_DIR/.log"

# Create or update avatar for this user using same logic as MUD incarnate
if [ ! -d "$ROOM_DIR/.$user_name" ]; then
  avatar_path=$(create-avatar "$user_name" "$ROOM_DIR" 2>/dev/null || printf '')
  # Mark as web avatar using enchant (xattr)
  if [ -n "$avatar_path" ]; then
    enchant "$avatar_path" "web_avatar=1" 2>/dev/null || true
  fi
fi

# Update last activity timestamp using enchant (xattr, not files)
current_timestamp=$(date +%s)
enchant "$ROOM_DIR/.$user_name" "last_activity=$current_timestamp" 2>/dev/null || true

# Create timestamp in full format for .log file (same as MUD)
timestamp=$(log-timestamp)

# Format message exactly like MUD 'say' command: [YYYY-MM-DD HH:MM:SS] player_name: message
log_entry="[$timestamp] $user_name: $message"

# Append to log file
# CRITICAL: Wrap in subshell to force immediate buffer flush for tail -f visibility
# Shell file append (>>) buffers output until script exits
# Subshell exits immediately, flushing buffer so chat-stream's tail -f sees write
if (printf '%s\n' "$log_entry" >> "$LOG_FILE") 2>/dev/null; then
  
  # Run cleanup after successful message send (periodic maintenance)
  # This removes avatars inactive for >5 minutes
  chat-cleanup-inactive-avatars "$ROOM_DIR" 2>/dev/null || true
  
  cat <<HTML
<div class="demo-result success">
  <p>âœ“ Message sent</p>
</div>
HTML
else
  cat <<HTML
<div class="demo-result error">
  <p>Failed to send message</p>
</div>
HTML
fi
