#!/bin/sh
# chat-create-avatar - Create an avatar for a user in a chat room
set -eu

http-ok-html

# Parse POST data from stdin (format: room=ROOM&user=USER)
if [ "${REQUEST_METHOD:-}" = "POST" ]; then
  post_data=$(cat)
else
  # Fallback to query string
  post_data="${QUERY_STRING:-}"
fi

# Parse parameters using get-query-param
room_name=$(get-query-param "room" "$post_data")
user_name=$(get-query-param "user" "$post_data")

# Validate inputs
if [ -z "$room_name" ] || [ -z "$user_name" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room and user required</p>
</div>
HTML
  exit 0
fi

# Sanitize username - reject reserved names that would conflict with room metadata
case "$user_name" in
  log|.log|.|..)
    cat <<HTML
<div class="demo-result error">
  <p>Invalid username. 'log' is a reserved name.</p>
</div>
HTML
    exit 0
    ;;
esac

# Chat rooms directory - use site-specific location
CHAT_DIR=$(get-site-data-dir "chatrooms")
ROOM_DIR="$CHAT_DIR/$room_name"

if [ ! -d "$ROOM_DIR" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Room not found</p>
</div>
HTML
  exit 0
fi

# Create avatar using the same logic as MUD incarnate spell
avatar_path=$(create-avatar "$user_name" "$ROOM_DIR" 2>&1)

if [ $? -ne 0 ] || [ -z "$avatar_path" ]; then
  cat <<HTML
<div class="demo-result error">
  <p>Failed to create avatar</p>
</div>
HTML
  exit 0
fi

# Mark as web avatar using enchant (xattr - distinguishes from MUD avatars)
enchant "$avatar_path" "web_avatar=1" >/dev/null 2>&1 || true

# Run cleanup BEFORE logging join (so AFK messages appear first)
chat-cleanup-inactive-avatars "$ROOM_DIR" 2>/dev/null || true

# Log join message (with duplicate detection to prevent spam)
LOG_FILE="$ROOM_DIR/.log"
timestamp=$(log-timestamp)
log_message="[$timestamp] log: $user_name joined the room."
chat-log-if-unique "$LOG_FILE" "$log_message" 2>/dev/null || true

cat <<HTML
<div class="demo-result success">
  <p>âœ“ Avatar created</p>
</div>
HTML
