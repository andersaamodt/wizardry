#!/bin/sh
# temperature-convert - Convert between Celsius and Fahrenheit
set -eu

http-status 200 "OK"
http-header "Content-Type" "text/html"
http-end-headers

params="${QUERY_STRING:-}"
temp_encoded=$(printf '%s' "$params" | sed 's/^temp=//' | sed 's/&.*//')
unit_encoded=$(printf '%s' "$params" | sed 's/.*unit=//' | sed 's/&.*//')
temp=$(url-decode "$temp_encoded")
unit=$(url-decode "$unit_encoded")

# Check if temp is empty or not a number
if [ -z "$temp" ] || ! printf '%s' "$temp" | grep -qE '^-?[0-9]+\.?[0-9]*$'; then
  cat <<HTML
<div class="demo-result">
  <p>Please enter a temperature</p>
</div>
HTML
else
  if [ "$unit" = "C" ]; then
    # Celsius to Fahrenheit
    result=$(printf "scale=1; ($temp * 9/5) + 32\n" | bc)
    cat <<HTML
<div class="demo-result">
  <p>${temp}째C = <strong>${result}째F</strong></p>
</div>
HTML
  else
    # Fahrenheit to Celsius
    result=$(printf "scale=1; ($temp - 32) * 5/9\n" | bc)
    cat <<HTML
<div class="demo-result">
  <p>${temp}째F = <strong>${result}째C</strong></p>
</div>
HTML
  fi
fi
