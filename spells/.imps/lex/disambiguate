#!/bin/sh
# disambiguate CMD [ARGS...] - resolve ambiguous command and execute
# When a command has multiple meanings, presents a menu to choose.
# Saves choice in $SPELLBOOK_DIR/.disambiguations for future use.

if [ $# -eq 0 ]; then
  exit 0
fi

dis_cmd=$1
shift

dis_spellbook_dir="${SPELLBOOK_DIR:-$HOME/.spellbook}"
dis_disambig_dir="$dis_spellbook_dir/.disambiguations"

if [ -f "$dis_disambig_dir/$dis_cmd" ]; then
  dis_saved_choice=$(cat "$dis_disambig_dir/$dis_cmd")
  if command -v "$dis_saved_choice" >/dev/null 2>&1; then
    "$dis_saved_choice" "$@"
    exit $?
  fi
  rm -f "$dis_disambig_dir/$dis_cmd"
fi

dis_candidates=""
dis_count=0

dis_wizardry_dir="${WIZARDRY_DIR:-$HOME/.wizardry}"
if [ -d "$dis_wizardry_dir/spells" ]; then
  dis_spell_path=$(
    find "$dis_wizardry_dir/spells" -name "$dis_cmd" \
      -type f -executable 2>/dev/null | head -1
  )
  if [ -n "$dis_spell_path" ]; then
    dis_count=$((_dis_count + 1))
    dis_candidates="${dis_candidates}${dis_count}:$dis_spell_path:wizardry spell
"
  fi
fi

# Get system command, excluding wizardry from PATH
dis_path_lines=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v wizardry)
dis_clean_path=$(echo "$dis_path_lines" | tr '\n' ':' | sed 's/:$//')
dis_sys_cmd=$(PATH="$dis_clean_path" command -v "$dis_cmd" 2>/dev/null || true)

if [ -n "$dis_sys_cmd" ]; then
  dis_count=$((_dis_count + 1))
  dis_candidates="${dis_candidates}${dis_count}:$dis_sys_cmd:system command
"
fi

if [ "$dis_count" -eq 0 ]; then
  "$dis_cmd" "$@"
  exit $?
fi

if [ "$dis_count" -eq 1 ]; then
  dis_choice_path=$(printf '%s' "$dis_candidates" | head -1 | cut -d: -f2)
  "$dis_choice_path" "$@"
  exit $?
fi

printf '%s\n' "Multiple commands match '$dis_cmd':" >&2
printf '%s' "$dis_candidates" | while IFS=: read -r dis_num dis_path dis_desc; do
  [ -z "$dis_num" ] && continue
  printf '  [%s] %s (%s)\n' "$dis_num" "$dis_path" "$dis_desc" >&2
done

printf '%s' "Choose [1-$dis_count, or 'r' to remember]: " >&2
read -r dis_choice

dis_remember=0
case $dis_choice in
  *r|*R)
    dis_remember=1
    dis_choice=$(printf '%s' "$dis_choice" | tr -d 'rR ')
    ;;
esac

if ! printf '%s' "$dis_choice" | grep -qE '^[0-9]+$'; then
  printf '%s\n' "Invalid choice." >&2
  exit 1
fi

if [ "$dis_choice" -lt 1 ] || [ "$dis_choice" -gt "$dis_count" ]; then
  printf '%s\n' "Choice out of range." >&2
  exit 1
fi

dis_chosen_path=$(printf '%s' "$dis_candidates" | sed -n "${dis_choice}p" | cut -d: -f2)

if [ "$dis_remember" -eq 1 ]; then
  mkdir -p "$dis_disambig_dir"
  printf '%s\n' "$dis_chosen_path" > "$dis_disambig_dir/$dis_cmd"
  printf '%s\n' "Remembered: '$dis_cmd' â†’ '$dis_chosen_path'" >&2
fi

"$dis_chosen_path" "$@"

