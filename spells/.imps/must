#!/bin/sh
# must TEST [ARGS...] - die with message if test fails
# Use with 'set -e' or '|| exit $?' to propagate failure to calling script
# Examples: must there /etc/config "config missing" || exit $?

test_type=$1
shift

# The last argument is the error message if more than minimum args
case "$test_type" in
file)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="file not found: $target"
  fi
  [ -f "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
dir)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="directory not found: $target"
  fi
  [ -d "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
link)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="link not found: $target"
  fi
  [ -L "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
exec)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="executable not found: $target"
  fi
  [ -x "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
readable)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="not readable: $target"
  fi
  [ -r "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
writable)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="not writable: $target"
  fi
  [ -w "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
set)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="value not provided"
  fi
  [ -n "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
there)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="path not found: $target"
  fi
  [ -e "$target" ] || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
has)
  if [ "$#" -ge 2 ]; then
    target=$1; msg=$2
  else
    target=$1; msg="command not found: $target"
  fi
  command -v "$target" >/dev/null 2>&1 || { printf '%s\n' "$msg" >&2; exit 1; }
  ;;
*)
  printf '%s\n' "must: unknown test type '$test_type'" >&2
  exit 1
  ;;
esac
