#!/bin/sh
# backup-nix-config FILE - back up nix config file before editing
# Prints backup path to stderr. Callers responsible for calling once per operation.
# Example: backup-nix-config /etc/nixos/configuration.nix
set -eu


bnc_file=${1:-}

if [ -z "$bnc_file" ]; then
  printf '%s\n' "backup-nix-config: file path required" >&2
  exit 1
fi

if [ ! -f "$bnc_file" ]; then
  exit 0
fi

bnc_timestamp=$(date +%Y%m%d%H%M%S 2>/dev/null || date +%s 2>/dev/null || printf 'pid%s' "$$")
bnc_backup="${bnc_file}.wizardry.${bnc_timestamp}"

bnc_needs_sudo=0
case $bnc_file in
  /etc/*)
    if [ ! -w "$bnc_file" ] && [ ! -w "$(dirname "$bnc_file")" ] 2>/dev/null; then
      bnc_needs_sudo=1
    fi
    ;;
esac

if [ "$bnc_needs_sudo" -eq 1 ]; then
  if command -v sudo >/dev/null 2>&1; then
    sudo cp "$bnc_file" "$bnc_backup"
  elif command -v doas >/dev/null 2>&1; then
    doas cp "$bnc_file" "$bnc_backup"
  else
    cp "$bnc_file" "$bnc_backup"
  fi
else
  cp "$bnc_file" "$bnc_backup"
fi || {
  printf '%s\n' "backup-nix-config: unable to back up '$bnc_file'" >&2
  exit 1
}

printf '%s\n' "Backed up '$bnc_file' to '$bnc_backup'" >&2
