#!/bin/sh
# list-attributes FILE - list all extended attribute keys for a file
# Tries xattr, attr, and getfattr in order, outputting keys one per line
# Returns 0 if keys found, 1 if no attributes or all helpers failed
set -eu


file=$1

# Try xattr first (macOS)
if check-attribute-tool xattr; then
  if keys=$(xattr "$file" 2>/dev/null); then
    if [ -n "$keys" ]; then
      printf '%s\n' "$keys"
  exit 0
    fi
  fi
fi

# Try attr (Linux)
if check-attribute-tool attr; then
  if keys=$(attr -l "$file" 2>/dev/null); then
    # Parse attr -l output which may be in format:
    # Attribute "key" has a value...
    # or just: key
    # Use simpler sed/awk to avoid GNU awk extensions
    parsed=$(printf '%s\n' "$keys" | sed -n 's/^Attribute "\([^"]*\)".*/\1/p')
    if [ -z "$parsed" ]; then
      # Try plain format (just key names)
      parsed=$(printf '%s\n' "$keys" | awk 'NF {print}')
    fi
    if [ -n "$parsed" ]; then
      printf '%s\n' "$parsed"
  exit 0
    fi
  fi
fi

# Try getfattr (Linux)
if check-attribute-tool getfattr; then
  if keys=$(getfattr -d "$file" 2>/dev/null); then
    parsed=$(printf '%s' "$keys" | awk -F '=' '/^# / {next} {print $1}')
    if [ -n "$parsed" ]; then
      printf '%s' "$parsed"
  exit 0
    fi
  fi
fi

exit 1
