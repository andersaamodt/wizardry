#!/bin/sh
# config-del FILE KEY - delete key from config file (atomic, safe)
# Example: config-del ~/.app/config old-key

set -eu


cd_file=${1:?config-del: file path required}
cd_key=${2:?config-del: key required}

# Validate key format
case "$cd_key" in
  *[!a-zA-Z0-9_-]*)
    printf 'config-del: invalid key format (use alphanumeric, dash, underscore only)\n' >&2
  exit 1
    ;;
  "")
    printf 'config-del: key cannot be empty\n' >&2
  exit 1
    ;;
esac

# File doesn't exist - nothing to delete
[ -f "$cd_file" ] || exit 0

# Create temp file for atomic operation
# Ensure temp dir exists
cd_tmpdir="${TMPDIR:-/tmp}"
if [ ! -d "$cd_tmpdir" ]; then
  cd_dir=$(dirname "$cd_file")
  mkdir -p "$cd_tmpdir" 2>/dev/null || cd_tmpdir="${cd_dir}"
fi
cd_tmp=$(mktemp "$cd_tmpdir/config-del.XXXXXX") || exit 1
trap 'rm -f "$cd_tmp"' EXIT HUP INT TERM

# Copy all lines except the key we're deleting
awk -F= -v key="$cd_key" '$1 != key' "$cd_file" > "$cd_tmp"

# Atomic move
if ! mv "$cd_tmp" "$cd_file"; then
  rm -f "$cd_tmp"
  trap - EXIT HUP INT TERM
  printf 'config-del: failed to update %s\n' "$cd_file" >&2
  exit 1
fi

trap - EXIT HUP INT TERM
exit 0
