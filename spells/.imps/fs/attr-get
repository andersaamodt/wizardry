#!/bin/sh
# attr-get KEY FILE - read the value of a specific extended attribute
# Tries xattr, attr, and getfattr in order
# Returns 0 and outputs value if found, 1 if not found or all helpers failed
set -eu


key=$1
file=$2

# Try xattr first (macOS)
if attr-tool-check xattr; then
  if output=$(xattr -p "$key" "$file" 2>/dev/null); then
    printf '%s' "$output"
  exit 0
  fi
fi

# Try attr (Linux)
if attr-tool-check attr; then
  if output=$(attr -g "$key" "$file" 2>/dev/null); then
    # Strip the header line from attr output
    printf '%s' "$output" | sed '1d'
  exit 0
  fi
fi

# Try getfattr (Linux)
if attr-tool-check getfattr; then
  if output=$(getfattr -n "$key" --only-values "$file" 2>/dev/null); then
    printf '%s' "$output"
  exit 0
  fi
fi

exit 1
