#!/bin/sh
# xattr-list-keys FILE - list all extended attribute keys for a file
# Tries xattr, attr, and getfattr in order, outputting keys one per line
# Returns 0 if keys found, 1 if no attributes or all helpers failed

_xattr_list_keys() {
  file=$1
  
  # Try xattr first (macOS)
  if xattr-helper-usable xattr; then
    if keys=$(xattr "$file" 2>/dev/null); then
      if [ -n "$keys" ]; then
        printf '%s\n' "$keys"
        return 0
      fi
    fi
  fi
  
  # Try attr (Linux)
  if xattr-helper-usable attr; then
    if keys=$(attr -l "$file" 2>/dev/null); then
      parsed=$(printf '%s\n' "$keys" | awk -F '"' '/Attribute/ {print $2}')
      if [ -n "$parsed" ]; then
        printf '%s\n' "$parsed"
        return 0
      fi
    fi
  fi
  
  # Try getfattr (Linux)
  if xattr-helper-usable getfattr; then
    if keys=$(getfattr -d "$file" 2>/dev/null); then
      parsed=$(printf '%s' "$keys" | awk -F '=' '/^# / {next} {print $1}')
      if [ -n "$parsed" ]; then
        printf '%s' "$parsed"
        return 0
      fi
    fi
  fi
  
  return 1
}

# Self-execute when run directly (not sourced)
case "$0" in
  */xattr-list-keys) _xattr_list_keys "$@" ;; 
esac
