#!/bin/sh
# xattr-read-batch FILE ATTR1 ATTR2 ... - read multiple extended attributes at once
# Outputs "ATTR1=value1 ATTR2=value2 ..." format with proper quoting
# Returns 0 if at least one attribute read, 1 if all failed
set -eu

file=$1
shift

# Auto-prepend user. namespace if needed
attrs=""
for attr in "$@"; do
  case "$attr" in
    *.*) attrs="$attrs $attr" ;;
    *) attrs="$attrs user.$attr" ;;
  esac
done

# Detect and cache which helper works (try direct execution for speed)
if [ -z "${XATTR_HELPER-}" ]; then
  # Try xattr first (macOS and some Linux)
  if command -v xattr >/dev/null 2>&1; then
    XATTR_HELPER=xattr
  elif command -v attr >/dev/null 2>&1; then
    XATTR_HELPER=attr
  elif command -v getfattr >/dev/null 2>&1; then
    XATTR_HELPER=getfattr
  else
    XATTR_HELPER=none
  fi
  export XATTR_HELPER
fi

if [ "$XATTR_HELPER" = "none" ]; then
  exit 1
fi

# Read all attributes efficiently
result=""
found_any=0

for attr in $attrs; do
  value=""
  case "$XATTR_HELPER" in
    xattr)
      value=$(xattr -p "$attr" "$file" 2>/dev/null || true)
      ;;
    attr)
      value=$(attr -g "$attr" "$file" 2>/dev/null | sed '1d' || true)
      ;;
    getfattr)
      value=$(getfattr -n "$attr" --only-values "$file" 2>/dev/null || true)
      ;;
  esac
  
  if [ -n "$value" ]; then
    # Strip user. prefix for output using shell parameter expansion
    case "$attr" in
      user.*) display_attr="${attr#user.}" ;;
      *) display_attr="$attr" ;;
    esac
    result="$result $display_attr=$value"
    found_any=1
  fi
done

if [ "$found_any" -eq 1 ]; then
  printf '%s\n' "${result# }"
  exit 0
fi

exit 1
