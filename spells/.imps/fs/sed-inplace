#!/bin/sh
# sed-inplace PATTERN FILE - perform in-place sed substitution portably (mac/linux)
# Example: sed-inplace 's/foo/bar/g' config.txt
set -eu

_sed_inplace() {
  _si_pattern=${1:-}
  _si_file=${2:-}

  if [ -z "$_si_pattern" ] || [ -z "$_si_file" ]; then
    printf '%s\n' "sed-inplace: requires PATTERN and FILE arguments" >&2
    return 1
  fi

  if [ ! -f "$_si_file" ]; then
    printf '%s\n' "sed-inplace: not a file: $_si_file" >&2
    return 1
  fi

  _si_tmpfile="${_si_file}.sed.$$"
  if sed "$_si_pattern" "$_si_file" > "$_si_tmpfile" 2>/dev/null; then
    mv "$_si_tmpfile" "$_si_file"
  else
    rm -f "$_si_tmpfile"
    return 1
  fi
}

# Self-execute when run directly (not sourced)
case "$0" in
  */sed-inplace) [ "${_WIZARDRY_SOURCING:-}" != "1" ] && _sed_inplace "$@" ;; esac
