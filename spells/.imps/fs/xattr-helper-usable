#!/bin/sh
# xattr-helper-usable HELPER - check if an xattr helper command is available and usable
# Returns 0 if helper is available, 1 otherwise
# Respects WIZARDRY_TEST_HELPERS_ONLY to skip system helpers during tests
set -eu

_xattr_helper_usable() {
  helper=$1
  
  # DEBUG - log to file to avoid command substitution capture
  logfile="${WIZARDRY_TMPDIR:-/tmp}/xattr-helper-usable.log"
  
  printf '[xattr-helper-usable] Checking helper: %s\n' "$helper" >> "$logfile"
  printf '[xattr-helper-usable] PATH=%s\n' "$PATH" >> "$logfile"
  
  if ! command -v "$helper" >/dev/null 2>&1; then
    printf '[xattr-helper-usable] command -v %s: NOT FOUND\n' "$helper" >> "$logfile"
    return 1
  fi
  
  helper_path=$(command -v "$helper")
  printf '[xattr-helper-usable] command -v %s=%s\n' "$helper" "$helper_path" >> "$logfile"
  printf '[xattr-helper-usable] WIZARDRY_TEST_HELPERS_ONLY=%s\n' "${WIZARDRY_TEST_HELPERS_ONLY-0}" >> "$logfile"

  if [ "${WIZARDRY_TEST_HELPERS_ONLY-0}" -eq 1 ]; then
    case "$helper_path" in
      /bin/*|/sbin/*|/usr/bin/*|/usr/sbin/*|/usr/local/bin/*|/usr/local/sbin/*|/nix/store/*)
        printf '[xattr-helper-usable] Path matches system dir, REJECTING\n' >> "$logfile"
        return 1 ;;
    esac
    printf '[xattr-helper-usable] Path is non-system, ALLOWING\n' >> "$logfile"
  fi

  printf '[xattr-helper-usable] Returning SUCCESS\n' >> "$logfile"
  return 0
}

# Self-execute when run directly (not sourced)
set -eu
case "$0" in
  */xattr-helper-usable) _xattr_helper_usable "$@" ;; 
esac
