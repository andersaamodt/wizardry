#!/bin/sh
# read-line [PROMPT] - read a line from stdin or tty, optional prompt to stderr
# Example: name=$(read-line "Enter name: ") | line=$(read-line)
# Set CHOOSE_INPUT_MODE=stdin|tty|none to override source detection
set -eu


_rl_prompt=${1:-}
[ -n "$_rl_prompt" ] && printf '%s' "$_rl_prompt" >&2

if command -v choose-input >/dev/null 2>&1; then
  _rl_src=$(choose-input) || exit 1
else
  case ${CHOOSE_INPUT_MODE:-auto} in
    stdin) _rl_src=stdin ;;
    tty)   _rl_src=tty ;;
    none)  exit 1 ;;
    *)
      # Use /dev/fd/0 instead of /dev/stdin for cross-platform compatibility
      if [ -t 0 ] || [ -p /dev/fd/0 ] || [ -s /dev/fd/0 ]; then _rl_src=stdin
      elif [ -r /dev/tty ]; then _rl_src=tty
      else exit 1; fi ;;
  esac
fi

case $_rl_src in
  stdin) IFS= read -r _rl_line || _rl_line= ;;
  tty)   IFS= read -r _rl_line </dev/tty || _rl_line= ;;
  *)     exit 1 ;;
esac

printf '%s' "$_rl_line"
