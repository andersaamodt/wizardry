#!/bin/sh
# test-bootstrap - set up wizardry shell test environment
# Sources all boot imps to provide test framework functions.

# CRITICAL: Seed a baseline PATH BEFORE set -eu and before any commands
# On macOS GitHub Actions, PATH may be completely empty, causing immediate failure
# when we try to use dirname, cd, pwd, etc. in find_repo_root
baseline_path="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
case ":${PATH-}:" in
  *":/usr/bin:"*|*":/bin:"*)
    # Already has at least one standard directory
    ;;
  *)
    # PATH is empty or missing standard directories, prepend baseline
    PATH="${baseline_path}${PATH:+:}${PATH-}"
    ;;
esac
export PATH

set -eu

# Find the repository root
_find_repo_root_inline() {
  dir=$(CDPATH= cd -- "$(dirname "${0:-$PWD}")" && pwd -P)
  while [ "$dir" != "/" ]; do
    if [ -d "$dir/spells" ] && [ -d "$dir/.tests" ]; then
      printf '%s\n' "$dir"
      return 0
    fi
    dir=$(dirname "$dir")
  done
  printf '%s\n' "$(pwd -P)"
}

ROOT_DIR=${ROOT_DIR-$(_find_repo_root_inline)}

# The baseline PATH was already set at the top of this file.
# Now add wizardry spells directories to PATH.
initial_path=$PATH
PATH="$ROOT_DIR/spells"
# Include .imps and its subdirectories (for organized imp families like input/, fs/)
if [ -d "$ROOT_DIR/spells/.imps" ]; then
  PATH="$PATH:$ROOT_DIR/spells/.imps"
  for impdir in "$ROOT_DIR"/spells/.imps/*; do
    [ -d "$impdir" ] || continue
    PATH="$PATH:$impdir"
    # Include nested subdirectories (daemonic complexes like test/boot/)
    for subdir in "$impdir"/*; do
      [ -d "$subdir" ] || continue
      PATH="$PATH:$subdir"
    done
  done
fi
for dir in "$ROOT_DIR"/spells/*; do
  [ -d "$dir" ] || continue
  PATH="$PATH:$dir"
done
PATH="$PATH:$initial_path"
export PATH
WIZARDRY_TEST_HELPERS_ONLY=1
export WIZARDRY_TEST_HELPERS_ONLY

# Save the system PATH for run_cmd to use internally
# This ensures run_cmd can always find essential utilities like mktemp, mkdir, cat, rm
# even when tests intentionally set a restricted PATH to test error conditions
WIZARDRY_SYSTEM_PATH="$initial_path"
export WIZARDRY_SYSTEM_PATH

: "${WIZARDRY_TMPDIR:=$(mktemp -d "${TMPDIR:-/tmp}/wizardry-test.XXXXXX")}" || exit 1
# Normalize path for macOS compatibility (TMPDIR ends with /)
WIZARDRY_TMPDIR=$(printf '%s' "$WIZARDRY_TMPDIR" | sed 's|//|/|g')
export WIZARDRY_TMPDIR

# Detect platform for sandbox selection
SANDBOX_PLATFORM=$(uname -s 2>/dev/null || printf 'unknown')

# Initialize sandbox availability flags
BWRAP_AVAILABLE=1
BWRAP_VIA_SUDO=0
BWRAP_USE_UNSHARE=1
BWRAP_BIN=${BWRAP_BIN-}
MACOS_SANDBOX_AVAILABLE=0
# Save the real sudo path before tests might add a stub sudo to PATH
REAL_SUDO_BIN=$(command -v sudo 2>/dev/null || true)
SANDBOX_EXEC_BIN=""

# Allow disabling sandboxing via environment variable
if [ "${WIZARDRY_DISABLE_SANDBOX-0}" = "1" ]; then
  BWRAP_AVAILABLE=0
  BWRAP_REASON="sandboxing disabled by WIZARDRY_DISABLE_SANDBOX"
  MACOS_SANDBOX_AVAILABLE=0
else
  # macOS sandboxing is disabled by default due to compatibility issues
  # Enable with WIZARDRY_ENABLE_MACOS_SANDBOX=1 if needed
  if [ "$SANDBOX_PLATFORM" = "Darwin" ] && [ "${WIZARDRY_ENABLE_MACOS_SANDBOX-0}" = "1" ]; then
    if command -v sandbox-exec >/dev/null 2>&1; then
      SANDBOX_EXEC_BIN=$(command -v sandbox-exec)
      # Test if sandbox-exec works with a simple profile
      if "$SANDBOX_EXEC_BIN" -p '(version 1) (allow default)' /usr/bin/true 2>/dev/null; then
        MACOS_SANDBOX_AVAILABLE=1
        # On macOS, prefer sandbox-exec over attempting bubblewrap
        BWRAP_AVAILABLE=0
        BWRAP_REASON="using macOS sandbox-exec instead"
      fi
    fi
  fi
fi

# Check for Linux bubblewrap (only if not using macOS sandboxing)
if [ "$MACOS_SANDBOX_AVAILABLE" -eq 0 ]; then
  if [ -z "$BWRAP_BIN" ]; then
    if command -v bwrap >/dev/null 2>&1; then
      BWRAP_BIN=$(command -v bwrap)
    else
      BWRAP_AVAILABLE=0
      BWRAP_REASON="bubblewrap not installed"
    fi
  fi

  if [ "$BWRAP_AVAILABLE" -eq 1 ]; then
    if "$BWRAP_BIN" --unshare-user-try --ro-bind / / /bin/true 2>/dev/null; then
      :
    else
      # Running bwrap via sudo causes permission issues (files created as root)
      # so we disable sandboxing if user namespaces are not available
      BWRAP_AVAILABLE=0
      BWRAP_REASON="bubblewrap unusable (user namespaces likely disabled)"
    fi
  fi

  if [ "$BWRAP_AVAILABLE" -eq 1 ] && { [ -z "$BWRAP_BIN" ] || [ ! -x "$BWRAP_BIN" ]; }; then
    BWRAP_AVAILABLE=0
    BWRAP_REASON="bubblewrap not installed"
  fi
fi

warn_once_file=${WIZARDRY_BWRAP_WARN_FILE-${TMPDIR:-/tmp}/wizardry-sandbox-warning}

if [ "$BWRAP_AVAILABLE" -eq 0 ] && [ "$MACOS_SANDBOX_AVAILABLE" -eq 0 ] && [ ! -f "$warn_once_file" ] && [ "${WIZARDRY_BWRAP_WARNING-0}" -eq 0 ]; then
  printf '%s\n' "WARNING: proceeding without sandbox isolation: $BWRAP_REASON" >&2
  WIZARDRY_BWRAP_WARNING=1
  export WIZARDRY_BWRAP_WARNING
  : >"$warn_once_file" 2>/dev/null || true
elif [ "$MACOS_SANDBOX_AVAILABLE" -eq 1 ] && [ ! -f "$warn_once_file" ]; then
  printf '%s\n' "INFO: using macOS sandbox-exec for test isolation" >&2
  : >"$warn_once_file" 2>/dev/null || true
fi

# Source all boot imps to define their true-name functions
for boot_imp in "$ROOT_DIR"/spells/.imps/test/boot/*; do
  [ -f "$boot_imp" ] || continue
  # shellcheck source=/dev/null
  . "$boot_imp"
done

# Initialize test counters
_pass_count=0
_fail_count=0
_test_index=0
_fail_detail_indices=""
