#!/bin/sh
# test-run-cmd CMD [ARGS...] - run command and output STATUS, OUTPUT, ERROR as shell
# Runs command, captures stdout/stderr/status, outputs shell code to eval.
# Example: eval "$(test-run-cmd echo hello)"

set -eu

# Save state file for output
_tmpdir=${WIZARDRY_TMPDIR:-/tmp}
_stdout=$(mktemp "$_tmpdir/stdout.XXXXXX")
_stderr=$(mktemp "$_tmpdir/stderr.XXXXXX")

_status=0
"$@" >"$_stdout" 2>"$_stderr" || _status=$?

# Output as shell variable assignments
printf 'STATUS=%d\n' "$_status"
printf 'OUTPUT=%s\n' "$(cat "$_stdout" | sed "s/'/'\\\\''/g" | { printf "'"; cat; printf "'"; })"
printf 'ERROR=%s\n' "$(cat "$_stderr" | sed "s/'/'\\\\''/g" | { printf "'"; cat; printf "'"; })"

rm -f "$_stdout" "$_stderr"
