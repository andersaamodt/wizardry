#!/bin/sh
# pty-test COMMAND [ARGS...] - run command with real PTY using script
# Example: pty-test --input "y\n" ask-yn "Proceed?"
#
# Uses the script command to allocate a real PTY for testing interactive commands.
# This works in CI environments and doesn't require /dev/tty.

set -eu

# Parse options
input_data=""
while [ "$#" -gt 0 ]; do
  case "$1" in
    --input)
      input_data="$2"
      shift 2
      ;;
    --input=*)
      input_data="${1#--input=}"
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      printf 'pty-test: unknown option: %s\n' "$1" >&2
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

if [ "$#" -lt 1 ]; then
  printf 'pty-test: command required\n' >&2
  printf 'Usage: pty-test [--input DATA] COMMAND [ARGS...]\n' >&2
  exit 1
fi

# Check if script command is available  
if ! command -v script >/dev/null 2>&1; then
  printf 'pty-test: script command not found\n' >&2
  printf 'pty-test: install util-linux for PTY testing\n' >&2
  exit 1
fi

# Provide input via stdin, or use default
if [ -n "$input_data" ]; then
  printf '%b' "$input_data" | script -q -c "$*" /dev/null 2>&1
else
  printf '\n' | script -q -c "$*" /dev/null 2>&1
fi
