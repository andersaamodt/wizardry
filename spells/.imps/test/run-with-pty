#!/bin/sh
# run-with-pty COMMAND [ARGS...] - run command with real PTY using socat
# Environment variables:
#   PTY_INPUT - input to send to the command (default: single newline)
#   PATH - inherited for command execution
#
# This helper uses socat to create a real PTY for interactive command testing.

set -eu

if [ "$#" -lt 1 ]; then
  printf 'run-with-pty: command required\n' >&2
  exit 1
fi

# Check if socat is available
if ! command -v socat >/dev/null 2>&1; then
  printf 'run-with-pty: socat not found\n' >&2
  exit 1
fi

# Create temporary directory
tmpdir=${TMPDIR:-/tmp}
test_dir=$(mktemp -d "$tmpdir/run-pty.XXXXXX")
trap 'rm -rf "$test_dir"' EXIT INT TERM

# Input to send (from env or default to newline)
input_data=${PTY_INPUT:-$'\n'}

# Create a script that runs the exact command
# Properly quote each argument
{
  printf '#!/bin/sh\n'
  printf 'export PATH=%s\n' "'$PATH'"
  printf 'exec'
  for arg in "$@"; do
    # Escape single quotes in the argument
    escaped=$(printf '%s' "$arg" | sed "s/'/'\\\\''/g")
    printf " '%s'" "$escaped"
  done
  printf '\n'
} > "$test_dir/cmd.sh"
chmod +x "$test_dir/cmd.sh"

# Use socat with stdin as input side and EXEC with PTY on output side
printf '%s' "$input_data" | timeout 5 socat - "EXEC:$test_dir/cmd.sh,pty,stderr" 2>&1 || true
