#!/bin/sh
# divine-test-environment - Detect and report test environment capabilities
#
# Outputs facts to stdout in a clearly marked section for:
# - Test logic (skip decisions)
# - CI workflow output visibility
# - read-test-failures extraction and AI context

set -eu

# ============================================================================
# Output Format
# ============================================================================
printf '=== Test Environment Facts ===\n'

# ============================================================================
# Phase 1: Platform Detection
# ============================================================================

detect_os() {
  case "$(uname -s)" in
    Linux*) printf 'linux' ;;
    Darwin*) printf 'macos' ;;
    *BSD) printf 'bsd' ;;
    *) printf 'unknown' ;;
  esac
}

detect_distro() {
  if [ -f /etc/os-release ]; then
    # shellcheck disable=SC1091
    . /etc/os-release
    case "${ID-}" in
      debian) printf 'debian' ;;
      ubuntu) printf 'ubuntu' ;;
      arch) printf 'arch' ;;
      nixos) printf 'nixos' ;;
      alpine) printf 'alpine' ;;
      *) printf 'unknown' ;;
    esac
  else
    printf 'unknown'
  fi
}

detect_arch() {
  case "$(uname -m)" in
    x86_64|amd64) printf 'x86_64' ;;
    aarch64|arm64) printf 'arm64' ;;
    i?86) printf 'i386' ;;
    *) printf 'unknown' ;;
  esac
}

TEST_ENV_OS=$(detect_os)
TEST_ENV_DISTRO=$(detect_distro)
TEST_ENV_ARCH=$(detect_arch)

printf 'Platform: %s/%s/%s\n' "$TEST_ENV_OS" "$TEST_ENV_DISTRO" "$TEST_ENV_ARCH"

# ============================================================================
# Phase 2: CI Detection
# ============================================================================

if [ "${CI-}" = "true" ] || [ "${GITHUB_ACTIONS-}" = "true" ]; then
  TEST_ENV_IS_CI=1
  printf 'CI: GitHub Actions\n'
elif [ -n "${CI-}" ]; then
  TEST_ENV_IS_CI=1
  printf 'CI: %s\n' "${CI}"
else
  TEST_ENV_IS_CI=0
  printf 'CI: no\n'
fi

# ============================================================================
# Phase 3: Tool Capabilities
# ============================================================================

has_command() {
  command -v "$1" >/dev/null 2>&1
}

# xattr tools
if has_command attr; then
  TEST_ENV_HAS_XATTR_ATTR=1
  xattr_attr="yes"
else
  TEST_ENV_HAS_XATTR_ATTR=0
  xattr_attr="no"
fi

if has_command xattr; then
  TEST_ENV_HAS_XATTR_NATIVE=1
  xattr_native="yes"
else
  TEST_ENV_HAS_XATTR_NATIVE=0
  xattr_native="no"
fi

if has_command setfattr && has_command getfattr; then
  TEST_ENV_HAS_XATTR_SETFATTR=1
  xattr_setfattr="yes"
else
  TEST_ENV_HAS_XATTR_SETFATTR=0
  xattr_setfattr="no"
fi

printf 'xattr: attr=%s xattr-native=%s setfattr=%s\n' \
  "$xattr_attr" "$xattr_native" "$xattr_setfattr"

# Core utilities
if has_command realpath; then
  TEST_ENV_HAS_REALPATH=1
  has_realpath="yes"
else
  TEST_ENV_HAS_REALPATH=0
  has_realpath="no"
fi

if has_command timeout; then
  TEST_ENV_HAS_TIMEOUT=1
  has_timeout="yes"
else
  TEST_ENV_HAS_TIMEOUT=0
  has_timeout="no"
fi

if has_command tput; then
  TEST_ENV_HAS_TPUT=1
  has_tput="yes"
else
  TEST_ENV_HAS_TPUT=0
  has_tput="no"
fi

printf 'coreutils: realpath=%s timeout=%s tput=%s\n' \
  "$has_realpath" "$has_timeout" "$has_tput"

# ============================================================================
# Phase 4: Filesystem Capabilities
# ============================================================================

# Test xattr support
test_xattr_support() {
  tmpfile=$(mktemp)
  if [ "$TEST_ENV_HAS_XATTR_ATTR" = "1" ]; then
    if attr -s test -V val "$tmpfile" >/dev/null 2>&1; then
      rm -f "$tmpfile"
      return 0
    fi
  elif [ "$TEST_ENV_HAS_XATTR_NATIVE" = "1" ]; then
    if xattr -w test val "$tmpfile" >/dev/null 2>&1; then
      rm -f "$tmpfile"
      return 0
    fi
  elif [ "$TEST_ENV_HAS_XATTR_SETFATTR" = "1" ]; then
    if setfattr -n user.test -v val "$tmpfile" >/dev/null 2>&1; then
      rm -f "$tmpfile"
      return 0
    fi
  fi
  rm -f "$tmpfile"
  return 1
}

if test_xattr_support; then
  TEST_ENV_SUPPORTS_XATTR=1
  fs_xattr="yes"
else
  TEST_ENV_SUPPORTS_XATTR=0
  fs_xattr="no"
fi

printf 'filesystem: xattr-support=%s\n' "$fs_xattr"

# ============================================================================
# Phase 5: Environment Variables
# ============================================================================

if [ -n "${USER-}" ]; then
  env_user="$USER"
elif [ -n "${LOGNAME-}" ]; then
  env_user="$LOGNAME"
else
  env_user="none"
fi

printf 'environment: user=%s\n' "$env_user"

# ============================================================================
# Close Facts Section
# ============================================================================
printf '=== End Environment Facts ===\n'

# Export all detected variables for use in tests
export TEST_ENV_OS TEST_ENV_DISTRO TEST_ENV_ARCH
export TEST_ENV_IS_CI
export TEST_ENV_HAS_XATTR_ATTR TEST_ENV_HAS_XATTR_NATIVE TEST_ENV_HAS_XATTR_SETFATTR
export TEST_ENV_SUPPORTS_XATTR
export TEST_ENV_HAS_REALPATH TEST_ENV_HAS_TIMEOUT TEST_ENV_HAS_TPUT
