#!/bin/sh
# run-test-case DESC FUNC [SPELL_PATH] - execute test function
# By default, tests use direct execution (fast, sufficient for most testing).
# Set WIZARDRY_TEST_BOTH_PATTERNS=1 to test both execution patterns.
# Set WIZARDRY_TEST_FILTER="1 2 3" to run only specific subtests by number.
set -eu

desc=$1
func=$2
spell_path=${3-}

# Increment subtest number for this test case (no globals - read from file, pass as arg)
test_index=$(cat "${WIZARDRY_TMPDIR}/_test_index")
test_index=$((_test_index + 1))
printf '%s' "$test_index" > "${WIZARDRY_TMPDIR}/_test_index"

# Check if we should filter this test (skip if not in filter list)
# NOTE: Subtest filtering is currently not working reliably
# The WIZARDRY_TEST_FILTER variable may not be preserved through all execution paths
# This feature is disabled for now
# if [ -n "${WIZARDRY_TEST_FILTER-}" ]; then
#   should_run=0
#   for filter_num in $WIZARDRY_TEST_FILTER; do
#     if [ "$filter_num" = "$test_index" ]; then
#       should_run=1
#       break
#     fi
#     done
#   
#   if [ "$should_run" -eq 0 ]; then
#     return 0
#   fi
# fi

# Direct execution (fast, sufficient for most testing)
# Run the test function and capture its exit status
if "$func"; then
  report-result "$test_index" "$desc" 0
else
  status=$?
  # Set default failure reason if not already set by assertions
  TEST_FAILURE_REASON=${TEST_FAILURE_REASON-test function failed}
  export TEST_FAILURE_REASON
  report-result "$test_index" "$desc" "$status"
fi


