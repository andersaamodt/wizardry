#!/bin/sh
# run-test-case DESC FUNC [SPELL_PATH] - execute test with dual-pattern by default
# Automatically tests both execution patterns for castable spells.
# Set WIZARDRY_TEST_SINGLE_PATTERN=1 to disable dual-pattern testing.
set -eu

_run_test_case() {
  desc=$1
  func=$2
  spell_path=${3-}
  
  # Check if dual-pattern testing is disabled
  if [ "${WIZARDRY_TEST_SINGLE_PATTERN-}" = "1" ]; then
    # Original single-pattern behavior
    _test_index=$((_test_index + 1))
    
    if [ -n "${WIZARDRY_GLOBAL_SUBTEST_NUM-}" ]; then
      WIZARDRY_GLOBAL_SUBTEST_NUM=$((WIZARDRY_GLOBAL_SUBTEST_NUM + 1))
      export WIZARDRY_GLOBAL_SUBTEST_NUM
    fi
    
    if "$func"; then
      _report_result "$desc" 0
    else
      ec=$?
      if [ "$ec" = "222" ]; then
        _skip_count=$((_skip_count + 1))
        skip_reason=${TEST_SKIP_REASON-(mode mismatch)}
        _test_skip "$desc" "$skip_reason"
        unset TEST_SKIP_REASON 2>/dev/null || true
      else
        reason=${TEST_FAILURE_REASON-}
        _report_result "$desc" 1 "$reason"
        _record_failure_detail "$_test_index"
        unset TEST_FAILURE_REASON 2>/dev/null || true
      fi
    fi
  else
    # Dual-pattern testing is the default
    _run_both_patterns "$desc" "$func" "$spell_path"
  fi
}

# Self-execution when run directly (not sourced)
case "${0##*/}" in run-test-case) _run_test_case "$@" ;; esac
