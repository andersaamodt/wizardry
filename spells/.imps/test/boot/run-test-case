#!/bin/sh
# run-test-case DESC FUNC [SPELL_PATH] - execute test function
# By default, tests use direct execution (fast, sufficient for most testing).
# Set WIZARDRY_TEST_BOTH_PATTERNS=1 to test both execution patterns.
set -eu

desc=$1
func=$2
spell_path=${3-}

# Increment subtest number for this test case (no globals - read from file, pass as arg)
_test_index=$(cat "${WIZARDRY_TMPDIR}/_test_index")
_test_index=$((_test_index + 1))
printf '%s' "$_test_index" > "${WIZARDRY_TMPDIR}/_test_index"

# Check if dual-pattern testing is explicitly requested
if [ "${WIZARDRY_TEST_BOTH_PATTERNS-}" = "1" ]; then
  # Use run-both-patterns for comprehensive validation
  run-both-patterns "$desc" "$func" "$spell_path"
else
  # Default: Direct execution (fast, sufficient for most testing)
  # Run the test function and capture its exit status
  if "$func"; then
    report-result "$_test_index" "$desc" 0
  else
    status=$?
    TEST_FAILURE_REASON="${TEST_FAILURE_REASON-test function failed}" \
      report-result "$_test_index" "$desc" "$status"
  fi
fi


