#!/bin/sh
# stub-memorize-command DIR - create memorize and forget stubs
set -eu

dir=$1
cat >"$dir/memorize" <<'STUB'
#!/bin/sh
tab_char=$(printf '\t')
case "${1-}" in
  list)
    cast_dir=${WIZARDRY_CAST_DIR:-${HOME:-.}/.spellbook}
    cast_file_default=$cast_dir/.memorized
    cast_file=${WIZARDRY_CAST_FILE:-$cast_file_default}
    cat "$cast_file" 2>/dev/null
    ;;
  dir)
    cast_dir=${WIZARDRY_CAST_DIR:-${HOME:-.}/.spellbook}
    printf '%s\n' "$cast_dir"
    ;;
  path)
    cast_dir=${WIZARDRY_CAST_DIR:-${HOME:-.}/.spellbook}
    cast_file_default=$cast_dir/.memorized
    cast_file=${WIZARDRY_CAST_FILE:-$cast_file_default}
    printf '%s\n' "$cast_file"
    ;;
  *)
    # Default: memorize a spell (single argument form)
    name=$1
    cast_dir=${WIZARDRY_CAST_DIR:-${HOME:-.}/.spellbook}
    cast_file_default=$cast_dir/.memorized
    cast_file=${WIZARDRY_CAST_FILE:-$cast_file_default}
    mkdir -p "$cast_dir"
    # Remove existing entry if present
    if [ -f "$cast_file" ]; then
      tmp=$(mktemp)
      while IFS= read -r line || [ -n "$line" ]; do
        entry_name=${line%%"$tab_char"*}
        [ "$entry_name" = "$name" ] || [ -z "$entry_name" ] && continue
        printf '%s\n' "$line" >>"$tmp"
      done <"$cast_file"
      mv "$tmp" "$cast_file"
    fi
    # Add spell to top of file
    printf '%s%s%s\n' "$name" "$tab_char" "$name" >"$cast_file.new"
    [ -f "$cast_file" ] && cat "$cast_file" >>"$cast_file.new"
    mv "$cast_file.new" "$cast_file"
    ;;
esac
STUB
chmod +x "$dir/memorize"

# Also create forget stub
cat >"$dir/forget" <<'STUB'
#!/bin/sh
tab_char=$(printf '\t')
name=$1
cast_dir=${WIZARDRY_CAST_DIR:-${HOME:-.}/.spellbook}
cast_file_default=$cast_dir/.memorized
cast_file=${WIZARDRY_CAST_FILE:-$cast_file_default}

if [ ! -f "$cast_file" ]; then
  printf '%s\n' "forget: spell '$name' is not memorized." >&2
  exit 1
fi

tmp=$(mktemp)
removed=0
while IFS= read -r line || [ -n "$line" ]; do
  entry_name=${line%%"$tab_char"*}
  if [ "$entry_name" = "$name" ]; then
    removed=1
    continue
  fi
  [ -n "$entry_name" ] && printf '%s\n' "$line" >>"$tmp"
done <"$cast_file"

if [ "$removed" -eq 0 ]; then
  rm -f "$tmp"
  printf '%s\n' "forget: spell '$name' is not memorized." >&2
  exit 1
fi

mv "$tmp" "$cast_file"
STUB
chmod +x "$dir/forget"
