#!/bin/sh
# report-result NUM DESC STATUS - record the result of a test case
# Prints PASS, FAIL, or SKIP with description, incrementing global counters.
# Uses counter files in WIZARDRY_TMPDIR for cross-imp state sharing.
# NUM is the subtest number (passed as argument, no globals)
# Reads TEST_FAILURE_REASON from environment or file for failure details
# Exit status 222 indicates a skipped test
set -eu

num=$1
desc=$2
status=$3
reason=${TEST_FAILURE_REASON-}
skip_reason=${TEST_SKIP_REASON-}

# If reason not in environment, try reading from file (for assert functions)
if [ -z "$reason" ] && [ -f "${WIZARDRY_TMPDIR}/_test_failure_reason" ]; then
  reason=$(cat "${WIZARDRY_TMPDIR}/_test_failure_reason" 2>/dev/null || true)
  # Clear the file after reading
  rm -f "${WIZARDRY_TMPDIR}/_test_failure_reason" 2>/dev/null || true
fi

# Read current counter values from files
pass_count=$(cat "${WIZARDRY_TMPDIR}/_pass_count")
fail_count=$(cat "${WIZARDRY_TMPDIR}/_fail_count")
skip_count=$(cat "${WIZARDRY_TMPDIR}/_skip_count" 2>/dev/null || printf '0')

if [ "$status" -eq 0 ]; then
  pass_count=$((pass_count + 1))
  printf '%s' "$pass_count" > "${WIZARDRY_TMPDIR}/_pass_count"
  test-pass "$num" "$desc"
elif [ "$status" -eq 222 ]; then
  # Skip status
  skip_count=$((skip_count + 1))
  printf '%s' "$skip_count" > "${WIZARDRY_TMPDIR}/_skip_count"
  test-skip "$num" "$desc" "$skip_reason"
else
  fail_count=$((fail_count + 1))
  printf '%s' "$fail_count" > "${WIZARDRY_TMPDIR}/_fail_count"
  test-fail "$num" "$desc" "$reason"
fi


