#!/bin/sh
# report-result NUM DESC STATUS - record the result of a test case
# Prints PASS, FAIL, or SKIP with description, incrementing global counters.
# Uses counter files in WIZARDRY_TMPDIR for cross-imp state sharing.
# NUM is the subtest number (passed as argument, no globals)
# Reads TEST_FAILURE_REASON or TEST_SKIP_REASON from environment
# Exit status 222 indicates a skipped test
set -eu

num=$1
desc=$2
status=$3
reason=${TEST_FAILURE_REASON-}
skip_reason=${TEST_SKIP_REASON-}

# Read current counter values from files
_pass_count=$(cat "${WIZARDRY_TMPDIR}/_pass_count")
_fail_count=$(cat "${WIZARDRY_TMPDIR}/_fail_count")
_skip_count=$(cat "${WIZARDRY_TMPDIR}/_skip_count" 2>/dev/null || printf '0')

if [ "$status" -eq 0 ]; then
  _pass_count=$((_pass_count + 1))
  printf '%s' "$_pass_count" > "${WIZARDRY_TMPDIR}/_pass_count"
  test-pass "$num" "$desc"
elif [ "$status" -eq 222 ]; then
  # Skip status
  _skip_count=$((_skip_count + 1))
  printf '%s' "$_skip_count" > "${WIZARDRY_TMPDIR}/_skip_count"
  test-skip "$num" "$desc" "$skip_reason"
else
  _fail_count=$((_fail_count + 1))
  printf '%s' "$_fail_count" > "${WIZARDRY_TMPDIR}/_fail_count"
  test-fail "$num" "$desc" "$reason"
fi


