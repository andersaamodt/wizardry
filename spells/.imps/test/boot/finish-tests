#!/bin/sh
# finish-tests - print test summary and exit with appropriate exit status
# Exits 0 if all tests passed, 1 otherwise. Prints failure indices if any.
# Provides organized failure lists by execution pattern when dual-pattern testing enabled.
# Uses counter files in WIZARDRY_TMPDIR for cross-imp state sharing.
set -eu

# Read counter values from files
pass_count=$(cat "${WIZARDRY_TMPDIR}/_pass_count")
fail_count=$(cat "${WIZARDRY_TMPDIR}/_fail_count")
skip_count=$(cat "${WIZARDRY_TMPDIR}/_skip_count" 2>/dev/null || printf '0')
fail_detail_indices=$(cat "${WIZARDRY_TMPDIR}/_fail_detail_indices" 2>/dev/null || printf '')

total=$((_pass_count + _fail_count + _skip_count))
test-summary "$pass_count" "$total" "$skip_count"

if [ "$fail_count" -gt 0 ]; then
  # Print organized failure summary (improved output to show all failures)
  if [ "${WIZARDRY_TEST_BOTH_PATTERNS-}" = "1" ]; then
    # Dual-pattern mode: show failures by pattern
    if [ -n "${WIZARDRY_DIRECT_EXEC_FAILURES-}" ] || [ -n "${WIZARDRY_SOURCED_FAILURES-}" ]; then
      printf '\n=== FAILURE SUMMARY BY EXECUTION PATTERN ===\n'
      
      if [ -n "${WIZARDRY_DIRECT_EXEC_FAILURES-}" ]; then
        printf '\n--- Direct Execution Failures [exec] ---\n'
        printf '%s\n' "$WIZARDRY_DIRECT_EXEC_FAILURES" | tr ',' '\n' | sed 's/^/  /'
      fi
      
      if [ -n "${WIZARDRY_SOURCED_FAILURES-}" ]; then
        printf '\n--- Source-Then-Invoke Failures [src] ---\n'
        printf '%s\n' "$WIZARDRY_SOURCED_FAILURES" | tr ',' '\n' | sed 's/^/  /'
      fi
      
      printf '\n=== END FAILURE SUMMARY ===\n'
    fi
  else
    # Single-pattern mode: show all failures in simple list
    if [ -n "${WIZARDRY_SOURCED_FAILURES-}" ]; then
      printf '\n=== FAILED TESTS ===\n'
      printf '%s\n' "$WIZARDRY_SOURCED_FAILURES" | tr ',' '\n' | sed 's/^/  /'
      printf '\n=== END FAILURES ===\n'
    fi
  fi
  
  # Print traditional failure detail indices (always show, fixes truncation)
  if [ -n "${fail_detail_indices-}" ]; then
    printf '\nFAIL_DETAIL:%s\n' "$fail_detail_indices"
  fi
  
  exit 1
fi
exit 0


