#!/bin/sh
# finish-tests - print test summary and return appropriate exit status
# Returns 0 if all tests passed, 1 otherwise. Prints failure indices if any.
# For dual-pattern tests, provides organized failure lists by execution pattern.
set -eu

_finish_tests() {
  total=$((_pass_count + _fail_count + ${_skip_count-0}))
  _test_summary "$_pass_count" "$total" "${_skip_count-0}"
  
  if [ "$_fail_count" -gt 0 ]; then
    # Print organized failure summary for dual-pattern tests
    if [ -n "${WIZARDRY_DIRECT_EXEC_FAILURES-}" ] || [ -n "${WIZARDRY_SOURCED_FAILURES-}" ]; then
      printf '\n=== FAILURE SUMMARY BY EXECUTION PATTERN ===\n'
      
      if [ -n "${WIZARDRY_DIRECT_EXEC_FAILURES-}" ]; then
        printf '\n--- Direct Execution Failures [exec] ---\n'
        # Convert comma-separated list to newlines for easy copying
        printf '%s\n' "$WIZARDRY_DIRECT_EXEC_FAILURES" | tr ',' '\n' | sed 's/^/  /'
      fi
      
      if [ -n "${WIZARDRY_SOURCED_FAILURES-}" ]; then
        printf '\n--- Source-Then-Invoke Failures [src] ---\n'
        # Convert comma-separated list to newlines for easy copying
        printf '%s\n' "$WIZARDRY_SOURCED_FAILURES" | tr ',' '\n' | sed 's/^/  /'
      fi
      
      printf '\n=== END FAILURE SUMMARY ===\n'
    fi
    
    # Print traditional failure detail indices
    if [ -n "$_fail_detail_indices" ]; then
      printf '\nFAIL_DETAIL:%s\n' "$_fail_detail_indices"
    fi
    
    return 1
  fi
  return 0
}

# Self-execution when run directly (not sourced)
case "${0##*/}" in finish-tests) _finish_tests "$@" ;; esac
