#!/bin/sh
# run-cmd CMD [ARGS...] - execute command in a sandboxed environment
# Captures stdout, stderr, and exit status into STATUS, OUTPUT, and ERROR.
set -eu

run_cmd() {
  # Save the caller's PATH and temporarily use the system PATH for run_cmd's
  # internal operations (mktemp, mkdir, cat, rm, pwd). This ensures run_cmd
  # works even when tests intentionally set a restricted PATH.
  _saved_path=$PATH
  PATH=${WIZARDRY_SYSTEM_PATH:-$PATH}

  _stdout=$(mktemp "${WIZARDRY_TMPDIR}/stdout.XXXXXX") || return 1
  _stderr=$(mktemp "${WIZARDRY_TMPDIR}/stderr.XXXXXX") || return 1

  workdir=${RUN_CMD_WORKDIR:-$(pwd)}
  mkdir -p "$workdir"

  sandbox=$(mktemp -d "${WIZARDRY_TMPDIR}/sandbox.XXXXXX") || return 1
  tmpdir="$sandbox/tmp"
  homedir="$sandbox/home"
  mkdir -p "$tmpdir" "$homedir"

  # Restore the caller's PATH for use in the sandbox
  PATH=$_saved_path

  if [ "${BWRAP_AVAILABLE:-0}" -eq 1 ]; then
    # Pass through test-related environment variables that tests commonly set
    # These are needed for test stubs (apt-get, pkgin, etc.) to log their actions
    # We bind both /tmp and WIZARDRY_TMPDIR explicitly to ensure test fixtures
    # and temp files are writable across different bwrap versions and systems.
    set -- \
      --die-with-parent \
      --ro-bind / / \
      --dev-bind /dev /dev \
      --bind /proc /proc \
      --bind /tmp /tmp \
      --bind "$WIZARDRY_TMPDIR" "$WIZARDRY_TMPDIR" \
      --ro-bind "$ROOT_DIR" "$ROOT_DIR" \
      --chdir "$workdir" \
      --setenv PATH "$PATH" \
      --setenv HOME "$homedir" \
      --setenv TMPDIR "$tmpdir" \
      --setenv WIZARDRY_TMPDIR "$WIZARDRY_TMPDIR" \
      -- "$@"

    # Optionally pass through test-related variables if they're set
    # (add them BEFORE the -- separator in the command)
    for envvar in \
      APT_LOG APT_EXIT PKGIN_LOG PKGIN_EXIT PKGIN_CANDIDATES \
      PACMAN_LOG PACMAN_EXIT NIX_ENV_LOG NIX_ENV_EXIT MANAGE_SYSTEM_COMMAND_NIXOS \
      DETECT_RC_FILE LOOK_RC_FILE ASK_LOG LOOK_COLORS_PATH SSHD_CONFIG \
      SPELLBOOK_DIR WIZARDRY_DIR MUD_DIR \
      WIZARDRY_SKIP_NIX_REBUILD WIZARDRY_SKIP_CONFIRM \
      WIZARDRY_INSTALL_ASSUME_YES WIZARDRY_INSTALL_DIR WIZARDRY_CORE_INSTALLER \
      DETECT_RC_FILE_PLATFORM CORE_LOG \
      GIT_LOG MOCK_TOPLEVEL PULL_STATUS REQUIRE_COMMAND \
      WIZARDRY_TEST_HELPERS_ONLY WIZARDRY_DEMO_NO_BWRAP
    do
      eval "val=\${$envvar-}"
      if [ -n "$val" ]; then
        # Insert --setenv before the -- separator
        set -- "--setenv" "$envvar" "$val" "$@"
      fi
    done

    if [ "${BWRAP_USE_UNSHARE:-1}" -eq 1 ]; then
      set -- --unshare-user-try "$@"
    fi

    if run_bwrap "$@" >"$_stdout" 2>"$_stderr"; then
      STATUS=0
    else
      STATUS=$?
    fi
  elif [ "${MACOS_SANDBOX_AVAILABLE:-0}" -eq 1 ]; then
    # Use macOS sandbox-exec for isolation
    # Export variables to subprocess environment
    export PATH="$PATH"
    export HOME="$HOME"
    export TMPDIR="$tmpdir"
    export WIZARDRY_TMPDIR="$WIZARDRY_TMPDIR"
    if [ -n "${WIZARDRY_TEST_HELPERS_ONLY:-}" ]; then
      export WIZARDRY_TEST_HELPERS_ONLY="$WIZARDRY_TEST_HELPERS_ONLY"
    fi
    
    # Export test-specific variables that tests commonly use for stubs
    [ -n "${GIT_LOG:-}" ] && export GIT_LOG
    [ -n "${REQUIRE_LOG:-}" ] && export REQUIRE_LOG
    [ -n "${MOCK_TOPLEVEL:-}" ] && export MOCK_TOPLEVEL
    [ -n "${PULL_STATUS:-}" ] && export PULL_STATUS
    [ -n "${REQUIRE_COMMAND:-}" ] && export REQUIRE_COMMAND
    
    if (cd "$workdir" && run_macos_sandbox "$@" >"$_stdout" 2>"$_stderr"); then
      STATUS=0
    else
      STATUS=$?
    fi
  else
    # Export variables to subprocess environment
    export PATH="$PATH"
    export HOME="$HOME"
    export TMPDIR="$tmpdir"
    export WIZARDRY_TMPDIR="$WIZARDRY_TMPDIR"
    if [ -n "${WIZARDRY_TEST_HELPERS_ONLY:-}" ]; then
      export WIZARDRY_TEST_HELPERS_ONLY="$WIZARDRY_TEST_HELPERS_ONLY"
    fi
    
    # Export test-specific variables that tests commonly use for stubs
    [ -n "${GIT_LOG:-}" ] && export GIT_LOG
    [ -n "${REQUIRE_LOG:-}" ] && export REQUIRE_LOG
    [ -n "${MOCK_TOPLEVEL:-}" ] && export MOCK_TOPLEVEL
    [ -n "${PULL_STATUS:-}" ] && export PULL_STATUS
    [ -n "${REQUIRE_COMMAND:-}" ] && export REQUIRE_COMMAND
    
    if (cd "$workdir" && "$@" >"$_stdout" 2>"$_stderr"); then
      STATUS=0
    else
      STATUS=$?
    fi
  fi

  # Use system PATH again for cleanup operations
  PATH=${WIZARDRY_SYSTEM_PATH:-$PATH}
  OUTPUT=$(cat "$_stdout")
  ERROR=$(cat "$_stderr")
  rm -f "$_stdout" "$_stderr"
  rm -rf "$sandbox"

  # Restore caller's PATH before returning
  PATH=$_saved_path
}


run_cmd "$@"
