#!/bin/sh
# stub-xattr STUB_DIR - create xattr/attr/setfattr/getfattr stubs
set -eu

stub_dir=$1

# Create xattr stub (macOS style)
cat >"$stub_dir/xattr" <<'STUB'
#!/bin/sh
# Simple xattr stub that tracks attributes in a temp file
case "$1" in
  -w)
    # Write: xattr -w key value file
    key=$2
    value=$3
    file=$4
    attr_file="${file}.attrs"
    # Remove existing key if present
    if [ -f "$attr_file" ]; then
      grep -v "^${key}=" "$attr_file" > "${attr_file}.tmp" 2>/dev/null || true
      mv "${attr_file}.tmp" "$attr_file" 2>/dev/null || true
    fi
    # Add new key=value
    printf '%s=%s\n' "$key" "$value" >> "$attr_file"
    ;;
  -p)
    # Read: xattr -p key file
    key=$2
    file=$3
    attr_file="${file}.attrs"
    if [ -f "$attr_file" ]; then
      value=$(grep "^${key}=" "$attr_file" 2>/dev/null | cut -d= -f2-)
      if [ -n "$value" ]; then
        printf '%s\n' "$value"
        exit 0
      fi
    fi
    exit 1
    ;;
  *)
    # List: xattr file
    file=$1
    attr_file="${file}.attrs"
    if [ -f "$attr_file" ]; then
      cut -d= -f1 < "$attr_file"
    fi
    ;;
esac
STUB
chmod +x "$stub_dir/xattr"

# Create attr stub (Linux style) - handles: attr -s key -V value file
cat >"$stub_dir/attr" <<'STUB'
#!/bin/sh
key=""; value=""; file=""
while [ $# -gt 0 ]; do
  case "$1" in
    -s) key=$2; shift 2 ;;
    -V) value=$2; shift 2 ;;
    *) file=$1; shift ;;
  esac
done
if [ -n "$key" ] && [ -n "$value" ] && [ -n "$file" ]; then
  attr_file="${file}.attrs"
  # Escape special regex characters in key for grep
  escaped_key=$(printf '%s\n' "$key" | sed 's/[.[\*^$]/\\&/g')
  if [ -f "$attr_file" ]; then
    grep -v "^${escaped_key}=" "$attr_file" > "${attr_file}.tmp" 2>/dev/null || true
    mv "${attr_file}.tmp" "$attr_file" 2>/dev/null || true
  fi
  printf '%s=%s\n' "$key" "$value" >> "$attr_file"
fi
STUB
chmod +x "$stub_dir/attr"

# Create setfattr stub (Linux style)
cat >"$stub_dir/setfattr" <<'STUB'
#!/bin/sh
key=""; value=""; file=""
while [ $# -gt 0 ]; do
  case "$1" in
    -n) key=$2; shift 2 ;;
    -v) value=$2; shift 2 ;;
    *) file=$1; shift ;;
  esac
done
if [ -n "$file" ]; then
  attr_file="${file}.attrs"
  if [ -f "$attr_file" ]; then
    grep -v "^${key}=" "$attr_file" > "${attr_file}.tmp" 2>/dev/null || true
    mv "${attr_file}.tmp" "$attr_file" 2>/dev/null || true
  fi
  printf '%s=%s\n' "$key" "$value" >> "$attr_file"
fi
STUB
chmod +x "$stub_dir/setfattr"

# Create getfattr stub (Linux style)
cat >"$stub_dir/getfattr" <<'STUB'
#!/bin/sh
key=""; file=""
while [ $# -gt 0 ]; do
  case "$1" in
    -n) key=$2; shift 2 ;;
    *) file=$1; shift ;;
  esac
done
if [ -n "$file" ]; then
  attr_file="${file}.attrs"
  if [ -f "$attr_file" ]; then
    value=$(grep "^${key}=" "$attr_file" 2>/dev/null | cut -d= -f2-)
    if [ -n "$value" ]; then
      printf '%s="%s"\n' "$key" "$value"
      exit 0
    fi
  fi
fi
exit 1
STUB
chmod +x "$stub_dir/getfattr"
