#!/bin/sh
# touch FILES... - touch hook that triggers on-touch effects for each touched file
# Example: Define as function: touch() { command touch "$@" || return $?; touch-hook "$@"; }

set -eu

# Check if touch-hook is enabled via mud-config (defaults to disabled when unset)
spell_home="${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}"
config_file="$spell_home/.mud"

touch_enabled=""
if [ -f "$config_file" ]; then
    touch_enabled=$(grep "^touch-hook=" "$config_file" 2>/dev/null | cut -d= -f2- || printf '')
fi
# Default to disabled (0) if not set
if [ -z "$touch_enabled" ]; then
    touch_enabled=$(mud-defaults touch-hook 2>/dev/null || printf '0')
fi

if [ "$touch_enabled" != "1" ]; then
    exit 0
fi

# Get avatar path
avatar_path=$(grep "^avatar-path=" "$config_file" 2>/dev/null | cut -d= -f2-)

# Process each file argument
for file in "$@"; do
    # Skip flag arguments
    case "$file" in
        -*) continue ;;
    esac
    
    # Trigger on-touch effects if trigger-on-touch is available
    if [ -n "$avatar_path" ] && [ -e "$avatar_path" ] && [ -e "$file" ]; then
        if command -v trigger-on-touch >/dev/null 2>&1; then
            trigger-on-touch "$avatar_path" "$file" 2>/dev/null || true
        fi
    fi
done
