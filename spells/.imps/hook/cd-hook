#!/bin/sh
# cd-hook - cd hook that runs look, moves avatar, and manages listening after successful directory change
# Example: Define as function: cd() { builtin cd "$@" || return $?; cd-hook; }

set -eu

# Check if cd-look is enabled via config file (defaults to enabled when unset)
config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
cd_look_value=""
if [ -f "$config_file" ]; then
    cd_look_value=$(grep "^cd-look=" "$config_file" 2>/dev/null | cut -d= -f2- || printf '')
fi
# Default to enabled (1) if not set
if [ -z "$cd_look_value" ]; then
    cd_look_value=$(mud-defaults cd-look 2>/dev/null || printf '1')
fi
if [ "$cd_look_value" = "1" ]; then
    command -v look >/dev/null 2>&1 && look 2>/dev/null || true
fi

# Check if cd-listen is enabled
cd_listen_value=""
if [ -f "$config_file" ]; then
    cd_listen_value=$(grep "^cd-listen=" "$config_file" 2>/dev/null | cut -d= -f2- || printf '')
fi
# Default to disabled (0) if not set
if [ -z "$cd_listen_value" ]; then
    cd_listen_value=$(mud-defaults cd-listen 2>/dev/null || printf '0')
fi
if [ "$cd_listen_value" = "1" ]; then
    # Stop and restart listening in the new directory
    if command -v listen >/dev/null 2>&1; then
        listen 2>/dev/null || true
    fi
fi

# Move avatar if avatar system is enabled (defaults to disabled when unset)
avatar_value=""
if [ -f "$config_file" ]; then
    avatar_value=$(grep "^avatar=" "$config_file" 2>/dev/null | cut -d= -f2- || printf '')
fi
# Default to disabled (0) if not set
if [ -z "$avatar_value" ]; then
    avatar_value=$(mud-defaults avatar 2>/dev/null || printf '0')
fi
if [ "$avatar_value" = "1" ]; then
    command -v move-avatar >/dev/null 2>&1 && move-avatar 2>/dev/null || true
fi
