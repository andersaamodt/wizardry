#!/bin/sh
# script-dir SCRIPT - resolve directory containing script (handles symlinks)
# Example: dir=$(script-dir "$0")
# Returns absolute normalized path to the directory containing the script.
# Follows symlinks to return the actual filesystem location.
set -eu


sd_script=${1:-$0}

# Extract initial directory portion
case "$sd_script" in
  */*) _sd_dir=${_sd_script%/*} ;;
  *)   _sd_dir=. ;;
esac

# Handle symlinks: follow the link if it's a symlink
# Use readlink if available; fall back to ls -l parsing
if [ -L "$sd_script" ]; then
  if command -v readlink >/dev/null 2>&1; then
    _sd_target=$(readlink "$sd_script" 2>/dev/null) || _sd_target=''
  else
    # Fallback: parse ls -l output (format: "... -> target")
    # shellcheck disable=SC2012
    _sd_target=$(ls -l "$sd_script" 2>/dev/null | sed 's/.*-> //' || true)
  fi

  if [ -n "$sd_target" ]; then
    case "$sd_target" in
      # Absolute path: extract directory
      /*) _sd_dir=${_sd_target%/*} ;;
      # Relative path with directory component: combine with current dir
      */*) _sd_dir="$sd_dir/${_sd_target%/*}" ;;
      # Just a filename (no directory): keep current _sd_dir
      *) : ;;
    esac
  fi
fi

# Convert to absolute path and normalize; return failure if cd fails
# shellcheck disable=SC1007
(CDPATH= cd -- "$sd_dir" && pwd -P) | sed 's|///*|/|g'
