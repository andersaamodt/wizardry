#!/bin/sh
# pkg ACTION PACKAGE - unified package manager operations across platforms
# Examples: pkg install git | pkg remove vim | pkg update | pkg has curl
# ACTION: install, remove, update (refresh repos), upgrade (upgrade all), has (check installed)

action=${1:-}
package=${2:-}

# Detect package manager
detect_pkg_manager() {
  if command -v apt-get >/dev/null 2>&1; then echo apt
  elif command -v dnf >/dev/null 2>&1; then echo dnf
  elif command -v pacman >/dev/null 2>&1; then echo pacman
  elif command -v brew >/dev/null 2>&1; then echo brew
  elif command -v nix-env >/dev/null 2>&1; then echo nix
  elif command -v pkgin >/dev/null 2>&1; then echo pkgin
  elif command -v apk >/dev/null 2>&1; then echo apk
  else exit 1; fi
}

pm=$(detect_pkg_manager) || { printf '%s\n' "pkg: no supported package manager found" >&2; exit 1; }

# Determine if we need sudo (not for brew or nix user packages)
need_sudo() {
  case $pm in
    brew|nix) return 1 ;;
    *) [ "$(id -u)" -ne 0 ] ;;
  esac
}

run() {
  if need_sudo && command -v sudo >/dev/null 2>&1; then
    sudo "$@"
  else
    "$@"
  fi
}

case $action in
install)
  [ -z "$package" ] && { printf '%s\n' "pkg: package name required" >&2; exit 1; }
  case $pm in
    apt)    run apt-get -y install "$package" ;;
    dnf)    run dnf -y install "$package" ;;
    pacman) run pacman --noconfirm -S "$package" ;;
    brew)   brew install "$package" ;;
    nix)    nix-env -iA "nixpkgs.$package" ;;
    pkgin)  run pkgin -y install "$package" ;;
    apk)    run apk add "$package" ;;
  esac
  ;;
remove)
  [ -z "$package" ] && { printf '%s\n' "pkg: package name required" >&2; exit 1; }
  case $pm in
    apt)    run apt-get -y remove "$package" ;;
    dnf)    run dnf -y remove "$package" ;;
    pacman) run pacman --noconfirm -R "$package" ;;
    brew)   brew uninstall "$package" ;;
    nix)    nix-env -e "$package" ;;
    pkgin)  run pkgin -y remove "$package" ;;
    apk)    run apk del "$package" ;;
  esac
  ;;
update)
  case $pm in
    apt)    run apt-get update ;;
    dnf)    run dnf check-update || [ $? -eq 100 ] ;;
    pacman) run pacman -Sy ;;
    brew)   brew update ;;
    nix)    nix-channel --update ;;
    pkgin)  run pkgin update ;;
    apk)    run apk update ;;
  esac
  ;;
upgrade)
  case $pm in
    apt)    run apt-get -y upgrade ;;
    dnf)    run dnf -y upgrade ;;
    pacman) run pacman --noconfirm -Su ;;
    brew)   brew upgrade ;;
    nix)    nix-env -u ;;
    pkgin)  run pkgin -y upgrade ;;
    apk)    run apk upgrade ;;
  esac
  ;;
has)
  [ -z "$package" ] && { printf '%s\n' "pkg: package name required" >&2; exit 1; }
  case $pm in
    apt)    dpkg -l "$package" 2>/dev/null | grep -q "^ii" ;;
    dnf)    rpm -q "$package" >/dev/null 2>&1 ;;
    pacman) pacman -Q "$package" >/dev/null 2>&1 ;;
    brew)   brew list "$package" >/dev/null 2>&1 ;;
    nix)    nix-env -q "$package" >/dev/null 2>&1 ;;
    pkgin)  pkgin list 2>/dev/null | grep -q "^$package" ;;
    apk)    apk info -e "$package" >/dev/null 2>&1 ;;
  esac
  ;;
which)
  printf '%s\n' "$pm"
  ;;
*)
  printf '%s\n' "pkg: unknown action '$action' (use install, remove, update, upgrade, has, which)" >&2
  exit 1
  ;;
esac
