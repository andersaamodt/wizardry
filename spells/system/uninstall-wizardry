#!/bin/sh

# This spell uninstalls wizardry by locating and running the install script
# with --uninstall. It locates the checkout directory or accepts WIZARDRY_DIR.

show_usage() {
	cat <<'USAGE'
Usage: uninstall-wizardry

Uninstall wizardry by locating and running the install script with --uninstall.
The wizardry directory is inferred from this spell or provided via WIZARDRY_DIR.
USAGE
}

case "${1-}" in
--help|--usage|-h)
	show_usage
	exit 0
	;;
esac

set -eu

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Locate the wizardry directory
if [ -n "${WIZARDRY_DIR-}" ]; then
	wizardry_dir=$WIZARDRY_DIR
	if [ ! -d "$wizardry_dir" ]; then
		printf '%s\n' "WIZARDRY_DIR does not exist or is not a directory: $wizardry_dir" >&2
		exit 1
	fi
else
	# Attempt to locate the wizardry repository based on this spell's location.
	# spells/system/uninstall-wizardry -> spells/system -> spells -> repo_root
	candidate=$(dirname "$script_dir")
	candidate=$(dirname "$candidate")
	if [ -f "$candidate/install" ] && [ -x "$candidate/install" ]; then
		wizardry_dir=$candidate
	else
		printf '%s\n' 'Unable to determine the wizardry directory. Set WIZARDRY_DIR to the installation location.' >&2
		exit 1
	fi
fi

install_script="$wizardry_dir/install"

if [ ! -x "$install_script" ]; then
	printf '%s\n' "Install script not found at: $install_script" >&2
	exit 1
fi

exec "$install_script" --uninstall
