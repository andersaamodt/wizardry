#!/bin/sh

# Banish environmental chaos and validate wizardry readiness at different levels.
# This spell assumption-checks, self-heals, and tests the environment,
# ensuring all prerequisites are met for each spell level.

show_usage() {
  cat <<'USAGE'
Usage: banish [LEVEL] [OPTIONS]

Validate wizardry at the specified spell level, checking assumptions, 
self-healing issues, and running tests. Each level builds on previous levels.

NOTE: Banish requires wizardry to be installed. Run ./install first.
See .github/SPELL_LEVELS.md for complete level documentation.

Arguments:
  LEVEL                 Spell level to validate (0-27, default: 1)
                        Level 0: POSIX & platform foundation
                        Level 1: Wizardry installation
                        Level 2: Menu system
                        Level 3: MUD basics (cd-hook, look)
                        Level 4: Navigation (jump-to-marker, mark-location)
                        Level 5: Arcane file operations
                        Level 6: Basic cantrips
                        Level 7: Validation helpers
                        Level 8: Advanced cantrips
                        Level 9: System configuration
                        Level 10: Testing infrastructure
                        Level 11: System maintenance
                        Level 12: Advanced system tools
                        Level 13: Divination
                        Level 14: Advanced MUD
                        Level 15-20: Specialized domains (crypto, SSH, priorities, wards, enchant, PSI, spellcraft)
                        Level 21-25: Menus (core, system, MUD, domain)
                        Level 26: System services
                        Level 27: Optional arcana & third-party integrations

Options:
  --no-heal             Skip self-healing (only report issues)
  --no-tests            Skip running tests (only check assumptions)
  --only                Only validate this specific level (don't run lower levels)

Environment Variables:
  WIZARDRY_DIR          Target wizardry installation directory

Exit Codes:
  0  Level is ready (all checks passed, tests passed)
  1  Critical issues found (cannot continue)
  2  Invalid usage

Examples:
  banish                    # Validate through level 1 (default - levels 0-1: POSIX + wizardry)
  banish 0                  # Validate level 0 only (POSIX foundation)
  banish 2                  # Validate through level 2 (levels 0-2: POSIX + wizardry + menu)
  banish 4 --no-tests       # Validate through level 4, skip tests
  banish 1 --no-heal        # Validate through level 1, only report issues
USAGE
}

banish() {
case "${1-}" in
--help|--usage|-h)
  show_usage
  return 0
  ;;
esac

set -eu

# Parse arguments
target_level=1
skip_tests=0
skip_heal=0
only_this_level=0

# First, check if first arg is a number (the level)
if [ "$#" -gt 0 ]; then
  case "$1" in
    [0-9]|[0-9][0-9])
      target_level=$1
      shift
      ;;
  esac
fi

while [ "$#" -gt 0 ]; do
  case $1 in
    --no-heal)
      skip_heal=1
      shift
      ;;
    --no-tests)
      skip_tests=1
      shift
      ;;
    --only)
      only_this_level=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      printf 'Error: unknown option: %s\n' "$1" >&2
      show_usage >&2
      return 2
      ;;
    *)
      # Check if it's a valid level number
      case "$1" in
        [0-9]|[0-9][0-9])
          target_level=$1
          shift
          ;;
        *)
          printf 'Error: unexpected argument: %s\n' "$1" >&2
          show_usage >&2
          return 2
          ;;
      esac
      ;;
  esac
done

# Validate level
if [ "$target_level" -lt 0 ] || [ "$target_level" -gt 27 ]; then
  printf 'Error: level must be 0-27, got: %s\n' "$target_level" >&2
  show_usage >&2
  return 2
fi

# Determine verbosity - removed, always show output

# Helper functions for output (inline since this is a bootstrap script)
banish_info() {
  printf '%s\n' "$*"
}

banish_step() {
  printf '  • %s\n' "$*"
}

banish_check() {
  printf '  ✓ %s\n' "$*"
}

banish_warn() {
  printf 'Warning: %s\n' "$*" >&2
}

banish_error() {
  printf 'Error: %s\n' "$*" >&2
}


# Get level name for display
banish_level_name() {
  case "$1" in
    0) printf 'POSIX & Platform Foundation' ;;
    1) printf 'Wizardry Installation' ;;
    2) printf 'Menu System' ;;
    3) printf 'MUD Basics' ;;
    4) printf 'Navigation' ;;
    5) printf 'Arcane File Operations' ;;
    6) printf 'Basic Cantrips' ;;
    7) printf 'Validation Helpers' ;;
    8) printf 'Advanced Cantrips' ;;
    9) printf 'System Configuration' ;;
    10) printf 'Testing Infrastructure' ;;
    11) printf 'System Maintenance' ;;
    12) printf 'Advanced System Tools' ;;
    13) printf 'Divination' ;;
    14) printf 'Advanced MUD Features' ;;
    15) printf 'Cryptography' ;;
    16) printf 'SSH & Remote Access' ;;
    17) printf 'Task Priorities' ;;
    18) printf 'Security Wards' ;;
    19) printf 'Extended Attributes' ;;
    20) printf 'Process & System Info (PSI)' ;;
    21) printf 'Spellcraft Development Tools' ;;
    22) printf 'Core Menu Infrastructure' ;;
    23) printf 'System & Configuration Menus' ;;
    24) printf 'MUD Administration Menus' ;;
    25) printf 'Domain-Specific Menus' ;;
    26) printf 'System Service Management' ;;
    27) printf 'Optional Arcana & Third-Party Integrations' ;;
    *) printf 'Unknown' ;;
  esac
}

# Run level-specific checks and actions
banish_level() {
  level=$1
  level_name=$(banish_level_name "$level")
  
  printf '\n=== Level %d: %s ===\n' "$level" "$level_name"
  
  case "$level" in
    0)
      banish_level_0
      ;;
    1)
      banish_level_1
      ;;
    2)
      banish_level_2
      ;;
    3)
      banish_level_3
      ;;
    4)
      banish_level_4
      ;;
    5)
      banish_level_5
      ;;
    6)
      banish_level_6
      ;;
    7)
      banish_level_7
      ;;
    8)
      banish_level_8
      ;;
    9)
      banish_level_9
      ;;
    10)
      banish_level_10
      ;;
    11)
      banish_level_11
      ;;
    12)
      banish_level_12
      ;;
    13)
      banish_level_13
      ;;
    14)
      banish_level_14
      ;;
    15)
      banish_level_15
      ;;
    16)
      banish_level_16
      ;;
    17)
      banish_level_17
      ;;
    18)
      banish_level_18
      ;;
    19)
      banish_level_19
      ;;
    20)
      banish_level_20
      ;;
    21)
      banish_level_21
      ;;
    22)
      banish_level_22
      ;;
    23)
      banish_level_23
      ;;
    24)
      banish_level_24
      ;;
    25)
      banish_level_25
      ;;
    26)
      banish_level_26
      ;;
    27)
      banish_level_27
      ;;
    *)
      banish_warn "Level $level not yet implemented"
      ;;
  esac
}

# Level 0: System Foundation (wizardry installation assumptions)
banish_level_0() {
  # Stage 1: Set up WIZARDRY_DIR first (needed for other checks)
  printf '\nConfiguring WIZARDRY_DIR:\n'
  
  wizardry_not_installed=0
  
  if [ -n "${WIZARDRY_DIR-}" ]; then
    # Already set in environment
    banish_check "Using existing: $WIZARDRY_DIR"
  else
    # Auto-detect
    banish_step "Auto-detecting wizardry installation..."
    
    # Try to find wizardry by looking for this script's location
    has_dirname=$(command -v dirname >/dev/null 2>&1 && echo 1 || echo 0)
    has_cd=$(command -v cd >/dev/null 2>&1 && echo 1 || echo 0)
    has_pwd=$(command -v pwd >/dev/null 2>&1 && echo 1 || echo 0)
    if [ "$has_dirname" = "1" ] && [ "$has_cd" = "1" ] && [ "$has_pwd" = "1" ]; then
      script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || true
      if [ -n "$script_dir" ]; then
        # We're in spells/system, so go up two levels
        _potential_dir=$(CDPATH= cd -- "$script_dir/../.." 2>/dev/null && pwd -P) || true
        if [ -n "$_potential_dir" ] && [ -d "$_potential_dir/spells" ]; then
          WIZARDRY_DIR=$_potential_dir
          banish_check "Detected from script location: $WIZARDRY_DIR"
        fi
      fi
    fi
    
    # Fallback to standard location
    if [ -z "${WIZARDRY_DIR-}" ]; then
      if [ -n "${HOME-}" ] && [ -d "${HOME}/.wizardry/spells" ]; then
        WIZARDRY_DIR="${HOME}/.wizardry"
        banish_check "Found standard location: $WIZARDRY_DIR"
      else
        wizardry_not_installed=1
      fi
    fi
  fi
  
  # Verify WIZARDRY_DIR structure (essential wizardry assumptions)
  if [ -n "${WIZARDRY_DIR-}" ]; then
    if [ ! -d "${WIZARDRY_DIR}/spells" ]; then
      wizardry_not_installed=1
    fi
  fi
  
  # Special case: If wizardry is not installed, report assumptions and stop
  if [ "$wizardry_not_installed" -eq 1 ]; then
    banish_info ""
    banish_info "Wizardry installation not found."
    banish_info ""
    banish_info "The following assumptions are not met:"
    banish_info "  • WIZARDRY_DIR not set or directory not found"
    banish_info "  • Wizardry spells directory not found"
    banish_info "  • invoke-wizardry not available"
    banish_info ""
    banish_info "To install wizardry, run: ./install"
    banish_info ""
    return 1
  fi
  
  # Wizardry is installed - continue with validation
  if [ -n "${WIZARDRY_DIR-}" ]; then
    # Check for critical wizardry directories
    banish_step "Checking wizardry structure..."
    for dir in spells spells/.imps spells/.imps/sys .tests; do
      if [ -d "${WIZARDRY_DIR}/$dir" ]; then
        banish_check "Found: $dir/"
      else
        banish_warn "Missing: $dir/"
      fi
    done
    
    # Export WIZARDRY_DIR for downstream tools
    export WIZARDRY_DIR
    banish_info "Environment prepared: WIZARDRY_DIR=$WIZARDRY_DIR"
  fi
  
  # Stage 2: Detect OS and system information
  printf '\nDetecting OS and system information:\n'
  
  # Detect operating system
  if command -v uname >/dev/null 2>&1; then
    os_kernel=$(uname -s 2>/dev/null || printf 'unknown')
    banish_check "Kernel: $os_kernel"
    
    # Try to detect distribution if available
    if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/divination/detect-distro" ]; then
      distro=$("${WIZARDRY_DIR}/spells/divination/detect-distro" 2>/dev/null || printf 'unknown')
      banish_check "Distribution: $distro"
    elif [ -f /etc/os-release ]; then
      distro=$(grep '^ID=' /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"' || printf 'unknown')
      banish_check "Distribution: $distro"
    fi
  else
    banish_warn "uname not found - cannot detect OS"
  fi
  
  # Stage 3: Check POSIX environment using detect-posix if available
  printf '\nChecking POSIX toolchain:\n'
  posix_check_failed=0
  missing_recommended=''
  
  # Try to use detect-posix if available
  if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/divination/detect-posix" ]; then
    banish_step "Using detect-posix for environment checks"
    "${WIZARDRY_DIR}/spells/divination/detect-posix" --verbose || posix_check_failed=1
    
    if [ "$posix_check_failed" -ne 0 ]; then
      banish_warn "detect-posix reported issues with POSIX environment"
      banish_warn "Some wizardry features may not work correctly"
    fi
  else
    # Fallback: manual check of critical tools if detect-posix not available
    banish_step "detect-posix not found, using fallback checks"
    critical_tools="sh test printf"
    missing_critical=''
    
    for tool in $critical_tools; do
      if ! command -v "$tool" >/dev/null 2>&1; then
        missing_critical="${missing_critical:+$missing_critical }$tool"
      else
        banish_check "Found: $tool"
      fi
    done
    
    if [ -n "$missing_critical" ]; then
      banish_warn "Critical POSIX tools missing: $missing_critical"
      banish_warn "Cannot self-heal without basic shell utilities"
      return 1
    fi
    
    # Check recommended tools
    recommended_tools="awk sed grep find mktemp dirname basename pwd cd curl wget tar"
    for tool in $recommended_tools; do
      if ! command -v "$tool" >/dev/null 2>&1; then
        missing_recommended="${missing_recommended:+$missing_recommended }$tool"
        banish_warn "Recommended tool missing: $tool"
      else
        banish_check "Found: $tool"
      fi
    done
  fi
  
  # Stage 4: Verify invoke-wizardry and RC integration
  if [ -n "${WIZARDRY_DIR-}" ]; then
    printf '\nVerifying invoke-wizardry and shell integration:\n'
    
    # Check invoke-wizardry exists
    if [ ! -f "$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry" ]; then
      banish_warn "invoke-wizardry not found at $WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry"
      banish_warn "Run ./install to repair wizardry"
      return 1
    else
      banish_check "invoke-wizardry is available"
    fi
    
    # Check if shell RC file exists and contains wizardry invocation
    rc_file=""
    if [ -n "${SHELL-}" ]; then
      case "$(basename "$SHELL")" in
        bash) rc_file="${HOME}/.bashrc" ;;
        zsh) rc_file="${HOME}/.zshrc" ;;
        *) rc_file="${HOME}/.profile" ;;
      esac
    else
      rc_file="${HOME}/.profile"
    fi
    
    if [ -f "$rc_file" ]; then
      if grep -q "invoke-wizardry" "$rc_file" 2>/dev/null; then
        banish_check "Shell RC configured: $rc_file"
      else
        banish_warn "Shell RC exists but wizardry not sourced: $rc_file"
        banish_info "Run: source \"\$HOME/.wizardry/spells/.imps/sys/invoke-wizardry\""
      fi
    else
      banish_warn "Shell RC file not found: $rc_file"
      banish_info "Wizardry may not be available in new shells"
    fi
  fi
  
  # Stage 5: Set baseline PATH if needed
  printf '\nChecking PATH:\n'
  baseline_path="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  case ":${PATH-}:" in
    *":/usr/bin:"*|*":/bin:"*)
      banish_check "PATH includes standard directories"
      ;;
    *)
      banish_warn "PATH missing standard directories, adding baseline"
      PATH="${baseline_path}${PATH:+:}${PATH-}"
      export PATH
      ;;
  esac
  
  # Stage 6: Check for package managers (system foundation)
  printf '\nChecking package managers:\n'
  found_pkg_mgr=0
  for pkg_mgr in apt yum dnf pacman brew nix-env; do
    if command -v "$pkg_mgr" >/dev/null 2>&1; then
      banish_check "Found package manager: $pkg_mgr"
      found_pkg_mgr=1
    fi
  done
  
  if [ "$found_pkg_mgr" -eq 0 ]; then
    banish_warn "No known package manager found"
    banish_warn "Self-healing capabilities will be limited"
  fi
  
  # Stage 7: Check and self-heal essential development tools
  printf '\nChecking essential development tools:\n'
  
  # Check for git
  if ! command -v git >/dev/null 2>&1; then
    banish_warn "git not found - required for wizardry development"
    if [ "$skip_heal" -eq 0 ] && [ -x "${WIZARDRY_DIR}/spells/.arcana/core/install-git" ]; then
      banish_info "Attempting to install git..."
      "${WIZARDRY_DIR}/spells/.arcana/core/install-git" || banish_warn "Failed to install git"
      # Re-check
      if command -v git >/dev/null 2>&1; then
        banish_check "git installed successfully"
      fi
    fi
  else
    banish_check "git available"
  fi
  
  # Stage 8: Check POSIX tools and attempt self-healing
  # Report summary and attempt self-healing if enabled
  if [ -n "$missing_recommended" ]; then
    banish_warn "Some recommended tools are missing: $missing_recommended"
    banish_warn "Wizardry may have reduced functionality"
    
    if [ "$skip_heal" -eq 0 ] && [ "$found_pkg_mgr" -eq 1 ]; then
      banish_info "Attempting to install missing tools (this may require sudo)..."
      # Whitelist of allowed POSIX tools to install (security: prevent command injection)
      allowed_tools="awk sed grep find mktemp dirname basename pwd cd curl wget tar sh test printf cat sort"
      
      # Try to install missing tools based on detected package manager
      for pkg_mgr in apt yum dnf pacman brew; do
        if command -v "$pkg_mgr" >/dev/null 2>&1; then
          case "$pkg_mgr" in
            apt)
              for tool in $missing_recommended; do
                # Validate tool is in whitelist
                tool_allowed=0
                for allowed in $allowed_tools; do
                  if [ "$tool" = "$allowed" ]; then
                    tool_allowed=1
                    break
                  fi
                done
                
                if [ "$tool_allowed" -eq 1 ]; then
                  banish_step "Installing $tool..."
                  sudo apt-get install -y "$tool" >/dev/null 2>&1 || banish_warn "Failed to install $tool"
                else
                  banish_warn "Skipping $tool (not in allowed tools list)"
                fi
              done
              break
              ;;
            yum|dnf)
              for tool in $missing_recommended; do
                # Validate tool is in whitelist
                tool_allowed=0
                for allowed in $allowed_tools; do
                  if [ "$tool" = "$allowed" ]; then
                    tool_allowed=1
                    break
                  fi
                done
                
                if [ "$tool_allowed" -eq 1 ]; then
                  banish_step "Installing $tool..."
                  sudo "$pkg_mgr" install -y "$tool" >/dev/null 2>&1 || banish_warn "Failed to install $tool"
                else
                  banish_warn "Skipping $tool (not in allowed tools list)"
                fi
              done
              break
              ;;
            pacman)
              for tool in $missing_recommended; do
                # Validate tool is in whitelist
                tool_allowed=0
                for allowed in $allowed_tools; do
                  if [ "$tool" = "$allowed" ]; then
                    tool_allowed=1
                    break
                  fi
                done
                
                if [ "$tool_allowed" -eq 1 ]; then
                  banish_step "Installing $tool..."
                  sudo pacman -S --noconfirm "$tool" >/dev/null 2>&1 || banish_warn "Failed to install $tool"
                else
                  banish_warn "Skipping $tool (not in allowed tools list)"
                fi
              done
              break
              ;;
            brew)
              for tool in $missing_recommended; do
                # Validate tool is in whitelist
                tool_allowed=0
                for allowed in $allowed_tools; do
                  if [ "$tool" = "$allowed" ]; then
                    tool_allowed=1
                    break
                  fi
                done
                
                if [ "$tool_allowed" -eq 1 ]; then
                  banish_step "Installing $tool..."
                  brew install "$tool" >/dev/null 2>&1 || banish_warn "Failed to install $tool"
                else
                  banish_warn "Skipping $tool (not in allowed tools list)"
                fi
              done
              break
              ;;
          esac
        fi
      done
    else
      banish_info "Install manually using your package manager if needed"
    fi
  fi
  
  # Success
  banish_info "Level 0 complete - system foundation validated"
  return 0
}

# Level 1: Wizardry Installation
banish_level_1() {
  banish_info "Checking Level 1: Wizardry Installation..."
  
  # Check if wizardry is installed (this should be caught by level 0)
  if [ ! -d "${WIZARDRY_DIR}/spells" ]; then
    banish_warn "Wizardry not installed at $WIZARDRY_DIR"
    return 1
  fi
  
  # Check for banish spell itself
  if [ ! -f "${WIZARDRY_DIR}/spells/system/banish" ]; then
    banish_warn "Missing: banish spell"
  else
    banish_check "Found spell: banish"
  fi
  
  # Check critical imps from Level 1
  banish_step "Checking Level 1 imps..."
  critical_imps="sys/invoke-wizardry sys/require-wizardry sys/require sys/castable sys/env-clear sys/on-exit sys/clear-traps cond/has cond/there cond/is cond/empty cond/nonempty out/say out/warn out/die out/fail out/info out/step out/success out/debug"
  for imp in $critical_imps; do
    if [ ! -f "${WIZARDRY_DIR}/spells/.imps/$imp" ]; then
      banish_warn "Missing imp: $imp"
    else
      banish_check "Found imp: $imp"
    fi
  done
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 1
  fi
  
  banish_info "Level 1 complete"
}

# Level 2: Menu System
banish_level_2() {
  banish_info "Checking Level 2: Menu System..."
  
  # Check for menu spell dependencies
  missing_spells=""
  for spell in menu fathom-terminal fathom-cursor move-cursor await-keypress cursor-blink colors main-menu; do
    if [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing_spells="${missing_spells:+$missing_spells }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing_spells" ]; then
    banish_warn "Missing menu spells: $missing_spells"
    banish_warn "Wizardry installation appears incomplete"
    return 1
  fi
  
  # Check if stty is available (required for menu terminal control)
  if ! command -v stty >/dev/null 2>&1; then
    banish_warn "stty command not found - required for menu"
    if [ "$skip_heal" -eq 0 ]; then
      if [ -x "${WIZARDRY_DIR}/spells/.arcana/core/install-stty" ]; then
        banish_info "Attempting to install stty..."
        "${WIZARDRY_DIR}/spells/.arcana/core/install-stty" || banish_warn "Failed to install stty"
        # Re-check after install
        if command -v stty >/dev/null 2>&1; then
          banish_check "stty installed successfully"
        fi
      else
        banish_info "install-stty script not found - install stty manually"
      fi
    fi
  else
    banish_check "stty available"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 2
  fi
  
  banish_info "Level 2 complete"
}

# Level 3: MUD Basics
banish_level_3() {
  banish_info "Checking Level 3: MUD Basics..."
  
  # Check for MUD basics spells
  mud_spells="check-cd-hook look"
  missing=""
  for spell in $mud_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/mud/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing MUD spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 3
  fi
  
  banish_info "Level 3 complete"
}

# Level 4: Navigation
banish_level_4() {
  banish_info "Checking Level 4: Navigation..."
  
  # Check for navigation spells
  nav_spells="jump-to-marker mark-location"
  missing=""
  for spell in $nav_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/translocation/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing navigation spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 4
  fi
  
  banish_info "Level 4 complete"
}

# Level 5: Arcane File Operations
banish_level_5() {
  banish_info "Checking Level 5: Arcane File Operations..."
  
  # Check for arcane spells
  arcane_spells="copy trash forall read-magic file-list"
  missing=""
  for spell in $arcane_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/arcane/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing arcane spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 5
  fi
  
  banish_info "Level 5 complete"
}

# Level 6: Basic Cantrips
banish_level_6() {
  banish_info "Checking Level 6: Basic Cantrips..."
  
  # Check for basic cantrip spells
  cantrip_spells="ask ask-yn ask-text list-files max-length move up"
  missing=""
  for spell in $cantrip_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing cantrips: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 6
  fi
  
  banish_info "Level 6 complete"
}

# Level 7: Validation Helpers
banish_level_7() {
  banish_info "Checking Level 7: Validation Helpers..."
  
  # Check for validation spells
  validation_spells="validate-number validate-path require-command"
  missing=""
  for spell in $validation_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing validation spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 7
  fi
  
  banish_info "Level 7 complete"
}

# Level 8: Advanced Cantrips
banish_level_8() {
  banish_info "Checking Level 8: Advanced Cantrips..."
  
  # Check for advanced cantrip spells
  adv_cantrips="ask-number memorize"
  missing=""
  for spell in $adv_cantrips; do
    if [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing advanced cantrips: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 8
  fi
  
  banish_info "Level 8 complete"
}

# Level 9: System Configuration
banish_level_9() {
  banish_info "Checking Level 9: System Configuration..."
  
  # Check for system configuration spells
  config_spells="config logs package-managers"
  missing=""
  for spell in $config_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/system/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing system configuration spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 9
  fi
  
  banish_info "Level 9 complete"
}

# Level 10: Testing Infrastructure
banish_level_10() {
  banish_info "Checking Level 10: Testing Infrastructure..."
  
  # Check for testing spells
  testing_spells="test-spell test-magic logging-example wizard-eyes"
  missing=""
  for spell in $testing_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/system/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing testing spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 10
  fi
  
  banish_info "Level 10 complete"
}

# Level 11: System Maintenance
banish_level_11() {
  banish_info "Checking Level 11: System Maintenance..."
  
  # Check for system maintenance spells
  maint_spells="update-wizardry update-all kill-process"
  missing=""
  for spell in $maint_spells; do
    # These could be in system or cantrips
    if [ ! -f "${WIZARDRY_DIR}/spells/system/$spell" ] && [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing maintenance spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 11
  fi
  
  banish_info "Level 11 complete"
}

# Level 12: Advanced System Tools
banish_level_12() {
  banish_info "Checking Level 12: Advanced System Tools..."
  
  # Check for advanced system spells
  adv_system_spells="demo-magic verify-posix wizard-cast"
  missing=""
  for spell in $adv_system_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/system/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing advanced system spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 12
  fi
  
  banish_info "Level 12 complete"
}

# Level 13: Divination
banish_level_13() {
  banish_info "Checking Level 13: Divination..."
  
  # Check for divination spells
  div_spells="detect-rc-file detect-magic identify-room"
  missing=""
  for spell in $div_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/divination/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing divination spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 13
  fi
  
  banish_info "Level 13 complete"
}

# Level 14: Advanced MUD Features
banish_level_14() {
  banish_info "Checking Level 14: Advanced MUD Features..."
  
  # Check for advanced MUD spells
  adv_mud_spells="decorate select-player check-command-not-found-hook"
  missing=""
  for spell in $adv_mud_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/mud/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing advanced MUD spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 14
  fi
  
  banish_info "Level 14 complete"
}

# Level 15: Cryptography
banish_level_15() {
  banish_info "Checking Level 15: Cryptography..."
  
  # Check for crypto spells
  if [ -d "${WIZARDRY_DIR}/spells/crypto" ]; then
    crypto_count=$(find "${WIZARDRY_DIR}/spells/crypto" -type f 2>/dev/null | wc -l)
    banish_check "Found $crypto_count cryptography spells"
  else
    banish_warn "Crypto directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 15
  fi
  
  banish_info "Level 15 complete"
}

# Level 16: SSH & Remote Access
banish_level_16() {
  banish_info "Checking Level 16: SSH & Remote Access..."
  
  # Check for translocation spells (SSH and remote)
  if [ -d "${WIZARDRY_DIR}/spells/translocation" ]; then
    trans_count=$(find "${WIZARDRY_DIR}/spells/translocation" -type f 2>/dev/null | wc -l)
    banish_check "Found $trans_count translocation spells"
  else
    banish_warn "Translocation directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 16
  fi
  
  banish_info "Level 16 complete"
}

# Level 17: Task Priorities
banish_level_17() {
  banish_info "Checking Level 17: Task Priorities..."
  
  # Check for priority spells
  if [ -d "${WIZARDRY_DIR}/spells/priorities" ]; then
    pri_count=$(find "${WIZARDRY_DIR}/spells/priorities" -type f 2>/dev/null | wc -l)
    banish_check "Found $pri_count priority spells"
  else
    banish_warn "Priorities directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 17
  fi
  
  banish_info "Level 17 complete"
}

# Level 18: Security Wards
banish_level_18() {
  banish_info "Checking Level 18: Security Wards..."
  
  # Check for ward spells
  if [ -d "${WIZARDRY_DIR}/spells/wards" ]; then
    ward_count=$(find "${WIZARDRY_DIR}/spells/wards" -type f 2>/dev/null | wc -l)
    banish_check "Found $ward_count ward spells"
  else
    banish_warn "Wards directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 18
  fi
  
  banish_info "Level 18 complete"
}

# Level 19: Extended Attributes
banish_level_19() {
  banish_info "Checking Level 19: Extended Attributes..."
  
  # Check for enchant spells
  if [ -d "${WIZARDRY_DIR}/spells/enchant" ]; then
    enchant_count=$(find "${WIZARDRY_DIR}/spells/enchant" -type f 2>/dev/null | wc -l)
    banish_check "Found $enchant_count enchantment spells"
  else
    banish_warn "Enchant directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 19
  fi
  
  banish_info "Level 19 complete"
}

# Level 20: Process & System Info (PSI)
banish_level_20() {
  banish_info "Checking Level 20: Process & System Info (PSI)..."
  
  # Check for PSI spells
  if [ -d "${WIZARDRY_DIR}/spells/psi" ]; then
    psi_count=$(find "${WIZARDRY_DIR}/spells/psi" -type f 2>/dev/null | wc -l)
    banish_check "Found $psi_count PSI spells"
  else
    banish_warn "PSI directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 20
  fi
  
  banish_info "Level 20 complete"
}

# Level 21: Spellcraft Development Tools
banish_level_21() {
  banish_info "Checking Level 21: Spellcraft Development Tools..."
  
  # Check for spellcraft spells
  if [ -d "${WIZARDRY_DIR}/spells/spellcraft" ]; then
    craft_count=$(find "${WIZARDRY_DIR}/spells/spellcraft" -type f 2>/dev/null | wc -l)
    banish_check "Found $craft_count spellcraft spells"
  else
    banish_warn "Spellcraft directory not found"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 21
  fi
  
  banish_info "Level 21 complete"
}

# Level 22: Core Menu Infrastructure
banish_level_22() {
  banish_info "Checking Level 22: Core Menu Infrastructure..."
  
  # Check for core menu spells
  menu_spells="spellbook-store spellbook cast spell-menu"
  missing=""
  for spell in $menu_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/menu/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing core menu spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 22
  fi
  
  banish_info "Level 22 complete"
}

# Level 23: System & Configuration Menus
banish_level_23() {
  banish_info "Checking Level 23: System & Configuration Menus..."
  
  # Check for system menu spells
  sys_menu_spells="system-menu install-menu synonym-menu thesaurus"
  missing=""
  for spell in $sys_menu_spells; do
    # Check both menu and menu/system directories
    if [ ! -f "${WIZARDRY_DIR}/spells/menu/$spell" ] && [ ! -f "${WIZARDRY_DIR}/spells/menu/system/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing system menu spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 23
  fi
  
  banish_info "Level 23 complete"
}

# Level 24: MUD Administration Menus
banish_level_24() {
  banish_info "Checking Level 24: MUD Administration Menus..."
  
  # Check for MUD menu spells
  mud_menu_spells="mud mud-menu mud-settings mud-admin-menu add-ssh-player new-player set-player"
  missing=""
  for spell in $mud_menu_spells; do
    # Check both menu and menu/mud-admin directories
    if [ ! -f "${WIZARDRY_DIR}/spells/menu/$spell" ] && [ ! -f "${WIZARDRY_DIR}/spells/menu/mud-admin/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing MUD menu spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 24
  fi
  
  banish_info "Level 24 complete"
}

# Level 25: Domain-Specific Menus
banish_level_25() {
  banish_info "Checking Level 25: Domain-Specific Menus..."
  
  # Check for domain-specific menu spells
  domain_menu_spells="network-menu services-menu shutdown-menu priority-menu priorities users-menu profile-tests"
  missing=""
  for spell in $domain_menu_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/menu/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
    fi
  done
  
  if [ -n "$missing" ]; then
    banish_warn "Missing domain menu spells: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 25
  fi
  
  banish_info "Level 25 complete"
}

# Level 26: System Service Management
banish_level_26() {
  banish_info "Checking Level 26: System Service Management..."
  
  # Check for service management spells
  service_spells="install-service-template is-service-installed enable-service disable-service start-service stop-service restart-service service-status remove-service"
  missing=""
  found=0
  for spell in $service_spells; do
    if [ ! -f "${WIZARDRY_DIR}/spells/cantrips/$spell" ]; then
      missing="${missing:+$missing }$spell"
    else
      banish_check "Found spell: $spell"
      found=$((found + 1))
    fi
  done
  
  if [ "$found" -eq 0 ]; then
    banish_warn "No service management spells found"
  elif [ -n "$missing" ]; then
    banish_info "Some service spells missing: $missing"
  fi
  
  # Run tests if not skipped
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 26
  fi
  
  banish_info "Level 26 complete"
}

# Level 27: Optional Arcana & Third-Party Integrations
banish_level_27() {
  banish_info "Checking Level 27: Optional Arcana & Third-Party Integrations..."
  
  # Check for arcana directory
  if [ -d "${WIZARDRY_DIR}/spells/.arcana" ]; then
    arcana_count=$(find "${WIZARDRY_DIR}/spells/.arcana" -type f 2>/dev/null | wc -l)
    banish_check "Found $arcana_count arcana spells/scripts"
  else
    banish_info "Arcana directory not found (optional)"
  fi
  
  # Run tests if not skipped (most arcana don't have tests)
  if [ "$skip_tests" -eq 0 ]; then
    banish_run_tests_for_level 27
  fi
  
  banish_info "Level 27 complete"
}

# Run tests for a specific level
banish_run_tests_for_level() {
  level=$1
  level_name=$(banish_level_name "$level")
  
  # Check if test-spell exists
  if [ ! -x "${WIZARDRY_DIR}/spells/system/test-spell" ]; then
    banish_warn "test-spell not found, skipping tests"
    return 0
  fi
  
  
  banish_info "Running tests for Level $level ($level_name)..."
  
  # Determine which tests to run based on level
  test_pattern=""
  case "$level" in
    0)
      # Level 0 uses detect-posix and detect-distro tests
      test_pattern="divination/test-detect-posix.sh divination/test-detect-distro.sh"
      ;;
    1)
      # Level 1: Wizardry installation - test banish itself
      test_pattern="system/test-banish.sh"
      ;;
    2)
      # Level 2: Menu system
      test_pattern="cantrips/test-menu.sh cantrips/test-await-keypress.sh cantrips/test-fathom-cursor.sh cantrips/test-fathom-terminal.sh"
      ;;
    3)
      # Level 3: MUD basics
      test_pattern="mud/test-check-cd-hook.sh mud/test-look.sh"
      ;;
    4)
      # Level 4: Navigation
      test_pattern="translocation/test-*.sh"
      ;;
    5)
      # Level 5: Arcane file operations
      test_pattern="arcane/test-*.sh"
      ;;
    6)
      # Level 6: Basic cantrips
      test_pattern="cantrips/test-ask.sh cantrips/test-ask-yn.sh cantrips/test-ask-text.sh cantrips/test-list-files.sh"
      ;;
    7)
      # Level 7: Validation helpers
      test_pattern="cantrips/test-validate-*.sh cantrips/test-require-command.sh"
      ;;
    8)
      # Level 8: Advanced cantrips
      test_pattern="cantrips/test-ask-number.sh cantrips/test-memorize.sh"
      ;;
    9)
      # Level 9: System configuration
      test_pattern="system/test-config.sh system/test-logs.sh"
      ;;
    10)
      # Level 10: Testing infrastructure
      test_pattern="system/test-test-spell.sh system/test-test-magic.sh"
      ;;
    11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27)
      # Higher levels - no specific test patterns defined yet
      banish_info "No standard tests defined for Level $level"
      return 0
      ;;
    *)
      banish_warn "Unknown test pattern for level $level"
      return 0
      ;;
  esac
  
  # Run the tests
  passed=0
  failed=0
  if [ -n "$test_pattern" ]; then
    for pattern in $test_pattern; do
      # Expand pattern
      for test_file in "${WIZARDRY_DIR}/.tests/$pattern"; do
        if [ -f "$test_file" ]; then
          test_name=$(basename "$test_file")
          banish_step "Running $test_name..."
          if "${WIZARDRY_DIR}/spells/system/test-spell" --skip-common "${test_file#${WIZARDRY_DIR}/.tests/}" </dev/null >/dev/null 2>&1; then
            passed=$((passed + 1))
            banish_check "$test_name passed"
          else
            failed=$((failed + 1))
            banish_warn "$test_name failed"
          fi
        fi
      done
    done
  fi
  
  # Show summary
  total=$((passed + failed))
  if [ "$total" -gt 0 ]; then
    if [ "$failed" -eq 0 ]; then
      banish_info "All $passed tests passed"
    else
      banish_warn "$failed of $total tests failed"
    fi
  fi
}

# Main execution: Run levels 0 through target_level (or only target_level if --only)
if [ "$only_this_level" -eq 1 ]; then
  printf '\n=== Validating Wizardry Level %d: %s (only) ===\n' "$target_level" "$(banish_level_name "$target_level")"
else
  printf '\n=== Validating Wizardry through Level %d: %s ===\n' "$target_level" "$(banish_level_name "$target_level")"
fi

# Run each level from 0 to target_level (or just target_level if --only)
if [ "$only_this_level" -eq 1 ]; then
  current_level=$target_level
else
  current_level=0
fi

while [ "$current_level" -le "$target_level" ]; do
  banish_level "$current_level" || {
    exit_code=$?
    banish_error "Level $current_level validation failed, cannot continue"
    return "$exit_code"
  }
  if [ "$only_this_level" -eq 1 ]; then
    break
  fi
  current_level=$((current_level + 1))
done

# Final success message
printf '\n✓ Validation complete - Level %d ready\n' "$target_level"

return 0
}


# Load castable imp for direct execution (AFTER all functions defined)
# CRITICAL: banish is a bootstrap spell that may run before wizardry is installed
# So we need to handle missing castable gracefully
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Try to find and source castable
      if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/.imps/sys/castable" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ] && [ -f "${ROOT_DIR}/spells/.imps/sys/castable" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        # Try to find wizardry relative to this script
        _script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || _script_dir=""
        if [ -n "$_script_dir" ]; then
          _wiz_root=$(CDPATH= cd -- "$_script_dir/../.." 2>/dev/null && pwd -P) || _wiz_root=""
          if [ -n "$_wiz_root" ] && [ -f "$_wiz_root/spells/.imps/sys/castable" ]; then
            _i="$_wiz_root/spells/.imps/sys"
          fi
        fi
      fi
      [ -n "${_i-}" ] && [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - try to find and source castable
    if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/.imps/sys/castable" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ] && [ -f "${ROOT_DIR}/spells/.imps/sys/castable" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      # Try to find wizardry relative to this script
      _script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || _script_dir=""
      if [ -n "$_script_dir" ]; then
        _wiz_root=$(CDPATH= cd -- "$_script_dir/../.." 2>/dev/null && pwd -P) || _wiz_root=""
        if [ -n "$_wiz_root" ] && [ -f "$_wiz_root/spells/.imps/sys/castable" ]; then
          _i="$_wiz_root/spells/.imps/sys"
        fi
      fi
    fi
    [ -n "${_i-}" ] && [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

# Only call castable if it's available (either from PATH or just sourced)
if command -v castable >/dev/null 2>&1; then
  castable "$@"
else
  # Castable not available - call the function directly
  # This happens when running as a bootstrap script before wizardry is installed
  banish "$@"
fi
