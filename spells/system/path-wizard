#!/bin/sh

# Generate PATH additions for wizardry spells and imps.
# This spell outputs shell commands that add all wizardry directories to PATH.
# It's designed to be sourced (eval) or used to generate rc file additions.

show_usage() {
  cat <<'USAGE'
Usage: path-wizard [OPTIONS]

Generate PATH additions for all wizardry spell and imp directories.

Options:
  --eval      Output commands for immediate evaluation (for sourcing)
  --rc        Output commands for adding to shell rc files (default)
  --check     Check if wizardry directories are in PATH
  --help      Show this help message

Examples:
  # Add to current shell:
  eval "$(path-wizard --eval)"
  
  # Generate rc file additions:
  path-wizard --rc >> ~/.bashrc
  
  # Check if wizardry is in PATH:
  path-wizard --check

The generated PATH includes:
  - All spell category directories (spells/arcane/, spells/cantrips/, etc.)
  - All imp family directories (spells/.imps/out/, spells/.imps/cond/, etc.)
  - User's spellbook directory (~/.spellbook)

This enables all spells and imps to be called directly by their hyphenated names.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac

set -eu

# Determine wizardry directory
if [ -n "${WIZARDRY_DIR-}" ]; then
  wizardry_dir=$WIZARDRY_DIR
elif [ -n "${HOME-}" ] && [ -d "$HOME/.wizardry/spells" ]; then
  wizardry_dir="$HOME/.wizardry"
else
  # Try to find from script location
  script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P)
  wizardry_dir=$(CDPATH= cd -- "$script_dir/../.." 2>/dev/null && pwd -P)
  
  # Verify it looks like wizardry
  if [ ! -d "$wizardry_dir/spells" ]; then
    printf 'path-wizard: cannot find wizardry directory\n' >&2
    exit 1
  fi
fi

# Determine spellbook directory
spellbook_dir=${SPELLBOOK_DIR:-${HOME-}/.spellbook}

# Parse mode
mode=${1:-rc}

case "$mode" in
  --eval)
    # Generate commands for eval (immediate use)
    printf '# Wizardry PATH setup (generated by path-wizard)\n'
    printf 'export WIZARDRY_DIR="%s"\n' "$wizardry_dir"
    printf 'export SPELLBOOK_DIR="%s"\n' "$spellbook_dir"
    
    # Add spell directories to PATH
    for dir in "$wizardry_dir"/spells/*; do
      [ -d "$dir" ] || continue
      # Skip hidden directories and special directories
      case "$dir" in
        */.imps|*/.arcana) continue ;;
      esac
      printf 'PATH="%s:$PATH"\n' "$dir"
    done
    
    # Add imp directories to PATH
    for dir in "$wizardry_dir"/spells/.imps/*; do
      [ -d "$dir" ] || continue
      printf 'PATH="%s:$PATH"\n' "$dir"
    done
    
    # Add spellbook
    printf 'PATH="%s:$PATH"\n' "$spellbook_dir"
    printf 'export PATH\n'
    ;;
    
  --rc)
    # Generate commands for rc file (persistent)
    printf '# Wizardry PATH setup (generated by path-wizard)\n'
    printf 'if [ -d "%s" ]; then\n' "$wizardry_dir"
    printf '  export WIZARDRY_DIR="%s"\n' "$wizardry_dir"
    printf '  export SPELLBOOK_DIR="%s"\n' "$spellbook_dir"
    printf '  \n'
    
    # Add spell directories
    printf '  # Add spell directories to PATH\n'
    for dir in "$wizardry_dir"/spells/*; do
      [ -d "$dir" ] || continue
      case "$dir" in
        */.imps|*/.arcana) continue ;;
      esac
      dir_name=$(basename "$dir")
      printf '  [ -d "$WIZARDRY_DIR/spells/%s" ] && PATH="$WIZARDRY_DIR/spells/%s:$PATH"\n' "$dir_name" "$dir_name"
    done
    
    printf '  \n'
    printf '  # Add imp directories to PATH\n'
    # Add imp directories
    for dir in "$wizardry_dir"/spells/.imps/*; do
      [ -d "$dir" ] || continue
      dir_name=$(basename "$dir")
      printf '  [ -d "$WIZARDRY_DIR/spells/.imps/%s" ] && PATH="$WIZARDRY_DIR/spells/.imps/%s:$PATH"\n' "$dir_name" "$dir_name"
    done
    
    printf '  \n'
    printf '  # Add spellbook\n'
    printf '  [ -d "$SPELLBOOK_DIR" ] && PATH="$SPELLBOOK_DIR:$PATH"\n'
    printf '  export PATH\n'
    printf 'fi\n'
    ;;
    
  --check)
    # Check if wizardry directories are in PATH
    found=0
    missing=0
    
    printf 'Checking wizardry directories in PATH...\n\n'
    
    # Check spell directories
    for dir in "$wizardry_dir"/spells/*; do
      [ -d "$dir" ] || continue
      case "$dir" in
        */.imps|*/.arcana) continue ;;
      esac
      
      case ":$PATH:" in
        *":$dir:"*)
          printf '✓ %s\n' "$dir"
          found=$((found + 1))
          ;;
        *)
          printf '✗ %s\n' "$dir"
          missing=$((missing + 1))
          ;;
      esac
    done
    
    # Check imp directories
    for dir in "$wizardry_dir"/spells/.imps/*; do
      [ -d "$dir" ] || continue
      
      case ":$PATH:" in
        *":$dir:"*)
          printf '✓ %s\n' "$dir"
          found=$((found + 1))
          ;;
        *)
          printf '✗ %s\n' "$dir"
          missing=$((missing + 1))
          ;;
      esac
    done
    
    printf '\nSummary: %d directories in PATH, %d missing\n' "$found" "$missing"
    
    if [ "$missing" -gt 0 ]; then
      printf '\nTo add wizardry to PATH, run:\n'
      printf '  eval "$(path-wizard --eval)"\n'
      printf '\nOr add to your shell rc file:\n'
      printf '  path-wizard --rc >> ~/.bashrc\n'
      exit 1
    fi
    ;;
    
  *)
    printf 'path-wizard: unknown option: %s\n' "$mode" >&2
    show_usage >&2
    exit 2
    ;;
esac
