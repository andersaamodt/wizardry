#!/bin/sh

# This spell lists running processes and interactively chooses one to terminate.
# It prompts with ask cantrips and sends a kill signal, customizable via KILL_CMD.


kill_process_usage() {
cat <<'USAGE'
Usage: kill-process

List running processes, prompt you to pick one by number, and then send a kill signal to that PID. Uses ask-number and ask-yn for a gentle, confirmed termination, and you can override the signal command with KILL_CMD.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        kill_process_usage
        exit 0
        ;;
esac
set -eu

# Present the process list so the user can choose what to terminate.
say "List of running processes:"
ps -ax | awk '{print $5}' | tail -n +2 | nl -w 2 -s ') '

PS_NAMES=$(ps -ax | awk '{print $5}' | tail -n +2)

lacks ask-number && { warn "ask-number spell is required to choose a process."; exit 1; }
lacks ask-yn && { warn "ask-yn spell is required to confirm termination."; exit 1; }

total_processes=$(printf '%s\n' "$PS_NAMES" | sed '/^$/d' | wc -l | tr -d ' ')

if [ "$total_processes" -eq 0 ]; then
    warn "No processes available to kill."
    exit 1
fi

choice=$(ask-number "Enter the number of the process you want to kill:" 1 "$total_processes")
selected_name=$(printf '%s\n' "$PS_NAMES" | sed -n "${choice}p")

pid=$(ps -ax | awk '{print $1 " " $5}' | grep "$selected_name" | awk '{print $1}')
if is set "$pid"; then
    if ask-yn "Are you sure you want to kill process $selected_name with pid $pid"; then
        kill_cmd=${KILL_CMD:-kill}

        lacks "$kill_cmd" && { warn "kill command '$kill_cmd' is required to terminate processes."; exit 1; }

        if "$kill_cmd" "$pid"; then
            say "Process $pid ($selected_name) has been killed."
        else
            status=$?
            warn "Failed to kill process $pid ($selected_name)."
            exit "$status"
        fi
    fi
fi
