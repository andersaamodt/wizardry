#!/bin/sh

# Demonstrate wizardry spells at specified levels with narrated output.
# Each demo level corresponds to a banish level and demonstrates the spells
# that are validated and tested by that banish level.

demo_magic_usage() {
  cat <<'USAGE'
Usage: demo-magic [LEVEL]

Demonstrate wizardry features by running checks on spells and narrating results.
Each level demonstrates spells validated by the corresponding banish level.

Arguments:
  LEVEL         Demonstration level (0-29, default: 1)
                Level 0: POSIX & platform foundation
                Level 1: Wizardry installation
                Level 2: Glossary system
                Level 3: Menu system
                Level 4+: Higher-level spells (see SPELL_LEVELS.md)
USAGE
}

# Demo a single level using spell-levels data
demo_level() {
  level=$1
  
  # Get level name and spell list
  level_name=$(banish_level_name "$level")
  spell_list=$(get_level_spells "$level")
  imp_list=$(get_level_imps "$level")
  
  printf '\n'
  printf '=== Level %d: %s ===\n' "$level" "$level_name"
  printf '\n'
  
  # Add level-specific narration and demonstrations
  case "$level" in
    0)
      printf 'The wizard examines the foundation of reality itself...\n'
      printf 'Verifying POSIX compliance and platform compatibility.\n'
      printf '\n'
      
      # Check infrastructure
      if [ -f "${WIZARDRY_DIR}/spells/.imps/sys/invoke-wizardry" ]; then
        printf 'The invoke-wizardry ritual: discovered\n'
      else
        printf 'Warning: invoke-wizardry ritual not found\n' >&2
      fi
      
      if [ -d "${WIZARDRY_DIR}/spells" ]; then
        printf 'The spells grimoire: present\n'
      else
        printf 'Warning: spells grimoire missing\n' >&2
      fi
      
      if [ -d "${WIZARDRY_DIR}/spells/.imps" ]; then
        printf 'The imp summoning circles: inscribed\n'
      else
        printf 'Warning: imp summoning circles not found\n' >&2
      fi
      ;;
      
    1)
      printf 'The wizard gathers the core components of wizardry...\n'
      printf 'Installing the foundation: validation and banishment.\n'
      printf '\n'
      ;;
      
    2)
      printf 'The wizard conjures the glossary system...\n'
      printf 'Words of power take form and meaning.\n'
      printf '\n'
      ;;
      
    3)
      printf 'The wizard weaves interactive menus from pure thought...\n'
      printf 'Terminal manipulation becomes an art form.\n'
      printf '\n'
      ;;
      
    4)
      printf 'The wizard enters the realm of MUD...\n'
      printf 'Rooms and locations gain meaning through extended attributes.\n'
      printf '\n'
      ;;
      
    5)
      printf 'The wizard learns the art of translocation...\n'
      printf 'Marking and jumping between locations in the blink of an eye.\n'
      printf '\n'
      ;;
      
    6)
      printf 'The wizard masters the arcane language of parsing...\n'
      printf 'Command structures bend to the wizards will.\n'
      printf '\n'
      ;;
      
    7)
      printf 'The wizard masters arcane file operations...\n'
      printf 'Copying, trashing, and reading magical inscriptions.\n'
      printf '\n'
      ;;
      
    8)
      printf 'The wizard learns basic cantrips...\n'
      printf 'Asking questions, listing files, and simple transformations.\n'
      printf '\n'
      ;;
      
    9)
      printf 'The wizard channels validation energies...\n'
      printf 'Numbers, paths, and commands yield to verification.\n'
      printf '\n'
      ;;
      
    10)
      printf 'The wizard advances in the cantrip arts...\n'
      printf 'Asking for numbers and memorizing spells into the shell.\n'
      printf '\n'
      ;;
      
    11)
      printf 'The wizard configures the system...\n'
      printf 'Package management and system configuration take shape.\n'
      printf '\n'
      ;;
      
    12)
      printf 'The wizard establishes the testing framework...\n'
      printf 'Self-examination becomes possible.\n'
      printf '\n'
      ;;
      
    13)
      printf 'The wizard learns system maintenance...\n'
      printf 'Updating wizardry and managing processes.\n'
      printf '\n'
      ;;
      
    14)
      printf 'The wizard demonstrates the demonstration itself...\n'
      printf 'Recursion: a wizard demonstrating demonstration magic.\n'
      printf '\n'
      ;;
      
    15)
      printf 'The wizard practices divination...\n'
      printf 'Detecting shells, discovering magic, and identifying rooms.\n'
      printf '\n'
      ;;
      
    16)
      printf 'The wizard enhances the MUD realm...\n'
      printf 'Decoration and player selection capabilities emerge.\n'
      printf '\n'
      ;;
      
    17)
      printf 'The wizard delves into cryptography...\n'
      printf 'Hashing and hash verification become available.\n'
      printf '\n'
      ;;
      
    18)
      printf 'The wizard opens portals to remote realms...\n'
      printf 'SSH keys, portkeys, and remote access materialize.\n'
      printf '\n'
      ;;
      
    19)
      printf 'The wizard manages task priorities...\n'
      printf 'Getting, setting, and voting on priorities.\n'
      printf '\n'
      ;;
      
    20)
      printf 'The wizard erects protective wards...\n'
      printf 'SSH barriers defend against intrusion.\n'
      printf '\n'
      ;;
      
    21)
      printf 'The wizard enchants files with extended attributes...\n'
      printf 'Metadata becomes magical inscription.\n'
      printf '\n'
      ;;
      
    22)
      printf 'The wizard develops psychic abilities (PSI)...\n'
      printf 'Reading contacts and process information.\n'
      printf '\n'
      ;;
      
    23)
      printf 'The wizard becomes a spellcrafter...\n'
      printf 'Creating, editing, and managing new spells.\n'
      printf '\n'
      ;;
      
    24)
      printf 'The wizard constructs core menu infrastructure...\n'
      printf 'Spellbooks and casting interfaces take form.\n'
      printf '\n'
      ;;
      
    25)
      printf 'The wizard builds system menus...\n'
      printf 'Installation, configuration, and synonym management.\n'
      printf '\n'
      ;;
      
    26)
      printf 'The wizard administers the MUD realm...\n'
      printf 'Player management and MUD settings.\n'
      printf '\n'
      ;;
      
    27)
      printf 'The wizard creates specialized menus...\n'
      printf 'Network, services, shutdown, and user management.\n'
      printf '\n'
      ;;
      
    28)
      printf 'The wizard masters system service management...\n'
      printf 'Installing, starting, stopping, and managing services.\n'
      printf '\n'
      ;;
      
    29)
      printf 'The wizard peers into the arcana...\n'
      printf 'Third-party integrations and optional extensions.\n'
      printf '\n'
      
      if [ -d "${WIZARDRY_DIR}/spells/.arcana" ]; then
        printf 'The arcana vault: accessible\n'
      else
        printf 'The arcana vault: sealed (no third-party extensions installed)\n'
      fi
      ;;
      
    *)
      printf 'The wizard channels level %d energies...\n' "$level"
      printf '\n'
      ;;
  esac
  
  # Check spells for this level (note: spell_list is intentionally unquoted for word splitting)
  if [ -n "$spell_list" ]; then
    printf 'Spells at this level:\n'
    # shellcheck disable=SC2086
    validate_spells $spell_list 2>&1 | sed 's/✓ Found spell:/  The wizard casts/; s/^  *//; s/$/ ... ready/'
    
    # Report missing spells if any
    # shellcheck disable=SC2086
    if ! validate_spells $spell_list >/dev/null 2>&1; then
      # shellcheck disable=SC2086
      missing=$(validate_spells --missing-only $spell_list)
      printf '  Warning: missing spells: %s\n' "$missing" >&2
    fi
  fi
  
  # Check imps for this level (note: imp_list is intentionally unquoted for word splitting)
  if [ -n "$imp_list" ]; then
    # Count imps to provide context
    imp_count=$(printf '%s' "$imp_list" | wc -w)
    if [ "$imp_count" -gt 10 ]; then
      printf '\n'
      printf 'Imps summoned at this level: %d micro-helpers\n' "$imp_count"
      printf '  (Core building blocks for spell construction)\n'
      # Don't list individual imps when there are many - it's too verbose
    else
      printf '\n'
      printf 'Imps summoned at this level:\n'
      # shellcheck disable=SC2086
      validate_spells --imps $imp_list 2>&1 | sed 's/✓ Found imp:/  Imp:/; s/^  *//; s/$/ ... bound/'
    fi
    
    # Report missing imps if any
    # shellcheck disable=SC2086
    if ! validate_spells --imps $imp_list >/dev/null 2>&1; then
      # shellcheck disable=SC2086
      missing=$(validate_spells --imps --missing-only $imp_list)
      printf '  Warning: missing imps: %s\n' "$missing" >&2
    fi
  fi
}

demo_magic() {
case "${1-}" in
--help|--usage|-h)
  demo_magic_usage
  return 0
  ;;
esac

set -eu

# Detect WIZARDRY_DIR if not set (for direct execution)
if [ -z "${WIZARDRY_DIR-}" ]; then
  # Try to detect from script location
  if command -v dirname >/dev/null 2>&1 && command -v cd >/dev/null 2>&1 \
     && command -v pwd >/dev/null 2>&1; then
    _script_dir=$(CDPATH= cd -- "$(dirname "$0")" 2>/dev/null && pwd -P) || _script_dir=""
    if [ -n "$_script_dir" ]; then
      _wiz_root=$(CDPATH= cd -- "$_script_dir/../.." 2>/dev/null && pwd -P) || _wiz_root=""
      if [ -n "$_wiz_root" ] && [ -d "$_wiz_root/spells" ]; then
        WIZARDRY_DIR=$_wiz_root
        export WIZARDRY_DIR
      fi
    fi
  fi
  
  # Fallback to standard location
  if [ -z "${WIZARDRY_DIR-}" ] && [ -n "${HOME-}" ] && [ -d "${HOME}/.wizardry/spells" ]; then
    WIZARDRY_DIR="${HOME}/.wizardry"
    export WIZARDRY_DIR
  fi
fi

# Source spell-levels from sys imp
if [ -n "${WIZARDRY_DIR-}" ] && [ -f "${WIZARDRY_DIR}/spells/.imps/sys/spell-levels" ]; then
  . "${WIZARDRY_DIR}/spells/.imps/sys/spell-levels"
else
  printf 'demo-magic: spell-levels imp not found\n' >&2
  return 1
fi

# Load validate_spells function if not already available
if ! command -v validate_spells >/dev/null 2>&1; then
  if [ -f "${WIZARDRY_DIR}/spells/system/validate-spells" ]; then
    # Prevent castable from executing when sourced
    _WIZARDRY_SOURCING_SPELL=1
    # shellcheck source=/dev/null
    . "${WIZARDRY_DIR}/spells/system/validate-spells"
    unset _WIZARDRY_SOURCING_SPELL
  else
    printf 'demo-magic: validate-spells not found\n' >&2
    return 1
  fi
  
  if ! command -v validate_spells >/dev/null 2>&1; then
    printf 'demo-magic: failed to load validate-spells\n' >&2
    return 1
  fi
fi

# Parse level argument
demo_level=1
if [ "$#" -gt 0 ]; then
  case "$1" in
    [0-9]|[0-9][0-9])
      demo_level=$1
      shift
      ;;
    *)
      printf 'demo-magic: invalid level: %s\n' "$1" >&2
      demo_magic_usage >&2
      return 2
      ;;
  esac
fi

# Sandbox with bwrap if not in GitHub Actions and not already sandboxed
if [ "${WIZARDRY_DEMO_IN_BWRAP-0}" -ne 1 ] && [ "${WIZARDRY_DEMO_NO_BWRAP-0}" -ne 1 ]; then
  # Skip bwrap in GitHub Actions (already isolated)
  if [ -z "${GITHUB_ACTIONS-}" ] || [ "${GITHUB_ACTIONS}" != "true" ]; then
    if command -v bwrap >/dev/null 2>&1; then
      # Re-exec with bwrap sandbox
      exec bwrap --unshare-user --ro-bind / / --dev-bind /dev /dev --bind /proc /proc \
        --bind /tmp /tmp --setenv PATH "$PATH" --setenv WIZARDRY_DEMO_IN_BWRAP 1 -- \
        "$0" "$@"
    else
      # bwrap not available - offer to install
      printf 'demo-magic: bubblewrap (bwrap) not found\n' >&2
      printf 'demo-magic: Running demos in an isolated sandbox is recommended for safety.\n' >&2
      
      # Check if we can install it
      if command -v pkg-install >/dev/null 2>&1; then
        if command -v ask_yn >/dev/null 2>&1; then
          if ask_yn "Install bubblewrap now?" yes; then
            printf 'Installing bubblewrap...\n' >&2
            if pkg-install bubblewrap 2>/dev/null || pkg-install bwrap 2>/dev/null; then
              printf 'Bubblewrap installed successfully. Re-running demo-magic...\n' >&2
              exec "$0" "$@"
            else
              printf 'demo-magic: failed to install bubblewrap\n' >&2
            fi
          fi
        fi
      fi
      
      # Either install failed or user declined - ask to continue
      if command -v ask_yn >/dev/null 2>&1; then
        if ! ask_yn "Continue without sandbox?" no; then
          printf 'demo-magic: aborting\n' >&2
          return 1
        fi
      else
        printf 'demo-magic: continuing without sandbox (set WIZARDRY_DEMO_NO_BWRAP=1 to skip this check)\n' >&2
      fi
    fi
  fi
fi

printf '\n'
printf '╔═══════════════════════════════════════════════════════════╗\n'
printf '║         WIZARDRY DEMONSTRATION OF MAGICAL ARTS            ║\n'
printf '╚═══════════════════════════════════════════════════════════╝\n'
printf '\n'
printf 'A circle of chalk flares into view.\n'
printf 'The apprentice wizard prepares to demonstrate mastery.\n'

# Run all levels from 0 to target level
current_level=0
while [ "$current_level" -le "$demo_level" ]; do
  demo_level "$current_level"
  current_level=$((current_level + 1))
done

printf '\n'
printf '═══════════════════════════════════════════════════════════\n'
printf '\n'
printf 'The demonstration concludes.\n'
printf 'The circle closes. Wizardry stands ready.\n'
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
