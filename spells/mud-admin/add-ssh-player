#!/bin/sh

# This spell authorizes a new player to connect via SSH key on a MUD host.
# Run it on the MUD host computer to add players with limited permissions.

show_usage() {
        cat <<'USAGE'
Usage: add-ssh-player

Interactively create a new player account on the MUD host. Prompts for
player name and SSH key, then creates a system user with the key.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

printf '%s\n' "This spell authorizes a new player to connect to this computer via their player key (SSH key). Run this on the MUD host computer."
printf '%s\n' "A new user account will be created on your system with limited permissions for the new player."
printf '%s\n' 'MUD users are in the group "mud", and this group only has access to your shared rooms (folders) in the MUD.'

printf '%s' "Enter player name: "
read -r playername

# Check if user already exists. Check now so they don't have to enter the SSH key over and over.
if id "$playername" >/dev/null 2>&1; then
    printf '%s\n' "Error: user $playername already exists. Please delete the existing user first and try again."
    exit 1
fi

printf '%s' "Enter SSH key: "
read -r sshkey

# Check if key already exists in authorized_keys file
if grep -q "$sshkey" ~/.ssh/authorized_keys 2>/dev/null; then
    printf '%s\n' "Error: key already exists in authorized_keys file. Please delete the existing key first and try again."
    exit 1
fi

# Create new system user
useradd "$playername"

# Create the directories on this path, if they don't exist
mkdir -p "/home/$playername/.ssh"

# Add key to authorized_keys file in their home directory, so they can log in as themselves
printf '%s %s@mud\n' "$sshkey" "$playername" >> "/home/$playername/.ssh/authorized_keys"
