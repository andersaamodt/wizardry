#!/bin/sh

# Toggle parse-enabled setting in MUD config - must be sourced for immediate effect

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: . toggle-parse    OR    toggle parse    (via parse/gloss)

Toggle the parse-enabled setting. When parse is enabled, generate-glosses
creates first-word glosses that enable natural language commands like
"read magic" instead of "read-magic".

Changes take effect immediately in the current shell.

This spell must be sourced (not executed) to affect your current shell.
USAGE
  exit 0
  ;;
esac

# Uncastable pattern - detect if sourced
toggle_parse_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) toggle_parse_sourced=1 ;;
  esac
else
  toggle_parse_base=${0##*/}
  case "$toggle_parse_base" in
    sh|dash|bash|zsh|ksh|mksh) toggle_parse_sourced=1 ;;
    toggle-parse) toggle_parse_sourced=0 ;;
    parse) toggle_parse_sourced=1 ;;  # Sourced via parse gloss function
    *) toggle_parse_sourced=1 ;;
  esac
fi

if [ "$toggle_parse_sourced" -eq 0 ]; then
  printf '%s\n' "This spell must be sourced. Use:  . toggle-parse  OR  toggle parse" >&2
  return 1 2>/dev/null || exit 1
fi
unset toggle_parse_sourced toggle_parse_base

set +e  # Permissive mode since we're in user's shell
set -u


# Determine config file location
SPELLBOOK_DIR="${SPELLBOOK_DIR:-$HOME/.spellbook}"
CONFIG_FILE="$SPELLBOOK_DIR/.mud"

# Ensure spellbook directory exists
mkdir -p "$SPELLBOOK_DIR"
touch "$CONFIG_FILE"

# Check current state
current_value=""
if config-has "$CONFIG_FILE" "parse-enabled" 2>/dev/null; then
  current_value=$(config-get "$CONFIG_FILE" "parse-enabled" 2>/dev/null)
else
  # Not set, use default
  current_value=$(mud-defaults parse-enabled 2>/dev/null || printf '1')
fi

if [ "$current_value" = "1" ]; then
  # Currently enabled, disable it
  config-set "$CONFIG_FILE" "parse-enabled" "0"
  
  # Unload gloss functions immediately
  # Get list of all gloss functions and unset them
  if command -v declare >/dev/null 2>&1; then
    # bash/zsh - use declare -F to list functions
    for func in $(declare -F 2>/dev/null | sed 's/^declare -f //'); do
      # Skip critical shell functions and wizardry core functions
      case "$func" in
        # Skip shell builtins and critical functions
        cd|ls|ll|la|type|which|command) continue ;;
        # Skip test framework functions
        _*|test_*|run_*|assert_*|finish_*|make_*|skip_*) continue ;;
        # Unset everything else (these are gloss functions)
        *) unset -f "$func" 2>/dev/null || true ;;
      esac
    done
  fi
  
  # Also unalias all aliases (gloss-generated aliases for uncastable spells)
  if command -v unalias >/dev/null 2>&1; then
    # Get all aliases and unset them (except critical ones)
    for alias_name in $(alias 2>/dev/null | sed 's/=.*//' | sed 's/^alias //'); do
      case "$alias_name" in
        # Skip critical aliases
        ls|ll|la|grep|egrep|fgrep) continue ;;
        # Unset everything else
        *) unalias "$alias_name" 2>/dev/null || true ;;
      esac
    done
  fi
  
  printf '%s\n' "✓ Parse disabled and gloss functions unloaded from your current shell."
  return 0
fi

# Currently disabled or not set, enable it
config-set "$CONFIG_FILE" "parse-enabled" "1"

# Load gloss functions immediately by sourcing invoke-wizardry
# This will regenerate the gloss cache with parse-enabled=1
invoke_wizardry_path="${WIZARDRY_DIR:-$HOME/.wizardry}/spells/.imps/sys/invoke-wizardry"
if [ -f "$invoke_wizardry_path" ]; then
  # Source invoke-wizardry to load gloss functions
  # Reset WIZARDRY_INVOKED to force reinvocation in the current environment
  WIZARDRY_INVOKED=0 . "$invoke_wizardry_path" 2>/dev/null || {
    printf '%s\n' "Warning: Failed to load gloss functions. Run 'invoke-wizardry' to activate."
    return 1
  }
  printf '%s\n' "✓ Parse enabled and gloss functions loaded in your current shell."
else
  printf '%s\n' "✓ Parse enabled. Run 'invoke-wizardry' to load gloss functions."
fi
