#!/bin/sh

# DEPRECATED: command-not-found hook is now automatically installed by invoke-wizardry.
# This spell is no longer needed and will be removed in a future version.

handle_command_not_found_usage() {
cat <<'USAGE'
Usage: handle-command-not-found {install|uninstall}

DEPRECATED: The command-not-found hook is now automatically installed by
invoke-wizardry when you install wizardry. This spell is no longer needed.

If you previously installed this hook manually, you can safely run:
  handle-command-not-found uninstall

to remove the old hook. The new hook in invoke-wizardry will continue to work.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  handle_command_not_found_usage
  exit 0
  ;;
esac

set -eu

# Inform users that this is deprecated
printf '%s\n' "handle-command-not-found: This spell is deprecated." >&2
printf '%s\n' "handle-command-not-found: Command-not-found hook is now built into invoke-wizardry." >&2
printf '%s\n' "" >&2

SCRIPT_SOURCE=$0
case $SCRIPT_SOURCE in
*/*)
  SCRIPT_DIR=${SCRIPT_SOURCE%/*}
  ;;
*)
  SCRIPT_DIR=.
  ;;
esac
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd -P)

handle_command_not_found_warn() {
  printf '%s\n' "handle-command-not-found: $1" >&2
}

# Run nixos-rebuild or home-manager switch to apply NixOS configuration changes
handle_command_not_found_run_nix_rebuild() {
  # Allow tests to skip the rebuild
  [ "${WIZARDRY_SKIP_NIX_REBUILD-}" = "1" ] && return 0

  rebuild_success=0

  # Try to detect if we should use sudo or doas
  priv_cmd=""
  command -v sudo >/dev/null 2>&1 && priv_cmd="sudo"
  command -v doas >/dev/null 2>&1 && [ -z "$priv_cmd" ] && priv_cmd="doas"

  # Try home-manager first (doesn't need privileges)
  if command -v home-manager >/dev/null 2>&1; then
    printf '%s\n' "handle-command-not-found: running home-manager switch..."
    if home-manager switch; then
      printf '%s\n' "handle-command-not-found: user environment rebuilt successfully."
      rebuild_success=1
    fi
  fi

  # If home-manager didn't work and we have privilege escalation, try nixos-rebuild
  if [ "$rebuild_success" -eq 0 ] && [ -n "$priv_cmd" ] \
      && command -v nixos-rebuild >/dev/null 2>&1; then
    printf '%s\n' "handle-command-not-found: running $priv_cmd nixos-rebuild switch..."
    if "$priv_cmd" nixos-rebuild switch; then
      printf '%s\n' "handle-command-not-found: NixOS system rebuilt successfully."
      rebuild_success=1
    fi
  fi

  if [ "$rebuild_success" -eq 0 ]; then
    handle_command_not_found_warn "NixOS configuration could not be automatically rebuilt."
    return 1
  fi

  return 0
}

# Cache for detect-rc-file output to avoid multiple calls
_detect_rc_cache=""

# Handle command-line invocation for install/uninstall commands
case "${1-}" in
install)
  printf '%s\n' "handle-command-not-found: Installation is deprecated." >&2
  printf '%s\n' "handle-command-not-found: The command-not-found hook is now automatically installed by invoke-wizardry." >&2
  printf '%s\n' "handle-command-not-found: No action needed - wizardry already provides this functionality." >&2
  exit 0
  ;;
uninstall)
  # Detect rc format and file
  rc_format="shell"
  rc_file=""
  
  if [ -n "${WIZARDRY_RC_FORMAT-}" ]; then
    rc_format="$WIZARDRY_RC_FORMAT"
  fi
  
  if [ -n "${WIZARDRY_RC_FILE-}" ]; then
    rc_file="$WIZARDRY_RC_FILE"
  else
    # Try detect-rc-file
    if command -v detect-rc-file >/dev/null 2>&1; then
      if _detect_rc_cache=$(detect-rc-file 2>/dev/null); then
        while IFS= read -r line; do
          case $line in
          rc_file=*)
            rc_value=${line#rc_file=}
            [ -n "$rc_value" ] && rc_file="$rc_value"
            ;;
          format=*)
            format_value=${line#format=}
            [ -n "$format_value" ] && rc_format="$format_value"
            ;;
          esac
        done <<EOF
$_detect_rc_cache
EOF
      fi
    fi
    
    # Fallback
    if [ -z "$rc_file" ]; then
      if [ -z "${HOME-}" ]; then
        handle_command_not_found_warn "HOME is not set; cannot determine rc file."
        exit 1
      fi
      
      shell_name=${SHELL-}
      case ${shell_name##*/} in
      zsh) rc_file="$HOME/.zshrc" ;;
      *) rc_file="$HOME/.bashrc" ;;
      esac
    fi
  fi
  
  if [ ! -f "$rc_file" ]; then
    printf '%s\n' "handle-command-not-found: no rc file found at '$rc_file'."
    exit 0
  fi
  
  # Check if hook is present
  hook_present=0
  if grep -Fq '# >>> wizardry command-not-found >>>' "$rc_file"; then
    hook_present=1
  elif grep -Fq '#wizardry: command-not-found' "$rc_file"; then
    hook_present=1
  elif grep -Fq 'WIZARDRY_COMMAND_NOT_FOUND' "$rc_file"; then
    hook_present=1
  fi
  
  if [ "$hook_present" -eq 0 ]; then
    printf '%s\n' "handle-command-not-found: not installed in '$rc_file'."
    exit 0
  fi

  # Detect format from file extension if needed
  if [ "$rc_format" = "shell" ]; then
    case $rc_file in
    *.nix) rc_format="nix" ;;
    esac
  fi

  # For nix format, use nix-shell-remove to remove the block
  if [ "$rc_format" = "nix" ]; then
    nix_helper=""
    if [ -x "$SCRIPT_DIR/../../.imps/sys/nix-shell-remove" ]; then
      nix_helper="$SCRIPT_DIR/../../.imps/sys/nix-shell-remove"
    elif command -v nix-shell-remove >/dev/null 2>&1; then
      nix_helper=$(command -v nix-shell-remove)
    fi

    if [ -n "$nix_helper" ]; then
      if "$nix_helper" command-not-found "$rc_file"; then
        printf '%s\n' "handle-command-not-found: uninstalled hook from '$rc_file'."
        # Run nixos-rebuild to apply the changes
        handle_command_not_found_run_nix_rebuild || true
        exit 0
      else
        handle_command_not_found_warn "unable to update '$rc_file'."
        exit 1
      fi
    fi
    # nix-shell-remove helper not found - handle_command_not_found_warn and attempt shell method fallback
    handle_command_not_found_warn "nix-shell-remove imp not found; attempting shell-style removal (may not work for nix files)."
  fi

  # Shell format: use sed to remove the block
  tmp_file=$(temp-file wizardry-cnf) || exit 1
  trap 'cleanup-file "$tmp_file"' EXIT HUP INT TERM
  sed '/^# >>> wizardry command-not-found >>>$/,/^# <<< wizardry command-not-found <<</d' "$rc_file" >"$tmp_file"
  if ! mv "$tmp_file" "$rc_file"; then
    trap - EXIT HUP INT TERM
    rm -f "$tmp_file"
    handle_command_not_found_warn "unable to update '$rc_file'."
    exit 1
  fi
  trap - EXIT HUP INT TERM
  printf '%s\n' "handle-command-not-found: uninstalled hook from '$rc_file'."
  exit 0
  ;;
*)
  handle_command_not_found_usage >&2
  exit 1
  ;;
esac
