#!/bin/sh

# The cd cantrip: source this file to enable the cd hook that runs 'look'.
# Toggle with: toggle-cd (manages ~/.spellbook/.mud/config file)

cd_usage() {
cat <<'USAGE'
Usage: Source this file in your shell rc file to enable the cd hook.

    . $HOME/.wizardry/spells/.arcana/mud/cd

Then use 'toggle-cd' to enable/disable the hook.

The hook runs 'look' after every successful directory change.
USAGE
}

# Handle --help when run directly (before defining cd function)
case "${1-}" in
--help|--usage|-h)
    cd_usage
    exit 0
    ;;
esac

# Load uncastable imp for direct execution
if ! command -v uncastable >/dev/null 2>&1; then
  if [ -n "${WIZARDRY_DIR-}" ]; then
    _i="$WIZARDRY_DIR/spells/.imps/sys"
  elif [ -n "${ROOT_DIR-}" ]; then
    _i="$ROOT_DIR/spells/.imps/sys"
  else
    _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
    _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
    _i="${_r}/spells/.imps/sys"
  fi
  [ -f "$_i/uncastable" ] && . "$_i/uncastable"
fi

uncastable cd

# Explicitly use permissive error handling - this file is meant to be sourced into user's shell
# and we don't want to change their shell error handling with strict mode
# We don't set +u because our global usage provides safe defaults
set +e

# The cd override - checks setting in .mud/config file before running look
cd() {
    command cd "$@" || return $?
    
    # Check if cd-look is enabled via config file (cd-look=1)
    config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud/config"
    if [ -f "$config_file" ] && grep -q "^cd-look=1$" "$config_file" 2>/dev/null; then
        command -v look >/dev/null 2>&1 && look 2>/dev/null || true
    fi
}
