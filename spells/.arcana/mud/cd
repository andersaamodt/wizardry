#!/bin/sh

# The cd cantrip: source this file to enable the cd hook that runs 'look'.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: Source this file in your shell rc file to enable the cd hook.

    . $HOME/.wizardry/spells/.arcana/mud/cd

Then use 'toggle-cd' to enable/disable the hook.

The hook runs 'look' after every successful directory change.
USAGE
  exit 0
  ;;
esac

# Enforce sourced-only behavior
# uncastable must be sourced (invoked), never executed (cast)
if ! command -v uncastable >/dev/null 2>&1; then
  . uncastable
fi

# Explicitly use permissive error handling - this file is meant to be sourced into user's shell
# and we don't want their shell to exit on command failures
# We DO use set -u because our global usage provides safe defaults (${SPELLBOOK_DIR:-...})
set +e
set -u

# The cd override - checks setting in .mud config file before running look
    command cd "$@" || return $?
    
    # Check if cd-hook is enabled via config file (cd-hook=1)
    config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
    if [ -f "$config_file" ] && grep -q "^cd-hook=1$" "$config_file" 2>/dev/null; then
        command -v look >/dev/null 2>&1 && look 2>/dev/null || true
    fi
