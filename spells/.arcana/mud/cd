#!/bin/sh

# The cd cantrip: source this file to enable the cd hook that runs 'look'.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: Source this file in your shell rc file to enable the cd hook.

    . $HOME/.wizardry/spells/.arcana/mud/cd

Then use 'toggle-cd' to enable/disable the hook.

The hook runs 'look' after every successful directory change.
USAGE
  exit 0
  ;;
esac

# Uncastable pattern - ensures spell is sourced, not executed
_cd_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) _cd_sourced=1 ;;
  esac
else
  _cd_base=${0##*/}
  case "$_cd_base" in
    sh|dash|bash|zsh|ksh|mksh) _cd_sourced=1 ;;
    cd) _cd_sourced=0 ;;
    *) _cd_sourced=1 ;;
  esac
fi

if [ "$_cd_sourced" -eq 0 ]; then
  printf '%s\n' "This spell cannot be cast directly. Invoke it with: . cd" >&2
  return 1 2>/dev/null || exit 1
fi
unset _cd_sourced _cd_base

# Explicitly use permissive error handling - this file is meant to be sourced into user's shell
# and we don't want their shell to exit on command failures
# We DO use set -u because our global usage provides safe defaults (${SPELLBOOK_DIR:-...})
set +e
set -u

# The cd override - checks setting in .mud config file before running look and moving avatar
cd() {
    command cd "$@" || return $?
    
    # Check if cd-hook is enabled via config file (cd-hook=1)
    config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
    if [ -f "$config_file" ] && grep -q "^cd-hook=1$" "$config_file" 2>/dev/null; then
        command -v look >/dev/null 2>&1 && look 2>/dev/null || true
    fi
    
    # Move avatar if avatar system is enabled
    if [ -f "$config_file" ] && grep -q "^avatar-enabled=1$" "$config_file" 2>/dev/null; then
        _move_avatar 2>/dev/null || true
    fi
}

# Helper function to move avatar to current directory
_move_avatar() {
    config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
    old_path=$(grep "^avatar-path=" "$config_file" 2>/dev/null | cut -d= -f2-)
    
    if [ -n "$old_path" ] && [ -d "$old_path" ]; then
        avatar_name=$(basename "$old_path")
        new_path="$PWD/$avatar_name"
        
        # Only move if different location
        if [ "$old_path" != "$new_path" ]; then
            # Move avatar folder to new location
            if mv "$old_path" "$new_path" 2>/dev/null; then
                # Update config with new path
                if command -v config-set >/dev/null 2>&1; then
                    config-set "$config_file" "avatar-path" "$new_path" 2>/dev/null || true
                fi
            fi
        fi
    fi
}

