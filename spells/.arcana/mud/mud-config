#!/bin/sh

# Manage MUD feature configuration stored in $SPELLBOOK_DIR/.mud

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: mud-config {get|set|toggle|list} [FEATURE] [VALUE]

Manage MUD feature toggles stored in $SPELLBOOK_DIR/.mud. Supports get, set, toggle, and list for features like parse-enabled, touch-hook, fantasy-theme, inventory, and combat.
USAGE
  exit 0
  ;;
esac

set -eu

# Resolve config file (inline env-or logic)
if [ -n "${SPELLBOOK_DIR-}" ]; then
  spell_home="$SPELLBOOK_DIR"
else
  spell_home="${HOME:-.}/.spellbook"
fi
config_dir="$spell_home/.mud"
config_file="$config_dir/config"

# Ensure spellbook directory exists
if [ ! -d "$spell_home" ]; then
  mkdir -p "$spell_home" || {
    printf '%s\n' "mud-config: cannot create spellbook directory '$spell_home'" >&2
    exit 1
  }
fi

# Ensure config directory exists
if [ ! -d "$config_dir" ]; then
  mkdir -p "$config_dir" || {
    printf '%s\n' "mud-config: cannot create config directory '$config_dir'" >&2
    exit 1
  }
fi

# Ensure config file exists
if [ ! -f "$config_file" ]; then
  touch "$config_file" || {
    printf '%s\n' "mud-config: cannot create config file '$config_file'" >&2
    exit 1
  }
fi

# Parse command
command=${1-list}
feature=${2-}
value=${3-}

case "$command" in
  get)
    if [ -z "$feature" ]; then
      printf '%s\n' "mud-config: feature name required for get" >&2
      exit 1
    fi
    config-get "$config_file" "$feature"
    ;;
  set)
    if [ -z "$feature" ] || [ -z "$value" ]; then
      printf '%s\n' "mud-config: feature name and value required for set" >&2
      exit 1
    fi
    config-set "$config_file" "$feature" "$value"
    ;;
  toggle)
    if [ -z "$feature" ]; then
      printf '%s\n' "mud-config: feature name required for toggle" >&2
      exit 1
    fi
    current=$(config-get "$config_file" "$feature" 2>/dev/null || printf '0')
    if [ "$current" = "1" ]; then
      config-set "$config_file" "$feature" "0"
      printf '0\n'
    else
      config-set "$config_file" "$feature" "1"
      printf '1\n'
    fi
    ;;

  list)
    if [ -f "$config_file" ]; then
      cat "$config_file"
    fi
    ;;
  *)
    printf '%s\n' "mud-config: unknown command '$command'" >&2
    printf '%s\n' "Usage: mud-config {get|set|toggle|list} [FEATURE] [VALUE]" >&2
    exit 1
    ;;
esac
