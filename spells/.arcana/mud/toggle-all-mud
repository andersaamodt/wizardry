#!/bin/sh

# Toggle all MUD features on or off.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: toggle-all-mud [--enable|--disable]

Toggle all MUD features on or off at once; with no arguments it flips based on the current state. The cd hook is managed separately via toggle-cd.
USAGE
  exit 0
  ;;
esac

set -eu


# Determine config file location
SPELLBOOK_DIR="${SPELLBOOK_DIR:-$HOME/.spellbook}"
CONFIG_FILE="$SPELLBOOK_DIR/.mud"

# Ensure spellbook directory exists
mkdir -p "$SPELLBOOK_DIR"
touch "$CONFIG_FILE"

# List of config-based features
FEATURES="parse-enabled mud-enabled avatar touch-hook cd-look cd-listen"

# Determine action based on arguments or current state
action=""
case "${1-}" in
  --enable)
    action="enable"
    ;;
  --disable)
    action="disable"
    ;;
  "")
    # Auto-detect: if any is disabled, enable all; otherwise disable all
    all_enabled=1
    for feature in $FEATURES; do
      state=$(config-get "$CONFIG_FILE" "$feature" 2>/dev/null || printf '0')
      if [ "$state" = "0" ] || [ -z "$state" ]; then
        all_enabled=0
        break
      fi
    done
    if [ "$all_enabled" -eq 1 ]; then
      action="disable"
    else
      action="enable"
    fi
    ;;
  *)
    printf '%s\n' "toggle-all-mud: unknown option '$1'" >&2
    exit 1
    ;;
esac

# Apply action to all features
if [ "$action" = "enable" ]; then
  printf '%s\n' "Enabling all MUD features..."
  for feature in $FEATURES; do
    config-set "$CONFIG_FILE" "$feature" "1"
  done
  
  # Enable Tor hosting if not already enabled
  if command -v is-tor-installed >/dev/null 2>&1 && is-tor-installed; then
    # Check if tor is already configured
    torrc_path=""
    if command -v torrc-path >/dev/null 2>&1; then
      torrc_path=$(torrc-path 2>/dev/null) || torrc_path=""
    fi
    if [ -z "$torrc_path" ]; then
      if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
        for path in /usr/local/etc/tor/torrc /opt/local/etc/tor/torrc; do
          if [ -f "$path" ]; then
            torrc_path="$path"
            break
          fi
        done
      else
        if [ -f /etc/tor/torrc ]; then
          torrc_path="/etc/tor/torrc"
        fi
      fi
    fi
    
    if [ -n "$torrc_path" ] && [ -f "$torrc_path" ]; then
      if ! grep -E -q "^[[:space:]]*HiddenServiceDir.*/mud(/)?$" "$torrc_path" 2>/dev/null; then
        printf '%s\n' "Enabling Tor hosting..."
        setup-tor -y >/dev/null 2>&1 || true
      fi
    fi
  fi
  
  printf '%s\n' "✓ All MUD features enabled."
else
  printf '%s\n' "Disabling all MUD features..."
  for feature in $FEATURES; do
    config-set "$CONFIG_FILE" "$feature" "0"
  done
  
  # Disable Tor hosting if enabled
  if command -v is-tor-installed >/dev/null 2>&1 && is-tor-installed; then
    torrc_path=""
    if command -v torrc-path >/dev/null 2>&1; then
      torrc_path=$(torrc-path 2>/dev/null) || torrc_path=""
    fi
    if [ -z "$torrc_path" ]; then
      if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
        for path in /usr/local/etc/tor/torrc /opt/local/etc/tor/torrc; do
          if [ -f "$path" ]; then
            torrc_path="$path"
            break
          fi
        done
      else
        if [ -f /etc/tor/torrc ]; then
          torrc_path="/etc/tor/torrc"
        fi
      fi
    fi
    
    if [ -n "$torrc_path" ] && [ -f "$torrc_path" ]; then
      if grep -E -q "^[[:space:]]*HiddenServiceDir.*/mud(/)?$" "$torrc_path" 2>/dev/null; then
        printf '%s\n' "Disabling Tor hosting..."
        remove-tor-hidden-service -y >/dev/null 2>&1 || true
      fi
    fi
  fi
  
  printf '%s\n' "✓ All MUD features disabled."
fi
