#!/bin/sh

# Toggle all MUD features on or off.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: toggle-all-mud [--enable|--disable]

Toggle all MUD features on or off at once; with no arguments it flips based on the current state. The cd hook is managed separately via toggle-cd.
USAGE
  exit 0
  ;;
esac

set -eu

# Get script directory to find imps
SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
ROOT_DIR=$(cd "$SCRIPT_DIR/../../.." && pwd -P)
IMPS_DIR="$ROOT_DIR/spells/.imps/fs"

# Determine config file location
SPELLBOOK_DIR="${SPELLBOOK_DIR:-$HOME/.spellbook}"
CONFIG_FILE="$SPELLBOOK_DIR/.mud"

# Ensure spellbook directory exists
mkdir -p "$SPELLBOOK_DIR"
touch "$CONFIG_FILE"

# List of config-based features
FEATURES="parse-enabled mud-enabled avatar touch-hook cd-look"

# Determine action based on arguments or current state
action=""
case "${1-}" in
  --enable)
    action="enable"
    ;;
  --disable)
    action="disable"
    ;;
  "")
    # Auto-detect: if any is disabled, enable all; otherwise disable all
    all_enabled=1
    for feature in $FEATURES; do
      state=$("$IMPS_DIR/config-get" "$CONFIG_FILE" "$feature" 2>/dev/null || printf '0')
      if [ "$state" = "0" ] || [ -z "$state" ]; then
        all_enabled=0
        break
      fi
    done
    if [ "$all_enabled" -eq 1 ]; then
      action="disable"
    else
      action="enable"
    fi
    ;;
  *)
    printf '%s\n' "toggle-all-mud: unknown option '$1'" >&2
    exit 1
    ;;
esac

# Apply action to all features
if [ "$action" = "enable" ]; then
  printf '%s\n' "Enabling all MUD features..."
  for feature in $FEATURES; do
    "$IMPS_DIR/config-set" "$CONFIG_FILE" "$feature" "1"
  done
  printf '%s\n' "✓ All MUD features enabled."
else
  printf '%s\n' "Disabling all MUD features..."
  for feature in $FEATURES; do
    "$IMPS_DIR/config-set" "$CONFIG_FILE" "$feature" "0"
  done
  printf '%s\n' "✓ All MUD features disabled."
fi
