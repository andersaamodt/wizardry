#!/bin/sh

# The cd cantrip: source this file to enable the cd hook that runs 'look'.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: Source this file in your shell rc file to enable the cd hook.

    . $HOME/.wizardry/spells/.arcana/mud/load-cd-hook

Then use 'toggle-cd' to enable/disable the hook.

The hook runs 'look' after every successful directory change.
USAGE
  exit 0
  ;;
esac

# Uncastable pattern - ensures spell is sourced, not executed
cd_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) cd_sourced=1 ;;
  esac
else
  cd_base=${0##*/}
  case "$cd_base" in
    sh|dash|bash|zsh|ksh|mksh) cd_sourced=1 ;;
    load-cd-hook) cd_sourced=0 ;;
    *) cd_sourced=1 ;;
  esac
fi

if [ "$cd_sourced" -eq 0 ]; then
  printf '%s\n' "This spell cannot be cast directly. Invoke it with: . cd" >&2
  return 1 2>/dev/null || exit 1
fi
unset cd_sourced cd_base

# Explicitly use permissive error handling - this file is meant to be sourced into user's shell
# and we don't want their shell to exit on command failures
# We DO use set -u because our global usage provides safe defaults (${SPELLBOOK_DIR:-...})
set +e
set -u

# The cd override - calls cd-hook imp after successful directory change
cd() {
    command cd "$@" || return $?
    command -v cd-hook >/dev/null 2>&1 && cd-hook || true
}

