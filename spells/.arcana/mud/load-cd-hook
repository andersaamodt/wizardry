#!/bin/sh

# The cd cantrip: source this file to enable the cd hook that runs 'look'.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: Source this file in your shell rc file to enable the cd hook.

    . $HOME/.wizardry/spells/.arcana/mud/load-cd-hook

Then use 'toggle-cd' to enable/disable the hook.

The hook runs 'look' after every successful directory change.
USAGE
  exit 0
  ;;
esac

# Uncastable pattern - ensures spell is sourced, not executed
cd_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) cd_sourced=1 ;;
  esac
else
  cd_base=${0##*/}
  case "$cd_base" in
    sh|dash|bash|zsh|ksh|mksh) cd_sourced=1 ;;
    load-cd-hook) cd_sourced=0 ;;
    *) cd_sourced=1 ;;
  esac
fi

if [ "$cd_sourced" -eq 0 ]; then
  printf '%s\n' "This spell cannot be cast directly. Invoke it with: . cd" >&2
  return 1 2>/dev/null || exit 1
fi
unset cd_sourced cd_base

# Uncastable spells must remember shell mode and restore on all exits
load_cd_hook_saved_opts=$(set +o)

# Explicitly use permissive error handling - this file is meant to be sourced into user's shell
# and we don't want their shell to exit on command failures
# We DO use set -u because our global usage provides safe defaults (${SPELLBOOK_DIR:-...})
set +e
set -u

# The cd override - calls cd-hook imp after successful directory change
cd() {
    # Save current shell options (must restore before ALL returns)
    cd_saved_opts=$(set +o)
    
    # Use builtin for zsh/bash (where it's required for function override), command for POSIX sh
    # We use eval to check for bash/zsh in a way that won't fail in POSIX sh
    # This is necessary because 'builtin cd' is required in zsh, but doesn't exist in pure POSIX sh
    if eval '[ -n "${BASH_VERSION:-}" ] || [ -n "${ZSH_VERSION:-}" ]' 2>/dev/null; then
        # In bash/zsh, must use 'builtin' to call the actual cd builtin from within override function
        eval 'builtin cd "$@"'
        cd_exit_code=$?
    else
        command cd "$@"
        cd_exit_code=$?
    fi
    
    # If cd failed, restore opts and return the error code
    if [ "$cd_exit_code" -ne 0 ]; then
        cd_return=$cd_exit_code
        eval "$cd_saved_opts"
        unset cd_saved_opts cd_exit_code
        return $cd_return
    fi
    
    # cd succeeded, we can unset cd_exit_code now
    unset cd_exit_code
    
    # Run cd-hook logic inline so listen can access PS1
    # (cd-hook is executed, not sourced, so listen wouldn't have PS1 access otherwise)
    
    # Check if cd-look is enabled via config file (defaults to enabled when unset)
    # Skip automatic look if JUMP_TO_MARKER_ACTIVE is set (jump-to-marker handles it)
    cd_config_file="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
    cd_look_value=""
    if [ -f "$cd_config_file" ]; then
        cd_look_value=$(grep "^cd-look=" "$cd_config_file" 2>/dev/null | \
            cut -d= -f2- || printf '')
    fi
    # Default to enabled (1) if not set
    if [ -z "$cd_look_value" ]; then
        cd_look_value=$(command -v mud-defaults >/dev/null 2>&1 && \
            mud-defaults cd-look 2>/dev/null || printf '1')
    fi
    if [ "$cd_look_value" = "1" ] && [ -z "${JUMP_TO_MARKER_ACTIVE-}" ]; then
        command -v look >/dev/null 2>&1 && look 2>/dev/null || true
    fi
    
    # Check if cd-listen is enabled
    cd_listen_value=""
    if [ -f "$cd_config_file" ]; then
        cd_listen_value=$(grep "^cd-listen=" "$cd_config_file" 2>/dev/null | \
            cut -d= -f2- || printf '')
    fi
    # Default to disabled (0) if not set
    if [ -z "$cd_listen_value" ]; then
        cd_listen_value=$(command -v mud-defaults >/dev/null 2>&1 && \
            mud-defaults cd-listen 2>/dev/null || printf '0')
    fi
    if [ "$cd_listen_value" = "1" ]; then
        # Source listen directly so it can access PS1 from this shell context
        if command -v listen >/dev/null 2>&1; then
            . listen 2>/dev/null || true
        fi
    fi
    
    # Move avatar if avatar system is enabled (defaults to disabled when unset)
    cd_avatar_value=""
    if [ -f "$cd_config_file" ]; then
        cd_avatar_value=$(grep "^avatar=" "$cd_config_file" 2>/dev/null | \
            cut -d= -f2- || printf '')
    fi
    # Default to disabled (0) if not set
    if [ -z "$cd_avatar_value" ]; then
        cd_avatar_value=$(command -v mud-defaults >/dev/null 2>&1 && \
            mud-defaults cd-listen 2>/dev/null || printf '0')
    fi
    if [ "$cd_avatar_value" = "1" ]; then
        command -v move-avatar >/dev/null 2>&1 && move-avatar 2>/dev/null || true
    fi
    
    # Clean up variables
    unset cd_config_file cd_look_value cd_listen_value cd_avatar_value
    
    # Restore shell options before returning
    eval "$cd_saved_opts"
    unset cd_saved_opts
}

# Set up shell completion for the cd function
# This ensures tab completion still works after overriding cd with a function
if eval '[ -n "${BASH_VERSION:-}" ]' 2>/dev/null; then
    # Bash: Use directory completion for cd function
    complete -d cd 2>/dev/null || true
elif eval '[ -n "${ZSH_VERSION:-}" ]' 2>/dev/null; then
    # Zsh: Use the builtin _cd completion function
    # compdef is only available when zsh completion system is loaded
    if command -v compdef >/dev/null 2>&1; then
        compdef _cd cd 2>/dev/null || true
    fi
fi

# Restore opts
eval "$load_cd_hook_saved_opts"
unset load_cd_hook_saved_opts

