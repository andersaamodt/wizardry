#!/bin/sh

# Toggle cd hook on/off by installing or uninstalling the cd spell

show_usage() {
cat <<'USAGE'
Usage: toggle-cd

Turn the cd hook that runs 'look' after each directory change on or off. Restart your shell or source your rc file after toggling.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
CD_SPELL="$SCRIPT_DIR/cd"

if [ ! -x "$CD_SPELL" ]; then
        printf '%s\n' "Error: cd spell not found at '$CD_SPELL'." >&2
        exit 1
fi

# Check if cd hook is currently installed by checking the rc file
# This avoids the silent behavior where uninstall would run nixos-rebuild
# without any feedback until it completes.
is_installed=0
rc_file=""
if [ -n "${WIZARDRY_RC_FILE-}" ]; then
        rc_file="$WIZARDRY_RC_FILE"
elif command -v detect-rc-file >/dev/null 2>&1; then
        if detected=$(detect-rc-file 2>/dev/null); then
                while IFS= read -r line; do
                        case $line in
                        rc_file=*)
                                rc_file="${line#rc_file=}"
                                break
                                ;;
                        esac
                done <<EOF
$detected
EOF
        fi
fi

# Fallback to shell-specific defaults
if [ -z "$rc_file" ] && [ -n "${HOME-}" ]; then
        shell_name="${SHELL-}"
        case ${shell_name##*/} in
        zsh)
                rc_file="$HOME/.zshrc"
                ;;
        *)
                rc_file="$HOME/.bashrc"
                ;;
        esac
fi

# Check if the hook is installed by looking for markers
# Use grep -E with alternation to check all markers in a single call
if [ -n "$rc_file" ] && [ -f "$rc_file" ]; then
        if grep -Eq '# >>> wizardry cd cantrip >>>|#wizardry: cd-cantrip' "$rc_file" 2>/dev/null; then
                is_installed=1
        fi
fi

if [ "$is_installed" -eq 0 ]; then
        # Not installed, so install it
        printf '%s\n' "Installing cd hook..."
        if "$CD_SPELL" install; then
                printf '%s\n' "✓ cd hook enabled. Each directory change will now display the room \
                  description.""
                printf '%s\n' "  (Restart your shell or source your rc file to activate)"
        else
                printf '%s\n' "✗ Failed to install cd hook." >&2
                exit 1
        fi
else
        # Hook is installed, so uninstall it with live feedback
        printf '%s\n' "Uninstalling cd hook..."
        if "$CD_SPELL" uninstall; then
                printf '%s\n' "✓ cd hook disabled."
                printf '%s\n' "  (Restart your shell or source your rc file to deactivate)"
        else
                printf '%s\n' "✗ Failed to uninstall cd hook." >&2
                exit 1
        fi
fi
