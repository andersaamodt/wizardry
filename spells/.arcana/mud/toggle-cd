#!/bin/sh

# Toggle cd hook on/off using config imps

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: toggle-cd

Turn the cd hook that runs 'look' after each directory change on or off.

To apply changes immediately in your current shell, use:
  . toggle-cd    OR    toggle cd    (via parse/gloss, which sources it)

Or restart your terminal to apply changes automatically.
USAGE
  exit 0
  ;;
esac

set -eu

# Determine config file location
SPELLBOOK_DIR="${SPELLBOOK_DIR:-$HOME/.spellbook}"
CONFIG_FILE="$SPELLBOOK_DIR/.mud"

# Ensure spellbook directory exists
mkdir -p "$SPELLBOOK_DIR"
touch "$CONFIG_FILE"

# Check if we're being sourced (to enable immediate effect)
toggle_cd_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) toggle_cd_sourced=1 ;;
  esac
else
  toggle_cd_base=${0##*/}
  case "$toggle_cd_base" in
    sh|dash|bash|zsh|ksh|mksh) toggle_cd_sourced=1 ;;
    parse) toggle_cd_sourced=1 ;;  # Sourced via parse
    *) toggle_cd_sourced=0 ;;
  esac
fi

# Check current state
if config-has "$CONFIG_FILE" "cd-look" 2>/dev/null; then
        current_value=$(config-get "$CONFIG_FILE" "cd-look" 2>/dev/null)
        if [ "$current_value" = "1" ]; then
                # Currently enabled, disable it
                config-set "$CONFIG_FILE" "cd-look" "0"
                
                # If sourced, unload the cd function immediately
                if [ "$toggle_cd_sourced" -eq 1 ]; then
                    unset -f cd 2>/dev/null || true
                    printf '%s\n' "✓ cd hook disabled and unloaded from your current shell."
                else
                    printf '%s\n' "✓ cd hook disabled in config."
                    printf '%s\n' "  To unload from current shell: . toggle-cd"
                    printf '%s\n' "  Or restart your terminal."
                fi
                return 0 2>/dev/null || exit 0
        fi
fi

# Currently disabled or set to 0, enable it
config-set "$CONFIG_FILE" "cd-look" "1"

# If sourced, load the cd function immediately
if [ "$toggle_cd_sourced" -eq 1 ]; then
    load_cd_hook_path="${WIZARDRY_DIR:-$HOME/.wizardry}/spells/.arcana/mud/load-cd-hook"
    if [ -f "$load_cd_hook_path" ]; then
        # Source the load-cd-hook file to define cd function
        . "$load_cd_hook_path" 2>/dev/null || {
            printf '%s\n' "✓ cd hook enabled in config."
            printf '%s\n' "  Warning: Failed to load cd function. Restart your terminal."
            return 1 2>/dev/null || exit 1
        }
        printf '%s\n' "✓ cd hook enabled and loaded in your current shell."
    else
        printf '%s\n' "✓ cd hook enabled in config."
        printf '%s\n' "  cd function will load on next shell startup."
    fi
else
    printf '%s\n' "✓ cd hook enabled in config."
    printf '%s\n' "  To load immediately in current shell: . toggle-cd"
    printf '%s\n' "  Or restart your terminal."
fi

unset toggle_cd_sourced toggle_cd_base
