#!/bin/sh

# Present the Node.js management menu.

show_usage() {
  cat <<'USAGE'
Usage: node-menu

Displays the Node.js management menu.
USAGE
}

case "${1-}" in
  --help|--usage|-h)
    show_usage
    exit 0
    ;;
esac

set -eu
. colors

trap 'exit 0' INT TERM

# Main menu loop
first_run=1
while :; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi
  
  # Build menu display
  title="${BOLD}${CYAN}Node.js: $(node-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  install_option="Install Node.js%install-node"
  uninstall_option="Uninstall Node.js%uninstall-node"

  # Check if node is installed
  if command -v node >/dev/null 2>&1; then
    # Build version options
    version_opts=""
    if command -v node >/dev/null 2>&1; then
      version_opts="Show Node version%node --version
Show Node binary path%command -v node
Runtime platform%node -e \"console.log(\`\${process.platform}-\${process.arch}\`)\"\n\
Quick health check%node -e \"console.log(\`Node OK: \${process.version}\`)\"
"
    fi
    if command -v npm >/dev/null 2>&1; then
      version_opts="${version_opts}Show npm version%npm --version
List global npm packages%npm list -g --depth=0
"
    fi
    
    # Build service options - find service name
    service_opts=""
    service_name=""
    for candidate in ${NODE_SERVICE-} node nodejs node-app; do
      [ -n "$candidate" ] || continue
      
      # Check if service is installed via is-service-installed
      is_installed="no"
      if command -v is-service-installed >/dev/null 2>&1 && is-service-installed "$candidate" >/dev/null 2>&1; then
        is_installed="yes"
      fi
      
      if [ "$is_installed" = "yes" ]; then
        service_name="$candidate"
        break
      fi
      
      # Check via systemctl if available
      if command -v systemctl >/dev/null 2>&1; then
        unit_files=$(systemctl list-unit-files --type=service --no-pager 2>/dev/null)
        if echo "$unit_files" | grep -q "^${candidate}\\.service"; then
          service_name="$candidate"
          break
        fi
      fi
    done
    
    if [ -n "$service_name" ]; then
      status="Service Status%sudo systemctl status $service_name"
      
      # Check if service is running
      is_running="no"
      if command -v is-service-running >/dev/null 2>&1 && is-service-running "$service_name" >/dev/null 2>&1; then
        is_running="yes"
      fi
      
      if [ "$is_running" = "yes" ]; then
        toggle="Restart Node service%sudo systemctl restart $service_name"
        stop="Stop Node service%sudo systemctl stop $service_name"
      elif command -v systemctl >/dev/null 2>&1 && systemctl is-active "$service_name" >/dev/null 2>&1; then
        toggle="Restart Node service%sudo systemctl restart $service_name"
        stop="Stop Node service%sudo systemctl stop $service_name"
      else
        toggle="Start Node service%sudo systemctl start $service_name"
        stop=""
      fi
      service_opts="$status
$toggle
"
      [ -n "$stop" ] && service_opts="${service_opts}$stop
"
    fi
    
    # Build menu arguments
    set --
    old_ifs=$IFS
    IFS=$(printf '\n')
    for line in $version_opts; do
      [ -n "$line" ] && set -- "$@" "$line"
    done
    for line in $service_opts; do
      [ -n "$line" ] && set -- "$@" "$line"
    done
    IFS=$old_ifs
    set -- "$@" "$uninstall_option" "$exit_option"
    menu "$title" "$@" || true
  else
    menu "$title" "$install_option" "$exit_option" || true
  fi
  
  # Loop to refresh status
  :
done
