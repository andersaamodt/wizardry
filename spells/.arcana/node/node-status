#!/bin/sh

# Report installation and runtime status for Node.js.

show_usage() {
        cat <<'USAGE' >&2
Usage: node-status

Reports whether Node.js is installed, whether npm is available, and whether a Node-related service is running.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu
. colors

# Older scripts expect GRAY, so mirror GREY when missing.
GRAY=${GRAY:-${GREY-}}

# Detect Node service name
node_service_name() {
  for candidate in ${NODE_SERVICE-} node nodejs node-app; do
    [ -n "$candidate" ] || continue
    
    is_svc_cmd=$(command -v is-service-installed 2>/dev/null || true)
    if [ -n "$is_svc_cmd" ] && is-service-installed "$candidate" >/dev/null 2>&1; then
      printf '%s' "$candidate"
      return 0
    fi
    
    if command -v systemctl >/dev/null 2>&1; then
      unit_files=$(systemctl list-unit-files --type=service --no-pager 2>/dev/null)
      if echo "$unit_files" | grep -q "^${candidate}\\.service"; then
        printf '%s' "$candidate"
        return 0
      fi
    fi
  done
  return 1
}

# Check Node installation and service status
if ! command -v node >/dev/null 2>&1; then
  status="not installed"
  printf "%s%s%s\n" "$GRAY" "$status" "$RESET"
  exit 0
fi

if ! node --version >/dev/null 2>&1; then
  status="installed, error"
  printf "%s%s%s\n" "$RED" "$status" "$RESET"
  exit 0
fi

if ! command -v npm >/dev/null 2>&1; then
  status="installed, npm missing"
else
  status="installed"
fi

if service_name=$(node_service_name); then
  is_running="no"
  if command -v is-service-running >/dev/null 2>&1 && is-service-running "$service_name" >/dev/null 2>&1; then
    is_running="yes"
  elif command -v systemctl >/dev/null 2>&1 && systemctl is-active "$service_name" >/dev/null 2>&1; then
    is_running="yes"
  fi
  
  if [ "$is_running" = "yes" ]; then
    status="installed, service running"
  else
    status="installed, service stopped"
  fi
fi

# Color output based on status
case "$status" in
  "installed, service running"|"installed")
    color=$GREEN
    ;;
  "installed, service stopped"|"installed, npm missing")
    color=$YELLOW
    ;;
  "not installed")
    color=$GRAY
    ;;
  *)
    color=$RED
    ;;
esac

printf "%s%s%s\n" "$color" "$status" "$RESET"
