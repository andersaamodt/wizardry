#!/bin/sh

# Report installation and runtime status for Node.js.

show_usage() {
        cat <<'USAGE' >&2
Usage: node-status

Reports whether Node.js is installed, whether npm is available, and whether a Node-related service is running.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  RESET=""
  THEME_SUCCESS=""
  THEME_WARNING=""
  THEME_ERROR=""
  GREY=""
fi
# Older scripts expect GRAY, so mirror GREY when missing.
GRAY=${GREY-}

color_for_status() {
  case "$1" in
    "installed, service running"|"installed")
      printf "%s" "$THEME_SUCCESS"
      ;;
    "installed, service stopped"|"installed, npm missing")
      printf "%s" "$THEME_WARNING"
      ;;
    "not installed")
      printf "%s" "$GRAY"
      ;;
    *)
      printf "%s" "$THEME_ERROR"
      ;;
  esac
}

command_available() {
  command -v "$1" >/dev/null 2>&1
}

node_service_name() {
  for candidate in ${NODE_SERVICE-} node nodejs node-app; do
    [ -n "$candidate" ] || continue
    
    has_service_cmd=$(command_available is-service-installed && echo "yes" || echo "no")
    is_installed="no"
    if [ "$has_service_cmd" = "yes" ] && is-service-installed "$candidate" >/dev/null 2>&1; then
      is_installed="yes"
    fi
    
    if [ "$is_installed" = "yes" ]; then
      printf '%s' "$candidate"
      return 0
    fi
    
    has_systemctl=$(command_available systemctl && echo "yes" || echo "no")
    if [ "$has_systemctl" = "yes" ]; then
      unit_files=$(systemctl list-unit-files --type=service --no-pager 2>/dev/null)
      if echo "$unit_files" | grep -q "^${candidate}\\.service"; then
        printf '%s' "$candidate"
        return 0
      fi
    fi
  done
  return 1
}

get_node_status() {
  if ! command_available node; then
    status="not installed"
    printf "%s%s%s\n" "$(color_for_status "$status")" "$status" "$RESET"
    return
  fi

  if ! node --version >/dev/null 2>&1; then
    status="installed, error"
    printf "%s%s%s\n" "$(color_for_status "$status")" "$status" "$RESET"
    return
  fi

  if ! command_available npm; then
    status="installed, npm missing"
  else
    status="installed"
  fi

  if service_name=$(node_service_name); then
    has_running_cmd=$(command_available is-service-running && echo "yes" || echo "no")
    is_running="no"
    if [ "$has_running_cmd" = "yes" ] && is-service-running "$service_name" >/dev/null 2>&1; then
      is_running="yes"
    fi
    
    if [ "$is_running" = "yes" ]; then
      status="installed, service running"
    elif command_available systemctl && systemctl is-active "$service_name" >/dev/null 2>&1; then
      status="installed, service running"
    else
      status="installed, service stopped"
    fi
  fi

  printf "%s%s%s\n" "$(color_for_status "$status")" "$status" "$RESET"
}

get_node_status
