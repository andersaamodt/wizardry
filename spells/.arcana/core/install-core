#!/bin/sh

# Bootstrap spell: installs the core wizardry dependencies required for spell execution.

show_usage() {
  cat <<'USAGE'
Usage: install-core

Install the core wizardry dependencies required for running spells.
USAGE
}

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)

if [ "${0##*/}" = "install-core" ]; then
  case "${1-}" in
    --help|--usage|-h)
      show_usage
      exit 0
      ;;
  esac

  set -eu
  
  # Install core dependencies (inlined from install_core, core_dependencies, detect_platform, get_clipboard_label)
  # Detect platform
  platform="unknown"
  if command -v uname >/dev/null 2>&1; then
    platform=$(uname -s 2>/dev/null || printf '%s' "unknown")
  fi
  
  # Get clipboard label for the menu
  clipboard_label='Clipboard (xsel)'
  if command -v pbcopy >/dev/null 2>&1; then
    clipboard_label='Clipboard (pbcopy)'
  elif command -v xsel >/dev/null 2>&1; then
    clipboard_label='Clipboard (xsel)'
  elif command -v xclip >/dev/null 2>&1; then
    clipboard_label='Clipboard (xclip)'
  elif command -v wl-copy >/dev/null 2>&1; then
    clipboard_label='Clipboard (wl-copy)'
  elif [ "$platform" = "Darwin" ]; then
    clipboard_label='Clipboard (pbcopy)'
  elif [ "${XDG_SESSION_TYPE:-}" = "wayland" ] || [ -n "${WAYLAND_DISPLAY:-}" ]; then
    clipboard_label='Clipboard (wl-copy)'
  fi
  
  # Special marker for clipboard helper
  CLIPBOARD_MARKER="__clipboard_helper__"
  
  # Generate core dependencies list based on platform
  case $platform in
    Darwin)
      dependencies='Git:git:install-git:uninstall-git:0
dd:dd:install-dd:uninstall-dd:1
stty:stty:install-stty:uninstall-stty:1
tput:tput:install-tput:uninstall-tput:1'
      ;;
    *)
      dependencies="Git:git:install-git:uninstall-git:0
${clipboard_label}:${CLIPBOARD_MARKER}:install-clipboard-helper:uninstall-clipboard-helper:0
Bubblewrap:bwrap:install-bwrap:uninstall-bwrap:0
dd:dd:install-dd:uninstall-dd:1
stty:stty:install-stty:uninstall-stty:1
tput:tput:install-tput:uninstall-tput:1"
      ;;
  esac
  
  # Try to install each core dependency
  # We silently skip failures to avoid confusing novice users during first-time install
  printf '%s\n' "$dependencies" | while IFS=: read -r label command_name install_spell _ _; do
    if command -v "$command_name" >/dev/null 2>&1; then
      continue
    fi

    # Resolve spell path (inlined from resolve_spell)
    spell=""
    if command -v "$install_spell" >/dev/null 2>&1; then
      spell=$install_spell
    elif [ -x "$script_dir/$install_spell" ]; then
      spell="$script_dir/$install_spell"
    else
      continue
    fi
    
    # Run installation silently - failures are expected on some platforms
    ASSUME_YES=1 "$spell" >/dev/null 2>&1 || true
  done
  
  # Always return success - optional package installation failures are non-fatal
  exit 0
fi
