#!/bin/sh

# Import an arcanum from a path into the wizardry arcana collection.

show_usage() {
  cat <<'USAGE'
Usage: import-arcanum [PATH]

Import an arcanum from the specified path into the wizardry arcana collection.
If no path is provided, the spell will prompt for one interactively.

An arcanum must:
- Be a directory
- Not already exist in the arcana directory
- Optionally contain a .arcanum metadata file (name must match folder name)
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac

set -eu

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
arcana_dir=${INSTALL_MENU_ROOT:-$script_dir}

# Get path from argument or prompt
if [ "$#" -ge 1 ]; then
  source_path=$1
else
  if ! command -v ask-text >/dev/null 2>&1; then
    printf '%s\n' "import-arcanum: ask-text command not found." >&2
    exit 1
  fi
  source_path=$(ask-text "Path to arcanum:") || {
    printf '%s\n' "import-arcanum: no path provided." >&2
    exit 1
  }
fi

# Validate that source path is not empty
if [ -z "$source_path" ]; then
  printf '%s\n' "import-arcanum: path cannot be empty." >&2
  exit 1
fi

# Expand ~ to HOME if present at start of path
case "$source_path" in
  '~')
    source_path=$HOME
    ;;
  '~/'*)
    source_path=$HOME/${source_path#'~/'}
    ;;
esac

# Make path absolute if it's relative
case "$source_path" in
  /*)
    # Already absolute
    ;;
  *)
    # Make relative path absolute
    source_path=$(cd "$(dirname "$source_path")" 2>/dev/null && pwd -P)/$(basename "$source_path") || {
      printf '%s\n' "import-arcanum: cannot access path: $source_path" >&2
      exit 1
    }
    ;;
esac

# Validate that source path exists and is a directory
if [ ! -d "$source_path" ]; then
  printf '%s\n' "import-arcanum: not a directory: $source_path" >&2
  exit 1
fi

# Extract arcanum name from path
arcanum_name=$(basename "$source_path")

# Validate arcanum name (alphanumeric, hyphens, underscores)
case "$arcanum_name" in
  ''|*[!A-Za-z0-9._-]*)
    printf '%s\n' "import-arcanum: invalid arcanum name: $arcanum_name" >&2
    printf '%s\n' "import-arcanum: names may contain only letters, digits, dots, underscores, and hyphens." >&2
    exit 1
    ;;
  -*)
    printf '%s\n' "import-arcanum: invalid arcanum name: $arcanum_name" >&2
    printf '%s\n' "import-arcanum: names may not begin with a dash." >&2
    exit 1
    ;;
  .*)
    printf '%s\n' "import-arcanum: invalid arcanum name: $arcanum_name" >&2
    printf '%s\n' "import-arcanum: names may not begin with a dot." >&2
    exit 1
    ;;
esac

# Validate source path is not the same as or inside the arcana directory
case "$source_path" in
  "$arcana_dir"*)
    printf '%s\n' "import-arcanum: cannot import from arcana directory itself." >&2
    exit 1
    ;;
esac

# Check if arcanum already exists in arcana directory
target_path="$arcana_dir/$arcanum_name"
if [ -e "$target_path" ]; then
  printf '%s\n' "import-arcanum: arcanum already exists: $arcanum_name" >&2
  exit 1
fi

# If .arcanum metadata file exists, validate it
arcanum_metadata="$source_path/$arcanum_name.arcanum"
if [ -f "$arcanum_metadata" ]; then
  # File exists - we could validate its contents here if needed
  # For now, we just check that it exists and has the correct name
  :
fi

# Copy the arcanum to the arcana directory
if ! cp -R "$source_path" "$target_path" 2>/dev/null; then
  printf '%s\n' "import-arcanum: failed to copy arcanum to: $target_path" >&2
  exit 1
fi

printf '%s\n' "Imported arcanum: $arcanum_name"
exit 0
