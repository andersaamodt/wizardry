#!/bin/sh

# Uninstall GNU coreutils (macOS only).

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: uninstall-coreutils

Uninstalls GNU coreutils on macOS (if installed to ~/.local).

On Linux: This is a no-op as system coreutils cannot be uninstalled.
On macOS: Removes source-built coreutils from ~/.local

Warning: Uninstalling coreutils will remove stdbuf, which is needed for
SSE unbuffering. Only uninstall if you don't need real-time SSE features.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

# Detect platform
os_type=$(uname -s)

case "$os_type" in
  Darwin)
    # macOS - can uninstall user-installed coreutils
    PREFIX="${HOME}/.local"
    
    if [ -f "$PREFIX/bin/stdbuf" ]; then
      warn "Uninstalling GNU coreutils will remove stdbuf"
      warn "SSE real-time features will use slower buffering workarounds"
      
      # Remove coreutils binaries
      say "Removing GNU coreutils from $PREFIX..."
      
      # List of coreutils programs to remove
      for prog in "[" b2sum base32 base64 basename basenc cat chcon chgrp chmod \
        chown chroot cksum comm cp csplit cut date dd df dir dircolors dirname \
        du echo env expand expr factor false fmt fold groups head hostid hostname \
        id install join kill link ln logname ls md5sum mkdir mkfifo mknod mktemp \
        mv nice nl nohup nproc numfmt od paste pathchk pinky pr printenv printf \
        ptx pwd readlink realpath rm rmdir runcon seq sha1sum sha224sum sha256sum \
        sha384sum sha512sum shred shuf sleep sort split stat stdbuf stty sum sync \
        tac tail tee test timeout touch tr true truncate tsort tty uname unexpand \
        uniq unlink uptime users vdir wc who whoami yes; do
        rm -f "$PREFIX/bin/$prog" 2>/dev/null || true
      done
      
      # Remove lib files
      rm -rf "$PREFIX/libexec/coreutils" 2>/dev/null || true
      rm -f "$PREFIX/lib/coreutils"/* 2>/dev/null || true
      
      # Remove man pages
      rm -f "$PREFIX/share/man/man1/stdbuf.1" 2>/dev/null || true
      
      success "GNU coreutils uninstalled"
    else
      info "GNU coreutils not installed in ~/.local"
    fi
    ;;
    
  Linux)
    warn "Cannot uninstall system coreutils on Linux - they are essential"
    info "System coreutils are required for basic OS functionality"
    ;;
    
  *)
    warn "Cannot uninstall coreutils on this platform"
    ;;
esac

