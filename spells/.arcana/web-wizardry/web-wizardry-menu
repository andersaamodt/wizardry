#!/bin/sh

# Present the web wizardry management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: web-wizardry-menu

Displays the web wizardry management menu with install/uninstall toggles for each component.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

if ! require menu "The web-wizardry-menu needs the 'menu' command to present options."; then
  exit 1
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Use temp file for selection tracking
SELECTION_FILE=$(temp-file web-wizardry-menu-selection)
export SELECTION_FILE
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true' EXIT
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 130' INT
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 0' TERM

loop_limit=${MENU_LOOP_LIMIT:-}

while true; do
  # Clear menu_status from previous iteration
  unset menu_status
  
  # Read last selected position from temp file, default to 1
  if [ -f "$SELECTION_FILE" ]; then
    start_selection=$(cat "$SELECTION_FILE" 2>/dev/null || printf '1')
    if [ -z "$start_selection" ]; then
      start_selection=1
    fi
  else
    start_selection=1
  fi
  
  # Build menu entries based on installation state
  
  # Pandoc toggle
  if "$script_dir/is-web-component-installed" pandoc 2>/dev/null; then
    pandoc_toggle="[X] Pandoc%$script_dir/uninstall-pandoc; echo 1 > \"$SELECTION_FILE\""
  else
    pandoc_toggle="[ ] Pandoc%$script_dir/install-pandoc; echo 1 > \"$SELECTION_FILE\""
  fi
  
  # Nginx toggle (with admin submenu when installed)
  if "$script_dir/is-web-component-installed" nginx 2>/dev/null; then
    nginx_toggle="[X] Nginx (web server)%$script_dir/uninstall-nginx; echo 2 > \"$SELECTION_FILE\""
    nginx_admin="    â†’ Nginx admin%$script_dir/nginx-admin; echo 3 > \"$SELECTION_FILE\""
  else
    nginx_toggle="[ ] Nginx (web server)%$script_dir/install-nginx; echo 2 > \"$SELECTION_FILE\""
    nginx_admin=""
  fi
  
  # Fcgiwrap toggle
  if "$script_dir/is-web-component-installed" fcgiwrap 2>/dev/null; then
    fcgiwrap_toggle="[X] Fcgiwrap (FastCGI)%$script_dir/uninstall-fcgiwrap; echo 4 > \"$SELECTION_FILE\""
  else
    fcgiwrap_toggle="[ ] Fcgiwrap (FastCGI)%$script_dir/install-fcgiwrap; echo 4 > \"$SELECTION_FILE\""
  fi
  
  # OpenSSL toggle
  if "$script_dir/is-web-component-installed" openssl 2>/dev/null; then
    openssl_toggle="[X] OpenSSL%$script_dir/uninstall-openssl; echo 5 > \"$SELECTION_FILE\""
  else
    openssl_toggle="[ ] OpenSSL%$script_dir/install-openssl; echo 5 > \"$SELECTION_FILE\""
  fi
  
  # Htmx toggle
  if "$script_dir/is-web-component-installed" htmx 2>/dev/null; then
    htmx_toggle="[X] Htmx (JS library)%$script_dir/uninstall-htmx; echo 6 > \"$SELECTION_FILE\""
  else
    htmx_toggle="[ ] Htmx (JS library)%$script_dir/install-htmx; echo 6 > \"$SELECTION_FILE\""
  fi
  
  # Coreutils (assert-only)
  if "$script_dir/is-web-component-installed" coreutils 2>/dev/null; then
    coreutils_toggle="[X] Coreutils (assert-only)%$script_dir/install-coreutils; echo 7 > \"$SELECTION_FILE\""
  else
    coreutils_toggle="[ ] Coreutils (assert-only)%$script_dir/install-coreutils; echo 7 > \"$SELECTION_FILE\""
  fi
  
  # Check if all are installed for enable/disable all toggle
  all_installed=1
  for component in pandoc nginx fcgiwrap openssl htmx coreutils; do
    if ! "$script_dir/is-web-component-installed" "$component" 2>/dev/null; then
      all_installed=0
      break
    fi
  done
  
  if [ "$all_installed" -eq 1 ]; then
    toggle_all="Disable all components%$script_dir/toggle-all-web-wizardry --disable; echo 8 > \"$SELECTION_FILE\""
  else
    toggle_all="Enable all components%$script_dir/toggle-all-web-wizardry --enable; echo 8 > \"$SELECTION_FILE\""
  fi
  
  # Exit button
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"
  
  # Build menu arguments
  if [ -n "$nginx_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$coreutils_toggle" "$toggle_all" "$exit_item"
  else
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$coreutils_toggle" "$toggle_all" "$exit_item"
  fi
  
  menu --start-selection "$start_selection" "Web Wizardry:" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
  
  # Support MENU_LOOP_LIMIT for testing
  if [ -n "$loop_limit" ]; then
    loop_limit=$((loop_limit - 1))
    if [ "$loop_limit" -le 0 ]; then
      break
    fi
  fi
done
