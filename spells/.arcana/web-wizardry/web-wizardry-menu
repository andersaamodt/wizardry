#!/bin/sh

# Present the web wizardry management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: web-wizardry-menu

Displays the web wizardry management menu with install/uninstall toggles for each component.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

if ! require menu "The web-wizardry-menu needs the 'menu' command to present options."; then
  exit 1
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

loop_limit=${MENU_LOOP_LIMIT:-}

while true; do
  # Clear menu_status from previous iteration
  unset menu_status
  
  # Capture state before menu to detect changes
  pandoc_was_installed=0
  nginx_was_installed=0
  fcgiwrap_was_installed=0
  openssl_was_installed=0
  htmx_was_installed=0
  certbot_was_installed=0
  
  "$script_dir/is-web-component-installed" pandoc 2>/dev/null && pandoc_was_installed=1
  "$script_dir/is-web-component-installed" nginx 2>/dev/null && nginx_was_installed=1
  "$script_dir/is-web-component-installed" fcgiwrap 2>/dev/null && fcgiwrap_was_installed=1
  "$script_dir/is-web-component-installed" openssl 2>/dev/null && openssl_was_installed=1
  "$script_dir/is-web-component-installed" htmx 2>/dev/null && htmx_was_installed=1
  "$script_dir/is-web-component-installed" certbot 2>/dev/null && certbot_was_installed=1
  
  # Track starting position
  start_selection=${start_selection:-1}
  
  # Build menu entries based on installation state
  
  # Position counter for tracking selection
  pos=1
  
  # Pandoc toggle
  if [ "$pandoc_was_installed" -eq 1 ]; then
    pandoc_toggle="[X] pandoc%uninstall-pandoc"
    pandoc_pos=$pos
  else
    pandoc_toggle="[ ] pandoc%install-pandoc"
    pandoc_pos=$pos
  fi
  pos=$((pos + 1))
  
  # Nginx toggle (with admin submenu when installed)
  if [ "$nginx_was_installed" -eq 1 ]; then
    nginx_toggle="[X] nginx%uninstall-nginx"
    nginx_pos=$pos
    pos=$((pos + 1))
    nginx_admin="    nginx admin%nginx-admin"
    nginx_admin_pos=$pos
    pos=$((pos + 1))
  else
    nginx_toggle="[ ] nginx%install-nginx"
    nginx_pos=$pos
    pos=$((pos + 1))
    nginx_admin=""
  fi
  
  # Fcgiwrap toggle
  if [ "$fcgiwrap_was_installed" -eq 1 ]; then
    fcgiwrap_toggle="[X] fcgiwrap%uninstall-fcgiwrap"
    fcgiwrap_pos=$pos
  else
    fcgiwrap_toggle="[ ] fcgiwrap%install-fcgiwrap"
    fcgiwrap_pos=$pos
  fi
  pos=$((pos + 1))
  
  # OpenSSL toggle
  if [ "$openssl_was_installed" -eq 1 ]; then
    openssl_toggle="[X] OpenSSL%uninstall-openssl"
    openssl_pos=$pos
  else
    openssl_toggle="[ ] OpenSSL%install-openssl"
    openssl_pos=$pos
  fi
  pos=$((pos + 1))
  
  # Htmx toggle
  if [ "$htmx_was_installed" -eq 1 ]; then
    htmx_toggle="[X] htmx%uninstall-htmx"
    htmx_pos=$pos
  else
    htmx_toggle="[ ] htmx%install-htmx"
    htmx_pos=$pos
  fi
  pos=$((pos + 1))
  
  # Certbot/acme.sh toggle (with manage-https submenu when installed)
  if [ "$certbot_was_installed" -eq 1 ]; then
    certbot_toggle="[X] acme.sh%uninstall-acme"
    certbot_pos=$pos
    pos=$((pos + 1))
    https_admin="    manage https%manage-https"
    https_admin_pos=$pos
    pos=$((pos + 1))
  else
    certbot_toggle="[ ] acme.sh%install-acme"
    certbot_pos=$pos
    pos=$((pos + 1))
    https_admin=""
  fi
  
  # Coreutils (can be checked but not unchecked - informational)
  coreutils_msg='coreutils should not be uninstalled - it contains essential system utilities.'
  if "$script_dir/is-web-component-installed" coreutils 2>/dev/null; then
    coreutils_info=" X  coreutils%printf '%s\\n' '$coreutils_msg' >&2"
  else
    coreutils_info="[ ] coreutils%printf '%s\\n' '$coreutils_msg' >&2"
  fi
  
  # Check if all are installed for enable/disable all toggle
  all_installed=1
  for component in pandoc nginx fcgiwrap openssl htmx certbot; do
    if ! "$script_dir/is-web-component-installed" "$component" 2>/dev/null; then
      all_installed=0
      break
    fi
  done
  
  if [ "$all_installed" -eq 1 ]; then
    toggle_all="Disable all%toggle-all-web-wizardry --disable"
  else
    toggle_all="Enable all%toggle-all-web-wizardry --enable"
  fi
  
  # Exit button
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"
  
  # Build menu arguments - handle dynamic submenus
  if [ -n "$nginx_admin" ] && [ -n "$https_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" \
      "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$https_admin" \
      "$coreutils_info" "$toggle_all" "$exit_item"
  elif [ -n "$nginx_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" \
      "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$coreutils_info" \
      "$toggle_all" "$exit_item"
  elif [ -n "$https_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" \
      "$htmx_toggle" "$certbot_toggle" "$https_admin" "$coreutils_info" \
      "$toggle_all" "$exit_item"
  else
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" \
      "$htmx_toggle" "$certbot_toggle" "$coreutils_info" "$toggle_all" "$exit_item"
  fi
  
  menu --start-selection "$start_selection" "Install Web Wizardry:" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
  
  # Detect which component changed to stay on that position
  if "$script_dir/is-web-component-installed" pandoc 2>/dev/null; then
    pandoc_now_installed=1
  else
    pandoc_now_installed=0
  fi
  if "$script_dir/is-web-component-installed" nginx 2>/dev/null; then
    nginx_now_installed=1
  else
    nginx_now_installed=0
  fi
  if "$script_dir/is-web-component-installed" fcgiwrap 2>/dev/null; then
    fcgiwrap_now_installed=1
  else
    fcgiwrap_now_installed=0
  fi
  if "$script_dir/is-web-component-installed" openssl 2>/dev/null; then
    openssl_now_installed=1
  else
    openssl_now_installed=0
  fi
  if "$script_dir/is-web-component-installed" htmx 2>/dev/null; then
    htmx_now_installed=1
  else
    htmx_now_installed=0
  fi
  if "$script_dir/is-web-component-installed" certbot 2>/dev/null; then
    certbot_now_installed=1
  else
    certbot_now_installed=0
  fi
  
  # Update start_selection to the component that changed
  if [ "$pandoc_was_installed" -ne "$pandoc_now_installed" ]; then
    start_selection=$pandoc_pos
  elif [ "$nginx_was_installed" -ne "$nginx_now_installed" ]; then
    start_selection=$nginx_pos
  elif [ "$fcgiwrap_was_installed" -ne "$fcgiwrap_now_installed" ]; then
    start_selection=$fcgiwrap_pos
  elif [ "$openssl_was_installed" -ne "$openssl_now_installed" ]; then
    start_selection=$openssl_pos
  elif [ "$htmx_was_installed" -ne "$htmx_now_installed" ]; then
    start_selection=$htmx_pos
  elif [ "$certbot_was_installed" -ne "$certbot_now_installed" ]; then
    start_selection=$certbot_pos
  fi
  # If no change detected, start_selection stays the same
  
  # Support MENU_LOOP_LIMIT for testing
  if [ -n "$loop_limit" ]; then
    loop_limit=$((loop_limit - 1))
    if [ "$loop_limit" -le 0 ]; then
      break
    fi
  fi
done
