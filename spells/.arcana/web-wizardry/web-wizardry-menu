#!/bin/sh

# Present the web wizardry management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: web-wizardry-menu

Displays the web wizardry management menu with install/uninstall toggles for each component.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

if ! require menu "The web-wizardry-menu needs the 'menu' command to present options."; then
  exit 1
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

loop_limit=${MENU_LOOP_LIMIT:-}

# Start with first item by default
start_selection=1

while true; do
  # Clear menu_status from previous iteration
  unset menu_status
  
  # Build menu entries based on installation state
  
  # Pandoc toggle
  if "$script_dir/is-web-component-installed" pandoc 2>/dev/null; then
    pandoc_toggle="[X] pandoc%uninstall-pandoc"
  else
    pandoc_toggle="[ ] pandoc%install-pandoc"
  fi
  
  # Nginx toggle (with admin submenu when installed)
  if "$script_dir/is-web-component-installed" nginx 2>/dev/null; then
    nginx_toggle="[X] nginx%uninstall-nginx"
    nginx_admin="    nginx admin%nginx-admin"
  else
    nginx_toggle="[ ] nginx%install-nginx"
    nginx_admin=""
  fi
  
  # Fcgiwrap toggle
  if "$script_dir/is-web-component-installed" fcgiwrap 2>/dev/null; then
    fcgiwrap_toggle="[X] fcgiwrap%uninstall-fcgiwrap"
  else
    fcgiwrap_toggle="[ ] fcgiwrap%install-fcgiwrap"
  fi
  
  # OpenSSL toggle
  if "$script_dir/is-web-component-installed" openssl 2>/dev/null; then
    openssl_toggle="[X] OpenSSL%uninstall-openssl"
  else
    openssl_toggle="[ ] OpenSSL%install-openssl"
  fi
  
  # Htmx toggle
  if "$script_dir/is-web-component-installed" htmx 2>/dev/null; then
    htmx_toggle="[X] htmx%uninstall-htmx"
  else
    htmx_toggle="[ ] htmx%install-htmx"
  fi
  
  # Certbot/acme.sh toggle (with manage-https submenu when installed)
  if "$script_dir/is-web-component-installed" certbot 2>/dev/null; then
    certbot_toggle="[X] acme.sh%uninstall-certbot"
    https_admin="    manage https%manage-https"
  else
    certbot_toggle="[ ] acme.sh%install-certbot"
    https_admin=""
  fi
  
  # Coreutils (can be checked but not unchecked - informational)
  if "$script_dir/is-web-component-installed" coreutils 2>/dev/null; then
    coreutils_info=" X  coreutils%printf '%s\\n' 'coreutils should not be uninstalled - it contains essential system utilities.' >&2"
  else
    coreutils_info="[ ] coreutils%printf '%s\\n' 'coreutils should not be uninstalled - it contains essential system utilities.' >&2"
  fi
  
  # Check if all are installed for enable/disable all toggle
  all_installed=1
  for component in pandoc nginx fcgiwrap openssl htmx certbot; do
    if ! "$script_dir/is-web-component-installed" "$component" 2>/dev/null; then
      all_installed=0
      break
    fi
  done
  
  if [ "$all_installed" -eq 1 ]; then
    toggle_all="Disable all%toggle-all-web-wizardry --disable"
  else
    toggle_all="Enable all%toggle-all-web-wizardry --enable"
  fi
  
  # Exit button
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"
  
  # Build menu arguments - handle dynamic submenus
  if [ -n "$nginx_admin" ] && [ -n "$https_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$https_admin" "$coreutils_info" "$toggle_all" "$exit_item"
  elif [ -n "$nginx_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$coreutils_info" "$toggle_all" "$exit_item"
  elif [ -n "$https_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$https_admin" "$coreutils_info" "$toggle_all" "$exit_item"
  else
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$coreutils_info" "$toggle_all" "$exit_item"
  fi
  
  menu --start-selection "$start_selection" "Install Web Wizardry:" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # Update start_selection based on menu exit code
  # Menu returns the selected item number when an action is performed
  if [ "$menu_status" -gt 0 ] && [ "$menu_status" -lt 100 ]; then
    start_selection=$menu_status
  fi
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
  
  # Support MENU_LOOP_LIMIT for testing
  if [ -n "$loop_limit" ]; then
    loop_limit=$((loop_limit - 1))
    if [ "$loop_limit" -le 0 ]; then
      break
    fi
  fi
done
