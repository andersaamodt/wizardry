#!/bin/sh

# Present the web wizardry management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: web-wizardry-menu

Displays the web wizardry management menu with install/uninstall toggles for each component.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

if ! require menu "The web-wizardry-menu needs the 'menu' command to present options."; then
  exit 1
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Use temp file for selection tracking
SELECTION_FILE=$(temp-file web-wizardry-menu-selection)
export SELECTION_FILE
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true' EXIT
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 130' INT
trap 'cleanup-file "$SELECTION_FILE" 2>/dev/null || true; exit 0' TERM

loop_limit=${MENU_LOOP_LIMIT:-}

while true; do
  # Clear menu_status from previous iteration
  unset menu_status
  
  # Read last selected position from temp file, default to 1
  if [ -f "$SELECTION_FILE" ]; then
    start_selection=$(cat "$SELECTION_FILE" 2>/dev/null || printf '1')
    if [ -z "$start_selection" ]; then
      start_selection=1
    fi
  else
    start_selection=1
  fi
  
  # Build menu entries based on installation state
  
  # Build position counter that accounts for dynamic nginx admin entry
  pos=1
  
  # Pandoc toggle
  if "$script_dir/is-web-component-installed" pandoc 2>/dev/null; then
    pandoc_toggle="[X] pandoc%uninstall-pandoc"
  else
    pandoc_toggle="[ ] pandoc%install-pandoc"
  fi
  pos=$((pos + 1))
  
  # Nginx toggle (with admin submenu when installed)
  if "$script_dir/is-web-component-installed" nginx 2>/dev/null; then
    nginx_toggle="[X] nginx%uninstall-nginx"
    pos=$((pos + 1))
    nginx_admin="    â†’ nginx admin%nginx-admin"
    pos=$((pos + 1))
  else
    nginx_toggle="[ ] nginx%install-nginx"
    pos=$((pos + 1))
    nginx_admin=""
  fi
  
  # Fcgiwrap toggle
  if "$script_dir/is-web-component-installed" fcgiwrap 2>/dev/null; then
    fcgiwrap_toggle="[X] fcgiwrap%uninstall-fcgiwrap"
  else
    fcgiwrap_toggle="[ ] fcgiwrap%install-fcgiwrap"
  fi
  pos=$((pos + 1))
  
  # OpenSSL toggle
  if "$script_dir/is-web-component-installed" openssl 2>/dev/null; then
    openssl_toggle="[X] OpenSSL%uninstall-openssl"
  else
    openssl_toggle="[ ] OpenSSL%install-openssl"
  fi
  pos=$((pos + 1))
  
  # Htmx toggle
  if "$script_dir/is-web-component-installed" htmx 2>/dev/null; then
    htmx_toggle="[X] htmx%uninstall-htmx"
  else
    htmx_toggle="[ ] htmx%install-htmx"
  fi
  pos=$((pos + 1))
  
  # Certbot toggle
  if "$script_dir/is-web-component-installed" certbot 2>/dev/null; then
    certbot_toggle="[X] certbot%uninstall-certbot"
  else
    certbot_toggle="[ ] certbot%install-certbot"
  fi
  pos=$((pos + 1))
  
  # Coreutils (can be checked but not unchecked - informational)
  if "$script_dir/is-web-component-installed" coreutils 2>/dev/null; then
    coreutils_info=" X  coreutils%printf '%s\\n' 'coreutils should not be uninstalled - it contains essential system utilities.' >&2"
  else
    coreutils_info="[ ] coreutils%printf '%s\\n' 'coreutils should not be uninstalled - it contains essential system utilities.' >&2"
  fi
  pos=$((pos + 1))
  
  # Check if all are installed for enable/disable all toggle
  all_installed=1
  for component in pandoc nginx fcgiwrap openssl htmx certbot; do
    if ! "$script_dir/is-web-component-installed" "$component" 2>/dev/null; then
      all_installed=0
      break
    fi
  done
  
  if [ "$all_installed" -eq 1 ]; then
    toggle_all="Disable all%toggle-all-web-wizardry --disable"
  else
    toggle_all="Enable all%toggle-all-web-wizardry --enable"
  fi
  
  # Exit button
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"
  
  # Build menu arguments
  if [ -n "$nginx_admin" ]; then
    set -- "$pandoc_toggle" "$nginx_toggle" "$nginx_admin" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$coreutils_info" "$toggle_all" "$exit_item"
  else
    set -- "$pandoc_toggle" "$nginx_toggle" "$fcgiwrap_toggle" "$openssl_toggle" "$htmx_toggle" "$certbot_toggle" "$coreutils_info" "$toggle_all" "$exit_item"
  fi
  
  menu --start-selection "$start_selection" "Install Web Wizardry:" "$@" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
  
  # Support MENU_LOOP_LIMIT for testing
  if [ -n "$loop_limit" ]; then
    loop_limit=$((loop_limit - 1))
    if [ "$loop_limit" -le 0 ]; then
      break
    fi
  fi
done
