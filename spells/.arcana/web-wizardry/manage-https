#!/bin/sh

# Present the HTTPS/acme.sh management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: manage-https

Displays the HTTPS management menu for acme.sh/Let's Encrypt.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

if ! require menu "The manage-https menu needs the 'menu' command to present options."; then
  exit 1
fi

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 130' INT
trap 'exit 0' TERM

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Check if acme.sh is installed
  if [ ! -f "$HOME/.acme.sh/acme.sh" ]; then
    printf '%s\n' "manage-https: acme.sh is not installed" >&2
    exit 1
  fi

  # Build menu
  title="${BOLD}${CYAN}HTTPS / Let's Encrypt Management"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  # acme.sh management commands (using literal $HOME for clarity)
  
  # Check if account is registered by looking for account.conf
  if [ -f "$HOME/.acme.sh/account.conf" ] && grep -q "ACCOUNT_EMAIL" "$HOME/.acme.sh/account.conf" 2>/dev/null; then
    # Account exists - show account info
    account_option="Show account%\$HOME/.acme.sh/acme.sh --info 2>&1"
  else
    # No account - show registration
    account_option="Register account%\$HOME/.acme.sh/acme.sh --register-account 2>&1"
  fi
  
  # Issue certificate wizard - interactive guided setup
  issue_option="Issue certificate%printf 'Enter domain (e.g., example.com): ' && read domain && printf 'Enter webroot path (e.g., /var/www/html): ' && read webroot && \$HOME/.acme.sh/acme.sh --issue -d \"\$domain\" -w \"\$webroot\" 2>&1"
  
  # List certificates with helpful message if none exist
  list_certs_option="List certificates%output=\$(\$HOME/.acme.sh/acme.sh --list 2>&1); if printf '%s' \"\$output\" | grep -q 'Main_Domain'; then lines=\$(printf '%s' \"\$output\" | wc -l); if [ \"\$lines\" -le 1 ]; then printf 'No certificates installed yet.\n'; else printf '%s\n' \"\$output\"; fi; else printf '%s\n' \"\$output\"; fi"
  
  # Renew all with informative output
  renew_option="Renew all%\$HOME/.acme.sh/acme.sh --renew-all 2>&1 || printf 'No certificates to renew or renewal not needed.\n'"
  
  version_option="Show version%\$HOME/.acme.sh/acme.sh --version 2>&1"
  
  menu "$title" "$account_option" "$issue_option" "$list_certs_option" "$renew_option" "$version_option" "$exit_option" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
