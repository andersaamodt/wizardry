#!/bin/sh

# Install Tabby in a cross-platform POSIX-compliant way.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: install-tabby

Installs Tabby without using homebrew, in a POSIX-compliant cross-platform manner.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Check if already installed
if "$script_dir/is-ai-component-installed" tabby 2>/dev/null; then
  success "Tabby is already installed"
  exit 0
fi

say "Installing Tabby..."

OS=$(uname -s 2>/dev/null)
ARCH=$(uname -m 2>/dev/null)

install_dir="$HOME/.local/bin"
mkdir -p "$install_dir"

# Determine the download URL based on OS and architecture
case "$OS" in
Darwin)
  # macOS installation - only aarch64 (Apple Silicon) is available
  case "$ARCH" in
  arm64|aarch64)
    url="https://github.com/TabbyML/tabby/releases/latest/download/tabby_aarch64-apple-darwin.tar.gz"
    ;;
  x86_64)
    die "install-tabby: Intel macOS (x86_64) is not supported by Tabby. Only Apple Silicon (arm64) is available."
    ;;
  *)
    die "install-tabby: unsupported architecture: $ARCH"
    ;;
  esac
  ;;
Linux)
  # Linux installation
  case "$ARCH" in
  x86_64)
    url="https://github.com/TabbyML/tabby/releases/latest/download/tabby_x86_64-manylinux_2_28.tar.gz"
    ;;
  aarch64|arm64)
    die "install-tabby: ARM64 Linux is not currently provided by Tabby releases"
    ;;
  *)
    die "install-tabby: unsupported architecture: $ARCH"
    ;;
  esac
  ;;
*)
  die "install-tabby: unsupported operating system: $OS"
  ;;
esac

# Download Tabby binary (tar.gz archive)
temp_file=$(temp-file tabby.tar.gz)
if has curl; then
  curl -fsSL -o "$temp_file" "$url" || die "install-tabby: failed to download Tabby"
elif has wget; then
  wget -q -O "$temp_file" "$url" || die "install-tabby: failed to download Tabby"
else
  die "install-tabby: curl or wget required"
fi

# Extract the tar.gz archive
temp_dir=$(temp-file tabby-extract)
rm -f "$temp_dir"
mkdir -p "$temp_dir"
tar -xzf "$temp_file" -C "$temp_dir" || die "install-tabby: failed to extract tar.gz"

# Find and install the tabby binary
if [ -f "$temp_dir/tabby" ]; then
  mv "$temp_dir/tabby" "$install_dir/tabby"
else
  # Look for tabby binary in subdirectories
  tabby_bin=$(find "$temp_dir" -name "tabby" -type f 2>/dev/null | head -1)
  if [ -n "$tabby_bin" ]; then
    mv "$tabby_bin" "$install_dir/tabby"
  else
    rm -rf "$temp_dir"
    rm -f "$temp_file"
    die "install-tabby: tabby binary not found in archive"
  fi
fi

chmod +x "$install_dir/tabby"
rm -rf "$temp_dir"
rm -f "$temp_file"

# Verify installation
if ! "$script_dir/is-ai-component-installed" tabby 2>/dev/null; then
  die "install-tabby: installation verification failed"
fi

success "Tabby installed successfully"
