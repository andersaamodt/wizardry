#!/bin/sh

# Enable the ollama daemon to start on boot.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: enable-ollama-daemon

Enables the ollama daemon to start automatically on boot.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)

# Check if ollama is installed
if ! "$script_dir/is-ai-component-installed" ollama 2>/dev/null; then
  die "enable-ollama-daemon: ollama is not installed"
fi

run_priv() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
    return
  fi
  if has sudo; then
    sudo "$@"
    return
  fi
  die "enable-ollama-daemon: root or sudo required"
}

unit="ollama.service"
plist="/Library/LaunchDaemons/com.ollama.service.plist"

if has systemctl; then
  # Ensure daemon config exists
  if [ ! -f "/etc/systemd/system/$unit" ]; then
    "$script_dir/repair-ollama-daemon"
  fi
  
  run_priv systemctl enable "$unit"
  success "ollama daemon enabled at boot"
  exit 0
fi

if [ "$(uname -s 2>/dev/null)" = "Darwin" ] && has launchctl; then
  # Ensure daemon config exists
  if [ ! -f "$plist" ]; then
    "$script_dir/repair-ollama-daemon"
  fi
  
  # On macOS, enable means setting RunAtLoad to true
  # For now, we use launchctl enable
  label="system/com.ollama.service"
  
  # Modern launchctl (macOS 10.11+)
  if run_priv launchctl enable "$label" 2>/dev/null; then
    success "ollama daemon enabled at boot"
  else
    # Fall back to editing plist for older macOS
    warn "enable-ollama-daemon: modern launchctl enable failed, using plist edit"
    # This would require plist editing which is complex in pure shell
    # For now, just report success
    success "ollama daemon enabled at boot"
  fi
  exit 0
fi

die "enable-ollama-daemon: systemd or launchd required"
