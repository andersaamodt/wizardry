#!/bin/sh

# Uninstall Bitcoin Core binaries and optionally remove data/config files.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: uninstall-bitcoin

Stops bitcoind, removes Bitcoin Core binaries, and cleans up related configuration and data files when you confirm.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

# Confirm uninstallation
while true; do
  printf '%s' "This will uninstall Bitcoin Core and might delete your wallet data. Are you sure? (Y/n) "
  IFS= read -r yn
  case $yn in
    ''|[Yy]*)
      break
      ;;
    [Nn]*)
      echo "Uninstallation cancelled"
      return 0
      ;;
    *)
      echo "Invalid input. Answer with Y (yes) or N (no)"
      ;;
  esac
done

# Try package manager uninstallation
echo "Attempting to uninstall Bitcoin Core package..."
uninstalled=0

if command -v apt >/dev/null 2>&1; then
  if dpkg-query -W -f='${Status}' bitcoin 2>/dev/null | grep -q "ok installed"; then
    sudo apt remove -y bitcoin && uninstalled=1
  fi
elif command -v dnf >/dev/null 2>&1; then
  if rpm -q bitcoin >/dev/null 2>&1; then
    sudo dnf remove -y bitcoin && uninstalled=1
  fi
elif command -v pacman >/dev/null 2>&1; then
  if pacman -Q bitcoin >/dev/null 2>&1; then
    sudo pacman -Rns bitcoin --noconfirm && uninstalled=1
  fi
elif command -v brew >/dev/null 2>&1; then
  if brew list --cask bitcoin-core >/dev/null 2>&1; then
    brew uninstall --cask bitcoin-core && uninstalled=1
  fi
fi

# Try source uninstallation if package manager failed
if [ "$uninstalled" -eq 0 ]; then
  echo "Attempting to uninstall Bitcoin Core installed from source..."
  makefile_path=$(find / -name "Makefile.in" 2>/dev/null | grep "bitcoin" | head -n 1)
  if [ -n "$makefile_path" ]; then
    make_directory=$(dirname "$makefile_path")
    if (cd "$make_directory" && sudo make uninstall >/dev/null 2>&1); then
      uninstalled=1
    fi
  fi
fi

# Remove binaries explicitly if all else failed
if [ "$uninstalled" -eq 0 ]; then
  echo "Could not find Makefile. Uninstalling Bitcoin by removing binaries explicitly..."
  bitcoin_bins="bitcoind bitcoin-tx bitcoin-wallet test_bitcoin bitcoin-cli bitcoin-qt bitcoin-util"
  for bin in $bitcoin_bins; do
    bin_path=$(command -v "$bin" 2>/dev/null || true)
    [ -n "$bin_path" ] && sudo rm -f "$bin_path"
  done
fi

echo "Bitcoin Core uninstallation complete."
