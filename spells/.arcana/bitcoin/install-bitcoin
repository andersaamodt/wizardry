#!/bin/sh

# Install Bitcoin Core binaries on the system.

install_bitcoin_usage() {
cat <<'USAGE' >&2
Usage: install-bitcoin

Runs an interactive wizard to install Bitcoin Core (via packages, nix, or
upstream binaries), updates bitcoin.conf, and optionally starts the node.
USAGE
}

install_bitcoin() {
case "${1-}" in
--help|--usage|-h)
install_bitcoin_usage
return 0
;;
esac

require-wizardry || return 1


set -eu

BITCOIN_VERSION_DEFAULT="25.0"

# Prompt for version
prompt="Which Bitcoin Core version should be installed?"
printf "%s [%s]: " "$prompt" "$BITCOIN_VERSION_DEFAULT"
IFS= read -r version
[ -z "$version" ] && version=$BITCOIN_VERSION_DEFAULT

# Detect distribution
if command -v detect-distro >/dev/null 2>&1; then
  distro=$(detect-distro 2>/dev/null || printf 'unknown')
else
  distro='unknown'
fi

# NixOS installation path
if [ "$distro" = "nixos" ]; then
  echo "Detected NixOS. Installing via nix profile for user environment."
  
  # Try nix installation
  nix_success=0
  if command -v nix-env >/dev/null 2>&1; then
    nix-env -iA nixpkgs.bitcoind && nix_success=1
  elif command -v nix >/dev/null 2>&1; then
    nix profile install nixpkgs#bitcoind && nix_success=1
  fi
  
  # Fallback to binary if nix failed
  if [ "$nix_success" -eq 0 ]; then
    echo "Nix tools were not available; falling back to upstream binaries."
    
    # Binary installation inline
    binary_name=""
    arch=$(uname -m)
    case "$arch" in
      x86_64) binary_name="bitcoin-$version-x86_64-linux-gnu.tar.gz" ;;
      aarch64) binary_name="bitcoin-$version-aarch64-linux-gnu.tar.gz" ;;
      armv7l) binary_name="bitcoin-$version-arm-linux-gnueabihf.tar.gz" ;;
      *)
        echo "Unsupported architecture: $arch"
        exit 1
        ;;
    esac
    
    bitcoin_url="https://bitcoincore.org/bin/bitcoin-core-$version/$binary_name"
    tmp_dir=$(temp-dir bitcoin-install) || exit 1
    trap 'cleanup-dir "$tmp_dir"' EXIT HUP INT TERM
    cd "$tmp_dir" || exit 1
    wget "$bitcoin_url" || exit 1
    tar -xzf "$binary_name"
    sudo install -m 0755 -o root -g root -t /usr/local/bin "bitcoin-$version"/bin/*
    cd - >/dev/null || true
    trap - EXIT HUP INT TERM
    rm -rf "$tmp_dir"
    printf "Bitcoin Core version %s installed from upstream binaries.\n" "$version"
  fi
  
  # Configure bitcoin.conf
  if command -v ask-yn >/dev/null 2>&1; then
    if ask-yn "Configure bitcoin.conf with sensible defaults now?" "y"; then
      configure-bitcoin
    fi
  else
    printf "Configure bitcoin.conf with sensible defaults now? [Y/n] "
    read -r reply
    [ -z "$reply" ] && reply=y
    case "$reply" in [Yy]*) configure-bitcoin ;; esac
  fi
  
  # Maybe rebuild NixOS
  if command -v nixos-rebuild >/dev/null 2>&1; then
    if command -v ask-yn >/dev/null 2>&1; then
      if ask-yn "Run 'sudo nixos-rebuild switch' to activate any configuration changes?" "y"; then
        sudo nixos-rebuild switch
      fi
    else
      printf "Run 'sudo nixos-rebuild switch' to activate any configuration changes? [Y/n] "
      read -r reply
      [ -z "$reply" ] && reply=y
      case "$reply" in [Yy]*) sudo nixos-rebuild switch ;; esac
    fi
  fi
  
  # Maybe start bitcoind
  if command -v ask-yn >/dev/null 2>&1; then
    if ask-yn "Start bitcoind in the background now?" "y"; then
      if command -v systemctl >/dev/null 2>&1 \
          && systemctl list-unit-files | grep -q '^bitcoin.service'; then
        sudo systemctl start bitcoin
      else
        bitcoind -daemon || true
      fi
    fi
  else
    printf "Start bitcoind in the background now? [Y/n] "
    read -r reply
    [ -z "$reply" ] && reply=y
    if [ "$reply" = "y" ] || [ "$reply" = "Y" ]; then
      if command -v systemctl >/dev/null 2>&1 \
          && systemctl list-unit-files | grep -q '^bitcoin.service'; then
        sudo systemctl start bitcoin
      else
        bitcoind -daemon || true
      fi
    fi
  fi
  exit 0
fi

# Standard Linux installation
echo "Detected platform: $distro"

# Check if package manager available and ask
pkg_install_success=0
pkg_mgr_available=0
command -v apt >/dev/null 2>&1 && pkg_mgr_available=1
command -v dnf >/dev/null 2>&1 && pkg_mgr_available=1
command -v pacman >/dev/null 2>&1 && pkg_mgr_available=1
command -v brew >/dev/null 2>&1 && pkg_mgr_available=1

use_pkg_mgr=0
if [ "$pkg_mgr_available" -eq 1 ]; then
  if command -v ask-yn >/dev/null 2>&1; then
    ask-yn "Use your package manager to install Bitcoin Core?" "y" && use_pkg_mgr=1
  else
    printf "Use your package manager to install Bitcoin Core? [Y/n] "
    read -r reply
    [ -z "$reply" ] && reply=y
    case "$reply" in [Yy]*) use_pkg_mgr=1 ;; esac
  fi
fi

# Install via package manager if requested
if [ "$use_pkg_mgr" -eq 1 ]; then
  if command -v apt >/dev/null 2>&1; then
    sudo apt update && sudo apt install -y bitcoind bitcoin-qt && pkg_install_success=1
  elif command -v dnf >/dev/null 2>&1; then
    (sudo dnf install -y bitcoin || sudo dnf install -y bitcoind) && pkg_install_success=1
  elif command -v pacman >/dev/null 2>&1; then
    sudo pacman -Sy --noconfirm bitcoind && pkg_install_success=1
  elif command -v brew >/dev/null 2>&1; then
    brew install bitcoin-core && pkg_install_success=1
  fi
fi

# Fallback to binary if package install failed
if [ "$pkg_install_success" -eq 0 ]; then
  binary_name=""
  arch=$(uname -m)
  case "$arch" in
    x86_64) binary_name="bitcoin-$version-x86_64-linux-gnu.tar.gz" ;;
    aarch64) binary_name="bitcoin-$version-aarch64-linux-gnu.tar.gz" ;;
    armv7l) binary_name="bitcoin-$version-arm-linux-gnueabihf.tar.gz" ;;
    *)
      echo "Unsupported architecture: $arch"
      exit 1
      ;;
  esac
  
  bitcoin_url="https://bitcoincore.org/bin/bitcoin-core-$version/$binary_name"
  tmp_dir=$(temp-dir bitcoin-install) || exit 1
  trap 'cleanup-dir "$tmp_dir"' EXIT HUP INT TERM
  cd "$tmp_dir" || exit 1
  wget "$bitcoin_url" || exit 1
  tar -xzf "$binary_name"
  sudo install -m 0755 -o root -g root -t /usr/local/bin "bitcoin-$version"/bin/*
  cd - >/dev/null || true
  trap - EXIT HUP INT TERM
  rm -rf "$tmp_dir"
  printf "Bitcoin Core version %s installed from upstream binaries.\n" "$version"
fi

# Configure bitcoin.conf
if command -v ask-yn >/dev/null 2>&1; then
  if ask-yn "Configure bitcoin.conf with sensible defaults now?" "y"; then
    configure-bitcoin
  fi
else
  printf "Configure bitcoin.conf with sensible defaults now? [Y/n] "
  read -r reply
  [ -z "$reply" ] && reply=y
  case "$reply" in [Yy]*) configure-bitcoin ;; esac
fi

# Maybe install service
if command -v install-service-template >/dev/null 2>&1; then
  if command -v ask-yn >/dev/null 2>&1; then
    if ask-yn "Install a system service for bitcoind?" "n"; then
      script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
      install-service-template "$script_dir/bitcoin.service" "BITCOIND=$(command -v bitcoind)"
    fi
  else
    printf "Install a system service for bitcoind? [y/N] "
    read -r reply
    [ -z "$reply" ] && reply=n
    if [ "$reply" = "y" ] || [ "$reply" = "Y" ]; then
      script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
      install-service-template "$script_dir/bitcoin.service" "BITCOIND=$(command -v bitcoind)"
    fi
  fi
fi

# Maybe start bitcoind
if command -v ask-yn >/dev/null 2>&1; then
  if ask-yn "Start bitcoind in the background now?" "y"; then
    if command -v systemctl >/dev/null 2>&1 \
        && systemctl list-unit-files | grep -q '^bitcoin.service'; then
      sudo systemctl start bitcoin
    else
      bitcoind -daemon || true
    fi
  fi
else
  printf "Start bitcoind in the background now? [Y/n] "
  read -r reply
  [ -z "$reply" ] && reply=y
  if [ "$reply" = "y" ] || [ "$reply" = "Y" ]; then
    if command -v systemctl >/dev/null 2>&1 \
        && systemctl list-unit-files | grep -q '^bitcoin.service'; then
      sudo systemctl start bitcoin
    else
      bitcoind -daemon || true
    fi
  fi
fi

}

# Load castable imp for direct execution
if true; then  # Always source castable, never use from PATH
  _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
  [ -f "$_i/castable" ] && . "$_i/castable"
fi

castable "$@"