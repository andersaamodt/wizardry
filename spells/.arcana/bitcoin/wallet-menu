#!/bin/sh

# This script is a magical tome of sorcery, commanding the elusive entity known as Bitcoin.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: wallet-menu

Displays the Bitcoin wallet menu.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

# Load colors
if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  BOLD=""
  CYAN=""
  RESET=""
fi

# Catch Ctrl-C and TERM signal to exit cleanly
# INT (Ctrl-C) should exit 130, TERM should exit 0
trap 'exit 130' INT
trap 'exit 0' TERM

first_run=1

# Main execution loop
while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Display wallet menu
  title="${BOLD}${CYAN}Bitcoin Wallet"
  list_wallets="List Wallets%bitcoin-cli listwallets"
  create_wallet="Create Wallet%bitcoin-cli createwallet"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  menu "$title" "$list_wallets" "$create_wallet" "$exit_option" || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
