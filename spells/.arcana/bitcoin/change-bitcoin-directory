#!/bin/sh

# This spell alters the location of thy Bitcoin data chamber on your system.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: change-bitcoin-directory

Prompts for a new Bitcoin data directory, moves your existing datadir or selected pieces into place, and rewrites bitcoin.conf to point to the new location.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1
set -eu
env_clear

retry_with_sudo() {
    printf '%s\n' "Permission denied. Invoking the power of the super user..."
    sudo "$@"
    if [ $? -ne 0 ]; then
        printf '%s\n' "Failed to execute with elevated privileges. Make certain thou hast the necessary permissions and try again."
        exit 1
    fi
}

# Check for the bitcoin.conf file
if [ ! -f "$HOME/.bitcoin/bitcoin.conf" ]; then
    printf '%s\n' "Unable to locate bitcoin.conf. Canst thou provide its location?"
    read -r bitcoin_conf
    if [ ! -f "$bitcoin_conf" ]; then
        printf '%s\n' "bitcoin.conf file not found at the provided location. The spell must end here."
        exit 1
    fi
else
    bitcoin_conf="$HOME/.bitcoin/bitcoin.conf"
fi

# Get the current Bitcoin directory
current_directory=$(grep "datadir" "$bitcoin_conf" | cut -d'=' -f2)
if [ -z "$current_directory" ]; then
    current_directory="$HOME/.bitcoin"
else
    # Confirm that the directory actually exists
    if [ ! -d "$current_directory" ]; then
        printf '%s\n' "The Bitcoin data chamber specified in bitcoin.conf doth not exist. Check the 'datadir' value in bitcoin.conf."
        exit 1
    fi
    printf '%s\n' "Verified the existence of the Bitcoin data chamber at: $current_directory"
fi

# Ask for the new directory
printf '%s\n' "Enter the new haven for thy Bitcoin data:"
read -r new_directory

# Create the new directory if it does not exist
if [ ! -d "$new_directory" ]; then
    mkdir "$new_directory" || retry_with_sudo mkdir "$new_directory"
fi

# Ask user what to move
printf '%s\n' "What wouldst thou like to move to the new Bitcoin data haven?"
printf '%s\n' "1. The entire Bitcoin data chamber"
printf '%s\n' "2. Only the blockchain data"
printf '%s\n' "3. Move naught"

read -r move_choice

case "$move_choice" in
    1)
        printf '%s\n' "Moving the entire Bitcoin data chamber..."
        mv "$current_directory"/* "$new_directory" || \
          retry_with_sudo mv "$current_directory"/* "$new_directory"
        ;;
    2)
        printf '%s\n' "Moving only the blockchain data..."
        mv "$current_directory/blocks" "$current_directory/chainstate" "$new_directory" || \
          retry_with_sudo mv "$current_directory/blocks" "$current_directory/chainstate" "$new_directory"
        ;;
    3)
        printf '%s\n' "Moving naught..."
        ;;
    *)
        printf '%s\n' "Invalid choice, the spell ends here without moving anything."
        exit 1
        ;;
esac

# Update the bitcoin.conf file to point to the new directory
awk -v path="$new_directory" '!/datadir/ {print} /datadir/ {$3 = path; print}' "$bitcoin_conf" | \
  tee "$bitcoin_conf" >/dev/null || \
  { retry_with_sudo awk -v path="$new_directory" '!/datadir/ {print} /datadir/ {$3 = path; print}' \
    "$bitcoin_conf" | sudo tee "$bitcoin_conf" >/dev/null; }

printf '%s\n' "The Bitcoin data chamber now resides in: $new_directory"
