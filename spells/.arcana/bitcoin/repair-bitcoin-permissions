#!/bin/sh

# This script sets the correct permissions on the Bitcoin configuration directory.

repair_bitcoin_permissions_usage() {
        cat <<'USAGE' >&2
Usage: repair-bitcoin-permissions

Fixes ownership and permissions on bitcoin directories and files so the node can start cleanly after migrations or backups.
USAGE
}

repair_bitcoin_permissions() {
case "${1-}" in
--help|--usage|-h)
        repair_bitcoin_permissions_usage
        return 0
        ;;
esac

require-wizardry || return 1



# This script sets the correct permissions on the Bitcoin configuration directory.

# Set the default Bitcoin configuration directory

set -eu
default_dir="$HOME/.bitcoin"

# Check if the default directory exists
if [ -d "$default_dir" ]; then
  bitcoin_dir="$default_dir"
else
  # Prompt the user to enter the path to the Bitcoin configuration directory
  printf '%s' "Enter the path to the Bitcoin configuration directory: "
  IFS= read -r bitcoin_dir
fi

# Check if the provided directory exists
if [ -d "$bitcoin_dir" ]; then
  # Set the default permission mode
  default_mode=710

  # Get the configuration directory mode from bitcoin.conf
  config_mode=$(grep -E '^ConfigurationDirectoryMode=' "$bitcoin_dir/bitcoin.conf" | cut -d '=' -f 2)

  # If ConfigurationDirectoryMode is not specified, use the default mode
  if [ -z "$config_mode" ]; then
    config_mode=$default_mode
  fi

  # Apply the configured mode
  chmod "$config_mode" "$bitcoin_dir"
  echo "The permission on the Bitcoin configuration directory has been set to $config_mode."
else
  echo "The provided directory does not exist."
fi

}

# Load castable imp for direct execution
if true; then  # Always source castable, never use from PATH
  _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
  [ -f "$_i/castable" ] && . "$_i/castable"
fi

castable "$@"