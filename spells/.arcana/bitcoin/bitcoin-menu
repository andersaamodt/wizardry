#!/bin/sh

# This script is a magical tome of sorcery, commanding the elusive entity known as Bitcoin.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: . bitcoin-menu    OR    bitcoin menu    (via parse/gloss)

Displays the Bitcoin management menu.

This spell must be sourced (not executed) to affect your current shell.
USAGE
  return 0 2>/dev/null || exit 0
  ;;
esac

require-wizardry || return 1 2>/dev/null || exit 1

# Uncastable pattern - detect if sourced
bitcoin_menu_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) bitcoin_menu_sourced=1 ;;
  esac
else
  bitcoin_menu_base=${0##*/}
  case "$bitcoin_menu_base" in
    sh|dash|bash|zsh|ksh|mksh) bitcoin_menu_sourced=1 ;;
    bitcoin-menu) bitcoin_menu_sourced=0 ;;
    parse) bitcoin_menu_sourced=1 ;;  # Sourced via parse
    *) bitcoin_menu_sourced=1 ;;
  esac
fi

if [ "$bitcoin_menu_sourced" -eq 0 ]; then
  printf '%s\n' "This spell must be sourced. Use:  . bitcoin-menu  OR  bitcoin menu" >&2
  return 1 2>/dev/null || exit 1
fi
unset bitcoin_menu_sourced bitcoin_menu_base

set +e  # Permissive mode since we're in user's shell
set -u
. env-clear
. colors

# Catch Ctrl-C and TERM signal to return cleanly
trap 'return 0' INT TERM

# Displays the menu
bitcoin_menu_display_menu() {
  title="${BOLD}${CYAN}Bitcoin: $(bitcoin-status)"
  blockchain_info="Display Blockchain Info%bitcoin-cli getblockchaininfo"
  set_config="Configure Bitcoin%configure-bitcoin"
  change_directory="Change Bitcoin Directory%change-bitcoin-directory"
  clear_cache="Clear Bitcoin Cache%# coming soon"
  repair_permissions="Repair Permissions%repair-bitcoin-permissions"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  if is-bitcoin-installed; then
    install_bitcoin_option="Uninstall Bitcoin%uninstall-bitcoin"
    if is-service-installed bitcoin; then
      install_service_option="Uninstall Bitcoin Service%remove-service bitcoin"
      service_status_option="View Bitcoin Service Status%sudo systemctl status bitcoin"
      if is-bitcoin-running; then
        bitcoin_service_option="Stop Bitcoin Service%sudo systemctl stop bitcoin"
        menu "$title" "$blockchain_info" "$set_config" "$change_directory" \
          "$clear_cache" "$repair_permissions" "$service_status_option" \
          "$bitcoin_service_option" "$install_service_option" \
          "$install_bitcoin_option" "$exit_option"
      else
        bitcoin_service_option="Start Bitcoin Service%sudo systemctl start bitcoin"
        menu "$title" "$set_config" "$change_directory" "$clear_cache" \
          "$repair_permissions" "$service_status_option" "$bitcoin_service_option" \
          "$install_service_option" "$install_bitcoin_option" "$exit_option"
      fi
    else
      script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
      install_service_option="Install Bitcoin Service%install-service-template \
$script_dir/bitcoin.service \"BITCOIND=\$(command -v bitcoind)\""
      menu "$title" "$set_config" "$change_directory" "$clear_cache" \
        "$repair_permissions" "$install_service_option" "$install_bitcoin_option" \
        "$exit_option"
  fi
  else
    install_bitcoin_option="Install Bitcoin%install-bitcoin"
    menu "$title" "$install_bitcoin_option" "$exit_option"
  fi
}

first_run=1

# Main execution loop
while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  bitcoin_menu_display_menu || true
done

