#!/bin/sh

# Ensure user is root

configure_tor_bridge_usage() {
        cat <<'USAGE' >&2
Usage: configure-tor-bridge

Guides a root user through enabling or disabling Tor bridge mode by updating torrc and restarting tor after confirmation.
USAGE
}

configure_tor_bridge() {
case "${1-}" in
--help|--usage|-h)
        configure_tor_bridge_usage
        return 0
        ;;
esac

require-wizardry || return 1


set -eu
env-clear
if [ "$(id -u)" -ne 0 ]; then
    echo "configure-tor-bridge: root privileges required."
    return 1
fi

# Identify torrc file location based on OS
torrc_location=$(torrc-path)

# Instructions and warning
cat << EOF
This script will enable or disable bridge mode for your Tor relay.

Becoming a bridge relay helps users in countries that block access to the Tor network. 
However, be aware that this could increase your network traffic and may have other unforeseen consequences.

Make sure to review the Tor documentation and fully understand the implications before proceeding.
EOF

# Check if bridge mode is currently enabled
bridge_enabled=$(tor-bridge-status)

if [ "$bridge_enabled" = "1" ]; then
    # Bridge mode is currently enabled, ask if user wants to disable
    ask-yn "Bridge mode is currently enabled. Do you want to disable it?" "N"
    if [ $? -eq 0 ]; then
        # Use awk to comment out the BridgeRelay line
        awk '{if ($1 == "BridgeRelay" && $2 == "1") {$0 = "# " $0} print}' "$torrc_location" > "$torrc_location.tmp" && mv "$torrc_location.tmp" "$torrc_location"
        echo "Bridge mode disabled."
        sudo systemctl restart tor
    else
        echo "Bridge mode remains enabled."
    fi
else
    # Bridge mode is currently disabled, ask if user wants to enable
    ask-yn "Bridge mode is currently disabled. Do you want to enable it?" "N"
    if [ $? -eq 0 ]; then
        # Append necessary lines to torrc if they don't already exist
        awk '!/^BridgeRelay 1$/ && !/^ORPort 9001$/ && !/^PublishServerDescriptor 0$/ {print} END {if (!/^BridgeRelay 1$/) {print "BridgeRelay 1"} if (!/^ORPort 9001$/) {print "ORPort 9001"} if (!/^PublishServerDescriptor 0$/) {print "PublishServerDescriptor 0"}}' "$torrc_location" > "$torrc_location.tmp" && mv "$torrc_location.tmp" "$torrc_location"
        echo "Bridge mode enabled. You are now acting as a Tor bridge relay."
        sudo systemctl restart tor
    else
        echo "Bridge mode remains disabled."
    fi
fi
}

# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*/*}}}/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*/*}}}/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
