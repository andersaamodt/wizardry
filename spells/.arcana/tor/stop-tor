#!/bin/sh
# Stop tor service

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: stop-tor

Stop the tor service.

Tries systemctl (Linux) first, then killall (macOS/others).
USAGE
  exit 0
  ;;
esac

set -eu

printf 'Stopping tor...\n'

# Check if tor is running first (inline check to avoid dependencies)
tor_running=0
if command -v pgrep >/dev/null 2>&1; then
    if pgrep -x tor >/dev/null 2>&1; then
        tor_running=1
    fi
else
    if ps aux 2>/dev/null | grep -v grep | grep -q 'tor$\|tor '; then
        tor_running=1
    fi
fi

if [ "$tor_running" = "0" ]; then
  printf 'stop-tor: tor is not running\n' >&2
  exit 1
fi

# Try systemctl (Linux with systemd)
if command -v systemctl >/dev/null 2>&1; then
  if sudo systemctl stop tor 2>/dev/null; then
    printf 'Tor stopped via systemctl.\n'
    exit 0
  fi
fi

# Try launchctl (macOS)
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  if is-tor-launchd-service-configured; then
    if sudo launchctl stop org.torproject.tor 2>/dev/null; then
      printf 'Tor stopped via launchd.\n'
      exit 0
    fi
  fi
fi

# Try killall (macOS and others - fallback)
if sudo killall tor 2>/dev/null; then
  printf 'Tor stopped.\n'
  exit 0
fi

printf 'stop-tor: could not stop tor\n' >&2
exit 1
