#!/bin/sh
# Stop tor service

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: stop-tor

Stop the tor service.

Tries systemctl (Linux) first, then killall (macOS/others).
USAGE
  exit 0
  ;;
esac

set -eu

printf 'Stopping tor...\n'

# Check if tor is running first
if ! is-tor-running; then
  printf 'stop-tor: tor is not running\n' >&2
  exit 1
fi

# Try systemctl (Linux with systemd)
if command -v systemctl >/dev/null 2>&1; then
  if sudo systemctl stop tor 2>/dev/null; then
    printf 'Tor stopped via systemctl.\n'
    # Wait and verify it actually stopped
    sleep 2
    if ! is-tor-running; then
      exit 0
    else
      printf 'Warning: systemctl stop succeeded but tor still running.\n' >&2
    fi
  fi
fi

# Try launchctl (macOS)
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  if is-tor-launchd-service-configured; then
    # On macOS with launchd, we need to unload the service with -w flag
    # to disable KeepAlive which will restart it if we just stop it
    printf 'Unloading tor from launchd...\n'
    if sudo launchctl unload -w /Library/LaunchDaemons/org.torproject.tor.plist 2>/dev/null; then
      printf 'Tor launchd service unloaded.\n'
      # Wait for process to actually stop (increased to allow graceful shutdown)
      sleep 5
      # Re-enable the service but don't start it
      sudo launchctl load -w /Library/LaunchDaemons/org.torproject.tor.plist 2>/dev/null || true
      
      if ! is-tor-running; then
        printf 'Tor stopped successfully.\n'
        exit 0
      else
        printf 'Warning: unload succeeded but tor still running.\n' >&2
        printf 'Attempting to kill tor process directly...\n'
      fi
    fi
  fi
fi

# Try killall (macOS and others - fallback)
if sudo killall tor 2>/dev/null; then
  printf 'Sent SIGTERM to tor process.\n'
  sleep 5
  if ! is-tor-running; then
    printf 'Tor stopped.\n'
    exit 0
  else
    printf 'Warning: SIGTERM did not stop tor, trying pkill...\n' >&2
  fi
fi

# Try pkill with SIGTERM
if sudo pkill -TERM tor 2>/dev/null; then
  printf 'Sent SIGTERM via pkill.\n'
  sleep 5
  if ! is-tor-running; then
    printf 'Tor stopped.\n'
    exit 0
  else
    printf 'Warning: pkill SIGTERM did not work, trying SIGKILL...\n' >&2
  fi
fi

# Last resort: force kill with SIGKILL
if sudo pkill -9 tor 2>/dev/null; then
  printf 'Force-killed tor with SIGKILL.\n'
  sleep 2
  if ! is-tor-running; then
    printf 'Tor stopped.\n'
    exit 0
  else
    printf 'Warning: Even SIGKILL did not stop tor.\n' >&2
  fi
fi

printf 'stop-tor: could not stop tor\n' >&2
exit 1
