#!/bin/sh

# Install libevent library (Tor dependency for macOS).

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: install-libevent

This spell installs the libevent library, required for building Tor on macOS.
Uses pkgin (pkgsrc) package manager on macOS.
USAGE
  exit 0
  ;;
esac

set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)

# Check if libevent is already installed
if pkg-config --exists libevent 2>/dev/null; then
  printf '%s\n' "libevent is already installed (detected via pkg-config)"
  exit 0
elif [ -f /usr/local/lib/libevent.dylib ]; then
  printf '%s\n' "libevent is already installed (/usr/local/lib/libevent.dylib)"
  exit 0
elif [ -f /opt/local/lib/libevent.dylib ]; then
  printf '%s\n' "libevent is already installed (/opt/local/lib/libevent.dylib)"
  exit 0
fi

# Check if on macOS
if [ "$(uname -s 2>/dev/null)" != "Darwin" ]; then
  printf '%s\n' "install-libevent: this installer is for macOS only" >&2
  exit 1
fi

# Use manage-system-command with pkgin package name
ASSUME_YES=1
FORCE_INSTALL=${INSTALL_LIBEVENT_FORCE_INSTALL:-0}
PKGIN_PACKAGE="libevent"
export ASSUME_YES FORCE_INSTALL PKGIN_PACKAGE

"$SCRIPT_DIR/../core/manage-system-command" libevent libevent
