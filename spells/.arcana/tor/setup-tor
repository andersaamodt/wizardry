#!/bin/sh

# Set up a Tor hidden service for the MUD gateway.

# Parse flags
skip_confirm=0
case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: setup-tor [-y|--yes]

Configure a basic Tor hidden service for the MUD gateway.
Prompts for confirmation before writing to torrc and restarting Tor.

Options:
  -y, --yes    Skip confirmation prompt
USAGE
  exit 0
  ;;
-y|--yes)
  skip_confirm=1
  ;;
esac

require-wizardry || exit 1

set -eu

# Check if tor is installed, offer to install if not
# Use multiple detection methods for reliability
tor_installed=0
if [ -x /usr/local/bin/tor ]; then
        tor_installed=1
elif command -v tor >/dev/null 2>&1; then
        tor_installed=1
fi

if [ "$tor_installed" -eq 0 ]; then
        printf '%s\n' "Tor is not installed."
        printf '%s' "Would you like to install Tor now? [y/n]: "
        IFS= read -r install_choice || exit 1
        case $install_choice in
        y|Y)
                install-tor || exit 1
                
                # Verify tor is now installed
                if [ -x /usr/local/bin/tor ] || command -v tor >/dev/null 2>&1; then
                        printf '%s\n' "Tor is now installed and ready."
                else
                        printf '\n'
                        printf '%s\n' \
                            "setup-tor: tor installation completed but tor is still not found"
                        printf '%s\n' "Possible causes:"
                        printf '%s\n' "  - Installation failed (check output above for errors)"
                        printf '%s\n' "  - New terminal window needed for PATH updates"
                        printf '%s\n' "  - /usr/local/bin not in current PATH"
                        exit 1
                fi
                ;;
        *)
                printf '%s\n' "Tor installation skipped. Cannot set up hidden service without Tor."
                exit 0
                ;;
        esac
fi

# Skip confirmation if -y flag was provided
if [ "$skip_confirm" -eq 0 ]; then
        printf '%s' "Set up a Tor hidden service for wizardry MUD gateway? [y/n]: "
        IFS= read -r choice || exit 1
else
        choice="y"
fi

case $choice in
y|Y)
        # Use torrc-path to get the correct config path for this platform
        tor_config_path=$(torrc-path) || exit 1
        
        # Get platform info for platform-specific settings
        if command -v detect-distro >/dev/null 2>&1; then
                distro=$(detect-distro)
        else
                distro=$(os)
        fi
        
        # Detect tor's data directory from torrc to use correct path
        data_dir=$(grep "^DataDirectory" "$tor_config_path" 2>/dev/null \
            | awk '{print $2}' | tr -d '"' || echo "")
        
        # Set platform-specific hidden service directory
        case $distro in
        mac|macos)
                if [ -n "$data_dir" ]; then
                        # Use detected data directory
                        mud_dir="${data_dir}/mud/"
                elif [ -d "/opt/homebrew/var/lib/tor" ]; then
                        # Homebrew on Apple Silicon
                        mud_dir="/opt/homebrew/var/lib/tor/mud/"
                elif [ -d "/usr/local/var/lib/tor" ]; then
                        # Homebrew on Intel or older
                        mud_dir="/usr/local/var/lib/tor/mud/"
                elif [ -d "/opt/local/var/lib/tor" ]; then
                        # MacPorts
                        mud_dir="/opt/local/var/lib/tor/mud/"
                else
                        # Fallback
                        mud_dir="/var/lib/tor/mud/"
                fi
                ;;
        *)
                if [ -n "$data_dir" ]; then
                        mud_dir="${data_dir}/mud/"
                else
                        mud_dir="/var/lib/tor/mud/"
                fi
                ;;
        esac
        
        # Create the directory if it doesn't exist
        sudo mkdir -p "$mud_dir" || exit 1
        # Set proper ownership (try _tor:wheel for macOS, then tor:tor for Linux)
        # On macOS, the _tor user belongs to the wheel group
        sudo chown -R _tor:wheel "$mud_dir" 2>/dev/null \
            || sudo chown -R tor:tor "$mud_dir" 2>/dev/null || true
        sudo chmod 700 "$mud_dir" || true

        printf 'HiddenServiceDir %s\n' "$mud_dir" | sudo tee -a "$tor_config_path"
        printf '%s\n' "HiddenServiceVersion 3" | sudo tee -a "$tor_config_path"
        printf '%s\n' "HiddenServicePort 80 127.0.0.1:8080" | sudo tee -a "$tor_config_path"
        
        # Ensure torrc remains readable after modification
        sudo chmod 644 "$tor_config_path"
        
        # Restart tor to activate the hidden service
        printf '%s\n' "Hidden service configured in $tor_config_path"
        
        if restart-tor; then
                # Wait for tor to actually start (up to 10 seconds)
                printf 'Waiting for tor to start...\n'
                wait_count=0
                while [ $wait_count -lt 10 ]; do
                        if is-tor-running; then
                                printf 'Tor is running.\n'
                                break
                        fi
                        sleep 1
                        wait_count=$((wait_count + 1))
                done
                
                if ! is-tor-running; then
                        printf 'Warning: Tor does not appear to be running yet.\n' >&2
                        printf 'Check logs with: show-tor-log\n' >&2
                fi
                
                # Wait for tor to generate the hidden service (up to 15 seconds)
                hostname_file="${mud_dir}/hostname"
                printf 'Waiting for tor to generate .onion address...\n'
                wait_count=0
                while [ $wait_count -lt 15 ]; do
                        if [ -f "$hostname_file" ]; then
                                printf 'Hostname file created.\n'
                                break
                        fi
                        sleep 1
                        wait_count=$((wait_count + 1))
                done
                
                # Fix permissions on tor directories
                printf 'Fixing tor permissions...\n'
                repair-tor-permissions >/dev/null 2>&1 || true
                
                # Read the hidden service address if available
                if [ -f "$hostname_file" ] && [ -r "$hostname_file" ]; then
                        onion_address=$(cat "$hostname_file" 2>/dev/null || true)
                        if [ -n "$onion_address" ]; then
                                printf 'Hidden service address: %s\n' "$onion_address"
                                printf 'The .onion address is stored at: %s\n' "$hostname_file"
                        fi
                else
                        printf '%s\n' "Hidden service configured."
                        printf 'The .onion address will be stored at: %s\n' "$hostname_file"
                        if [ -f "$hostname_file" ]; then
                                printf 'Note: File exists but may not be readable yet.\n'
                                printf 'Try running: repair-tor-permissions\n'
                        else
                                printf 'Note: Tor may still be generating the .onion address.\n'
                                printf 'It can take up to a minute. Check with: show-tor-log\n'
                        fi
                fi
        else
                printf 'Error: Failed to restart tor.\n' >&2
                printf 'Try running: show-tor-log\n' >&2
                exit 1
        fi
        ;;
*)
        printf '%s\n' "Tor setup skipped."
        ;;
esac
