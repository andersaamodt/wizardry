#!/bin/sh
# Restart tor service

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: restart-tor

Restart the tor service.

Tries systemctl (Linux) first, then killall + restart (macOS/others).
USAGE
  exit 0
  ;;
esac

set -eu

printf 'Restarting tor...\n'

# Try systemctl first (Linux with systemd)
if command -v systemctl >/dev/null 2>&1; then
  if sudo systemctl restart tor 2>/dev/null; then
    printf 'Tor restarted via systemctl.\n'
    exit 0
  fi
fi

# Try launchctl (macOS)
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  if is-tor-launchd-service-configured; then
    # Use launchctl unload/load for proper restart with launchd
    plist_file="/Library/LaunchDaemons/org.torproject.tor.plist"
    printf 'Restarting tor via launchd...\n'
    
    # Unload (stop) the service - always try to unload first
    # Use -w flag to also disable it temporarily
    sudo launchctl unload -w "$plist_file" 2>/dev/null || true
    sleep 2
    
    # Load (start) the service with -w flag to enable and start it
    # This works even if the service was previously disabled
    if sudo launchctl load -w "$plist_file" 2>/dev/null; then
      printf 'Tor restarted via launchd.\n'
      # Wait for tor to start
      sleep 2
      if is-tor-running; then
        printf 'Tor is running.\n'
        exit 0
      else
        printf 'Warning: launchctl load succeeded but tor not detected yet.\n' >&2
        printf 'Tor may still be starting up...\n'
        exit 0
      fi
    else
      # Load failed - try to recover by recreating the service
      printf 'Warning: launchctl load failed, attempting to recreate service...\n' >&2
      if create-tor-launchd-service; then
        printf 'Tor service recreated and started.\n'
        exit 0
      else
        printf 'Error: Failed to restart tor via launchd.\n' >&2
        printf 'Check logs with: show-tor-log\n' >&2
        exit 1
      fi
    fi
  else
    # Service not configured, create it (this will also start it)
    if create-tor-launchd-service; then
      printf 'Tor service created and started.\n'
      exit 0
    fi
  fi
fi

# On systems without service managers, we can't safely restart tor
# because we can't distinguish between our tor and Tor Browser's tor
printf 'restart-tor: no service manager found\n' >&2
printf 'Cannot safely restart tor without killing Tor Browser instance.\n' >&2
printf 'Please use the system service manager.\n' >&2
exit 1
