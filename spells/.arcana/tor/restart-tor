#!/bin/sh
# Restart tor service

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: restart-tor

Restart the tor service.

Tries systemctl (Linux) first, then killall + restart (macOS/others).
USAGE
  exit 0
  ;;
esac

set -eu

printf 'Restarting tor...\n'

# Try systemctl first (Linux with systemd)
if command -v systemctl >/dev/null 2>&1; then
  if sudo systemctl restart tor 2>/dev/null; then
    printf 'Tor restarted via systemctl.\n'
    exit 0
  fi
fi

# Try launchctl (macOS)
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  if is-tor-launchd-service-configured; then
    # Use launchctl unload/load for proper restart with launchd
    plist_file="/Library/LaunchDaemons/org.torproject.tor.plist"
    printf 'Restarting tor via launchd...\n'
    
    # Unload (stop) the service
    sudo launchctl unload "$plist_file" 2>/dev/null || true
    sleep 2
    
    # Load (start) the service
    if sudo launchctl load "$plist_file" 2>/dev/null; then
      printf 'Tor restarted via launchd.\n'
      exit 0
    fi
  else
    # Service not configured, create it (this will also start it)
    if create-tor-launchd-service; then
      printf 'Tor service created and started.\n'
      exit 0
    fi
  fi
fi

# Try killall for systems without service managers (not recommended)
if command -v tor >/dev/null 2>&1; then
  printf 'Warning: Using killall method (service manager not available).\n' >&2
  sudo killall tor 2>/dev/null || true
  sleep 1
  # Don't start tor in background - let service manager handle it
  printf 'Tor stopped. Use start-tor to restart.\n'
  exit 1
fi

printf 'restart-tor: tor restart needed but method not available\n' >&2
exit 1
