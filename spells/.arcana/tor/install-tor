#!/bin/sh

# Install and configure Tor across supported platforms.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: install-tor

Guides you through installing Tor. On NixOS, this will update configuration.nix
when possible and run sudo nixos-rebuild all for you.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

# Find script directory for sibling resources
SCRIPT_SOURCE=$0
case $SCRIPT_SOURCE in
*/*)
        SCRIPT_DIR=${SCRIPT_SOURCE%/*}
        ;;
*)
        resolved=$(command -v "$SCRIPT_SOURCE" 2>/dev/null || printf '%s' "$SCRIPT_SOURCE")
        SCRIPT_DIR=${resolved%/*}
        SCRIPT_SOURCE=$resolved
        ;;
esac
if [ -z "$SCRIPT_DIR" ] || [ "$SCRIPT_DIR" = "$SCRIPT_SOURCE" ]; then
        SCRIPT_DIR=.
fi
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd -P)
IMPS_TEXT_DIR=$(cd "$SCRIPT_DIR" 2>/dev/null && cd .. && cd .. && cd .imps/text && pwd -P)

# Welcome message
printf '%s\n' 'Welcome to the Tor installation wizard.'
distro="$(detect-distro 2>/dev/null || os)"
printf 'Detected platform: %s\n' "$distro"

# Platform-specific installation
case $distro in
  debian|ubuntu|linux)
    printf '%s\n' 'Installing tor via apt...'
    if command -v sudo >/dev/null 2>&1; then
      sudo apt-get update
      sudo apt-get install -y tor
    else
      apt-get update
      apt-get install -y tor
    fi
    ;;
  arch)
    printf '%s\n' 'Installing tor via pacman...'
    if command -v sudo >/dev/null 2>&1; then
      sudo pacman -Sy --noconfirm tor
    else
      pacman -Sy --noconfirm tor
    fi
    ;;
  mac|macos)
    printf '%s\n' 'Installing Tor from source on macOS...'
    
    # Check for required tools
    if ! command -v make >/dev/null 2>&1; then
      xcode_msg='Error: make is required.'
      xcode_msg2='Install Xcode Command Line Tools: xcode-select --install'
      printf '%s\n' "$xcode_msg"
      printf '%s\n' "$xcode_msg2"
      exit 1
    fi
    
    # Automatically install libevent if not present
    if ! is-libevent-installed; then
      printf '%s\n' 'libevent is required to build Tor.'
      printf '%s\n' 'Installing libevent automatically...'
      if ! install-libevent; then
        printf '%s\n' 'Error: Failed to install libevent.' >&2
        printf '%s\n' 'Please install it manually and try again.' >&2
        exit 1
      fi
    fi
    
    # Automatically install OpenSSL if not present
    if ! is-openssl-installed; then
      printf '%s\n' 'OpenSSL is required to build Tor.'
      printf '%s\n' 'Installing OpenSSL automatically...'
      if ! install-openssl; then
        printf '%s\n' 'Error: Failed to install OpenSSL.' >&2
        printf '%s\n' 'Please install it manually and try again.' >&2
        exit 1
      fi
    fi
    
    # Detect pkgsrc installation directory
    pkgsrc_prefix=""
    if [ -d /opt/pkg ]; then
      pkgsrc_prefix="/opt/pkg"
    elif [ -d /usr/pkg ]; then
      pkgsrc_prefix="/usr/pkg"
    fi
    
    # Create temp directory for build
    tmp_dir=$(temp-dir tor-install) || exit 1
    trap 'cleanup-dir "$tmp_dir"' EXIT HUP INT TERM
    cd "$tmp_dir" || exit 1
    
    # Download and build latest stable tor
    TOR_VERSION="0.4.8.10"
    printf 'Downloading Tor %s...\n' "$TOR_VERSION"
    if command -v curl >/dev/null 2>&1; then
      curl -L -O "https://dist.torproject.org/tor-${TOR_VERSION}.tar.gz" || exit 1
    elif command -v wget >/dev/null 2>&1; then
      wget "https://dist.torproject.org/tor-${TOR_VERSION}.tar.gz" || exit 1
    else
      printf '%s\n' 'Error: curl or wget required to download Tor'
      exit 1
    fi
    
    tar -xzf "tor-${TOR_VERSION}.tar.gz"
    cd "tor-${TOR_VERSION}" || exit 1
    
    printf 'Configuring and building Tor (this may take a few minutes)...\n'
    
    # Configure with appropriate paths based on pkgsrc availability
    if [ -n "$pkgsrc_prefix" ]; then
      # Point configure to pkgsrc library and include paths
      # Set additional flags for compiler and linker
      export CPPFLAGS="-I$pkgsrc_prefix/include"
      export LDFLAGS="-L$pkgsrc_prefix/lib"
      
      printf 'Using pkgsrc prefix: %s\n' "$pkgsrc_prefix"
      
      ./configure --prefix=/usr/local \
        --disable-dependency-tracking \
        --with-libevent-dir="$pkgsrc_prefix" \
        --with-openssl-dir="$pkgsrc_prefix" || exit 1
    else
      ./configure --prefix=/usr/local \
        --disable-dependency-tracking || exit 1
    fi
    
    printf '\n'
    printf 'Building Tor from source (this may take several minutes)...\n'
    printf 'Compilation output:\n'
    printf '%s\n' "----------------------------------------"
    
    # Ensure we're in the tor source directory
    if [ ! -f "Makefile" ]; then
      printf '%s\n' "install-tor: Makefile not found in tor source directory"
      printf '%s\n' "Current directory: $(pwd)"
      printf '%s\n' "Expected location: extracted tor source directory"
      printf '%s\n' "Directory contents:"
      ls -la
      exit 1
    fi
    
    # Run make with explicit output handling
    # Note: Both stdout and stderr are shown to user
    make
    make_exit=$?
    
    printf '%s\n' "----------------------------------------"
    
    if [ "$make_exit" -ne 0 ]; then
      printf '\n'
      printf '%s\n' "install-tor: compilation failed"
      printf '%s\n' "Possible causes:"
      printf '%s\n' "  - Xcode Command Line Tools not found"
      printf '%s\n' "  - Incompatible compiler version detected"
      printf '%s\n' "  - Missing or incompatible dependencies detected"
      printf '\n'
      printf '%s\n' "The compilation output above may contain more details."
      exit 1
    fi
    
    printf 'Build completed successfully.\n'
    
    printf '\n'
    printf 'Installing Tor to /usr/local/bin...\n'
    if command -v sudo >/dev/null 2>&1; then
      sudo make install || exit 1
    else
      make install || exit 1
    fi
    
    # Verify installation before cleaning up
    if [ ! -x /usr/local/bin/tor ]; then
      printf '%s\n' "ERROR: make install completed but /usr/local/bin/tor not found!"
      printf '%s\n' "Checking alternate locations..."
      
      # Check other possible locations (shared list used later too)
      alternate_tor_paths="/usr/bin/tor /opt/local/bin/tor /usr/local/sbin/tor"
      found_elsewhere=0
      for tor_path in $alternate_tor_paths; do
        if [ -x "$tor_path" ]; then
          printf '%s\n' "Found tor at: $tor_path"
          printf '%s\n' "Tor was installed to a different location than expected."
          found_elsewhere=1
          break
        fi
      done
      
      if [ "$found_elsewhere" -eq 0 ]; then
        printf '%s\n' "Installation failed. Check output above for errors."
        exit 1
      fi
    else
      printf '%s\n' 'Tor binary installed successfully to /usr/local/bin/tor'
    fi
    
    # Clear shell command cache so tor can be found immediately
    hash -r 2>/dev/null || true
    
    cd - >/dev/null || true
    trap - EXIT HUP INT TERM
    rm -rf "$tmp_dir"
    ;;
  nixos)
    # Ask for configuration path
    printf "Path to NixOS configuration [/etc/nixos/configuration.nix]: "
    read -r config_path
    config_path=${config_path:-/etc/nixos/configuration.nix}
    
    changes=0
    if [ ! -f "$config_path" ]; then
      printf '%s\n' "NixOS configuration file $config_path was not found."
      exit 1
    fi

    if command -v backup-nix-config >/dev/null 2>&1; then
      backup-nix-config "$config_path" >&2 || true
    fi

    # Detect indentation style from config file
    indent_l1="  "
    indent_l2="    "
    if [ -x "$IMPS_TEXT_DIR/make-indent" ]; then
      indent_l1=$("$IMPS_TEXT_DIR/make-indent" 1 "$config_path")
      indent_l2=$("$IMPS_TEXT_DIR/make-indent" 2 "$config_path")
    fi

    if grep -q 'environment.systemPackages' "$config_path"; then
      if ! grep -q 'tor' "$config_path"; then
        printf '%s\n' 'Adding tor to environment.systemPackages...'
        pattern1="(environment\\.systemPackages\\s*=\\s*with\\s+pkgs;\\s*\\[[^\\]]*)\\]"
        replace1="\$1\\n${indent_l2}tor\\n${indent_l1}]"
        sudo perl -0pi -e "s/$pattern1/$replace1/" "$config_path" || {
          pattern2="(environment\\.systemPackages\\s*=\\s*\\[[^\\]]*)\\]"
          replace2="\$1\\n${indent_l2}tor\\n${indent_l1}]"
          sudo perl -0pi -e "s/$pattern2/$replace2/" "$config_path"
        }
        changes=1
      fi
    fi

    if ! grep -q 'services.tor.enable' "$config_path"; then
      printf '%s\n' 'Enabling Tor service in configuration.nix...'
      sudo perl -0pi -e "s/(\\n\\})/\\n${indent_l1}services.tor.enable = true;\\n}/" "$config_path"
      changes=1
    fi

    if [ "$changes" -eq 1 ]; then
      printf '%s\n' 'Rebuilding NixOS to apply Tor installation...'
      sudo nixos-rebuild all
    else
      printf '%s\n' 'Tor already present in configuration.nix.'
    fi
    ;;
  *)
    printf '%s\n' "Unsupported distribution for automatic Tor installation."
    exit 1
    ;;
esac

# Clear shell command cache to find newly installed tor
hash -r 2>/dev/null || true

# Check if installation was successful - use multiple methods
tor_found=0
tor_location=""
alternate_tor_paths="/usr/bin/tor /opt/local/bin/tor /usr/local/sbin/tor"

# Method 1: Check if tor binary exists in expected location
if [ -x /usr/local/bin/tor ]; then
  tor_found=1
  tor_location="/usr/local/bin/tor"
# Method 2: Try command -v
elif command -v tor >/dev/null 2>&1; then
  tor_found=1
  tor_location=$(command -v tor)
# Method 3: Check other common locations
else
  for check_path in $alternate_tor_paths; do
    if [ -x "$check_path" ]; then
      tor_found=1
      tor_location="$check_path"
      break
    fi
  done
fi

if [ "$tor_found" -eq 1 ]; then
  printf '%s\n' 'Tor installation complete.'
  printf '%s\n' "Tor installed to: $tor_location"
  
  # Verify it actually works
  if "$tor_location" --version >/dev/null 2>&1; then
    printf '%s\n' "Tor version: $("$tor_location" --version | head -1)"
  fi
  
  # Try to start service if systemctl is available
  if command -v systemctl >/dev/null 2>&1; then
    unit_files=$(systemctl list-unit-files)
    if echo "$unit_files" | grep -q "^tor\.service"; then
      printf "Enable and start tor.service now? [Y/n]: "
      read -r reply
      reply=${reply:-y}
      case "$reply" in
        y|Y|yes|Yes)
          sudo systemctl enable --now tor || sudo systemctl start tor || true
          ;;
      esac
    fi
  fi
else
  printf '%s\n' 'Tor installation attempted, but tor binary not yet in PATH.'
  printf '%s\n' 'Expected location: /usr/local/bin/tor'
  printf '%s\n' ''
  printf '%s\n' 'Try one of the following:'
  printf '%s\n' '  1. Open a new terminal window'
  printf '%s\n' '  2. Run: hash -r'
  printf '%s\n' '  3. Check if /usr/local/bin is in your PATH'
fi
