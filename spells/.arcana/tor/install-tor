#!/bin/sh

# Install and configure Tor across supported platforms.

install_tor_usage() {
        cat <<'USAGE' >&2
Usage: install-tor

Guides you through installing Tor. On NixOS, this will update configuration.nix
when possible and run sudo nixos-rebuild all for you.
USAGE
}

install_tor() {
case "${1-}" in
--help|--usage|-h)
        install_tor_usage
        return 0
        ;;
esac

require-wizardry || return 1


set -eu
. env-clear

# Find script directory for sibling resources
SCRIPT_SOURCE=$0
case $SCRIPT_SOURCE in
*/*)
        SCRIPT_DIR=${SCRIPT_SOURCE%/*}
        ;;
*)
        resolved=$(command -v "$SCRIPT_SOURCE" 2>/dev/null || printf '%s' "$SCRIPT_SOURCE")
        SCRIPT_DIR=${resolved%/*}
        SCRIPT_SOURCE=$resolved
        ;;
esac
if [ -z "$SCRIPT_DIR" ] || [ "$SCRIPT_DIR" = "$SCRIPT_SOURCE" ]; then
        SCRIPT_DIR=.
fi
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd -P)
IMPS_TEXT_DIR=$(cd "$SCRIPT_DIR" 2>/dev/null && cd .. && cd .. && cd .imps/text && pwd -P)

# Welcome message
printf '%s\n' 'Welcome to the Tor installation wizard.'
distro="$(detect-distro 2>/dev/null || os)"
printf 'Detected platform: %s\n' "$distro"

# Platform-specific installation
case $distro in
  debian|ubuntu|linux)
    printf '%s\n' 'Installing tor via apt...'
    if command -v sudo >/dev/null 2>&1; then
      sudo apt-get update
      sudo apt-get install -y tor
    else
      apt-get update
      apt-get install -y tor
    fi
    ;;
  arch)
    printf '%s\n' 'Installing tor via pacman...'
    if command -v sudo >/dev/null 2>&1; then
      sudo pacman -Sy --noconfirm tor
    else
      pacman -Sy --noconfirm tor
    fi
    ;;
  mac|macos)
    printf '%s\n' 'Installing tor via Homebrew...'
    if ! command -v brew >/dev/null 2>&1; then
      printf '%s\n' 'Homebrew is required to install Tor on macOS.'
      return 1
    fi
    brew install tor
    ;;
  nixos)
    # Ask for configuration path
    printf "Path to NixOS configuration [/etc/nixos/configuration.nix]: "
    read -r config_path
    config_path=${config_path:-/etc/nixos/configuration.nix}
    
    changes=0
    if [ ! -f "$config_path" ]; then
      printf '%s\n' "NixOS configuration file $config_path was not found."
      return 1
    fi

    if command -v backup-nix-config >/dev/null 2>&1; then
      backup-nix-config "$config_path" >&2 || true
    fi

    # Detect indentation style from config file
    indent_l1="  "
    indent_l2="    "
    if [ -x "$IMPS_TEXT_DIR/make-indent" ]; then
      indent_l1=$("$IMPS_TEXT_DIR/make-indent" 1 "$config_path")
      indent_l2=$("$IMPS_TEXT_DIR/make-indent" 2 "$config_path")
    fi

    if grep -q 'environment.systemPackages' "$config_path"; then
      if ! grep -q 'tor' "$config_path"; then
        printf '%s\n' 'Adding tor to environment.systemPackages...'
        pattern1="(environment\\.systemPackages\\s*=\\s*with\\s+pkgs;\\s*\\[[^\\]]*)\\]"
        replace1="\$1\\n${indent_l2}tor\\n${indent_l1}]"
        sudo perl -0pi -e "s/$pattern1/$replace1/" "$config_path" || {
          pattern2="(environment\\.systemPackages\\s*=\\s*\\[[^\\]]*)\\]"
          replace2="\$1\\n${indent_l2}tor\\n${indent_l1}]"
          sudo perl -0pi -e "s/$pattern2/$replace2/" "$config_path"
        }
        changes=1
      fi
    fi

    if ! grep -q 'services.tor.enable' "$config_path"; then
      printf '%s\n' 'Enabling Tor service in configuration.nix...'
      sudo perl -0pi -e "s/(\\n\\})/\\n${indent_l1}services.tor.enable = true;\\n}/" "$config_path"
      changes=1
    fi

    if [ "$changes" -eq 1 ]; then
      printf '%s\n' 'Rebuilding NixOS to apply Tor installation...'
      sudo nixos-rebuild all
    else
      printf '%s\n' 'Tor already present in configuration.nix.'
    fi
    ;;
  *)
    printf '%s\n' "Unsupported distribution for automatic Tor installation."
    return 1
    ;;
esac

# Check if installation was successful
if command -v tor >/dev/null 2>&1; then
  printf '%s\n' 'Tor installation complete.'
  
  # Try to start service if systemctl is available
  if command -v systemctl >/dev/null 2>&1; then
    unit_files=$(systemctl list-unit-files)
    if echo "$unit_files" | grep -q "^tor\.service"; then
      printf "Enable and start tor.service now? [Y/n]: "
      read -r reply
      reply=${reply:-y}
      case "$reply" in
        y|Y|yes|Yes)
          sudo systemctl enable --now tor || sudo systemctl start tor || true
          ;;
      esac
    fi
  fi
else
  printf '%s\n' 'Tor installation attempted, but the tor binary is not yet available. Check logs.'
fi

}

# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*}}}/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*}}}/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
