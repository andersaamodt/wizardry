#!/bin/sh

# Install and configure Tor across supported platforms.

install_tor_usage() {
        cat <<'USAGE' >&2
Usage: install-tor

Guides you through installing Tor. On NixOS, this will update configuration.nix
when possible and run sudo nixos-rebuild all for you.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        install_tor_usage
        exit 0
        ;;
esac

set -eu

# Find script directory for sibling resources
script_source=$0
case $script_source in
*/*)
  script_dir=${script_source%/*}
        ;;
*)
        resolved=$(command -v "$script_source" 2>/dev/null || printf '%s' "$script_source")
  script_dir=${resolved%/*}
  script_source=$resolved
        ;;
esac
if [ -z "$script_dir" ] || [ "$script_dir" = "$script_source" ]; then
  script_dir=.
fi
script_dir=$(cd "$script_dir" && pwd -P)
imps_text_dir="$script_dir/../../.imps/text"

# Welcome message
printf '%s\n' 'Welcome to the Tor installation wizard.'
distro="$(detect-distro 2>/dev/null || os)"
printf 'Detected platform: %s\n' "$distro"

# Platform-specific installation
case $distro in
  debian|ubuntu|linux)
    printf '%s\n' 'Installing tor via apt...'
    if command -v sudo >/dev/null 2>&1; then
      sudo apt-get update
      sudo apt-get install -y tor
    else
      apt-get update
      apt-get install -y tor
    fi
    ;;
  arch)
    printf '%s\n' 'Installing tor via pacman...'
    if command -v sudo >/dev/null 2>&1; then
      sudo pacman -Sy --noconfirm tor
    else
      pacman -Sy --noconfirm tor
    fi
    ;;
  mac|macos)
    printf '%s\n' 'Installing tor via Homebrew...'
    if ! command -v brew >/dev/null 2>&1; then
      printf '%s\n' 'Homebrew is required to install Tor on macOS.'
      exit 1
    fi
    brew install tor
    ;;
  nixos)
    # Ask for configuration path
    printf "Path to NixOS configuration [/etc/nixos/configuration.nix]: "
    read -r config_path
    config_path=${config_path:-/etc/nixos/configuration.nix}
    
    changes=0
    if [ ! -f "$config_path" ]; then
      printf '%s\n' "NixOS configuration file $config_path was not found."
      exit 1
    fi

    if command -v backup-nix-config >/dev/null 2>&1; then
      backup-nix-config "$config_path" >&2 || true
    fi

    # Detect indentation style from config file
    indent_l1="  "
    indent_l2="    "
    if [ -x "$imps_text_dir/make-indent" ]; then
      indent_l1=$("$imps_text_dir/make-indent" 1 "$config_path")
      indent_l2=$("$imps_text_dir/make-indent" 2 "$config_path")
    fi

    if grep -q 'environment.systemPackages' "$config_path"; then
      if ! grep -q 'tor' "$config_path"; then
        printf '%s\n' 'Adding tor to environment.systemPackages...'
        pattern1="(environment\\.systemPackages\\s*=\\s*with\\s+pkgs;\\s*\\[[^\\]]*)\\]"
        replace1="\$1\\n${indent_l2}tor\\n${indent_l1}]"
        sudo perl -0pi -e "s/$pattern1/$replace1/" "$config_path" || {
          pattern2="(environment\\.systemPackages\\s*=\\s*\\[[^\\]]*)\\]"
          replace2="\$1\\n${indent_l2}tor\\n${indent_l1}]"
          sudo perl -0pi -e "s/$pattern2/$replace2/" "$config_path"
        }
        changes=1
      fi
    fi

    if ! grep -q 'services.tor.enable' "$config_path"; then
      printf '%s\n' 'Enabling Tor service in configuration.nix...'
      sudo perl -0pi -e "s/(\\n\\})/\\n${indent_l1}services.tor.enable = true;\\n}/" "$config_path"
      changes=1
    fi

    if [ "$changes" -eq 1 ]; then
      printf '%s\n' 'Rebuilding NixOS to apply Tor installation...'
      sudo nixos-rebuild all
    else
      printf '%s\n' 'Tor already present in configuration.nix.'
    fi
    ;;
  *)
    printf '%s\n' "Unsupported distribution for automatic Tor installation."
    exit 1
    ;;
esac

# Check if installation was successful
if command -v tor >/dev/null 2>&1; then
  printf '%s\n' 'Tor installation complete.'
  
  # Try to start service if systemctl is available
  if command -v systemctl >/dev/null 2>&1; then
    unit_files=$(systemctl list-unit-files)
    if echo "$unit_files" | grep -q "^tor\.service"; then
      printf "Enable and start tor.service now? [Y/n]: "
      read -r reply
      reply=${reply:-y}
      case "$reply" in
        y|Y|yes|Yes)
          sudo systemctl enable --now tor || sudo systemctl start tor || true
          ;;
      esac
    fi
  fi
else
  printf '%s\n' 'Tor installation attempted, but the tor binary is not yet available. Check logs.'
fi
