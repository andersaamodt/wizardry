#!/bin/sh

# Display the tor log file (last 120 lines)

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: show-tor-log

Displays the last 120 lines of the tor log file.
Shows logs from /usr/local/var/log/tor.log on macOS or systemd journal on Linux.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu

# Find and display the tor log
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  # macOS - check for tor log file
  log_file=""
  if [ -f /usr/local/var/log/tor.log ]; then
    log_file="/usr/local/var/log/tor.log"
  elif [ -f /opt/pkg/var/log/tor.log ]; then
    log_file="/opt/pkg/var/log/tor.log"
  elif [ -f /var/log/tor.log ]; then
    log_file="/var/log/tor.log"
  fi
  
  if [ -n "$log_file" ]; then
    if [ -r "$log_file" ]; then
      printf 'Showing last 120 lines of %s:\n\n' "$log_file"
      tail -n 120 "$log_file"
    else
      printf 'Log file exists but not readable: %s\n' "$log_file" >&2
      printf 'Try: sudo tail -n 120 %s\n' "$log_file"
      exit 1
    fi
  else
    printf 'Tor log file not found.\n' >&2
    printf 'Expected locations:\n' >&2
    printf '  /usr/local/var/log/tor.log\n' >&2
    printf '  /opt/pkg/var/log/tor.log\n' >&2
    printf '  /var/log/tor.log\n' >&2
    exit 1
  fi
else
  # Linux - try systemd journal first, then log file
  if command -v journalctl >/dev/null 2>&1; then
    printf 'Showing last 120 lines from systemd journal for tor:\n\n'
    sudo journalctl -u tor -n 120 --no-pager
  elif [ -f /var/log/tor/log ]; then
    if [ -r /var/log/tor/log ]; then
      printf 'Showing last 120 lines of /var/log/tor/log:\n\n'
      tail -n 120 /var/log/tor/log
    else
      printf 'Log file exists but not readable: /var/log/tor/log\n' >&2
      printf 'Try: sudo tail -n 120 /var/log/tor/log\n'
      exit 1
    fi
  else
    printf 'Tor log not found.\n' >&2
    printf 'Expected: systemd journal or /var/log/tor/log\n' >&2
    exit 1
  fi
fi
