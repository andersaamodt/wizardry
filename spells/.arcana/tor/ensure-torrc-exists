#!/bin/sh

# Ensure torrc configuration file exists with default content

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: ensure-torrc-exists

Creates a default torrc configuration file if one doesn't exist.
Uses torrc-path to determine the correct location for the platform.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu

# Get the torrc path (will return expected path even if file doesn't exist)
torrc_path=$(torrc-path)

# Check if torrc already exists
if [ -f "$torrc_path" ]; then
  # File exists, nothing to do
  exit 0
fi

# Create the torrc directory if it doesn't exist
torrc_dir=$(dirname "$torrc_path")
if [ ! -d "$torrc_dir" ]; then
  printf 'Creating directory: %s\n' "$torrc_dir"
  sudo mkdir -p "$torrc_dir"
fi

# Create log directory (needed for tor.log)
log_dir="/usr/local/var/log"
if [ ! -d "$log_dir" ]; then
  printf 'Creating log directory: %s\n' "$log_dir"
  if ! sudo mkdir -p "$log_dir" 2>/dev/null; then
    printf 'Error: Could not create log directory %s\n' "$log_dir" >&2
    printf 'This may be a permissions issue.\n' >&2
    printf 'Try running: repair-tor-permissions\n' >&2
    exit 1
  fi
fi

# Create data directory  
data_dir="/usr/local/var/lib/tor"
if [ ! -d "$data_dir" ]; then
  printf 'Creating data directory: %s\n' "$data_dir"
  if ! sudo mkdir -p "$data_dir" 2>/dev/null; then
    printf 'Error: Could not create data directory %s\n' "$data_dir" >&2
    printf 'This may be a permissions issue.\n' >&2
    printf 'Try running: repair-tor-permissions\n' >&2
    exit 1
  fi
fi

# Create a minimal default torrc
printf 'Creating default torrc at: %s\n' "$torrc_path"
sudo tee "$torrc_path" >/dev/null <<'EOF'
# Tor configuration file
# Auto-generated by wizardry

# Data directory
DataDirectory /usr/local/var/lib/tor

# SOCKS proxy port (default: 9050)
SocksPort 9050

# Note: Logging is handled by launchd (macOS) or systemd (Linux)
# Logs can be viewed with: show-tor-log

# Additional configuration can be added below
EOF

# Set proper permissions
sudo chmod 644 "$torrc_path"

# Create data and log directories if they don't exist
sudo mkdir -p /usr/local/var/lib/tor
sudo mkdir -p /usr/local/var/log
# Make log directory writable
sudo chmod 755 /usr/local/var/log

# On macOS, set ownership to _tor user if it exists
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  if dscl . -read /Users/_tor >/dev/null 2>&1; then
    sudo chown -R _tor:wheel /usr/local/var/lib/tor
    log_file="/usr/local/var/log/tor.log"
    err_log="/usr/local/var/log/tor-errors.log"
    # Create log files if they don't exist
    if [ ! -f "$log_file" ]; then
      sudo touch "$log_file"
    fi
    if [ ! -f "$err_log" ]; then
      sudo touch "$err_log"
    fi
    # Set ownership and permissions for log files
    sudo chown _tor:wheel "$log_file" "$err_log"
    sudo chmod 644 "$log_file" "$err_log"
  fi
fi

printf 'Default torrc created successfully.\n'
