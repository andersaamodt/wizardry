#!/bin/sh

# Present the Tor management menu.

tor_menu_usage() {
  cat <<'USAGE'
Usage: tor-menu

Displays the Tor management menu.
USAGE
}

tor_menu() {
case "${1-}" in
  --help|--usage|-h)
    tor_menu_usage
    return 0
    ;;
esac

require-wizardry || return 1


set -eu
. colors

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 0' INT TERM

build_service_entries() {
  service_status_option=""
  tor_service_option=""

  if is-service-installed tor > /dev/null; then
    service_status_option="View Tor Service Status%sudo systemctl status tor"
    if is-service-running tor > /dev/null; then
      tor_service_option="Stop Tor Service%sudo systemctl stop tor"
    else
      tor_service_option="Start Tor Service%sudo systemctl start tor"
    fi
  else
    script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
    service_status_option="Install Tor Service%install-service-template $script_dir/tor.service \"TORPATH=\$(command -v tor)\" \"TORRCPATH=/etc/tor/torrc\""
  fi
}

# Displays the menu
tor_menu_display_menu() {
  title="${BOLD}${CYAN}TOR: $(tor-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"

  cli_version="Tor Version%tor --version"
  cli_verify="Verify torrc%tor --verify-config"
  cli_fingerprint="Show Fingerprint%tor --list-fingerprint"
  cli_dump="Print Effective Config%tor --dump-config short"
  set_config="Configure Tor%configure-tor"
  repair_permissions="Repair Permissions%sudo repair-tor-permissions"
  tor_lightning="Tor Lightning (Install Wizard)%install-tor"

  if sudo tor-bridge-status; then
    bridge_option="Disable Bridge Mode%sudo configure-tor-bridge"
  else
    bridge_option="Enable Bridge Mode%sudo configure-tor-bridge"
  fi

  build_service_entries

  if is-installed tor > /dev/null; then
    uninstall_option="Uninstall Tor%uninstall-tor"
    menu "$title" \
      "$set_config" \
      "$tor_lightning" \
      "$repair_permissions" \
      "$bridge_option" \
      "$service_status_option" \
      "$tor_service_option" \
      "$cli_version" \
      "$cli_verify" \
      "$cli_fingerprint" \
      "$cli_dump" \
      "$uninstall_option" \
      "$exit_option" || true
  else
    install_tor_option="Install Tor (wizard)%install-tor"
    menu "$title" "$install_tor_option" "$exit_option" || true
  fi
}

first_run=1

# Main execution loop
while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  tor_menu_display_menu || true

done

}

# Load castable imp for direct execution
if true; then  # Always source castable, never use from PATH
  _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
  [ -f "$_i/castable" ] && . "$_i/castable"
fi

castable "$@"