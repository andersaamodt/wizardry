#!/bin/sh

# Present the Tor management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: . tor-menu    OR    tor menu    (via parse/gloss)

Displays the Tor management menu.

This spell must be sourced (not executed) to affect your current shell.
USAGE
  return 0 2>/dev/null || exit 0
  ;;
esac

require-wizardry || return 1 2>/dev/null || exit 1

# Uncastable pattern - detect if sourced
tor_menu_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) tor_menu_sourced=1 ;;
  esac
else
  tor_menu_base=${0##*/}
  case "$tor_menu_base" in
    sh|dash|bash|zsh|ksh|mksh) tor_menu_sourced=1 ;;
    tor-menu) tor_menu_sourced=0 ;;
    parse) tor_menu_sourced=1 ;;  # Sourced via parse
    *) tor_menu_sourced=1 ;;
  esac
fi

if [ "$tor_menu_sourced" -eq 0 ]; then
  printf '%s\n' "This spell must be sourced. Use:  . tor-menu  OR  tor menu" >&2
  return 1 2>/dev/null || exit 1
fi
unset tor_menu_sourced tor_menu_base

set +e  # Permissive mode since we're in user's shell
set -u
. env-clear
. colors

# Catch Ctrl-C and TERM signal to return cleanly
trap 'return 0' INT TERM

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Build menu
  title="${BOLD}${CYAN}Tor: $(tor-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  # Build service entries
  service_status_option=""
  tor_service_option=""
  
  if is-service-installed tor > /dev/null; then
    service_status_option="View Tor Service Status%sudo systemctl status tor"
    if is-service-running tor > /dev/null; then
      tor_service_option="Stop Tor Service%sudo systemctl stop tor"
    else
      tor_service_option="Start Tor Service%sudo systemctl start tor"
    fi
  else
    script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
    service_status_option="Install Tor Service%install-service-template $script_dir/tor.service \"TORPATH=\$(command -v tor)\" \"TORRCPATH=/etc/tor/torrc\""
  fi
  
  if command -v tor >/dev/null 2>&1; then
    config_option="Configure Tor%configure-tor"
    repair_option="Repair Permissions%repair-tor-permissions"
    uninstall_option="Uninstall Tor%uninstall-tor"
    
    if [ -n "$service_status_option" ] && [ -n "$tor_service_option" ]; then
      menu "$title" "$config_option" "$service_status_option" "$tor_service_option" "$repair_option" "$uninstall_option" "$exit_option" || true
    elif [ -n "$service_status_option" ]; then
      menu "$title" "$config_option" "$service_status_option" "$repair_option" "$uninstall_option" "$exit_option" || true
    else
      menu "$title" "$config_option" "$repair_option" "$uninstall_option" "$exit_option" || true
    fi
  else
    install_option="Install Tor%install-tor"
    menu "$title" "$install_option" "$exit_option" || true
  fi
done
