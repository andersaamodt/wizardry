#!/bin/sh

# Present the Tor management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: tor-menu

Displays the Tor management menu.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. colors

# Catch Ctrl-C and TERM signal to exit cleanly
# INT (Ctrl-C) should exit 130, TERM should exit 0
trap 'exit 130' INT
trap 'exit 0' TERM

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Build menu
  title="${BOLD}${CYAN}Tor: $(tor-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  # Build macOS dependency entries (only show on macOS)
  macos_deps=""
  if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
    # Check libevent status
    if is-libevent-installed; then
      libevent_option="[X] libevent%uninstall-libevent && exec \$0"
    else
      libevent_option="[ ] libevent%install-libevent && exec \$0"
    fi
    
    # Check openssl status
    if is-openssl-installed; then
      openssl_option="[X] openssl%uninstall-openssl && exec \$0"
    else
      openssl_option="[ ] openssl%install-openssl && exec \$0"
    fi
    
    macos_deps="$libevent_option
$openssl_option"
  fi
  
  # Build service entries
  service_status_option=""
  tor_service_option=""
  
  if is-service-installed tor > /dev/null; then
    service_status_option="View Tor Service Status%sudo systemctl status tor"
    if is-service-running tor > /dev/null; then
      tor_service_option="Stop Tor Service%sudo systemctl stop tor"
    else
      tor_service_option="Start Tor Service%sudo systemctl start tor"
    fi
  else
    script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
    service_status_option="Install Tor Service%install-service-template $script_dir/tor.service \"TORPATH=\$(command -v tor)\" \"TORRCPATH=/etc/tor/torrc\""
  fi
  
  if command -v tor >/dev/null 2>&1; then
    config_option="Configure Tor%configure-tor"
    repair_option="Repair Permissions%repair-tor-permissions"
    uninstall_option="Uninstall Tor%uninstall-tor"
    
    # Check for .onion address file to offer show option
    show_onion_option=""
    # Determine hostname file path based on platform
    case "$(uname -s 2>/dev/null)" in
    Darwin)
      hostname_file="/usr/local/var/lib/tor/mud/hostname"
      ;;
    *)
      hostname_file="/var/lib/tor/mud/hostname"
      ;;
    esac
    
    # Show onion address option if file exists
    if [ -f "$hostname_file" ]; then
      show_onion_option="Show .onion address%show-tor-onion-address"
    fi
    
    # Add start/restart/stop options based on tor status
    tor_control_option=""
    if is-tor-running; then
      restart_tor_option="Restart Tor%sudo killall tor 2>/dev/null; tor &"
      stop_tor_option="Stop Tor%sudo killall tor"
    else
      start_tor_option="Start Tor%tor &"
    fi
    
    # Build menu with macOS dependencies if present
    menu_options="$title"
    
    # Add show onion option if available
    if [ -n "$show_onion_option" ]; then
      menu_options="$menu_options
$show_onion_option"
    fi
    
    # Add tor control options
    if [ -n "${restart_tor_option-}" ]; then
      menu_options="$menu_options
$restart_tor_option"
    fi
    if [ -n "${stop_tor_option-}" ]; then
      menu_options="$menu_options
$stop_tor_option"
    fi
    if [ -n "${start_tor_option-}" ]; then
      menu_options="$menu_options
$start_tor_option"
    fi
    
    # Add config option
    menu_options="$menu_options
$config_option"
    
    # Add service options if present
    if [ -n "$service_status_option" ]; then
      menu_options="$menu_options
$service_status_option"
    fi
    if [ -n "$tor_service_option" ]; then
      menu_options="$menu_options
$tor_service_option"
    fi
    
    # Add repair and uninstall
    menu_options="$menu_options
$repair_option
$uninstall_option"
    
    # Add macOS dependencies if present
    if [ -n "$macos_deps" ]; then
      menu_options="$menu_options
$libevent_option
$openssl_option"
    fi
    
    # Add exit option
    menu_options="$menu_options
$exit_option"
    
    # Call menu with all options
    menu $menu_options || menu_status=$?
  else
    install_option="Install Tor%install-tor"
    # Show dependencies in menu even when Tor is not installed (macOS only)
    if [ -n "$macos_deps" ]; then
      menu "$title" "$install_option" "$libevent_option" "$openssl_option" \
        "$exit_option" || menu_status=$?
    else
      menu "$title" "$install_option" "$exit_option" || menu_status=$?
    fi
  fi
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
