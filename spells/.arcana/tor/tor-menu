#!/bin/sh

# Present the Tor management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: tor-menu

Displays the Tor management menu.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. colors

# Build the menu title with tor status
title="${BOLD}${CYAN}Tor: $(tor-status)${RESET}"

# Build menu options (simple list)
options=""

# Show .onion address option (if hidden service configured)
case "$(uname -s 2>/dev/null)" in
Darwin)
  hostname_file="/usr/local/var/lib/tor/mud/hostname"
  ;;
*)
  hostname_file="/var/lib/tor/mud/hostname"
  ;;
esac

if [ -f "$hostname_file" ]; then
  options="$options
Show .onion address%show-tor-onion-address"
fi

# Start/Restart/Stop options based on whether tor is running
if is-tor-running; then
  options="$options
Restart Tor%restart-tor
Stop Tor%stop-tor"
else
  options="$options
Start Tor%start-tor"
fi

# Configuration and management options (always available if tor installed)
if command -v tor >/dev/null 2>&1; then
  options="$options
Configure Tor%configure-tor
View Tor Service Status%tor-status
Repair Permissions%repair-tor-permissions
Uninstall Tor%uninstall-tor"
fi

# Dependency management (macOS only)
if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
  # libevent toggle
  if is-libevent-installed; then
    options="$options
[X] libevent%uninstall-libevent"
  else
    options="$options
[ ] libevent%install-libevent"
  fi
  
  # openssl toggle
  if is-openssl-installed; then
    options="$options
[X] openssl%uninstall-openssl"
  else
    options="$options
[ ] openssl%install-openssl"
  fi
fi

# Exit option
options="$options
$(exit-label)%kill -TERM \$\$"

# Call menu with our options
printf '%b' "$title"
printf '%b' "$options" | menu
