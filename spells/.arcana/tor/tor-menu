#!/bin/sh

# Present the Tor management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: tor-menu

Displays the Tor management menu.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. colors

# Catch Ctrl-C and TERM signal to exit cleanly
# INT (Ctrl-C) should exit 130, TERM should exit 0
trap 'exit 130' INT
trap 'exit 0' TERM

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Build menu
  title="${BOLD}${CYAN}Tor: $(tor-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  # Build macOS dependency entries (only show on macOS)
  macos_deps=""
  if [ "$(uname -s 2>/dev/null)" = "Darwin" ]; then
    # Check libevent status
    if is-libevent-installed; then
      libevent_option="[X] libevent%uninstall-libevent"
    else
      libevent_option="[ ] libevent%install-libevent"
    fi
    
    # Check openssl status
    if is-openssl-installed; then
      openssl_option="[X] openssl%uninstall-openssl"
    else
      openssl_option="[ ] openssl%install-openssl"
    fi
    
    macos_deps="$libevent_option
$openssl_option"
  fi
  
  # Build service entries
  service_status_option=""
  tor_service_option=""
  show_log_option=""
  
  # Show Start/Stop based on running status and daemon configuration
  if is-tor-installed; then
    # Only show "View tor service status" on Linux with systemd
    if command -v systemctl >/dev/null 2>&1; then
      service_status_option="View tor service status%sudo systemctl status tor"
    fi
    
    # Show "Stop tor" if tor is running (regardless of daemon status)
    # Show "Start tor" only if daemon is enabled and tor is not running
    if is-tor-running; then
      # Show log option as first menu item when tor is running
      show_log_option="Show tor log%show-tor-log"
      tor_service_option="Stop tor%stop-tor"
    elif is-tor-daemon-enabled; then
      tor_service_option="Start tor%start-tor"
    fi
  fi
  
  if is-tor-installed; then
    config_option="Configure tor%configure-tor"
    repair_option="Repair permissions%repair-tor-permissions"
    uninstall_option="Uninstall tor%uninstall-tor"
    
    # Check if daemon is enabled and create enable/disable option
    daemon_option=""
    if is-tor-daemon-enabled; then
      daemon_option="[X] Start tor at startup%disable-tor-daemon"
    else
      daemon_option="[ ] Start tor at startup%enable-tor-daemon"
    fi
    
    # Check for .onion address file to offer copy option
    # Only show if tor is installed and a hidden service is configured
    copy_onion_option=""
    hostname_file=""
    case "$(uname -s 2>/dev/null)" in
    Darwin)
      # Try multiple locations on macOS
      for hs_dir in /usr/local/var/lib/tor/hidden_service /usr/local/var/lib/tor/mud /opt/pkg/var/lib/tor/hidden_service; do
        if [ -f "$hs_dir/hostname" ]; then
          hostname_file="$hs_dir/hostname"
          break
        fi
      done
      ;;
    *)
      # Try multiple locations on Linux
      for hs_dir in /var/lib/tor/hidden_service /var/lib/tor/mud; do
        if [ -f "$hs_dir/hostname" ]; then
          hostname_file="$hs_dir/hostname"
          break
        fi
      done
      ;;
    esac
    
    if [ -n "$hostname_file" ]; then
      copy_onion_option="Copy .onion address%copy-to-clipboard \"\$(cat \"$hostname_file\")\""
    fi
    
    # Build menu with simplified logic
    # Menu order: show_log (if running), copy_onion, tor_service, daemon, config, repair, uninstall, deps, exit
    # We build the argument list by testing each option and adding it if present
    # Note: We can't use arrays in POSIX sh, so we use conditionals to build the call
    
    # Determine the menu options based on what's available
    
    if [ -n "$show_log_option" ]; then
      # Tor is running - show log option first
      if [ -n "$copy_onion_option" ]; then
        if [ -n "$macos_deps" ]; then
          menu "$title" "$show_log_option" "$copy_onion_option" "$tor_service_option" "$daemon_option" \
            "$config_option" "$repair_option" "$uninstall_option" \
            "$libevent_option" "$openssl_option" "$exit_option" || menu_status=$?
        else
          menu "$title" "$show_log_option" "$copy_onion_option" "$tor_service_option" "$daemon_option" \
            "$config_option" "$repair_option" "$uninstall_option" "$exit_option" || menu_status=$?
        fi
      else
        if [ -n "$macos_deps" ]; then
          menu "$title" "$show_log_option" "$tor_service_option" "$daemon_option" \
            "$config_option" "$repair_option" "$uninstall_option" \
            "$libevent_option" "$openssl_option" "$exit_option" || menu_status=$?
        else
          menu "$title" "$show_log_option" "$tor_service_option" "$daemon_option" \
            "$config_option" "$repair_option" "$uninstall_option" "$exit_option" || menu_status=$?
        fi
      fi
    elif [ -n "$copy_onion_option" ]; then
      if [ -n "$macos_deps" ]; then
        menu "$title" "$copy_onion_option" "$tor_service_option" "$daemon_option" \
          "$config_option" "$repair_option" "$uninstall_option" \
          "$libevent_option" "$openssl_option" "$exit_option" || menu_status=$?
      else
        menu "$title" "$copy_onion_option" "$tor_service_option" "$daemon_option" \
          "$config_option" "$repair_option" "$uninstall_option" "$exit_option" || menu_status=$?
      fi
    else
      if [ -n "$macos_deps" ]; then
        menu "$title" "$tor_service_option" "$daemon_option" \
          "$config_option" "$repair_option" "$uninstall_option" \
          "$libevent_option" "$openssl_option" "$exit_option" || menu_status=$?
      else
        menu "$title" "$tor_service_option" "$daemon_option" \
          "$config_option" "$repair_option" "$uninstall_option" "$exit_option" || menu_status=$?
      fi
    fi
  else
    install_option="Install tor%install-tor"
    # Show dependencies in menu even when Tor is not installed (macOS only)
    if [ -n "$macos_deps" ]; then
      menu "$title" "$install_option" "$libevent_option" "$openssl_option" \
        "$exit_option" || menu_status=$?
    else
      menu "$title" "$install_option" "$exit_option" || menu_status=$?
    fi
  fi
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
