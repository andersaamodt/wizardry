#!/bin/sh

# Remove Tor hidden service configuration

# Check for -y/--yes flag to skip confirmation
skip_confirm=0
case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: remove-tor-hidden-service [-y|--yes]

Remove Tor hidden service configuration from torrc.

Options:
  -y, --yes  Skip confirmation prompt
USAGE
  exit 0
  ;;
-y|--yes)
  skip_confirm=1
  ;;
esac

require-wizardry || exit 1

set -eu

if [ "$skip_confirm" -eq 0 ]; then
  printf '%s' "Do you want to remove the Tor hidden service? [y/n]: "
  IFS= read -r choice || exit 1
  
  case $choice in
  y|Y)
    # Continue with removal
    ;;
  *)
    printf '%s\n' "Tor hidden service removal cancelled."
    exit 0
    ;;
  esac
fi

# Proceed with removal
        # Get torrc path
        tor_config_path=$(torrc-path) || exit 1
        
        if [ ! -f "$tor_config_path" ]; then
                printf '%s\n' "Error: torrc file not found at $tor_config_path" >&2
                exit 1
        fi
        
        # Remove MUD HiddenService lines from torrc (not site-specific ones)
        # Only remove the /mud/ hidden service directory and its associated port
        temp_file=$(temp-file torrc-temp)
        if command -v sudo >/dev/null 2>&1; then
                # Use awk to remove only the mud hidden service block
                sudo awk '
                /^HiddenServiceDir.*\/mud\/?$/ { 
                    in_mud = 1
                    next
                }
                in_mud && /^HiddenServiceVersion/ {
                    next
                }
                in_mud && /^HiddenServicePort/ {
                    in_mud = 0
                    next
                }
                /^HiddenServiceDir/ {
                    in_mud = 0
                }
                { print }
                ' "$tor_config_path" > "$temp_file"
        else
                # Use awk to remove only the mud hidden service block
                awk '
                /^HiddenServiceDir.*\/mud\/?$/ { 
                    in_mud = 1
                    next
                }
                in_mud && /^HiddenServiceVersion/ {
                    next
                }
                in_mud && /^HiddenServicePort/ {
                    in_mud = 0
                    next
                }
                /^HiddenServiceDir/ {
                    in_mud = 0
                }
                { print }
                ' "$tor_config_path" > "$temp_file"
        fi
        
        # If temp file is empty, create a minimal valid torrc
        if [ ! -s "$temp_file" ]; then
                printf '%s\n' "# Tor configuration file" > "$temp_file"
                printf '%s\n' "# HiddenService configuration removed $(date -u +%Y-%m-%d)" >> "$temp_file"
        fi
        
        if command -v sudo >/dev/null 2>&1; then
                sudo mv "$temp_file" "$tor_config_path"
                # Ensure torrc remains readable after modification
                sudo chmod 644 "$tor_config_path"
        else
                mv "$temp_file" "$tor_config_path"
                chmod 644 "$tor_config_path"
        fi
        
        printf '%s\n' "Hidden service disabled for MUD"
        
        # Auto-restart tor when called with -y flag (from menu)
        # When called directly, offer choice for safety
        if [ "$skip_confirm" -eq 1 ]; then
                # Called from menu with -y, auto-restart
                restart-tor
        else
                printf '%s' "Restart tor service now? [y/n]: "
                IFS= read -r restart_choice || exit 0
                case $restart_choice in
                y|Y)
                        restart-tor
                        ;;
                *)
                        printf '%s\n' "Tor restart needed for changes to take effect."
                        ;;
                esac
        fi
