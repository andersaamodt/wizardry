#!/bin/sh

# Report installation and setup status for simplex-chat.

simplex_chat_status_usage() {
        cat <<'USAGE' >&2
Usage: simplex-chat-status

Reports whether simplex-chat is installed and ready to use, highlighting missing configuration or errors.
USAGE
}

simplex_chat_status() {
case "${1-}" in
--help|--usage|-h)
        simplex_chat_status_usage
        return 0
        ;;
esac

require-wizardry || return 1


set -eu
. env-clear

if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  RESET=""
  THEME_SUCCESS=""
  THEME_WARNING=""
  THEME_ERROR=""
  GREY=""
fi
# Older scripts expect GRAY, so mirror GREY when missing.
GRAY=${GREY-}

simplex_chat_status_color_for_status() {
  case "$1" in
    "installed")
      printf "%s" "$THEME_SUCCESS"
      ;;
    "installed, needs setup")
      printf "%s" "$THEME_WARNING"
      ;;
    "not installed")
      printf "%s" "$GRAY"
      ;;
    *)
      printf "%s" "$THEME_ERROR"
      ;;
  esac
}

simplex_chat_status_command_available() {
  command -v "$1" >/dev/null 2>&1
}

simplex_bin=${SIMPLEX_CHAT_BIN:-simplex-chat}
config_dir=${SIMPLEX_CHAT_CONFIG_DIR:-$HOME/.config/simplex-chat}
data_dir=${SIMPLEX_CHAT_DATA_DIR:-$HOME/.local/share/simplex-chat}

get_simplex_status() {
  if ! simplex_chat_status_command_available "$simplex_bin"; then
    status="not installed"
    printf "%s%s%s\n" "$(simplex_chat_status_color_for_status "$status")" "$status" "$RESET"
    return
  fi

  if ! "$simplex_bin" --version >/dev/null 2>&1; then
    status="installed, error"
    printf "%s%s%s\n" "$(simplex_chat_status_color_for_status "$status")" "$status" "$RESET"
    return
  fi

  status="installed"
  if [ ! -d "$config_dir" ] || [ ! -d "$data_dir" ]; then
    status="installed, needs setup"
  fi

  printf "%s%s%s\n" "$(simplex_chat_status_color_for_status "$status")" "$status" "$RESET"
}

get_simplex_status

}

# Load castable imp for direct execution
if true; then  # Always source castable, never use from PATH
  _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
  [ -f "$_i/castable" ] && . "$_i/castable"
fi

castable "$@"