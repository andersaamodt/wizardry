#!/bin/sh

# Present the Lightning management menu.

show_usage() {
  cat <<'USAGE'
Usage: lightning-menu

Displays the Lightning management menu.
USAGE
}

case "${1-}" in
  --help|--usage|-h)
    show_usage
    exit 0
    ;;
esac

set -eu
. colors

trap 'exit 0' INT TERM

# Main execution loop
first_run=1
while :; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi
  
  # Display menu (inlined from display_menu and helper functions)
  title="${BOLD}${CYAN}Lightning: $(lightning-status)"
  info_option="Lightning Info%lightning-cli getinfo"
  peers_option="List Peers%lightning-cli listpeers"
  funds_option="List Funds%lightning-cli listfunds"
  address_option="New On-chain Address%lightning-cli newaddr"
  wallet_menu_option="Lightning Wallet Menu%lightning-wallet-menu"
  
  # Build service status options (inlined from service_status_options and lightning_service_name)
  service_name=lightningd
  for candidate in "${LIGHTNING_SERVICE-}" lightningd clightningd c-lightning; do
    if [ -n "$candidate" ] && command -v "$candidate" >/dev/null 2>&1; then
      service_name=$candidate
      break
    fi
    if [ -n "$candidate" ] && is-service-installed "$candidate" >/dev/null 2>&1; then
      service_name=$candidate
      break
    fi
  done
  
  service_status_option="Service Status%sudo systemctl status $service_name"
  if is-service-running "$service_name" >/dev/null 2>&1; then
    toggle_service_option="Stop Lightning%sudo systemctl stop $service_name"
  else
    toggle_service_option="Start Lightning%sudo systemctl start $service_name"
  fi
  
  install_option="Install Lightning%install-lightning"
  uninstall_option="Uninstall Lightning%uninstall-lightning"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"

  # Check if lightning is installed (inlined from is_lightning_installed and command_available)
  lightning_installed=0
  if command -v lightning-cli >/dev/null 2>&1 || command -v lightningd >/dev/null 2>&1; then
    lightning_installed=1
  fi

  if [ "$lightning_installed" -eq 1 ]; then
    menu "$title" \
      "$info_option" \
      "$peers_option" \
      "$funds_option" \
      "$address_option" \
      "$wallet_menu_option" \
      "$service_status_option" \
      "$toggle_service_option" \
      "$uninstall_option" \
      "$exit_option" || true
  else
    menu "$title" "$install_option" "$exit_option" || true
  fi
  
  # Loop continues so status updates are shown
done
