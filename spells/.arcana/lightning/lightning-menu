#!/bin/sh

# Present the Lightning management menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: lightning-menu

Displays the Lightning management menu.
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear
. colors

# Catch Ctrl-C and TERM signal to exit cleanly
# INT (Ctrl-C) should exit 130, TERM should exit 0
trap 'exit 130' INT
trap 'exit 0' TERM

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    printf '\n'
  else
    first_run=0
  fi

  # Build menu based on Lightning installation status
  title="${BOLD}${CYAN}Lightning: $(lightning-status)"
  exit_label=$(exit-label)
  exit_option="${exit_label}%kill -TERM \$PPID"
  
  if command -v lightning-cli >/dev/null 2>&1; then
    # Lightning is installed - show management options
    wallet_option="Wallet Menu%lightning-wallet-menu"
    info_option="Show Info%lightning-cli getinfo"
    configure_option="Configure Lightning%configure-lightning"
    uninstall_option="Uninstall Lightning%uninstall-lightning"
    
    # Check for service management
    service_status_option=""
    lightning_service_option=""
    
    if is-service-installed lightningd > /dev/null 2>&1; then
      service_status_option="View Lightning Service Status%sudo systemctl status lightningd"
      if is-service-running lightningd > /dev/null 2>&1; then
        lightning_service_option="Stop Lightning Service%sudo systemctl stop lightningd"
      else
        lightning_service_option="Start Lightning Service%sudo systemctl start lightningd"
      fi
    else
      script_dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
      service_status_option="Install Lightning Service%install-service-template $script_dir/lightning.service \"LIGHTNINGD=\$(command -v lightningd)\" \"USER=\$USER\""
    fi
    
    # Build menu with available options
    if [ -n "$service_status_option" ] && [ -n "$lightning_service_option" ]; then
      menu "$title" "$wallet_option" "$info_option" "$configure_option" \
        "$service_status_option" "$lightning_service_option" \
        "$uninstall_option" "$exit_option" || menu_status=$?
    elif [ -n "$service_status_option" ]; then
      menu "$title" "$wallet_option" "$info_option" "$configure_option" \
        "$service_status_option" "$uninstall_option" "$exit_option" || menu_status=$?
    else
      menu "$title" "$wallet_option" "$info_option" "$configure_option" \
        "$uninstall_option" "$exit_option" || menu_status=$?
    fi
  else
    # Lightning not installed - show install option
    install_option="Install Lightning%install-lightning"
    menu "$title" "$install_option" "$exit_option" || menu_status=$?
  fi
  menu_status=${menu_status:-0}
  
  # ESC causes menu to exit with 130 - handle gracefully by exiting
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    exit 0
  fi
done
