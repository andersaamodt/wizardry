#!/bin/sh

# Install and configure Bitcoin Lightning (Core Lightning) across supported platforms.

show_usage() {
        cat <<'USAGE' >&2
Usage: install-lightning

Guides you through installing Bitcoin Lightning (Core Lightning). On NixOS, this will add
clightning to environment.systemPackages when possible and run sudo nixos-rebuild all.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

# Main installation wizard - inlined all helper functions for linear flow
printf '%s\n' 'Welcome to the Lightning installation wizard.'
distro="$(detect-distro 2>/dev/null || os)"
printf 'Detected platform: %s\n' "$distro"

case $distro in
  debian|ubuntu|linux)
    printf '%s\n' 'Installing lightningd via apt...'
    if command -v sudo >/dev/null 2>&1; then
      sudo apt-get update
      sudo apt-get install -y lightningd
    else
      apt-get update
      apt-get install -y lightningd
    fi
    ;;
  arch)
    printf '%s\n' 'Installing lightningd via pacman...'
    if command -v sudo >/dev/null 2>&1; then
      sudo pacman -Sy --noconfirm lightningd
    else
      pacman -Sy --noconfirm lightningd
    fi
    ;;
  mac|macos)
    printf '%s\n' 'Installing lightning using Homebrew (package name: lightningd or core-lightning)...'
    if ! command -v brew >/dev/null 2>&1; then
      printf '%s\n' 'Homebrew is required to install Lightning on macOS.'
      exit 1
    fi
    if brew info lightningd >/dev/null 2>&1; then
      brew install lightningd
    elif brew info core-lightning >/dev/null 2>&1; then
      brew install core-lightning
    else
      printf '%s\n' 'Lightning package not found in Homebrew.'
      exit 1
    fi
    ;;
  nixos)
    # Inline ask logic for NixOS config path
    printf "Path to NixOS configuration [/etc/nixos/configuration.nix]: "
    read -r config_path
    if [ -z "$config_path" ]; then
      config_path="/etc/nixos/configuration.nix"
    fi
    
    # Inline add_lightning_to_nixos logic
    if [ ! -f "$config_path" ]; then
      printf '%s\n' "NixOS configuration file $config_path was not found."
      exit 1
    fi

    if command -v backup-nix-config >/dev/null 2>&1; then
      backup-nix-config "$config_path" >&2 || true
    fi

    if grep -q 'clightning' "$config_path"; then
      printf '%s\n' 'clightning already present in configuration.nix.'
    else
      printf '%s\n' 'Adding clightning to environment.systemPackages (with pkgs; [ clightning ])...'
      if grep -q 'environment.systemPackages' "$config_path"; then
        sudo perl -0pi -e 's/(environment\.systemPackages\s*=\s*with\s+pkgs;\s*\[[^]]*)\]/$1\n  clightning\n]/' "$config_path" \
          || sudo perl -0pi -e 's/(environment\.systemPackages\s*=\s*\[[^]]*)\]/$1\n  clightning\n]/' "$config_path"
      else
        sudo tee -a "$config_path" <<'NIX' >/dev/null

# Added by wizardry install-lightning
{ environment.systemPackages = with pkgs; [ clightning ]; }
NIX
      fi
    fi

    printf '%s\n' 'Rebuilding NixOS to apply Lightning installation...'
    sudo nixos-rebuild all
    ;;
  *)
    printf '%s\n' "Unsupported distribution for automatic install."
    exit 1
    ;;
esac

if command -v lightning-cli >/dev/null 2>&1; then
  printf '%s\n' 'Lightning installation complete.'
else
  printf '%s\n' 'Lightning installation attempted, but lightning-cli is not yet available. Check logs.'
fi
