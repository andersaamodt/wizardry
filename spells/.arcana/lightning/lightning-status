#!/bin/sh

# Report the installation and runtime status of Bitcoin Lightning.

show_usage() {
        cat <<'USAGE' >&2
Usage: lightning-status

Reports whether Bitcoin Lightning (lightningd/lightning-cli) is installed and running.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  RESET=""
  THEME_SUCCESS=""
  THEME_WARNING=""
  THEME_ERROR=""
  GREY=""
fi
# Older scripts expect GRAY, so mirror GREY when missing.
GRAY=${GREY-}

color_for_status() {
  case "$1" in
    "installed, running")
      printf "%s" "$THEME_SUCCESS"
      ;;
    "installed, not running")
      printf "%s" "$THEME_WARNING"
      ;;
    "installed, needs setup"|"installed, error")
      printf "%s" "$THEME_ERROR"
      ;;
    *)
      printf "%s" "$GRAY"
      ;;
  esac
}

command_available() {
  command -v "$1" >/dev/null 2>&1
}

lightning_service_name() {
  if [ -n "${LIGHTNING_SERVICE-}" ]; then
    printf '%s' "$LIGHTNING_SERVICE"
    return
  fi
  # Default to lightningd; fallback to clightningd or similar names if present.
  for candidate in lightningd clightningd c-lightning; do
    if command_available "$candidate"; then
      printf '%s' "$candidate"
      return
    fi
    if is-service-installed "$candidate" >/dev/null 2>&1; then
      printf '%s' "$candidate"
      return
    fi
  done
  printf '%s' lightningd
}

get_lightning_status() {
  service_name=$(lightning_service_name)

  if command_available lightning-cli || command_available "$service_name"; then
    if is-service-running "$service_name" >/dev/null 2>&1; then
      if lightning-cli getinfo >/dev/null 2>&1; then
        status="installed, running"
      else
        status="installed, needs setup"
      fi
    else
      status="installed, not running"
    fi
  else
    status="not installed"
  fi

  printf "%s%s%s\n" "$(color_for_status "$status")" "$status" "$RESET"
}

get_lightning_status
