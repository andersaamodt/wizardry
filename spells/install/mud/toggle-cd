#!/bin/sh

# Toggle cd hook on/off by installing or uninstalling the cd spell

show_usage() {
        cat <<'USAGE'
Usage: toggle-cd

Toggle the cd hook on or off. When enabled, every directory change
automatically runs 'look' to display the room description.

The toggle detects the current state and flips it:
  - If the hook is installed, it will be uninstalled
  - If the hook is not installed, it will be installed

After toggling, restart your shell or source your rc file to apply changes.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
CD_SPELL="$SCRIPT_DIR/cd"

if [ ! -x "$CD_SPELL" ]; then
        printf '%s\n' "Error: cd spell not found at '$CD_SPELL'." >&2
        exit 1
fi

# Check if cd is currently installed
uninstall_output=$(WIZARDRY_CD_CANTRIP="$CD_SPELL" "$CD_SPELL" uninstall 2>&1) || true

if printf '%s\n' "$uninstall_output" | grep -q "not installed\|no rc file found"; then
        # Not installed, so install it
        printf '%s\n' "Installing cd hook..."
        if WIZARDRY_CD_CANTRIP="$CD_SPELL" "$CD_SPELL" install; then
                printf '%s\n' "✓ CD hook enabled. Each directory change will now display the room description."
                printf '%s\n' "  (Restart your shell or source your rc file to activate)"
        else
                printf '%s\n' "✗ Failed to install cd hook." >&2
                exit 1
        fi
else
        # Was already installed and just uninstalled
        printf '%s\n' "$uninstall_output"
        printf '%s\n' "✓ CD hook disabled."
        printf '%s\n' "  (Restart your shell or source your rc file to deactivate)"
fi
