#!/bin/sh

# Toggle cd narration on/off by installing or uninstalling the cd hook

set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
CD_NARRATION="$SCRIPT_DIR/cd-narration"

if [ ! -x "$CD_NARRATION" ]; then
        printf '%s\n' "Error: cd-narration script not found at '$CD_NARRATION'." >&2
        exit 1
fi

# Check if cd narration is currently installed
uninstall_output=$(WIZARDRY_CD_CANTRIP="$CD_NARRATION" "$CD_NARRATION" uninstall 2>&1) || true

if printf '%s\n' "$uninstall_output" | grep -q "not installed\|no rc file found"; then
        # Not installed, so install it
        printf '%s\n' "Installing cd narration..."
        if WIZARDRY_CD_CANTRIP="$CD_NARRATION" "$CD_NARRATION" install; then
                printf '%s\n' "✓ CD narration enabled. Each directory change will now display the room description."
                printf '%s\n' "  (Restart your shell or source your rc file to activate)"
        else
                printf '%s\n' "✗ Failed to install cd narration." >&2
                exit 1
        fi
else
        # Was already installed and just uninstalled
        printf '%s\n' "$uninstall_output"
        printf '%s\n' "✓ CD narration disabled."
        printf '%s\n' "  (Restart your shell or source your rc file to deactivate)"
fi
