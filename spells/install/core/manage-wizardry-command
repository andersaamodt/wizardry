#!/usr/bin/env sh

# Create or remove lightweight shims for wizardry-provided commands.
# Usage: manage-wizardry-command [--uninstall] <command> <relative-path-from-root>

set -eu

action=install
if [ "${1-}" = "--uninstall" ]; then
  action=uninstall
  shift
fi

if [ "$#" -lt 2 ]; then
  printf '%s\n' "Usage: manage-wizardry-command [--uninstall] <command> <relative-path-from-root>" >&2
  exit 1
fi

command_name=$1
command_path=$2

root_dir=$(CDPATH= cd -- "$(dirname "$0")/../../.." && pwd -P)
install_dir=${WIZARDRY_BIN_DIR:-$HOME/.local/bin}
source_path="$root_dir/$command_path"

if [ ! -e "$source_path" ]; then
  printf '%s\n' "manage-wizardry-command: '$source_path' does not exist." >&2
  exit 1
fi

if [ "$action" = "install" ]; then
  if command -v "$command_name" >/dev/null 2>&1; then
    printf '%s\n' "${command_name} is already available."
    exit 0
  fi

  mkdir -p "$install_dir"
  ln -sf "$source_path" "$install_dir/$command_name"
  printf '%s\n' "Installed $command_name to $install_dir."
  exit 0
fi

shim_path="$install_dir/$command_name"
if [ -L "$shim_path" ] || [ -f "$shim_path" ]; then
  rm -f "$shim_path"
  printf '%s\n' "Removed $command_name shim from $install_dir."
  exit 0
fi

printf '%s\n' "${command_name} is not managed by wizardry shims." >&2
exit 0
