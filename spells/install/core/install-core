#!/usr/bin/env sh

# This spell installs the core wizardry dependencies required for spell execution.

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)

detect_platform() {
  if command -v uname >/dev/null 2>&1; then
    uname -s 2>/dev/null || printf '%s' "unknown"
  else
    printf '%s' "unknown"
  fi
}

core_dependencies() {
  # Format: label:command_name:install_spell:uninstall_spell:essential
  # essential=1 means the command is critical for shell/wizardry operation
  # and should not be uninstalled
  platform=$(detect_platform)
  case $platform in
    Darwin)
      # macOS has pbcopy built-in, so no clipboard utilities needed
      cat <<'EOF'
Git:git:install-git:uninstall-git:0
dd:dd:install-dd:uninstall-dd:1
stty:stty:install-stty:uninstall-stty:1
tput:tput:install-tput:uninstall-tput:1
EOF
      ;;
    *)
      # Linux needs clipboard utilities (xsel preferred, xclip as fallback)
      # wl-clipboard is for Wayland environments
      cat <<'EOF'
Git:git:install-git:uninstall-git:0
xsel (clipboard):xsel:install-xsel:uninstall-xsel:0
xclip (clipboard):xclip:install-xclip:uninstall-xclip:0
wl-clipboard (Wayland):wl-copy:install-wl-clipboard:uninstall-wl-clipboard:0
Bubblewrap:bwrap:install-bwrap:uninstall-bwrap:0
dd:dd:install-dd:uninstall-dd:1
stty:stty:install-stty:uninstall-stty:1
tput:tput:install-tput:uninstall-tput:1
EOF
      ;;
  esac
}

resolve_spell() {
  spell_name=$1
  if command -v "$spell_name" >/dev/null 2>&1; then
    printf '%s\n' "$spell_name"
    return 0
  fi

  if [ -x "$script_dir/$spell_name" ]; then
    printf '%s\n' "$script_dir/$spell_name"
    return 0
  fi

  printf '%s\n' "install-core: missing helper '$spell_name'" >&2
  return 1
}

install_core() {
  # Try to install each core dependency, but don't fail if optional packages
  # can't be installed (e.g., on NixOS where packages must be installed declaratively).
  # We silently skip failures to avoid confusing novice users during first-time install.
  core_dependencies | while IFS=: read -r label command_name install_spell _ _; do
    if command -v "$command_name" >/dev/null 2>&1; then
      continue
    fi

    spell=$(resolve_spell "$install_spell" 2>/dev/null) || continue
    # Run installation silently - failures are expected on some platforms
    ASSUME_YES=1 "$spell" >/dev/null 2>&1 || true
  done
  # Always return success - optional package installation failures are non-fatal
  return 0
}

if [ "${0##*/}" = "install-core" ]; then
  set -eu
  install_core "$@"
fi
