#!/usr/bin/env sh

# Install and manage the core prerequisites for wizardry.

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
# shellcheck source=/dev/null
. "$script_dir/install-core"

colors_bin=$(command -v colors 2>/dev/null) || {
  echo "missing dependency: colors" >&2
  exit 1
}
. "$colors_bin"

menu_bin=$(command -v menu 2>/dev/null) || {
  echo "missing dependency: menu" >&2
  exit 1
}

loop_limit=${MENU_LOOP_LIMIT:-}

if [ -n "$loop_limit" ] && ! printf '%s' "$loop_limit" | grep -Eq '^[0-9]+$'; then
  echo "invalid MENU_LOOP_LIMIT: must be numeric" >&2
  exit 1
fi

handle_ctrl_c() {
  trap 'echo exiting; exit' INT
}

handle_ctrl_c

title="${BOLD}${CYAN}Core prerequisites"
exit_entry="Exit%kill -2 $$"

resolve_spell() {
  spell_name=$1

  if command -v "$spell_name" >/dev/null 2>&1; then
    printf '%s\n' "$spell_name"
    return 0
  fi

  if [ -x "$script_dir/$spell_name" ]; then
    printf '%s\n' "$script_dir/$spell_name"
    return 0
  fi

  printf '%s\n' "core-menu: missing helper '$spell_name'" >&2
  return 1
}

while true; do
  set --

  while IFS=: read -r label command_name install_spell uninstall_spell; do
    if command -v "$command_name" >/dev/null 2>&1; then
      entry_label="Uninstall $label"
      spell=$(resolve_spell "$uninstall_spell") || exit 1
    else
      entry_label="Install $label"
      spell=$(resolve_spell "$install_spell") || exit 1
    fi

    set -- "$@" "${entry_label}%$spell"
  done <<EOF
$(core_dependencies)
EOF

  set -- "$@" "Install all%$script_dir/install-core" "$exit_entry"

  if ! "$menu_bin" "$title" "$@"; then
    status=$?
    echo "menu failed with status $status" >&2
    exit "$status"
  fi

  if [ -n "$loop_limit" ]; then
    if [ "$loop_limit" -le 1 ] 2>/dev/null; then
      break
    fi
    loop_limit=$((loop_limit - 1))
  fi

done
