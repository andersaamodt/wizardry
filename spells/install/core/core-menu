#!/usr/bin/env sh

# Install and manage the core prerequisites for wizardry.

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
root_dir=$(CDPATH= cd -- "$script_dir/../../.." && pwd -P)

require_cmd=${REQUIRE_COMMAND:-}
if [ -z "$require_cmd" ]; then
  if command -v require-command >/dev/null 2>&1; then
    require_cmd=$(command -v require-command)
  elif [ -x "$root_dir/spells/cantrips/require-command" ]; then
    require_cmd="$root_dir/spells/cantrips/require-command"
  else
    echo "core-menu: missing dependency: require-command" >&2
    exit 1
  fi
fi

colors_bin=$(command -v colors 2>/dev/null)
if [ -z "$colors_bin" ] && [ -x "$root_dir/spells/cantrips/colors" ]; then
  colors_bin="$root_dir/spells/cantrips/colors"
fi
if [ -z "$colors_bin" ]; then
  echo "core-menu: missing dependency: colors" >&2
  exit 1
fi

menu_bin=$(command -v menu 2>/dev/null)
if [ -z "$menu_bin" ] && [ -x "$root_dir/spells/cantrips/menu" ]; then
  menu_bin="$root_dir/spells/cantrips/menu"
fi
if [ -z "$menu_bin" ]; then
  echo "core-menu: missing dependency: menu" >&2
  exit 1
fi

export REQUIRE_COMMAND="$require_cmd"
export REQUIRE_COMMAND_ASSUME_YES=1

# shellcheck source=/dev/null
. "$script_dir/install-core"

# shellcheck source=/dev/null
. "$colors_bin"

loop_limit=${MENU_LOOP_LIMIT:-}

if [ -n "$loop_limit" ] && ! printf '%s' "$loop_limit" | grep -Eq '^[0-9]+$'; then
  echo "invalid MENU_LOOP_LIMIT: must be numeric" >&2
  exit 1
fi

handle_ctrl_c() {
  trap 'echo exiting; exit' INT
}

handle_ctrl_c

title="${BOLD}${CYAN}Core prerequisites"
exit_entry="Exit%kill -2 $$"

bootstrap_menu_deps() {
  for dep in fathom-terminal fathom-cursor move-cursor await-keypress cursor-blink stty; do
    if command -v "$dep" >/dev/null 2>&1; then
      continue
    fi

    if ! "$require_cmd" "$dep" "core-menu: installing '$dep' for menu support."; then
      echo "core-menu: failed to prepare $dep" >&2
      exit 1
    fi
  done
}

bootstrap_menu_deps

resolve_spell() {
  spell_name=$1

  if command -v "$spell_name" >/dev/null 2>&1; then
    printf '%s\n' "$spell_name"
    return 0
  fi

  if [ -x "$script_dir/$spell_name" ]; then
    printf '%s\n' "$script_dir/$spell_name"
    return 0
  fi

  printf '%s\n' "core-menu: missing helper '$spell_name'" >&2
  return 1
}

while true; do
  set --

  while IFS=: read -r label command_name install_spell uninstall_spell; do
    installed=0
    if command -v "$command_name" >/dev/null 2>&1; then
      installed=1
      entry_label="Uninstall $label"
      spell=$(resolve_spell "$uninstall_spell") || exit 1
    else
      entry_label="Install $label"
      spell=$(resolve_spell "$install_spell") || exit 1
    fi

    display_label=$entry_label
    if [ "$installed" -eq 1 ]; then
      display_label="$entry_label (installed; select to uninstall â€” Install $label to reinstall)"
    fi

    set -- "$@" "${display_label}%$spell"
  done <<EOF
$(core_dependencies)
EOF

  set -- "$@" "Install all%$script_dir/install-core" "$exit_entry"

  if ! "$menu_bin" "$title" "$@"; then
    status=$?
    echo "menu failed with status $status" >&2
    exit "$status"
  fi

  if [ -n "$loop_limit" ]; then
    if [ "$loop_limit" -le 1 ] 2>/dev/null; then
      break
    fi
    loop_limit=$((loop_limit - 1))
  fi

done
