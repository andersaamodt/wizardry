#!/usr/bin/env sh

set -eu

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
# shellcheck source=/dev/null
. "$script_dir/dependencies"

resolve_spell() {
  spell_name=$1
  if command -v "$spell_name" >/dev/null 2>&1; then
    printf '%s\n' "$spell_name"
    return 0
  fi

  if [ -x "$script_dir/$spell_name" ]; then
    printf '%s\n' "$script_dir/$spell_name"
    return 0
  fi

  printf '%s\n' "install-core-all: missing helper '$spell_name'" >&2
  return 1
}

core_dependencies | while IFS=: read -r label command_name install_spell uninstall_spell; do
  if command -v "$command_name" >/dev/null 2>&1; then
    continue
  fi

  spell=$(resolve_spell "$install_spell") || exit 1
  if ! ASSUME_YES=1 "$spell"; then
    printf '%s\n' "install-core-all: failed to install $label" >&2
    exit 1
  fi

done
