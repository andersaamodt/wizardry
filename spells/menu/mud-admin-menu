#!/bin/sh

# This spell displays the menu for adminning hosting a MUD server.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE' >&2
Usage: . mud-admin-menu    OR    mud admin menu    (via parse/gloss)

Opens the MUD admin menu so you can manage authorized players, review shared rooms, and oversee your hosted server.

This spell must be sourced (not executed) to affect your current shell.
USAGE
  return 0 2>/dev/null || exit 0
  ;;
esac

# Uncastable pattern - detect if sourced
mud_admin_menu_sourced=0
if eval '[ -n "${ZSH_VERSION+x}" ]' 2>/dev/null; then
  case "${ZSH_EVAL_CONTEXT-}" in
    *:file) mud_admin_menu_sourced=1 ;;
  esac
else
  mud_admin_menu_base=${0##*/}
  case "$mud_admin_menu_base" in
    sh|dash|bash|zsh|ksh|mksh) mud_admin_menu_sourced=1 ;;
    mud-admin-menu) mud_admin_menu_sourced=0 ;;
    parse) mud_admin_menu_sourced=1 ;;  # Sourced via parse
    *) mud_admin_menu_sourced=1 ;;
  esac
fi

if [ "$mud_admin_menu_sourced" -eq 0 ]; then
  printf '%s\n' "This spell must be sourced. Use:  . mud-admin-menu  OR  mud admin menu" >&2
  return 1 2>/dev/null || exit 1
fi
unset mud_admin_menu_sourced mud_admin_menu_base

set +e  # Permissive mode since we're in user's shell
set -u
. env-clear

# Catch Ctrl-C and TERM signal to return cleanly
trap 'return 0' INT TERM

# Load color palette (colors handles terminal capability detection internally)
# shellcheck source=/dev/null
. "$(command -v colors)"

if ! require menu "The MUD Admin menu needs the 'menu' command to present options."; then
  return 1
fi

mud_admin_menu_display_menu() {
  add="Add authorized player%add-player"
  list_players="List authorized players%new-player"
  list_rooms="List shared rooms%list-rooms"
  exit_label=$(exit-label)
  # Exit button kills this menu script via TERM signal
  # Menu (child process) evals: kill -TERM $PPID → kills its parent (this script)
  exit_item="${exit_label}%kill -TERM \$PPID"

  set -- "$add" "$list_players" "$list_rooms" "$exit_item"
  menu "MUD Admin:" "$@"
}

loop_limit=${MENU_LOOP_LIMIT:-}
first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    :
  else
    first_run=0
  fi

  mud_admin_menu_display_menu || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC kills this menu script via TERM signal (same as Exit button)
  # Direct kill: kill -TERM $$ → kills this script
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    kill -TERM $$ 2>/dev/null || true
    return 0
  fi

  # Support MENU_LOOP_LIMIT for testing
  if [ -n "$loop_limit" ]; then
    loop_limit=$((loop_limit - 1))
    if [ "$loop_limit" -le 0 ]; then
      break
    fi
  fi
done
