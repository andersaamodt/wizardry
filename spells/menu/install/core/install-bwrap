#!/usr/bin/env sh

# Install the bubblewrap sandboxing utility across common platforms.
# This helper ensures tests and spells can isolate side effects safely.

set -eu

usage() {
        cat <<'USAGE'
Usage: install-bwrap

Install the bubblewrap (bwrap) command using the system package manager when
it is not already available. Supports common Linux distributions and macOS.
USAGE
}

case "${1-}" in
-h|--help|--usage)
        usage
        exit 0
        ;;
-*)
        printf '%s\n' "install-bwrap: unknown option '$1'" >&2
        usage
        exit 1
        ;;
esac

if [ "${INSTALL_BWRAP_FORCE_INSTALL-}" != "1" ] && command -v bwrap >/dev/null 2>&1; then
        printf '%s\n' "bubblewrap is already installed."
        exit 0
fi

run_installer() {
        cmd=$1
        shift
        if command -v sudo >/dev/null 2>&1; then
                sudo "$cmd" "$@"
        else
                "$cmd" "$@"
        fi
}

try_install() {
        installer=$1
        shift
        if ! command -v "$installer" >/dev/null 2>&1; then
                return 1
        fi
        run_installer "$installer" "$@"
}

# Prefer non-interactive installs when possible to keep automation smooth.
if try_install apt-get -y update && try_install apt-get -y install bubblewrap; then
        exit 0
fi

if try_install dnf -y install bubblewrap; then
        exit 0
fi

if try_install yum -y install bubblewrap; then
        exit 0
fi

if try_install zypper --non-interactive install bubblewrap; then
        exit 0
fi

if try_install pacman --noconfirm -Sy bubblewrap; then
        exit 0
fi

if try_install apk add --no-cache bubblewrap; then
        exit 0
fi

if try_install brew install bubblewrap; then
        exit 0
fi

printf '%s\n' "install-bwrap: unable to install bubblewrap automatically. Please install it manually." >&2
exit 1
