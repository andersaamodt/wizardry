#!/bin/sh
# This spell displays a management menu for a specific synonym.

show_usage() {
  cat <<'USAGE'
Usage: synonym-menu WORD

Display a management menu for a specific synonym with options to
edit the word, edit the target spell, or delete the synonym.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  show_usage
  exit 0
  ;;
esac

require-wizardry || exit 1

set -eu
. env-clear

# Catch Ctrl-C and TERM signal to return cleanly
trap 'exit 0' INT TERM

if [ "$#" -lt 1 ]; then
  printf '%s\n' "synonym-menu: requires WORD argument" >&2
  exit 2
fi

synonym_word=$1

if ! require menu "The synonym menu needs the 'menu' command."; then
  exit 1
fi

spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
synonyms_file="$spell_home/.synonyms"

# Check if synonyms file exists
if [ ! -f "$synonyms_file" ]; then
  printf '%s\n' "synonym-menu: no synonyms defined" >&2
  exit 1
fi

# Check if synonym exists and read target spell
target_spell=""
if grep -q "^alias $synonym_word=" "$synonyms_file"; then
  target_spell=$(grep "^alias $synonym_word=" "$synonyms_file" | sed "s/^alias $synonym_word='\\(.*\\)'$/\\1/" | sed "s/'\\\\''/'/g")
fi

if [ -z "$target_spell" ]; then
  printf '%s\n' "synonym-menu: synonym '$synonym_word' not found" >&2
  exit 1
fi

# Escape single quotes for safe passing
escaped_word=$(printf '%s' "$synonym_word" | sed "s/'/'\\\\''/g")

while :; do
  set --
  
  # Prompt for new word
  edit_word_cmd="printf 'New synonym word: ' >&2 && read new_word && edit-synonym '$escaped_word' --word \"\$new_word\""
  set -- "$@" "Edit word%$edit_word_cmd"
  
  # Prompt for new spell
  edit_spell_cmd="printf 'New target spell: ' >&2 && read new_spell && edit-synonym '$escaped_word' --spell \"\$new_spell\""
  set -- "$@" "Edit spell%$edit_spell_cmd"
  
  # Delete synonym
  set -- "$@" "Delete synonym%delete-synonym '$escaped_word' && kill -TERM \$PPID"
  
  exit_label=$(exit-label)
  set -- "$@" "${exit_label}%kill -TERM \$PPID"
  
  menu "Synonym: $synonym_word â†’ $target_spell" "$@" || true
done
