#!/usr/bin/env sh

# Present a menu of spells that can install supporting software.

script_dir=$(CDPATH= cd -- "$(dirname "$0")" && pwd)
cantrip_dir=$(dirname "$script_dir")/cantrips

if [ -n "${REQUIRE_COMMAND-}" ]; then
    require_cmd=$REQUIRE_COMMAND
elif [ -x "$cantrip_dir/require-command" ]; then
    require_cmd="$cantrip_dir/require-command"
else
    require_cmd=require-command
fi

# Shared helper that ensures dependencies exist before we keep going.
require() {
    "$require_cmd" "$@"
}

if [ -r "$cantrip_dir/colors" ]; then
    . "$cantrip_dir/colors"
else
    # Continue gracefully without colour if the palette is unavailable.
    RESET=''
    CYAN=''
    GREY=''
fi

if ! require menu "The install-menu spell needs the 'menu' command to present choices."; then
    exit 1
fi

# Let the user bail out with Ctrl+C while still printing a friendly message.
trap 'printf "\nExiting install menu.\n" >&2; exit 0' INT

list_entries() {
    # INSTALL_MENU_DIRS can override discovery for tests or custom menus.
    if [ -n "${INSTALL_MENU_DIRS-}" ]; then
        for name in $INSTALL_MENU_DIRS; do
            printf '%s\n' "$name"
        done
        return
    fi

    # Otherwise list each subdirectory as a potential install target.
    for dir in "$script_dir"/*; do
        [ -d "$dir" ] || continue
        printf '%s\n' "$(basename "$dir")"
    done
}

menu_escape_status=113

while :; do
    entries=$(list_entries)

    if [ -z "$entries" ]; then
        printf '%s\n' 'install-menu: no installable spells found' >&2
        exit 1
    fi

    printf '\n'

    set --
    for name in $entries; do
        if command -v "${name}-status" >/dev/null 2>&1; then
            status=$("${name}-status")
        else
            status='coming soon'
        fi

        if command -v "${name}-menu" >/dev/null 2>&1; then
            cmd="printf '\\n'; ${name}-menu"
        else
            cmd='printf "This entry is not ready yet.\n"'
        fi

        label="$name"
        if [ -n "$status" ]; then
            label="$label - $status"
        fi

        # Build the menu entry using the name%command convention expected by
        # the menu cantrip.
        set -- "$@" "${label}%$cmd"
    done

    set -- "$@" "Exit%kill -2 $$"

    MENU_ESCAPE_STATUS=$menu_escape_status menu "Install Menu:" "$@"
    status=$?

    if [ "$status" -eq "$menu_escape_status" ]; then
        break
    fi

    if [ "$status" -ne 0 ]; then
        exit "$status"
    fi
done
