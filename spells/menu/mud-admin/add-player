#!/bin/sh

# This spell authorizes a new player to connect via SSH key on a MUD host.
# Run it on the MUD host computer to add players with limited permissions.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: add-player

Interactively create a new player account on the MUD host by prompting for a player name and SSH key, then creating a limited system user with that key.

Player names must:
- Be 3-16 characters long
- Start with a letter  
- Contain only letters, digits, and underscores
- Be unique on this server

SSH keys must be in the format: ssh-<type> <base64-data> [comment]

This requires the 'mud' group to exist. Run install-sshfs first to set up the MUD server.
USAGE
  exit 0
  ;;
esac

set -eu

# Check if mud group exists
if ! getent group mud >/dev/null 2>&1; then
  printf '%s\n' "add-player: the 'mud' group does not exist." >&2
  printf '%s\n' "Please run 'install-sshfs' first to set up the MUD server." >&2
  printf '%s\n' "Or manually create the group: sudo groupadd mud" >&2
  exit 1
fi

printf '%s\n' "Add a new player to this MUD server."
printf '%s\n' "This creates a system user account with limited permissions for the player."
printf '%s\n' "Players in the 'mud' group only have access to shared rooms (folders) in the MUD."
printf '%s\n' ""

# Loop until we get a valid, unique player name
while true; do
  printf '%s' "Enter player name: "
  read -r playername
  
  # Validate player name format
  if ! validate-player-name "$playername" 2>/dev/null; then
    validate-player-name "$playername" || true
    continue
  fi
  
  # Check if user already exists
  if id "$playername" >/dev/null 2>&1; then
    printf '%s\n' "add-player: player '$playername' already exists on this server. Choose a different name." >&2
    continue
  fi
  
  break
done

# Loop until we get a valid SSH key
while true; do
  printf '%s' "Enter SSH public key: "
  read -r sshkey
  
  # Validate SSH key format
  if ! validate-ssh-key "$sshkey" 2>/dev/null; then
    printf '%s\n' "add-player: invalid SSH key format." >&2
    printf '%s\n' "SSH keys should start with ssh-rsa, ssh-ed25519, ssh-dss, or ecdsa-sha2-*" >&2
    continue
  fi
  
  # Check if key already exists in authorized_keys file
  if grep -qF "$sshkey" ~/.ssh/authorized_keys 2>/dev/null; then
    printf '%s\n' "add-player: this SSH key is already authorized. Use a different key." >&2
    continue
  fi
  
  break
done

# Create new system user with mud group
printf '%s\n' "Creating system user '${playername}'..."
useradd -m -G mud "$playername"

# Create the SSH directory
mkdir -p "/home/$playername/.ssh"
chmod 700 "/home/$playername/.ssh"

# Add key to authorized_keys file
printf '%s %s@mud\n' "$sshkey" "$playername" >> "/home/$playername/.ssh/authorized_keys"
chmod 600 "/home/$playername/.ssh/authorized_keys"
chown -R "$playername:$playername" "/home/$playername/.ssh"

printf '%s\n' ""
success "Player ${playername} added successfully!"
printf '%s\n' "They can now connect to this server using their SSH key."
printf '%s\n' ""
printf '%s\n' "Connection command for player:"
printf '%s\n' "  ssh -i ~/.ssh/${playername} ${playername}@your-server-address"
