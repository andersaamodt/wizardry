#!/bin/sh

# This spell creates a new player identity with SSH keys for the MUD.
# Use it to generate a new player key pair for connecting to MUD hosts.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: new-player

Interactively create a new player identity by generating an SSH key pair at ~/.ssh/<player_name> after prompting for a name.

Player names must:
- Be 3-16 characters long
- Start with a letter
- Contain only letters, digits, and underscores
USAGE
  exit 0
  ;;
esac

set -eu

printf '%s\n' "Create a new player identity for the MUD."
printf '%s\n' "Player names must be 3-16 characters, start with a letter, and contain only letters, digits, and underscores."
printf '%s\n' ""

# Loop until we get a valid player name
while true; do
  printf '%s' "Enter player name: "
  read -r player_name
  
  # Validate player name
  if validate-player-name "$player_name" 2>/dev/null; then
    # Check if key files already exist
    if [ -f "$HOME/.ssh/${player_name}" ] || [ -f "$HOME/.ssh/${player_name}.pub" ]; then
      printf '%s\n' "Player ${player_name} already has SSH keys. Choose a different name." >&2
      continue
    fi
    break
  else
    # Re-run validation to show error message
    validate-player-name "$player_name" || true
  fi
done

# Generate ssh key
printf '%s\n' "Generating SSH key pair for ${player_name}..."
ssh-keygen -t ed25519 -C "${player_name}@MUD" -f "$HOME/.ssh/${player_name}" -q -N ""

printf '%s\n' ""
success "Player ${player_name} created successfully!"
printf '%s\n' "SSH key pair saved to ~/.ssh/${player_name}"
printf '%s\n' ""
printf '%s\n' "To connect to a MUD server, share your public key:"
printf '%s\n' "  cat ~/.ssh/${player_name}.pub"
