#!/bin/sh

# This spell authorizes a new player to connect via SSH key on a MUD host.
# Run it on the MUD host computer to add players with limited permissions.

add_ssh_player_usage() {
cat <<'USAGE'
Usage: add-ssh-player

Interactively create a new player account on the MUD host by prompting for a player name and SSH key, then creating a limited system user with that key.
USAGE
}



add_ssh_player() {
case "${1-}" in
--help|--usage|-h)
  add_ssh_player_usage
  return 0
  ;;
esac

set -eu

printf '%s\n' "This spell authorizes a new player to connect to this computer via their player key (SSH key). Run this on the MUD host computer."
printf '%s\n' "A new user account will be created on your system with limited permissions for the new player."
printf '%s\n' 'MUD users are in the group "mud", and this group only has access to your shared rooms (folders) in the MUD.'

printf '%s' "Enter player name: "
read -r playername

# Check if user already exists. Check now so they don't have to enter the SSH key over and over.
if id "$playername" >/dev/null 2>&1; then
    printf '%s\n' "add-ssh-player: user $playername already exists."
    return 1
fi

printf '%s' "Enter SSH key: "
read -r sshkey

# Check if key already exists in authorized_keys file
if grep -q "$sshkey" ~/.ssh/authorized_keys 2>/dev/null; then
    printf '%s\n' "add-ssh-player: key already exists in authorized_keys file."
    return 1
fi

# Create new system user
useradd "$playername"

# Create the directories on this path, if they don't exist
mkdir -p "/home/$playername/.ssh"

# Add key to authorized_keys file in their home directory, so they can log in as themselves
printf '%s %s@mud\n' "$sshkey" "$playername" >> "/home/$playername/.ssh/authorized_keys"
}

# Self-execute when run directly (not sourced)
case "$0" in
  */add-ssh-player) add_ssh_player "$@" ;; esac
