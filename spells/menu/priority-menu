#!/bin/sh

# This spell displays a menu of commands for a prioritized file or folder with echelon support.
# Use 'priorities' to easily select a priority with this menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: priority-menu <file>

Display an interactive menu of actions for a prioritized file, offering quick options to prioritize, check, edit, or browse within it.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 0' INT TERM

# Load color palette (colors handles terminal capability detection internally)
# shellcheck source=/dev/null
. "$(command -v colors)"

# Check for menu command
if ! command -v menu >/dev/null 2>&1; then
  printf '%s\n' "priority-menu: menu command required" >&2
  exit 1
fi

file="${1-}"

if [ -z "$file" ]; then
  printf '%s\n' "priority-menu: file path required" >&2
  exit 2
fi

priority_menu_display_menu() {
  checked_state=$(read-magic "${file}" checked 2>/dev/null || true)
  case "$checked_state" in
    ''|*Error*|*"does not exist"*)
      # Not checked - show Check option
      check_item="Check%printf 'Feature: Check command not yet implemented\n'"
      ;;
    *)
      # Checked - show Uncheck option
      check_item="Uncheck%printf 'Feature: Uncheck command not yet implemented\n'"
      ;;
  esac

  filename=$(basename "$file")
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"

  set -- "Prioritize (upboat)%prioritize \"$file\"; kill -TERM \$PPID" \
         "${check_item}" \
         "Discard from priorities (downboat)%printf 'Feature: Discard command not yet implemented\n'" \
         "Edit Card%printf 'Feature: Edit command not yet implemented\n'" \
         "Browse Within%printf 'Feature: Browse files within this file/folder not yet implemented\n'" \
         "$exit_item"
  menu "${THEME_HEADING}${filename}${RESET}:" "$@"
}

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    :
  else
    first_run=0
  fi

  priority_menu_display_menu || true
done
