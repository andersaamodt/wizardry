#!/bin/sh

# This spell displays a menu of commands for a prioritized file or folder with echelon support.
# Use 'priorities' to easily select a priority with this menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: priority-menu <file>

Display an interactive menu of actions for a prioritized file, offering quick options to prioritize, check, edit, or browse within it.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 0' INT TERM

# Load color palette (colors handles terminal capability detection internally)
# shellcheck source=/dev/null
. "$(command -v colors)"

# Check for menu command
if ! command -v menu >/dev/null 2>&1; then
  printf '%s\n' "priority-menu: menu command required" >&2
  exit 1
fi

file="${1-}"

if [ -z "$file" ]; then
  printf '%s\n' "priority-menu: file path required" >&2
  exit 2
fi

priority_menu_display_menu() {
  checked_value=$(read-magic "${file}" checked 2>/dev/null || printf '0')
  
  # Handle errors or empty values
  case "$checked_value" in
    ''|*Error*) checked_value=0 ;;
    *[!0-9]*) checked_value=0 ;;
  esac
  
  if [ "$checked_value" = "1" ]; then
    # Checked - show Uncheck option
    check_item="Uncheck%uncheck \"$file\""
  else
    # Not checked - show Check option
    check_item="Check%check \"$file\""
  fi

  filename=$(basename "$file")
  
  # Add checkbox state to header
  if [ "$checked_value" = "1" ]; then
    header_checkbox="[X] "
  else
    header_checkbox="[ ] "
  fi
  
  # Exit button kills this menu script via TERM signal
  # Menu (child process) evals: kill -TERM $PPID → kills its parent (this script)
  exit_label=$(exit-label)
  exit_item="${exit_label}%kill -TERM \$PPID"

  # Check if this file is the highest priority (first in the list)
  # Get parent directory
  parent_dir=$(dirname "$file")
  if [ "$parent_dir" = "." ]; then
    parent_dir=$(pwd -P)
  fi
  
  # Get the priority list from the directory
  dir_priorities=$(read-magic "$parent_dir" priorities 2>/dev/null || true)
  
  # Determine if this file is the highest priority
  is_highest_priority=0
  case "$dir_priorities" in
    ''|*Error*|*"does not exist"*)
      # No priorities set, so can't be highest
      is_highest_priority=0
      ;;
    *)
      # Get the first hash in the priority list
      first_hash=$(printf '%s' "$dir_priorities" | cut -d',' -f1)
      # Get this file's hash
      file_hash=$(read-magic "$file" hash 2>/dev/null || true)
      # Only check if we have a valid hash
      case "$file_hash" in
        ''|*Error*|*"does not exist"*)
          is_highest_priority=0
          ;;
        *)
          if [ "$file_hash" = "$first_hash" ]; then
            is_highest_priority=1
          fi
          ;;
      esac
      ;;
  esac

  # Check if file is a directory and has subpriorities
  browse_item=""
  if [ -d "$file" ]; then
    # Check if directory has items with priority >= 1
    has_subpriorities=0
    for item in "$file"/*; do
      [ -e "$item" ] || continue
      item_priority=$(read-magic "$item" priority 2>/dev/null || printf '0')
      # Handle errors or empty values
      case "$item_priority" in
        ''|*Error*) item_priority=0 ;;
        *[!0-9]*) item_priority=0 ;;
      esac
      if [ "$item_priority" -ge 1 ]; then
        has_subpriorities=1
        break
      fi
    done
    
    if [ "$has_subpriorities" = "1" ]; then
      browse_item="Subpriorities...%(cd \"$file\" && priorities)"
    else
      # No subpriorities - offer to add one
      browse_item="Add subpriority%(cd \"$file\" && prioritize --interactive)"
    fi
  fi

  # Check if file is a regular file (not a directory) for "Make project" option
  make_project_item=""
  if [ -f "$file" ]; then
    make_project_item="Make project%file-to-folder \"$file\""
  fi

  # Build menu items - conditionally include Prioritize based on whether it's highest priority
  # Order: Subpriorities... (if available), Prioritize, Check, Edit priority, Make project (if file), Discard priority
  if [ "$is_highest_priority" = "1" ]; then
    # Don't show Prioritize for highest priority items
    if [ -n "$browse_item" ]; then
      if [ -n "$make_project_item" ]; then
        set -- "$browse_item" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "$make_project_item" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      else
        set -- "$browse_item" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      fi
    else
      if [ -n "$make_project_item" ]; then
        set -- "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "$make_project_item" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      else
        set -- "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      fi
    fi
  else
    # Show Prioritize for non-highest priority items
    if [ -n "$browse_item" ]; then
      if [ -n "$make_project_item" ]; then
        set -- "$browse_item" \
               "Prioritize%prioritize \"$file\"; kill -TERM \$PPID" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "$make_project_item" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      else
        set -- "$browse_item" \
               "Prioritize%prioritize \"$file\"; kill -TERM \$PPID" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      fi
    else
      if [ -n "$make_project_item" ]; then
        set -- "Prioritize%prioritize \"$file\"; kill -TERM \$PPID" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "$make_project_item" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      else
        set -- "Prioritize%prioritize \"$file\"; kill -TERM \$PPID" \
               "${check_item}" \
               "Edit priority%rename-interactive \"$file\"" \
               "Discard priority%deprioritize \"$file\"" \
               "---" \
               "$exit_item"
      fi
    fi
  fi
  menu "${THEME_HEADING}${header_checkbox}${filename}${RESET}:" "$@"
}

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    :
  else
    first_run=0
  fi

  priority_menu_display_menu || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC kills this menu script via TERM signal (same as Exit button)
  # Direct kill: kill -TERM $$ → kills this script
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    kill -TERM $$ 2>/dev/null || true
    exit 0
  fi
done
