#!/bin/sh

# This spell displays a menu of commands for a prioritized file or folder with echelon support.
# Use 'priorities' to easily select a priority with this menu.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: priority-menu <file>

Display an interactive menu of actions for a prioritized file, offering quick options to prioritize, check, edit, or browse within it.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 0' INT TERM

# Load color palette (colors handles terminal capability detection internally)
# shellcheck source=/dev/null
. "$(command -v colors)"

# Check for menu command
if ! command -v menu >/dev/null 2>&1; then
  printf '%s\n' "priority-menu: menu command required" >&2
  exit 1
fi

file="${1-}"

if [ -z "$file" ]; then
  printf '%s\n' "priority-menu: file path required" >&2
  exit 2
fi

priority_menu_display_menu() {
  checked_value=$(read-magic "${file}" checked 2>/dev/null || printf '0')
  
  # Handle errors or empty values
  case "$checked_value" in
    ''|*Error*) checked_value=0 ;;
    *[!0-9]*) checked_value=0 ;;
  esac
  
  if [ "$checked_value" = "1" ]; then
    # Checked - show Uncheck option
    check_item="Uncheck%uncheck \"$file\"; kill -TERM \$PPID"
  else
    # Not checked - show Check option
    check_item="Check%check \"$file\"; kill -TERM \$PPID"
  fi

        filename=$(basename "$file")
        # Exit button - use exit 0 instead of kill signal
        exit_label=$(exit-label)
        exit_item="${exit_label}%exit 0"

  set -- "Prioritize%prioritize \"$file\"; kill -TERM \$PPID" \
         "${check_item}" \
         "Discard from priorities%deprioritize \"$file\"; kill -TERM \$PPID" \
         "Edit priority%rename-interactive \"$file\"; kill -TERM \$PPID" \
         "---" \
         "$exit_item"
  menu "${THEME_HEADING}${filename}${RESET}:" "$@"
}

first_run=1

while true; do
  if [ "$first_run" -eq 0 ]; then
    :
  else
    first_run=0
  fi

  priority_menu_display_menu || menu_status=$?
  menu_status=${menu_status:-0}
  
  # ESC kills this menu script via TERM signal (same as Exit button)
  # Direct kill: kill -TERM $$ â†’ kills this script
  if [ "$menu_status" -eq 130 ]; then
    printf 'ESC\n' >&2
    kill -TERM $$ 2>/dev/null || true
    exit 0
  fi
done
