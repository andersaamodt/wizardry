#!/bin/sh

set -eu

spellbook_store=${SPELLBOOK_STORE-spellbook-store}
if spellbook_store_path=$(command -v "$spellbook_store" 2>/dev/null); then
        spellbook_store=$spellbook_store_path
else
        printf '%s\n' "spell-menu: spellbook-store helper is missing." >&2
        exit 1
fi

if [ -n "${REQUIRE_COMMAND-}" ]; then
        require_cmd=$REQUIRE_COMMAND
else
        require_cmd=require-command
fi

require_tool() {
        "$require_cmd" "$@"
}

spellbook_list() {
        "$spellbook_store" list
}

print_empty_message() {
        printf '%s\n' "No spells are available to cast."
        printf '%s\n' "Add spells with: memorize alias <name> 'command'"
}

spell_menu_loop() {
        menu_escape_status=113
        while :
        do
                entries=$(spellbook_list)
                if [ -z "$entries" ]; then
                        print_empty_message
                        break
                fi
                set --
                while IFS=$(printf '\t') read -r alias command
                do
                        [ -z "$alias" ] && continue
                        label=$(printf '%s â€“ %s' "$alias" "$command")
                        set -- "$@" "$(printf '%s%%%s' "$label" "$command")"
                done <<SPELLS
$entries
SPELLS
                set -- "$@" "Exit%kill -2 $$"
                MENU_ESCAPE_STATUS=$menu_escape_status menu "Cast a Spell:" "$@"
                status=$?
                if [ "$status" -eq "$menu_escape_status" ]; then
                        break
                fi
                printf '\n'
        done
}

usage() {
        cat <<'USAGE'
Usage: spell-menu [--list]

  --list   Show the stored spells in NAME<TAB>COMMAND format.
  --help   Show this help text.

Run without arguments to open the interactive casting menu.
USAGE
}

case ${1-} in
        --list)
                entries=$(spellbook_list)
                if [ -n "$entries" ]; then
                        printf '%s\n' "$entries"
                fi
                exit 0
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                ;;
        "")
                :
                ;;
        *)
                usage >&2
                exit 1
                ;;
esac

if ! require_tool menu "The casting menu needs the 'menu' command."; then
        exit 1
fi

spell_menu_loop
