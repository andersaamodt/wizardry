#!/bin/sh
# This spell casts previously memorized commands from the spellbook.

set -eu

cast_store=${CAST_STORE-memorize-spell}
if has "$cast_store"; then
        cast_store=$(where "$cast_store")
else
        warn "cast: memorize-spell helper is missing."
        exit 1
fi

if [ -n "${REQUIRE_COMMAND-}" ]; then
        require_cmd=$REQUIRE_COMMAND
else
        require_cmd=require-command
fi

require_tool() {
        "$require_cmd" "$@"
}

cast_dir=$($cast_store dir)

cast_list() {
        "$cast_store" list
}

print_empty_message() {
        printf '%s\n' "No spells are available to cast."
        printf '%s\n' "Add spells from the Spellbook menu."
}

spell_menu_loop() {
        menu_escape_status=113
        first_run=1
        while :
        do
                if [ "$first_run" -eq 0 ]; then
                        printf '\n'
                else
                        first_run=0
                fi

                entries=$(cast_list)
                if [ -z "$entries" ]; then
                        print_empty_message
                        break
                fi
                set --
                while IFS=$(printf '\t') read -r alias command
                do
                        [ -z "$alias" ] && continue
                        label=$(printf '%s â€“ %s' "$alias" "$command")
                        entry_cmd=$cast_dir/$alias
                        if [ ! -x "$entry_cmd" ]; then
                                entry_cmd=$command
                        fi
                        set -- "$@" "$(printf '%s%%%s' "$label" "$entry_cmd")"
                done <<SPELLS
$entries
SPELLS
                exit_label=$(exit-label)
                set -- "$@" "${exit_label}%exit $menu_escape_status"
                MENU_ESCAPE_STATUS=$menu_escape_status menu "Cast a Spell:" "$@"
                status=$?
                if [ "$status" -eq "$menu_escape_status" ]; then
                        break
                fi
                if [ "$status" -ne 0 ]; then
                        exit "$status"
                fi
        done
}

usage() {
        cat <<'USAGE'
Usage: cast [--list|--dir]

  --list   Show the stored spells in NAME<TAB>COMMAND format.
  --dir    Print the directory containing cast menu spells.
  --help   Show this help text.

Run without arguments to open the interactive casting menu.
USAGE
}

case ${1-} in
        --list)
                entries=$(cast_list)
                if [ -n "$entries" ]; then
                        printf '%s\n' "$entries"
                fi
                exit 0
                ;;
        --dir)
                printf '%s\n' "$cast_dir"
                exit 0
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                ;;
        "")
                :
                ;;
        *)
                usage >&2
                exit 1
                ;;
esac

if ! require_tool menu "The casting menu needs the 'menu' command."; then
        exit 1
fi

spell_menu_loop
