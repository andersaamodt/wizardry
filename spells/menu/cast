#!/bin/sh
# This spell casts previously memorized commands from the spellbook.

set -eu

cast_store=${CAST_STORE-memorize}
if has "$cast_store"; then
        cast_store=$(where "$cast_store")
else
        warn "cast: memorize helper is missing."
        exit 1
fi

if [ -n "${REQUIRE_COMMAND-}" ]; then
        require_cmd=$REQUIRE_COMMAND
else
        require_cmd=require-command
fi

require_tool() {
        "$require_cmd" "$@"
}

cast_dir=$($cast_store dir)

cast_list() {
        "$cast_store" list
}

# Extract the single executable line from a spell script if it has exactly one
# Returns the extracted command if successful, empty string otherwise
extract_one_line_command() {
        spell_path=$1
        if [ ! -f "$spell_path" ]; then
                return 1
        fi
        # Count non-comment, non-empty, non-set-eu lines
        # Skip shebang (#!/...), comments (#...), set commands (set -eu), and empty lines
        exec_lines=$(grep -v '^[[:space:]]*#' "$spell_path" 2>/dev/null | grep -v '^[[:space:]]*$' | grep -v '^[[:space:]]*set[[:space:]]' | wc -l | tr -d ' ')
        if [ "$exec_lines" -eq 1 ]; then
                # Get the single executable line
                cmd_line=$(grep -v '^[[:space:]]*#' "$spell_path" 2>/dev/null | grep -v '^[[:space:]]*$' | grep -v '^[[:space:]]*set[[:space:]]' | head -1)
                # If it's an exec sh -c 'command' pattern, extract the inner command
                case "$cmd_line" in
                        *"exec sh -c '"*"'"*)
                                # Extract the command from exec sh -c 'command' "$0" "$@"
                                inner_cmd=$(printf '%s' "$cmd_line" | sed "s/.*exec sh -c '\\([^']*\\)'.*/\\1/")
                                printf '%s' "$inner_cmd"
                                return 0
                                ;;
                        *)
                                printf '%s' "$cmd_line"
                                return 0
                                ;;
                esac
        fi
        return 1
}

print_empty_message() {
        printf '%s\n' "No spells are available to cast."
        printf '%s\n' "Add spells from the Spellbook menu."
}

spell_menu_loop() {
        menu_escape_status=113
        first_run=1
        while :
        do
                if [ "$first_run" -eq 0 ]; then
                        printf '\n'
                else
                        first_run=0
                fi

                entries=$(cast_list)
                if [ -z "$entries" ]; then
                        print_empty_message
                        break
                fi
                set --
                while IFS=$(printf '\t') read -r alias command
                do
                        [ -z "$alias" ] && continue
                        entry_cmd=$cast_dir/$alias
                        if [ ! -x "$entry_cmd" ]; then
                                entry_cmd=$command
                        fi
                        # Check if spell has exactly one executable line
                        display_cmd=$command
                        if one_liner=$(extract_one_line_command "$entry_cmd"); then
                                display_cmd=$one_liner
                        fi
                        label=$(printf '%s â€“ %s' "$alias" "$display_cmd")
                        set -- "$@" "$(printf '%s%%%s' "$label" "$entry_cmd")"
                done <<SPELLS
$entries
SPELLS
                exit_label=$(exit-label)
                set -- "$@" "${exit_label}%exit $menu_escape_status"
                if MENU_ESCAPE_STATUS=$menu_escape_status menu "Cast a Spell:" "$@"; then
                        status=0
                else
                        status=$?
                fi
                if [ "$status" -eq "$menu_escape_status" ]; then
                        break
                fi
                if [ "$status" -ne 0 ]; then
                        exit "$status"
                fi
        done
}

usage() {
        cat <<'USAGE'
Usage: cast [--list|--dir]

  --list   Show the stored spells in NAME<TAB>COMMAND format.
  --dir    Print the directory containing cast menu spells.
  --help   Show this help text.

Run without arguments to open the interactive casting menu.
USAGE
}

case ${1-} in
        --list)
                entries=$(cast_list)
                if [ -n "$entries" ]; then
                        printf '%s\n' "$entries"
                fi
                exit 0
                ;;
        --dir)
                printf '%s\n' "$cast_dir"
                exit 0
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                ;;
        "")
                :
                ;;
        *)
                usage >&2
                exit 1
                ;;
esac

if ! require_tool menu "The casting menu needs the 'menu' command."; then
        exit 1
fi

spell_menu_loop
