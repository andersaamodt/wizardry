#!/bin/sh
# This spell casts previously memorized commands from the spellbook.

require-wizardry || exit 1

# Catch Ctrl-C and TERM signal to exit cleanly
trap 'exit 0' INT TERM

cast_store=${CAST_STORE-memorize}
if has "$cast_store"; then
        cast_store=$(where "$cast_store")
else
        # Try to self-heal by offering to install memorize
        if ! require "$cast_store" "cast: memorize helper is needed for storing spells."; then
                exit 1
        fi
        # Check again after potential installation
        if has "$cast_store"; then
                cast_store=$(where "$cast_store")
        else
                # Still missing - exit gracefully
                warn "cast: memorize helper is still missing after attempted installation."
                exit 1
        fi
fi

cast_dir=$($cast_store dir)

cast_list() {
        "$cast_store" list
}

print_empty_message() {
        printf '%s\n' "No spells are available to cast."
        printf '%s\n' "Add spells from the Spellbook menu."
}

spell_menu_loop() {
        first_run=1
        while :
        do
                if [ "$first_run" -eq 0 ]; then
                        printf '\n'
                else
                        first_run=0
                fi

                entries=$(cast_list)
                if [ -z "$entries" ]; then
                        print_empty_message
                        break
                fi
                set --
                while IFS=$(printf '\t') read -r alias command
                do
                        [ -z "$alias" ] && continue
                        # Memorized spells are called directly by name
                        entry_cmd=$command
                        # Label is just the alias; menu shows and executes entry_cmd on the right
                        set -- "$@" "$(printf '%s%%%s' "$alias" "$entry_cmd")"
                done <<SPELLS
$entries
SPELLS
                exit_label=$(exit-label)
                set -- "$@" "${exit_label}%kill -TERM \$PPID"
                menu "Cast a Spell:" "$@" || true
        done
}

show_usage() {
        cat <<'USAGE'
Usage: cast [--list|--dir]

  --list   Show the stored spells in NAME<TAB>COMMAND format.
  --dir    Print the directory containing cast menu spells.
  --help   Show this help text.

Run without arguments to open the interactive casting menu.
USAGE
}

case ${1-} in
        --list)
                entries=$(cast_list)
                if [ -n "$entries" ]; then
                        printf '%s\n' "$entries"
                fi
                exit 0
                ;;
        --dir)
                printf '%s\n' "$cast_dir"
                exit 0
                ;;
        --help|--usage|-h)
                show_usage
                exit 0
                ;;
        --)
                shift
                ;;
        "")
                :
                ;;
        *)
                show_usage >&2
                exit 1
                ;;
esac
set -eu

if ! require menu "The casting menu needs the 'menu' command."; then
        exit 1
fi

spell_menu_loop
