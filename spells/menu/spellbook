#!/bin/sh

set -eu

spellbook_store=${SPELLBOOK_STORE-spellbook-store}
if spellbook_store_path=$(command -v "$spellbook_store" 2>/dev/null); then
        spellbook_store=$spellbook_store_path
else
        printf '%s\n' "spellbook: spellbook-store helper is missing." >&2
        exit 1
fi

if [ -n "${REQUIRE_COMMAND-}" ]; then
        require_cmd=$REQUIRE_COMMAND
else
        require_cmd=require-command
fi

require_tool() {
        "$require_cmd" "$@"
}

spellbook_list() {
        "$spellbook_store" list
}

spellbook_forget() {
        if [ "$#" -ne 1 ]; then
                printf '%s\n' "Usage: spellbook --forget NAME" >&2
                exit 1
        fi
        name=$1
        if "$spellbook_store" remove "$name"; then
                printf "Forgot '%s'.\n" "$name"
        fi
}

spellbook_show_list() {
        entries=$(spellbook_list)
        if [ -z "$entries" ]; then
                return 1
        fi
        printf '%s\n' "$entries"
        return 0
}

print_empty_message() {
        printf '%s\n' "Your spellbook is empty."
        printf '%s\n' "Add spells with: memorize alias <name> 'command'"
}

spellbook_menu() {
        menu_escape_status=113
        first_run=1
        while :
        do
                entries=$(spellbook_list)
                if [ -z "$entries" ]; then
                        if [ "$first_run" -eq 1 ]; then
                                print_empty_message
                        fi
                        break
                fi
                set --
                while IFS='\t' read -r alias command
                do
                        [ -z "$alias" ] && continue
                        label=$(printf '%s â€“ %s' "$alias" "$command")
                        set -- "$@" "$(printf '%s%%spellbook --forget %s' "$label" "$alias")"
                done <<'SPELLS'
$entries
SPELLS
                set -- "$@" "Close Spellbook%kill -2 $$"
                MENU_ESCAPE_STATUS=$menu_escape_status menu "Spellbook:" "$@"
                status=$?
                if [ "$status" -eq "$menu_escape_status" ]; then
                        break
                fi
                first_run=0
                printf '\n'
        done
}

usage() {
        cat <<'USAGE'
Usage: spellbook [--list|--forget NAME]

  --list          Show the stored spells in NAME<TAB>COMMAND format.
  --forget NAME   Remove the named spell from the spellbook.
  --help          Show this help text.

Run without arguments to interactively manage your spellbook.
USAGE
}

case ${1-} in
        --list)
                if spellbook_show_list; then
                        :
                fi
                exit 0
                ;;
        --forget)
                shift
                spellbook_forget "$@"
                exit 0
                ;;
        --help|-h)
                usage
                exit 0
                ;;
        --)
                shift
                ;;
        "")
                :
                ;;
        *)
                usage >&2
                exit 1
                ;;
esac

if ! require_tool menu "The spellbook menu needs the 'menu' command."; then
        exit 1
fi

spellbook_menu
