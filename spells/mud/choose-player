#!/bin/sh

# Load required imps for direct execution
if ! command -v require_wizardry >/dev/null 2>&1; then
  if [ -n "${WIZARDRY_DIR-}" ]; then
    _i="$WIZARDRY_DIR/spells/.imps/sys"
  elif [ -n "${ROOT_DIR-}" ]; then
    _i="$ROOT_DIR/spells/.imps/sys"
  else
    _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
  fi
  [ -f "$_i/require-wizardry" ] && . "$_i/require-wizardry"
fi

if ! command -v env_clear >/dev/null 2>&1; then
  if [ -n "${WIZARDRY_DIR-}" ]; then
    _i="$WIZARDRY_DIR/spells/.imps/sys"
  elif [ -n "${ROOT_DIR-}" ]; then
    _i="$ROOT_DIR/spells/.imps/sys"
  else
    _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
  fi
  [ -f "$_i/env-clear" ] && . "$_i/env-clear"
fi


# This spell displays a menu to choose and set the current MUD player.
# Use it to switch between player identities from available SSH keys.

require_wizardry || return 1

choose_player_usage() {
cat <<'USAGE'
Usage: choose-player

Display an interactive menu of player identities from ~/.ssh/*.pub and set MUD_PLAYER to the one you choose.
USAGE
}



choose_player() {
case "${1-}" in
--help|--usage|-h)
  choose_player_usage
  return 0
  ;;
esac

set -eu
env_clear

# check if the $MUD_PLAYER environment variable is set
if [ -z "${MUD_PLAYER-}" ]; then
    printf '%s\n' "MUD_PLAYER is not set."
else
    printf '%s\n' "MUD_PLAYER is currently set to $MUD_PLAYER"
fi

# Build menu options from player keys using set --
set --
for file in "$HOME"/.ssh/*.pub; do
    [ -f "$file" ] || continue
    player_name=$(basename "$file" ".pub")
    # Validate player name contains only safe characters
    case "$player_name" in
        *[!a-zA-Z0-9._-]*) continue ;;
    esac
    set -- "$@" "$player_name%set-player $player_name"
done
set -- "$@" "Cancel%return"

# Execute menu with options
menu "Choose your player:" "$@"
}


# Load castable imp for direct execution (AFTER all functions defined)
# When executed directly: always source to ensure castable sees correct $0
# When sourced (testing): use from PATH if available to avoid forks
case "$0" in
  sh|dash|bash|zsh|ksh|mksh|*/sh|*/dash|*/bash|*/zsh|*/ksh|*/mksh)
    # Being sourced - use from PATH if available
    if ! command -v castable >/dev/null 2>&1; then
      # Use WIZARDRY_DIR or ROOT_DIR if available (avoids dirname/basename)
      if [ -n "${WIZARDRY_DIR-}" ]; then
        _i="$WIZARDRY_DIR/spells/.imps/sys"
      elif [ -n "${ROOT_DIR-}" ]; then
        _i="$ROOT_DIR/spells/.imps/sys"
      else
        _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
      fi
      [ -f "$_i/castable" ] && . "$_i/castable"
    fi
    ;;
  *)
    # Being executed - always source to ensure correct $0 detection
    if [ -n "${WIZARDRY_DIR-}" ]; then
      _i="$WIZARDRY_DIR/spells/.imps/sys"
    elif [ -n "${ROOT_DIR-}" ]; then
      _i="$ROOT_DIR/spells/.imps/sys"
    else
      _i="${WIZARDRY_DIR:-${ROOT_DIR:-${0%/*/*/*}}}/spells/.imps/sys"
    fi
    [ -f "$_i/castable" ] && . "$_i/castable"
    ;;
esac

castable "$@"
