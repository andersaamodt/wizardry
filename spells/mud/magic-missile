#!/bin/sh

# Cast a magic missile at a target file, dealing random damage with colorful effects.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: magic-missile [target]

Cast a magic missile that deals random damage to a target file.
If no target is specified, a random file in the current directory is selected.

The spell displays colorful output and uses extended attributes to track damage.

Example:
  magic-missile treasure-chest
  magic-missile
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Load colors for tasteful output
if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  # Fallback if colors not available
  RESET=""
  PURPLE=""
  CYAN=""
  YELLOW=""
  RED=""
  GREEN=""
  BOLD=""
fi

# Determine target
target=${1-}

if [ -z "$target" ]; then
  # Select random file from current directory
  # Get list of files (not directories)
  files=""
  for entry in *; do
    # Check if glob expanded (if entry is *, no files exist)
    if [ "$entry" = "*" ] && [ ! -e "*" ]; then
      break
    fi
    if [ -f "$entry" ]; then
      if [ -z "$files" ]; then
        files="$entry"
      else
        files="$files
$entry"
      fi
    fi
  done
  
  if [ -z "$files" ]; then
    printf '%s\n' "magic-missile: no files found in current directory." >&2
    exit 1
  fi
  
  # Count files
  file_count=0
  printf '%s\n' "$files" | while IFS= read -r f || [ -n "$f" ]; do
    file_count=$((file_count + 1))
  done
  file_count=$(printf '%s\n' "$files" | wc -l)
  
  # Use cksum to generate a pseudo-random number
  random_seed=$(date +%s%N 2>/dev/null || date +%s)
  random_index=$(printf '%s' "$random_seed" | cksum | cut -d' ' -f1)
  random_index=$((random_index % file_count + 1))
  
  # Select the nth file
  target=$(printf '%s\n' "$files" | sed -n "${random_index}p")
fi

# Validate target exists
if [ ! -e "$target" ]; then
  printf '%s\n' "magic-missile: target file does not exist." >&2
  exit 1
fi

if [ ! -f "$target" ]; then
  printf '%s\n' "magic-missile: target must be a file (not a directory)." >&2
  exit 1
fi

# Generate random damage (1d4+1, range 2-5)
random_seed=$(date +%s%N 2>/dev/null || date +%s)
damage_value=$(printf '%s' "$random_seed" | cksum | cut -d' ' -f1)
damage=$((damage_value % 4 + 2))

# Pick random descriptive text
desc_hash=$(printf '%s%s' "$target" "$random_seed" | cksum | cut -d' ' -f1)
desc_index=$((desc_hash % 8))

case $desc_index in
  0) description="The missile streaks through the air with deadly precision" ;;
  1) description="Arcane energy coalesces into a blazing projectile" ;;
  2) description="A bolt of pure magical force erupts from your fingertips" ;;
  3) description="Shimmering light forms a crackling sphere of power" ;;
  4) description="Mystical energies swirl and launch toward your target" ;;
  5) description="A glowing orb of destruction hurtles forth" ;;
  6) description="Raw magical energy takes physical form and flies true" ;;
  7) description="Eldritch power manifests as a radiant missile" ;;
esac

# Display colorful output
printf '%s%sYou cast magic missile!%s %s. ' "${PURPLE}${BOLD}" "${RESET}" "${CYAN}" "$description"
printf 'It deals %s%s%d%s damage to %s%s%s.%s\n' "${RED}${BOLD}" "${RESET}" "$damage" "${RESET}" "${YELLOW}" "$target" "${RESET}" "${RESET}"

# Apply damage using damage-file
damage-file "$target" "$damage"
