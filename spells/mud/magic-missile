#!/bin/sh

# Cast a magic missile at a target file, dealing random damage with colorful effects.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: magic-missile [-v] [target]

Cast a magic missile that deals random damage to a target file or folder.
If no target is specified, a random file or folder in the current directory is selected.

The spell logs actions to the room .log file. Use -v for verbose local output.

Example:
  magic-missile treasure-chest
  magic-missile -v monster
  magic-missile
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Check for -v verbose flag
verbose=0
if [ "${1-}" = "-v" ]; then
  verbose=1
  shift
fi

# Load colors for tasteful output
if command -v colors >/dev/null 2>&1; then
  # shellcheck source=/dev/null
  . colors
else
  # Fallback if colors not available
  RESET=""
  PURPLE=""
  CYAN=""
  YELLOW=""
  RED=""
  GREEN=""
  BOLD=""
fi

# Determine target
target=${1-}

if [ -z "$target" ]; then
  # Select random file or folder from current directory
  # Get list of files and directories (exclude hidden files)
  entries=""
  for entry in *; do
    # Check if glob expanded (if entry is *, no files exist)
    if [ "$entry" = "*" ] && [ ! -e "*" ]; then
      break
    fi
    if [ -e "$entry" ]; then
      if [ -z "$entries" ]; then
        entries="$entry"
      else
        entries="$entries
$entry"
      fi
    fi
  done
  
  if [ -z "$entries" ]; then
    printf '%s\n' "magic-missile: no files or folders found in current directory." >&2
    exit 1
  fi
  
  # Count entries
  entry_count=$(printf '%s\n' "$entries" | wc -l)
  
  # Use cksum to generate a pseudo-random number
  random_seed=$(date +%s%N 2>/dev/null || date +%s)
  random_index=$(printf '%s' "$random_seed" | cksum | cut -d' ' -f1)
  random_index=$((random_index % entry_count + 1))
  
  # Select the nth entry
  target=$(printf '%s\n' "$entries" | sed -n "${random_index}p")
fi

# Validate target exists
if [ ! -e "$target" ]; then
  printf '%s\n' "magic-missile: target does not exist." >&2
  exit 1
fi

# Check if player has avatar and enough mana
spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
config_file="$spell_home/.mud"
avatar_enabled=$(config-get "$config_file" "avatar-enabled" 2>/dev/null || printf '0')

if [ "$avatar_enabled" = "1" ]; then
  avatar_path=$(config-get "$config_file" "avatar-path" 2>/dev/null || printf '')
  
  if [ -n "$avatar_path" ] && [ -e "$avatar_path" ]; then
    # Check mana
    current_mana=$(read-magic "$avatar_path" mana 2>/dev/null || printf '0')
    case "$current_mana" in
      ''|*[!0-9]*) current_mana=0 ;;
    esac
    
    mana_cost=4
    
    if [ "$current_mana" -lt "$mana_cost" ]; then
      printf '%s\n' "magic-missile: insufficient mana! You need $mana_cost mana but only have $current_mana." >&2
      exit 1
    fi
    
    # Deduct mana
    new_mana=$((current_mana - mana_cost))
    enchant "$avatar_path" "mana=$new_mana" >/dev/null 2>&1
  fi
fi

# Generate random damage (1d4+1, range 2-5)
random_seed=$(date +%s%N 2>/dev/null || date +%s)
damage_value=$(printf '%s' "$random_seed" | cksum | cut -d' ' -f1)
damage=$((damage_value % 4 + 2))

# Pick random descriptive text
desc_hash=$(printf '%s%s' "$target" "$random_seed" | cksum | cut -d' ' -f1)
desc_index=$((desc_hash % 8))

case $desc_index in
  0) description="The missile streaks through the air with deadly precision" ;;
  1) description="Arcane energy coalesces into a blazing projectile" ;;
  2) description="A bolt of pure magical force erupts from your fingertips" ;;
  3) description="Shimmering light forms a crackling sphere of power" ;;
  4) description="Mystical energies swirl and launch toward your target" ;;
  5) description="A glowing orb of destruction hurtles forth" ;;
  6) description="Raw magical energy takes physical form and flies true" ;;
  7) description="Eldritch power manifests as a radiant missile" ;;
esac

# Display colorful output only if verbose
if [ "$verbose" -eq 1 ]; then
  printf '%s%sYou cast magic missile!%s %s. ' "${PURPLE}${BOLD}" "${RESET}" "${CYAN}" "$description"
  printf 'It deals %s%s%d%s damage to %s%s%s.%s\n' "${RED}${BOLD}" "${RESET}" "$damage" "${RESET}" "${YELLOW}" "$target" "${RESET}" "${RESET}"
  # Apply damage using damage-file (shows output)
  damage-file "$target" "$damage"
else
  # Apply damage silently
  damage-file "$target" "$damage" >/dev/null 2>&1
fi

# Log the attack to room log for multiplayer visibility
player_name=${MUD_PLAYER:-${USER:-Someone}}
timestamp=$(log-timestamp)
room_log="$PWD/.log"
log_entry="[$timestamp] $player_name casts magic missile at ${BLUE}$target${RESET}, dealing $damage damage!"
printf '%s\n' "$log_entry" >> "$room_log" 2>/dev/null || true
