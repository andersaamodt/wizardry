#!/bin/sh

# Record a private thought in your avatar's personal log (not visible to others).

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: think <thought>

Record your character's private thoughts in your avatar's personal log file.
Thoughts are displayed in quotes to distinguish them from speech.

Thoughts are private and only visible to you, representing your character's
internal monologue that others cannot hear.

Note: If your thought contains special characters like !, use single quotes:
  think 'I wonder what that sound was!'

Example:
  think "Where did everyone go?"
  think 'This place gives me the creeps...'
  think 'Maybe I should have brought a torch.'

See also: say, look, listen
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Get thought from all arguments
if [ $# -eq 0 ]; then
  printf '%s\n' "think: requires a thought to narrate" >&2
  exit 2
fi

thought="$*"

# Get player name from environment or use 'Anonymous'
player_name=${MUD_PLAYER:-${USER:-Anonymous}}

# Get config file location
spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
config_file="$spell_home/.mud"

# Get avatar path from config
avatar_path=$(config-get "$config_file" "avatar-path" 2>/dev/null || printf '')

# If no avatar path or avatar doesn't exist, fall back to using player name
if [ -z "$avatar_path" ] || [ ! -d "$avatar_path" ]; then
  # Try to find avatar folder in current directory
  avatar_path="$PWD/.$player_name"
  if [ ! -d "$avatar_path" ]; then
    printf '%s\n' "think: no avatar found. Thoughts require an avatar folder." >&2
    exit 1
  fi
fi

# Create timestamp (HH:MM format, like say)
timestamp=$(date '+%H:%M' 2>/dev/null || date '+%H:%M')

# Format the thought with quotes and comma (name thinks, "thought")
log_entry="[$timestamp] $player_name thinks, \"$thought\""

# Append to avatar's personal log
avatar_log="$avatar_path/.log"

# Create or append to log file
if printf '%s\n' "$log_entry" >> "$avatar_log" 2>/dev/null; then
  # Echo to stdout for the thinker to see
  printf '%s\n' "$log_entry"
else
  printf '%s\n' "think: failed to write to avatar log" >&2
  exit 1
fi
