#!/bin/sh

# This spell displays a menu to select and set the current MUD player.
# Use it to switch between player identities from available SSH keys.

require-wizardry || return 1

select_player_usage() {
cat <<'USAGE'
Usage: select-player

Display an interactive menu of player identities from ~/.ssh/*.pub and set MUD_PLAYER to the one you choose.
USAGE
}



select_player() {
case "${1-}" in
--help|--usage|-h)
  select_player_usage
  return 0
  ;;
esac

set -eu
. env-clear

# check if the $MUD_PLAYER environment variable is set
if [ -z "${MUD_PLAYER-}" ]; then
    printf '%s\n' "MUD_PLAYER is not set."
else
    printf '%s\n' "MUD_PLAYER is currently set to $MUD_PLAYER"
fi

# Build menu options from player keys using set --
set --
for file in "$HOME"/.ssh/*.pub; do
    [ -f "$file" ] || continue
    player_name=$(basename "$file" ".pub")
    # Validate player name contains only safe characters
    case "$player_name" in
        *[!a-zA-Z0-9._-]*) continue ;;
    esac
    set -- "$@" "$player_name%set-player $player_name"
done
set -- "$@" "Cancel%return"

# Execute menu with options
menu "Choose your player:" "$@"
}


# Load castable imp for direct execution
# CRITICAL: Check if already available before sourcing to avoid fork limits
if ! command -v castable >/dev/null 2>&1; then
  _d=$(CDPATH= cd -- "$(dirname "$0")" && pwd -P)
  _r=$(cd "$_d" && while [ ! -d "spells/.imps" ] && [ "$(pwd)" != "/" ]; do cd ..; done; pwd)
  _i="${WIZARDRY_DIR:-${_r}}/spells/.imps/sys"
  [ -f "$_i/castable" ] && . "$_i/castable"
fi

castable "$@"
