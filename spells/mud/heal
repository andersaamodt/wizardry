#!/bin/sh

# Smart heal spell that casts the best available healing spell.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: heal [target]

Cast the most powerful healing spell you have available.
Tries greater-heal first, falls back to lesser-heal if you don't have enough mana.

If no target is specified, heals yourself.

Example:
  heal
  heal other-avatar
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1
set -eu
. env-clear

spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
config_file="$spell_home/.mud"

# Check if avatar is enabled
avatar_enabled=$(config-get "$config_file" "avatar-enabled" 2>/dev/null || printf '0')
if [ "$avatar_enabled" != "1" ]; then
  printf '%s\n' "heal: avatar system is not enabled"
  exit 1
fi

# Get caster's avatar
avatar_path=$(config-get "$config_file" "avatar-path" 2>/dev/null || printf '')
if [ -z "$avatar_path" ] || [ ! -e "$avatar_path" ]; then
  printf '%s\n' "heal: avatar not found"
  exit 1
fi

# Check current mana
current_mana=$(read-magic "$avatar_path" mana 2>/dev/null || printf '0')
case "$current_mana" in
  ''|*[!0-9]*) current_mana=0 ;;
esac

# Try greater-heal first (costs 20 mana)
if [ "$current_mana" -ge 20 ]; then
  if command -v greater-heal >/dev/null 2>&1; then
    greater-heal "$@"
    exit $?
  fi
fi

# Fall back to lesser-heal (costs 5 mana)
if [ "$current_mana" -ge 5 ]; then
  if command -v lesser-heal >/dev/null 2>&1; then
    lesser-heal "$@"
    exit $?
  fi
fi

# Not enough mana for any heal
printf '%s\n' "heal: insufficient mana! You need at least 5 mana but only have $current_mana." >&2
exit 1
