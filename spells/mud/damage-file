#!/bin/sh

# Apply or increase damage to a file using extended attributes.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: damage-file <file> <damage>

Apply or increase damage to a file using the 'damage' extended attribute.
The damage amount is added to any existing damage on the file.

Example:
  damage-file treasure-chest 5
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Validate arguments
if [ "$#" -ne 2 ]; then
  printf '%s\n' "damage-file: requires exactly two arguments (file path and damage amount)." >&2
  exit 2
fi

file=$1
new_damage=$2

# Validate damage is a number
case "$new_damage" in
  ''|*[!0-9]*)
    printf '%s\n' "damage-file: damage must be a positive number." >&2
    exit 2
    ;;
esac

# Check file exists
if [ ! -e "$file" ]; then
  printf '%s\n' "damage-file: file does not exist." >&2
  exit 1
fi

# Apply damage using the deal-damage imp
deal-damage "$file" "$new_damage"

# Get total damage for display
total_damage=0
if existing_damage=$(read-magic "$file" damage 2>/dev/null); then
  case "$existing_damage" in
    ''|*[!0-9]*) total_damage=0 ;;
    *) total_damage=$existing_damage ;;
  esac
fi

printf '%s\n' "The file has taken $new_damage damage (total: $total_damage)."
