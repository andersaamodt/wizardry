#!/bin/sh

# Apply or increase damage to a file using extended attributes.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: damage-file <file> <damage>

Apply or increase damage to a file using the 'damage' extended attribute.
The damage amount is added to any existing damage on the file.

Example:
  damage-file treasure-chest 5
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Validate arguments
if [ "$#" -ne 2 ]; then
  printf '%s\n' "damage-file: requires exactly two arguments (file path and damage amount)." >&2
  exit 2
fi

file=$1
new_damage=$2

# Validate damage is a number
case "$new_damage" in
  ''|*[!0-9]*)
    printf '%s\n' "damage-file: damage must be a positive number." >&2
    exit 2
    ;;
esac

# Check file exists
if [ ! -e "$file" ]; then
  printf '%s\n' "damage-file: file does not exist." >&2
  exit 1
fi

# Get current damage (if any)
current_damage=0
if existing_damage=$(read-magic "$file" damage 2>/dev/null); then
  # Check if we got a valid number
  case "$existing_damage" in
    ''|*[!0-9]*) current_damage=0 ;;
    *) current_damage=$existing_damage ;;
  esac
fi

# Calculate total damage
total_damage=$((current_damage + new_damage))

# Apply the damage using enchant
enchant "$file" "damage=$total_damage"

printf '%s\n' "The file has taken $new_damage damage (total: $total_damage)."
