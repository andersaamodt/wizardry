#!/bin/sh

# This spell decorates a location with a description, making it visible to 'look'.
# It's a convenient wrapper around 'enchant' for setting room descriptions.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: decorate [path] [description]

Decorate a location (folder or file) with a description shown when using the look spell. Defaults to the current directory and accepts either order when both a path and description are provided.
USAGE
  exit 0
  ;;
esac

set -eu

if ! command -v enchant >/dev/null 2>&1; then
        printf '%s\n' "decorate: enchant spell is missing." >&2
        exit 1
fi

# Parse arguments - detect which is path and which is description
path=""
description=""

if [ $# -eq 0 ]; then
        # No arguments: use current directory and prompt for description
        path=$PWD
elif [ $# -eq 1 ]; then
        # One argument: could be path or description
        if [ -e "$1" ]; then
                # It's a path - prompt for description
                path=$1
        else
                # It's a description - use current directory
                path=$PWD
                description=$1
        fi
elif [ $# -eq 2 ]; then
        # Two arguments: detect which is the path
        # Note: empty strings are not valid descriptions
        if [ -e "$1" ] && [ -n "$2" ] && [ ! -e "$2" ]; then
                # First is path, second is description
                path=$1
                description=$2
        elif [ -e "$2" ] && [ -n "$1" ] && [ ! -e "$1" ]; then
                # Second is path, first is description
                path=$2
                description=$1
        elif [ -e "$1" ] && [ -e "$2" ]; then
                # Both exist as paths - this is ambiguous
                printf '%s\n' "decorate: both arguments appear to be valid paths." >&2
                exit 1
        elif [ -z "$1" ] || [ -z "$2" ]; then
                # One of the arguments is empty
                printf '%s\n' "decorate: description cannot be empty." >&2
                exit 1
        else
                # Neither exists as a path
                printf '%s\n' "decorate: no valid path found among arguments." >&2
                exit 1
        fi
else
        printf '%s\n' "decorate: too many arguments provided." >&2
        exit 1
fi

# Resolve path to absolute
if [ -d "$path" ]; then
        path=$(cd "$path" && pwd)
elif [ -f "$path" ]; then
        path=$(cd "$(dirname "$path")" && pwd)/$(basename "$path")
fi

# Get description if not already set
if [ -z "$description" ]; then
        if command -v ask-text >/dev/null 2>&1; then
                description=$(ask-text "Enter description for this location:")
        else
                printf '%s' "Enter description: "
                read -r description
        fi
fi

if [ -z "$description" ]; then
        printf '%s\n' "decorate: description cannot be empty." >&2
        exit 1
fi

# Apply the description using enchant
if enchant "$path" description "$description"; then
        printf '%s\n' "The location has been decorated with the description."
else
        printf '%s\n' "decorate: failed to apply description." >&2
        exit 1
fi
