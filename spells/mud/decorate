#!/bin/sh

# This spell decorates a location with a description, making it visible to 'look'.
# It's a convenient wrapper around 'enchant' for setting room descriptions.

show_usage() {
        cat <<'USAGE'
Usage: decorate [description]
       decorate [path] [description]
       decorate [description] [path]

Decorate a location (folder or file) with a description that will be shown
when using the 'look' spell. If no path is provided, decorates the current
directory. With two arguments, the spell detects which is the path and which
is the description.

Examples:
  decorate                        # Interactively decorate current directory
  decorate "A cozy chamber"       # Decorate current directory with description
  decorate ~/projects "Workshop"  # Decorate a specific folder
  decorate "Workshop" ~/projects  # Same as above (order doesn't matter)
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

if lacks enchant; then
        warn "decorate: enchant spell is missing."
        exit 1
fi

# Parse arguments - detect which is path and which is description
path=""
description=""

if [ $# -eq 0 ]; then
        # No arguments: use current directory and prompt for description
        path=$PWD
elif [ $# -eq 1 ]; then
        # One argument: could be path or description
        if [ -e "$1" ]; then
                # It's a path - prompt for description
                path=$1
        else
                # It's a description - use current directory
                path=$PWD
                description=$1
        fi
elif [ $# -eq 2 ]; then
        # Two arguments: detect which is the path
        # Note: empty strings are not valid descriptions
        if [ -e "$1" ] && [ -n "$2" ] && [ ! -e "$2" ]; then
                # First is path, second is description
                path=$1
                description=$2
        elif [ -e "$2" ] && [ -n "$1" ] && [ ! -e "$1" ]; then
                # Second is path, first is description
                path=$2
                description=$1
        elif [ -e "$1" ] && [ -e "$2" ]; then
                # Both exist as paths - this is ambiguous
                warn "decorate: both arguments appear to be valid paths."
                exit 1
        elif [ -z "$1" ] || [ -z "$2" ]; then
                # One of the arguments is empty
                warn "decorate: description cannot be empty."
                exit 1
        else
                # Neither exists as a path
                warn "decorate: no valid path found among arguments."
                exit 1
        fi
else
        warn "decorate: too many arguments provided."
        exit 1
fi

# Resolve path to absolute
if [ -d "$path" ]; then
        path=$(cd "$path" && pwd)
elif [ -f "$path" ]; then
        path=$(cd "$(dirname "$path")" && pwd)/$(basename "$path")
fi

# Get description if not already set
if [ -z "$description" ]; then
        if has ask_text; then
                description=$(ask_text "Enter description for this location:")
        else
                printf '%s' "Enter description: "
                read -r description
        fi
fi

if [ -z "$description" ]; then
        warn "decorate: description cannot be empty."
        exit 1
fi

# Apply the description using enchant
if enchant "$path" description "$description"; then
        printf '%s\n' "The location has been decorated with the description."
else
        warn "decorate: failed to apply description."
        exit 1
fi
