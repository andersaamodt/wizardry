#!/bin/sh

# Stop the background listener.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: stop-listening

Stop the background room activity listener that was started with
start-listening.

See also: start-listening, listen
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

pid_file="$HOME/.wizardry-listening.pid"

if [ ! -f "$pid_file" ]; then
  printf '%s\n' "Not currently listening to any room."
  exit 0
fi

monitor_pid=$(cat "$pid_file" 2>/dev/null || printf '')

if [ -z "$monitor_pid" ]; then
  printf '%s\n' "Invalid PID file."
  rm -f "$pid_file"
  exit 1
fi

if kill -0 "$monitor_pid" 2>/dev/null; then
  # Kill the monitor process
  kill "$monitor_pid" 2>/dev/null || true
  
  # Also try to kill any child processes (tail)
  # Use ps to find children instead of pkill for portability
  if command -v ps >/dev/null 2>&1; then
    # Find and kill child processes
    ps -o pid= --ppid "$monitor_pid" 2>/dev/null | while read -r child_pid; do
      kill "$child_pid" 2>/dev/null || true
    done
  fi
  
  # Wait a moment for cleanup
  sleep 0.5
  
  # Check if it's really gone
  if kill -0 "$monitor_pid" 2>/dev/null; then
    printf '%s\n' "Warning: Listener process may still be running (PID: $monitor_pid)"
  else
    printf '%s\n' "âœ“ Stopped listening to room activity"
  fi
else
  printf '%s\n' "Listener was not running (stale PID file)"
fi

rm -f "$pid_file"
