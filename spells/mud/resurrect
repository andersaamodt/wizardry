#!/bin/sh

# Resurrect the player, restoring them to life with 1 HP.

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: resurrect

Resurrect yourself if you are dead. This spell can only be cast in your home
directory or the directory designated by 'jump 1'.

When you resurrect, your health is restored to 1 HP.

Aliases: revive
USAGE
  exit 0
  ;;
esac

require-wizardry || exit 1
set -eu
. env-clear

spell_home=$(env-or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
config_file="$spell_home/.mud"

# Check if avatar is enabled
avatar_enabled=$(config-get "$config_file" "avatar-enabled" 2>/dev/null || printf '0')
if [ "$avatar_enabled" != "1" ]; then
  printf '%s\n' "resurrect: avatar system is not enabled" >&2
  exit 1
fi

# Get avatar
avatar_path=$(config-get "$config_file" "avatar-path" 2>/dev/null || printf '')
if [ -z "$avatar_path" ] || [ ! -e "$avatar_path" ]; then
  printf '%s\n' "resurrect: avatar not found" >&2
  exit 1
fi

# Check if player is dead
dead=$(read-magic "$avatar_path" dead 2>/dev/null || printf '0')
case "$dead" in
  ''|*[!0-9]*) dead=0 ;;
esac

if [ "$dead" != "1" ]; then
  printf '%s\n' "You are not dead."
  exit 0
fi

# Check if we're in home directory or jump 1 location
current_dir=$(pwd -P)
home_dir=$(cd "$HOME" && pwd -P)

# TODO: Check jump 1 location when jump spell exists
# For now, just check home
if [ "$current_dir" != "$home_dir" ]; then
  printf '%s\n' "resurrect: you can only resurrect in your home directory" >&2
  exit 1
fi

# Resurrect: clear dead flag, set damage to max_life - 1
max_life=$(read-magic "$avatar_path" max_life 2>/dev/null || printf '100')
case "$max_life" in
  ''|*[!0-9]*) max_life=100 ;;
esac

new_damage=$((max_life - 1))
if ! enchant "$avatar_path" "damage=$new_damage" >/dev/null 2>&1; then
  printf '%s\n' "resurrect: failed to restore HP" >&2
  exit 1
fi
if ! enchant "$avatar_path" "dead=0" >/dev/null 2>&1; then
  printf '%s\n' "resurrect: failed to clear dead status" >&2
  exit 1
fi

printf '%s\n' "You have been resurrected! Your health is restored to 1 HP."
exit 0
