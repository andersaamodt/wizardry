#!/bin/sh

# Say something in the current room (append to room log for multiplayer chat).

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: say [-v] <message>

Speak in the current room by appending your message to the .log file.
Other players in the same room (directory) can see your messages by reading
the log file or using 'listen' which displays activity in real-time.

By default, 'say' is silent (writes to log only). Use -v for verbose output.

In multiplayer MUD, speech is simply append operations to the room log.
Each player can use 'listen' to see messages in real-time.

Note: If your message contains special characters like !, use single quotes:
  say 'Hello, world!'

Example:
  say "Hello, adventurers"
  say 'Has anyone seen the dragon?'
  say -v 'Watch out!'  # Show output locally

See also: look, listen
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Check for -v verbose flag
verbose=0
if [ "${1-}" = "-v" ]; then
  verbose=1
  shift
fi

# Get message from all arguments
if [ $# -eq 0 ]; then
  printf '%s\n' "say: requires a message to say" >&2
  exit 2
fi

message="$*"

# Get current directory (the room we're in)
room_dir=${PWD}

# Get player name from environment or use 'Anonymous'
player_name=${MUD_PLAYER:-${USER:-Anonymous}}

# Create timestamp (HH:MM format, no date or seconds)
timestamp=$(date '+%H:%M' 2>/dev/null || date '+%H:%M')

# Format the message (player_name: message format, no "says")
log_entry="[$timestamp] $player_name: $message"

# Append to room log
room_log="$room_dir/.log"

# Create or append to log file
if printf '%s\n' "$log_entry" >> "$room_log" 2>/dev/null; then
  # Echo to stdout only if verbose flag was used
  if [ "$verbose" -eq 1 ]; then
    printf '%s\n' "$log_entry"
  fi
else
  printf '%s\n' "say: failed to write to room log (directory may be read-only)" >&2
  exit 1
fi
