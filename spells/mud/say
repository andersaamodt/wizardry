#!/bin/sh

# Say something in the current room (append to room log for multiplayer chat).

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: say [-v] <message>

Speak in the current room by appending your message to the .log file.
Other players in the same room (directory) can see your messages by reading
the log file or using 'listen' which displays activity in real-time.

By default, 'say' is silent (writes to log only). Use -v for verbose output.

In multiplayer MUD, speech is simply append operations to the room log.
Each player can use 'listen' to see messages in real-time.

Note: If your message contains special characters like !, use single quotes:
  say 'Hello, world!'

Example:
  say "Hello, adventurers"
  say 'Has anyone seen the dragon?'
  say -v 'Watch out!'  # Show output locally

See also: look, listen
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Check for -v verbose flag
verbose=0
if [ "${1-}" = "-v" ]; then
  verbose=1
  shift
fi

# Get message from all arguments
if [ $# -eq 0 ]; then
  printf '%s\n' "say: requires a message to say" >&2
  exit 2
fi

message="$*"

# Get current directory (the room we're in)
room_dir=${PWD}

# Get player name from environment or use 'Anonymous'
player_name=${MUD_PLAYER:-${USER:-Anonymous}}

# Create timestamp in full format for .log file
timestamp=$(log-timestamp)

# Format the message (player_name: message format, no "says")
log_entry="[$timestamp] $player_name: $message"

# Append to room log
room_log="$room_dir/.log"

# Create or append to log file
# CRITICAL: Wrap in subshell to force immediate buffer flush for tail -f visibility
# Shell file append (>>) buffers output until script exits
# Subshell exits immediately, flushing buffer so chat-stream's tail -f sees write
if (printf '%s\n' "$log_entry" >> "$room_log") 2>/dev/null; then
  # Echo to stdout only if verbose flag was used
  if [ "$verbose" -eq 1 ]; then
    # Colorize player name if outputting to a terminal
    if [ -t 1 ] && [ -z "${NO_COLOR-}" ]; then
      color=$(colorize-player-name "$player_name")
      printf '\033[1;%dm%s:\033[0m %s\n' "$color" "$player_name" "$message"
    else
      # No colors for non-TTY or when NO_COLOR is set
      printf '%s: %s\n' "$player_name" "$message"
    fi
  fi
else
  printf '%s\n' "say: failed to write to room log (directory may be read-only)" >&2
  exit 1
fi
