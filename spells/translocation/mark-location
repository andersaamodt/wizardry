#!/bin/sh

# This spell records the current directory (or a provided path) for jump-to-marker.
# It resolves the destination to an absolute path and stores it in the marker file.

usage() {
  cat <<'USAGE'
Usage: mark-location [path]

Record the absolute path (current directory by default) for jump-to-marker to
return to later, writing it into ~/.mud/portal_marker.
USAGE
}

case "${1-}" in
--help|--usage|-h)
  usage
  exit 0
  ;;
esac

if [ "$#" -gt 1 ]; then
  usage
  exit 1
fi

marker_dir="$HOME/.mud"
marker_file="$marker_dir/portal_marker"

# Store the marker alongside other MUD metadata.
mkdir -p "$marker_dir" || exit 1

if [ "$#" -eq 0 ]; then
  destination=$(pwd -P | sed 's|//|/|g')
else
  # Expand the provided path to an absolute destination for consistent recall.
  case $1 in
    /*)
      destination="$(cd "$(dirname "$1")" && pwd -P | sed 's|//|/|g')/$(basename "$1")"
      ;;
    "~/"*)
      if [ -n "${HOME-}" ]; then
        destination="$HOME/${1#"~/"}"
      else
        destination="$1"
      fi
      ;;
    *)
      destination="$(pwd -P | sed 's|//|/|g')/$1"
      ;;
  esac
  if [ ! -e "$destination" ]; then
    printf 'Error: %s does not exist.\n' "$1" >&2
    exit 1
  fi
fi

# Normalize any double slashes in the path (can occur on macOS where TMPDIR ends with /)
destination=$(printf '%s\n' "$destination" | sed 's|//|/|g')

printf '%s\n' "$destination" >"$marker_file"
printf 'Location marked at %s.\n' "$destination"
