#!/bin/sh

# This spell mounts a remote directory using sshfs through Tor.
# Use it to access remote servers anonymously via SSH filesystem.

show_usage() {
        cat <<'USAGE'
Usage: open-portal [remote_address] [remote_directory]

Mount a remote directory using sshfs over Tor. Prompts for address and
directory if not provided as arguments. Uses MUD_PLAYER for SSH key identity.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

# Check for required commands
if ! has sshfs; then
        die "open-portal: sshfs not found. Please install sshfs."
fi

if ! has torify; then
        die "open-portal: torify not found. Please install tor."
fi

# Get player key from environment
if is unset "${MUD_PLAYER-}"; then
        die "open-portal: MUD_PLAYER environment variable not set."
fi
player_key="$HOME/.ssh/$MUD_PLAYER"

if ! is file "$player_key"; then
        die "open-portal: SSH key not found: $player_key"
fi

# Get address and directory from arguments or prompt
tor_address=${1-}
remote_dir=${2-}

if is unset "$tor_address"; then
        printf '%s' "Enter the Tor address of the remote server: "
        read -r tor_address
fi

if is unset "$remote_dir"; then
        printf '%s' "Enter the remote directory to mount: "
        read -r remote_dir
fi

# Normalize trailing slashes
remote_dir="${remote_dir%/}/"

# Ensure local mount point exists
make dir "$remote_dir" || die "open-portal: cannot create mount point: $remote_dir"

# Mount the remote directory using sshfs over tor
torify sshfs -o "IdentityFile=$player_key" "$tor_address:$remote_dir" "$remote_dir"

say "Portal opened to $tor_address:$remote_dir"
