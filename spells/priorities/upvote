#!/bin/sh

# This spell increments the upvote count on a file using extended attributes.
# Use it to track popularity or priority through file metadata.

case "${1-}" in
--help|--usage|-h)
  cat << 'USAGE'
Usage: upvote <file>

Increment the upvote count stored in a file's 'upvotes' attribute, creating it with a value of 1 if it doesn't exist yet.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Ensure file argument is provided
if [ -z "${1-}" ]; then
  printf '%s\n' "upvote: file path required" >&2
  exit 2
fi

file=$1

# Verify file exists
if [ ! -f "$file" ]; then
  printf '%s\n' "upvote: file not found: $file" >&2
  exit 1
fi

# Get current upvotes count, default to 0 if not set
current=$(read-magic "$file" upvotes 2>/dev/null || printf '0')

# Handle case where read-magic returns an error message
case "$current" in
  *Error*|'') current=0 ;;
  *[!0-9]*) current=0 ;;
esac

# Increment the count
new_count=$((current + 1))

# Store the new value
enchant "$file" upvotes "$new_count" >/dev/null

printf '%s\n' "Upvotes: $new_count"
