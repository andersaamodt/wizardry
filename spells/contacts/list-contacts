#!/bin/sh

# Default contacts directory
CONTACTS_DIR="${1:-$HOME/.contacts}"

# Ensure the contacts directory exists
mkdir -p "$CONTACTS_DIR"

# Find all vCard files in the contacts directory
find "$CONTACTS_DIR" -name '*.vcf' -print0 |
  while IFS= read -r -d '' file; do
    # Attempt to extract the FN, ORG, or TEL field from the vCard
    name=$(perl -pe 's/\r\n[[:space:]]/ /g' "$file" |
      awk -v RS='END:VCARD' '
        BEGIN {FPAT = "([^:]+:)?([^\\\\]*\\\\.)*[^\\\\]*"}
        /^FN:/  {name = substr($0,5); gsub(/\\\\n/,"\n",name); gsub(/\\\\,/,",",name); gsub(/\\\\;/,";",name); gsub(/\\\\\\\\/,"\\",name); exit}
        /^ORG:/ {org  = substr($0,5); gsub(/\\\\n/,"\n",org); gsub(/\\\\,/,",",org); gsub(/\\\\;/,";",org); gsub(/\\\\\\\\/,"\\",org);}
        /^TEL:/ {tel  = substr($0,5); gsub(/\\\\n/,"\n",tel); gsub(/\\\\,/,",",tel); gsub(/\\\\;/,";",tel); gsub(/\\\\\\\\/,"\\",tel);}
        END     {print name != "" ? name : (org != "" ? org : tel)}
      ')

    if [ -z "$name" ]; then
      # No name, organization, or telephone found, print the filename
      name="<$(basename "$file")>"
    fi

    echo "$name"
  done | sort
