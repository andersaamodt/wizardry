#!/bin/bash
# Diagnostic script to identify readline/autocomplete issues

echo "=========================================="
echo "Wizardry Readline Diagnostic"
echo "=========================================="
echo ""

# Must run in bash
if [ -z "$BASH_VERSION" ]; then
    echo "ERROR: This diagnostic must be run in bash"
    echo "Run: bash diagnose-readline-issue"
    exit 1
fi

echo "1. Shell Information:"
echo "   bash version: $BASH_VERSION"
echo "   TERM: $TERM"
echo "   Shell is interactive: $([[ $- == *i* ]] && echo "yes" || echo "no")"
echo ""

echo "2. Shell Options BEFORE sourcing wizardry:"
echo "   errexit: $(set -o | grep errexit)"
echo "   nounset: $(set -o | grep nounset)"
echo ""

echo "3. Sourcing invoke-wizardry..."
if [ -f "$HOME/.wizardry/spells/.imps/sys/invoke-wizardry" ]; then
    . "$HOME/.wizardry/spells/.imps/sys/invoke-wizardry"
elif [ -f "spells/.imps/sys/invoke-wizardry" ]; then
    . spells/.imps/sys/invoke-wizardry
else
    echo "   ERROR: Cannot find invoke-wizardry"
    exit 1
fi
echo "   ✓ Sourced"
echo ""

echo "4. Shell Options AFTER sourcing wizardry:"
echo "   errexit: $(set -o | grep errexit)"
echo "   nounset: $(set -o | grep nounset)"
echo ""

echo "5. Checking what's loaded:"
echo "   WIZARDRY_INVOKED: ${WIZARDRY_INVOKED:-<not set>}"
echo "   cd is: $(type -t cd)"
if [ "$(type -t cd)" = "function" ]; then
    echo "   ✓ cd function is loaded"
else
    echo "   ⚠ cd is NOT a function (hook not loaded)"
fi
echo "   touch is: $(type -t touch)"
if [ "$(type -t touch)" = "function" ]; then
    echo "   ✓ touch function is loaded"
else
    echo "   ⚠ touch is NOT a function (hook not loaded)"
fi
echo ""

echo "6. Configuration:"
mud_config="${SPELLBOOK_DIR:-$HOME/.spellbook}/.mud"
if [ -f "$mud_config" ]; then
    echo "   Config file exists: $mud_config"
    echo "   Contents:"
    cat "$mud_config" | sed 's/^/     /'
else
    echo "   Config file does NOT exist: $mud_config"
    echo "   (This is why hooks may not be loaded)"
fi
echo ""

echo "7. Testing readline variable access:"
# These variables are used internally by readline
: ${READLINE_LINE:=}
: ${READLINE_POINT:=}
: ${COMP_WORDS:=}
echo "   ✓ Can access unset readline variables"
echo ""

echo "8. Completion status:"
if complete -p cd 2>&1 | grep -q "no completion"; then
    echo "   cd: No completion registered"
elif complete -p cd 2>&1 | grep -q "complete"; then
    echo "   cd completion: $(complete -p cd 2>&1)"
else
    echo "   cd completion: <error checking>"
fi
echo ""

echo "=========================================="
echo "Diagnosis:"
echo "=========================================="
nounset_status=$(set -o | grep nounset | awk '{print $2}')
if [ "$nounset_status" = "on" ]; then
    echo "❌ PROBLEM FOUND: set -u (nounset) is ON"
    echo "   This breaks readline (arrow keys, tab completion)"
    echo "   Solution: Wizardry should set permissive mode"
else
    echo "✓ set -u is OFF (permissive mode active)"
    echo ""
    if [ "$(type -t cd)" != "function" ]; then
        echo "ℹ️  cd hook not loaded (need cd-look=1 in config)"
    fi
    if [ "$(type -t touch)" != "function" ]; then
        echo "ℹ️  touch hook not loaded (need touch-hook=1 in config)"
    fi
    echo ""
    echo "If arrow keys and tab completion are still broken,"
    echo "the issue may be:"
    echo "  - Terminal configuration"
    echo "  - Other shell rc files interfering"  
    echo "  - Something else in the shell environment"
fi
echo ""
echo "=========================================="
