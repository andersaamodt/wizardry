#!/bin/sh

# Wizardry Uninstall Script
# This script was automatically generated during installation.
# It will reverse all changes made by the install script.

set -eu

INSTALL_DIR="/tmp/wizardry-test.x7awGB/case.fxmo8O/home/.wizardry"
INSTALL_WAS_LOCAL="/home/runner/work/wizardry/wizardry"
RC_FILE="/tmp/wizardry-test.x7awGB/sandbox.rd2t7e/home/.bashrc"
RC_FORMAT="shell"

# Load colors if available
if [ -r "$INSTALL_DIR/spells/cantrips/colors" ]; then
        # shellcheck source=/dev/null
        . "$INSTALL_DIR/spells/cantrips/colors"
else
        RESET=''
        RED=''
        YELLOW=''
        GREEN=''
        BOLD=''
        CYAN=''
fi

printf '\n%s===== Wizardry Uninstall =====%s\n\n' "$BOLD$CYAN" "$RESET"
printf '%sThis will remove wizardry from your system:%s\n' "$YELLOW" "$RESET"
printf '  - Remove PATH entries from %s\n' "$RC_FILE"
if [ -z "$INSTALL_WAS_LOCAL" ]; then
        printf '  - Delete wizardry directory: %s\n' "$INSTALL_DIR"
else
        printf '  - Keep wizardry directory (local source installation)\n'
fi
printf '\n'

# Ask for confirmation
printf '%sDo you want to proceed?%s [y/N] ' "$BOLD" "$RESET"
read -r answer
case $answer in
        y|Y|yes|YES)
                : # Continue
                ;;
        *)
                printf 'Uninstall cancelled.\n'
                exit 0
                ;;
esac

printf '\n%s==> Removing PATH entries...%s\n' "$CYAN" "$RESET"

# Use path-wizard to remove PATH entries
PATH_WIZARD="$INSTALL_DIR/spells/translocation/path-wizard"
if [ -x "$PATH_WIZARD" ]; then
        for dir in "$INSTALL_DIR"/spells/*; do
                [ -d "$dir" ] || continue
                if "$PATH_WIZARD" --recursive remove "$dir" 2>/dev/null; then
                        printf '  %s✓%s Removed %s\n' "$GREEN" "$RESET" "$dir"
                fi
        done
        # Also try removing the main spells directory
        if "$PATH_WIZARD" remove "$INSTALL_DIR/spells" 2>/dev/null; then
                printf '  %s✓%s Removed %s\n' "$GREEN" "$RESET" "$INSTALL_DIR/spells"
        fi
else
        printf '  %sWarning:%s Could not find path-wizard; manual PATH cleanup may be needed\n' "$YELLOW" "$RESET"
fi

# Remove wizardry directory if it was downloaded (not local source)
if [ -z "$INSTALL_WAS_LOCAL" ]; then
        printf '\n%s==> Removing wizardry directory...%s\n' "$CYAN" "$RESET"
        if [ -d "$INSTALL_DIR" ]; then
                if rm -rf "$INSTALL_DIR"; then
                        printf '  %s✓%s Deleted %s\n' "$GREEN" "$RESET" "$INSTALL_DIR"
                else
                        printf '  %sError:%s Could not delete %s\n' "$RED" "$RESET" "$INSTALL_DIR"
                        exit 1
                fi
        fi
fi

printf '\n%s✓ Wizardry uninstalled successfully%s\n' "$BOLD$GREEN" "$RESET"
printf 'You may need to restart your shell or source your configuration file.\n\n'

# Self-destruct - safely remove the uninstall script itself
SELF_DIR="$(cd "$(dirname "$0")" 2>/dev/null && pwd)" || SELF_DIR="."
SELF_NAME="$(basename "$0")"
if [ -n "$SELF_DIR" ] && [ -n "$SELF_NAME" ]; then
        rm -f "$SELF_DIR/$SELF_NAME"
fi
