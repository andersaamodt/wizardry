# Lessons Learned

**Purpose:** Document a lesson learned from EVERY bug found. This is a living record of debugging insights.

**Coordination with FULL_SPEC.md:** When lessons reveal gaps, contradictions, or clarifications in the project specification, update both LESSONS.md (the lesson) and .github/FULL_SPEC.md (the canonical spec). If a lesson indicates the spec was unclear or wrong, clarify the spec and note the lesson here.

**Related Documentation:**
- **FULL_SPEC.md** - Canonical specification
- **SHELL_CODE_PATTERNS.md** - POSIX shell patterns and best practices
- **CROSS_PLATFORM_PATTERNS.md** - Cross-platform compatibility patterns
- **EXEMPTIONS.md** - Documented exceptions

**Rules:**
- One sentence per lesson, extremely succinct
- Don't document the same lesson twice—if a lesson recurs, increment the counter at the end: `(3)`
- Maximum 1000 lines total
- When approaching 1000 lines, remove the least-important or most-conquered lessons
- Don't duplicate code policies or lessons already encoded in other AI-facing documentation
- Check this file when creating new code or debugging
- Lessons can be retired here from other documentation when no longer actively needed elsewhere

---

## Lessons

- For SSE/real-time CGI: unbuffer the ENTIRE chain - chat-stream uses `stdbuf -o0`, AND fcgiwrap must be started with `stdbuf -o0 fcgiwrap ...` to prevent fcgiwrap from buffering CGI output.
- Pipe-into-while creates subshell where output gets buffered until pipe closes; use temp file with input redirection instead: `tail file > temp; while read line; do ...; done < temp`.
- Shell stdout is buffered by default; for SSE/real-time streaming on Linux use `exec stdbuf -o0 "$0" "$@"`, on macOS without stdbuf use 128KB+ padding per event to force buffer overflow.
- Spells MUST NOT preload their own prerequisites (die, warn, etc.); they should fail early with require_wizardry if wizardry isn't available.
- When inlining helper functions, use global search-replace to ensure ALL calls are replaced, including those outside the main function body.
- Editing files with text processing tools (sed, awk, perl) can change file permissions - always restore execute bits afterwards.
- The `find -executable` flag is not portable to BSD/macOS; use `find -perm /111` (GNU) with fallbacks to `-perm +111` (BSD) and manual `[ -x ]` check.
- When gloss generation fails silently, check that find commands are BSD-compatible and validate WIZARDRY_DIR exists.
- Parse must search WIZARDRY_DIR for spell files as fallback when preloaded functions aren't available (gloss execution in new process).
- Cross-platform shell compatibility requires testing flag availability (e.g., find flags) on both GNU and BSD implementations.
- Common system commands (find, grep, sed, etc.) must be blacklisted in generate-glosses to prevent glossary from overriding them.
- Pipe-based while loops create subshells; use variable with here-document instead to preserve loop counter updates in parent shell.
- Spells should call imps via PATH (has, say, die, etc.) instead of executing scripts as subprocesses with full paths ("${WIZARDRY_DIR}/spells/...").
- Spells are now flat, linear scripts without function wrappers; the castable/uncastable pattern and dual-pattern testing (source-then-invoke) have been deprecated.
- Imps executed as scripts (via PATH) must use `exit` not `return`; bash (Arch's /bin/sh) errors on top-level `return`, while dash (Ubuntu's /bin/sh) silently allows it.
- Shell builtins like `disable` (bash builtin for disabling commands/functions) must be blacklisted in generate-glosses to prevent creating first-word glosses that conflict.
- Always establish realistic unit tests for every feature BEFORE writing or fixing code; tests are the fastest path to working code and catch edge cases immediately (TDD).
- Aliases for hyphenated sourced-only spells must expand to space-separated form (jump to marker) not hyphenated (jump-to-marker) to route through first-word glosses.
- Parse must skip both functions AND aliases when trying system commands as fallback; aliases cause wrong behavior (expansion before exec).
- First-word glosses must check BOTH real spell files AND synonym files when looking for uncastable spells to source.
- Shell builtin `read` CANNOT be overridden as it breaks while loops; must be blacklisted in generate-glosses even though read-magic exists.
- Spells executed directly (not sourced) must use `exit` not `return` for flow control; `return` outside a function causes "not within a function" errors.
- In sourced-only spells (with uncastable pattern), use plain `return` for error exits AFTER the uncastable guard, not `return 1 2>/dev/null || exit 1`; the `exit` part closes the user's terminal when the spell is sourced.
- Use shell parameter expansion ${file##*/} instead of basename for 100x speedup when processing many files (e.g., generate-glosses with 396 files).
- Variable `$_i` (imps directory shorthand) is not preserved by env-clear; use `${WIZARDRY_DIR}/spells/.imps` instead when referencing imp paths after sourcing env-clear.
- When two endpoints serve the same data (one for history, one for real-time), ensure they don't redundantly send overlapping data causing O(n) delays in the real-time endpoint; separate concerns and let deduplication handle any overlap.
- Using separate read-past and monitor-future operations creates race conditions; use single continuous stream (e.g., `tail -f -n 100`) with filtering to prevent gaps.
- When comparing timestamps between client and server, ensure both use the same timezone; mixing UTC and local time causes filter mismatches that reject valid data.
- Before creating UI elements with unique IDs, remove any existing element with that ID to prevent duplicates on rapid operations (e.g., room switching).
- When converting synonym targets from hyphenated to space-separated form (e.g., jump-to-marker → jump to marker), preserve directory prefixes unchanged (translocation/jump-to-marker → translocation/jump to marker, not translocation/jump to marker with / converted to space).
- First-word glosses must invoke aliases via eval (not parse or direct command invocation) because: (1) parse skips aliases to avoid recursion, (2) direct invocation "$_fw_spell" tries to find executable not expand alias, (3) eval expands alias correctly without passing $@ since multi-word was already consumed during reconstruction.
- Parse MUST skip functions before trying to exec system commands; exec-ing a gloss function creates infinite recursion (gloss → parse → exec gloss → parse ...) causing segfault/exit 139.
- Pandoc wraps inline HTML elements in paragraph tags when they appear on separate lines in Markdown files; place all related inline elements on a single line to prevent this and maintain intended layout (consolidating elements signals to Pandoc that HTML is intentional inline markup rather than block-level content).
- CSS transitions only work when animating between two defined states; setting `height: auto` breaks transitions because the browser can't interpolate from a length to 'auto' - use scrollHeight directly instead.
- When styling disabled buttons, always include `:not(:disabled)` in hover selectors to prevent hover effects on disabled state.
- Textarea auto-resize should calculate new height from scrollHeight without setting height to 'auto' first to preserve smooth CSS transitions.
- CSS scrollbar styling requires both `-webkit-scrollbar` pseudo-elements (Chrome/Safari/Edge) and standard `scrollbar-width`/`scrollbar-color` properties (Firefox) for cross-browser support.
- Notification message opacity must balance visibility with aesthetics; 0.15 is too transparent, 0.95 too opaque, 0.25 provides good legibility while maintaining light/tasteful appearance.
- NO underscore-prefixed identifiers in any code (functions, variables, loop iterators); use imps instead of "private" functions; rename conflicting variables rather than prefixing with underscore.
- Uncastable pattern variables (spell_name_sourced, spell_name_base) are internal-only (not exported) so should use lowercase without underscore prefix, not _spell_name_sourced.
- Underscore-prefixed functions/variables are an anti-pattern suggesting "private" functions, but spells/imps shouldn't have functions at all; use imps for reusable code instead.
- Spells and imps must NEVER define functions, even with underscore prefixes; extract logic into separate imps instead (e.g., move-avatar imp, not _move_avatar function).
- Underscore-prefixed identifiers (variables/functions) are an anti-pattern that attempts to circumvent the "no functions in spells/imps" rule; always refactor into imps.
- The `find -perm` flags cause infinite hangs on some systems (macOS, Ubuntu in CI); always omit `-perm` checks when scanning for files and use simple `-type f` instead.
- When synonym handling in gloss functions finds a target spell, MUST shift consumed words BEFORE calling parse; otherwise parse builds wrong multi-word command causing infinite recursion.
- Duplicated uncastable detection logic (in gloss functions, synonyms, parse) is an antipattern; centralize in a single helper function (invoke_spell_helper) that's preloaded with glosses.
- Parse should not depend on other imps (like env-or) being available; use inline parameter expansion ${VAR:-default} instead to ensure parse works in all contexts.
- When generate-glosses creates first-word glosses, consumed words must be shifted BEFORE calling parse with synonym targets to prevent infinite loops (e.g., "jump-to" → "leap-to-location" with args still present causes parse to try "leap-to-location-to-marker-home").


- When a file is sourced (`. filename`), using `exit` exits the parent shell; use `return` instead (discovered via doppelganger failing to create directories) (3)
- Bootstrap imps (env-clear, invoke-thesaurus, invoke-wizardry) must use inline sourced-only checks, not call the uncastable imp, because they're sourced before PATH is properly set up (discovered via doppelganger compile failure)
- Sourced-only scripts (invoke-wizardry, env-clear, invoke-thesaurus) must use `return 0` not `exit 0` for normal completion to avoid exiting parent shell (2)
- Test helper imps that are sourced (skip-if-compiled) must define functions and use self-execute pattern, not use bare `exit` statements which exit the calling test
- When implementing a feature across "all items" (e.g., adding colors to all install-menu entries), systematically verify each item is covered rather than assuming completion - PR #874 added colors to core-status and tor-status, but mud-status was never created, leaving one menu item without colors.

- .imps/sys directory must be in PATH so system imps like require-wizardry are directly callable as commands (PR #594).
- Circular dependency during sourcing: imps must be available before spells call them; add all imp families to PATH before sourcing (PR #595).
- Scripts must verify prerequisites exist before calling them to avoid "command not found" errors during bootstrap (PR #596).
- Function return convention confusion (0=success, non-zero=failure) inverted in conditionals (is_first_word_blacklisted returning 0 for allowed led to `if` succeeding when shouldn't) requires careful attention and clarifying comments.
- When first-word glosses reconstruct multi-word synonyms (leap to location → leap-to-location), must pass the RECONSTRUCTED name to parse, not the original first word.
- Always use test-driven development to verify fixes before claiming they work; manual testing misses edge cases and creates false confidence.
- Consolidated AI documentation improves consistency by guaranteeing all critical information is read from a single entry point (PR #598).
- Sourcing a file with `set -eu` permanently affects the parent shell's mode; restore permissive mode with `set +eu` after sourcing (PR #599).
- macOS Terminal.app opens login shells by default, requiring .bash_profile to source .bashrc for shell configuration availability (PR #600).
- invoke-wizardry must auto-detect its location using shell-specific variables (BASH_SOURCE[0], ${(%):-%x}) instead of hardcoding $HOME/.wizardry (PR #601).
- RC file manipulation should use inline markers (. "/path" # wizardry: marker-name) instead of separate comment lines for consistent editing (PR #602).
- Menu exit handlers must validate parent PID exists before sending kill signals to prevent terminating unintended processes (PR #606).
- Always establish realistic unit tests for every feature BEFORE writing or fixing code; tests are the fastest path to working code and catch edge cases immediately.
- Default prompts for optional features should match expected common usage patterns (e.g., MUD defaults to "yes" for installation) (PR #607).
- Failed subtests must cause their parent test to fail; testing system integrity requires meta-tests that validate the testing infrastructure itself (PR #609).
- Compiled spells in doppelganger mode are standalone without invoke-wizardry/env-clear; tests must skip infrastructure-dependent checks in compiled mode (PR #610).
- Self-execute pattern case matching on $0 depends on path format; verify patterns match both relative and resolved absolute paths on all platforms (PR #611).
- Stub system requires strict PATH ordering with stub directory first to successfully override real commands with mocked versions (PR #612).
- Bubblewrap (bwrap) sandboxing compatibility varies by platform; graceful fallback ensures tests run successfully without sandboxing where unavailable (PR #613).
- Boolean logic with && || chains can cause unexpected early returns due to short-circuit evaluation; use explicit if-then-fi for clarity (PR #614).
- Testing system regressions are prevented by making test infrastructure itself testable with dedicated validation test files (PR #615).
- Pipe output buffering in pipelines requires explicit stdbuf -oL on all stages, not just the first command, to ensure line-by-line output (PR #616).
- Common structural tests should run by default for individual spell testing to ensure complete validation coverage (PR #617).
- Subprocess invocations must redirect stdin from /dev/null (< /dev/null) to prevent blocking if any subprocess attempts to read stdin (PR #619).
- Performance profiling infrastructure with --profile flag enables systematic identification of bottlenecks (e.g., common-tests.sh: 67s → 64s via grep reduction) (PR #622).
- Infinite recursion in command_not_found_handle requires a guard flag (_IN_CNF_HANDLER) to detect re-entry and prevent terminal hangs (PR #623).
- macOS login shell modifications (.zprofile sourcing .zshrc) must be tracked during install and completely removed during uninstall to prevent stale code (PR #624).
- Toggleable features in configuration files allow users to selectively disable functionality for isolating and debugging complex issues (PR #626).
- HTTP responses use CRLF (`\r\n`) line endings not LF (`\n`); strip carriage returns with `tr -d '\r'` before parsing headers or sed pattern `/^$/` won't match blank lines.
- CGI subprocess environment isolation: fcgiwrap spawns scripts without inheriting shell PATH; explicitly pass wizardry PATH via `env PATH="$FCGI_PATH" fcgiwrap` at server startup.
- Async promise completion must be awaited before dependent operations; SSE setup reading log file before avatar creation completes causes race conditions and missed events.
- Filesystem directory mtime has 1-second granularity AND count-based change detection misses simultaneous join/leave; use sorted member name signature for robust change detection.
- CGI script stdout pollution: commands like `enchant` that output success messages must redirect stdout (`>/dev/null 2>&1`) to prevent corrupting JSON responses.
- Button visibility logic must use consistent thresholds across all update paths; inconsistent conditions (count===0 vs count<=1) cause UI desync between clients.
- Installation cancellation or interruption should trigger cleanup of downloaded wizardry directory to avoid leaving partial installations (PR #627).
- Debug logging with timestamps, file paths, and success/failure counts helps diagnose complex shell initialization and sourcing issues (PR #629).
- Glob patterns stored in variables don't expand in POSIX sh; use `set -- "$dir"/*` to populate positional parameters for reliable shell glob expansion (PR #668).
- Negated assignment patterns `if ! var=$(cmd)` can trigger zsh parse errors when sourced; separate into assignment then condition for cross-shell compatibility (PR #669).
- AWK regex patterns in shell strings require double backslashes (\\) not quadruple (\\\\) for proper pattern escaping in extraction operations (PR #670).
- Bootstrap spells in `.arcana/core` run before wizardry installation and must not depend on wizardry imps (castable, require-wizardry, env-clear) (PR #672).
- Multi-cd shell patterns for path calculation (`cd dir1 && cd dir2`) create 2-3 extra process forks per execution; use parameter expansion ${var%/*} for significant performance improvement (PR #674).
- Always create realistic unit tests for every feature BEFORE writing or fixing code; tests are the fastest path to working code and catch edge cases immediately (TDD principle).
- Hyphenated spell names with uncastable pattern must have aliases generated (not just hyphenated synonyms) to prevent terminal crashes when typed directly by users.
- The sed command `/pattern/q` quits AFTER printing the matching line; use `/pattern/,$d` to delete from the pattern to end-of-file without including the pattern line itself.
- In sourced-only spells with `set -eu`, always do `set +eu` before every `return` statement to prevent shell options from leaking into the parent shell, which can cause unexpected behavior or terminal exits.
- In zsh (macOS default), `for m in $variable` doesn't word-split by default; use `for m in $(printf '%s\n' $variable)` to force word splitting in all shells (PR #909).
- Debug output showing iteration counts can quickly reveal word-splitting issues: if `all_markers="1 2 3"` iterates once instead of three times, word splitting is disabled (PR #909).
- When sourcing scripts into zsh shells, unquoted variables in for loops don't split; command substitution output always splits regardless of shell settings (PR #909).
- Hardcoded menu positions don't account for dynamic entries (like conditionally-shown submenus); use a position counter that increments for each menu item to keep selection stable when menu items appear/disappear.
- Install/uninstall scripts must verify the command is actually installed/removed after calling package manager; package managers can exit 0 even when skipping already-installed packages or refusing to remove system dependencies.
- macOS package management on "unaugmented" systems requires Homebrew support; check for `brew` before falling back to pkgin when detecting Darwin/macOS platform.
- htmx's morph extension (idiomorph) prevents flicker by intelligently diffing DOM trees and only updating changed nodes; use `hx-swap="morph" hx-ext="morph"` for smooth updates like poll results.
- Manual JavaScript innerHTML replacement causes flicker even with content comparison; prefer htmx's declarative swap strategies (`morph`, `innerHTML settle:0ms`) over manual DOM manipulation.
- For optimal UX, block buttons until visible effect occurs not just HTTP completion; move re-enable logic from `hx-on::after-request` to `htmx:afterSwap` on the updated element.
- htmx conditional triggers should check JavaScript variables before sending requests; `hx-vals='js:{param: window.var}'` sends `param=null` when var is null, causing CGI errors—conditionally enable/disable htmx triggers instead.
- Auto-scroll preservation in htmx requires tracking scroll position in `htmx:beforeSwap` and restoring in `htmx:afterSwap`; store `wasAtBottom` flag globally to decide whether to auto-scroll after DOM update.
- Dynamic htmx attributes (setAttribute + htmx.process) don't reliably initialize polling; use static htmx attributes with `hx-vals='js:{param: window.var}'` that evaluate at request time for robust behavior.
- Read operations should never mutate state; cleanup belongs in write operations.
- Time-based bugs make old working commits appear broken when tested later.
- Cleanup on every read can delete data before read completes.
- Directory mtime doesn't track file changes inside; use explicit xattr timestamps.
- Use enchant/read-magic for metadata instead of separate files.
- Move avatars between rooms; don't delete and recreate.
- Input validation must happen server-side; never trust client-side only.
- Display prefixes should not be stored in data; strip when reading for API.
- System messages need duplicate detection to prevent spam.

### SSE/Server-Sent Events and Buffering (PR #implement-sse-for-chatroom)

- Server-Sent Events require `Content-Type: text/event-stream` header and `Cache-Control: no-cache` to prevent caching/buffering at HTTP layer.
- SSE event format is `event: name\ndata: content\n\n` (double newline terminates event); padding can be added as SSE comments `: padding\n`.
- fcgiwrap on macOS has ~8KB output buffer; events smaller than buffer threshold get batched together until buffer fills.
- Adding padding to SSE events (8KB of spaces as comment) forces buffer to exceed threshold, triggering immediate flush per event.
- Shell stdout is ALSO buffered independently of fcgiwrap; `printf | cat` creates pipe that should force flush but may not work reliably.
- The `dd conv=fsync` command forces kernel-level filesystem sync, flushing all buffering layers (shell, C library, kernel).
- Multiple buffering layers exist: application (stdio), shell (stdout), fcgiwrap, nginx (fastcgi), kernel (page cache), disk controller.
- Nginx `fastcgi_buffering off` directive disables nginx-level buffering but doesn't affect lower layers (fcgiwrap, shell, kernel).
- When "next message triggers delivery of previous message", suspect event-boundary buffering where new event flushes previous buffered event.
- File system write buffering (kernel page cache) can delay when appended data becomes visible to other processes reading the same file.
- The `sync` command forces kernel to flush dirty pages to disk, making file writes immediately visible to all processes (critical for log files).
- Testing revealed buffering at SEVEN layers: fcgiwrap buffer (~8KB), shell stdout buffer, nginx fastcgi buffer, kernel page cache, C library buffer, file descriptor buffer, disk controller buffer.
- Padding size must EXCEED the buffer threshold to trigger flush; 512 bytes < 2KB < 8KB all failed because fcgiwrap buffer is ~8KB on macOS.
- Pre-generating padding strings (with awk) is vastly more efficient than generating padding in loops (2048 printf calls vs 1 awk call).
- The symptom "always 1 message behind" where next write flushes previous write indicates buffering at write-boundary level, not within-write level.
- File append operations (`>>`) buffer writes in kernel page cache; reads don't see new data until kernel flushes or explicit `sync` is called.
- Adding heartbeat/comment events immediately after message events attempts to force flush but may fail if both events are buffered together as one unit.
- SSE over CGI requires defeating multiple independent buffering layers; fixing one layer (e.g., fcgiwrap) doesn't solve others (e.g., file system).
- When all flush attempts fail, the buffering may be happening outside CGI script control (nginx config, fcgiwrap startup flags, OS settings).
- File descriptor redirection avoids subshell buffering in POSIX shell - `exec 3< fifo; while read <&3` keeps loop in main shell, unlike pipes which create subshells.
- 32KB padding forces fcgiwrap/nginx buffer overflow for instant SSE delivery - Buffer size must exceed fcgiwrap (~8KB) + nginx (~16-32KB) = minimum 32KB total.
- Flush placement matters: padding BEFORE event is more reliable than after - Pre-flush primes buffers for immediate event delivery.
- SSE comment padding is protocol-compliant, not a hack - `: comment` is valid SSE syntax, browsers ignore, zero client overhead.
- Avatar directories are single source of truth for membership - No redundant .members file, use chat-list-avatars imp to scan directories on-demand.
- Room directory mtime detects avatar joins/leaves without polling files - stat() room directory, mtime changes when avatar directory added/removed.
- True event-driven SSE is possible in pure POSIX shell using tail -f + file descriptors - Contrary to initial assumptions, FD redirection avoids subshell creation.
- Always test assumptions about subshells empirically - What "should" create a subshell may not in practice.
- When debugging buffering, look for next message triggering previous delivery - Classic sign of buffer waiting for flush trigger.
- fcgiwrap/nginx/browser is a multi-layer buffering chain - Must exceed ALL buffer sizes combined, not individual layers.
- Shell file append (`>>`) buffers output until script exits - Wrap writes in subshell `(printf >> file)` to force immediate buffer flush for tail -f visibility.
- 4KB padding works for SSE despite smaller than total buffer size - Write sequence (padding + event + padding) triggers flush mechanism, not just overflow.
- 2KB padding causes batching in SSE delivery (too small for reliable flush) - Testing confirmed 4KB is minimum threshold to trigger flush mechanism consistently.
- 4KB is confirmed minimum for instant SSE delivery over fcgiwrap/nginx - Smaller sizes (2KB, 1KB) cause batching; 4KB provides 83% bandwidth reduction while maintaining reliability.
- Functions defined in sourced files (like cd() in load-cd-hook) must save shell options at function entry and restore before ALL return paths (success and error) to prevent corrupting the user's shell state.
- Variable names must not begin with underscore (against project policy) - use descriptive names like `cd_saved_opts` not `_cd_saved_opts` to match existing codebase patterns.
- Overriding builtin commands with functions breaks shell tab completion - attempting to restore it from scripts causes more problems than it solves (readline corruption, invisible characters).
- NEVER call `bind` from sourced scripts - it corrupts readline state causing arrow keys to show escape sequences (^[[A) and breaking all line editing.
- NEVER set up completion from sourced scripts - custom completion functions, complete flags, and compdef can all break readline; let bash use default completion.
- NEVER use `set -u` in sourced scripts - it stays active in user's shell and breaks readline (arrow keys, tab completion) because readline uses unset internal variables.
- ALL files sourced into user's interactive shell MUST explicitly `set +eu` at end - environment setup scripts (invoke-wizardry, load-cd-hook, load-touch-hook) cannot restore user's pre-invocation options; PR #1053 regression broke readline by restoring strict modes.
- Scripts that CAN BE sourced (even if usually executed) should use permissive mode - listen spell is sourced by cd function when cd-listen=1, so `set -eu` breaks readline; use `set +eu` instead.
- Nested save/restore of shell options causes insidious bugs - if outer script restores opts after inner script, the inner script's changes get undone, potentially re-enabling harmful strict modes.
- macOS bash colored completion rendering bugs cannot be fixed from scripts - users must set `colored-stats off` in ~/.inputrc, not via bind commands or script-based workarounds.
- When defining bash-specific functions in POSIX sh scripts, wrap with eval to avoid syntax errors in sh - `eval 'function_name() { bash syntax }'` works in both sh and bash.
