name: Test Doppelganger Compiled Wizardry

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  compile-and-test-doppelganger:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install wizardry
        run: |
          # Add wizardry to PATH for compilation
          echo "${{ github.workspace }}/spells" >> $GITHUB_PATH
          echo "${{ github.workspace }}/spells/cantrips" >> $GITHUB_PATH
          echo "${{ github.workspace }}/spells/spellcraft" >> $GITHUB_PATH
          
          # Source invoke-wizardry to set up environment
          export WIZARDRY_DIR="${{ github.workspace }}"
          . "${{ github.workspace }}/spells/.imps/sys/invoke-wizardry"
      
      - name: Create doppelganger
        run: |
          export WIZARDRY_DIR="${{ github.workspace }}"
          . "${{ github.workspace }}/spells/.imps/sys/invoke-wizardry"
          
          # Create doppelganger in /tmp
          doppelganger /tmp/wizardry-doppelganger
          
          echo "=== Doppelganger created ==="
          ls -la /tmp/wizardry-doppelganger/
          echo ""
          echo "=== Spells directory ==="
          ls -la /tmp/wizardry-doppelganger/spells/ | head -20
      
      - name: Test doppelganger spells
        run: |
          passed=0
          failed=0
          total=0
          
          echo "=== Testing doppelganger spells ==="
          
          # Exclusions (wizardry infrastructure)
          excluded="invoke-wizardry require-wizardry declare-globals learn-spellbook learn mud decorate select-player"
          
          # Test all compiled spells
          find /tmp/wizardry-doppelganger/spells -type f -executable | while IFS= read -r compiled; do
            [ -f "$compiled" ] || continue
            spell_name=$(basename "$compiled")
            
            # Skip excluded
            skip=0
            for ex in $excluded; do
              if [ "$spell_name" = "$ex" ]; then
                skip=1
                break
              fi
            done
            [ "$skip" = "1" ] && continue
            
            # Determine if imp or spell
            is_imp=0
            case "$compiled" in
              */.imps/*) is_imp=1 ;;
            esac
            
            # Test appropriately
            if [ "$is_imp" = "1" ]; then
              # Imps: test with empty stdin
              if echo "" | timeout 1 env -i PATH="/usr/bin:/bin" "$compiled" >/dev/null 2>&1; then
                echo "  ✓ $spell_name"
                passed=$((passed + 1))
              else
                ec=$?
                if [ "$ec" != "124" ]; then
                  echo "  ✓ $spell_name (exit $ec OK)"
                  passed=$((passed + 1))
                else
                  echo "  ✗ $spell_name (timeout)"
                  failed=$((failed + 1))
                fi
              fi
            else
              # Spells: test --help
              if timeout 2 env -i PATH="/usr/bin:/bin" "$compiled" --help >/dev/null 2>&1; then
                echo "  ✓ $spell_name"
                passed=$((passed + 1))
              else
                echo "  ✗ $spell_name"
                failed=$((failed + 1))
              fi
            fi
            
            total=$((total + 1))
          done
          
          # Note: we can't pass variables out of the while loop subshell easily
          # So we re-count for final summary
          echo ""
          echo "=== Test Summary ==="
          total_files=$(find /tmp/wizardry-doppelganger/spells -type f -executable | wc -l)
          echo "Total compiled files: $total_files"
          echo "(Individual results shown above)"
      
      - name: Run doppelganger tests
        if: success()
        run: |
          # If test files exist, run them against doppelganger
          if [ -d "/tmp/wizardry-doppelganger/.tests" ]; then
            echo "=== Running doppelganger test suite ==="
            cd /tmp/wizardry-doppelganger
            
            # Add doppelganger spells to PATH
            export PATH="/tmp/wizardry-doppelganger/spells:$PATH"
            export PATH="/tmp/wizardry-doppelganger/spells/cantrips:$PATH"
            
            # Run a sample of tests (not all, since many require full wizardry)
            find .tests -name "test_*.sh" -type f | head -5 | while read -r test; do
              echo "Running: $test"
              sh "$test" 2>&1 | head -20 || true
              echo ""
            done
          fi
      
      - name: Create doppelganger zip
        if: success()
        run: |
          cd /tmp
          zip -r wizardry-doppelganger-${{ github.sha }}.zip wizardry-doppelganger \
            -x "wizardry-doppelganger/.git/*" \
            -x "wizardry-doppelganger/.github/*"
          
          echo "=== Zip created ==="
          ls -lh wizardry-doppelganger-*.zip
      
      - name: Upload doppelganger artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: wizardry-doppelganger-${{ github.sha }}
          path: /tmp/wizardry-doppelganger-${{ github.sha }}.zip
          retention-days: 720
      
      - name: Clean up old artifacts
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // Get all artifacts for this repo
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // Filter for doppelganger artifacts, sort by creation date
            const doppelgangerArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('wizardry-doppelganger-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            console.log(`Found ${doppelgangerArtifacts.length} doppelganger artifacts`);
            
            // Keep only the last 3, delete the rest
            const toDelete = doppelgangerArtifacts.slice(3);
            
            for (const artifact of toDelete) {
              console.log(`Deleting old artifact: ${artifact.name} (created ${artifact.created_at})`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              } catch (error) {
                console.log(`Failed to delete ${artifact.name}: ${error.message}`);
              }
            }
            
            console.log(`Kept ${Math.min(3, doppelgangerArtifacts.length)} most recent artifacts`);
