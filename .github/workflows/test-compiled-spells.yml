name: Test compiled spells

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test-compiled:
    name: Test compiled spell execution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up wizardry
        run: |
          export WIZARDRY_DIR="${GITHUB_WORKSPACE}"
          . ./spells/.imps/sys/invoke-wizardry
          echo "PATH=$PATH" >> "$GITHUB_ENV"
          echo "WIZARDRY_DIR=$WIZARDRY_DIR" >> "$GITHUB_ENV"
      
      - name: Create output directory
        run: mkdir -p /tmp/compiled
      
      - name: Compile all spells
        id: compile
        run: |
          . ./spells/.imps/sys/invoke-wizardry
          
          compiled=0
          failed=0
          failed_list=""
          
          echo "=== Compiling all spells ==="
          
          # Find all spells recursively (excluding .imps and .arcana)
          # Use a temp file to collect failures since subshell won't persist variables
          tmpfile="/tmp/failed_spells.txt"
          : > "$tmpfile"
          
          find spells -type f -executable \
            ! -path "spells/.imps/*" \
            ! -path "spells/.arcana/*" | while IFS= read -r spell_file; do
            
            spell_name=$(basename "$spell_file")
            
            # Compile the spell
            if compile-spell "$spell_name" > "/tmp/compiled/${spell_name}" 2>/dev/null; then
              chmod +x "/tmp/compiled/${spell_name}"
              echo "  ✓ $spell_name"
            else
              echo "$spell_name" >> "$tmpfile"
              echo "  ✗ $spell_name"
            fi
          done
          
          # Count results
          compiled=$(find /tmp/compiled -type f 2>/dev/null | wc -l)
          failed=$(wc -l < "$tmpfile" 2>/dev/null || echo 0)
          
          echo ""
          echo "Compiled: $compiled"
          echo "Failed: $failed"
          
          if [ "$failed" -gt 0 ]; then
            # Build comma-delimited list
            failed_list=$(tr '\n' ',' < "$tmpfile" | sed 's/,$//')
            echo "FAILED_COMPILE=$failed_list" >> "$GITHUB_OUTPUT"
            echo ""
            echo "Failed to compile: $failed_list"
            exit 1
          fi
      
      - name: Test compiled spells standalone
        if: success()
        id: test
        run: |
          passed=0
          failed=0
          
          echo "=== Testing compiled spells in isolation ==="
          
          # Use temp file for failures
          tmpfile="/tmp/failed_tests.txt"
          : > "$tmpfile"
          
          # Test each compiled spell with minimal PATH
          for compiled in /tmp/compiled/*; do
            [ -f "$compiled" ] || continue
            spell_name=$(basename "$compiled")
            
            # Test --help in isolated environment
            if env -i PATH="/usr/bin:/bin" "$compiled" --help >/dev/null 2>&1; then
              echo "  ✓ $spell_name"
            else
              echo "$spell_name" >> "$tmpfile"
              echo "  ✗ $spell_name (requires dependencies)"
            fi
          done
          
          # Count results
          passed=$(find /tmp/compiled -type f 2>/dev/null | wc -l)
          failed=$(wc -l < "$tmpfile" 2>/dev/null || echo 0)
          passed=$((passed - failed))
          
          echo ""
          echo "Passed: $passed"
          echo "Failed: $failed"
          
          if [ "$failed" -gt 0 ]; then
            # Build comma-delimited list
            failed_list=$(tr '\n' ',' < "$tmpfile" | sed 's/,$//')
            echo "FAILED_TESTS=$failed_list" >> "$GITHUB_OUTPUT"
            echo ""
            echo "Failed tests (comma-delimited): $failed_list"
            exit 1
          fi
      
      - name: Report failures
        if: failure()
        run: |
          echo "=== COMPILATION AND TEST FAILURES ==="
          echo ""
          if [ -n "${{ steps.compile.outputs.FAILED_COMPILE }}" ]; then
            echo "Failed to compile:"
            echo "${{ steps.compile.outputs.FAILED_COMPILE }}"
            echo ""
          fi
          if [ -n "${{ steps.test.outputs.FAILED_TESTS }}" ]; then
            echo "Failed standalone tests:"
            echo "${{ steps.test.outputs.FAILED_TESTS }}"
            echo ""
          fi
          echo "Copy-paste ready list:"
          echo "${{ steps.compile.outputs.FAILED_COMPILE }}${{ steps.test.outputs.FAILED_TESTS }}"
