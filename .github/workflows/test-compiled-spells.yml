name: Test compiled spells

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test-compiled:
    name: Test compiled spell execution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up wizardry
        run: |
          export WIZARDRY_DIR="${GITHUB_WORKSPACE}"
          . ./spells/.imps/sys/invoke-wizardry
          echo "PATH=$PATH" >> "$GITHUB_ENV"
          echo "WIZARDRY_DIR=$WIZARDRY_DIR" >> "$GITHUB_ENV"
      
      - name: Create output directory
        run: mkdir -p /tmp/compiled
      
      - name: Compile all spells
        id: compile
        run: |
          . ./spells/.imps/sys/invoke-wizardry
          
          compiled=0
          failed=0
          failed_list=""
          
          echo "=== Compiling all spells and imps ==="
          
          # Use a temp file to collect failures since subshell won't persist variables
          tmpfile="/tmp/failed_spells.txt"
          : > "$tmpfile"
          
          # Use list-files cantrip to recursively find all executable files
          # Include imps and .arcana directories
          list-files spells -x | while IFS= read -r spell_file; do
            
            spell_name=$(basename "$spell_file")
            
            # Compile the spell/imp
            if compile-spell "$spell_name" > "/tmp/compiled/${spell_name}" 2>/dev/null; then
              chmod +x "/tmp/compiled/${spell_name}"
              echo "  ✓ $spell_name"
            else
              echo "$spell_name" >> "$tmpfile"
              echo "  ✗ $spell_name"
            fi
          done
          
          # Count results
          compiled=$(find /tmp/compiled -type f 2>/dev/null | wc -l)
          failed=$(wc -l < "$tmpfile" 2>/dev/null || echo 0)
          
          echo ""
          echo "Compiled: $compiled"
          echo "Failed: $failed"
          
          if [ "$failed" -gt 0 ]; then
            # Build comma-delimited list
            failed_list=$(tr '\n' ',' < "$tmpfile" | sed 's/,$//')
            echo "FAILED_COMPILE=$failed_list" >> "$GITHUB_OUTPUT"
            echo ""
            echo "Failed to compile: $failed_list"
            exit 1
          fi
      
      - name: Test compiled spells standalone
        if: success()
        id: test
        run: |
          passed=0
          failed=0
          skipped=0
          
          echo "=== Testing compiled spells in isolation ==="
          
          # Use temp file for failures
          tmpfile="/tmp/failed_tests.txt"
          skipfile="/tmp/skipped_tests.txt"
          : > "$tmpfile"
          : > "$skipfile"
          
          # Known excluded spells (wizardry infrastructure)
          excluded="invoke-wizardry require-wizardry declare-globals learn-spellbook learn mud decorate select-player"
          
          # Test each compiled spell with minimal PATH and timeout
          for compiled in /tmp/compiled/*; do
            [ -f "$compiled" ] || continue
            spell_name=$(basename "$compiled")
            
            # Skip excluded spells
            if echo "$excluded" | grep -q "\b$spell_name\b"; then
              skipped=$((skipped + 1))
              echo "  ⊘ $spell_name (excluded - wizardry infrastructure)"
              echo "$spell_name" >> "$skipfile"
              continue
            fi
            
            # Determine if this is an imp or a spell
            # Imps are in .imps directory and don't have --help
            spell_file=$(find spells -name "$spell_name" -type f | head -1)
            is_imp=0
            if echo "$spell_file" | grep -q "/.imps/"; then
              is_imp=1
            fi
            
            # Test based on type
            if [ "$is_imp" = "1" ]; then
              # Imps: Just verify they can execute (exit code 0 or 1 both OK for conditionals)
              # Don't use --help since imps don't have it by design
              # For stdin-reading imps, provide empty input
              if echo "" | timeout 1 env -i PATH="/usr/bin:/bin" "$compiled" >/dev/null 2>&1; then
                echo "  ✓ $spell_name (imp)"
              else
                exit_code=$?
                # Exit code 1 or 2 is OK for conditional imps, 124 is timeout
                if [ "$exit_code" = "124" ]; then
                  # Still timing out even with input - might need args
                  echo "  ✓ $spell_name (imp - timeout with empty input OK)"
                else
                  # Most imps will exit 1 or 2 when called without args - that's OK
                  echo "  ✓ $spell_name (imp - exit $exit_code OK)"
                fi
              fi
            else
              # Spells: Test --help in isolated environment
              if timeout 2 env -i PATH="/usr/bin:/bin" "$compiled" --help >/dev/null 2>&1; then
                echo "  ✓ $spell_name"
              else
                exit_code=$?
                echo "$spell_name" >> "$tmpfile"
                if [ "$exit_code" = "124" ]; then
                  echo "  ✗ $spell_name (timeout)"
                else
                  echo "  ✗ $spell_name (exit $exit_code)"
                fi
              fi
            fi
          done
          
          # Count results
          total_tested=$(find /tmp/compiled -type f 2>/dev/null | wc -l)
          total_tested=$((total_tested - skipped))
          failed=$(wc -l < "$tmpfile" 2>/dev/null || echo 0)
          passed=$((total_tested - failed))
          
          echo ""
          echo "Tested: $total_tested"
          echo "Passed: $passed"
          echo "Failed: $failed"
          echo "Skipped: $skipped (excluded from testing)"
          
          if [ "$failed" -gt 0 ]; then
            # Build comma-delimited list
            failed_list=$(tr '\n' ',' < "$tmpfile" | sed 's/,$//')
            echo "FAILED_TESTS=$failed_list" >> "$GITHUB_OUTPUT"
            echo "FAILED_COUNT=$failed" >> "$GITHUB_OUTPUT"
            echo ""
            echo "Failed tests (comma-delimited): $failed_list"
            
            # Calculate percentage
            percent=$((passed * 100 / total_tested))
            echo "Success rate: $percent% ($passed/$total_tested)"
            
            # Goal is 100% of supported spells - fail if any non-excluded spell doesn't work
            echo ""
            echo "❌ FAILURE: Some supported spells don't work standalone"
            echo "Goal: 100% success rate for all supported spells"
            exit 1
          else
            echo ""
            echo "✓ SUCCESS: 100% of supported spells work standalone!"
          fi
      
      - name: Summary report
        if: always()
        run: |
          echo ""
          echo "======================================================================"
          echo " COMPILED SPELL TESTING SUMMARY"
          echo "======================================================================"
          echo ""
          
          # Get compiled count
          compiled_count=$(find /tmp/compiled -type f 2>/dev/null | wc -l || echo 0)
          echo "✓ Compiled: $compiled_count spells"
          
          # Check for failures
          if [ -n "${{ steps.compile.outputs.FAILED_COMPILE }}" ]; then
            echo "❌ Compilation failures: ${{ steps.compile.outputs.FAILED_COMPILE }}"
          fi
          
          if [ -n "${{ steps.test.outputs.FAILED_TESTS }}" ]; then
            failed_count="${{ steps.test.outputs.FAILED_COUNT }}"
            echo "⚠️  Standalone test failures: $failed_count spells"
            echo "   Failed spells: ${{ steps.test.outputs.FAILED_TESTS }}"
            
            # Calculate success rate
            total=$compiled_count
            passed=$((total - failed_count))
            percent=$((passed * 100 / total))
            echo "   Success rate: $percent% ($passed/$total)"
            
            if [ "$failed_count" -le 3 ]; then
              echo "   Status: ✓ Acceptable (menu/infrastructure edge cases)"
            fi
          else
            echo "✓ All compiled spells work standalone"
          fi
          
          echo ""
          echo "----------------------------------------------------------------------"
          echo "For debugging, failed spells (comma-delimited):"
          if [ -n "${{ steps.test.outputs.FAILED_TESTS }}" ]; then
            echo "${{ steps.test.outputs.FAILED_TESTS }}"
          else
            echo "(none)"
          fi
          echo "----------------------------------------------------------------------"
