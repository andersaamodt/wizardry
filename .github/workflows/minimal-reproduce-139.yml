name: Minimal Reproduction - Exit 139 on Arch/Ubuntu

# This workflow contains individually-numbered tests to isolate the cause
# of exit code 139 on Arch/Ubuntu (distinct from NixOS declare() bug)

on:
  pull_request:
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: minimal-139-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Test #86: && chaining with invoke-wizardry + banish (expected to crash)
  test-86-and-chaining:
    if: false  # Disabled - already analyzed
    name: "#86: && chaining (reproduce crash)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test && chaining
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing && chaining with invoke-wizardry and banish..."
          . spells/.imps/sys/invoke-wizardry && banish 4

  # Test #87: Separate lines without && (test if this avoids crash)
  test-87-separate-lines:
    if: false  # Disabled - already analyzed
    name: "#87: Separate lines (no &&)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test separate lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing separate lines without && chaining..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # Test #88: Semicolon separator (test alternative to &&)
  test-88-semicolon:
    if: false  # Disabled - already analyzed
    name: "#88: Semicolon separator"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test semicolon separator
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing semicolon separator..."
          . spells/.imps/sys/invoke-wizardry; banish 4

  # Test #89: Script wrapper approach
  test-89-script-wrapper:
    if: false  # Disabled - already analyzed
    name: "#89: Script wrapper"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create test script
        run: |
          cat > /tmp/test-banish.sh <<'SCRIPT'
          #!/bin/sh
          export WIZARDRY_DIR="${1}"
          . "${WIZARDRY_DIR}/spells/.imps/sys/invoke-wizardry"
          banish 4
          SCRIPT
          chmod +x /tmp/test-banish.sh
      
      - name: Run test script
        run: /tmp/test-banish.sh "${PWD}"

  # Test #90: Minimal banish without invoke-wizardry
  test-90-banish-standalone:
    if: false  # Disabled - already analyzed
    name: "#90: Banish without invoke-wizardry"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test banish standalone
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing banish standalone (source banish directly)..."
          # Source banish directly without invoke-wizardry
          . spells/.imps/ops/banish
          echo "Banish function loaded, now calling it..."
          banish 4

  # Test #91: Test with different banish levels
  test-91-banish-levels:
    if: false  # Disabled - already analyzed
    name: "#91: Different banish levels"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test banish 1
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 1..."
          banish 1
      
      - name: Test banish 2
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 2..."
          banish 2
      
      - name: Test banish 3
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 3..."
          banish 3

  # Test #92: Test on Arch Linux specifically
  test-92-arch-linux:
    if: false  # Disabled - already analyzed
    name: "#92: Arch Linux test"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install git
        run: pacman -Sy --noconfirm git
      
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test invoke-wizardry + banish on Arch
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing on Arch Linux..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # Test #93: Test with bash tracing enabled
  test-93-bash-tracing:
    if: false  # Disabled - already analyzed
    name: "#93: With bash tracing"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test with tracing
        run: |
          set -x
          export WIZARDRY_DIR="${PWD}"
          echo "Testing with bash tracing..."
          . spells/.imps/sys/invoke-wizardry
          echo "invoke-wizardry sourced"
          banish 4
          echo "banish completed"

  # Test #94: Test with minimal environment
  test-94-minimal-env:
    if: false  # Disabled - already analyzed
    name: "#94: Minimal environment"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test in minimal env
        run: |
          env -i PWD="${PWD}" HOME="${HOME}" PATH="/usr/bin:/bin" sh -c '
            export WIZARDRY_DIR="${PWD}"
            . spells/.imps/sys/invoke-wizardry
            banish 4
          '

  # Test #95: Test without generating glosses
  test-95-no-glosses:
    if: false  # Disabled - already analyzed
    name: "#95: Without gloss generation"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test without glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          export WIZARDRY_NO_GLOSSES=1
          echo "Testing without gloss generation..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # NixOS-specific tests - narrow down the line ranges that cause segfault
  # Based on PR #940 investigation that narrowed to Decile 9 (lines 12807-12840)
  
  test-96-nix-decile-9:
    if: false  # Disabled - already analyzed
    name: "#96: NixOS - Decile 9 (lines 12807-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh
          # Extract functions starting in lines 12807-12840
          awk -v start="12807" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 glosses:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 completed without crash'
          "

  test-97-nix-decile-9-sub-1:
    if: false  # Disabled - already analyzed
    name: "#97: NixOS - Decile 9 Sub 1 (lines 12807-12820)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9 Sub 1
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          # Extract functions starting in lines 12807-12820 (first half)
          awk -v start="12807" -v end="12820" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 Sub 1:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9 Sub 1
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 Sub 1 completed'
          "

  test-98-nix-decile-9-sub-2:
    if: false  # Disabled - already analyzed
    name: "#98: NixOS - Decile 9 Sub 2 (lines 12821-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9 Sub 2
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          # Extract functions starting in lines 12821-12840 (second half)
          awk -v start="12821" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 Sub 2:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9 Sub 2
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 Sub 2 completed'
          "

  test-99-nix-full-glosses:
    if: false  # Disabled - already analyzed
    name: "#99: NixOS - Full glosses (baseline test)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate full glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh

      - name: Source full glosses (expected to crash with exit 139)
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_full.sh
            echo 'SUCCESS! Full glosses completed (if this prints, bug is fixed!)'
          "

  # New hypotheses based on test results analysis
  
  # H1: Test if invoke-wizardry itself crashes without calling any functions
  test-100-invoke-only:
    name: "#100: Invoke-wizardry only (no function calls)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source invoke-wizardry without calling functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing invoke-wizardry without calling any functions..."
          . spells/.imps/sys/invoke-wizardry
          echo "SUCCESS! invoke-wizardry sourced without crash"

  # H2: Test calling a simple imp function (not banish) after invoke-wizardry
  test-101-invoke-then-say:
    name: "#101: Invoke + call 'say' function"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source invoke-wizardry and call say
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry + say..."
          . spells/.imps/sys/invoke-wizardry
          say "Test message"
          echo "SUCCESS! say function worked"

  # H3: Test if the crash happens with just PATH modification
  test-102-path-only:
    name: "#102: Manual PATH setup (no invoke-wizardry)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Manually set PATH and call banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          export PATH="${WIZARDRY_DIR}/spells/.glossary:${PATH}"
          echo "Calling banish via PATH without invoke-wizardry..."
          banish 4
          echo "SUCCESS! banish worked via PATH alone"

  # H4: Test sourcing individual imps without invoke-wizardry
  test-103-source-imps-directly:
    name: "#103: Source imps directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source imps directly
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing imps directly..."
          . spells/.imps/out/say
          . spells/.imps/wards/banish
          echo "Calling banish..."
          banish 4
          echo "SUCCESS! Direct imp sourcing worked"

  # H5: Test if it's the combination of glosses + invoke-wizardry
  test-104-glosses-without-invoke:
    name: "#104: Source glosses without invoke-wizardry"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and source glosses directly
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          echo "Sourcing glosses without invoke-wizardry..."
          . /tmp/glosses.sh
          echo "Calling banish..."
          banish 4
          echo "SUCCESS! Glosses worked without invoke-wizardry"

  # H6: NixOS - Narrow to lines 12827-12833 (middle of Sub 2)
  test-105-nix-decile-9-sub-2a:
    name: "#105: NixOS - Decile 9 Sub 2a (lines 12821-12827)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2a
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12821" -v end="12827" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2a:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2a
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2a completed'
          "

  # H7: NixOS - Narrow to lines 12828-12834 (second half of Sub 2)
  test-106-nix-decile-9-sub-2b:
    name: "#106: NixOS - Decile 9 Sub 2b (lines 12828-12834)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2b
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12828" -v end="12834" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2b:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2b
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2b completed'
          "

  # H8: NixOS - Narrow to lines 12835-12840 (last part of Sub 2)
  test-107-nix-decile-9-sub-2c:
    name: "#107: NixOS - Decile 9 Sub 2c (lines 12835-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2c
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12835" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2c:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2c
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2c completed'
          "

  # New hypotheses based on #100-#107 results
  # CRITICAL: #104 crashed - glosses WITHOUT invoke-wizardry crash!
  # This means the bug is in glosses themselves, NOT invoke-wizardry

  # H1: Test with minimal glosses (just first 5 complete functions)
  test-108-minimal-glosses:
    name: "#108: Minimal glosses (first 5 functions)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and extract first 5 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          echo "Full glosses lines:"
          wc -l /tmp/glosses_full.sh
          # Extract first 5 complete functions
          awk '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= 5) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_minimal.sh
          echo "Minimal glosses lines:"
          wc -l /tmp/glosses_minimal.sh

      - name: Source minimal glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing minimal glosses..."
          . /tmp/glosses_minimal.sh
          echo "SUCCESS! Minimal glosses worked"

  # H2: Test with medium-sized glosses (first 50 functions)
  test-109-medium-glosses:
    name: "#109: Medium glosses (first 50 functions)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and extract first 50 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh
          # Extract first 50 complete functions
          awk '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= 50) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_medium.sh
          echo "Medium glosses lines:"
          wc -l /tmp/glosses_medium.sh

      - name: Source medium glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing medium glosses..."
          . /tmp/glosses_medium.sh
          echo "SUCCESS! Medium glosses worked"

  # H3: Test with large glosses (first 100 functions)
  test-110-large-glosses:
    name: "#110: Large glosses (first 100 functions)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and extract first 100 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh
          # Extract first 100 complete functions
          awk '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= 100) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_large.sh
          echo "Large glosses lines:"
          wc -l /tmp/glosses_large.sh

      - name: Source large glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing large glosses..."
          . /tmp/glosses_large.sh
          echo "SUCCESS! Large glosses worked"

  # H4: Test with glosses minus last 10 functions (see if it's at the end)
  test-111-glosses-minus-tail:
    name: "#111: Glosses without last 10 functions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and remove last 10 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          # Count total functions
          total_funcs=$(grep -c '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_full.sh)
          echo "Total functions: $total_funcs"
          target_funcs=$((total_funcs - 10))
          echo "Extracting first $target_funcs functions"
          # Extract all but last 10 functions
          awk -v max="$target_funcs" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= max) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_no_tail.sh
          echo "Without tail lines:"
          wc -l /tmp/glosses_no_tail.sh

      - name: Source glosses without tail
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing glosses without tail..."
          . /tmp/glosses_no_tail.sh
          echo "SUCCESS! Glosses without tail worked"

  # H5: NixOS - Further narrow Sub 2a into halves (lines 12821-12824 vs 12825-12827)
  test-112-nix-sub-2a-first-half:
    name: "#112: NixOS - Sub 2a first half (lines 12821-12824)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2a first half
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12821" -v end="12824" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2a first half:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2a first half
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2a first half completed'
          "

  # H6: NixOS - Sub 2a second half (lines 12825-12827)
  test-113-nix-sub-2a-second-half:
    name: "#113: NixOS - Sub 2a second half (lines 12825-12827)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2a second half
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12825" -v end="12827" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2a second half:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2a second half
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2a second half completed'
          "

  # H7: Test sourcing glosses in sh (not bash) to see if it's bash-specific
  test-114-glosses-with-sh:
    name: "#114: Source glosses with /bin/sh instead of bash"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh

      - name: Source glosses with sh
        shell: sh -e {0}
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing glosses with /bin/sh..."
          . /tmp/glosses_full.sh
          echo "SUCCESS! Glosses worked with sh"

  # H8: Print actual function names from problematic NixOS range
  test-115-nix-identify-functions:
    name: "#115: NixOS - Identify function names in lines 12821-12827"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Identify functions in problematic range
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          echo "=== Functions starting in lines 12821-12827 ==="
          awk 'NR>=12821 && NR<=12827 && /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {print NR": "$0}' /tmp/glosses_full.sh
          echo "=== Full content of lines 12821-12827 ==="
          sed -n '12821,12827p' /tmp/glosses_full.sh
          echo "=== SUCCESS - Identification complete ==="

  # New tests based on #112 crash (lines 12821-12824 confirmed problematic)
  
  # H9: NixOS - Test lines 12821-12822 (first half of the 4-line range)
  test-116-nix-12821-12822:
    name: "#116: NixOS - Lines 12821-12822 (first pair)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract lines 12821-12822
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12821" -v end="12822" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted lines 12821-12822:"
          wc -l /tmp/glosses_decile.sh

      - name: Test lines 12821-12822
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Lines 12821-12822 completed'
          "

  # H10: NixOS - Test lines 12823-12824 (second half of the 4-line range)
  test-117-nix-12823-12824:
    name: "#117: NixOS - Lines 12823-12824 (second pair)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract lines 12823-12824
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12823" -v end="12824" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted lines 12823-12824:"
          wc -l /tmp/glosses_decile.sh

      - name: Test lines 12823-12824
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Lines 12823-12824 completed'
          "

  # H11: NixOS - Test just line 12821 (single function test)
  test-118-nix-12821-only:
    name: "#118: NixOS - Line 12821 only (single line)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract line 12821 only
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v target="12821" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start == target) {
                  printf "%s", func_lines
                  exit
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted line 12821 only:"
          wc -l /tmp/glosses_decile.sh
          echo "Function content:"
          cat /tmp/glosses_decile.sh

      - name: Test line 12821 only
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Line 12821 completed'
          "

  # H12: Arch/Ubuntu - Test with 150 functions (between 100 and all)
  test-119-150-functions:
    name: "#119: Arch/Ubuntu - 150 functions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and extract first 150 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          total_funcs=$(grep -c '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_full.sh)
          echo "Total functions: $total_funcs"
          # Extract first 150 complete functions
          awk '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= 150) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_150.sh
          echo "150 functions extracted:"
          wc -l /tmp/glosses_150.sh

      - name: Source 150 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing 150 functions..."
          . /tmp/glosses_150.sh
          echo "SUCCESS! 150 functions worked"

  # H13: Arch/Ubuntu - Test with 200 functions (even larger)
  test-120-200-functions:
    name: "#120: Arch/Ubuntu - 200 functions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and extract first 200 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          total_funcs=$(grep -c '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_full.sh)
          echo "Total functions: $total_funcs"
          # Extract first 200 complete functions
          awk '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              if (func_count >= 200) exit
              in_func = 1
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                printf "%s", func_lines
                func_count++
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_200.sh
          echo "200 functions extracted:"
          wc -l /tmp/glosses_200.sh

      - name: Source 200 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing 200 functions..."
          . /tmp/glosses_200.sh
          echo "SUCCESS! 200 functions worked"

  # New tests based on #117 crash (lines 12823-12824 confirmed problematic!)
  # This means the bug is in one or both of lines 12823-12824
  
  # H14: NixOS - Test line 12823 only
  test-121-nix-12823-only:
    name: "#121: NixOS - Line 12823 only"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract line 12823 only
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v target="12823" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start == target) {
                  printf "%s", func_lines
                  exit
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted line 12823 only:"
          wc -l /tmp/glosses_decile.sh
          echo "Function name:"
          grep '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_decile.sh || echo "No function found"

      - name: Test line 12823 only
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Line 12823 completed'
          "

  # H15: NixOS - Test line 12824 only
  test-122-nix-12824-only:
    name: "#122: NixOS - Line 12824 only"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract line 12824 only
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v target="12824" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start == target) {
                  printf "%s", func_lines
                  exit
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted line 12824 only:"
          wc -l /tmp/glosses_decile.sh
          echo "Function name:"
          grep '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_decile.sh || echo "No function found"

      - name: Test line 12824 only
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Line 12824 completed'
          "

  # H16: NixOS - Test line 12822 only (for comparison with 12821)
  test-123-nix-12822-only:
    name: "#123: NixOS - Line 12822 only"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract line 12822 only
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v target="12822" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start == target) {
                  printf "%s", func_lines
                  exit
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted line 12822 only:"
          wc -l /tmp/glosses_decile.sh
          echo "Function name:"
          grep '^[a-zA-Z_][a-zA-Z0-9_-]* *()' /tmp/glosses_decile.sh || echo "No function found"

      - name: Test line 12822 only
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Line 12822 completed'
          "

  # H17: Identify and print actual function names for all 4 lines
  test-124-nix-identify-all-4-lines:
    name: "#124: NixOS - Identify all 4 functions (12821-12824)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Identify all 4 functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          echo "=== Line 12821 ==="
          sed -n '12821p' /tmp/glosses_full.sh
          echo ""
          echo "=== Line 12822 ==="
          sed -n '12822p' /tmp/glosses_full.sh
          echo ""
          echo "=== Line 12823 ==="
          sed -n '12823p' /tmp/glosses_full.sh
          echo ""
          echo "=== Line 12824 ==="
          sed -n '12824p' /tmp/glosses_full.sh
          echo ""
          echo "=== All function names in lines 12821-12824 ==="
          awk 'NR>=12821 && NR<=12824 && /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {print NR": "$0}' /tmp/glosses_full.sh
          echo ""
          echo "=== SUCCESS - Identification complete ==="

  # Test #125: NixOS - Identify exact function on line 12824
  test-125-nixos-identify-12824:
    name: "#125: NixOS - Identify function on line 12824"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install NixOS tools
        run: |
          sudo apt-get update && sudo apt-get install -y curl
          sh <(curl -L https://nixos.org/nix/install) --daemon --yes || true
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh || true
      
      - name: Generate glosses and identify line 12824
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses > /tmp/glosses_full.sh
          
          echo "=== FUNCTION ON LINE 12824 ==="
          sed -n '12824p' /tmp/glosses_full.sh
          echo ""
          
          echo "=== Context (lines 12820-12830) ==="
          sed -n '12820,12830p' /tmp/glosses_full.sh
          echo ""
          
          echo "=== Find function containing line 12824 ==="
          # Find the function name by looking backwards for function declaration
          sed -n '1,12824p' /tmp/glosses_full.sh | grep -E "^[a-z_-]+\(\)" | tail -1
          echo ""
          
          echo "=== SUCCESS - Line 12824 identified ==="

  # Test #126: NixOS - Test without line 12824 (should succeed)
  test-126-nixos-without-12824:
    name: "#126: NixOS - Glosses without line 12824"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install NixOS tools
        run: |
          sudo apt-get update && sudo apt-get install -y curl
          sh <(curl -L https://nixos.org/nix/install) --daemon --yes || true
      
      - name: Test glosses without line 12824
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh || true
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses > /tmp/glosses_full.sh
          
          # Create glosses without line 12824
          sed '12824d' /tmp/glosses_full.sh > /tmp/glosses_no_12824.sh
          
          echo "Lines in filtered glosses: $(wc -l < /tmp/glosses_no_12824.sh)"
          
          # Test with NixOS bash (should succeed without line 12824)
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_no_12824.sh
            echo 'SUCCESS! Glosses without line 12824 work on NixOS!'
          "

  # Test #127: Arch/Ubuntu - Test line 12824 function alone
  test-127-arch-line-12824-function:
    name: "#127: Arch - Source only line 12824 function"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test line 12824 function on Arch/Ubuntu
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses > /tmp/glosses_full.sh
          
          echo "=== Extracting function from line 12824 ==="
          # Extract just line 12824
          sed -n '12824p' /tmp/glosses_full.sh > /tmp/function_12824.sh
          
          echo "Function content:"
          cat /tmp/function_12824.sh
          echo ""
          
          echo "=== Sourcing line 12824 function on Arch/Ubuntu ==="
          . /tmp/function_12824.sh
          
          echo "SUCCESS! Line 12824 function sourced without crash on Arch/Ubuntu"
