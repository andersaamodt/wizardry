name: Minimal Reproduce Exit 139

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # WORKFLOW #1: Minimal NixOS declare() reproduction
  # ============================================================================
  nix-minimal-declare-repro:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#1 Nix - Minimal declare() function reproduction"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Create minimal glosses with ONLY declare() function
        run: |
          # Create a minimal glosses file that contains ONLY the declare() function
          # This is the exact code from lines 12823-12874 that causes the segfault
          cat > /tmp/minimal-glosses.sh <<'EOF'
          # First-word gloss for commands starting with 'declare'
          declare() {
            # Try progressively longer spell names to find uncastable spells
            _fw_spell="declare"
            _fw_words_used=0
            _fw_spell_home=${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}
            
            for _fw_arg in "$@"; do
              # Skip flags and pure numeric arguments (they're not part of command names)
              case "$_fw_arg" in
                -*) break ;;  # Flag - stop looking for command words
                *[!0-9]*) ;; # Contains non-numeric - it's a command word, continue
                *) break ;;  # Pure numeric - stop looking for command words
              esac
              
              _fw_candidate="${_fw_spell}-${_fw_arg}"
              _fw_words_used=$((_fw_words_used + 1))
              
              # Look for spell file in wizardry directories
              _fw_found=0
              for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                _fw_path="${_fw_dir}${_fw_candidate}"
                if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                  # Found uncastable spell - source it with remaining args after consuming used words
                  shift "$_fw_words_used"
                  . "$_fw_path"
                  return $?
                fi
              done
              
              _fw_spell="$_fw_candidate"
            done
            
            # No uncastable spell found - use parse for normal spells
            parse "$_fw_spell" "$@"
          }
          EOF
          
          wc -l /tmp/minimal-glosses.sh
          echo "Created minimal glosses with declare() function"
      
      - name: Test sourcing declare() in nix-shell
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            echo 'About to source minimal glosses with declare() function...'
            . /tmp/minimal-glosses.sh
            echo 'SUCCESS! Sourced declare() without crash'
            echo 'Now attempting to use declare builtin...'
            declare -F | head -5 || echo 'declare -F failed with exit code: \$?'
          "
  
  # ============================================================================
  # WORKFLOW #2: Ubuntu/Arch minimal full invoke-wizardry test
  # ============================================================================
  ubuntu-full-invoke-test:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#2 Ubuntu - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose

  # ============================================================================
  # WORKFLOW #3: Ubuntu without invoke-wizardry (isolate glosses)
  # ============================================================================
  ubuntu-glosses-only:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#3 Ubuntu - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"
          
          # Try using a gloss
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #4: Arch without invoke-wizardry
  # ============================================================================
  arch-glosses-only:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#4 Arch - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"

  # ============================================================================
  # WORKFLOW #5: Ubuntu with invoke-wizardry but NO banish
  # ============================================================================
  ubuntu-invoke-no-banish:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#5 Ubuntu - invoke-wizardry without banish"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry only (skip banish)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry without banish..."
          . spells/.imps/sys/invoke-wizardry
          echo "SUCCESS! invoke-wizardry completed"
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #6: Ubuntu with banish but NO test-magic
  # ============================================================================
  ubuntu-banish-no-test:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#6 Ubuntu - invoke-wizardry + banish only (no test-magic)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry + banish 8 (skip test-magic)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry + banish without test-magic..."
          . spells/.imps/sys/invoke-wizardry && banish 8
          echo "SUCCESS! banish completed"

  # ============================================================================
  # WORKFLOW #7: Arch full test (original failure)
  # ============================================================================
  arch-full-invoke-test:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#7 Arch - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose

  # ============================================================================
  # WORKFLOW #8: NixOS Decile 9-5 exact reproduction from PR #940
  # ============================================================================
  nix-decile-9-5-exact:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#8 Nix - Decile 9 Sub 5 (lines 12823-12826) from PR #940"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Generate glosses and extract Decile 9 Sub 5
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses-full.sh
          # Extract lines 12823-12826 (4 lines) - this is the exact test from PR #940 decile 9-5
          awk 'NR>=12823 && NR<=12826 && /^[a-z_-]+ *\(\)/ {in_func=1} in_func {print; if (/^}$/) in_func=0}' /tmp/glosses-full.sh > /tmp/glosses.sh
          echo "Decile 9 Sub 5 (lines 12823-12826):"
          wc -l /tmp/glosses.sh
          echo "Content:"
          cat /tmp/glosses.sh
      
      - name: Source and test in nix-shell
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses.sh
            ./spells/.wizardry/test-magic --verbose
            echo 'SUCCESS! Decile 9 Sub 5 completed'
          "

  # ============================================================================
  # WORKFLOW #9: Ubuntu banish in isolation (no glosses)
  # ============================================================================
  ubuntu-banish-no-glosses:
    if: false  # DISABLED - workflow #1-10 disabled per request
    name: "#9 Ubuntu - banish without glosses (direct execution)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run banish directly without glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          export PATH="${WIZARDRY_DIR}/spells/.imps/out:${PATH}"
          export PATH="${WIZARDRY_DIR}/spells/.imps/cond:${PATH}"
          export PATH="${WIZARDRY_DIR}/spells/wards:${PATH}"
          echo "Running banish 8 directly without sourcing glosses..."
          ./spells/wards/banish 8
          echo "SUCCESS! banish completed without glosses"

  # ============================================================================
  # WORKFLOW #10: REMOVED (word-of-binding doesn't exist)
  # ============================================================================
  
  # ============================================================================
  # WORKFLOW #11: Ubuntu - Source ONLY declare() function
  # Hypothesis: declare() function definition itself causes segfault
  # Expected: FAIL (exit 139)
  # ============================================================================
  ubuntu-only-declare-function:
    if: false  # DISABLED - workflows #11-15 disabled per request
    name: "#11 Ubuntu - Source ONLY declare() (expect FAIL)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create minimal script with ONLY declare() function
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract ONLY the declare() function (lines 12823-12926)
          awk 'NR==12823,/^}$/ && NR>12823 {print; if (/^}$/) exit}' /tmp/full-glosses.sh > /tmp/only-declare.sh
          echo "# First-word gloss for commands starting with 'declare'" | cat - /tmp/only-declare.sh > /tmp/declare-gloss.sh
          
          wc -l /tmp/declare-gloss.sh
          echo "--- Content of declare-gloss.sh ---"
          head -20 /tmp/declare-gloss.sh
      
      - name: Source declare() and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing ONLY declare() function..."
          . /tmp/declare-gloss.sh
          echo "SUCCESS! declare() sourced without crash"
          
          # Try using declare
          type declare || echo "declare not available"
  
  # ============================================================================
  # WORKFLOW #12: Ubuntu - Source all glosses EXCEPT declare()
  # Hypothesis: Other glosses work fine, only declare() causes the issue
  # Expected: PASS
  # ============================================================================
  ubuntu-glosses-except-declare:
    name: "#12 Ubuntu - All glosses EXCEPT declare() (expect PASS)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate glosses without declare()
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Remove the declare() function (lines 12823-12926)
          awk 'NR<12823 || NR>12926' /tmp/full-glosses.sh > /tmp/glosses-no-declare.sh
          
          echo "Original glosses: $(wc -l < /tmp/full-glosses.sh) lines"
          echo "Without declare: $(wc -l < /tmp/glosses-no-declare.sh) lines"
          echo "Removed: $(($(wc -l < /tmp/full-glosses.sh) - $(wc -l < /tmp/glosses-no-declare.sh))) lines"
      
      - name: Source glosses and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing all glosses EXCEPT declare()..."
          . /tmp/glosses-no-declare.sh
          echo "SUCCESS! Glosses sourced"
          
          echo "Running banish 8..."
          banish 8
          echo "SUCCESS! banish completed"
  
  # ============================================================================
  # WORKFLOW #13: Ubuntu - Just the 4 lines from decile 9-5 (12823-12826)
  # Hypothesis: Even these 4 lines alone trigger the issue
  # Expected: Unclear - may PASS if incomplete function is okay
  # ============================================================================
  ubuntu-4-lines-only:
    if: false  # DISABLED - workflows #11-15 disabled per request
    name: "#13 Ubuntu - Only 4 lines 12823-12826 (exploratory)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create file with ONLY 4 lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract EXACTLY 4 lines (12823-12826)
          awk 'NR>=12823 && NR<=12826' /tmp/full-glosses.sh > /tmp/4-lines.sh
          
          echo "--- Exact 4 lines extracted ---"
          cat /tmp/4-lines.sh
      
      - name: Try to source the 4 lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Attempting to source 4 lines..."
          . /tmp/4-lines.sh || echo "Failed to source (expected - incomplete function)"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #14: Arch - Source ONLY declare() function
  # Hypothesis: Same as #11 but on Arch to see if platform-specific
  # Expected: FAIL (exit 139) if same root cause
  # ============================================================================
  arch-only-declare-function:
    if: false  # DISABLED - workflows #11-15 disabled per request
    name: "#14 Arch - Source ONLY declare() (expect FAIL)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Create and source ONLY declare() function
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract ONLY the declare() function
          awk 'NR==12823,/^}$/ && NR>12823 {print; if (/^}$/) exit}' /tmp/full-glosses.sh > /tmp/only-declare.sh
          echo "# First-word gloss for commands starting with 'declare'" | cat - /tmp/only-declare.sh > /tmp/declare-gloss.sh
          
          wc -l /tmp/declare-gloss.sh
          
          echo "Sourcing ONLY declare() function..."
          . /tmp/declare-gloss.sh
          echo "SUCCESS! declare() sourced without crash"
  
  # ============================================================================
  # WORKFLOW #15: Ubuntu - Bisect glosses (first half)
  # Hypothesis: Narrow down which section of glosses contains the problematic function
  # Expected: Either PASS or FAIL - helps narrow down
  # ============================================================================
  ubuntu-glosses-first-half:
    if: false  # DISABLED - workflows #11-15 disabled per request
    name: "#15 Ubuntu - First half of glosses (exploratory)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate first half of glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          total_lines=$(wc -l < /tmp/full-glosses.sh)
          half_lines=$((total_lines / 2))
          
          head -n $half_lines /tmp/full-glosses.sh > /tmp/first-half.sh
          
          echo "Total lines: $total_lines"
          echo "First half: $half_lines lines"
          echo "Line 12823 in range: $(if [ 12823 -le $half_lines ]; then echo YES; else echo NO; fi)"
      
      - name: Source first half and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/first-half.sh
          echo "First half sourced successfully"
          banish 8
          echo "SUCCESS!"
  
  # ============================================================================
  # WORKFLOW #16: Ubuntu - Second half of glosses
  # Hypothesis: Bug is in second half (declare is at line 12823, in 2nd half)
  # Expected: FAIL if bug in 2nd half, PASS if in 1st half
  # ============================================================================
  ubuntu-glosses-second-half:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#16 Ubuntu - Second half of glosses (expect FAIL)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate second half of glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          total_lines=$(wc -l < /tmp/full-glosses.sh)
          half_lines=$((total_lines / 2))
          
          tail -n +$((half_lines + 1)) /tmp/full-glosses.sh > /tmp/second-half.sh
          
          echo "Total lines: $total_lines"
          echo "Second half starts at line: $((half_lines + 1))"
          echo "Second half has: $(wc -l < /tmp/second-half.sh) lines"
          echo "Line 12823 in second half: $(if [ 12823 -gt $half_lines ]; then echo YES; else echo NO; fi)"
      
      - name: Source second half and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/second-half.sh
          echo "Second half sourced successfully"
          banish 8 || echo "banish failed or not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #17: Ubuntu - First quarter of glosses
  # Hypothesis: Narrow down further - is bug in Q1 or Q2?
  # Expected: If #15 failed and #16 passes, bug is in first half (Q1 or Q2)
  # ============================================================================
  ubuntu-glosses-first-quarter:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#17 Ubuntu - First quarter of glosses (narrow Q1)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate first quarter of glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          total_lines=$(wc -l < /tmp/full-glosses.sh)
          quarter_lines=$((total_lines / 4))
          
          head -n $quarter_lines /tmp/full-glosses.sh > /tmp/first-quarter.sh
          
          echo "Total lines: $total_lines"
          echo "First quarter: $quarter_lines lines"
      
      - name: Source first quarter and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/first-quarter.sh
          echo "First quarter sourced successfully"
          banish 8 || echo "banish failed or not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #18: Ubuntu - Second quarter of glosses (Q2 only)
  # Hypothesis: Test Q2 in isolation
  # Expected: Helps identify if bug is in Q2
  # ============================================================================
  ubuntu-glosses-second-quarter:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#18 Ubuntu - Second quarter only (narrow Q2)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate second quarter of glosses  
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          total_lines=$(wc -l < /tmp/full-glosses.sh)
          quarter_lines=$((total_lines / 4))
          half_lines=$((total_lines / 2))
          
          # Extract Q2 (lines quarter+1 to half)
          awk "NR > $quarter_lines && NR <= $half_lines" /tmp/full-glosses.sh > /tmp/second-quarter.sh
          
          echo "Total lines: $total_lines"
          echo "Q2 lines: $((quarter_lines + 1)) to $half_lines"
          echo "Q2 has: $(wc -l < /tmp/second-quarter.sh) lines"
      
      - name: Source second quarter and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/second-quarter.sh
          echo "Second quarter sourced successfully"
          banish 8 || echo "banish failed or not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #19: Ubuntu - Lines 1-5000 (very narrow first section)
  # Hypothesis: Bug is in early glosses
  # Expected: FAIL if bug in first ~5000 lines, else PASS
  # ============================================================================
  ubuntu-glosses-lines-1-5000:
    name: "#19 Ubuntu - Lines 1-5000 (expect FAIL if early bug)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 1-5000
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          head -n 5000 /tmp/full-glosses.sh > /tmp/lines-1-5000.sh
          
          echo "Extracted lines 1-5000"
          wc -l /tmp/lines-1-5000.sh
      
      - name: Source lines 1-5000 and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/lines-1-5000.sh
          echo "Lines 1-5000 sourced successfully"
          banish 8 || echo "banish failed or not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #20: Ubuntu - Lines 5001-10000 (middle-early section)
  # Hypothesis: Continue narrowing down the problem range
  # Expected: Helps identify exact range
  # ============================================================================
  ubuntu-glosses-lines-5001-10000:
    name: "#20 Ubuntu - Lines 5001-10000 (continue narrowing)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 5001-10000
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          awk 'NR >= 5001 && NR <= 10000' /tmp/full-glosses.sh > /tmp/lines-5001-10000.sh
          
          echo "Extracted lines 5001-10000"
          wc -l /tmp/lines-5001-10000.sh
      
      - name: Source lines 5001-10000 and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/lines-5001-10000.sh
          echo "Lines 5001-10000 sourced successfully"
          banish 8 || echo "banish failed or not available"
          echo "Test completed"

  # ============================================================================
  # NixOS INVESTIGATION LINE
  # ============================================================================

  # ============================================================================
  # WORKFLOW #21: NixOS - Full glosses with banish
  # Hypothesis: NixOS has different root cause than Ubuntu/Arch
  # Expected: FAIL - reproduce NixOS exit 139
  # ============================================================================
  nix-full-glosses-banish:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#21 Nix - Full glosses + banish (expect FAIL for Nix bug)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Generate and source full glosses, then run banish
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            ./spells/.wizardry/generate-glosses --quiet > /tmp/glosses.sh
            echo 'Generated glosses: '
            wc -l /tmp/glosses.sh
            
            echo 'Sourcing glosses...'
            . /tmp/glosses.sh
            echo 'Glosses sourced successfully'
            
            echo 'Running banish 8...'
            banish 8
            echo 'SUCCESS!'
          "

  # ============================================================================
  # WORKFLOW #22: NixOS - All glosses EXCEPT declare()
  # Hypothesis: If Nix bug is declare(), removing it should fix
  # Expected: PASS if declare is Nix issue, FAIL if different issue
  # ============================================================================
  nix-glosses-except-declare:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#22 Nix - All glosses EXCEPT declare() (test Nix theory)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Generate glosses without declare() and test
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
            
            # Remove the declare() function (lines 12823-12926)
            awk 'NR<12823 || NR>12926' /tmp/full-glosses.sh > /tmp/glosses-no-declare.sh
            
            echo 'Original: $(wc -l < /tmp/full-glosses.sh) lines'
            echo 'Without declare: $(wc -l < /tmp/glosses-no-declare.sh) lines'
            
            echo 'Sourcing glosses without declare...'
            . /tmp/glosses-no-declare.sh
            echo 'Glosses sourced successfully'
            
            echo 'Running banish 8...'
            banish 8
            echo 'SUCCESS!'
          "

  # ============================================================================
  # WORKFLOW #23: NixOS - Only declare() function
  # Hypothesis: Test if declare() alone causes Nix crash (retest #11 on Nix)
  # Expected: FAIL if declare is Nix-specific issue
  # ============================================================================
  nix-only-declare-with-banish:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#23 Nix - Only declare() then banish (Nix-specific test)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Source only declare() and try banish
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
            
            # Extract ONLY the declare() function
            awk 'NR==12823,/^}$/ && NR>12823 {print; if (/^}$/) exit}' /tmp/full-glosses.sh > /tmp/only-declare.sh
            echo '# First-word gloss for commands starting with \"declare\"' | cat - /tmp/only-declare.sh > /tmp/declare-gloss.sh
            
            wc -l /tmp/declare-gloss.sh
            
            echo 'Sourcing ONLY declare() function...'
            . /tmp/declare-gloss.sh
            echo 'declare() sourced'
            
            echo 'Trying to run banish 8...'
            banish 8 || echo 'banish not available or failed'
            echo 'Test completed'
          "

  # ============================================================================
  # NEW WORKFLOWS #24-30 based on latest findings
  # ============================================================================
  
  # ============================================================================
  # WORKFLOW #24: Ubuntu - Q1 first half (lines 1-2700)
  # Hypothesis: Bug is in first half of Q1
  # Expected: FAIL if bug in lines 1-2700, PASS if in 2701-5411
  # ============================================================================
  ubuntu-q1-first-half:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#24 Ubuntu - Q1 first half lines 1-2700"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 1-2700 and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract complete functions only (first ~150 functions â‰ˆ 2700 lines)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 150) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1-2700.sh
          
          echo "Extracted lines (cleaned): $(wc -l < /tmp/lines-1-2700.sh)"
          echo "Functions extracted: approximately 150"
          
          . /tmp/lines-1-2700.sh
          echo "Sourced successfully"
          banish 8
          echo "SUCCESS!"
  
  # ============================================================================
  # WORKFLOW #25: Ubuntu - Q1 second half (lines 2701-5411)
  # Hypothesis: Bug is in second half of Q1  
  # Expected: Complements #24
  # ============================================================================
  ubuntu-q1-second-half:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#25 Ubuntu - Q1 second half lines 2701-5411"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 2701-5411 and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          awk 'NR >= 2701 && NR <= 5411' /tmp/full-glosses.sh > /tmp/lines-2701-5411.sh
          
          echo "Extracted lines: $(wc -l < /tmp/lines-2701-5411.sh)"
          
          . /tmp/lines-2701-5411.sh
          echo "Sourced successfully"
          banish 8 || echo "banish not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #26: Nix - Test other builtin shadowing
  # Hypothesis: Shadowing ANY shell builtin causes Nix crash
  # Expected: FAIL if general builtin shadowing issue, PASS if declare-specific
  # ============================================================================
  nix-shadow-test-builtin:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#26 Nix - Shadow 'test' builtin (not declare)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Test shadowing 'test' builtin
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            
            echo 'Creating function that shadows test builtin...'
            test() {
              echo 'Custom test function'
            }
            
            echo 'test function defined'
            test
            echo 'test function called successfully'
            echo 'Exiting shell...'
          "
          echo "Shell exited successfully - no crash!"
  
  # ============================================================================
  # WORKFLOW #27: Ubuntu - Lines 1-1000 (very narrow)
  # Hypothesis: Bug is in very early glosses
  # Expected: Helps narrow to specific 1000-line range
  # ============================================================================
  ubuntu-lines-1-1000:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#27 Ubuntu - Lines 1-1000"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 1-1000 and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract first ~55 complete functions (approximately 1000 lines)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 55) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1-1000.sh
          
          echo "Lines: $(wc -l < /tmp/lines-1-1000.sh)"
          echo "Functions: approximately 55"
          
          . /tmp/lines-1-1000.sh
          echo "Sourced successfully"
          banish 8 || echo "banish not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #28: Ubuntu - Lines 1001-2000
  # Hypothesis: Continue binary search
  # Expected: Helps pinpoint range
  # ============================================================================
  ubuntu-lines-1001-2000:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#28 Ubuntu - Lines 1001-2000"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 1001-2000 and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract functions 56-110 (roughly lines 1001-2000)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func && func_count > 55 && func_count <= 110 { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 110) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1001-2000.sh
          
          echo "Lines: $(wc -l < /tmp/lines-1001-2000.sh)"
          echo "Functions: approximately 55 (functions 56-110)"
          
          . /tmp/lines-1001-2000.sh
          echo "Sourced successfully"
          banish 8 || echo "banish not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #29: Ubuntu - Lines 2001-2700
  # Hypothesis: Continue binary search  
  # Expected: Helps pinpoint range
  # ============================================================================
  ubuntu-lines-2001-2700:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#29 Ubuntu - Lines 2001-2700"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate lines 2001-2700 and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract functions 111-150 (roughly lines 2001-2700)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func && func_count > 110 && func_count <= 150 { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 150) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-2001-2700.sh
          
          echo "Lines: $(wc -l < /tmp/lines-2001-2700.sh)"
          echo "Functions: approximately 40 (functions 111-150)"
          
          . /tmp/lines-2001-2700.sh
          echo "Sourced successfully"
          banish 8 || echo "banish not available"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #30: Nix - Confirm declare is the ONLY problematic builtin
  # Hypothesis: Only declare causes the issue, not other builtins
  # Expected: PASS (no crash) to confirm declare is special
  # ============================================================================
  nix-shadow-enable-builtin:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#30 Nix - Shadow 'enable' builtin (test another)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Test shadowing 'enable' builtin
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            
            echo 'Creating function that shadows enable builtin...'
            enable() {
              echo 'Custom enable function'
            }
            
            echo 'enable function defined'
            enable
            echo 'enable function called successfully'
            echo 'Exiting shell...'
          "
          echo "Shell exited successfully - no crash!"
  
  # ============================================================================
  # WORKFLOW #31: NixOS - DEFINITIVE minimal declare() reproduction
  # Hypothesis: CONFIRMED - shadowing declare builtin causes segfault on shell exit
  # Expected: FAIL (exit 139) - this is the minimal reproduction of the NixOS bug
  # ============================================================================
  nix-minimal-declare-reproduction:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#31 Nix - MINIMAL declare() reproduction (DEFINITIVE)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Minimal reproduction - just define declare() and exit
        run: |
          echo "=========================================="
          echo "DEFINITIVE NixOS exit 139 minimal reproduction"
          echo "=========================================="
          echo ""
          echo "Root cause: Defining a function named 'declare()' that shadows"
          echo "the shell builtin causes a segmentation fault when the shell exits."
          echo ""
          echo "Test: Create declare() function and let shell exit normally..."
          echo ""
          
          nix-shell -p bash --run '
            declare() {
              echo "custom declare function"
            }
            echo "declare() function has been defined"
            echo "Shell is now exiting..."
          '
          
          echo ""
          echo "=========================================="
          echo "If you see this message, the bug is FIXED!"
          echo "=========================================="
  
  # ============================================================================
  # WORKFLOW #32: NixOS - Define declare() then call "declare -F"
  # Hypothesis: Crash occurs when shell tries to USE the shadowed declare builtin
  # Expected: FAIL (exit 139) - using declare after redefining it causes crash
  # ============================================================================
  nix-declare-then-use:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#32 Nix - Define declare() then call 'declare -F'"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Define declare() then try to use declare -F
        run: |
          echo "Testing if USING shadowed declare builtin causes crash..."
          
          nix-shell -p bash --run '
            echo "Defining custom declare() function..."
            declare() {
              echo "custom declare function called"
            }
            echo "declare() function has been defined"
            
            echo "Now trying to use the declare builtin with declare -F..."
            declare -F || echo "declare -F failed with exit code: $?"
            
            echo "Shell is exiting..."
          '
          
          echo "Test completed successfully - no crash!"
  
  # ============================================================================
  # WORKFLOW #33: NixOS - Define declare() then run "type declare"
  # Hypothesis: Using 'type' command triggers declare introspection which crashes
  # Expected: FAIL (exit 139)
  # ============================================================================
  nix-declare-then-type:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#33 Nix - Define declare() then run 'type declare'"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Define declare() then try to use type command
        run: |
          echo "Testing if 'type declare' triggers crash..."
          
          nix-shell -p bash --run '
            declare() {
              echo "custom declare"
            }
            echo "declare() defined"
            
            echo "Running: type declare"
            type declare
            
            echo "Shell exiting..."
          '
          
          echo "Test completed - no crash!"
  
  # ============================================================================
  # WORKFLOW #34: NixOS - Define declare() then invoke-wizardry
  # Hypothesis: invoke-wizardry uses declare internally, triggering crash
  # Expected: FAIL (exit 139)
  # ============================================================================
  nix-declare-then-invoke:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#34 Nix - Define declare() then invoke-wizardry"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Define declare() then source invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          nix-shell -p bash --run '
            export WIZARDRY_DIR="'"${WIZARDRY_DIR}"'"
            
            echo "Defining declare() function..."
            declare() {
              echo "custom declare"
            }
            echo "declare() defined"
            
            echo "Sourcing invoke-wizardry..."
            . spells/.imps/sys/invoke-wizardry || echo "invoke-wizardry failed: $?"
            
            echo "Trying to run banish..."
            banish 8 || echo "banish failed: $?"
            
            echo "Test completed"
          '
  
  # ============================================================================
  # WORKFLOW #35: NixOS - Just "declare -F" without redefining (control test)
  # Hypothesis: Normal declare usage works fine (this is the control)
  # Expected: PASS - no crash when declare is not redefined
  # ============================================================================
  nix-declare-control:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#35 Nix - Just 'declare -F' without redefining (control)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Use declare -F without redefining declare
        run: |
          echo "Control test: using declare -F without redefining it..."
          
          nix-shell -p bash --run '
            echo "Calling declare -F (builtin should work normally)..."
            declare -F | head -5
            
            echo "Success - declare builtin works as expected"
          '
  
  # ============================================================================
  # WORKFLOW #36: Ubuntu - Lines 1-1350 (first half of 1-2700 range)
  # Hypothesis: Bug is in first half of narrowed range
  # Expected: FAIL if bug in 1-1350, PASS if in 1351-2700
  # ============================================================================
  ubuntu-lines-1-1350:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#36 Ubuntu - Lines 1-1350"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract and test lines 1-1350
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract complete functions only (avoid cutting mid-function)
          # Count functions and extract first ~70-80 complete functions (roughly 1350 lines)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 75) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1-1350.sh
          
          echo "Lines extracted: $(wc -l < /tmp/lines-1-1350.sh)"
          echo "Functions extracted: approximately 75"
          
          # Source and test
          . /tmp/lines-1-1350.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed without crash"
  
  # ============================================================================
  # WORKFLOW #37: Ubuntu - Lines 1351-2700 (second half)
  # Hypothesis: Bug is in second half if not in first half
  # Expected: Opposite result of #36
  # ============================================================================
  ubuntu-lines-1351-2700:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#37 Ubuntu - Lines 1351-2700"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract and test lines 1351-2700
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract complete functions from second section (skip first ~75, take next ~75)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func && func_count > 75 { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 150) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1351-2700.sh
          
          echo "Lines extracted: $(wc -l < /tmp/lines-1351-2700.sh)"
          echo "Functions extracted: approximately 75 (functions 76-150)"
          
          # Source and test
          . /tmp/lines-1351-2700.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed without crash"
  
  # ============================================================================
  # WORKFLOW #38: Ubuntu - Lines 1-500 (very narrow range)
  # Hypothesis: Bug might be in very early glosses
  # Expected: Helps pinpoint if bug is in first 500 lines
  # ============================================================================
  ubuntu-lines-1-500:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#38 Ubuntu - Lines 1-500"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract and test lines 1-500
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract complete functions only (first ~25-30 functions â‰ˆ 500 lines)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 28) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-1-500.sh
          
          echo "Lines extracted: $(wc -l < /tmp/lines-1-500.sh)"
          echo "Functions extracted: approximately 28"
          
          # Source and test
          . /tmp/lines-1-500.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed without crash"
  
  # ============================================================================
  # WORKFLOW #39: Ubuntu - Lines 501-1000
  # Hypothesis: Continue binary search to narrow down exact range
  # Expected: Helps identify specific 500-line range containing bug
  # ============================================================================
  ubuntu-lines-501-1000:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#39 Ubuntu - Lines 501-1000"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract and test lines 501-1000
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract functions 29-56 (roughly lines 501-1000)
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func && func_count > 28 && func_count <= 56 { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 56) exit }
          ' /tmp/full-glosses.sh > /tmp/lines-501-1000.sh
          
          echo "Lines extracted: $(wc -l < /tmp/lines-501-1000.sh)"
          echo "Functions extracted: approximately 28 (functions 29-56)"
          
          # Source and test
          . /tmp/lines-501-1000.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed without crash"
  
  # ============================================================================
  # WORKFLOW #40: Extract first 75 functions + check if declare is included
  # Hypothesis: declare() is in the first 75 functions, causing them to fail
  # Expected: If "declare found", test should FAIL; if "declare not found", should PASS
  # ============================================================================
  ubuntu-first-75-check-declare:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#40 Ubuntu - First 75 funcs + check for declare"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract first 75 functions and check for declare
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract first 75 complete functions
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++; func_name=$1 }
            in_func { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 75) exit }
          ' /tmp/full-glosses.sh > /tmp/first-75-funcs.sh
          
          echo "Lines extracted: $(wc -l < /tmp/first-75-funcs.sh)"
          echo "Functions extracted: 75"
          
          # Check if declare is in the extraction
          if grep -q '^declare() {$' /tmp/first-75-funcs.sh; then
            echo "âš ï¸ DECLARE FOUND in first 75 functions!"
          else
            echo "âœ“ declare NOT in first 75 functions"
          fi
          
          # Source and test
          . /tmp/first-75-funcs.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed without crash"
  
  # ============================================================================
  # WORKFLOW #41: Extract first 75 functions but SKIP declare - KEY TEST
  # Hypothesis: Skipping declare will make the test PASS
  # Expected: PASS (proves declare is the bug)
  # This is the definitive test for the unified hypothesis!
  # ============================================================================
  ubuntu-first-75-skip-declare:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#41 Ubuntu - First 75 funcs SKIP declare â­ KEY TEST"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract first 75 functions, explicitly SKIP declare
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract 75 complete functions but SKIP any named "declare"
          awk '
            /^[a-z_-]+\(\) \{$/ { 
              in_func=1
              func_name=$1
              sub(/\(\).*/, "", func_name)  # Extract just the function name
              buffer=$0 "\n"
              next
            }
            in_func { buffer = buffer $0 "\n" }
            /^}$/ && in_func {
              in_func=0
              # Only print if not declare AND we havent hit our limit
              if (func_name != "declare" && func_count < 75) {
                printf "%s", buffer
                func_count++
              }
              buffer=""
              if (func_count >= 75) exit
            }
          ' /tmp/full-glosses.sh > /tmp/first-75-no-declare.sh
          
          echo "Lines extracted: $(wc -l < /tmp/first-75-no-declare.sh)"
          echo "Functions extracted: up to 75 (excluding declare)"
          
          # Verify declare was skipped
          if grep -q '^declare() {$' /tmp/first-75-no-declare.sh; then
            echo "âŒ ERROR: declare still in extraction!"
            exit 1
          else
            echo "âœ… CONFIRMED: declare successfully excluded"
          fi
          
          # Source and test
          . /tmp/first-75-no-declare.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "âœ… SUCCESS! Test completed without crash - declare was the bug!"
  
  # ============================================================================
  # WORKFLOW #42: Extract functions 76-150 + check for declare
  # Hypothesis: declare might also be in this range (if it appears late)
  # Expected: Check if declare is present
  # ============================================================================
  ubuntu-funcs-76-150-check-declare:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#42 Ubuntu - Funcs 76-150 + check for declare"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract functions 76-150 and check for declare
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract functions 76-150
          awk '
            /^[a-z_-]+\(\) \{$/ { in_func=1; func_count++ }
            in_func && func_count > 75 && func_count <= 150 { print }
            /^}$/ && in_func { in_func=0; if (func_count >= 150) exit }
          ' /tmp/full-glosses.sh > /tmp/funcs-76-150.sh
          
          echo "Lines extracted: $(wc -l < /tmp/funcs-76-150.sh)"
          echo "Functions extracted: 75 (functions 76-150)"
          
          # Check if declare is in this range
          if grep -q '^declare() {$' /tmp/funcs-76-150.sh; then
            echo "âš ï¸ DECLARE FOUND in functions 76-150!"
          else
            echo "âœ“ declare NOT in functions 76-150"
          fi
          
          # Source and test
          . /tmp/funcs-76-150.sh
          echo "Glosses sourced successfully"
          
          # Try to trigger the bug
          . spells/.imps/sys/invoke-wizardry
          banish 8
          
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #43: List all function names to find declare's position
  # Hypothesis: Need to see exact position of declare in glosses
  # Expected: Diagnostic output showing all function names
  # ============================================================================
  ubuntu-list-all-functions:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#43 Ubuntu - List all function names (find declare position)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: List all function names with positions
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          echo "=== All functions in glosses (first 100) ==="
          awk '
            /^[a-z_-]+\(\) \{$/ {
              func_count++
              func_name=$1
              sub(/\(\).*/, "", func_name)
              printf "%3d: %s\n", func_count, func_name
              if (func_count >= 100) exit
            }
          ' /tmp/full-glosses.sh
          
          echo ""
          echo "=== Searching for declare specifically ==="
          awk '
            /^[a-z_-]+\(\) \{$/ {
              func_count++
              func_name=$1
              sub(/\(\).*/, "", func_name)
              if (func_name == "declare") {
                printf "FOUND: declare is function #%d\n", func_count
                found=1
                exit
              }
            }
            END {
              if (!found) print "declare function NOT FOUND in glosses"
            }
          ' /tmp/full-glosses.sh
          
          echo "Listing complete"
  
  # ============================================================================
  # WORKFLOW #44: Verify declare() function exists in glosses
  # Hypothesis: declare() is actually being generated
  # Expected: Should find the declare function definition
  # ============================================================================
  ubuntu-verify-declare-exists:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#44 Ubuntu - Verify declare() exists in glosses"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if declare() is generated
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          echo "=== Searching for declare() function ==="
          if grep -n '^declare() {$' /tmp/full-glosses.sh; then
            echo ""
            echo "âœ“ CONFIRMED: declare() function IS in glosses"
            echo ""
            echo "=== First 20 lines of declare() function ==="
            grep -A 20 '^declare() {$' /tmp/full-glosses.sh | head -21
          else
            echo "âœ— declare() function NOT FOUND in glosses"
          fi
          
          echo ""
          echo "=== Total functions in glosses ==="
          grep -c '^[a-z_-]\+() {$' /tmp/full-glosses.sh || echo "Count: 0"
  
  # ============================================================================
  # WORKFLOW #45: Ubuntu - Matrix batch testing (10 functions at a time)
  # ============================================================================
  ubuntu-batch-matrix-test:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#45 Ubuntu - Batch ${{ matrix.batch }} (funcs ${{ matrix.start }}-${{ matrix.end }})"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    strategy:
      fail-fast: false
      matrix:
        include:
          - batch: 1
            start: 1
            end: 10
          - batch: 2
            start: 11
            end: 20
          - batch: 3
            start: 21
            end: 30
          - batch: 4
            start: 31
            end: 40
          - batch: 5
            start: 41
            end: 50
          - batch: 6
            start: 51
            end: 60
          - batch: 7
            start: 61
            end: 70
          - batch: 8
            start: 71
            end: 80
          - batch: 9
            start: 81
            end: 90
          - batch: 10
            start: 91
            end: 100
          - batch: 11
            start: 101
            end: 110
          - batch: 12
            start: 111
            end: 120
          - batch: 13
            start: 121
            end: 130
          - batch: 14
            start: 131
            end: 140
          - batch: 15
            start: 141
            end: 150
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Check bubblewrap
        run: |
          if bwrap --unshare-user-try --ro-bind / / /bin/true; then
            echo "bubblewrap usable with user namespaces"
          elif sudo -n bwrap --unshare-user-try --ro-bind / / /bin/true; then
            echo "bubblewrap usable via sudo with user namespaces"
          elif sudo -n bwrap --ro-bind / / /bin/true; then
            echo "bubblewrap usable via sudo"
          else
            echo "bubblewrap unusable; proceeding without sandboxing" >&2
          fi
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Extract batch ${{ matrix.batch }} (functions ${{ matrix.start }}-${{ matrix.end }})
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Generating full glosses..."
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          echo "Extracting batch ${{ matrix.batch }}: functions ${{ matrix.start }}-${{ matrix.end }}"
          
          # Extract exactly the specified range of functions
          awk '
            /^[a-z_-]+\(\) \{$/ {
              in_func=1
              func_count++
              if (func_count >= ${{ matrix.start }} && func_count <= ${{ matrix.end }}) {
                capture=1
              }
            }
            capture && in_func { print }
            /^}$/ && in_func {
              in_func=0
              if (capture && func_count == ${{ matrix.end }}) {
                exit
              }
              if (func_count > ${{ matrix.end }}) {
                exit
              }
              capture=0
            }
          ' /tmp/full-glosses.sh > /tmp/batch-${{ matrix.batch }}.sh
          
          lines_extracted=$(wc -l < /tmp/batch-${{ matrix.batch }}.sh)
          echo "Lines extracted: $lines_extracted"
          echo "Functions in batch: ${{ matrix.start }}-${{ matrix.end }}"
          
          if [ "$lines_extracted" -eq 0 ]; then
            echo "ERROR: No functions extracted!"
            exit 1
          fi
          
          echo ""
          echo "First 10 lines of batch:"
          head -10 /tmp/batch-${{ matrix.batch }}.sh
          echo ""
          echo "Last 10 lines of batch:"
          tail -10 /tmp/batch-${{ matrix.batch }}.sh
      
      - name: Source batch and test with banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing batch ${{ matrix.batch }}..."
          . /tmp/batch-${{ matrix.batch }}.sh
          echo "âœ“ Batch sourced successfully"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! Batch ${{ matrix.batch }} passed"

  # ============================================================================
  # WORKFLOW #46: Test individual functions 31-40 (batch 4 isolation)
  # ============================================================================
  test-individual-functions-batch4:
    if: false  # DISABLED - workflows #16-46 disabled after #47 confirmed first-word gloss pattern bug
    name: "#46 Ubuntu - Individual function ${{ matrix.func_num }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        func_num: [31, 32, 33, 34, 35, 36, 37, 38, 39, 40]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Extract and test function ${{ matrix.func_num }}
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Generating full glosses..."
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          echo "Extracting function number ${{ matrix.func_num }}..."
          
          # Extract exactly the specified function
          awk '
            /^[a-z_-]+\(\) \{$/ {
              in_func=1
              func_count++
              if (func_count == ${{ matrix.func_num }}) {
                capture=1
                func_name=$1
                print "# Function " func_count ": " func_name
              }
            }
            capture && in_func { print }
            /^}$/ && in_func {
              in_func=0
              if (capture) {
                exit
              }
            }
          ' /tmp/full-glosses.sh > /tmp/func-${{ matrix.func_num }}.sh
          
          lines_extracted=$(wc -l < /tmp/func-${{ matrix.func_num }}.sh)
          echo "Lines extracted: $lines_extracted"
          
          if [ "$lines_extracted" -eq 0 ]; then
            echo "ERROR: Function ${{ matrix.func_num }} not found!"
            exit 1
          fi
          
          echo ""
          echo "Function ${{ matrix.func_num }} content:"
          cat /tmp/func-${{ matrix.func_num }}.sh
          echo ""
          
          # Source invoke-wizardry first to load banish
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Sourcing function ${{ matrix.func_num }}..."
          . /tmp/func-${{ matrix.func_num }}.sh
          echo "âœ“ Function sourced successfully"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! Function ${{ matrix.func_num }} passed"

  # ============================================================================
  # WORKFLOW #47: Test yaml() function manually (bypass extraction)
  # ============================================================================
  test-yaml-manual:
    name: "#47 Ubuntu - Manual yaml() test (no extraction)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Manually define yaml() and test with banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Source invoke-wizardry first to get banish
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced (banish available)"
          
          echo ""
          echo "Manually defining yaml() function..."
          
          # Manually define yaml() exactly as it appears in the glosses
          yaml() {
            # Try progressively longer spell names to find uncastable spells
            _fw_spell="yaml"
            _fw_words_used=0
            _fw_spell_home=${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}
            
            for _fw_arg in "$@"; do
              # Skip flags and pure numeric arguments (they're not part of command names)
              case "$_fw_arg" in
                -*) break ;;  # Flag - stop looking for command words
                *[!0-9]*) ;; # Contains non-numeric - it's a command word, continue
                *) break ;;  # Pure numeric - stop looking for command words
              esac
              
              _fw_candidate="${_fw_spell}-${_fw_arg}"
              _fw_words_used=$((_fw_words_used + 1))
              
              # Look for spell file in wizardry directories
              _fw_found=0
              for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                _fw_path="${_fw_dir}${_fw_candidate}"
                if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                  # Found uncastable spell - source it with remaining args after consuming used words
                  shift "$_fw_words_used"
                  . "$_fw_path"
                  return $?
                fi
              done
              
              # Check if candidate is a synonym
              _fw_syn_target=""
              if [ -f "$_fw_spell_home/.synonyms" ]; then
                _fw_syn_target=$(grep "^${_fw_candidate}=" "$_fw_spell_home/.synonyms" 2>/dev/null | sed 's/^[^=]*=//' || true)
              fi
              if [ -z "$_fw_syn_target" ] && [ -f "$_fw_spell_home/.default-synonyms" ]; then
                _fw_syn_target=$(grep "^${_fw_candidate}=" "$_fw_spell_home/.default-synonyms" 2>/dev/null | sed 's/^[^=]*=//' || true)
              fi
              if [ -n "$_fw_syn_target" ]; then
                # Found synonym - check if target is uncastable
                for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                  _fw_path="${_fw_dir}${_fw_syn_target}"
                  if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                    shift "$_fw_words_used"
                    . "$_fw_path"
                    return $?
                  fi
                done
              fi
              
              _fw_spell="$_fw_candidate"
            done
            
            # No uncastable spell found - use parse for normal spells
            parse "$_fw_spell" "$@"
          }
          
          echo "âœ“ yaml() function defined"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! yaml() worked without crash"

  # ============================================================================
  # WORKFLOW #48: Test function from batch 1 (which passed)
  # ============================================================================
  test-batch1-function:
    name: "#48 Ubuntu - Test function from batch 1 (control)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test function from batch 1 manually
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          # Generate full glosses to see what batch 1 functions look like
          echo "Generating glosses to extract function 5 (from batch 1)..."
          spells/.wizardry/generate-glosses > /tmp/full-glosses.sh
          
          # Extract function 5 (from batch 1 which passed)
          echo "Extracting function 5..."
          awk '
            BEGIN { func_count=0; in_func=0 }
            /^[a-z_-]+\(\) \{$/ { 
              in_func=1
              func_count++
              if (func_count == 5) found=1
            }
            in_func && found { print }
            /^}$/ && in_func && found { exit }
          ' /tmp/full-glosses.sh > /tmp/func-5.sh
          
          lines_extracted=$(wc -l < /tmp/func-5.sh)
          echo "Lines extracted: $lines_extracted"
          
          echo ""
          echo "Function 5 content:"
          cat /tmp/func-5.sh
          echo ""
          
          # Source invoke-wizardry first
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Sourcing function 5..."
          . /tmp/func-5.sh
          echo "âœ“ Function sourced successfully"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! Function 5 from batch 1 passed"

  # ============================================================================
  # WORKFLOW #49: Test banish without any first-word glosses
  # Hypothesis: Banish itself doesn't crash, only when combined with glosses
  # Expected: PASS (banish works fine alone)
  # ============================================================================
  test-banish-without-glosses:
    name: "#49 Ubuntu - Test banish without first-word glosses"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test banish without glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry (loads banish and other imps)..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Testing banish 8 without any first-word glosses..."
          banish 8
          echo "âœ“ SUCCESS! Banish works fine without glosses"

  # ============================================================================
  # WORKFLOW #50: Test simple non-first-word-gloss function with banish
  # Hypothesis: Regular functions don't crash with banish, only first-word glosses
  # Expected: PASS
  # ============================================================================
  test-simple-function-with-banish:
    name: "#50 Ubuntu - Test simple function (non-gloss) with banish"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test simple function with banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Defining a simple test function (not a first-word gloss)..."
          simple_test() {
            echo "Simple function called with: $@"
          }
          echo "âœ“ Simple function defined"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! Simple function + banish worked"

  # ============================================================================
  # WORKFLOW #51: Test minimal first-word gloss (no variable names from yaml)
  # Hypothesis: The specific variable names (_fw_spell, _fw_arg, etc.) might conflict
  # Expected: If PASS, variable names are the issue. If FAIL, it's the pattern itself
  # ============================================================================
  test-minimal-first-word-gloss:
    name: "#51 Ubuntu - Test minimal first-word gloss with different vars"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test minimal first-word gloss
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Defining minimal first-word gloss with different variable names..."
          testgloss() {
            my_spell="testgloss"
            my_home=${HOME:-.}
            
            for my_arg in "$@"; do
              case "$my_arg" in
                -*) break ;;
                *) ;;
              esac
              my_spell="${my_spell}-${my_arg}"
            done
            
            echo "Test gloss called: $my_spell"
          }
          echo "âœ“ Minimal gloss defined"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS! Minimal gloss worked"

  # ============================================================================
  # WORKFLOW #52: Test yaml() but call it before running banish
  # Hypothesis: Maybe the function needs to be executed to cause the crash
  # Expected: If FAIL even when called, execution matters. If PASS, definition alone is the issue
  # ============================================================================
  test-yaml-execute-before-banish:
    name: "#52 Ubuntu - Execute yaml() before running banish"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test yaml() with execution before banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Defining yaml() function..."
          yaml() {
            _fw_spell="yaml"
            _fw_words_used=0
            _fw_spell_home=${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}
            
            for _fw_arg in "$@"; do
              case "$_fw_arg" in
                -*) break ;;
                *[!0-9]*) ;;
                *) break ;;
              esac
              
              _fw_candidate="${_fw_spell}-${_fw_arg}"
              _fw_words_used=$((_fw_words_used + 1))
              
              _fw_found=0
              for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                _fw_path="${_fw_dir}${_fw_candidate}"
                if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                  shift "$_fw_words_used"
                  . "$_fw_path"
                  return $?
                fi
              done
              
              _fw_spell="$_fw_candidate"
            done
            
            parse "$_fw_spell" "$@"
          }
          echo "âœ“ yaml() defined"
          
          echo ""
          echo "Executing yaml() function with test arg..."
          yaml --help 2>/dev/null || echo "yaml returned: $?"
          echo "âœ“ yaml() executed"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS!"

  # ============================================================================
  # WORKFLOW #53: Test if it's the parse/shift commands causing issues
  # Hypothesis: The shift command in first-word glosses might corrupt state
  # Expected: If PASS, shift is the issue. If FAIL, something else
  # ============================================================================
  test-first-word-gloss-no-shift:
    name: "#53 Ubuntu - First-word gloss without shift/parse"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test first-word gloss without shift/parse
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Defining simplified yaml() without shift/parse..."
          yaml() {
            local spell="yaml"
            local words_used=0
            
            for arg in "$@"; do
              case "$arg" in
                -*) break ;;
                *[!0-9]*) ;;
                *) break ;;
              esac
              
              spell="${spell}-${arg}"
              words_used=$((words_used + 1))
            done
            
            echo "Would call: $spell with $words_used words consumed"
            return 0
          }
          echo "âœ“ Simplified yaml() defined"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS!"

  # ============================================================================
  # WORKFLOW #54: Load banish directly without invoke-wizardry
  # Hypothesis: Banish works fine when loaded directly
  # Expected: PASS - proves invoke-wizardry corrupts banish
  # ============================================================================
  test-banish-direct-load:
    name: "#54 Ubuntu - Load banish directly (bypass invoke-wizardry)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test banish loaded directly
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Loading banish directly (NOT via invoke-wizardry)..."
          . spells/.imps/ops/banish
          echo "âœ“ banish loaded directly"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS!"

  # ============================================================================
  # WORKFLOW #55: Test other imps after invoke-wizardry
  # Hypothesis: All imps crash after invoke-wizardry, not just banish
  # Expected: Shows scope of issue
  # ============================================================================
  test-other-imps-after-invoke:
    name: "#55 Ubuntu - Test other imps after invoke-wizardry"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test other imps after invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Sourcing invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          echo "âœ“ invoke-wizardry sourced"
          
          echo ""
          echo "Testing say imp..."
          say "test message" 2>/dev/null || echo "say returned: $?"
          echo "âœ“ say works"
          
          echo ""
          echo "Testing has imp..."
          has bash || echo "has returned: $?"
          echo "âœ“ has works"
          
          echo ""
          echo "Testing banish..."
          banish 8
          echo "âœ“ banish works"
          
          echo ""
          echo "âœ“ SUCCESS - All imps work!"

  # ============================================================================
  # WORKFLOW #56: Minimal invoke-wizardry emulation
  # Hypothesis: Something specific invoke-wizardry does breaks banish
  # Expected: Identifies what action causes corruption
  # ============================================================================
  test-minimal-invoke-emulation:
    name: "#56 Ubuntu - Minimal invoke-wizardry emulation"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Make scripts executable
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
      
      - name: Test minimal invoke-wizardry emulation
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Manually loading imps one by one..."
          
          # Load core imps in order
          echo "Loading basic imps..."
          . spells/.imps/cond/has
          . spells/.imps/out/say
          . spells/.imps/out/warn
          . spells/.imps/out/die
          . spells/.imps/out/fail
          echo "âœ“ Basic imps loaded"
          
          echo ""
          echo "Loading banish..."
          . spells/.imps/ops/banish
          echo "âœ“ banish loaded"
          
          echo ""
          echo "Running banish 8..."
          banish 8
          echo "âœ“ SUCCESS!"
  
  # ============================================================================
  # WORKFLOW #57: Test malformed eval hypothesis  
  # ============================================================================
  test-malformed-eval:
    name: "#57 Ubuntu - Test malformed eval in banish"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Test malformed eval command
        run: |
          export WIZARDRY_DIR="${PWD}"
          
          echo "Testing malformed eval (current banish code)..."
          echo 'eval ""echo" test"' > /tmp/test-malformed.sh
          chmod +x /tmp/test-malformed.sh
          
          echo "Running malformed eval..."
          if bash /tmp/test-malformed.sh 2>/dev/null; then
            echo "âœ“ Malformed eval did NOT crash"
          else
            echo "âœ— Malformed eval crashed with exit code: $?"
          fi
          
          echo ""
          echo "Testing corrected eval..."
          echo 'eval "echo test"' > /tmp/test-correct.sh
          chmod +x /tmp/test-correct.sh
          
          echo "Running corrected eval..."
          if bash /tmp/test-correct.sh 2>/dev/null; then
            echo "âœ“ Corrected eval worked"
          else
            echo "âœ— Corrected eval failed with exit code: $?"
          fi
          
          echo ""
          echo "Now testing actual banish with invoke-wizardry..."
          . spells/.imps/sys/invoke-wizardry
          
          echo "Running banish 1 (will test eval at line 998)..."
          banish 1
          echo "âœ“ banish completed!"
