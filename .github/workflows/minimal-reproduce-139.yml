name: Minimal Reproduce Exit 139

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # WORKFLOW #1: Minimal NixOS declare() reproduction
  # ============================================================================
  nix-minimal-declare-repro:
    name: "#1 Nix - Minimal declare() function reproduction"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Create minimal glosses with ONLY declare() function
        run: |
          # Create a minimal glosses file that contains ONLY the declare() function
          # This is the exact code from lines 12823-12874 that causes the segfault
          cat > /tmp/minimal-glosses.sh <<'EOF'
          # First-word gloss for commands starting with 'declare'
          declare() {
            # Try progressively longer spell names to find uncastable spells
            _fw_spell="declare"
            _fw_words_used=0
            _fw_spell_home=${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}
            
            for _fw_arg in "$@"; do
              # Skip flags and pure numeric arguments (they're not part of command names)
              case "$_fw_arg" in
                -*) break ;;  # Flag - stop looking for command words
                *[!0-9]*) ;; # Contains non-numeric - it's a command word, continue
                *) break ;;  # Pure numeric - stop looking for command words
              esac
              
              _fw_candidate="${_fw_spell}-${_fw_arg}"
              _fw_words_used=$((_fw_words_used + 1))
              
              # Look for spell file in wizardry directories
              _fw_found=0
              for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                _fw_path="${_fw_dir}${_fw_candidate}"
                if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                  # Found uncastable spell - source it with remaining args after consuming used words
                  shift "$_fw_words_used"
                  . "$_fw_path"
                  return $?
                fi
              done
              
              _fw_spell="$_fw_candidate"
            done
            
            # No uncastable spell found - use parse for normal spells
            parse "$_fw_spell" "$@"
          }
          EOF
          
          wc -l /tmp/minimal-glosses.sh
          echo "Created minimal glosses with declare() function"
      
      - name: Test sourcing declare() in nix-shell
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            echo 'About to source minimal glosses with declare() function...'
            . /tmp/minimal-glosses.sh
            echo 'SUCCESS! Sourced declare() without crash'
            echo 'Now attempting to use declare builtin...'
            declare -F | head -5 || echo 'declare -F failed with exit code: \$?'
          "
  
  # ============================================================================  
  # WORKFLOW #2: Ubuntu/Arch minimal full invoke-wizardry test
  # ============================================================================
  ubuntu-full-invoke-test:
    name: "#2 Ubuntu - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose

  # ============================================================================
  # WORKFLOW #3: Ubuntu without invoke-wizardry (isolate glosses)
  # ============================================================================
  ubuntu-glosses-only:
    name: "#3 Ubuntu - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"
          
          # Try using a gloss
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #4: Arch without invoke-wizardry
  # ============================================================================
  arch-glosses-only:
    name: "#4 Arch - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"

  # ============================================================================
  # WORKFLOW #5: Ubuntu with invoke-wizardry but NO banish
  # ============================================================================
  ubuntu-invoke-no-banish:
    name: "#5 Ubuntu - invoke-wizardry without banish"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry only (skip banish)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry without banish..."
          . spells/.imps/sys/invoke-wizardry
          echo "SUCCESS! invoke-wizardry completed"
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #6: Ubuntu with banish but NO test-magic
  # ============================================================================
  ubuntu-banish-no-test:
    name: "#6 Ubuntu - invoke-wizardry + banish only (no test-magic)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry + banish 8 (skip test-magic)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry + banish without test-magic..."
          . spells/.imps/sys/invoke-wizardry && banish 8
          echo "SUCCESS! banish completed"

  # ============================================================================
  # WORKFLOW #7: Arch full test (original failure)
  # ============================================================================
  arch-full-invoke-test:
    name: "#7 Arch - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose
