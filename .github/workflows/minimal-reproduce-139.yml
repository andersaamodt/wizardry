name: Minimal Reproduction - Exit 139 on Arch/Ubuntu

# This workflow contains individually-numbered tests to isolate the cause
# of exit code 139 on Arch/Ubuntu (distinct from NixOS declare() bug)

on:
  pull_request:
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: minimal-139-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Test #86: && chaining with invoke-wizardry + banish (expected to crash)
  test-86-and-chaining:
    name: "#86: && chaining (reproduce crash)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test && chaining
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing && chaining with invoke-wizardry and banish..."
          . spells/.imps/sys/invoke-wizardry && banish 4

  # Test #87: Separate lines without && (test if this avoids crash)
  test-87-separate-lines:
    name: "#87: Separate lines (no &&)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test separate lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing separate lines without && chaining..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # Test #88: Semicolon separator (test alternative to &&)
  test-88-semicolon:
    name: "#88: Semicolon separator"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test semicolon separator
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing semicolon separator..."
          . spells/.imps/sys/invoke-wizardry; banish 4

  # Test #89: Script wrapper approach
  test-89-script-wrapper:
    name: "#89: Script wrapper"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create test script
        run: |
          cat > /tmp/test-banish.sh <<'SCRIPT'
          #!/bin/sh
          export WIZARDRY_DIR="${1}"
          . "${WIZARDRY_DIR}/spells/.imps/sys/invoke-wizardry"
          banish 4
          SCRIPT
          chmod +x /tmp/test-banish.sh
      
      - name: Run test script
        run: /tmp/test-banish.sh "${PWD}"

  # Test #90: Minimal banish without invoke-wizardry
  test-90-banish-standalone:
    name: "#90: Banish without invoke-wizardry"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test banish standalone
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing banish standalone (source banish directly)..."
          # Source banish directly without invoke-wizardry
          . spells/.imps/ops/banish
          echo "Banish function loaded, now calling it..."
          banish 4

  # Test #91: Test with different banish levels
  test-91-banish-levels:
    name: "#91: Different banish levels"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test banish 1
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 1..."
          banish 1
      
      - name: Test banish 2
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 2..."
          banish 2
      
      - name: Test banish 3
        run: |
          export WIZARDRY_DIR="${PWD}"
          . spells/.imps/sys/invoke-wizardry
          echo "Testing banish 3..."
          banish 3

  # Test #92: Test on Arch Linux specifically
  test-92-arch-linux:
    name: "#92: Arch Linux test"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install git
        run: pacman -Sy --noconfirm git
      
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test invoke-wizardry + banish on Arch
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing on Arch Linux..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # Test #93: Test with bash tracing enabled
  test-93-bash-tracing:
    name: "#93: With bash tracing"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test with tracing
        run: |
          set -x
          export WIZARDRY_DIR="${PWD}"
          echo "Testing with bash tracing..."
          . spells/.imps/sys/invoke-wizardry
          echo "invoke-wizardry sourced"
          banish 4
          echo "banish completed"

  # Test #94: Test with minimal environment
  test-94-minimal-env:
    name: "#94: Minimal environment"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test in minimal env
        run: |
          env -i PWD="${PWD}" HOME="${HOME}" PATH="/usr/bin:/bin" sh -c '
            export WIZARDRY_DIR="${PWD}"
            . spells/.imps/sys/invoke-wizardry
            banish 4
          '

  # Test #95: Test without generating glosses
  test-95-no-glosses:
    name: "#95: Without gloss generation"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test without glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          export WIZARDRY_NO_GLOSSES=1
          echo "Testing without gloss generation..."
          . spells/.imps/sys/invoke-wizardry
          banish 4

  # NixOS-specific tests - narrow down the line ranges that cause segfault
  # Based on PR #940 investigation that narrowed to Decile 9 (lines 12807-12840)
  
  test-96-nix-decile-9:
    name: "#96: NixOS - Decile 9 (lines 12807-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh
          # Extract functions starting in lines 12807-12840
          awk -v start="12807" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 glosses:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 completed without crash'
          "

  test-97-nix-decile-9-sub-1:
    name: "#97: NixOS - Decile 9 Sub 1 (lines 12807-12820)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9 Sub 1
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          # Extract functions starting in lines 12807-12820 (first half)
          awk -v start="12807" -v end="12820" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 Sub 1:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9 Sub 1
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 Sub 1 completed'
          "

  test-98-nix-decile-9-sub-2:
    name: "#98: NixOS - Decile 9 Sub 2 (lines 12821-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Decile 9 Sub 2
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          # Extract functions starting in lines 12821-12840 (second half)
          awk -v start="12821" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Decile 9 Sub 2:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Decile 9 Sub 2
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Decile 9 Sub 2 completed'
          "

  test-99-nix-full-glosses:
    name: "#99: NixOS - Full glosses (baseline test)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate full glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          wc -l /tmp/glosses_full.sh

      - name: Source full glosses (expected to crash with exit 139)
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_full.sh
            echo 'SUCCESS! Full glosses completed (if this prints, bug is fixed!)'
          "

  # New hypotheses based on test results analysis
  
  # H1: Test if invoke-wizardry itself crashes without calling any functions
  test-100-invoke-only:
    name: "#100: Invoke-wizardry only (no function calls)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source invoke-wizardry without calling functions
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing invoke-wizardry without calling any functions..."
          . spells/.imps/sys/invoke-wizardry
          echo "SUCCESS! invoke-wizardry sourced without crash"

  # H2: Test calling a simple imp function (not banish) after invoke-wizardry
  test-101-invoke-then-say:
    name: "#101: Invoke + call 'say' function"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source invoke-wizardry and call say
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry + say..."
          . spells/.imps/sys/invoke-wizardry
          say "Test message"
          echo "SUCCESS! say function worked"

  # H3: Test if the crash happens with just PATH modification
  test-102-path-only:
    name: "#102: Manual PATH setup (no invoke-wizardry)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Manually set PATH and call banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          export PATH="${WIZARDRY_DIR}/spells/.glossary:${PATH}"
          echo "Calling banish via PATH without invoke-wizardry..."
          banish 4
          echo "SUCCESS! banish worked via PATH alone"

  # H4: Test sourcing individual imps without invoke-wizardry
  test-103-source-imps-directly:
    name: "#103: Source imps directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Source imps directly
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing imps directly..."
          . spells/.imps/out/say
          . spells/.imps/wards/banish
          echo "Calling banish..."
          banish 4
          echo "SUCCESS! Direct imp sourcing worked"

  # H5: Test if it's the combination of glosses + invoke-wizardry
  test-104-glosses-without-invoke:
    name: "#104: Source glosses without invoke-wizardry"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate and source glosses directly
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          echo "Sourcing glosses without invoke-wizardry..."
          . /tmp/glosses.sh
          echo "Calling banish..."
          banish 4
          echo "SUCCESS! Glosses worked without invoke-wizardry"

  # H6: NixOS - Narrow to lines 12827-12833 (middle of Sub 2)
  test-105-nix-decile-9-sub-2a:
    name: "#105: NixOS - Decile 9 Sub 2a (lines 12821-12827)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2a
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12821" -v end="12827" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2a:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2a
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2a completed'
          "

  # H7: NixOS - Narrow to lines 12828-12834 (second half of Sub 2)
  test-106-nix-decile-9-sub-2b:
    name: "#106: NixOS - Decile 9 Sub 2b (lines 12828-12834)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2b
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12828" -v end="12834" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2b:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2b
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2b completed'
          "

  # H8: NixOS - Narrow to lines 12835-12840 (last part of Sub 2)
  test-107-nix-decile-9-sub-2c:
    name: "#107: NixOS - Decile 9 Sub 2c (lines 12835-12840)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate and extract Sub 2c
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses_full.sh
          awk -v start="12835" -v end="12840" '
            /^[a-zA-Z_][a-zA-Z0-9_-]* *\(\)/ {
              in_func = 1
              func_start = NR
              func_lines = $0 "\n"
              next
            }
            in_func {
              func_lines = func_lines $0 "\n"
              if (/^}$/) {
                if (func_start >= start && func_start <= end) {
                  printf "%s", func_lines
                }
                in_func = 0
              }
            }
          ' /tmp/glosses_full.sh > /tmp/glosses_decile.sh
          echo "Extracted Sub 2c:"
          wc -l /tmp/glosses_decile.sh

      - name: Test Sub 2c
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses_decile.sh
            echo 'SUCCESS! Sub 2c completed'
          "
