name: Minimal Reproduce Exit 139

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # WORKFLOW #1: Minimal NixOS declare() reproduction
  # ============================================================================
  nix-minimal-declare-repro:
    name: "#1 Nix - Minimal declare() function reproduction"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Create minimal glosses with ONLY declare() function
        run: |
          # Create a minimal glosses file that contains ONLY the declare() function
          # This is the exact code from lines 12823-12874 that causes the segfault
          cat > /tmp/minimal-glosses.sh <<'EOF'
          # First-word gloss for commands starting with 'declare'
          declare() {
            # Try progressively longer spell names to find uncastable spells
            _fw_spell="declare"
            _fw_words_used=0
            _fw_spell_home=${SPELLBOOK_DIR:-${HOME:-.}/.spellbook}
            
            for _fw_arg in "$@"; do
              # Skip flags and pure numeric arguments (they're not part of command names)
              case "$_fw_arg" in
                -*) break ;;  # Flag - stop looking for command words
                *[!0-9]*) ;; # Contains non-numeric - it's a command word, continue
                *) break ;;  # Pure numeric - stop looking for command words
              esac
              
              _fw_candidate="${_fw_spell}-${_fw_arg}"
              _fw_words_used=$((_fw_words_used + 1))
              
              # Look for spell file in wizardry directories
              _fw_found=0
              for _fw_dir in "$WIZARDRY_DIR"/spells/*/; do
                _fw_path="${_fw_dir}${_fw_candidate}"
                if [ -f "$_fw_path" ] && grep -q "^# Uncastable pattern" "$_fw_path" 2>/dev/null; then
                  # Found uncastable spell - source it with remaining args after consuming used words
                  shift "$_fw_words_used"
                  . "$_fw_path"
                  return $?
                fi
              done
              
              _fw_spell="$_fw_candidate"
            done
            
            # No uncastable spell found - use parse for normal spells
            parse "$_fw_spell" "$@"
          }
          EOF
          
          wc -l /tmp/minimal-glosses.sh
          echo "Created minimal glosses with declare() function"
      
      - name: Test sourcing declare() in nix-shell
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            echo 'About to source minimal glosses with declare() function...'
            . /tmp/minimal-glosses.sh
            echo 'SUCCESS! Sourced declare() without crash'
            echo 'Now attempting to use declare builtin...'
            declare -F | head -5 || echo 'declare -F failed with exit code: \$?'
          "
  
  # ============================================================================  
  # WORKFLOW #2: Ubuntu/Arch minimal full invoke-wizardry test
  # ============================================================================
  ubuntu-full-invoke-test:
    name: "#2 Ubuntu - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 root
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose

  # ============================================================================
  # WORKFLOW #3: Ubuntu without invoke-wizardry (isolate glosses)
  # ============================================================================
  ubuntu-glosses-only:
    name: "#3 Ubuntu - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"
          
          # Try using a gloss
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #4: Arch without invoke-wizardry
  # ============================================================================
  arch-glosses-only:
    name: "#4 Arch - Source glosses directly (no invoke-wizardry)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Generate and source glosses without invoke-wizardry
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses.sh
          wc -l /tmp/glosses.sh
          
          echo "Sourcing glosses directly..."
          . /tmp/glosses.sh
          echo "SUCCESS! Glosses sourced"

  # ============================================================================
  # WORKFLOW #5: Ubuntu with invoke-wizardry but NO banish
  # ============================================================================
  ubuntu-invoke-no-banish:
    name: "#5 Ubuntu - invoke-wizardry without banish"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry only (skip banish)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry without banish..."
          . spells/.imps/sys/invoke-wizardry
          echo "SUCCESS! invoke-wizardry completed"
          type banish || echo "banish not found"

  # ============================================================================
  # WORKFLOW #6: Ubuntu with banish but NO test-magic
  # ============================================================================
  ubuntu-banish-no-test:
    name: "#6 Ubuntu - invoke-wizardry + banish only (no test-magic)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run invoke-wizardry + banish 8 (skip test-magic)
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Testing invoke-wizardry + banish without test-magic..."
          . spells/.imps/sys/invoke-wizardry && banish 8
          echo "SUCCESS! banish completed"

  # ============================================================================
  # WORKFLOW #7: Arch full test (original failure)
  # ============================================================================
  arch-full-invoke-test:
    name: "#7 Arch - Full invoke-wizardry + banish test (original failure)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Run full invoke-wizardry + banish 8 + test-magic
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Running the exact command that fails with exit 139..."
          . spells/.imps/sys/invoke-wizardry && banish 8 && ./spells/.wizardry/test-magic --verbose

  # ============================================================================
  # WORKFLOW #8: NixOS Decile 9-5 exact reproduction from PR #940
  # ============================================================================
  nix-decile-9-5-exact:
    name: "#8 Nix - Decile 9 Sub 5 (lines 12823-12826) from PR #940"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Generate glosses and extract Decile 9 Sub 5
        run: |
          export WIZARDRY_DIR="${PWD}"
          cd spells/.wizardry
          ./generate-glosses > /tmp/glosses-full.sh
          # Extract lines 12823-12826 (4 lines) - this is the exact test from PR #940 decile 9-5
          awk 'NR>=12823 && NR<=12826 && /^[a-z_-]+ *\(\)/ {in_func=1} in_func {print; if (/^}$/) in_func=0}' /tmp/glosses-full.sh > /tmp/glosses.sh
          echo "Decile 9 Sub 5 (lines 12823-12826):"
          wc -l /tmp/glosses.sh
          echo "Content:"
          cat /tmp/glosses.sh
      
      - name: Source and test in nix-shell
        run: |
          WIZARDRY_DIR="${PWD}"
          nix-shell -p bash --run "
            export WIZARDRY_DIR='${WIZARDRY_DIR}'
            . /tmp/glosses.sh
            ./spells/.wizardry/test-magic --verbose
            echo 'SUCCESS! Decile 9 Sub 5 completed'
          "

  # ============================================================================
  # WORKFLOW #9: Ubuntu banish in isolation (no glosses)
  # ============================================================================
  ubuntu-banish-no-glosses:
    name: "#9 Ubuntu - banish without glosses (direct execution)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Run banish directly without glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          export PATH="${WIZARDRY_DIR}/spells/.imps/out:${PATH}"
          export PATH="${WIZARDRY_DIR}/spells/.imps/cond:${PATH}"
          export PATH="${WIZARDRY_DIR}/spells/wards:${PATH}"
          echo "Running banish 8 directly without sourcing glosses..."
          ./spells/wards/banish 8
          echo "SUCCESS! banish completed without glosses"

  # ============================================================================
  # WORKFLOW #10: REMOVED (word-of-binding doesn't exist)
  # ============================================================================
  
  # ============================================================================
  # WORKFLOW #11: Ubuntu - Source ONLY declare() function
  # Hypothesis: declare() function definition itself causes segfault
  # Expected: FAIL (exit 139)
  # ============================================================================
  ubuntu-only-declare-function:
    name: "#11 Ubuntu - Source ONLY declare() (expect FAIL)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create minimal script with ONLY declare() function
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract ONLY the declare() function (lines 12823-12926)
          awk 'NR==12823,/^}$/ && NR>12823 {print; if (/^}$/) exit}' /tmp/full-glosses.sh > /tmp/only-declare.sh
          echo "# First-word gloss for commands starting with 'declare'" | cat - /tmp/only-declare.sh > /tmp/declare-gloss.sh
          
          wc -l /tmp/declare-gloss.sh
          echo "--- Content of declare-gloss.sh ---"
          head -20 /tmp/declare-gloss.sh
      
      - name: Source declare() and test
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing ONLY declare() function..."
          . /tmp/declare-gloss.sh
          echo "SUCCESS! declare() sourced without crash"
          
          # Try using declare
          type declare || echo "declare not available"
  
  # ============================================================================
  # WORKFLOW #12: Ubuntu - Source all glosses EXCEPT declare()
  # Hypothesis: Other glosses work fine, only declare() causes the issue
  # Expected: PASS
  # ============================================================================
  ubuntu-glosses-except-declare:
    name: "#12 Ubuntu - All glosses EXCEPT declare() (expect PASS)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate glosses without declare()
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Remove the declare() function (lines 12823-12926)
          awk 'NR<12823 || NR>12926' /tmp/full-glosses.sh > /tmp/glosses-no-declare.sh
          
          echo "Original glosses: $(wc -l < /tmp/full-glosses.sh) lines"
          echo "Without declare: $(wc -l < /tmp/glosses-no-declare.sh) lines"
          echo "Removed: $(($(wc -l < /tmp/full-glosses.sh) - $(wc -l < /tmp/glosses-no-declare.sh))) lines"
      
      - name: Source glosses and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Sourcing all glosses EXCEPT declare()..."
          . /tmp/glosses-no-declare.sh
          echo "SUCCESS! Glosses sourced"
          
          echo "Running banish 8..."
          banish 8
          echo "SUCCESS! banish completed"
  
  # ============================================================================
  # WORKFLOW #13: Ubuntu - Just the 4 lines from decile 9-5 (12823-12826)
  # Hypothesis: Even these 4 lines alone trigger the issue
  # Expected: Unclear - may PASS if incomplete function is okay
  # ============================================================================
  ubuntu-4-lines-only:
    name: "#13 Ubuntu - Only 4 lines 12823-12826 (exploratory)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create file with ONLY 4 lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract EXACTLY 4 lines (12823-12826)
          awk 'NR>=12823 && NR<=12826' /tmp/full-glosses.sh > /tmp/4-lines.sh
          
          echo "--- Exact 4 lines extracted ---"
          cat /tmp/4-lines.sh
      
      - name: Try to source the 4 lines
        run: |
          export WIZARDRY_DIR="${PWD}"
          echo "Attempting to source 4 lines..."
          . /tmp/4-lines.sh || echo "Failed to source (expected - incomplete function)"
          echo "Test completed"
  
  # ============================================================================
  # WORKFLOW #14: Arch - Source ONLY declare() function
  # Hypothesis: Same as #11 but on Arch to see if platform-specific
  # Expected: FAIL (exit 139) if same root cause
  # ============================================================================
  arch-only-declare-function:
    name: "#14 Arch - Source ONLY declare() (expect FAIL)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      WIZARDRY_OS_LABEL: arch
    
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git
      
      - uses: actions/checkout@v4
      
      - name: Create and source ONLY declare() function
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          
          # Extract ONLY the declare() function
          awk 'NR==12823,/^}$/ && NR>12823 {print; if (/^}$/) exit}' /tmp/full-glosses.sh > /tmp/only-declare.sh
          echo "# First-word gloss for commands starting with 'declare'" | cat - /tmp/only-declare.sh > /tmp/declare-gloss.sh
          
          wc -l /tmp/declare-gloss.sh
          
          echo "Sourcing ONLY declare() function..."
          . /tmp/declare-gloss.sh
          echo "SUCCESS! declare() sourced without crash"
  
  # ============================================================================
  # WORKFLOW #15: Ubuntu - Bisect glosses (first half)
  # Hypothesis: Narrow down which section of glosses contains the problematic function
  # Expected: Either PASS or FAIL - helps narrow down
  # ============================================================================
  ubuntu-glosses-first-half:
    name: "#15 Ubuntu - First half of glosses (exploratory)"
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap uidmap attr file
      
      - name: Setup user namespaces
        run: |
          sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 "$(whoami)"
          {
            echo 'kernel.unprivileged_userns_clone=1'
            echo 'kernel.apparmor_restrict_unprivileged_userns=0'
          } | sudo tee /etc/sysctl.d/99-unprivileged-userns.conf
          sudo sysctl --system
      
      - name: Generate first half of glosses
        run: |
          export WIZARDRY_DIR="${PWD}"
          ./spells/.wizardry/generate-glosses --quiet > /tmp/full-glosses.sh
          total_lines=$(wc -l < /tmp/full-glosses.sh)
          half_lines=$((total_lines / 2))
          
          head -n $half_lines /tmp/full-glosses.sh > /tmp/first-half.sh
          
          echo "Total lines: $total_lines"
          echo "First half: $half_lines lines"
          echo "Line 12823 in range: $(if [ 12823 -le $half_lines ]; then echo YES; else echo NO; fi)"
      
      - name: Source first half and run banish
        run: |
          export WIZARDRY_DIR="${PWD}"
          . /tmp/first-half.sh
          echo "First half sourced successfully"
          banish 8
          echo "SUCCESS!"
