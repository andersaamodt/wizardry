name: "Hypothesis #57 - source-one-at-time"

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup
        run: |
          chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor
          chmod +x spells/.imps/fs/xattr-helper-usable spells/.imps/fs/xattr-list-keys spells/.imps/fs/xattr-read-value
          sudo apt-get update && sudo apt-get install -y attr
      
      - name: Test hypothesis
        run: |
          echo "Testing hypothesis #57: Source each gloss function individually with sync"
          sed -i "/eval.*_glosses/s/.*/while IFS= read -r _line; do eval \"\$_line\"; sync; done < \"\$_gloss_file\"/" spells/.imps/sys/word-of-binding
          . spells/.imps/sys/invoke-wizardry
          banish 8
          ./spells/.wizardry/test-magic --verbose
