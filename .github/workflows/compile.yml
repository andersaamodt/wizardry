name: Compile wizardry

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write  # Required for artifact cleanup

jobs:
  compile:
    name: Compile and package wizardry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create compiled doppelganger
        run: |
          # Set wizardry directory
          export WIZARDRY_DIR="${{ github.workspace }}"
          
          # Call doppelganger directly (as standalone script)
          # Don't source invoke-wizardry here - it would try to pre-load all spells
          # including doppelganger itself, creating a circular dependency
          "${{ github.workspace }}/spells/spellcraft/doppelganger" /tmp/wizardry-compiled

          echo "=== Doppelganger created ==="
          ls -la /tmp/wizardry-compiled/

          # Verify spells directory exists
          if [ ! -d "/tmp/wizardry-compiled/spells" ]; then
            echo "ERROR: spells directory not created"
            exit 1
          fi

          echo ""
          echo "=== Spells directory structure ==="
          find /tmp/wizardry-compiled/spells -type d | head -20

      - name: Remove excluded files from compiled directory
        run: |
          cd /tmp/wizardry-compiled

          # Remove SKIP-IF-COMPILED files
          rm -f SKIP-IF-COMPILED-ANALYSIS.md
          rm -f SKIP-IF-COMPILED-SUMMARY.md

          # Remove .tests directory
          rm -rf .tests

          echo "=== Cleaned compiled directory ==="
          ls -la /tmp/wizardry-compiled/

          echo ""
          echo "=== Root files ==="
          find /tmp/wizardry-compiled -maxdepth 1 -type f

          echo ""
          echo "=== Directories ==="
          find /tmp/wizardry-compiled -maxdepth 1 -type d

          echo ""
          echo "=== Spell count ==="
          find /tmp/wizardry-compiled/spells -type f | wc -l

          echo ""
          echo "=== Moving to workspace for upload ==="
          mv /tmp/wizardry-compiled ${{ github.workspace }}/wizardry-compiled

          echo "Moved to workspace. Ready for artifact upload."

      - name: Generate artifact name with date
        id: artifact-name
        run: |
          DATE=$(date +'%Y-%-m-%-d')
          echo "name=wizardry-compiled-${DATE}" >> "$GITHUB_OUTPUT"
          echo "Artifact name: wizardry-compiled-${DATE}"

      - name: Upload compiled wizardry artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: |
            wizardry-compiled/LICENSE
            wizardry-compiled/README.md
            wizardry-compiled/spells/
          retention-days: 90
          if-no-files-found: error

      - name: Clean up old artifacts
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const keepCount = 3;  // Number of recent artifacts to keep

            const msg = `Cleaning up artifacts, keeping ${keepCount}...`;
            console.log(msg);

            // Fetch all artifacts with pagination
            let allArtifacts = [];
            let page = 1;
            const perPage = 100;

            while (true) {
              const response = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: perPage,
                page: page
              });

              if (response.data.artifacts.length === 0) {
                break;
              }

              allArtifacts = allArtifacts.concat(response.data.artifacts);

              // Check if there are more pages
              if (response.data.artifacts.length < perPage) {
                break;
              }

              page++;
            }

            console.log(`Total artifacts found: ${allArtifacts.length}`);

            // Filter for compiled wizardry artifacts
            const prefix = 'wizardry-compiled-';
            const compiledArtifacts = allArtifacts
              .filter(artifact => artifact.name.startsWith(prefix))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const foundMsg = `Found ${compiledArtifacts.length} artifacts`;
            console.log(foundMsg);

            // Keep only the most recent N, delete the rest
            const toDelete = compiledArtifacts.slice(keepCount);

            if (toDelete.length === 0) {
              console.log('No old artifacts to delete');
              return;
            }

            console.log(`Deleting ${toDelete.length} old artifacts...`);

            for (const artifact of toDelete) {
              const delMsg = `Deleting: ${artifact.name}`;
              console.log(delMsg);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`  ✓ Deleted ${artifact.name}`);
              } catch (error) {
                const errMsg = `  ✗ Failed: ${error.message}`;
                console.log(errMsg);
              }
            }

            const kept = Math.min(keepCount, compiledArtifacts.length);
            const doneMsg = `Cleanup complete. Kept ${kept} artifacts`;
            console.log(doneMsg);
