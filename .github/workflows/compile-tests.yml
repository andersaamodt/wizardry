name: Compiled spell tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

jobs:
  compile-and-test:
    name: Test compiled spells for standalone execution
    runs-on: ubuntu-latest
    env:
      WIZARDRY_OS_LABEL: ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Ensure installer spells are executable
        run: chmod +x spells/.arcana/mud/install-mud spells/.arcana/tor/setup-tor
      
      - name: Set up wizardry environment
        run: |
          export WIZARDRY_DIR="${GITHUB_WORKSPACE}"
          . ./spells/.imps/sys/invoke-wizardry
          echo "PATH=$PATH" >> "$GITHUB_ENV"
          echo "WIZARDRY_DIR=$WIZARDRY_DIR" >> "$GITHUB_ENV"
      
      - name: Create compiled spells directory
        run: mkdir -p /tmp/compiled-spells
      
      - name: Compile all spells
        run: |
          . ./spells/.imps/sys/invoke-wizardry
          compiled_count=0
          failed_count=0
          
          echo "=== Compiling spells ==="
          for spell_dir in spells/*; do
            [ -d "$spell_dir" ] || continue
            # Skip special directories
            case "$spell_dir" in
              spells/.imps|spells/.arcana) continue ;;
            esac
            
            for spell in "$spell_dir"/*; do
              [ -f "$spell" ] || continue
              [ -x "$spell" ] || continue
              
              spell_name=$(basename "$spell")
              category=$(basename "$spell_dir")
              
              echo "Compiling: $category/$spell_name"
              if compile-spell "$spell_name" > "/tmp/compiled-spells/${spell_name}" 2>/dev/null; then
                chmod +x "/tmp/compiled-spells/${spell_name}"
                compiled_count=$((compiled_count + 1))
              else
                echo "  Failed to compile $category/$spell_name"
                failed_count=$((failed_count + 1))
              fi
            done
          done
          
          echo ""
          echo "=== Compilation Summary ==="
          echo "Successfully compiled: $compiled_count spells"
          echo "Failed to compile: $failed_count spells"
          echo ""
          ls -1 /tmp/compiled-spells/ | wc -l
          echo "compiled spells in /tmp/compiled-spells/"
      
      - name: Test compiled spells for standalone execution
        run: |
          success_count=0
          fail_count=0
          
          echo "=== Testing compiled spells in isolation ==="
          echo ""
          
          # Test each compiled spell by running its --help
          # This tests if it can execute without wizardry being in PATH
          for compiled in /tmp/compiled-spells/*; do
            [ -f "$compiled" ] || continue
            
            spell_name=$(basename "$compiled")
            
            # Test in isolated environment with minimal PATH
            if env -i PATH="/usr/bin:/bin" "$compiled" --help >/dev/null 2>&1; then
              echo "✓ $spell_name works standalone"
              success_count=$((success_count + 1))
            else
              echo "✗ $spell_name requires wizardry dependencies"
              fail_count=$((fail_count + 1))
            fi
          done
          
          echo ""
          echo "=== Standalone Test Summary ==="
          echo "Working standalone: $success_count spells"
          echo "Requires dependencies: $fail_count spells"
          echo ""
          
          # Fail the workflow if any spell requires dependencies
          # We've achieved 100% standalone compilation, so this should never fail
          if [ "$fail_count" -gt 0 ]; then
            echo "❌ FAILURE: $fail_count spell(s) require dependencies"
            echo "All spells must compile to working standalone scripts."
            echo "This is a regression - please investigate and fix."
            exit 1
          fi
          
          echo "✓ SUCCESS: All $success_count spells work standalone!"
      
      - name: Run test suite against compiled spells
        run: |
          . ./spells/.imps/sys/invoke-wizardry
          
          # Enable compiled spell testing mode
          export WIZARDRY_TEST_COMPILED=1
          export WIZARDRY_COMPILED_DIR="/tmp/compiled-spells"
          
          echo "=== Running full test suite against compiled spells ==="
          echo ""
          echo "Test mode: Compiled spell substitution enabled"
          echo "Compiled directory: $WIZARDRY_COMPILED_DIR"
          echo ""
          
          # Run the test suite with timeout to prevent hanging on interactive tests
          # Some tests (like kill-process) stub interactive spells, but when those
          # spells are inlined in compiled versions, the stubs don't work as expected
          # We use a 5-minute timeout as a reasonable limit for the full test suite
          timeout 300 test-magic || test_result=$?
          
          # timeout returns 124 on timeout, preserve other exit codes
          if [ "${test_result:-0}" -eq 124 ]; then
            echo ""
            echo "❌ Test suite timed out after 5 minutes"
            echo "This usually means a test is hanging due to waiting for user input."
            echo "Some compiled spells with inlined interactive functions may not work"
            echo "with test stubs that expect external commands."
            exit 1
          fi
          
          if [ "${test_result:-0}" -eq 0 ]; then
            echo ""
            echo "✓ SUCCESS: All tests pass with compiled spells!"
          else
            echo ""
            echo "❌ FAILURE: Test suite failed with compiled spells"
            echo "This indicates compiled spells don't have full behavioral parity"
            exit 1
          fi
      
      - name: Verify compiled spell completeness
        run: |
          echo "=== Verifying compiled spell completeness ==="
          echo ""
          
          complete_count=0
          incomplete_count=0
          
          # Verify each compiled spell has inlined functions
          for compiled in /tmp/compiled-spells/*; do
            [ -f "$compiled" ] || continue
            
            spell_name=$(basename "$compiled")
            
            # Check for inlined function definitions (functions starting with _)
            if grep -q "^_.*() {" "$compiled" 2>/dev/null; then
              complete_count=$((complete_count + 1))
            else
              echo "⚠ $spell_name - no inlined functions detected"
              incomplete_count=$((incomplete_count + 1))
            fi
          done
          
          echo ""
          echo "=== Completeness Summary ==="
          echo "Complete with inlined dependencies: $complete_count spells"
          echo "No inlined dependencies: $incomplete_count spells"
          echo ""
          
          # Note: Spells without inlined functions are still valid standalone scripts
          # They just don't have dependencies that needed inlining
          echo "✓ All compiled spells are valid standalone executables"
      
      - name: Upload compiled spells as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compiled-spells
          path: /tmp/compiled-spells/
          retention-days: 90
          compression-level: 9
      
      - name: Generate compilation report
        if: always()
        run: |
          mkdir -p /tmp/reports
          
          echo "# Compiled Spell Report" > /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          
          echo "## Compilation Summary" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          compiled_count=$(find /tmp/compiled-spells/ -maxdepth 1 -type f 2>/dev/null | wc -l)
          echo "- Total spells compiled: $compiled_count" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          
          # Build lists in single pass
          standalone_list=""
          dependency_list=""
          
          for compiled in /tmp/compiled-spells/*; do
            [ -f "$compiled" ] || continue
            spell_name=$(basename "$compiled")
            if env -i PATH="/usr/bin:/bin" "$compiled" --help >/dev/null 2>&1; then
              standalone_list="$standalone_list- \`$spell_name\`"$'\n'
            else
              dependency_list="$dependency_list- \`$spell_name\`"$'\n'
            fi
          done
          
          echo "## Standalone Spells" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          echo "These spells can run without wizardry installed:" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          printf '%s' "$standalone_list" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          
          echo "## Spells Requiring Dependencies" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          echo "These spells require wizardry imps or other dependencies:" >> /tmp/reports/compilation-report.md
          echo "" >> /tmp/reports/compilation-report.md
          printf '%s' "$dependency_list" >> /tmp/reports/compilation-report.md
          
          cat /tmp/reports/compilation-report.md
      
      - name: Upload compilation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compilation-report
          path: /tmp/reports/
          retention-days: 90
