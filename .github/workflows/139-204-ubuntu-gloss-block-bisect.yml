name: 139-204 Ubuntu gloss block bisect

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ubuntu-gloss-blocks-1-34:
    name: 139-204 Ubuntu gloss blocks 1-34
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 1-34 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 1 && idx <= 34)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  ubuntu-gloss-blocks-35-68:
    name: 139-205 Ubuntu gloss blocks 35-68
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 35-68 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 35 && idx <= 68)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  ubuntu-gloss-blocks-1-17:
    name: 139-206 Ubuntu gloss blocks 1-17
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 1-17 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 1 && idx <= 17)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  ubuntu-gloss-blocks-18-34:
    name: 139-207 Ubuntu gloss blocks 18-34
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 18-34 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 18 && idx <= 34)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  ubuntu-gloss-blocks-35-51:
    name: 139-208 Ubuntu gloss blocks 35-51
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 35-51 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 35 && idx <= 51)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  ubuntu-gloss-blocks-52-68:
    name: 139-209 Ubuntu gloss blocks 52-68
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install xattr tooling
        run: sudo apt-get update && sudo apt-get install -y attr
      - name: Load blocks 52-68 and run banish
        run: |
          set +e
          ulimit -c unlimited || true
          (
            set -e
            . spells/.imps/sys/invoke-wizardry
            gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
            gloss_trim=$(mktemp /tmp/wizardry-gloss-trim.XXXXXX)
            generate-glosses --output "$gloss_file"
            awk '
              BEGIN { idx=0; keep=0 }
              /^# First-word gloss/ {
                idx++
                keep = (idx >= 52 && idx <= 68)
              }
              keep { print }
            ' "$gloss_file" > "$gloss_trim"
            . "$gloss_trim"
            set -x
            banish 8 --only --no-tests --no-heal
          )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"
