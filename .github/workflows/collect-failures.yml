name: Collect test failures

# Collects failure outputs and makes them visible to Copilot via:
# 1. PR comments (immediate visibility in conversation)
# 2. Job summaries (visible in workflow run UI)
# 3. Single cumulative artifact (downloadable detailed reports)

on:
  workflow_run:
    workflows:
      - "Unit tests"
      - "POSIX, linting, and style checks"
      - "Test standalone compiled spells"
      - "Test doppelganger compiled wizardry"
      - "Dual-pattern validation"
      - "Demonstrate wizardry"
      - "Compile wizardry"
    types:
      - completed

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  collect-failures:
    name: Collect workflow failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download previous failures
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: workflow-failures-latest
          path: /tmp/workflow-failures/
      
      - name: Collect failure details
        id: collect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p /tmp/workflow-failures
          
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          SAFE_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[^a-zA-Z0-9._-]/_/g')
          REPORT_FILE="/tmp/workflow-failures/${SAFE_NAME}.md"
          
          echo "workflow_name=$WORKFLOW_NAME" >> "$GITHUB_OUTPUT"
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> "$GITHUB_OUTPUT"
          
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            rm -f "$REPORT_FILE"
            echo "has_failure=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "has_failure=true" >> "$GITHUB_OUTPUT"
          
          {
            echo "# ${WORKFLOW_NAME}"
            echo ""
            echo "**Status:** ‚ùå Failed"
            echo "**Run:** [${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})"
            echo "**Commit:** \`${{ github.event.workflow_run.head_sha }}\`"
            echo "**Updated:** $(date -u '+%Y-%m-%d %H:%M')"
            echo ""
          } > "$REPORT_FILE"
          
          gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" > /tmp/jobs.json
          
          failed_jobs=$(jq '[.jobs[] | select(.conclusion == "failure")] | length' /tmp/jobs.json)
          echo "**Failed:** $failed_jobs job(s)" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          jq -r '.jobs[] | select(.conclusion == "failure") | "\(.id)|\(.name)"' /tmp/jobs.json | \
          while IFS='|' read -r job_id job_name; do
            echo "## üí• $job_name" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            if gh api "/repos/${{ github.repository }}/actions/jobs/${job_id}/logs" > /tmp/log.txt 2>&1; then
              if grep -i -E "(FAIL|ERROR|‚úó|‚ùå)" /tmp/log.txt > /tmp/fail.txt 2>/dev/null; then
                echo "<details><summary>Failures</summary>" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
                echo '```' >> "$REPORT_FILE"
                head -150 /tmp/fail.txt >> "$REPORT_FILE"
                echo '```' >> "$REPORT_FILE"
                echo "</details>" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
              fi
            fi
          done
      
      - name: Create index and summary
        id: summary
        run: |
          failure_count=$(ls -1 /tmp/workflow-failures/*.md 2>/dev/null | wc -l)
          echo "failure_count=$failure_count" >> "$GITHUB_OUTPUT"
          
          {
            echo "# üîç Test Failure Collection"
            echo ""
            echo "**Workflow:** ${{ steps.collect.outputs.workflow_name }}"
            echo "**Status:** ${{ steps.collect.outputs.conclusion }}"
            echo ""
            if [ "$failure_count" -gt 0 ]; then
              echo "## ‚ùå Active Failures: $failure_count"
              echo ""
              for f in /tmp/workflow-failures/*.md; do
                [ -f "$f" ] || continue
                name=$(basename "$f" .md | sed 's/_/ /g')
                echo "- **$name**"
              done
            else
              echo "## ‚úÖ All Tests Passing"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          
          {
            echo "# Workflow Failure Reports"
            echo ""
            echo "**Updated:** $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo ""
            if [ "$failure_count" -gt 0 ]; then
              echo "## Current Failures"
              echo ""
              for f in /tmp/workflow-failures/*.md; do
                [ -f "$f" ] || continue
                name=$(basename "$f" .md | sed 's/_/ /g')
                echo "- [$name](./${f##*/})"
              done
            else
              echo "‚úÖ All workflows passing"
            fi
            echo ""
            echo "---"
            echo ""
            echo "Download this artifact to see detailed failure reports."
            echo "Copilot can read PR comments with failure summaries."
          } > /tmp/workflow-failures/README.md
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-failures-latest
          path: /tmp/workflow-failures/
          retention-days: 30
          overwrite: true
      
      - name: Find PR
        id: find-pr
        if: github.event.workflow_run.event == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --jq '.pull_requests[0].number // empty')
          if [ -n "$PR" ]; then
            echo "pr=$PR" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Post PR comment
        if: steps.find-pr.outputs.pr != ''
        uses: actions/github-script@v7
        env:
          WORKFLOW_NAME: ${{ steps.collect.outputs.workflow_name }}
          CONCLUSION: ${{ steps.collect.outputs.conclusion }}
          FAIL_COUNT: ${{ steps.summary.outputs.failure_count }}
        with:
          script: |
            const fs = require('fs');
            const pr = '${{ steps.find-pr.outputs.pr }}';
            const failCount = parseInt(process.env.FAIL_COUNT || '0');
            const workflowName = process.env.WORKFLOW_NAME;
            const conclusion = process.env.CONCLUSION;
            
            const status = conclusion === 'success' ? '‚úÖ Passed' : '‚ùå Failed';
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].slice(0,8);
            
            const header = [
              '<!-- workflow-failures-bot -->',
              '## üîç Workflow Status',
              '',
              '**Latest:** ' + workflowName,
              '**Result:** ' + status,
              '**Updated:** ' + date + ' ' + time + ' UTC',
              ''
            ].join('\n');
            
            let body = header + '\n';
            
            if (failCount > 0) {
              body += '### ‚ùå Active Failures: ' + failCount + '\n\n';
              const files = fs.readdirSync('/tmp/workflow-failures').filter(f => f.endsWith('.md') && f !== 'README.md');
              for (const file of files) {
                const content = fs.readFileSync('/tmp/workflow-failures/' + file, 'utf8');
                const lines = content.split('\n').slice(0, 15).join('\n');
                const name = file.replace('.md', '').replace(/_/g, ' ');
                body += '<details><summary>' + name + '</summary>\n\n' + lines + '\n\n</details>\n\n';
              }
            } else {
              body += '### ‚úÖ All Tests Passing\n\n';
            }
            
            body += 'üí° Download `workflow-failures-latest` artifact for full logs\n';
            body += 'ü§ñ Ask Copilot: "What test failures do I need to fix?"\n';
            
            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr
            });
            
            const existing = comments.find(c => c.body && c.body.includes('<!-- workflow-failures-bot -->'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr,
                body
              });
            }
