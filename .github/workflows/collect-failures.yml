name: Collect test failures

# This workflow collects failure outputs from all test workflows and creates
# a centralized failure report that Copilot can read.
# It updates a single file in the repository with all current failures.

on:
  workflow_run:
    workflows:
      - "Unit tests"
      - "POSIX, linting, and style checks"
      - "Test standalone compiled spells"
      - "Test doppelganger compiled wizardry"
      - "Dual-pattern validation"
      - "Demonstrate wizardry"
      - "Compile wizardry"
    types:
      - completed

permissions:
  contents: write  # Required to commit failure report
  actions: read    # Required to read workflow information

jobs:
  collect-failures:
    name: Collect workflow failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update failure report directory
        run: |
          mkdir -p .github/workflow-failures
      - name: Download previous failure reports
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: workflow-failures-combined
          path: .github/workflow-failures/
      
      - name: Collect failure information
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_ID="${{ github.event.workflow_run.id }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          COMMIT="${{ github.event.workflow_run.head_sha }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          
          # Create safe filename from workflow name
          SAFE_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[^a-zA-Z0-9._-]/_/g')
          REPORT_FILE=".github/workflow-failures/${SAFE_NAME}.md"
          
          echo "Collecting failures for: $WORKFLOW_NAME"
          echo "Report file: $REPORT_FILE"
          
          # Start the report
          {
            echo "# ${WORKFLOW_NAME} - Failure Report"
            echo ""
            echo "**Status:** ${CONCLUSION}"
            echo "**Run ID:** ${WORKFLOW_ID}"
            echo "**Commit:** \`${COMMIT}\`"
            echo "**Branch:** \`${BRANCH}\`"
            echo "**Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
          } > "$REPORT_FILE"
          
          # If workflow succeeded, mark as such and exit
          if [ "$CONCLUSION" = "success" ]; then
            {
              echo "## Status: ✅ All Jobs Passed"
              echo ""
              echo "No failures to report."
            } >> "$REPORT_FILE"
            echo "Workflow succeeded - clearing any previous failures"
            exit 0
          fi
          
          # Workflow failed - collect details
          echo "Workflow FAILED - collecting job logs..."
          echo "## Status: ❌ Workflow Failed" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          # Get jobs for this workflow run
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${WORKFLOW_ID}/jobs" \
            > /tmp/jobs.json
          
          # Count jobs
          total_jobs=$(jq '.jobs | length' /tmp/jobs.json)
          failed_jobs=$(jq '[.jobs[] | select(.conclusion == "failure")] | length' /tmp/jobs.json)
          
          {
            echo "**Total Jobs:** $total_jobs"
            echo "**Failed Jobs:** $failed_jobs"
            echo ""
            echo "---"
            echo ""
          } >> "$REPORT_FILE"
          
          # Process each failed job
          jq -r '.jobs[] | select(.conclusion == "failure") | "\(.id)|\(.name)"' /tmp/jobs.json | while IFS='|' read -r job_id job_name; do
            echo "Processing failed job: $job_name"
            
            {
              echo "## Failed Job: $job_name"
              echo ""
              echo "**Job ID:** $job_id"
              echo ""
            } >> "$REPORT_FILE"
            
            # Get job logs and extract failures
            if gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/actions/jobs/${job_id}/logs" \
              > /tmp/raw_log.txt 2>&1; then
              
              # Extract failure lines (case-insensitive)
              if grep -i -E "(FAIL|ERROR|✗|❌)" /tmp/raw_log.txt > /tmp/failures.txt 2>/dev/null; then
                {
                  echo "<details>"
                  echo "<summary>Failure Output (click to expand)</summary>"
                  echo ""
                  echo '```'
                  head -500 /tmp/failures.txt
                  echo '```'
                  echo ""
                  echo "</details>"
                  echo ""
                } >> "$REPORT_FILE"
              else
                echo "No specific failure patterns found in logs." >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
              fi
              
              # Add last 100 lines of full log
              {
                echo "<details>"
                echo "<summary>Full Log (last 100 lines)</summary>"
                echo ""
                echo '```'
                tail -100 /tmp/raw_log.txt
                echo '```'
                echo ""
                echo "</details>"
                echo ""
                echo "---"
                echo ""
              } >> "$REPORT_FILE"
            else
              echo "⚠️ Failed to download logs for this job." >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
            fi
            
            rm -f /tmp/raw_log.txt /tmp/failures.txt
          done
          
          echo "Failure report created: $REPORT_FILE"
      
      - name: Create combined failure index
        run: |
          INDEX_FILE=".github/workflow-failures/README.md"
          
          {
            echo "# Workflow Failure Reports"
            echo ""
            echo "This directory contains failure reports from GitHub Actions workflows."
            echo "Each workflow has its own markdown file that is updated when the workflow completes."
            echo ""
            echo "**Last Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "---"
            echo ""
            echo "## Current Status"
            echo ""
          } > "$INDEX_FILE"
          
          # List all workflow reports
          for report in .github/workflow-failures/*.md; do
            [ "$report" = ".github/workflow-failures/README.md" ] && continue
            [ -f "$report" ] || continue
            
            workflow_name=$(basename "$report" .md | sed 's/_/ /g')
            
            # Check if workflow failed or passed
            if grep -q "✅ All Jobs Passed" "$report"; then
              echo "- ✅ **$workflow_name** - All tests passing" >> "$INDEX_FILE"
            elif grep -q "❌ Workflow Failed" "$report"; then
              failed_count=$(grep "^\*\*Failed Jobs:\*\*" "$report" | sed 's/.*: //')
              echo "- ❌ **$workflow_name** - $failed_count job(s) failing ([view report]($report))" >> "$INDEX_FILE"
            else
              echo "- ⚠️ **$workflow_name** - Status unknown" >> "$INDEX_FILE"
            fi
          done
          
          {
            echo ""
            echo "---"
            echo ""
            echo "## How to Use"
            echo ""
            echo "1. Check this README for current failure status"
            echo "2. Click on failing workflow links to see detailed failure reports"
            echo "3. Each report includes:"
            echo "   - Failure output filtered for errors"
            echo "   - Full log context (last 100 lines)"
            echo "   - Timestamp and commit information"
            echo ""
            echo "## For Copilot"
            echo ""
            echo "When debugging workflow failures, check the individual workflow markdown files"
            echo "in this directory. Each file contains the most recent failure information for"
            echo "that specific workflow, making it easy to identify and fix issues."
          } >> "$INDEX_FILE"
      
      - name: Upload combined failure artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-failures-combined
          path: .github/workflow-failures/
          retention-days: 30
          if-no-files-found: warn
          overwrite: true
      
      - name: Commit failure reports
        if: github.event.workflow_run.head_branch == github.event.repository.default_branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/workflow-failures/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update workflow failure reports" \
            -m "Workflow: ${{ github.event.workflow_run.name }}" \
            -m "Status: ${{ github.event.workflow_run.conclusion }}" \
            -m "Run ID: ${{ github.event.workflow_run.id }}" \
            -m "[skip ci]"
          
          git push
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "======================================================================"
          echo " FAILURE COLLECTION SUMMARY"
          echo "======================================================================"
          echo ""
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Status: ${{ github.event.workflow_run.conclusion }}"
          echo ""
          echo "Failure reports available in: .github/workflow-failures/"
          echo "View combined status: .github/workflow-failures/README.md"
          echo ""
          echo "======================================================================"
