name: Collect test failures

# Collects failure outputs and makes them visible to Copilot via:
# 1. Job summaries (visible in workflow run UI - Copilot can read)
# 2. Workflow logs (sequential output for easy review)

on:
  workflow_run:
    workflows:
      - "Unit tests"
      - "POSIX, linting, and style checks"
      - "Test standalone compiled spells"
      - "Test doppelganger compiled wizardry"
      - "Dual-pattern validation"
      - "Demonstrate wizardry"
      - "Compile wizardry"
    types:
      - completed

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  collect-failures:
    name: Collect workflow failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Collect and display failure details
        id: collect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          COMMIT="${{ github.event.workflow_run.head_sha }}"
          
          echo "workflow_name=$WORKFLOW_NAME" >> "$GITHUB_OUTPUT"
          echo "conclusion=$CONCLUSION" >> "$GITHUB_OUTPUT"
          
          echo ""
          echo "========================================================================"
          echo " WORKFLOW FAILURE COLLECTION"
          echo "========================================================================"
          echo ""
          echo "Workflow: $WORKFLOW_NAME"
          echo "Status: $CONCLUSION"
          echo "Run ID: $RUN_ID"
          echo "Run URL: $RUN_URL"
          echo "Commit: $COMMIT"
          echo ""
          
          if [ "$CONCLUSION" = "success" ]; then
            echo "âœ… Workflow succeeded - no failures to collect"
            echo "has_failure=false" >> "$GITHUB_OUTPUT"
            echo "failure_summary=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "âŒ Workflow FAILED - collecting failure details..."
          echo "has_failure=true" >> "$GITHUB_OUTPUT"
          echo ""
          
          # Get jobs
          gh api "/repos/${{ github.repository }}/actions/runs/${RUN_ID}/jobs" > /tmp/jobs.json
          
          total_jobs=$(jq '.jobs | length' /tmp/jobs.json)
          failed_jobs=$(jq '[.jobs[] | select(.conclusion == "failure")] | length' /tmp/jobs.json)
          
          echo "Total jobs: $total_jobs"
          echo "Failed jobs: $failed_jobs"
          echo ""
          echo "------------------------------------------------------------------------"
          echo ""
          
          # Create summary for output variable
          SUMMARY="**$WORKFLOW_NAME** failed: $failed_jobs of $total_jobs jobs"
          echo "failure_summary=$SUMMARY" >> "$GITHUB_OUTPUT"
          
          # Process each failed job
          jq -r '.jobs[] | select(.conclusion == "failure") | "\(.id)|\(.name)"' /tmp/jobs.json | \
          while IFS='|' read -r job_id job_name; do
            echo "=== FAILED JOB: $job_name ==="
            echo ""
            
            # Get job logs
            if gh api "/repos/${{ github.repository }}/actions/jobs/${job_id}/logs" > /tmp/log.txt 2>&1; then
              
              # Extract relevant failure text based on job type
              if echo "$job_name" | grep -qi "unit test"; then
                # For unit tests, extract the test summary
                echo "--- Test Summary ---"
                if grep -q "=== Test Summary ===" /tmp/log.txt; then
                  sed -n '/=== Test Summary ===/,/^===/p' /tmp/log.txt | head -n -1
                else
                  # Fallback: show lines with test results
                  grep -E "tests? passed|FAIL|Failed" /tmp/log.txt | tail -20
                fi
                echo ""
              else
                # For other workflows, extract error lines and context
                if grep -q "##\[error\]" /tmp/log.txt; then
                  echo "--- Errors ---"
                  grep -B 3 -A 5 "##\[error\]" /tmp/log.txt | head -50
                  echo ""
                elif grep -qi "FAIL\|ERROR" /tmp/log.txt; then
                  echo "--- Failure Details ---"
                  grep -i -B 2 -A 3 "FAIL\|ERROR" /tmp/log.txt | head -50
                  echo ""
                else
                  echo "--- Log Context (last 30 lines) ---"
                  tail -30 /tmp/log.txt
                  echo ""
                fi
              fi
              
            else
              echo "âš ï¸ Failed to download logs for job: $job_name"
              echo ""
            fi
            
            echo "------------------------------------------------------------------------"
            echo ""
          done
          
          echo "========================================================================"
          echo " END FAILURE COLLECTION"
          echo "========================================================================"
      
      - name: Create job summary
        if: always()
        run: |
          {
            echo "# ðŸ” Test Failure Collection"
            echo ""
            echo "**Workflow:** ${{ steps.collect.outputs.workflow_name }}"
            echo "**Status:** ${{ steps.collect.outputs.conclusion }}"
            echo ""
            
            if [ "${{ steps.collect.outputs.has_failure }}" = "true" ]; then
              echo "## âŒ Workflow Failed"
              echo ""
              echo "${{ steps.collect.outputs.failure_summary }}"
              echo ""
              echo "See workflow logs above for detailed failure output."
            else
              echo "## âœ… Workflow Passed"
              echo ""
              echo "No failures to report."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
      
      - name: Find PR
        id: find-pr
        if: github.event.workflow_run.event == 'pull_request' && steps.collect.outputs.has_failure == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --jq '.pull_requests[0].number // empty')
          if [ -n "$PR" ]; then
            echo "pr=$PR" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Post PR comment
        if: steps.find-pr.outputs.pr != ''
        uses: actions/github-script@v7
        env:
          WORKFLOW_NAME: ${{ steps.collect.outputs.workflow_name }}
          CONCLUSION: ${{ steps.collect.outputs.conclusion }}
          FAILURE_SUMMARY: ${{ steps.collect.outputs.failure_summary }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const pr = '${{ steps.find-pr.outputs.pr }}';
            const workflowName = process.env.WORKFLOW_NAME;
            const failureSummary = process.env.FAILURE_SUMMARY;
            const runId = process.env.RUN_ID;
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].slice(0,8);
            
            const body = [
              '<!-- workflow-failures-bot -->',
              '## ðŸ” Workflow Failure',
              '',
              '**Workflow:** ' + workflowName,
              '**Status:** âŒ Failed',
              '**Updated:** ' + date + ' ' + time + ' UTC',
              '',
              failureSummary,
              '',
              '---',
              '',
              'ðŸ’¡ **View detailed logs:** Check the [workflow run logs](../../actions/runs/' + runId + ')',
              'ðŸ¤– **Ask Copilot:** "What test failures do I need to fix?"'
            ].join('\n');
            
            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr
            });
            
            const existing = comments.find(c => c.body && c.body.includes('<!-- workflow-failures-bot -->'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr,
                body
              });
            }
