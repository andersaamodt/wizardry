name: Consolidate workflow errors

on:
  workflow_run:
    workflows:
      - "Unit tests"
      - "POSIX, linting, and style checks"
      - "Compile wizardry"
      - "Test standalone compiled spells"
      - "Test doppelganger compiled wizardry"
      - "Demonstrate wizardry"
    types:
      - completed

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  consolidate-errors:
    name: Consolidate all workflow errors
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Find all workflow runs for this commit
        uses: actions/github-script@v7
        id: find-runs
        with:
          script: |
            // Get all workflow runs for the same commit SHA
            const sha = '${{ github.event.workflow_run.head_sha }}';
            console.log(`Finding all workflow runs for commit: ${sha}`);
            
            const response = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: sha,
              per_page: 100
            });
            
            const runs = response.data.workflow_runs;
            console.log(`Found ${runs.length} workflow runs for this commit`);
            
            // Filter to only completed runs with failures
            const failedRuns = runs.filter(run => 
              run.conclusion === 'failure' && run.status === 'completed'
            );
            
            console.log(`Found ${failedRuns.length} failed workflow runs`);
            failedRuns.forEach(run => {
              console.log(`  - ${run.name} (ID: ${run.id})`);
            });
            
            // Return run IDs as comma-separated string
            const runIds = failedRuns.map(r => r.id).join(',');
            return { runIds, count: failedRuns.length };
      
      - name: Download error artifacts from all failed workflows
        if: steps.find-runs.outputs.result != ''
        continue-on-error: true
        run: |
          mkdir -p /tmp/error-reports
          
          # Parse run IDs from previous step
          run_ids="${{ fromJSON(steps.find-runs.outputs.result).runIds }}"
          
          if [ -z "$run_ids" ]; then
            echo "No failed workflow runs found"
            exit 0
          fi
          
          echo "Downloading error artifacts from workflow runs: $run_ids"
          
          # Download artifacts from each workflow run
          IFS=',' read -ra RUN_ARRAY <<< "$run_ids"
          for run_id in "${RUN_ARRAY[@]}"; do
            echo "Downloading artifacts from run $run_id..."
            
            # Use GitHub CLI to download artifacts
            gh run download "$run_id" \
              --pattern '*-errors' \
              --dir "/tmp/error-reports/run-$run_id" \
              2>/dev/null || echo "No error artifacts found for run $run_id"
          done
          
          echo "Download complete. Artifacts saved to /tmp/error-reports/"
          find /tmp/error-reports -type f | head -20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
      
      - name: Consolidate error reports
        run: |
          echo "======================================================================"
          echo " CONSOLIDATED WORKFLOW ERROR REPORT (ALL WORKFLOWS)"
          echo "======================================================================"
          echo ""
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Triggered by workflow: ${{ github.event.workflow_run.name }}"
          echo "Total failed workflows: ${{ fromJSON(steps.find-runs.outputs.result).count }}"
          echo ""
          echo "======================================================================"
          echo " ERROR DETAILS FROM ALL FAILED WORKFLOWS"
          echo "======================================================================"
          echo ""
          
          # Create consolidated report file
          report_file="/tmp/consolidated-errors.txt"
          {
            echo "===================================================================="
            echo " CONSOLIDATED ERROR REPORT - ALL WORKFLOWS"
            echo "===================================================================="
            echo ""
            echo "Branch: ${{ github.event.workflow_run.head_branch }}"
            echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
            echo "Report generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Triggered by: ${{ github.event.workflow_run.name }} workflow failure"
            echo "Total failed workflows: ${{ fromJSON(steps.find-runs.outputs.result).count }}"
            echo ""
            echo "This report consolidates errors from ALL failed workflows for this commit."
            echo "The artifact is updated each time a workflow fails, providing incremental updates."
            echo ""
            echo "===================================================================="
            echo " ERROR DETAILS"
            echo "===================================================================="
            echo ""
          } > "$report_file"
          
          # Check if any error artifacts were downloaded
          if [ -d "/tmp/error-reports" ] && [ "$(find /tmp/error-reports -type f | wc -l)" -gt 0 ]; then
            echo "Processing error reports from all failed workflows..."
            echo ""
            
            # Group by workflow run
            for run_dir in /tmp/error-reports/run-*; do
              [ -d "$run_dir" ] || continue
              
              run_id=$(basename "$run_dir" | sed 's/run-//')
              
              {
                echo ""
                echo "======================================================================"
                echo " WORKFLOW RUN: $run_id"
                echo "======================================================================"
                echo ""
              } >> "$report_file"
              
              # Process each error artifact from this run
              if [ -d "$run_dir" ] && [ "$(find "$run_dir" -type f -name "*.txt" | wc -l)" -gt 0 ]; then
                for error_file in $(find "$run_dir" -type f -name "*.txt" | sort); do
                  artifact_name=$(basename $(dirname "$error_file"))
                  
                  echo "----------------------------------------------------------------------"
                  echo "ERROR: $artifact_name (Run: $run_id)"
                  echo "----------------------------------------------------------------------"
                  cat "$error_file"
                  echo ""
                  echo ""
                  
                  # Add to consolidated report
                  {
                    echo "----------------------------------------------------------------------"
                    echo "ERROR ARTIFACT: $artifact_name"
                    echo "----------------------------------------------------------------------"
                  } >> "$report_file"
                  cat "$error_file" >> "$report_file"
                  echo "" >> "$report_file"
                  echo "" >> "$report_file"
                done
              else
                echo "No error artifacts found in run $run_id"
                echo "No error artifacts found in this run." >> "$report_file"
                echo "" >> "$report_file"
              fi
            done
          else
            echo "No error artifacts found for any workflow run."
            echo "The workflows may have failed without generating error artifacts."
            echo ""
            echo "No error artifacts found for any workflow run." >> "$report_file"
            echo "The workflows may have failed without generating error artifacts." >> "$report_file"
          fi
          
          echo "======================================================================"
          echo " SUMMARY"
          echo "======================================================================"
          echo ""
          echo "Complete error report saved to artifact: consolidated-errors-${{ github.event.workflow_run.head_branch }}-latest"
          echo "This artifact contains errors from ALL failed workflows for this commit."
          echo "Download the artifact from the Actions tab to view full details."
          echo ""
          
          # Add summary
          {
            echo ""
            echo "===================================================================="
            echo " SUMMARY"
            echo "===================================================================="
            echo ""
            echo "This consolidated report includes errors from all failed workflows for:"
            echo "  Branch: ${{ github.event.workflow_run.head_branch }}"
            echo "  Commit: ${{ github.event.workflow_run.head_sha }}"
            echo ""
            echo "The artifact is updated incrementally as each workflow fails."
            echo "Always download the latest version for the most complete error report."
          } >> "$report_file"
      
      - name: Upload consolidated error report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-errors-${{ github.event.workflow_run.head_branch }}-latest
          path: /tmp/consolidated-errors.txt
          retention-days: 30
          overwrite: true
          if-no-files-found: warn
      
      - name: Display error summary in job summary
        run: |
          {
            echo "# Consolidated Workflow Error Report"
            echo ""
            echo "**Branch:** ${{ github.event.workflow_run.head_branch }}"
            echo "**Commit SHA:** \`${{ github.event.workflow_run.head_sha }}\`"
            echo "**Triggered by:** ${{ github.event.workflow_run.name }} workflow failure"
            echo "**Failed workflows:** ${{ fromJSON(steps.find-runs.outputs.result).count }}"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“Š How This Works"
            echo ""
            echo "This report consolidates errors from **ALL failed workflows** for this commit."
            echo "Each time a workflow fails, this consolidation runs and updates the artifact."
            echo ""
            echo "âœ“ **Single artifact location:** \`consolidated-errors-${{ github.event.workflow_run.head_branch }}-latest\`"
            echo "âœ“ **Incremental updates:** Report grows as more workflows fail"
            echo "âœ“ **One place to check:** Always download the same artifact name for latest errors"
            echo ""
            echo "---"
            echo ""
            echo "## Error Details"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f /tmp/consolidated-errors.txt ]; then
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/consolidated-errors.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No consolidated error report generated." >> "$GITHUB_STEP_SUMMARY"
          fi
          
          {
            echo ""
            echo "---"
            echo ""
            echo "ðŸ“¥ **Download:** Look for the \`consolidated-errors-${{ github.event.workflow_run.head_branch }}-latest\` artifact"
            echo ""
            echo "ðŸ’¡ **Tip:** This artifact is updated each time a workflow fails. Download it at any time to see all errors so far, or wait for all workflows to complete for the full report."
          } >> "$GITHUB_STEP_SUMMARY"
