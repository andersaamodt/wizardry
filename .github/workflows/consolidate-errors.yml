name: Consolidate workflow errors

on:
  workflow_run:
    workflows:
      - "Unit tests"
      - "POSIX, linting, and style checks"
      - "Compile wizardry"
      - "Test standalone compiled spells"
      - "Test doppelganger compiled wizardry"
      - "Demonstrate wizardry"
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  consolidate-errors:
    name: Consolidate all workflow errors
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Download error artifacts from triggering workflow
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: '*-errors'
          path: /tmp/error-reports
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Consolidate error reports
        run: |
          echo "======================================================================"
          echo " CONSOLIDATED WORKFLOW ERROR REPORT"
          echo "======================================================================"
          echo ""
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Run URL: ${{ github.event.workflow_run.html_url }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Triggered by: ${{ github.event.workflow_run.event }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "======================================================================"
          echo " ERROR DETAILS"
          echo "======================================================================"
          echo ""
          
          # Create consolidated report file
          report_file="/tmp/consolidated-errors.txt"
          cat > "$report_file" <<EOF
====================================================================
 CONSOLIDATED WORKFLOW ERROR REPORT
====================================================================

Workflow: ${{ github.event.workflow_run.name }}
Conclusion: ${{ github.event.workflow_run.conclusion }}
Run URL: ${{ github.event.workflow_run.html_url }}
Run ID: ${{ github.event.workflow_run.id }}
Triggered by: ${{ github.event.workflow_run.event }}
Head branch: ${{ github.event.workflow_run.head_branch }}
Head SHA: ${{ github.event.workflow_run.head_sha }}
Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

====================================================================
 ERROR DETAILS
====================================================================

EOF
          
          # Check if any error artifacts were downloaded
          if [ -d "/tmp/error-reports" ] && [ "$(find /tmp/error-reports -type f | wc -l)" -gt 0 ]; then
            echo "Found error reports:"
            find /tmp/error-reports -type f
            echo ""
            
            # Process each error report
            for error_file in $(find /tmp/error-reports -type f -name "*.txt" | sort); do
              echo "----------------------------------------------------------------------"
              echo "ERROR REPORT: $(basename $(dirname "$error_file"))"
              echo "----------------------------------------------------------------------"
              cat "$error_file"
              echo ""
              echo ""
              
              # Add to consolidated report
              cat >> "$report_file" <<EOF
----------------------------------------------------------------------
ERROR REPORT: $(basename $(dirname "$error_file"))
----------------------------------------------------------------------
EOF
              cat "$error_file" >> "$report_file"
              echo "" >> "$report_file"
              echo "" >> "$report_file"
            done
          else
            echo "No error artifacts found for this workflow run."
            echo "The workflow may have failed without generating error artifacts."
            echo ""
            echo "No error artifacts found for this workflow run." >> "$report_file"
            echo "The workflow may have failed without generating error artifacts." >> "$report_file"
          fi
          
          echo "======================================================================"
          echo " SUMMARY"
          echo "======================================================================"
          echo ""
          echo "Complete error report saved to artifact: consolidated-workflow-errors"
          echo "Download the artifact from the Actions tab to view full details."
          echo ""
          
          # Add summary
          cat >> "$report_file" <<EOF

====================================================================
 SUMMARY
====================================================================

Complete error report for workflow: ${{ github.event.workflow_run.name }}
Run URL: ${{ github.event.workflow_run.html_url }}

This report consolidates all errors from the failed workflow run.
EOF
      
      - name: Upload consolidated error report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-workflow-errors-${{ github.event.workflow_run.id }}
          path: /tmp/consolidated-errors.txt
          retention-days: 30
          if-no-files-found: warn
      
      - name: Display error summary in job summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # Workflow Error Report

          **Workflow:** ${{ github.event.workflow_run.name }}  
          **Conclusion:** ${{ github.event.workflow_run.conclusion }}  
          **Run URL:** ${{ github.event.workflow_run.html_url }}  
          **Triggered by:** ${{ github.event.workflow_run.event }}  
          **Branch:** ${{ github.event.workflow_run.head_branch }}  
          **SHA:** \`${{ github.event.workflow_run.head_sha }}\`

          ---

          ## Error Details

          EOF
          
          if [ -f /tmp/consolidated-errors.txt ]; then
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/consolidated-errors.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No consolidated error report generated." >> "$GITHUB_STEP_SUMMARY"
          fi
          
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF

          ---

          ðŸ“¥ Download the **consolidated-workflow-errors** artifact for the complete error report.
          EOF
