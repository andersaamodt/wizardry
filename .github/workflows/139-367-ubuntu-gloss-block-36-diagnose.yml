name: 139-367 Ubuntu gloss block 36 diagnose

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: 139-367-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  job-139-367-no-gloss:
    name: "139-367 no gloss"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install attr
        run: |
          sudo apt-get update
          sudo apt-get install -y attr

      - name: Run banish with glosses disabled
        shell: bash
        run: |
          set -euo pipefail
          echo "[gloss-36] banish with WIZARDRY_GLOSSES=0"
          export WIZARDRY_DIR="$GITHUB_WORKSPACE"
          export WIZARDRY_GLOSSES=0
          . "$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry"
          set +e
          ( banish 8 --only --no-tests --no-heal )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  job-139-367-block-36-only:
    name: "139-367 block 36 only"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install attr
        run: |
          sudo apt-get update
          sudo apt-get install -y attr

      - name: Run block 36 only
        shell: bash
        run: |
          set -euo pipefail
          echo "[gloss-36] block 36 only"
          export WIZARDRY_DIR="$GITHUB_WORKSPACE"
          . "$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry"
          gloss_dir=$(mktemp -d /tmp/wizardry-gloss-blocks.XXXXXX)
          gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
          "$WIZARDRY_DIR/spells/.wizardry/generate-glosses" --output "$gloss_file"
          awk_program=$(printf '%s\n' \
            'BEGIN { idx=0; out="" }' \
            '/^# First-word gloss/ {' \
            '  idx++' \
            '  out=sprintf("%s/block-%03d.sh", outdir, idx)' \
            '  print "# block " idx > out' \
            '}' \
            '{ if (out != "") print >> out }' \
            'END { printf "%d\n", idx > outdir "/count" }')
          awk -v outdir="$gloss_dir" "$awk_program" "$gloss_file"
          block="$gloss_dir/block-036.sh"
          if [ ! -s "$block" ]; then
            printf '%s\n' "missing block 36" >&2
            exit 1
          fi
          printf '%s\n' "[gloss-36] block 36 header:"
          sed -n '1,6p' "$block"
          . "$block"
          set +e
          ( banish 8 --only --no-tests --no-heal )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  job-139-367-block-36-unset:
    name: "139-367 block 36 unset"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install attr
        run: |
          sudo apt-get update
          sudo apt-get install -y attr

      - name: Run block 36 then unset its function
        shell: bash
        run: |
          set -euo pipefail
          echo "[gloss-36] block 36 then unset"
          export WIZARDRY_DIR="$GITHUB_WORKSPACE"
          . "$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry"
          gloss_dir=$(mktemp -d /tmp/wizardry-gloss-blocks.XXXXXX)
          gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
          "$WIZARDRY_DIR/spells/.wizardry/generate-glosses" --output "$gloss_file"
          awk_program=$(printf '%s\n' \
            'BEGIN { idx=0; out="" }' \
            '/^# First-word gloss/ {' \
            '  idx++' \
            '  out=sprintf("%s/block-%03d.sh", outdir, idx)' \
            '  print "# block " idx > out' \
            '}' \
            '{ if (out != "") print >> out }' \
            'END { printf "%d\n", idx > outdir "/count" }')
          awk -v outdir="$gloss_dir" "$awk_program" "$gloss_file"
          block="$gloss_dir/block-036.sh"
          if [ ! -s "$block" ]; then
            printf '%s\n' "missing block 36" >&2
            exit 1
          fi
          gloss_name=$(awk '/^[a-zA-Z0-9_-]+\(\)/ { sub(/\(\).*/, "", $1); print $1; exit }' "$block")
          printf '%s\n' "[gloss-36] block 36 function: $gloss_name"
          . "$block"
          if [ -n "$gloss_name" ]; then
            unset -f "$gloss_name"
          fi
          set +e
          ( banish 8 --only --no-tests --no-heal )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"

  job-139-367-block-36-noop:
    name: "139-367 block 36 noop"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install attr
        run: |
          sudo apt-get update
          sudo apt-get install -y attr

      - name: Run block 36 then noop its function
        shell: bash
        run: |
          set -euo pipefail
          echo "[gloss-36] block 36 noop"
          export WIZARDRY_DIR="$GITHUB_WORKSPACE"
          . "$WIZARDRY_DIR/spells/.imps/sys/invoke-wizardry"
          gloss_dir=$(mktemp -d /tmp/wizardry-gloss-blocks.XXXXXX)
          gloss_file=$(mktemp /tmp/wizardry-gloss.XXXXXX)
          "$WIZARDRY_DIR/spells/.wizardry/generate-glosses" --output "$gloss_file"
          awk_program=$(printf '%s\n' \
            'BEGIN { idx=0; out="" }' \
            '/^# First-word gloss/ {' \
            '  idx++' \
            '  out=sprintf("%s/block-%03d.sh", outdir, idx)' \
            '  print "# block " idx > out' \
            '}' \
            '{ if (out != "") print >> out }' \
            'END { printf "%d\n", idx > outdir "/count" }')
          awk -v outdir="$gloss_dir" "$awk_program" "$gloss_file"
          block="$gloss_dir/block-036.sh"
          if [ ! -s "$block" ]; then
            printf '%s\n' "missing block 36" >&2
            exit 1
          fi
          gloss_name=$(awk '/^[a-zA-Z0-9_-]+\(\)/ { sub(/\(\).*/, "", $1); print $1; exit }' "$block")
          printf '%s\n' "[gloss-36] block 36 function: $gloss_name"
          . "$block"
          if [ -n "$gloss_name" ]; then
            eval "${gloss_name}() { return 0; }"
          fi
          set +e
          ( banish 8 --only --no-tests --no-heal )
          status=$?
          if [ "$status" -eq 139 ]; then
            printf '%s\n' "subshell banish exited with code 139 (SIGSEGV)"
            printf '%s\n' "Last 50 dmesg lines (if available):"
            dmesg | tail -n 50 || true
          fi
          exit "$status"
