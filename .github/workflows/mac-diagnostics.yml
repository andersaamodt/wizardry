name: macOS Diagnostics

on:
  workflow_dispatch:
  pull_request:

jobs:
  mac-diagnostics:
    name: macOS environment probing
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Summarize system context
        run: |
          set -euo pipefail
          echo "sw_vers: $(sw_vers -productVersion)"
          echo "uname: $(uname -a)"
          echo "shell: ${SHELL:-unknown}"
          echo "PATH: $PATH"

      - name: Locate helper commands
        run: |
          set -euo pipefail
          for cmd in attr xattr getfattr stat gstat readlink greadlink pbcopy pbpaste kill pkill ps; do
            printf '%-10s' "$cmd:"
            if command -v "$cmd" >/dev/null 2>&1; then
              path=$(command -v "$cmd")
              printf ' %s' "$path"
              version=$($cmd --version 2>/dev/null | head -n 1 || true)
              [ -n "$version" ] && printf ' | %s' "$version"
              printf '\n'
            else
              echo " missing"
            fi
          done

      - name: Capture attr/xattr behavior
        run: |
          set -euo pipefail
          tmp=$(mktemp)
          echo "sample" > "$tmp"
          xattr -w user.alpha alpha-value "$tmp" 2>/dev/null || true
          xattr -w user.beta beta-value "$tmp" 2>/dev/null || true

          if command -v attr >/dev/null 2>&1; then
            echo "# attr -l"
            attr -l "$tmp" || true
            echo "# attr -g user.beta"
            attr -g user.beta "$tmp" || true
            echo "# attr -q -g user.beta"
            attr -q -g user.beta "$tmp" || true
          else
            echo "# attr missing"
          fi

          echo "# xattr list"
          xattr "$tmp" 2>/dev/null || true
          echo "# xattr -p user.beta"
          xattr -p user.beta "$tmp" 2>/dev/null || true

          echo "# read-magic (all)"
          ./spells/divination/read-magic "$tmp" || true
          echo "# read-magic (user.beta)"
          ./spells/divination/read-magic "$tmp" user.beta || true

      - name: Run focused failing tests
        run: |
          set +e
          failures="
          cantrips/test_menu.sh
          divination/test_detect-magic.sh
          divination/test_read-magic.sh
          kryptos/test_hash.sh
          menu/system/test_verify-posix.sh
          system/test_update-all.sh
          system/test_verify-posix.sh
          translocation/test_jump-to-marker.sh
          translocation/test_mark-location.sh
          war/test_kill-process.sh
          "
          for test in $failures; do
            echo "::group::${test}"
            ./spells/system/test-magic --very-verbose --only "$test" || true
            echo "::endgroup::"
          done
