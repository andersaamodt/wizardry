name: "Hypothesis #08 - CPU time limit"

on:
  pull_request:
    paths:
      - '.github/workflows/hypothesis-08-cpu-time-limit.yml'
      - 'spells/.wizardry/test-magic'
  workflow_dispatch:

jobs:
  test-cpu-time-limit:
    name: Test with unlimited CPU time
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Hypothesis #08 - Test if ulimit -t (CPU time) causes crash
        run: |
          echo "Testing hypothesis: CPU time limit (ulimit -t) causes crash at ~120 seconds"
          echo ""
          echo "Current CPU time limit:"
          ulimit -t
          echo ""
          echo "Setting CPU time to unlimited..."
          ulimit -t unlimited
          echo "New CPU time limit:"
          ulimit -t
          echo ""
          echo "Running test-magic with unlimited CPU time..."
          START_TIME=$(date +%s)
          . spells/.imps/sys/invoke-wizardry && banish 8 && timeout 300 ./spells/.wizardry/test-magic --verbose || EXIT=$?
          END_TIME=$(date +%s)
          ELAPSED=$((END_TIME - START_TIME))
          echo ""
          echo "Elapsed time: ${ELAPSED}s"
          echo "Exit code: ${EXIT:-0}"
          if [ "${EXIT:-0}" = "139" ] && [ "$ELAPSED" -lt "150" ]; then
            echo "✗ Still crashed at ~${ELAPSED}s - CPU time limit was NOT the cause"
            exit 139
          elif [ "${EXIT:-0}" = "0" ] && [ "$ELAPSED" -gt "150" ]; then
            echo "✓ CONFIRMED: Ran >150s without crash - CPU time limit WAS the cause"
            exit 0
          else
            echo "? Unexpected: exit=${EXIT:-0}, elapsed=${ELAPSED}s"
            exit ${EXIT:-1}
          fi
