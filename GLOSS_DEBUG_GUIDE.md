# Glossary Generation Debugging Guide

## Problem Summary
If `invoke-wizardry` is only generating synonym glosses (like `cd-to`, `copy`, `delete-file`) but NOT spell glosses (like `main-menu`, `menu`, `forall`), this guide will help you debug the issue.

## Quick Fix
The fixes in this PR should resolve the issue. After updating:

1. **Update wizardry:**
   ```sh
   cd ~/.wizardry
   git pull
   ```

2. **Force regenerate glosses:**
   ```sh
   generate-glosses --force
   ```

3. **Restart your shell** or reload invoke-wizardry:
   ```sh
   exec $SHELL
   # OR
   . ~/.wizardry/spells/.imps/sys/invoke-wizardry
   ```

4. **Verify main-menu works:**
   ```sh
   main-menu --help
   ```

## What Was Fixed

### 1. Cross-Platform Compatibility (PRIMARY FIX)
**Problem:** The `find -executable` flag is not available on older BSD find implementations on macOS. This caused the find command to fail, returning 0 spell files, which meant only synonym glosses were created.

**Fix:** Now uses `find -perm /111` which is portable across BSD and GNU find implementations. This matches any file with at least one execute bit set.

### 2. Better Error Diagnostics
**Problem:** No visibility into what was happening during gloss generation, making it hard to debug failures.

**Fix:** Added:
- Debug logging showing how many files were found
- Warning when no executable files found
- Warning when very few glosses created (<50)
- Error log file at `~/.spellbook/.glossary-errors.log`

### 3. Subshell Issue
**Problem:** The original code used `find | while read` which runs in a subshell, making errors harder to detect.

**Fix:** Now uses a temp file to avoid subshell complexity.

### 4. Directory Validation
**Problem:** Didn't verify WIZARDRY_DIR was valid before attempting to scan it.

**Fix:** Now validates that WIZARDRY_DIR exists and contains spells/.

## Debugging Steps

If you're still seeing issues after the fix:

### 1. Check Error Log
Look at the gloss generation error log:
```sh
cat ~/.spellbook/.glossary-errors.log
```

This file contains any errors that occurred during the last gloss generation.

### 2. Run with Debug Mode
Enable debug output to see what's happening:
```sh
WIZARDRY_LOG_LEVEL=2 generate-glosses --force
```

This should show:
- Directory being scanned
- Number of executable files found
- Number of glosses generated/skipped

### 3. Verify WIZARDRY_DIR
Make sure WIZARDRY_DIR is set correctly:
```sh
echo $WIZARDRY_DIR
ls -la $WIZARDRY_DIR/spells
```

You should see directories like:
- `arcane/`
- `cantrips/`
- `menu/`
- `spellcraft/`
- `system/`
- `.imps/`

### 4. Count Glosses
Check how many glosses were created:
```sh
ls ~/.spellbook/.glossary | wc -l
```

Should be around 388 glosses.

Check for specific spell glosses:
```sh
ls ~/.spellbook/.glossary | grep -E "(main-menu|menu|forall|copy)"
```

Should show:
- `main-menu`
- `menu`
- `forall`
- `copy`
- And many others

### 5. Check Gloss Content
Look at the content of a gloss file:
```sh
cat ~/.spellbook/.glossary/main-menu
```

Should contain:
```sh
#!/bin/sh
# Gloss for wizardry spell: main-menu -> main-menu
# Generated by generate-glosses
# DO NOT EDIT - This file is auto-generated
exec parse "main-menu" "$@"
```

### 6. Check Permissions
Verify glosses are executable:
```sh
ls -la ~/.spellbook/.glossary/main-menu
```

Should show: `-rwxr-xr-x` (executable)

### 7. Verify PATH
Make sure glossary is in PATH:
```sh
echo $PATH | tr ':' '\n' | grep glossary
```

Should show: `~/.spellbook/.glossary` or `/Users/yourusername/.spellbook/.glossary`

## Common Issues

### Issue: "command not found: main-menu"
**Cause:** Glossary not in PATH or gloss not created.

**Fix:**
1. Check if gloss exists: `ls ~/.spellbook/.glossary/main-menu`
2. If missing, regenerate: `generate-glosses --force`
3. Verify PATH includes glossary: `echo $PATH | grep glossary`
4. Reload shell: `exec $SHELL`

### Issue: Only synonyms in glossary
**Cause:** The `find -executable` flag is not available on older BSD find (macOS). This is now fixed.

**Fix:**
1. Update wizardry to get the fix: `cd ~/.wizardry && git pull`
2. Force regenerate: `generate-glosses --force`
3. Check for warning messages about no files found
4. Check error log: `cat ~/.spellbook/.glossary-errors.log`

### Issue: Warning "no executable files found"
**Cause:** Either WIZARDRY_DIR is wrong, or there's a find compatibility issue, or permission problem.

**Fix:**
1. Verify WIZARDRY_DIR: `ls $WIZARDRY_DIR/spells`
2. Check permissions: `ls -la $WIZARDRY_DIR/spells`
3. Verify spells are executable: `ls -la $WIZARDRY_DIR/spells/menu/main-menu`
4. Try manual find: `find $WIZARDRY_DIR/spells -type f -perm /111 | head -5`

### Issue: Warning "only X glosses created (expected 300+)"
**Cause:** Spell files not found or not executable.

**Fix:**
1. Check how many spells exist: `find $WIZARDRY_DIR/spells -type f | wc -l`
2. Check how many are executable: `find $WIZARDRY_DIR/spells -type f -perm /111 | wc -l`
3. If counts differ, fix permissions: `chmod +x $WIZARDRY_DIR/spells/*/* 2>/dev/null`

## Expected Behavior

After successful gloss generation:

1. **Glossary directory** should contain ~388 executable files
2. **Error log** should be empty or contain only warnings
3. **Spell glosses** like main-menu, menu, forall should exist
4. **Synonym glosses** like cd-to, copy, delete-file should exist
5. **Commands work** - `main-menu --help` should show usage

## Still Having Issues?

If you're still experiencing problems after trying these steps:

1. **Share the error log:**
   ```sh
   cat ~/.spellbook/.glossary-errors.log
   ```

2. **Share debug output:**
   ```sh
   WIZARDRY_LOG_LEVEL=2 generate-glosses --force 2>&1 | head -50
   ```

3. **Share gloss count:**
   ```sh
   echo "Total glosses: $(ls ~/.spellbook/.glossary | wc -l)"
   ls ~/.spellbook/.glossary | head -20
   ```

4. **Share environment:**
   ```sh
   echo "WIZARDRY_DIR: $WIZARDRY_DIR"
   echo "SPELLBOOK_DIR: $SPELLBOOK_DIR"
   echo "Shell: $SHELL"
   uname -a
   ```

This information will help diagnose any remaining issues.
