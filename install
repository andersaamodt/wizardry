#!/bin/sh

# Abort if unexpected arguments are supplied so we do not accidentally discard
# them when repurposing the positional parameters to track missing directories.
if [ "$#" -ne 0 ]; then
        printf '%s\n' "Usage: install" >&2
        exit 1
fi

# Resolve the directory containing this installer without relying on
# non-POSIX utilities so the script works on Debian's /bin/sh (dash).
case $0 in
        */*)
                SCRIPT_DIR=${0%/*}
                ;;
        *)
                SCRIPT_DIR=.
                ;;
esac

# Disable CDPATH so that "cd" behaves predictably even if the user has a
# custom search path configured in their environment.
unset CDPATH

ABS_DIR=$(cd "$SCRIPT_DIR" && pwd -P) || exit 1
PATH_WIZARD="$ABS_DIR/spells/path-wizard"
MEMORIZE="$ABS_DIR/spells/memorize"
ASK_YN="$ABS_DIR/spells/cantrips/ask_yn"
REQUIRED_REL_DIRS="spells spells/cantrips spells/menu"

if [ ! -x "$PATH_WIZARD" ]; then
        printf '%s\n' "Error: Expected helper '$PATH_WIZARD' is missing or not executable." >&2
        exit 1
fi

if [ ! -x "$ASK_YN" ]; then
        printf '%s\n' "Error: Required cantrip '$ASK_YN' is missing." >&2
        exit 1
fi

# Collect the directories whose PATH exports are absent from the chosen start-up
# file so we can repair them in one pass.
set --
for rel in $REQUIRED_REL_DIRS
do
        dir="$ABS_DIR/$rel"

        if [ ! -d "$dir" ]; then
                printf '%s\n' "Warning: Expected directory '$dir' is missing; skipping." >&2
                continue
        fi

        if "$PATH_WIZARD" -r status "$dir"; then
                continue
        fi
        set -- "$@" "$dir"
done

if [ "$#" -eq 0 ]; then
        printf '%s\n' "ao-mud is already installed. Run it with 'menu' or 'mud'."
        exit 0
fi

printf '%s\n' "ao-mud will ensure the following directories appear in your PATH via your shell configuration file:"
for dir
do
        printf '  %s\n' "$dir"
done

confirm_install() {
        if [ "${WIZARDRY_INSTALL_ASSUME_YES-}" = "1" ]; then
                return 0
        fi
        if "$ASK_YN" "Proceed with installation?" yes >/dev/null; then
                return 0
        fi
        return 1
}

if ! confirm_install; then
        printf '%s\n' "Ok, well the mud won't work until you install it by adding the spells directory to your PATH."
        exit 1
fi

for dir
do
        "$PATH_WIZARD" -r add "$dir" || exit 1
done

if [ -x "$MEMORIZE" ]; then
        if ! "$MEMORIZE" --recursive "$ABS_DIR/spells"; then
                printf '%s\n' "Warning: memorize --recursive failed; run it manually to finish memorizing spells." >&2
        fi
else
        printf '%s\n' "Warning: memorize spell is missing; skipping automatic memorization." >&2
fi

printf '%s\n' "Your spellbook has been activated. Open a fresh terminal or source your shell configuration to cast spells everywhere."
