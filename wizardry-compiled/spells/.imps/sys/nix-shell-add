#!/bin/sh
#
# ----------------------------- nix-shell-add ------------------------------
#
# COMPILED WIZARDRY SPELL
#
# This is a compiled version of a wizardry spell.
# Wizardry is a collection of POSIX shell scripts themed as magical spells,
# turning folders into rooms and files into items, like a fantasy MUD.
#
# For the full clean version of this script and much more, please visit:
# https://github.com/andersaamodt/wizardry
#
# Original spell: nix-shell-add
# Generated by: compile-spell
#
# ----------------------------------------------------------------------------
#
#  ,___,   OPEN WIZARDRY LICENSE 1.1
#  (O,O)
#  /)  )   Permission: You may use, copy, modify, and share this project
# ="=="=   for non-commercial purposes, including private, educational,
#          research, and internal organizational use.
#
# Commercial Use: Commercial exploitation is prohibited. "Commercial exploitation"
# means sale, subscription, paid access, monetized hosting, inclusion in any paid
# product or service, or use as part of any monetized system, even if not the
# primary component. Internal use by commercial entities is allowed.
#
# Reciprocity: If you make modified versions publicly available—either by
# distributing copies or by operating a public-facing service that meaningfully
# depends on those modified files—you must publish those modified files under
# this license. No other files must be published.
#
# No Enclosure: Modified files you share must remain exclusively under this
# license, without additional restrictions. This license must accompany any public
# distribution of modified files.
#
# Warranty: Provided without warranty or guarantee of any kind.
#
# ----------------------------------------------------------------------------


# Inlined imp: nix-shell-add
_nix_shell_add() {
  _nsa_block_name=${1:-}
  _nsa_nix_file=${2:-}
  _nsa_shell_type=${3:-bash}

  if [ -z "$_nsa_block_name" ] || [ -z "$_nsa_nix_file" ]; then
    printf '%s\n' "nix-shell-add: NAME and FILE are required" >&2
    return 1
  fi

  case $_nsa_shell_type in
    bash|zsh) : ;;
    *) printf '%s\n' "nix-shell-add: shell must be 'bash' or 'zsh'" >&2; return 1 ;;
  esac

  _nsa_is_system_config=0
  case $_nsa_nix_file in /etc/nixos/*) _nsa_is_system_config=1 ;; esac

  if [ "$_nsa_is_system_config" -eq 1 ]; then
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.interactiveShellInit" ;;
      zsh)  _nsa_nix_option="programs.zsh.interactiveShellInit" ;;
    esac
  else
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.initExtra" ;;
      zsh)  _nsa_nix_option="programs.zsh.initExtra" ;;
    esac
  fi

  _nsa_marker="# wizardry: $_nsa_block_name"

  _nsa_needs_sudo=0
  if [ -f "$_nsa_nix_file" ] && [ ! -w "$_nsa_nix_file" ]; then
    _nsa_needs_sudo=1
  fi

  if [ -f "$_nsa_nix_file" ] && grep -Fq "$_nsa_marker" "$_nsa_nix_file" 2>/dev/null; then return 0; fi
  _nsa_shell_code=""
  while IFS= read -r _nsa_line || [ -n "$_nsa_line" ]; do
    if [ -z "$_nsa_shell_code" ]; then _nsa_shell_code=$_nsa_line
    else _nsa_shell_code="$_nsa_shell_code
$_nsa_line"; fi
  done
  if [ -z "$_nsa_shell_code" ]; then
    printf '%s\n' "nix-shell-add: no shell code provided on stdin" >&2
    return 1
  fi
  _nsa_escaped_code=$(printf '%s' "$_nsa_shell_code" | sed "s/''/'''/g; s/\\\${/''\${/g")
  _nsa_marked_code=$(printf '%s' "$_nsa_escaped_code" | sed "s/$/ $_nsa_marker/")
  if [ ! -f "$_nsa_nix_file" ]; then
    _nsa_dir=${_nsa_nix_file%/*}
    [ "$_nsa_dir" != "$_nsa_nix_file" ] && [ ! -d "$_nsa_dir" ] && mkdir -p "$_nsa_dir"
    printf '{ config, pkgs, ... }:\n\n{\n}\n' > "$_nsa_nix_file"
  fi
  _nsa_tmp_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add.XXXXXX") || return 1
  # Read file content inline
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then _nsa_content=$(sudo cat "$_nsa_nix_file")
    elif command -v doas >/dev/null 2>&1; then _nsa_content=$(doas cat "$_nsa_nix_file")
    else _nsa_content=$(cat "$_nsa_nix_file"); fi
  else _nsa_content=$(cat "$_nsa_nix_file"); fi
  
  if printf '%s\n' "$_nsa_content" | grep -q "$_nsa_nix_option[[:space:]]*="; then
    _nsa_input_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-input.XXXXXX") || return 1
    printf '%s\n' "$_nsa_content" > "$_nsa_input_file"
    _nsa_in_block=0
    while IFS= read -r _nsa_line; do
      if printf '%s\n' "$_nsa_line" | grep -q "$_nsa_nix_option[[:space:]]*=" && printf '%s\n' "$_nsa_line" | grep -q "''"; then
        _nsa_in_block=1; printf '%s\n' "$_nsa_line"; continue
      fi
      if [ "$_nsa_in_block" -eq 1 ] && printf '%s\n' "$_nsa_line" | grep -q "^[[:space:]]*'';"; then
        printf '%s\n' "$_nsa_marked_code"; printf '%s\n' "$_nsa_line"; _nsa_in_block=0; continue
      fi
      printf '%s\n' "$_nsa_line"
    done < "$_nsa_input_file" > "$_nsa_tmp_file"
    rm -f "$_nsa_input_file"
  else
    # Write the block to a temp file and use it with awk (macOS awk compatible)
    _nsa_block_file=$(mktemp "${TMPDIR:-/tmp}/nix-shell-add-block.XXXXXX") || return 1
    printf '%s\n' "  $_nsa_nix_option = ''" > "$_nsa_block_file"
    printf '%s\n' "$_nsa_marked_code" >> "$_nsa_block_file"
    printf '%s\n' "  '';" >> "$_nsa_block_file"
    
    printf '%s\n' "$_nsa_content" | awk -v blockfile="$_nsa_block_file" '
    BEGIN { while ((getline line < blockfile) > 0) block = block line "\n" }
    { lines[NR] = $0 }
    END {
      last = NR; while (last > 0 && lines[last] ~ /^[[:space:]]*$/) last--
      if (last > 0 && lines[last] ~ /^[[:space:]]*}/) {
        for (i = 1; i < last; i++) print lines[i]; print ""; printf "%s", block; print lines[last]
        for (i = last + 1; i <= NR; i++) print lines[i]
      } else { for (i = 1; i <= NR; i++) print lines[i]; print ""; printf "%s", block }
    }' > "$_nsa_tmp_file"
    rm -f "$_nsa_block_file"
  fi
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cp "$_nsa_tmp_file" "$_nsa_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cp "$_nsa_tmp_file" "$_nsa_nix_file"
    else cp "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  else mv "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  rm -f "$_nsa_tmp_file"
  return 0
}

# _nix_shell_add NAME FILE [SHELL] - add shell init code to nix config (from stdin)
# Example: echo 'source "/path/to/spell"' | _nix_shell_add myspell home.nix
# SHELL defaults to 'bash'; valid values: bash, zsh

_nix_shell_add() {
  _nsa_block_name=${1:-}
  _nsa_nix_file=${2:-}
  _nsa_shell_type=${3:-bash}

  if [ -z "$_nsa_block_name" ] || [ -z "$_nsa_nix_file" ]; then
    printf '%s\n' "_nix_shell_add: NAME and FILE are required" >&2
    return 1
  fi

  case $_nsa_shell_type in
    bash|zsh) : ;;
    *) printf '%s\n' "_nix_shell_add: shell must be 'bash' or 'zsh'" >&2; return 1 ;;
  esac

  _nsa_is_system_config=0
  case $_nsa_nix_file in /etc/nixos/*) _nsa_is_system_config=1 ;; esac

  if [ "$_nsa_is_system_config" -eq 1 ]; then
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.interactiveShellInit" ;;
      zsh)  _nsa_nix_option="programs.zsh.interactiveShellInit" ;;
    esac
  else
    case $_nsa_shell_type in
      bash) _nsa_nix_option="programs.bash.initExtra" ;;
      zsh)  _nsa_nix_option="programs.zsh.initExtra" ;;
    esac
  fi

  _nsa_marker="# wizardry: $_nsa_block_name"

  _nsa_needs_sudo=0
  if [ -f "$_nsa_nix_file" ] && [ ! -w "$_nsa_nix_file" ]; then
    _nsa_needs_sudo=1
  fi

  if [ -f "$_nsa_nix_file" ] && grep -Fq "$_nsa_marker" "$_nsa_nix_file" 2>/dev/null; then return 0; fi
  _nsa_shell_code=""
  while IFS= read -r _nsa_line || [ -n "$_nsa_line" ]; do
    if [ -z "$_nsa_shell_code" ]; then _nsa_shell_code=$_nsa_line
    else _nsa_shell_code="$_nsa_shell_code
$_nsa_line"; fi
  done
  if [ -z "$_nsa_shell_code" ]; then
    printf '%s\n' "_nix_shell_add: no shell code provided on stdin" >&2
    return 1
  fi
  _nsa_escaped_code=$(printf '%s' "$_nsa_shell_code" | sed "s/''/'''/g; s/\\\${/''\${/g")
  _nsa_marked_code=$(printf '%s' "$_nsa_escaped_code" | sed "s/$/ $_nsa_marker/")
  if [ ! -f "$_nsa_nix_file" ]; then
    _nsa_dir=${_nsa_nix_file%/*}
    [ "$_nsa_dir" != "$_nsa_nix_file" ] && [ ! -d "$_nsa_dir" ] && mkdir -p "$_nsa_dir"
    printf '{ config, pkgs, ... }:\n\n{\n}\n' > "$_nsa_nix_file"
  fi
  _nsa_tmp_file=$(mktemp "${TMPDIR:-/tmp}/_nix_shell_add.XXXXXX") || return 1
  # Read file content inline
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then _nsa_content=$(sudo cat "$_nsa_nix_file")
    elif command -v doas >/dev/null 2>&1; then _nsa_content=$(doas cat "$_nsa_nix_file")
    else _nsa_content=$(cat "$_nsa_nix_file"); fi
  else _nsa_content=$(cat "$_nsa_nix_file"); fi
  
  if printf '%s\n' "$_nsa_content" | grep -q "$_nsa_nix_option[[:space:]]*="; then
    _nsa_input_file=$(mktemp "${TMPDIR:-/tmp}/_nix_shell_add-input.XXXXXX") || return 1
    printf '%s\n' "$_nsa_content" > "$_nsa_input_file"
    _nsa_in_block=0
    while IFS= read -r _nsa_line; do
      if printf '%s\n' "$_nsa_line" | grep -q "$_nsa_nix_option[[:space:]]*=" && printf '%s\n' "$_nsa_line" | grep -q "''"; then
        _nsa_in_block=1; printf '%s\n' "$_nsa_line"; continue
      fi
      if [ "$_nsa_in_block" -eq 1 ] && printf '%s\n' "$_nsa_line" | grep -q "^[[:space:]]*'';"; then
        printf '%s\n' "$_nsa_marked_code"; printf '%s\n' "$_nsa_line"; _nsa_in_block=0; continue
      fi
      printf '%s\n' "$_nsa_line"
    done < "$_nsa_input_file" > "$_nsa_tmp_file"
    rm -f "$_nsa_input_file"
  else
    # Write the block to a temp file and use it with awk (macOS awk compatible)
    _nsa_block_file=$(mktemp "${TMPDIR:-/tmp}/_nix_shell_add-block.XXXXXX") || return 1
    printf '%s\n' "  $_nsa_nix_option = ''" > "$_nsa_block_file"
    printf '%s\n' "$_nsa_marked_code" >> "$_nsa_block_file"
    printf '%s\n' "  '';" >> "$_nsa_block_file"
    
    printf '%s\n' "$_nsa_content" | awk -v blockfile="$_nsa_block_file" '
    BEGIN { while ((getline line < blockfile) > 0) block = block line "\n" }
    { lines[NR] = $0 }
    END {
      last = NR; while (last > 0 && lines[last] ~ /^[[:space:]]*$/) last--
      if (last > 0 && lines[last] ~ /^[[:space:]]*}/) {
        for (i = 1; i < last; i++) print lines[i]; print ""; printf "%s", block; print lines[last]
        for (i = last + 1; i <= NR; i++) print lines[i]
      } else { for (i = 1; i <= NR; i++) print lines[i]; print ""; printf "%s", block }
    }' > "$_nsa_tmp_file"
    rm -f "$_nsa_block_file"
  fi
  if [ "$_nsa_needs_sudo" -eq 1 ]; then
    if command -v sudo >/dev/null 2>&1; then sudo cp "$_nsa_tmp_file" "$_nsa_nix_file"
    elif command -v doas >/dev/null 2>&1; then doas cp "$_nsa_tmp_file" "$_nsa_nix_file"
    else cp "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  else mv "$_nsa_tmp_file" "$_nsa_nix_file"; fi
  rm -f "$_nsa_tmp_file"
  return 0
}

# Self-execute when run directly (not sourced)
case "$0" in
  */_nix_shell_add) _nix_shell_add "$@" ;; esac
