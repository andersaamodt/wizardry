#!/bin/sh
#
# ------------------------------- mud-config -------------------------------
#
# COMPILED WIZARDRY SPELL
#
# This is a compiled version of a wizardry spell.
# Wizardry is a collection of POSIX shell scripts themed as magical spells,
# turning folders into rooms and files into items, like a fantasy MUD.
#
# For the full clean version of this script and much more, please visit:
# https://github.com/andersaamodt/wizardry
#
# Original spell: mud-config
# Generated by: compile-spell
#
# ----------------------------------------------------------------------------
#
#  ,___,   OPEN WIZARDRY LICENSE 1.1
#  (O,O)
#  /)  )   Permission: You may use, copy, modify, and share this project
# ="=="=   for non-commercial purposes, including private, educational,
#          research, and internal organizational use.
#
# Commercial Use: Commercial exploitation is prohibited. "Commercial exploitation"
# means sale, subscription, paid access, monetized hosting, inclusion in any paid
# product or service, or use as part of any monetized system, even if not the
# primary component. Internal use by commercial entities is allowed.
#
# Reciprocity: If you make modified versions publicly available—either by
# distributing copies or by operating a public-facing service that meaningfully
# depends on those modified files—you must publish those modified files under
# this license. No other files must be published.
#
# No Enclosure: Modified files you share must remain exclusively under this
# license, without additional restrictions. This license must accompany any public
# distribution of modified files.
#
# Warranty: Provided without warranty or guarantee of any kind.
#
# ----------------------------------------------------------------------------


# Inlined imp: cleanup-file
_cleanup_file() {
  [ -n "${1:-}" ] && [ -f "$1" ] && rm -f "$1"
  return 0
}

# Inlined imp: env-or
_env_or() {
  _eo_var=$1
  # Validate variable name contains only alphanumerics and underscores
  case "$_eo_var" in
    *[!A-Za-z0-9_]*|"")
      printf '%s\n' "$2"
      return
      ;;
  esac
  eval "_eo_val=\${$_eo_var-}"
  if [ -n "$_eo_val" ]; then
    printf '%s\n' "$_eo_val"
  else
    printf '%s\n' "$2"
  fi
}

# Inlined imp: temp-file
_temp_file() {
  _tf_prefix=${1:-wizardry}
  mktemp "${TMPDIR:-/tmp}/${_tf_prefix}.XXXXXX"
}


# Manage MUD feature configuration stored in $MUD_DIR/config
# This is a helper for reading and writing MUD feature toggle states.


show_usage() {
cat <<'USAGE'
Usage: mud-config {get|set|toggle|list} [FEATURE] [VALUE]

Manage MUD feature toggles stored in $MUD_DIR/config. Supports get, set, toggle, and list for features like command-not-found, touch-hook, fantasy-theme, inventory, and combat.
USAGE
}

case "${1-}" in
--help|--usage|-h)
        show_usage
        exit 0
        ;;
esac

set -eu

# Resolve config directory
spell_home=$(_env_or SPELLBOOK_DIR "${HOME:-.}/.spellbook")
config_dir=$(_env_or MUD_DIR "$spell_home/.mud")
config_file="$config_dir/config"

# Ensure config directory exists
ensure_config_dir() {
        if [ ! -d "$config_dir" ]; then
                mkdir -p "$config_dir" || {
                        printf '%s\n' "mud-config: cannot create config directory '$config_dir'" >&2
                        return 1
                }
        fi
}

# Get feature value (returns '1' for enabled, '0' for disabled)
get_feature() {
        feature=$1
        if [ ! -f "$config_file" ]; then
                printf '%s\n' "0"
                return 0
        fi
        value=$(grep "^${feature}=" "$config_file" 2>/dev/null | cut -d= -f2 | head -1)
        if [ "$value" = "1" ]; then
                printf '%s\n' "1"
        else
                printf '%s\n' "0"
        fi
}

# Set feature value
set_feature() {
        feature=$1
        value=$2
        case "$value" in
                1|0) ;;
                *)
                        printf '%s\n' "mud-config: value must be '1' or '0'" >&2
                        return 1
                        ;;
        esac
        ensure_config_dir || return 1
        
        # Create or update config file
        if [ -f "$config_file" ]; then
                # Remove old entry and add new one
                tmp_file=$(_temp_file mud-config) || return 1
                trap '_cleanup_file "$tmp_file"' EXIT HUP INT TERM
                grep -v "^${feature}=" "$config_file" >"$tmp_file" 2>/dev/null || true
                printf '%s=%s\n' "$feature" "$value" >>"$tmp_file"
                if ! mv "$tmp_file" "$config_file"; then
                        trap - EXIT HUP INT TERM
                        rm -f "$tmp_file"
                        return 1
                fi
                trap - EXIT HUP INT TERM
        else
                printf '%s=%s\n' "$feature" "$value" >"$config_file"
        fi
}

# Toggle feature between 1/0
toggle_feature() {
        feature=$1
        current=$(get_feature "$feature")
        if [ "$current" = "1" ]; then
                set_feature "$feature" "0"
                printf '%s\n' "0"
        else
                set_feature "$feature" "1"
                printf '%s\n' "1"
        fi
}

# List all features
list_features() {
        features="command-not-found touch-hook fantasy-theme inventory combat"
        for feature in $features; do
                value=$(get_feature "$feature")
                printf '%s=%s\n' "$feature" "$value"
        done
}

# Main command dispatch
if [ "$#" -lt 1 ]; then
        show_usage >&2
        exit 1
fi

cmd=$1
shift

case "$cmd" in
        get)
                if [ "$#" -lt 1 ]; then
                        printf '%s\n' "mud-config: get requires a feature name" >&2
                        exit 1
                fi
                get_feature "$1"
                ;;
        set)
                if [ "$#" -lt 2 ]; then
                        printf '%s\n' "mud-config: set requires a feature name and value" >&2
                        exit 1
                fi
                set_feature "$1" "$2"
                ;;
        toggle)
                if [ "$#" -lt 1 ]; then
                        printf '%s\n' "mud-config: toggle requires a feature name" >&2
                        exit 1
                fi
                toggle_feature "$1"
                ;;
        list)
                list_features
                ;;
        *)
                printf '%s\n' "mud-config: unknown command '$cmd'" >&2
                show_usage >&2
                exit 1
                ;;
esac
