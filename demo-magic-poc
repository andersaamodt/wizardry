#!/bin/sh
# Enhanced demo-magic POC with actual spell demonstrations
# Combines working banish integration with spell narration

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: demo-magic-poc [LEVEL] [OPTIONS]

Demonstrate wizardry spells at each level with banish validation.

Arguments:
  LEVEL         Demonstrate through level N (0-27, default: 4)

Options:
  --no-bwrap    Skip bubblewrap sandboxing (use with caution)

This demonstrates actual wizardry spells at each level, with prerequisite
validation via banish running silently in the background.
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Colors for narration
if [ -t 1 ]; then
  cyan='\033[36m'
  green='\033[32m'
  yellow='\033[1;33m'
  reset='\033[0m'
else
  cyan=''
  green=''
  yellow=''
  reset=''
fi

# Demo a single level with banish validation + spell demonstrations
demo_level() {
  level=$1
  
  # Get level info
  level_name=$(spell-levels "$level" name 2>/dev/null || printf "Level %d" "$level")
  
  printf '\n'
  printf '%s=== Level %d: %s ===%s\n' "$yellow" "$level" "$level_name" "$reset"
  printf '\n'
  
  # Silently validate with banish (user doesn't need to see this detail)
  if ! banish "$level" --only --no-tests >/dev/null 2>&1; then
    printf '%sWarning: Level %d prerequisites not fully met (continuing anyway)%s\n' "$cyan" "$level" "$reset" >&2
  fi
  
  # Level-specific demonstrations with narration
  case "$level" in
    0)
      printf '%sThe wizard examines the foundation of reality itself...%s\n' "$cyan" "$reset"
      printf '\n'
      
      if command -v detect-posix >/dev/null 2>&1; then
        printf '%sThe wizard casts %sdetect-posix%s...%s\n' "$cyan" "$green" "$cyan" "$reset"
        detect-posix 2>&1 | head -5
        printf '\n'
      fi
      
      if command -v detect-distro >/dev/null 2>&1; then
        printf '%sThe wizard casts %sdetect-distro%s...%s\n' "$cyan" "$green" "$cyan" "$reset"
        printf 'Distribution: %s\n' "$(detect-distro)"
        printf '\n'
      fi
      
      if [ -d "${WIZARDRY_DIR}/spells" ]; then
        spell_count=$(find "${WIZARDRY_DIR}/spells" -type f -executable 2>/dev/null | wc -l)
        printf 'The spells grimoire: %d spells inscribed\n' "$spell_count"
      fi
      ;;
      
    1)
      printf '%sThe wizard gathers the core components of wizardry...%s\n' "$cyan" "$reset"
      printf '\n'
      
      if command -v validate-spells >/dev/null 2>&1; then
        printf '%sThe wizard casts %svalidate-spells%s on core infrastructure...%s\n' "$cyan" "$green" "$cyan" "$reset"
        validate-spells banish:wards validate-spells:.wizardry 2>&1 | head -3
        printf '\n'
      fi
      
      imp_list=$(spell-levels "$level" imps 2>/dev/null || true)
      if [ -n "$imp_list" ]; then
        imp_count=$(printf '%s' "$imp_list" | wc -w)
        printf 'Core imps summoned: %d foundational helpers\n' "$imp_count"
        printf 'Including: has, there, is, say, warn, die, temp-file, and more...\n'
      fi
      ;;
      
    2)
      printf '%sThe wizard conjures the glossary system...%s\n' "$cyan" "$reset"
      printf '\n'
      
      if [ -f "${WIZARDRY_DIR}/spells/.wizardry/generate-glosses" ]; then
        printf 'The wizard has the power to cast %sgenerate-glosses%s...\n' "$green" "$reset"
        printf '(Glossary generation extracts help text from all spells)\n'
      fi
      ;;
      
    3)
      printf '%sThe wizard weaves the glossary and parsing infrastructure...%s\n' "$cyan" "$reset"
      printf '\n'
      
      printf 'Glossary and parsing capabilities available\n'
      ;;
      
    4)
      printf '%sThe wizard masters the menu system...%s\n' "$cyan" "$reset"
      printf '\n'
      
      if command -v fathom-terminal >/dev/null 2>&1; then
        printf '%sThe wizard casts %sfathom-terminal%s...%s\n' "$cyan" "$green" "$cyan" "$reset"
        if term_size=$(fathom-terminal 2>&1); then
          printf 'Terminal dimensions discovered: %s\n' "$term_size"
        else
          printf 'Terminal dimensions unavailable (no TTY)\n'
        fi
        printf '\n'
      fi
      
      printf 'Menu system capabilities unlocked:\n'
      printf '  • Interactive menu navigation\n'
      printf '  • Terminal size detection\n'
      printf '  • Cursor positioning\n'
      printf '  • Keypress detection\n'
      printf '  • Color support\n'
      ;;
      
    *)
      printf '%sThe wizard demonstrates level %d capabilities...%s\n' "$cyan" "$level" "$reset"
      printf '\n'
      
      spell_list=$(spell-levels "$level" spells 2>/dev/null || true)
      if [ -n "$spell_list" ]; then
        spell_count=$(printf '%s' "$spell_list" | wc -w)
        printf 'Spells at this level: %d\n' "$spell_count"
      fi
      ;;
  esac
  
  printf '\n'
}

# Parse arguments
target_level=4
no_bwrap=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-bwrap)
      no_bwrap=1
      shift
      ;;
    [0-9]|[0-9][0-9])
      target_level=$1
      shift
      ;;
    *)
      printf 'demo-magic-poc: invalid argument: %s\n' "$1" >&2
      exit 2
      ;;
  esac
done

# Sandbox with bwrap if available and not disabled
if [ "$no_bwrap" -eq 0 ] && [ "${WIZARDRY_DEMO_IN_BWRAP-0}" -ne 1 ]; then
  if [ -z "${GITHUB_ACTIONS-}" ] || [ "${GITHUB_ACTIONS}" != "true" ]; then
    if command -v bwrap >/dev/null 2>&1; then
      # Re-exec with bwrap sandbox
      exec bwrap --unshare-user --ro-bind / / --dev-bind /dev /dev --bind /proc /proc \
        --bind /tmp /tmp --setenv PATH "$PATH" --setenv WIZARDRY_DEMO_IN_BWRAP 1 -- \
        "$0" "$target_level" --no-bwrap
    fi
  fi
fi

printf '\n'
printf '╔═══════════════════════════════════════════════════════════╗\n'
printf '║         WIZARDRY DEMONSTRATION OF MAGICAL ARTS            ║\n'
printf '╚═══════════════════════════════════════════════════════════╝\n'
printf '\n'
printf '%sA circle of chalk flares into view.%s\n' "$cyan" "$reset"
printf '%sThe apprentice wizard prepares to demonstrate mastery.%s\n' "$cyan" "$reset"

# Add imps and spells to PATH
if [ -n "${WIZARDRY_DIR-}" ]; then
  imp_path="${WIZARDRY_DIR}/spells/.imps/sys"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/cond"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/out"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/fs"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/str"
  PATH="$imp_path:$PATH"
  
  PATH="$WIZARDRY_DIR/spells/.wizardry:$PATH"
  for dir in "$WIZARDRY_DIR"/spells/*; do
    [ -d "$dir" ] || continue
    PATH="$dir:$PATH"
  done
  export PATH
fi

# Run levels 0 through target
current=0
while [ "$current" -le "$target_level" ]; do
  demo_level "$current"
  current=$((current + 1))
done

printf '\n'
printf '═══════════════════════════════════════════════════════════\n'
printf '\n'
printf '%sThe demonstration concludes.%s\n' "$cyan" "$reset"
printf '%sThe circle closes. Wizardry stands ready.%s\n' "$cyan" "$reset"
printf 'DEMO_MAGIC_COMPLETE\n'

exit 0
