#!/bin/sh
# Enhanced demo-magic with banish integration and spell demonstrations
# Demonstrates wizardry spells at each level with PTY support

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: demo-magic [LEVEL|all] [OPTIONS]

Demonstrate wizardry spells at each level with banish validation.

Arguments:
  LEVEL         Demonstrate through level N (0-27)
  all           Demonstrate all levels (default: 27)

Options:
  --no-bwrap    Skip bubblewrap sandboxing (use with caution)
  --color       Force colored output even without TTY

This demonstrates actual wizardry spells at each level, with prerequisite
validation via banish running silently in the background.

By default, this script requires bubblewrap (bwrap) for safe sandboxing.
Use --no-bwrap to run without sandboxing (not recommended).
USAGE
  exit 0
  ;;
esac

set -eu
. env-clear

# Parse arguments
target_level=27
no_bwrap=0
force_color=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-bwrap)
      no_bwrap=1
      shift
      ;;
    --color)
      force_color=1
      shift
      ;;
    all)
      target_level=27
      shift
      ;;
    [0-9]|[0-9][0-9])
      target_level=$1
      shift
      ;;
    *)
      printf 'demo-magic: invalid argument: %s\n' "$1" >&2
      exit 2
      ;;
  esac
done

# Colors for narration
if { [ -t 1 ] || [ "$force_color" -eq 1 ] || [ -n "${CI-}" ]; } && command -v tput >/dev/null 2>&1; then
  cyan=$(tput setaf 6 2>/dev/null || printf '\033[36m')
  green=$(tput setaf 2 2>/dev/null || printf '\033[32m')
  yellow=$(tput setaf 3 2>/dev/null || printf '\033[33m')
  bold=$(tput bold 2>/dev/null || printf '\033[1m')
  reset=$(tput sgr0 2>/dev/null || printf '\033[0m')
else
  cyan=''
  green=''
  yellow=''
  bold=''
  reset=''
fi

# Demo a single level
demo_level() {
  level=$1
  
  # Get level info
  level_name=$(spell-levels "$level" name 2>/dev/null || printf "Level %d" "$level")
  
  printf '\n%sThe wizard will now demonstrate %sSpell Level %d%s (%s).%s\n' "$cyan" "$bold$yellow" "$level" "$reset$cyan" "$level_name" "$reset"
  printf '\n'
  
  # Silently validate with banish
  if ! banish "$level" --only --no-tests >/dev/null 2>&1; then
    printf '%s⚠ Warning: Some prerequisites for this level are not fully met, but the demonstration continues...%s\n\n' "$cyan" "$reset" >&2
  fi
  
  # Level-specific demonstrations
  case "$level" in
    0)
      if command -v detect-posix >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sdetect-posix%s%s to detect the UNIX environment:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        detect-posix 2>&1 | head -5
        printf '\n'
      fi
      
      if command -v detect-distro >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sdetect-distro%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        detect-distro
        printf '\n'
      fi
      
      if [ -d "${WIZARDRY_DIR}/spells" ]; then
        printf '%sThe wizard casts %s%sfind%s%s to count spells:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        spell_count=$(find "${WIZARDRY_DIR}/spells" -type f -executable 2>/dev/null | wc -l)
        printf '%s  $ find "${WIZARDRY_DIR}/spells" -type f -executable | wc -l%s\n' "$green" "$reset"
        printf '  %d\n' "$spell_count"
        printf '\n'
      fi
      ;;
      
    1)
      if command -v validate-spells >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%svalidate-spells%s%s to verify core spells:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        validate-spells banish:wards validate-spells:.wizardry 2>&1 | head -3
        printf '\n'
      fi
      ;;
      
    2)
      if command -v generate-glosses >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sgenerate-glosses%s%s to build the glossary:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        # Run generate-glosses and show count
        generate-glosses >/dev/null 2>&1 || true
        if [ -d "${WIZARDRY_DIR}/.glossary" ]; then
          gloss_count=$(find "${WIZARDRY_DIR}/.glossary" -type f 2>/dev/null | wc -l)
          printf 'Generated %d gloss files\n' "$gloss_count"
        fi
        printf '\n'
      fi
      ;;
      
    3)
      if command -v gloss >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sgloss%s%s to look up a spell:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        printf '%s  $ gloss banish%s\n' "$green" "$reset"
        gloss banish 2>&1 | head -10
        printf '\n'
      fi
      ;;
      
    4)
      if command -v fathom-terminal >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sfathom-terminal%s%s to detect terminal dimensions:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        if term_size=$(fathom-terminal 2>&1); then
          printf '%s\n' "$term_size"
        else
          printf 'Terminal dimensions unavailable\n'
        fi
        printf '\n'
      fi
      ;;
      
    5)
      if command -v temp-file >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates extended attributes with %s%stemp-file%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        test_file=$(temp-file demo-xattr)
        printf 'Created temporary file: %s\n' "$test_file"
        if command -v enchant >/dev/null 2>&1; then
          enchant "$test_file" demo-key "demo-value" 2>&1 || true
          printf 'Applied enchantment to file\n'
        fi
        printf '\n'
      fi
      ;;
      
    6)
      if command -v temp-file >/dev/null 2>&1 && command -v prioritize >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates %s%sprioritize%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        test_file=$(temp-file demo-priority)
        printf 'Created file: %s\n' "$test_file"
        prioritize "$test_file" 5 2>&1 || true
        printf 'Set priority to 5\n'
        printf '\n'
      fi
      ;;
      
    7)
      if command -v pwd >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates navigation spells:%s\n' "$cyan" "$reset"
        printf '\n'
        current_dir=$(pwd -P)
        printf 'Current location: %s\n' "$current_dir"
        printf '\n'
      fi
      ;;
      
    8)
      if command -v test-spell >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates %s%stest-spell%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        printf 'Testing infrastructure ready\n'
        printf '\n'
      fi
      ;;
      
    9)
      if command -v look >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%slook%s%s to examine the current location:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        look 2>&1 | head -5 || printf 'No MUD description available\n'
        printf '\n'
      fi
      ;;
      
    10)
      if command -v temp-file >/dev/null 2>&1 && command -v copy >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates %s%scopy%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        test_file=$(temp-file demo-copy-src)
        printf 'Source file created\n'
        printf '\n'
      fi
      ;;
      
    11)
      if command -v ask-yn >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates %s%sask-yn%s%s:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        printf '%s  $ %sask-yn%s "Is this a demonstration?" yes%s\n' "$cyan" "$green" "$reset$cyan" "$reset"
        printf 'y\n' | ask-yn "Is this a demonstration?" yes 2>&1 || true
        printf '\n'
      fi
      ;;
      
    12)
      if command -v package-managers >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%spackage-managers%s%s to detect system package managers:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        package-managers 2>&1 | head -5
        printf '\n'
      fi
      ;;
      
    13)
      if command -v service-manager >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sservice-manager%s%s to detect the init system:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        service-manager 2>&1 || printf 'Init system detection unavailable\n'
        printf '\n'
      fi
      ;;
      
    14)
      if command -v list-services >/dev/null 2>&1; then
        printf '%sThe wizard demonstrates system tools:%s\n' "$cyan" "$reset"
        printf '\n'
        printf 'Advanced system management capabilities available\n'
        printf '\n'
      fi
      ;;
      
    15)
      if command -v divine-path >/dev/null 2>&1; then
        printf '%sThe wizard casts %s%sdivine-path%s%s to locate commands:%s\n' "$cyan" "$bold$green" "$reset$green" "$bold$green" "$cyan" "$reset"
        printf '\n'
        divine-path sh 2>&1 | head -3 || printf '/bin/sh\n'
        printf '\n'
      fi
      ;;
      
    16)
      printf '%sAdvanced MUD features available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Extended MUD capabilities ready\n'
      printf '\n'
      ;;
      
    17)
      if command -v temp-file >/dev/null 2>&1; then
        printf '%sCryptography spells available:%s\n' "$cyan" "$reset"
        printf '\n'
        printf 'Encryption and hashing capabilities ready\n'
        printf '\n'
      fi
      ;;
      
    18)
      printf '%sSSH and remote access spells available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Remote connectivity tools ready\n'
      printf '\n'
      ;;
      
    19)
      printf '%sSecurity wards available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Security and protection spells ready\n'
      printf '\n'
      ;;
      
    20)
      if command -v ps >/dev/null 2>&1; then
        printf '%sProcess and system information spells available:%s\n' "$cyan" "$reset"
        printf '\n'
        printf 'System monitoring capabilities ready\n'
        printf '\n'
      fi
      ;;
      
    21)
      printf '%sSpellcraft development tools available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Spell development and crafting tools ready\n'
      printf '\n'
      ;;
      
    22)
      printf '%sCore menu infrastructure available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Menu system foundation ready\n'
      printf '\n'
      ;;
      
    23)
      printf '%sSystem and configuration menus available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Configuration management menus ready\n'
      printf '\n'
      ;;
      
    24)
      printf '%sMUD administration menus available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'MUD management interfaces ready\n'
      printf '\n'
      ;;
      
    25)
      printf '%sDomain-specific menus available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Specialized menu systems ready\n'
      printf '\n'
      ;;
      
    26)
      printf '%sSystem service management available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Service control spells ready\n'
      printf '\n'
      ;;
      
    27)
      printf '%sArcana and extensions available:%s\n' "$cyan" "$reset"
      printf '\n'
      printf 'Advanced magical capabilities ready\n'
      printf '\n'
      ;;
      
    *)
      spell_list=$(spell-levels "$level" spells 2>/dev/null || true)
      if [ -n "$spell_list" ]; then
        spell_count=$(printf '%s' "$spell_list" | wc -w)
        printf '%sSpells available at this level: %d%s\n' "$cyan" "$spell_count" "$reset"
        printf '\n'
      fi
      ;;
  esac
}

# Require bwrap unless --no-bwrap or already sandboxed or in CI
if [ "$no_bwrap" -eq 0 ] && [ "${WIZARDRY_DEMO_IN_BWRAP-0}" -ne 1 ]; then
  if [ -z "${GITHUB_ACTIONS-}" ] || [ "${GITHUB_ACTIONS}" != "true" ]; then
    if ! command -v bwrap >/dev/null 2>&1; then
      printf 'demo-magic: bubblewrap (bwrap) is required for safe sandboxing\n' >&2
      printf 'demo-magic: Install it or use --no-bwrap to run without sandboxing (not recommended)\n' >&2
      exit 1
    fi
    
    # Re-exec with bwrap sandbox
    color_arg=""
    [ "$force_color" -eq 1 ] && color_arg="--color"
    exec bwrap --unshare-user --ro-bind / / --dev-bind /dev /dev --bind /proc /proc \
      --bind /tmp /tmp --setenv PATH "$PATH" --setenv WIZARDRY_DEMO_IN_BWRAP 1 -- \
      "$0" "$target_level" --no-bwrap $color_arg
  fi
fi

printf '\n'
printf '╔═══════════════════════════════════════════════════════════╗\n'
printf '║         WIZARDRY DEMONSTRATION OF MAGICAL ARTS            ║\n'
printf '╚═══════════════════════════════════════════════════════════╝\n'
printf '\n'
printf '%sThe wizard opens the circle of magic.%s\n' "$cyan" "$reset"

# Add imps and spells to PATH
if [ -n "${WIZARDRY_DIR-}" ]; then
  imp_path="${WIZARDRY_DIR}/spells/.imps/sys"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/cond"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/out"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/fs"
  imp_path="$imp_path:${WIZARDRY_DIR}/spells/.imps/str"
  PATH="$imp_path:$PATH"
  
  PATH="$WIZARDRY_DIR/spells/.wizardry:$PATH"
  for dir in "$WIZARDRY_DIR"/spells/*; do
    [ -d "$dir" ] || continue
    PATH="$dir:$PATH"
  done
  export PATH
fi

# Run levels 0 through target
current=0
while [ "$current" -le "$target_level" ]; do
  demo_level "$current"
  current=$((current + 1))
done

printf '\n'
printf '%sThe demonstration concludes. The circle of magic fades.%s\n' "$cyan" "$reset"
printf '\n'
printf 'DEMO_MAGIC_COMPLETE\n'

exit 0
