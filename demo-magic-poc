#!/bin/sh
# Minimal proof-of-concept demo-magic to test socat/PTY integration with banish
# This version calls banish for each level to validate prerequisites

case "${1-}" in
--help|--usage|-h)
  cat <<'USAGE'
Usage: demo-magic-poc [LEVEL]

Minimal demonstration of wizardry levels with banish validation (POC).

Arguments:
  LEVEL         Demonstrate through level N (0-10, default: 2)

This is a proof-of-concept for testing banish integration with socat/PTY.
Each level runs banish validation before demonstrating that level's capabilities.
USAGE
  exit 0
  ;;
esac

set -eu

# Generic level demonstration with banish validation
demo_level() {
  level=$1
  
  printf '\n=== Level %d ===\n\n' "$level"
  
  # Get level info if spell-levels is available
  level_name=""
  if command -v spell-levels >/dev/null 2>&1; then
    level_name=$(spell-levels "$level" name 2>/dev/null || true)
  fi
  
  if [ -n "$level_name" ]; then
    printf 'Level %d: %s\n' "$level" "$level_name"
  else
    printf 'Level %d\n' "$level"
  fi
  
  printf 'Validating prerequisites with banish...\n\n'
  
  # Run banish for this level validation (--only to avoid redundant lower levels)
  # Use --no-tests to skip actual tests, just validate assumptions
  if banish "$level" --only --no-tests 2>&1; then
    printf '\n✓ Banish level %d: PASSED\n' "$level"
  else
    printf '\n✗ Banish level %d: FAILED\n' "$level"
    return 1
  fi
  
  printf '\nLevel %d complete.\n' "$level"
}

# Determine target level
target_level=2
if [ "$#" -gt 0 ]; then
  case "$1" in
    [0-9]|[0-9][0-9])
      target_level=$1
      ;;
    *)
      printf 'demo-magic-poc: invalid level: %s\n' "$1" >&2
      exit 2
      ;;
  esac
fi

printf '\n╔═══════════════════════════════════════════════╗\n'
printf '║     DEMO-MAGIC POC - Banish Integration      ║\n'
printf '╚═══════════════════════════════════════════════╝\n'

# Run levels 0 through target
current=0
while [ "$current" -le "$target_level" ]; do
  demo_level "$current"
  current=$((current + 1))
done

printf '\n═══════════════════════════════════════════════\n'
printf 'POC demonstration complete.\n'
printf 'DEMO_POC_COMPLETE\n'

exit 0
